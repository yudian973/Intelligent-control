     1                     ;==================================================================
     2                     ; Filename     :  EM78M611
     3                     ; Author       :  yu.wei
     4                     ; Company      :  ELAN
     5                     ; VERSION      :  4.0
     6                     ; CRYSTAL      :  6MHZ
     7                     ; Creat date   :  2009/11/4
     8                     ; tool ver.    :  eUIDE
     9                     ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10                     ;=========================================================================
    11                     M611rxP40.H.ASM    EQU    M611rxP40.H.ASM
    12                     
    13                     include "D:\include\EM78xx\inc\EM78M611E.H"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M612 include file                ;
     3            C        ;  Description: The Definition of EM78M612 Registers ;
     4            C        ;  Company:     Elan Electronic Corp.                  ;
     5            C        ;  Author:      YU.WEI                            ;
     6            C        ;  Date:        2009.02.26                             ;
     7            C        ;  Version:     v1.0                                   ;
     8            C        ;===================================================================
     9            C        ;-----------------------------------------------------------------
    10            C        EM78M611E.H     EQU     EM78M611E.H
    11            C        
    12            C        ;-----------------------------------------------------------------
    13            C        ; Indirect Addressing register
    14       0000 C        	R0      ==      0X00
    15            C        
    16            C        ; Time Clock/Counter
    17       0001 C        	R1      ==      0X01
    18       0001 C        	TCC     ==      0X01
    19            C        
    20            C        ; Program Counter
    21       0002 C        	R2      ==      0X02
    22       0002 C        	PC      ==      0X02
    23            C        
    24            C        ; Status Register
    25       0003 C        	R3      ==      0X03
    26       0003 C        	STATUS  ==      0X03
    27            C        	;{
    28       0000 C        		C       == 0X00; CARRYFLAG
    29       0001 C        		DC      == 0X01; AUXILIARY CARRY FLAG
    30       0002 C        		Z       == 0X02; ZERO FLAG
    31       0003 C        		P       == 0X03; POWER DOWN BIT
    32       0004 C        		T       == 0X04; TIME-OUT BIT
    33       0005 C        		PS0     == 0X05; PAGE select BIT 1
    34       0006 C        		PS1     == 0X06; PAGE select BIT 2
    35       0007 C        		PS2     == 0X07; PAGE select BIT 3
    36            C        		;{
    37            C        			PAGE0	MACRO			;000
    38            C        				BC	STATUS,PS2
    39            C        				BC	STATUS,PS1
    40            C        				BC	STATUS,PS0
    41            C        				ENDM
    42            C        			PAGE1	MACRO			;001
    43            C        				BC	STATUS,PS2
    44            C        				BC	STATUS,PS1
    45            C        				BS	STATUS,PS0
    46            C        				ENDM
    47            C        			PAGE2	MACRO			;010
    48            C        				BC	STATUS,PS2
    49            C        				BS	STATUS,PS1
    50            C        				BC	STATUS,PS0
    51            C        				ENDM
    52            C        			PAGE3	MACRO			;011
    53            C        				BC	STATUS,PS2
    54            C        				BS	STATUS,PS1
    55            C        				BS	STATUS,PS0
    56            C        				ENDM
    57            C        			PAGE4	MACRO			;100
    58            C        				BS	STATUS,PS2
    59            C        				BC	STATUS,PS1
    60            C        				BC	STATUS,PS0
    61            C        				ENDM
    62            C        			PAGE5	MACRO			;101
    63            C        				BS	STATUS,PS2
    64            C        				BC	STATUS,PS1
    65            C        				BS	STATUS,PS0
    66            C        				ENDM
    67            C        
    68            C        		;}
    69            C                  ;}
    70            C        
    71            C        
    72            C        ; RAM Select Register (RSR)
    73       0004 C        	R4             ==     0X04;
    74       0004 C        	RSR            ==     0X04
    75            C        	;{
    76       0006 C        		BK0     == 0X06; BANK selector BIT 0
    77       0007 C        		BK1     == 0X07; BANK selector BIT 1
    78            C        
    79            C        		BANK0	MACRO		;00
    80            C        			BC	RSR,BK0
    81            C        			BC	RSR,BK1
    82            C        			ENDM
    83            C        		BANK1	MACRO		;01
    84            C        			BS	RSR,BK0
    85            C        			BC	RSR,BK1
    86            C        			ENDM
    87            C        		BANK2	MACRO		;10
    88            C        			BC	RSR,BK0
    89            C        			BS	RSR,BK1
    90            C        			ENDM
    91            C        		BANK3	MACRO		;11
    92            C        			BS	RSR,BK0
    93            C        			BS	RSR,BK1
    94            C        			ENDM
    95            C        	;}
    96            C        
    97            C        ;====================================================================
    98       0005 C        	R5      == 0X05
    99       0005 C        	PORT5   == 0X05
   100            C        	;{
   101       0007 C        		P57	== 0X07
   102       0006 C        		P56	== 0X06
   103       0005 C        		P55	== 0X05
   104       0004 C        		P54	== 0X04
   105       0003 C        		P53	== 0X03
   106       0002 C        		P52	== 0X02
   107       0001 C        		P51	== 0X01
   108       0000 C        		P50	== 0X00
   109            C        	;}
   110            C        
   111            C        ;====================================================================
   112       0006 C        	R6      == 0X06
   113       0006 C        	PORT6   == 0X06
   114            C        	;{
   115       0007 C        		P67	== 0X07
   116       0006 C        		P66	== 0X06
   117       0005 C        		P65	== 0X05
   118       0004 C        		P64	== 0X04
   119       0003 C        		P63	== 0X03
   120       0002 C        		P62	== 0X02
   121       0001 C        		P61	== 0X01
   122       0000 C        		P60	== 0X00
   123            C        	;}
   124            C        
   125            C        ;====================================================================
   126       0007 C        	R7      == 0X07
   127       0007 C        	PORT7   == 0X07
   128            C        	;{
   129       0007 C        		P77	== 0X07
   130       0006 C        		P76	== 0X06
   131       0005 C        		P75	== 0X05
   132       0004 C        		P74	== 0X04
   133       0003 C        		P73	== 0X03
   134       0002 C        		P72	== 0X02
   135       0001 C        		P71	== 0X01
   136       0000 C        		P70	== 0X00
   137            C        	;}
   138            C        
   139            C        ;====================================================================
   140       0008 C        	R8      == 0X08; /PORT6 WAKE-UP PIN SELECT REGISTER
   141       0008 C        	PORT8   == 0X08
   142            C        	;{
   143       0007 C        		P87	== 0X07
   144       0006 C        		P86	== 0X06
   145       0005 C        		P85	== 0X05
   146       0004 C        		P84	== 0X04
   147       0003 C        		P83	== 0X03
   148       0002 C        		P82	== 0X02
   149       0001 C        		P81	== 0X01
   150       0000 C        		P80	== 0X00
   151            C        	;}
   152            C        
   153            C        ;====================================================================
   154       0009 C        	R9      == 0X09; /PORT7 WAKE-UP PIN SELECT REGISTER
   155       0009 C        	PORT9   == 0X09;
   156            C        	;{
   157       0007 C        		P97	== 0X07
   158       0006 C        		P96	== 0X06
   159       0005 C        		P95	== 0X05
   160       0004 C        		P94	== 0X04
   161       0003 C        		P93	== 0X03
   162       0002 C        		P92	== 0X02
   163       0001 C        		P91	== 0X01
   164       0000 C        		P90	== 0X00
   165            C        	;}
   166            C        
   167            C        ;====================================================================
   168       000A C        	RA      == 0X0A; HIGH PATTERN COUNTER
   169       000A C        	EECR    == 0X0A
   170            C        	;{
   171       0002 C        		EE_OK	== 0X02
   172       0001 C        		EE_C1	== 0X01
   173       0000 C        		EE_C0	== 0X00
   174            C        	;}
   175            C        
   176            C        ;====================================================================
   177       000B C        	RB      == 0X0B; LOW PATTERN COUNTER
   178       000B C        	PDACR       == 0X0B
   179            C        	;{
   180       0007 C        		SE2F    == 0X07
   181       0006 C        		SE1F    == 0X06
   182       0005 C        		SR2	== 0X05
   183       0004 C        		SR1	== 0X04
   184       0003 C        		SR0	== 0X03
   185       0002 C        		DB2	== 0X02
   186       0001 C        		DB1	== 0X01
   187       0000 C        		DB0	== 0X00
   188            C        	;}
   189            C        
   190            C        ;====================================================================
   191       000C C        	RC      == 0X0C; USB APPLICATION STATUS REGISTER
   192       000C C        	USBASR  == 0X0C
   193            C        	;{
   194       0007 C        		EP0_W           == 0X07
   195       0006 C        		EP0_R           == 0X06
   196       0005 C        		EP1_R           == 0X05
   197       0004 C        		EP2_R           == 0X04
   198       0003 C        		EP2_W           == 0X03
   199       0002 C        		HOST_SUSPEND    == 0X02
   200       0001 C        		EP0_BUSY        == 0X01
   201       0000 C        		STALL           == 0X00
   202            C        	;}
   203            C        
   204            C        ;====================================================================
   205       000D C        	RD       == 0X0D; USB APPLICATION FIFO ADDRESS REGISTER
   206       000D C        	FIFOAR   == 0X0D
   207            C        	;{
   208            C        		;---------------------------
   209            C        		;   00	Endpoint 0
   210            C        			;---------
   211            C        			;    0
   212            C        			;---------
   213            C        			;    1
   214            C        			;---------
   215            C        			;    2
   216            C        			;---------
   217            C        			;    3
   218            C        			;---------
   219            C        			;    4
   220            C        			;---------
   221            C        			;    5
   222            C        			;---------
   223            C        			;    6
   224            C        			;---------
   225            C        			;    7
   226            C        		;---------------------------
   227            C        		;    01    ;
   228            C        		;    :     ;
   229            C        		;    :	   ; Endpoint address
   230            C        		;    :     ;
   231            C        		;    0F    ;
   232            C        		;---------------------------
   233            C        		;    10	   ; EP0_STATUS
   234            C        		;---------------------------
   235            C        		;    11    ;
   236            C        		;    :     ;
   237            C        		;    :     ; EP_STATUS
   238            C        		;    :     ;
   239            C        		;    1F    ;
   240            C        		;---------------------------
   241            C        
   242            C        	;}
   243            C        
   244            C        ;====================================================================
   245       000E C        	RE          == 0X0E; USB APPLICATION FIFO DATA REGISTER A[0..3]POINTER [4..7]COUNTER
   246       000E C        	FIFODR      == 0X0E
   247            C        	;{
   248            C        
   249            C        	;}
   250            C        
   251            C        ;====================================================================
   252       000F C        	RF      == 0X0F; INTERRUPT STATUS REGISTER
   253       000F C        	ISR     == 0X0F; INTERRUPT STATUS REGISTER
   254            C        	;{
   255       0000 C        		TCCIF       == 0X00
   256       0001 C        		EP0IF       == 0X01
   257       0002 C        		USBSIF      == 0X02
   258       0003 C        		USBRIF      == 0X03
   259       0004 C        		P7SCIF      == 0X04
   260       0005 C        		SE1IF       == 0X05
   261       0006 C        		SE2IF       == 0X06
   262       0007 C        		USBHRIF     == 0X07
   263            C        	;}
   264            C        
   265            C        ;====================================================================
   266            C        
   267            C        
   268       0005 C        	IOC5		== 0X05;	port 5 direction control register
   269       0006 C        	IOC6		== 0X06;	port 6 direction control register
   270       0007 C        	IOC7		== 0X07;	port 7 direction control register
   271       0008 C        	IOC8		== 0X08; 	port 8 direction control register
   272       0009 C        	IOC9		== 0X09; 	port 9 direction control register
   273       000A C        	IOCA		== 0X0A; 	OPERATION MODE
   274            C        	;{
   275       0000 C        		USBM        == 0X00
   276       0001 C        		PS2M        == 0X01
   277       0002 C        		PDAM        == 0X02
   278       0003 C        		EXRegSel    == 0X03
   279            C        	;}
   280            C        ;====================================================================
   281       000B C        	IOCB		== 0X0B; PORT6 PULL-LOW
   282            C        
   283            C        ;====================================================================
   284       000C C        	IOCC		== 0X0C; PORT6 PULL-HIGH
   285            C        
   286            C        ;====================================================================
   287       000D C        	IOCD		== 0X0D; PORT7 PULL-HIGH
   288            C        
   289            C        ;====================================================================
   290       000E C        	IOCE		== 0X0E; SPECIAL FUNCTION
   291       000E C        	SFCR		== 0X0E;
   292            C        	;{
   293       0004 C        		RUN         == 0X04
   294       0005 C        		WTE         == 0X05
   295       0002 C        		_PULL8      == 0X02
   296       0001 C        		_PULL6      == 0X01
   297       0000 C        		_PULL5      == 0X00
   298            C        	;}
   299            C        
   300            C        ;====================================================================
   301       000F C        	IOCF    == 0X0F; INTERRUPT MASK
   302       000F C        	IMR     == 0X0F
   303            C        	;{
   304       0000 C        		TCIE        == 0X00
   305       0001 C        		EPOIE       == 0X01
   306       0002 C        		USBSIE      == 0X02
   307       0003 C        		USBRIE      == 0X03
   308       0004 C        		P5SCIE      == 0X04
   309       0005 C        		SE1IE       == 0X05
   310       0006 C        		SE2IE       == 0X06
   311       0004 C        		USBHRIE     == 0X04
   312            C        	;}
   313            C        
   314            C        
   315            C        
   316            C        
   317            C        ;======================================================;
   318            C        ; Register R10~R3F                                     ;
   319            C        ;======================================================;
   320            C        ;
   321            C        ; (R10 ~ R3F): General Purpose Register
   322            C        ;
   323       0010 C         R10    ==    0x10
   324       0011 C         R11    ==    0x11
   325       0012 C         R12    ==    0x12
   326       0013 C         R13    ==    0x13
   327       0014 C         R14    ==    0x14
   328       0015 C         R15    ==    0x15
   329       0016 C         R16    ==    0x16
   330       0017 C         R17    ==    0x17
   331       0018 C         R18    ==    0x18
   332       0019 C         R19    ==    0x19
   333       001A C         R1A    ==    0x1A
   334       001B C         R1B    ==    0x1B
   335       001C C         R1C    ==    0x1C
   336       001D C         R1D    ==    0x1D
   337       001E C         R1E    ==    0x1E
   338       001F C         R1F    ==    0x1F
   339            C        ;
   340       0020 C         R20    ==    0x20
   341       0021 C         R21    ==    0x21
   342       0022 C         R22    ==    0x22
   343       0023 C         R23    ==    0x23
   344       0024 C         R24    ==    0x24
   345       0025 C         R25    ==    0x25
   346       0026 C         R26    ==    0x26
   347       0027 C         R27    ==    0x27
   348       0028 C         R28    ==    0x28
   349       0029 C         R29    ==    0x29
   350       002A C         R2A    ==    0x2A
   351       002B C         R2B    ==    0x2B
   352       002C C         R2C    ==    0x2C
   353       002D C         R2D    ==    0x2D
   354       002E C         R2E    ==    0x2E
   355       002F C         R2F    ==    0x2F
   356            C        ;
   357       0030 C         R30    ==    0x30
   358       0031 C         R31    ==    0x31
   359       0032 C         R32    ==    0x32
   360       0033 C         R33    ==    0x33
   361       0034 C         R34    ==    0x34
   362       0035 C         R35    ==    0x35
   363       0036 C         R36    ==    0x36
   364       0037 C         R37    ==    0x37
   365       0038 C         R38    ==    0x38
   366       0039 C         R39    ==    0x39
   367       003A C         R3A    ==    0x3A
   368       003B C         R3B    ==    0x3B
   369       003C C         R3C    ==    0x3C
   370       003D C         R3D    ==    0x3D
   371       003E C         R3E    ==    0x3E
   372       003F C         R3F    ==    0x3F
    14                     include "D:\include\EM78xx\inc\EM78Math.H"
     1            C        ;**********************************************************************;
     2            C        ; Title:        EM78Math Macros Define                                 ;
     3            C        ; Description:  The Maths for EM78x447xxx                              ;
     4            C        ; Company:      Elan Corp.Inc                                          ;
     5            C        ; Author:       Shenzhen 8Bit Tean                                     ;
     6            C        ; Date:         5/26/2004                                              ;
     7            C        ; Version:      1.0                                                    ;
     8            C        ;**********************************************************************
     9            C        ;----------------------------------------------------------------
    10            C        EM78Math.H      EQU     EM78Math.H
    11            C        
    12            C        
    13            C        ;----------------------------------------------------------------
    14            C        
    15            C        
    16            C        
    17            C        
    18            C        ;**********************************************************************;
    19            C        ; Title:       1 Byte Binary Code Transform BCD Code                   ;
    20            C        ; Description: Hundred Bigit Of Bcd Cade Storage In  Low Bigit  Of     ;
    21            C        ;              reg_acc3,Entries Bigit Of Bcd Cade Storage In High      ;
    22            C        ;              Bigit Of reg_acc2, Binary Data Storage In reg_acc1      ;
    23            C        ; Arithmetic:  BCD==100*a+10*b+c                                       ;
    24            C        ; Input:       reg_acc1                                                ;
    25            C        ; Output:      reg_acc3, reg_acc2                                      ;
    26            C        ; Variable Register:None                                               ;
    27            C        ; Register Changed: R3, 0 ;ACC                                         ;
    28            C        ;**********************************************************************;
    29            C        ;-----------------------------------------------------------------
    30            C        mBinToBcd1 MACRO reg_acc1, reg_acc3, reg_acc2
    31            C        ;
    32            C                CLR     reg_acc2        ;clear BCD data register
    33            C                CLR     reg_acc3
    34            C                MOV     A, reg_acc1
    35            C        $Bin_Bcd1:
    36            C                ADD     A, @156         ;subtract 100 from binary that is transform
    37            C                JBS     STATUS, C       ;borrow bigit?
    38            C                JMP     $Bin_Bcd2       ;borrow bigit jump to Bin_Bcd2
    39            C                INC     reg_acc3        ;if don't borrow bigit then hundred bigit adding 1
    40            C                JMP     $Bin_Bcd1       ;backing out
    41            C        $Bin_Bcd2:
    42            C                ADD     A, @100         ;有借位，则加回被减去的数100
    43            C                MOV     reg_acc1, A
    44            C        $Bin_Bcd3:
    45            C                ADD     A, @246         ;余下的被减数再减10
    46            C                JBS     STATUS, C       ;有借位吗？
    47            C                JMP     $Bin_Bcd4       ;有借位，则跳出
    48            C                INC     reg_acc2        ;无借位，则BCD码的十位寄存器加1
    49            C                JMP     $Bin_Bcd3
    50            C        $Bin_Bcd4:
    51            C                ADD     A, @10          ;有借位，则加回被减去的数10
    52            C                SWAP    reg_acc2        ;将BCD码的十位存到reg_acc2的高半字节
    53            C                ADD     reg_acc2, A     ;将BCD码的个位存到reg_acc2的低半字节
    54            C                ENDM
    55            C        ;
    56            C        ;**********************************************************************;
    57            C        ; Title:       2 Byte Binary Code Transform BCD Code                   ;
    58            C        ; Description: Highest Bigit Of Bcd Storage In Low Byte Of reg_acc5,   ;
    59            C        ;              Lowest Bigit Of Bcd Storage In Low Byte Of reg_acc3,    ;
    60            C        ;              High Bigit Of Binary Storage In reg_acc1,               ;
    61            C        ;              Low Bigit Of Binart Storage In reg_acc2,                ;
    62            C        ; Input:       reg_acc1, reg_acc2                                      ;
    63            C        ; Output:      reg_acc3, reg_acc4, reg_acc5                            ;
    64            C        ; Variable Register:reg_acc, reg_accd                                  ;
    65            C        ; Register Changed: R3, 0; ACC                                         ;
    66            C        ; Status:      1                                                       ;
    67            C        ;**********************************************************************;
    68            C        ;
    69            C        mBinToBcd2 MACRO reg_acc2, reg_acc1, reg_acc5, reg_acc4, reg_acc3
    70            C        ;
    71            C                MOV     A, @16          ;设定移位字节长度(其值=byte*8)
    72            C                MOV     reg_acc, A
    73            C                CLR     reg_acc5        ;清BCD码寄存器
    74            C                CLR     reg_acc4
    75            C                CLR     reg_acc3
    76            C                BC      STATUS, C       ;清R3标志位C
    77            C        $Bin_Bcd1:
    78            C                RLC     reg_acc1        ;左移被转换的字节的最低位寄存器
    79            C                RLC     reg_acc2        ;左移被转换的字节的最高位寄存器
    80            C                RLC     reg_acc3        ;左移BCD码的最低位寄存器
    81            C                RLC     reg_acc4
    82            C                RLC     reg_acc5        ;左移BCD码的最高位寄存器
    83            C                DJZ     reg_acc         ;移位完成了吗？
    84            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
    85            C                JMP     $Bin_Bcd3       ;移位完，跳出
    86            C        $Bin_Bcd2:
    87            C                MOV     A, reg_acc3     ;对reg_acc3进行BCD码调整
    88            C                CALL    $bcdadj         ;调BCD码调整子程序
    89            C                MOV     reg_acc3, A     ;
    90            C                MOV     A, reg_acc4     ;对reg_acc4进行BCD码调整
    91            C                CALL    $BCDADJ
    92            C                MOV     reg_acc4, A
    93            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
    94            C                CALL    $BCDADJ
    95            C                MOV     reg_acc5, A
    96            C                JMP     $Bin_Bcd1       ;返回，继续进行移位处理
    97            C        ;-------BCD Code Adjust Subprogram---------------
    98            C        $BCDADJ:
    99            C                ADD     A, @51
   100            C                MOV     reg_accd, A
   101            C                JBS     reg_accd, 3
   102            C                ADD     A, @253
   103            C                JBS     reg_accd, 7
   104            C                ADD     A, @208
   105            C                RET
   106            C        $Bin_Bcd3:
   107            C                ENDM
   108            C        ;
   109            C        ;**********************************************************************;
   110            C        ; Title:      3 Byte Binary Code Transform Bcd Code                    ;
   111            C        ; Description:reg_acc7的高半字节存放BCD码的最高位，                    ;
   112            C        ;             reg_acc4的低半字节存放BCD码的最低位,                     ;
   113            C        ;             reg_acc3存放被转换字节的最高位，                         ;
   114            C        ;             reg_acc1存放被转换字节的最低位。                         ;
   115            C        ; Input:      reg_acc1, reg_acc2, reg_acc3                             ;
   116            C        ; Output:     reg_acc4, reg_acc5, reg_acc6, reg_acc7                   ;
   117            C        ; Variable Register:reg_acc, reg_accd                                  ;
   118            C        ; Register Changed: R3, 0;ACC                                          ;
   119            C        ; stack:      1                                                        ;
   120            C        ;**********************************************************************;
   121            C        ;
   122            C        mBinToBcd3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc7, reg_acc6, reg_acc5, reg_acc4
   123            C        ;
   124            C                MOV     A, @24          ;设定移位字节长度（其值=byte*8)
   125            C                MOV     reg_acc, A
   126            C                CLR     reg_acc4
   127            C                CLR     reg_acc5
   128            C                CLR     reg_acc6
   129            C                CLR     reg_acc7
   130            C                BC      STATUS, C       ;清R3标志位C
   131            C        $Bin_Bcd1:
   132            C                RLC     reg_acc1        ;左移被转换字节数的最低位寄存器
   133            C                RLC     reg_acc2
   134            C                RLC     reg_acc3        ;左移被转换字节数的最高位寄存器
   135            C                RLC     reg_acc4        ;左移BCD码的最低位寄存器
   136            C                RLC     reg_acc5
   137            C                RLC     reg_acc6
   138            C                RLC     reg_acc7        ;左移BCD码的最高位寄存器
   139            C                DJZ     reg_acc         ;移位完成了吗？
   140            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   141            C                JMP     $Bin_Bcd3       ;移位完，跳出
   142            C        $Bin_Bcd2:
   143            C                MOV     A, reg_acc4     ;对reg_acc4进行BCD码调整
   144            C                CALL    $BCDADJ         ;调BCD码调整子程序
   145            C                MOV     reg_acc4, A
   146            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
   147            C                CALL    $BCDADJ
   148            C                MOV     reg_acc5, A
   149            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   150            C                CALL    $BCDADJ
   151            C                MOV     reg_acc6, A
   152            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   153            C                CALL    $BCDADJ
   154            C                MOV     reg_acc7, A
   155            C                JMP     $Bin_Bcd1       ;移位未完，返回，继续进行移位处理
   156            C        ;-------BCD Code Adjust Subprogram---------------
   157            C        $BCDADJ:
   158            C                ADD     A, @51
   159            C                MOV     reg_accd, A
   160            C                JBS     reg_accd, 3
   161            C                ADD     A, @253
   162            C                JBS     reg_accd, 7
   163            C                ADD     A, @208
   164            C                RET
   165            C        $Bin_Bcd3:
   166            C                ENDM
   167            C        ;
   168            C        ;**********************************************************************;
   169            C        ; Title:      4 Byte Binary Code Transform Bcd Code                    ;
   170            C        ; Description:reg_acc9的高半字节存放BCD码的最高位，                    ;
   171            C        ;             reg_acc5的低半字节存放BCD码的最低位，                    ;
   172            C        ;             reg_acc4存放被转换字节的最高位，                         ;
   173            C        ;             reg_acc1存放被转换字节的最低位?                          ;
   174            C        ; Arithmetic:                                                          ;
   175            C        ; Input:      reg_acc1, reg_acc2, reg_acc3, reg_acc4                   ;
   176            C        ; Output:     reg_acc5, reg_acc6, reg_acc7, reg_acc8, reg_acc9         ;
   177            C        ; Variable Register:reg_acc, reg_accd                                  ;
   178            C        ; Register Changed: R3, 0; ACC                                         ;
   179            C        ; stack:      1                                                        ;
   180            C        ;**********************************************************************;
   181            C        ;
   182            C        mBinToBcd4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc9, reg_acc8, reg_acc7, reg_acc6, reg_acc5
   183            C        ;
   184            C                MOV     A,  @32         ;设定移位字节长度(其值=byte*8)
   185            C                MOV     reg_acc, A
   186            C                CLR     reg_acc5        ;清BCD码寄存器
   187            C                CLR     reg_acc6
   188            C                CLR     reg_acc7
   189            C                CLR     reg_acc8
   190            C                CLR     reg_acc9
   191            C                BC      STATUS, C       ;清R3标志位C
   192            C        $Bin_Bcd1:
   193            C                RLC     reg_acc1        ;左移被转换字节数的最低位寄存器
   194            C                RLC     reg_acc2
   195            C                RLC     reg_acc3
   196            C                RLC     reg_acc4        ;左移被转换字节数的最高位寄存器
   197            C                RLC     reg_acc5
   198            C                RLC     reg_acc6        ;左移BCD码的最低位寄存器
   199            C                RLC     reg_acc7
   200            C                RLC     reg_acc8
   201            C                RLC     reg_acc9        ;左移BCD码的最高位寄存器
   202            C                DJZ     reg_acc         ;移位完成了吗？
   203            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   204            C                JMP     $Bin_Bcd3       ;移位完，跳出
   205            C        $Bin_Bcd2:
   206            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
   207            C                CALL    $BCDADJ         ;调BCD码调整子程序
   208            C                MOV     reg_acc5, A
   209            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   210            C                CALL    $BCDADJ
   211            C                MOV     reg_acc6, A
   212            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   213            C                CALL    $BCDADJ
   214            C                MOV     reg_acc7, A
   215            C                MOV     A, reg_acc8     ;对reg_acc8进行BCD码调整
   216            C                CALL    $BCDADJ
   217            C                MOV     reg_acc8, A
   218            C                MOV     A, reg_acc9     ;对reg_acc9进行BCD码调整
   219            C                CALL    $BCDADJ
   220            C                MOV     reg_acc9, A
   221            C                JMP     $Bin_Bcd1       ;移位未完成，返回，继续进行移位处理
   222            C        ;-------BCD Code Adjust Subprogram---------------
   223            C        $BCDADJ:
   224            C                ADD     A, @51
   225            C                MOV     reg_accd, A
   226            C                JBS     reg_accd, 3
   227            C                ADD     A, @253
   228            C                JBS     reg_accd, 7
   229            C                ADD     A, @208
   230            C                RET
   231            C        $Bin_Bcd3:
   232            C                ENDM
   233            C        ;**********************************************************************;
   234            C        ; Title:      5 Byte Binary Code Transform Bcd Code                    ;
   235            C        ; Description:reg_accc的低半字节存放BCD的最高位，                      ;
   236            C        ;             reg_acc6的低半字节存放BCD的最低位，                      ;
   237            C        ;             reg_acc5存放被转换字节的最高位，                         ;
   238            C        ;             reg_acc1存放被转换字节的最低位。                         ;
   239            C        ; Input:      reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,        ;
   240            C        ; Output:     reg_acc6, reg_acc7, reg_acc8, reg_acc9, reg_acca,        ;
   241            C        ;             reg_accb, reg_accc                                       ;
   242            C        ; Variable Register:reg_acc, reg_accd                                  ;
   243            C        ; Register Changed: R3, 0;ACC                                          ;
   244            C        ; Stack:      1                                                        ;
   245            C        ;**********************************************************************;
   246            C        ;
   247            C        mBinToBcd5 MACRO reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
   248            C        ;
   249            C                MOV     A,  @40         ;设定移位字节长度(其值=byte*8)
   250            C                MOV     reg_acc, A
   251            C                CLR     reg_acc6        ;清BCD码寄存器
   252            C                CLR     reg_acc7
   253            C                CLR     reg_acc8
   254            C                CLR     reg_acc9
   255            C                CLR     reg_acca
   256            C                CLR     reg_accb
   257            C                CLR     reg_accc
   258            C                BC      STATUS, C       ;清R3标志位C
   259            C        $Bin_Bcd1:
   260            C                RLC     reg_acc1
   261            C                RLC     reg_acc2
   262            C                RLC     reg_acc3        ;左移被转换字节的最低位寄存器
   263            C                RLC     reg_acc4        ;
   264            C                RLC     reg_acc5        ;左移被转换字节的最高位寄存器
   265            C        ;
   266            C                RLC     reg_acc6        ;左移BCD码寄存器的最低位
   267            C                RLC     reg_acc7
   268            C                RLC     reg_acc8
   269            C                RLC     reg_acc9
   270            C                RLC     reg_acca
   271            C                RLC     reg_accb
   272            C                RLC     reg_accc        ;左移BCD码寄存器的最高位
   273            C                DJZ     reg_acc         ;移位完成了吗？
   274            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   275            C                JMP     $Bin_Bcd3       ;移位完，跳出
   276            C        $Bin_Bcd2:
   277            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   278            C                CALL    $BCDADJ         ;调BCD码调整子程序
   279            C                MOV     reg_acc6, A
   280            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   281            C                CALL    $BCDADJ
   282            C                MOV     reg_acc7, A
   283            C                MOV     A, reg_acc8     ;对reg_acc8进行BCD码调整
   284            C                CALL    $BCDADJ
   285            C                MOV     reg_acc8, A
   286            C                MOV     A, reg_acc9     ;对reg_acc9进行BCD码调整
   287            C                CALL    $BCDADJ
   288            C                MOV     reg_acc9, A
   289            C                MOV     A, reg_acca     ;对reg_acca进行BCD码调整
   290            C                CALL    $BCDADJ
   291            C                MOV     reg_acca, A
   292            C                MOV     A, reg_accb     ;对reg_accb进行BCD码调整
   293            C                CALL    $BCDADJ
   294            C                MOV     reg_accb, A
   295            C                MOV     A, reg_accc     ;对reg_accc进行BCD码调整
   296            C                CALL    $BCDADJ
   297            C                MOV     reg_accc, A
   298            C                JMP     $Bin_Bcd1       ;未移完，返回，继续进行移位处理
   299            C        ;
   300            C        ;-------BCD Code Adjust Subprogram---------------
   301            C        $BCDADJ:
   302            C                ADD     A, @51
   303            C                MOV     reg_accd, A
   304            C                JBS     reg_accd, 3
   305            C                ADD     A, @253
   306            C                JBS     reg_accd, 7
   307            C                ADD     A, @208
   308            C                RET
   309            C        $Bin_Bcd3:
   310            C                ENDM
   311            C        ;
   312            C        ;**********************************************************************;
   313            C        ; Title:      1 Byte Bcd Code Transform 1 Byte Binary Code             ;
   314            C        ; Input:      reg_acc1(BCD code)                                       ;
   315            C        ; Output:     reg_acc2(Binary Code)                                    ;
   316            C        ; Register Changed: STATUS, C;ACC                                      ;
   317            C        ;**********************************************************************;
   318            C        ;
   319            C        mBcdToBin1 MACRO reg_acc1, reg_acc2
   320            C        ;
   321            C                CLR     reg_acc2
   322            C                SWAPA   reg_acc1        ;将reg_acc1的高半字节送到A的低半字节
   323            C                AND     A, @0X0F        ;屏蔽reg_acc1, 0-3bit.
   324            C                MOV     reg_acc2, A
   325            C                BC      STATUS, C
   326            C                RLC     reg_acc2        ;reg_acc2*10
   327            C                RLC     reg_acc2
   328            C                ADD     reg_acc2, A
   329            C                RLC     reg_acc2
   330            C                MOV     A, reg_acc1
   331            C                AND     A, @0X0F        ;屏蔽reg_acc1, 4-7bit
   332            C                ADD     reg_acc2, A     ;bcd code的十位数乘10后加bcd code的个位数
   333            C                ENDM
   334            C        ;
   335            C        ;**********************************************************************;
   336            C        ; Title:     2 Byte Bcd Code Transform 2 Byte Binary Code              ;
   337            C        ; Input:     reg_acc1, reg_acc2;reg_acc2:High Bigit Of Bcd Code;       ;
   338            C        ;            reg_acc1:Low Bigit Of Bcd Code.                           ;
   339            C        ; Output:    reg_acc3, reg_acc4;reg_acc4:High Byte Binary Code;        ;
   340            C        ;            reg_acc3:Low Byte Of Binary Code.                         ;
   341            C        ; Register Changed: STATUS, C; ACC                                     ;
   342            C        ; Stack:     1                                                         ;
   343            C        ;**********************************************************************;
   344            C        ;
   345            C        mBcdToBin2 MACRO reg_acc2, reg_acc1, reg_acc4, reg_acc3
   346            C        ;
   347            C                CLR     reg_acc3        ;clear binary code register
   348            C                CLR     reg_acc4
   349            C                MOV     A, @16          ;移位的次数（reg_acc==byte*8)
   350            C                Mov     reg_acc, A
   351            C        $Bcd_Bin1:
   352            C                BC      STATUS, C
   353            C                RRC     reg_acc2        ;将BCD数和BINARY数一起右移，从高移到低
   354            C                RRC     reg_acc1
   355            C                RRC     reg_acc4
   356            C                RRC     reg_acc3
   357            C                MOV     A, reg_acc1     ;对BCD数进行BCD调整
   358            C                CALL    $Binadj
   359            C                MOV     reg_acc1, A
   360            C                MOV     A, reg_acc2
   361            C                CALL    $Binadj
   362            C                MOV     reg_acc2, A
   363            C                DJZ     reg_acc
   364            C                JMP     $Bcd_Bin1
   365            C                JMP     $Bcd_Bin2
   366            C        $Binadj:
   367            C                MOV     reg_accd, A
   368            C                JBC     reg_accd, 3
   369            C                ADD     A, @253
   370            C                JBC     reg_accd, 7
   371            C                ADD     A, @208
   372            C                RET
   373            C        $Bcd_Bin2:
   374            C                ENDM
   375            C        ;
   376            C        ;**********************************************************************;
   377            C        ; Title:    3 Byte Bcd Code Transform 3 Byte Binary Code               ;
   378            C        ; Input:    reg_acc1,reg_acc2,reg_acc3;reg_acc3:High Bigit Of Bcd Code;;
   379            C        ;           reg_acc1:Low Bigit Of Bcd Code.                            ;
   380            C        ; Output:   reg_acc4,reg_acc5,reg_acc6;reg_acc6:High Byte Binary Code; ;
   381            C        ;           reg_acc4:Low Byte Of Binary Code.                          ;
   382            C        ; Register Changed: STATUS, C; ACC                                     ;
   383            C        ; Stack:     1                                                         ;
   384            C        ;**********************************************************************;
   385            C        ;
   386            C        mBcdToBin3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5, reg_acc4
   387            C        ;
   388            C                CLR     reg_acc4
   389            C                CLR     reg_acc5
   390            C                CLR     reg_acc6
   391            C                MOV     A, @24          ;移位的次数（reg_acc==BYTE*8)
   392            C                MOV     reg_acc, A
   393            C        $Bcd_Bin1:
   394            C                BC      STATUS, C
   395            C                RRC     reg_acc3
   396            C                RRC     reg_acc2
   397            C                RRC     reg_acc1
   398            C                RRC     reg_acc6
   399            C                RRC     reg_acc5
   400            C                RRC     reg_acc4
   401            C                MOV     A, reg_acc1
   402            C                CALL    $Binadj
   403            C                MOV     reg_acc1, A
   404            C                MOV     A, reg_acc2
   405            C                CALL    $Binadj
   406            C                MOV     reg_acc2, A
   407            C                MOV     A, reg_acc3
   408            C                CALL    $Binadj
   409            C                MOV     reg_acc3, A
   410            C                DJZ     reg_acc
   411            C                JMP     $Bcd_Bin1
   412            C                JMP     $Bcd_Bin2
   413            C        $Binadj:
   414            C                MOV     reg_accd, A
   415            C                JBC     reg_accd, 3
   416            C                ADD     A, @253
   417            C                JBC     reg_accd, 7
   418            C                ADD     A, @208
   419            C                RET
   420            C        $Bcd_Bin2:
   421            C                ENDM
   422            C        ;
   423            C        ;**********************************************************************;
   424            C        ; Title:     4 Byte Bcd Code Transform 4 Byte Binary Code              ;
   425            C        ; Input:     reg_acc1, reg_acc2, reg_acc3, reg_acc4;reg_acc4:High Bigit;
   426            C        ;            Of Bcd Code;reg_acc1:Low Bigit Of Bcd Code.               ;
   427            C        ; Output:    reg_acc5, reg_acc6, reg_acc7, reg_acc8;reg_acc8:High Byte ;
   428            C        ;            Binary Code;reg_acc5:Low Byte Of Binary Code.             ;
   429            C        ; Register Changed: STATUS, C;ACC                                      ;
   430            C        ; Stack:     1                                                         ;
   431            C        ;**********************************************************************;
   432            C        ;
   433            C        mBcdToBin4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc8, reg_acc7, reg_acc6, reg_acc5
   434            C        ;
   435            C                CLR     reg_acc5
   436            C                CLR     reg_acc6
   437            C                CLR     reg_acc7
   438            C                CLR     reg_acc8
   439            C                MOV     A, @32          ;移位的次数（reg_acc==BYTE*8)
   440            C                MOV     reg_acc, A
   441            C        $Bcd_Bin1:
   442            C                BC      STATUS, C
   443            C                RRC     reg_acc4
   444            C                RRC     reg_acc3
   445            C                RRC     reg_acc2
   446            C                RRC     reg_acc1
   447            C                RRC     reg_acc8
   448            C                RRC     reg_acc7
   449            C                RRC     reg_acc6
   450            C                RRC     reg_acc5
   451            C                MOV     A, reg_acc1
   452            C                CALL    $Binadj
   453            C                MOV     reg_acc1, A
   454            C                MOV     A, reg_acc2
   455            C                CALL    $Binadj
   456            C                MOV     reg_acc2, A
   457            C                MOV     A, reg_acc3
   458            C                CALL    $Binadj
   459            C                MOV     reg_acc3, A
   460            C                MOV     A, reg_acc4
   461            C                CALL    $Binadj
   462            C                MOV     reg_acc4, A
   463            C                DJZ     reg_acc
   464            C                JMP     $Bcd_Bin1
   465            C                JMP     $Bcd_Bin2
   466            C        $Binadj:
   467            C                MOV     reg_accd, A
   468            C                JBC     reg_accd, 3
   469            C                ADD     A, @253
   470            C                JBC     reg_accd, 7
   471            C                ADD     A, @208
   472            C                RET
   473            C        $Bcd_Bin2:
   474            C                ENDM
   475            C        ;
   476            C        ;**********************************************************************;
   477            C        ; Title:     5 Byte Bcd Code Transform 5 Byte Binary Code              ;
   478            C        ; Input:     reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5;         ;
   479            C        ;            reg_acc5:High Bigit Of Bcd Code;reg_acc1:lOw Bigit Of     ;
   480            C        ;            Bcd Code.                                                 ;
   481            C        ; Output:    reg_acc6, reg_acc7, reg_acc8, reg_acc9, reg_acca;         ;
   482            C        ;            reg_acca:High Byte Of Binary Code;reg_acc6:Low Byte       ;
   483            C        ;            Of Binary Code.                                           ;
   484            C        ; Register Changed: STATUS, C; ACC                                     ;
   485            C        ; Stack:     1                                                         ;
   486            C        ;**********************************************************************;
   487            C        ;
   488            C        mBcdToBin5 MACRO  reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
   489            C        ;
   490            C                CLR     reg_acc6
   491            C                CLR     reg_acc7
   492            C                CLR     reg_acc8
   493            C                CLR     reg_acc9
   494            C                CLR     reg_acca
   495            C                MOV     A, @40          ;移位的次数（reg_acc==BYTE*8)
   496            C                MOV     reg_acc, A
   497            C        $Bcd_Bin1:
   498            C                BC      STATUS, C
   499            C                RRC     reg_acc5
   500            C                RRC     reg_acc4
   501            C                RRC     reg_acc3
   502            C                RRC     reg_acc2
   503            C                RRC     reg_acc1
   504            C                RRC     reg_acca
   505            C                RRC     reg_acc9
   506            C                RRC     reg_acc8
   507            C                RRC     reg_acc7
   508            C                RRC     reg_acc6
   509            C                MOV     A, reg_acc1
   510            C                CALL    $Binadj
   511            C                MOV     reg_acc1, A
   512            C                MOV     A, reg_acc2
   513            C                CALL    $Binadj
   514            C                MOV     reg_acc2, A
   515            C                MOV     A, reg_acc3
   516            C                CALL    $Binadj
   517            C                MOV     reg_acc3, A
   518            C                MOV     A, reg_acc4
   519            C                CALL    $Binadj
   520            C                MOV     reg_acc4, A
   521            C                MOV     A, reg_acc5
   522            C                CALL    $Binadj
   523            C                MOV     reg_acc5, A
   524            C                DJZ     reg_acc
   525            C                JMP     $Bcd_Bin1
   526            C                JMP     $Bcd_Bin2
   527            C        $Binadj:
   528            C                MOV     reg_accd, A
   529            C                JBC     reg_accd, 3
   530            C                ADD     A, @253
   531            C                JBC     reg_accd, 7
   532            C                ADD     A, @208
   533            C                RET
   534            C        $Bcd_Bin2:
   535            C                ENDM
   536            C        
   537            C        
   538            C        ;*****************************************************************
   539            C        ;Function:    Subtration
   540            C        ;Input:       reg_acc2, reg_acc1, reg_acc3
   541            C        ;Output:      reg_acc2, reg_acc1
   542            C        ;description: reg_acc2/reg_acc1 is the reslut;
   543            C        ;             reg_acc3 is a symbol:
   544            C        ;             0X00 Mean reslut is plus
   545            C        ;             0X01 Mean reslut is negative
   546            C        ;*****************************************************************
   547            C        mSubtration2_1 MACRO reg_acc2, reg_acc1, reg_acc3
   548            C                BC      STATUS,C
   549            C                MOV     A,reg_acc3
   550            C                SUB     reg_acc1,A
   551            C                JBC     STATUS,C
   552            C                JMP     Subtration_End
   553            C                CLR     reg_acc3
   554            C                MOV     A,@0X01
   555            C                SUB     A,reg_acc2
   556            C                JBC     STATUS,C
   557            C                DEC     reg_acc2
   558            C                JBC     STATUS,C
   559            C                INC     reg_acc3
   560            C          Subtration_End:
   561            C                ENDM
   562            C        
   563            C        ;**********************************************************************;
   564            C        ; Title:        Division 8 bits /8 bits -> 8 bit --8 bits              ;
   565            C        ; Description:  reg_acc1/reg_acc2->reg_acc1 --reg_acc2                 ;
   566            C        ; Input:        Dividend reg_acc1        Divisor    reg_acc2           ;
   567            C        ; Output:       Result   reg_acc1        Remainder  reg_acc2           ;
   568            C        ; Variable Register:None                                               ;
   569            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   570            C        ;**********************************************************************;
   571            C        mDIV1_1 MACRO reg_acc1, reg_acc2
   572            C        ;
   573            C                MOV     A, @8           ;Recurrence Cortrol Data
   574            C                MOV     reg_acc, A
   575            C                CLRA                    ;Check Divisor Is Zero
   576            C                OR      A, reg_acc2     ;Divisor load into A register
   577            C                JBC     STATUS, 2
   578            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   579            C                CLR     reg_acc2        ;Divisor Is Not Zero, Begin Peration，Then A=1
   580            C        $_Div_Sub:
   581            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   582            C                RLC     reg_acc2
   583            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   584            C                SUB     reg_acc2, a
   585            C                JBC     STATUS, C
   586            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   587            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   588            C                ADD     reg_acc2, A     ;Revert Dividend
   589            C        $_Div_Cnt:
   590            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   591            C                JMP     $_Div_Sub
   592            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   593            C        $_Div_Out:
   594            C                ENDM
   595            C        ;
   596            C        ;**********************************************************************;
   597            C        ; Title:        Division 16 bits /8 bits -> 16 bit --8 bits            ;
   598            C        ; Description:  (reg_acc2,reg_acc1)/reg_acc3                           ;
   599            C        ;               ->(reg_acc2,reg_acc1)--reg_acc3                        ;
   600            C        ; Input:        Dividend reg_acc2,reg_acc1       Divisor    reg_acc3   ;
   601            C        ; Output:       Result   reg_acc2,reg_acc1       Remainder  reg_acc3   ;
   602            C        ; Variable Register:None                                               ;
   603            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   604            C        ;**********************************************************************;
   605            C        ;
   606            C        mDIV2_1 MACRO reg_acc2, reg_acc1, reg_acc3
   607            C        ;
   608            C                MOV     A, @16          ;Recurrence Cortrol Data
   609            C                MOV     reg_acc, A
   610            C                CLRA                    ;Check Divisor Is Zero
   611            C                OR      A, reg_acc3     ;Divisor load into A register
   612            C                JBC     STATUS, Z
   613            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   614            C                CLR     reg_acc3        ;Divisor Is Not Zero, Begin Peration，Then A=1
   615            C        $_Div_Sub:
   616            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   617            C                RLC     reg_acc2
   618            C                RLC     reg_acc3
   619            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   620            C                JBS     STATUS, C
   621            C                JMP     $_Div_S_0
   622            C                SUB     reg_acc3, A
   623            C                JMP     $_Div_Cnt
   624            C        $_Div_S_0:
   625            C                SUB     reg_acc3, A
   626            C                JBC     STATUS, C
   627            C                JMP     $_Div_Cnt
   628            C                BC      reg_acc1, 0
   629            C                ADD     reg_acc3, A
   630            C        $_Div_Cnt:
   631            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   632            C                JMP     $_Div_Sub
   633            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   634            C        $_Div_Out:
   635            C                ENDM
   636            C        ;
   637            C        ;**********************************************************************;
   638            C        ; Title:        Division 16 bits /16 bits -> 16 bit --16 bits          ;
   639            C        ; Description:  (reg_acc2, reg_acc1)/(reg_acc4, reg_acc3)              ;
   640            C        ;               ->(reg_acc2, reg_acc1)--(reg_acc4, reg_acc3)           ;
   641            C        ; Input:        Dividend reg_acc2,reg_acc1 Divisor   reg_acc4,reg_acc3 ;
   642            C        ; Output:       Result   reg_acc2,reg_acc1 Remainder reg_acc4,reg_acc3 ;
   643            C        ; Variable Register:None                                               ;
   644            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   645            C        ;                   , reg_acc5(0x025), reg_acc6(0x26)                  ;
   646            C        ;**********************************************************************;
   647            C        ;
   648            C        mDIV2_2 MACRO reg_acc2, reg_acc1, reg_acc4, reg_acc3
   649            C        ;
   650            C                CLRA
   651            C                OR      A, reg_acc3     ;Check Divisor Is Zero
   652            C                OR      A, reg_acc4
   653            C                JBC     STATUS, Z
   654            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   655            C                MOV     A, @16          ;Recurrence Cortrol Data
   656            C                MOV     reg_acc, A
   657            C                CLR     reg_acc5        ;Divisor Is Not Zero, Begin Peration，Then A=1
   658            C                CLR     reg_acc6
   659            C        $_Div_Sub:
   660            C                BC      STATUS, C       ;Clear c Flag
   661            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   662            C                RLC     reg_acc2
   663            C                RLC     reg_acc5
   664            C                RLC     reg_acc6
   665            C                MOV     A, reg_acc4     ;Check If Dividend > Divisor
   666            C                SUB     A, reg_acc6     ;Check High Word  Equal
   667            C                JBS     STATUS, Z
   668            C                JMP     $_Div_Set
   669            C                MOV     A, reg_acc3     ;High Word Equal Then Check  Low Word
   670            C                SUB     A, reg_acc5
   671            C        $_Div_Set:
   672            C                JBS     STATUS, C
   673            C                JMP     $_Div_S_0       ;Dividend < Divisor, Quotient Add 0.
   674            C                BS      reg_acc1, 0     ;Dividend > Divisor, Quotient Add 1.
   675            C                MOV     A, reg_acc3     ;Dividend-Divisor, From Low Word To High Word.
   676            C                SUB     reg_acc5, A     ;Save Diviso
   677            C                JBS     STATUS, C
   678            C                DEC     reg_acc6        ;If Low Word < High Word, Next High Word Sub 1.
   679            C                MOV     A, reg_acc4
   680            C                SUB     reg_acc6, A
   681            C        $_Div_S_0:
   682            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   683            C                JMP     $_Div_Sub
   684            C                MOV     A, reg_acc6     ;Save Result Into User's Register.
   685            C                MOV     reg_acc4, A
   686            C                MOV     A, reg_acc5
   687            C                MOV     reg_acc3, A
   688            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   689            C        $_Div_Out:
   690            C                ENDM
   691            C        ;
   692            C        ;**********************************************************************;
   693            C        ; Title:        Division 24 bits /8 bits -> 24 bit --8 bits            ;
   694            C        ; Description:  (reg_acc3, reg_acc2, reg_acc1)/reg_acc4                ;
   695            C        ;               ->(reg_acc3, reg_acc2, reg_acc1) --reg_acc4            ;
   696            C        ; Input:        Dividend reg_acc3,reg_acc2,reg_acc1 Divisor   reg_acc4 ;
   697            C        ; Output:       Result   reg_acc3,reg_acc2,reg_acc1 Remainder reg_acc4 ;
   698            C        ; Variable Register:None                                               ;
   699            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   700            C        ;**********************************************************************;
   701            C        ;
   702            C        mDIV3_1 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc4
   703            C        ;
   704            C                MOV     A, @24          ;Recurrence Cortrol Data
   705            C                MOV     reg_acc, A
   706            C                CLRA                    ;Check Divisor Is Zero
   707            C                OR      A, reg_acc4     ;Divisor load into A register
   708            C                JBC     STATUS, Z
   709            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   710            C                CLR     reg_acc4        ;Divisor Is Not Zero, Begin Peration，Then A=1
   711            C        $_Div_Sub:
   712            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   713            C                RLC     reg_acc2
   714            C                RLC     reg_acc3
   715            C                RLC     reg_acc4
   716            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   717            C                JBS     STATUS, C
   718            C                JMP     $_Div_S_0       ;C Flag Is 0, Check Dividend > Divisor
   719            C                SUB     reg_acc4, A     ;C Flag Is 1, Quotient Low Bit Set 1
   720            C                JMP     $_Div_Cnt
   721            C        $_Div_S_0:
   722            C                SUB     reg_acc4, A
   723            C                JBC     STATUS, C
   724            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   725            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   726            C                ADD     reg_acc4, A     ;Revert Dividend
   727            C        $_Div_Cnt:
   728            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   729            C                JMP     $_Div_Sub
   730            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   731            C        $_Div_Out:
   732            C                ENDM
   733            C        ;
   734            C        ;**********************************************************************;
   735            C        ; Title:        Division 24 bits /16 bits -> 24 bit --16 bits          ;
   736            C        ; Description:  (reg_acc3, reg_acc2, reg_acc1)/(reg_acc5, reg_acc4)    ;
   737            C        ;               ->(reg_acc3, reg_acc2, reg_acc1) --(reg_acc5, reg_acc4);
   738            C        ; Input:        Dividend  reg_acc3 reg_acc2 reg_acc1                   ;
   739            C        ;               Divisor   reg_acc5, reg_acc4                           ;
   740            C        ; Output:       Result    reg_acc3 reg_acc2 reg_acc1                   ;
   741            C        ;               Remainder reg_acc5, reg_acc4                           ;
   742            C        ; Variable Register: None                                              ;
   743            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc6(0x26) ;
   744            C        ;                   , reg_acc7(0x27)                                   ;
   745            C        ;**********************************************************************;
   746            C        ;
   747            C        mDIV3_2 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc5, reg_acc4
   748            C        ;
   749            C                CLRA
   750            C                OR      A, reg_acc4     ;Check Divisor Is Zero
   751            C                OR      A, reg_acc5
   752            C                JBC     STATUS, Z
   753            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   754            C                MOV     A, @24          ;Recurrence Cortrol Data
   755            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   756            C                CLR     reg_acc6        ;clear Remainder register
   757            C                CLR     reg_acc7
   758            C        $_Div_Sub:
   759            C                BC      STATUS, C       ;Clear c Flag
   760            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   761            C                RLC     reg_acc2
   762            C                RLC     reg_acc3
   763            C                RLC     reg_acc6
   764            C                RLC     reg_acc7
   765            C                JBC     STATUS, C
   766            C                JMP     $_Div_Set_1     ;C Flag Is 1, Quotient Low Bit Set 1
   767            C                MOV     A, reg_acc5     ;Check If Dividend > Divisor
   768            C                SUB     A, reg_acc7     ;Check High Word  Equal
   769            C                JBS     STATUS, Z
   770            C                JMP     $_Div_Set
   771            C                MOV     A, reg_acc4     ;High Word Equal Then Check  Low Word
   772            C                SUB     A, reg_acc6
   773            C        $_Div_Set:
   774            C                JBS     STATUS, C
   775            C                JMP     $_Div_S_0       ;Dividend < Divisor, Quotient Add 0.
   776            C        $_Div_Set_1:
   777            C                BS      reg_acc1, 0     ;Dividend > Divisor, Quotient Add 1.
   778            C                MOV     A, reg_acc4     ;Dividend-Divisor, From Low Word To High Word.
   779            C                SUB     reg_acc6, A     ;Save Diviso
   780            C                JBS     STATUS, C
   781            C                DEC     reg_acc7        ;If Low Word < High Word, Next High Word Sub 1.
   782            C                MOV     A, reg_acc5
   783            C                SUB     reg_acc7, A
   784            C        $_Div_S_0:
   785            C                DJZ     reg_acc         ;If Finish Shift, SetA=1 Exit
   786            C                JMP     $_Div_Sub
   787            C                MOV     A, reg_acc7     ;Save Result Into User's Register.
   788            C                MOV     reg_acc5, A
   789            C                MOV     A, reg_acc6
   790            C                MOV     reg_acc4, A
   791            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   792            C        $_Div_Out:
   793            C                ENDM
   794            C        ;
   795            C        ;**********************************************************************;
   796            C        ; Title:        Division 24 bits /24 bits -> 24 bit --24 bits          ;
   797            C        ; Description:  (reg_acc3,reg_acc2,reg_acc1)/                          ;
   798            C        ;               (reg_acc6,reg_acc5,reg_acc4)                           ;
   799            C        ;               ->(reg_acc3,reg_acc2,reg_acc1)                         ;
   800            C        ;               --(reg_acc6,reg_acc5,reg_acc4)                         ;
   801            C        ; Input:        Dividend  reg_acc3 reg_acc2 reg_acc1                   ;
   802            C        ;               Divisor   reg_acc6 reg_acc5, reg_acc4                  ;
   803            C        ; Output:       Result    reg_acc3 reg_acc2 reg_acc1                   ;
   804            C        ;               Remainder reg_acc6, reg_acc5, reg_acc4                 ;
   805            C        ; Variable Register:None                                               ;
   806            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc7(x027) ;
   807            C        ;                   , reg_acc8(0x28),  reg_acc9(0x29)                  ;
   808            C        ;**********************************************************************;
   809            C        ;
   810            C        mDIV3_3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5, reg_acc4
   811            C        ;
   812            C                CLRA
   813            C                OR      A, reg_acc4     ;Check Divisor Is Zero
   814            C                OR      A, reg_acc5
   815            C                OR      A, reg_acc6
   816            C                JBC     STATUS, Z
   817            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   818            C                MOV     A, @24          ;Recurrence Cortrol Data
   819            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   820            C                CLR     reg_acc7        ;clear Remainder register
   821            C                CLR     reg_acc8
   822            C                CLR     reg_acc9
   823            C        $_Div_Sub:
   824            C                BC      STATUS, C       ;Clear c Flag
   825            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   826            C                RLC     reg_acc2
   827            C                RLC     reg_acc3
   828            C                RLC     reg_acc7
   829            C                RLC     reg_acc8
   830            C                RLC     reg_acc9
   831            C                MOV     A, reg_acc6     ;Check If Dividend > Divisor
   832            C                SUB     A, reg_acc9     ;Check High Word  Equal
   833            C                JBS     STATUS, Z
   834            C                JMP     $_Div_Set
   835            C                MOV     A, reg_acc5     ;High Word Equal Then Check  Low Word
   836            C                SUB     A, reg_acc8
   837            C                JBS     STATUS, Z
   838            C                JMP     $_Div_Set
   839            C                MOV     A, reg_acc4
   840            C                SUB     A, reg_acc7
   841            C        $_Div_Set:
   842            C                JBS     STATUS, C
   843            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
   844            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
   845            C                MOV     A, reg_acc4     ;Dividend-Divisor, From Low Word To High Word.
   846            C                SUB     reg_acc7, A     ;Save Diviso
   847            C                JBS     STATUS, C
   848            C                DEC     reg_acc8        ;If Low Word < High Word, Next High Word Sub 1.
   849            C                MOV     A, reg_acc5
   850            C                SUB     reg_acc8, A
   851            C                JBS     STATUS, C
   852            C                DEC     reg_acc9
   853            C                MOV     A, reg_acc6
   854            C                SUB     reg_acc9, A
   855            C        $_Div_S_0:
   856            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   857            C                JMP     $_Div_Sub
   858            C                MOV     A, reg_acc9     ;Save Result Into User's Register.
   859            C                MOV     reg_acc6, A
   860            C                MOV     A, reg_acc8
   861            C                MOV     reg_acc5, A
   862            C                MOV     A, reg_acc7
   863            C                MOV     reg_acc4, A
   864            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   865            C        $_Div_Out:
   866            C                ENDM
   867            C        ;
   868            C        ;**********************************************************************;
   869            C        ; Title:        Division 32 bits /8 bits -> 32 bit --8 bits            ;
   870            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/reg_acc5      ;
   871            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1) --reg_acc5  ;
   872            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   873            C        ;               Divisor   reg_acc5                                     ;
   874            C        ; Output:       Result    reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   875            C        ;               Remainder reg_acc5                                     ;
   876            C        ; Variable Register:None                                               ;
   877            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   878            C        ;**********************************************************************;
   879            C        ;
   880            C        mDIV4_1 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc5
   881            C        ;
   882            C                MOV     A, @32          ;Recurrence Cortrol Data
   883            C                MOV     reg_acc, A
   884            C                CLRA                    ;Check Divisor Is Zero
   885            C                OR      A, reg_acc5     ;Divisor load into A register
   886            C                JBC     STATUS, Z
   887            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   888            C                CLR     reg_acc5        ;Divisor Is Not Zero, Begin Peration，Then A=1.
   889            C        $_Div_Sub:
   890            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   891            C                RLC     reg_acc2
   892            C                RLC     reg_acc3
   893            C                RLC     reg_acc4
   894            C                RLC     reg_acc5
   895            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Bit _Div_Set 1.
   896            C                JBS     STATUS, C
   897            C                JMP     $_Div_S_0       ;C Flag Is 0, Check Dividend > Divisor
   898            C                SUB     reg_acc5, A     ;C Flag Is 1, Quotient Low Bit Set 1
   899            C                JMP     $_Div_Cnt
   900            C        $_Div_S_0:
   901            C                SUB     reg_acc5, A
   902            C                JBC     STATUS, C
   903            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   904            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   905            C                ADD     reg_acc5, A     ;Revert Dividend
   906            C        $_Div_Cnt:
   907            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   908            C                JMP     $_Div_Sub
   909            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   910            C        $_Div_Out:
   911            C                ENDM
   912            C        ;
   913            C        ;**********************************************************************;
   914            C        ; Title:        Division 32 bits /16 bits -> 32 bit --16 bits          ;
   915            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
   916            C        ;               (reg_acc6, reg_acc5)                                   ;
   917            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
   918            C        ;               --(reg_acc6, reg_acc5)                                 ;
   919            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   920            C        ;               Divisor   reg_acc6 reg_acc5                            ;
   921            C        ; Output:       Result    reg_acc4, reg_acc3 reg_acc2 reg_acc1         ;
   922            C        ;               Remainder reg_acc6, reg_acc5                           ;
   923            C        ; Variable Register:None                                               ;
   924            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc7(x027) ;
   925            C        ;                   , reg_acc8(0x28)                                   ;
   926            C        ;**********************************************************************;
   927            C        ;
   928            C        mDIV4_2 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5
   929            C        ;
   930            C                CLRA
   931            C                OR      A, reg_acc6     ;Check Divisor Is Zero
   932            C                OR      A, reg_acc5
   933            C                JBC     STATUS, Z
   934            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   935            C                MOV     A, @32          ;Recurrence Cortrol Data
   936            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   937            C                CLR     reg_acc7        ;clear Remainder register
   938            C                CLR     reg_acc8
   939            C        $_Div_Sub:
   940            C                BC      STATUS, C       ;Clear c Flag
   941            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   942            C                RLC     reg_acc2
   943            C                RLC     reg_acc3
   944            C                RLC     reg_acc4
   945            C                RLC     reg_acc7
   946            C                RLC     reg_acc8
   947            C                JBC     STATUS, C
   948            C                JMP     $_Div_Set_1     ;C Flag Is 1, Quotient Low Bit Set 1
   949            C                MOV     A, reg_acc6     ;Check If Dividend > Divisor
   950            C                SUB     A, reg_acc8     ;Check High Word  Equal
   951            C                JBS     STATUS, Z
   952            C                JMP     $_Div_Set
   953            C                MOV     A, reg_acc5     ;if High Word Equal Then Check  Low Word
   954            C                SUB     A, reg_acc7
   955            C        $_Div_Set:
   956            C                JBS     STATUS, C
   957            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
   958            C        $_Div_Set_1:
   959            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
   960            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
   961            C                SUB     reg_acc7, A     ;Save Divisor
   962            C                JBS     STATUS, C
   963            C                DEC     reg_acc8        ;If Low Word < High Word, Next High Word Sub 1.
   964            C                MOV     A, reg_acc6
   965            C                SUB     reg_acc8, A
   966            C        $_Div_S_0:
   967            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   968            C                JMP     $_Div_Sub
   969            C                MOV     A, reg_acc8     ;Save Result Into User's Register.
   970            C                MOV     reg_acc6, A
   971            C                MOV     A, reg_acc7
   972            C                MOV     reg_acc5, A
   973            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   974            C        $_Div_Out:
   975            C                ENDM
   976            C        ;
   977            C        ;**********************************************************************;
   978            C        ; Title:        Division 32 bits /24 bits -> 32 bit --24 bits          ;
   979            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
   980            C        ;               (reg_acc7, reg_acc6, reg_acc5)                         ;
   981            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
   982            C        ;               --(reg_acc7, reg_acc6, reg_acc5)                       ;
   983            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   984            C        ;               Divisor   reg_acc7 reg_acc6 reg_acc5                   ;
   985            C        ; Output:       Result    reg_acc4, reg_acc3 reg_acc2 reg_acc1         ;
   986            C        ;               Remainder reg_acc7 reg_acc6, reg_acc5                  ;
   987            C        ; Variable Register:None                                               ;
   988            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc8(x028) ;
   989            C        ;                   , reg_acc9(0x29) , reg_acca(0x2a)                  ;
   990            C        ;**********************************************************************;
   991            C        ;
   992            C        mDIV4_3 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc7, reg_acc6, reg_acc5
   993            C        ;
   994            C                CLRA
   995            C                OR      A, reg_acc7     ;Check Divisor Is Zero
   996            C                OR      A, reg_acc6
   997            C                OR      A, reg_acc5
   998            C                JBC     STATUS, Z
   999            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
  1000            C                MOV     A, @32          ;Recurrence Cortrol Data
  1001            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
  1002            C                CLR     reg_acc8        ;clear Remainder register
  1003            C                CLR     reg_acc9
  1004            C                CLR     reg_acca
  1005            C        $_Div_Sub:
  1006            C                BC      STATUS, 0       ;Clear c Flag
  1007            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
  1008            C                RLC     reg_acc2
  1009            C                RLC     reg_acc3
  1010            C                RLC     reg_acc4
  1011            C                RLC     reg_acc8
  1012            C                RLC     reg_acc9
  1013            C                RLC     reg_acca
  1014            C                JBC     STATUS, C       ;C Flag Is 1, Quotient Low Bit Set 1
  1015            C                JMP     $_Div_Set_1
  1016            C                MOV     A, reg_acc7     ;Check If Dividend > Divisor
  1017            C                SUB     A, reg_acca     ;Check High Word  Equal
  1018            C                JBS     STATUS, Z
  1019            C                JMP     $_Div_Set
  1020            C                MOV     A, reg_acc6     ;if High Word Equal Then Check  Low Word
  1021            C                SUB     A, reg_acc9
  1022            C                JBS     STATUS, Z
  1023            C                JMP     $_Div_Set
  1024            C                MOV     A, reg_acc5
  1025            C                SUB     A, reg_acc8
  1026            C        $_Div_Set:
  1027            C                JBS     STATUS, C
  1028            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
  1029            C        $_Div_Set_1:
  1030            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
  1031            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
  1032            C                SUB     reg_acc8, A     ;Save Divisor
  1033            C                JBS     STATUS, C
  1034            C                DEC     reg_acc9        ;If Low Word < High Word, Next High Word Sub 1.
  1035            C                MOV     A, reg_acc6
  1036            C                SUB     reg_acc9, A
  1037            C                JBS     STATUS, C
  1038            C                DEC     reg_acca
  1039            C                MOV     A, reg_acc7
  1040            C                SUB     reg_acca, A
  1041            C        $_Div_S_0:
  1042            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
  1043            C                JMP     $_Div_Sub
  1044            C                MOV     A, reg_acca     ;Save Result Into User's Register.
  1045            C                MOV     reg_acc7, A
  1046            C                MOV     A, reg_acc9
  1047            C                MOV     reg_acc6, A
  1048            C                MOV     A, reg_acc8
  1049            C                MOV     reg_acc5, A
  1050            C                MOV     A, @1           ;Finish Peration, A Register Return 1
  1051            C        $_Div_Out:
  1052            C                ENDM
  1053            C        ;
  1054            C        ;**********************************************************************;
  1055            C        ; Title:        Division 32 bits /32 bits -> 32 bit --32 bits          ;
  1056            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
  1057            C        ;               (reg_acc8, reg_acc7, reg_acc6, reg_acc5)               ;
  1058            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
  1059            C        ;               --(reg_acc8, reg_acc7, reg_acc6, reg_acc5)             ;
  1060            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
  1061            C        ;               Divisor   reg_acc8 reg_acc7 reg_acc6 reg_acc5          ;
  1062            C        ; Output:       Result    reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
  1063            C        ;               Remainder reg_acc8 reg_acc7 reg_acc6, reg_acc5         ;
  1064            C        ; Variable Register:None                                               ;
  1065            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc9(x029) ;
  1066            C        ;                   , reg_acca(0x2a) , reg_accb(0x2b) , reg_accc(0x2c) ;
  1067            C        ;**********************************************************************;
  1068            C        ;
  1069            C        mDIV4_4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc8, reg_acc7, reg_acc6, reg_acc5
  1070            C        ;
  1071            C                CLRA
  1072            C                OR      A, reg_acc8     ;Check Divisor Is Zero
  1073            C                OR      A, reg_acc7
  1074            C                OR      A, reg_acc6
  1075            C                OR      A, reg_acc5
  1076            C                JBC     STATUS, Z
  1077            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
  1078            C                MOV     A, @32          ;Recurrence Cortrol Data
  1079            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
  1080            C                CLR     reg_acc9        ;clear Remainder register
  1081            C                CLR     reg_acca
  1082            C                CLR     reg_accb
  1083            C                CLR     reg_accc
  1084            C        $_Div_Sub:
  1085            C                BC      STATUS, C       ;Clear c Flag
  1086            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
  1087            C                RLC     reg_acc2
  1088            C                RLC     reg_acc3
  1089            C                RLC     reg_acc4
  1090            C                RLC     reg_acc9
  1091            C                RLC     reg_acca
  1092            C                RLC     reg_accb
  1093            C                RLC     reg_accc
  1094            C                MOV     A, reg_acc8     ;Check If Dividend > Divisor
  1095            C                SUB     A, reg_accc     ;Check High Word  Equal
  1096            C                JBS     STATUS, Z
  1097            C                JMP     $_Div_Set
  1098            C                MOV     A, reg_acc7     ;if High Word Equal Then Check  Low Word
  1099            C                SUB     A, reg_accb
  1100            C                JBS     STATUS, Z
  1101            C                JMP     $_Div_Set
  1102            C                MOV     A, reg_acc6
  1103            C                SUB     A, reg_acca
  1104            C                JBS     STATUS, Z
  1105            C                JMP     $_Div_Set
  1106            C                MOV     A, reg_acc5
  1107            C                SUB     A, reg_acc9
  1108            C        $_Div_Set:
  1109            C                JBS     STATUS, C
  1110            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
  1111            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
  1112            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
  1113            C                SUB     reg_acc9, A     ;Save Divisor
  1114            C                JBS     STATUS, C
  1115            C                DEC     reg_acca        ;If Low Word < High Word, Next High Word Sub 1.
  1116            C                MOV     A, reg_acc6
  1117            C                SUB     reg_acca, A
  1118            C                JBS     STATUS, C
  1119            C                DEC     reg_accb
  1120            C                MOV     A, reg_acc7
  1121            C                SUB     reg_accb, A
  1122            C                JBS     STATUS, C
  1123            C                DEC     reg_accc
  1124            C                MOV     A, reg_acc8
  1125            C                SUB     reg_accc, A
  1126            C        $_Div_S_0:
  1127            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
  1128            C                JMP     $_Div_Sub
  1129            C                MOV     A, reg_accc     ;Save Result Into User's Register.
  1130            C                MOV     reg_acc8, A
  1131            C                MOV     A, reg_accb
  1132            C                MOV     reg_acc7, A
  1133            C                MOV     A, reg_acca
  1134            C                MOV     reg_acc6, A
  1135            C                MOV     A, reg_acc9
  1136            C                MOV     reg_acc5, A
  1137            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
  1138            C        $_Div_Out:
  1139            C                ENDM
  1140            C        ;
  1141            C        ;**********************************************************************;
  1142            C        ; Title:          (1 byte) * (1 byte) operation                        ;
  1143            C        ; Description:    reg_acc2 * reg_acc1 = (reg_acc2, reg_acc1)           ;
  1144            C        ; Input:          reg_acc1, reg_acc2                                   ;
  1145            C        ; Output:         reg_acc1, reg_acc2                                   ;
  1146            C        ; Register change:reg_acc                                              ;
  1147            C        ;**********************************************************************;
  1148            C        ;
  1149            C        mMUL1_1 MACRO   reg_acc2, reg_acc1
  1150            C        ;
  1151            C                MOV     A, @8
  1152            C                MOV     reg_acc, A
  1153            C                MOV     A, reg_acc2
  1154            C                CLR     reg_acc2
  1155            C        $Mul11_Loop:
  1156            C                BC      STATUS, C
  1157            C                JBC     reg_acc1, 0
  1158            C                ADD     reg_acc2, A
  1159            C                RRC     reg_acc2
  1160            C                RRC     reg_acc1
  1161            C        ;
  1162            C                DJZ     reg_acc
  1163            C                JMP     $Mul11_Loop
  1164            C                ENDM
  1165            C        ;
  1166            C        ;**********************************************************************;
  1167            C        ; Title:          (1 byte) * (2 bytes) operation                       ;
  1168            C        ; Description:    reg_acc3 * (reg_acc2, reg_acc1)                      ;
  1169            C        ;                 = (reg_acc3, reg_acc2, reg_acc1)                     ;
  1170            C        ; Input:          reg_acc1, reg_acc2, reg_acc3                         ;
  1171            C        ; Output:         reg_acc1, reg_acc2, reg_acc3                         ;
  1172            C        ; Register change:reg_acc                                              ;
  1173            C        ;**********************************************************************;
  1174            C        ;
  1175            C        mMUL1_2 MACRO   reg_acc3, reg_acc2, reg_acc1
  1176            C        ;
  1177            C                MOV     A, @16
  1178            C                MOV     reg_acc, A
  1179            C                MOV     A, reg_acc3
  1180            C                CLR     reg_acc3
  1181            C        $Mul12_Loop:
  1182            C                BC      STATUS, C
  1183            C                JBC     reg_acc1, 0
  1184            C                ADD     reg_acc3, A
  1185            C                RRC     reg_acc3
  1186            C                RRC     reg_acc2
  1187            C                RRC     reg_acc1
  1188            C        ;
  1189            C                DJZ     reg_acc
  1190            C                JMP     $Mul12_Loop
  1191            C                ENDM
  1192            C        ;
  1193            C        ;**********************************************************************;
  1194            C        ; Title:          (1 byte) * (3 bytes) operation                       ;
  1195            C        ; Description:    reg_acc4 * (reg_acc3, reg_acc2, reg_acc1)            ;
  1196            C        ;                 = (reg_acc4, reg_acc3, reg_acc2, reg_acc1)           ;
  1197            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1198            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1199            C        ; Register change:reg_acc                                              ;
  1200            C        ;**********************************************************************;
  1201            C        ;
  1202            C        mMUL1_3 MACRO   reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1203            C        ;
  1204            C                MOV     A, @24
  1205            C                MOV     reg_acc, A
  1206            C                MOV     A, reg_acc4
  1207            C                CLR     reg_acc4
  1208            C        $Mul13_Loop:
  1209            C                BC      STATUS, C
  1210            C                JBC     reg_acc1, 0
  1211            C                ADD     reg_acc4, A
  1212            C                RRC     reg_acc4
  1213            C                RRC     reg_acc3
  1214            C                RRC     reg_acc2
  1215            C                RRC     reg_acc1
  1216            C        ;
  1217            C                DJZ     reg_acc
  1218            C                JMP     $Mul13_Loop
  1219            C                ENDM
  1220            C        ;
  1221            C        ;**********************************************************************;
  1222            C        ; Title:          (1 byte) * (4 bytes) operation                       ;
  1223            C        ; Description:    reg_acc5 * (reg_acc4, reg_acc3, reg_acc2, reg_acc1)  ;
  1224            C        ;                 = (reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1) ;
  1225            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1226            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1227            C        ; Register change:reg_acc                                              ;
  1228            C        ;**********************************************************************;
  1229            C        ;
  1230            C        mMUL1_4  MACRO   reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1231            C        ;
  1232            C                MOV     A, @32
  1233            C                MOV     reg_acc, A
  1234            C                MOV     A, reg_acc5
  1235            C                CLR     reg_acc5
  1236            C        $Mul14_Loop:
  1237            C                BC      STATUS, C
  1238            C                JBC     reg_acc1, 0
  1239            C                ADD     reg_acc5, A
  1240            C                RRC     reg_acc5
  1241            C                RRC     reg_acc4
  1242            C                RRC     reg_acc3
  1243            C                RRC     reg_acc2
  1244            C                RRC     reg_acc1
  1245            C        ;
  1246            C                DJZ     reg_acc
  1247            C                JMP     $Mul14_Loop
  1248            C                ENDM
  1249            C        ;
  1250            C        ;**********************************************************************;
  1251            C        ; Title:          (2 bytes) * (2 bytes) operation                      ;
  1252            C        ; Description:    (reg_acc4, reg_acc3) * (reg_acc2, reg_acc1)          ;
  1253            C        ;                 = (reg_acc4, reg_acc3, reg_acc2, reg_acc1)           ;
  1254            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1255            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1256            C        ; Register change:reg_acc, reg_acc5, reg_acc6                          ;
  1257            C        ;**********************************************************************;
  1258            C        ;
  1259            C        mMUL2_2 MACRO   reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1260            C        ;
  1261            C                MOV     A, @16
  1262            C                MOV     reg_acc, A
  1263            C                MOV     A, reg_acc4
  1264            C                MOV     reg_acc6, A
  1265            C                MOV     A, reg_acc3
  1266            C                MOV     reg_acc5, A
  1267            C                CLR     reg_acc3
  1268            C                CLR     reg_acc4
  1269            C        $Mul22_Loop:
  1270            C                BC      STATUS, C
  1271            C                JBS     reg_acc1, 0
  1272            C                JMP     $Mul22_Rs
  1273            C                MOV     A, reg_acc5
  1274            C                ADD     reg_acc3, A
  1275            C        ;--------------------------------------
  1276            C                MOV     A, reg_acc4
  1277            C                JBC     STATUS, C
  1278            C                ADD     A, @1
  1279            C                RLC     reg_acc
  1280            C                ADD     A, reg_acc6
  1281            C                MOV     reg_acc4, A
  1282            C                JBC     STATUS, C
  1283            C                BS      reg_acc, 0
  1284            C                RRC     reg_acc
  1285            C        $Mul22_Rs:
  1286            C                RRC     reg_acc4
  1287            C                RRC     reg_acc3
  1288            C                RRC     reg_acc2
  1289            C                RRC     reg_acc1
  1290            C        ;
  1291            C                BC      reg_acc, 7
  1292            C                DJZ     reg_acc
  1293            C                JMP     $Mul22_Loop
  1294            C                ENDM
  1295            C        ;
  1296            C        ;**********************************************************************;
  1297            C        ; Title:          (2 bytes) * (3 bytes) operation                      ;
  1298            C        ; Description:    (reg_acc5, reg_acc4) * (reg_acc3, reg_acc2, reg_acc1);
  1299            C        ;                 = (reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1) ;
  1300            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1301            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1302            C        ; Register change:reg_acc, reg_acc6, reg_acc7                          ;
  1303            C        ;**********************************************************************;
  1304            C        ;
  1305            C        mMUL2_3 MACRO   reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1306            C        ;
  1307            C                MOV     A, @24
  1308            C                MOV     reg_acc, A
  1309            C                MOV     A, reg_acc5
  1310            C                MOV     reg_acc7, A
  1311            C                MOV     A, reg_acc4
  1312            C                MOV     reg_acc6, A
  1313            C                CLR     reg_acc4
  1314            C                CLR     reg_acc5
  1315            C        $Mul23_Loop:
  1316            C                BC      STATUS, C
  1317            C                JBS     reg_acc1, 0
  1318            C                JMP     $Mul23_Rs
  1319            C                MOV     A, reg_acc6
  1320            C                ADD     reg_acc4, A
  1321            C        ;--------------------------------------
  1322            C                MOV     A, reg_acc5
  1323            C                JBC     STATUS, C
  1324            C                ADD     A, @1
  1325            C                RLC     reg_acc
  1326            C                ADD     A, reg_acc7
  1327            C                MOV     reg_acc5, A
  1328            C                JBC     STATUS, C
  1329            C                BS      reg_acc, 0
  1330            C                RRC     reg_acc
  1331            C        $Mul23_Rs:
  1332            C                RRC     reg_acc5
  1333            C                RRC     reg_acc4
  1334            C                RRC     reg_acc3
  1335            C                RRC     reg_acc2
  1336            C                RRC     reg_acc1
  1337            C        ;
  1338            C                BC      reg_acc, 7
  1339            C                DJZ     reg_acc
  1340            C                JMP     $Mul23_Loop
  1341            C                ENDM
  1342            C        ;
  1343            C        ;**********************************************************************;
  1344            C        ; Title:          (2 bytes) * (4 bytes) operation                      ;
  1345            C        ; Description:    (reg_acc6, reg_acc5) * (reg_acc4, reg_acc3, reg_acc2 ;
  1346            C        ;                 , reg_acc1) = (reg_acc6, reg_acc5, reg_acc4, reg_acc3;
  1347            C        ;                 , reg_acc2, reg_acc1)                                ;
  1348            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,    ;
  1349            C        ;                 reg_acc6                                             ;
  1350            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,    ;
  1351            C        ;                 reg_acc6                                             ;
  1352            C        ; Register change:reg_acc, reg_acc7, reg_acc8                          ;
  1353            C        ;**********************************************************************;
  1354            C        ;
  1355            C        mMUL2_4 MACRO   reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1356            C        ;
  1357            C                MOV     A, @32
  1358            C                MOV     reg_acc, A
  1359            C                MOV     A, reg_acc6
  1360            C                MOV     reg_acc8, A
  1361            C                MOV     A, reg_acc5
  1362            C                MOV     reg_acc7, A
  1363            C                CLR     reg_acc5
  1364            C                CLR     reg_acc6
  1365            C        $Mul24_Loop:
  1366            C                BC      STATUS, C
  1367            C                JBS     reg_acc1, 0
  1368            C                JMP     $Mul24_Rs
  1369            C                MOV     A, reg_acc7
  1370            C                ADD     reg_acc5, A
  1371            C        ;--------------------------------------
  1372            C                MOV     A, reg_acc6
  1373            C                JBC     STATUS, C
  1374            C                ADD     A, @1
  1375            C                RLC     reg_acc
  1376            C                ADD     A, reg_acc8
  1377            C                MOV     reg_acc6, A
  1378            C                JBC     STATUS, C
  1379            C                BS      reg_acc, 0
  1380            C                RRC     reg_acc
  1381            C        $Mul24_Rs:
  1382            C                RRC     reg_acc6
  1383            C                RRC     reg_acc5
  1384            C                RRC     reg_acc4
  1385            C                RRC     reg_acc3
  1386            C                RRC     reg_acc2
  1387            C                RRC     reg_acc1
  1388            C        ;
  1389            C                BC      reg_acc, 7
  1390            C                DJZ     reg_acc
  1391            C                JMP     $Mul24_Loop
  1392            C                ENDM
  1393            C        ;
  1394            C        ;**********************************************************************;
  1395            C        ; Title:          (3 bytes) * (3 bytes) operation                      ;
  1396            C        ; Description:    (reg_acc6, reg_acc5, reg_acc4) * (reg_acc3, reg_acc2 ;
  1397            C        ;                 , reg_acc1) = (reg_acc6, reg_acc5, reg_acc4, reg_acc3;
  1398            C        ;                 , reg_acc2, reg_acc1)                                ;
  1399            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1400            C        ;                 , reg_acc6                                           ;
  1401            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1402            C        ;                 , reg_acc6                                           ;
  1403            C        ; Register change:reg_acc, reg_acc7, reg_acc8, reg_acc9                ;
  1404            C        ;**********************************************************************;
  1405            C        ;
  1406            C        mMUL3_3 MACRO   reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1407            C        ;
  1408            C                MOV     A, @24
  1409            C                MOV     reg_acc, A
  1410            C                MOV     A, reg_acc4
  1411            C                MOV     reg_acc7, A
  1412            C                MOV     A, reg_acc5
  1413            C                MOV     reg_acc8, A
  1414            C                MOV     A, reg_acc6
  1415            C                MOV     reg_acc9, A
  1416            C                CLR     reg_acc4
  1417            C                CLR     reg_acc5
  1418            C                CLR     reg_acc6
  1419            C        $Mul33_Loop:
  1420            C                BC      STATUS, C
  1421            C                JBS     reg_acc1, 0
  1422            C                JMP     $Mul33_Rs
  1423            C                MOV     A, reg_acc7
  1424            C                ADD     reg_acc4, A
  1425            C        ;--------------------------------------
  1426            C                MOV     A, reg_acc5
  1427            C                JBC     STATUS, C
  1428            C                ADD     A, @1
  1429            C                RLC     reg_acc
  1430            C                ADD     A, reg_acc8
  1431            C                MOV     reg_acc5, A
  1432            C                JBC     STATUS, C
  1433            C                BS      reg_acc, 0
  1434            C                RRC     reg_acc
  1435            C        ;--------------------------------------
  1436            C                MOV     A, reg_acc6
  1437            C                JBC     STATUS, C
  1438            C                ADD     A, @1
  1439            C                RLC     reg_acc
  1440            C                ADD     A, reg_acc9
  1441            C                MOV     reg_acc6, A
  1442            C                JBC     STATUS, C
  1443            C                BS      reg_acc, 0
  1444            C                RRC     reg_acc
  1445            C        $Mul33_Rs:
  1446            C                RRC     reg_acc6
  1447            C                RRC     reg_acc5
  1448            C                RRC     reg_acc4
  1449            C                RRC     reg_acc3
  1450            C                RRC     reg_acc2
  1451            C                RRC     reg_acc1
  1452            C        ;
  1453            C                BC      reg_acc, 7
  1454            C                DJZ     reg_acc
  1455            C                JMP     $Mul33_Loop
  1456            C                ENDM
  1457            C        ;
  1458            C        ;**********************************************************************;
  1459            C        ; Title:          (3 bytes) * (4 bytes) operation                      ;
  1460            C        ; Description:    (reg_acc7, reg_acc6, reg_acc5) * (reg_acc4, reg_acc3 ;
  1461            C        ;                 , reg_acc2, reg_acc1) = (reg_acc7, reg_acc6, reg_acc5;
  1462            C        ;                 , reg_acc4, reg_acc3, reg_acc2, reg_acc1)            ;
  1463            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1464            C        ;                 , reg_acc6, reg_acc7                                 ;
  1465            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1466            C        ;                 , reg_acc6, reg_acc7                                 ;
  1467            C        ; Register change:reg_acc, reg_acc8, reg_acc9, reg_acca                ;
  1468            C        ;**********************************************************************;
  1469            C        ;
  1470            C        mMUL3_4 MACRO   reg_acc7, reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1471            C        ;
  1472            C                MOV     A, @32
  1473            C                MOV     reg_acc, A
  1474            C                MOV     A, reg_acc5
  1475            C                MOV     reg_acc8, A
  1476            C                MOV     A, reg_acc6
  1477            C                MOV     reg_acc9, A
  1478            C                MOV     A, reg_acc7
  1479            C                MOV     reg_acca, A
  1480            C                CLR     reg_acc5
  1481            C                CLR     reg_acc6
  1482            C                CLR     reg_acc7
  1483            C        $Mul34_Loop:
  1484            C                BC      STATUS, C
  1485            C                JBS     reg_acc1, 0
  1486            C                JMP     $Mul34_Rs
  1487            C                MOV     A, reg_acc8
  1488            C                ADD     reg_acc5, A
  1489            C        ;--------------------------------------
  1490            C                MOV     A, reg_acc6
  1491            C                JBC     STATUS, C
  1492            C                ADD     A, @1
  1493            C                RLC     reg_acc
  1494            C                ADD     A, reg_acc9
  1495            C                MOV     reg_acc6, A
  1496            C                JBC     STATUS, C
  1497            C                BS      reg_acc, 0
  1498            C                RRC     reg_acc
  1499            C        ;--------------------------------------
  1500            C                MOV     A, reg_acc7
  1501            C                JBC     STATUS, C
  1502            C                ADD     A, @1
  1503            C                RLC     reg_acc
  1504            C                ADD     A, reg_acca
  1505            C                MOV     reg_acc7, A
  1506            C                JBC     STATUS, C
  1507            C                BS      reg_acc, 0
  1508            C                RRC     reg_acc
  1509            C        $Mul34_Rs:
  1510            C                RRC     reg_acc7
  1511            C                RRC     reg_acc6
  1512            C                RRC     reg_acc5
  1513            C                RRC     reg_acc4
  1514            C                RRC     reg_acc3
  1515            C                RRC     reg_acc2
  1516            C                RRC     reg_acc1
  1517            C        ;
  1518            C                BC      reg_acc, 7
  1519            C                DJZ     reg_acc
  1520            C                JMP     $Mul34_Loop
  1521            C                ENDM
  1522            C        ;
  1523            C        ;**********************************************************************;
  1524            C        ; Title:          (4 bytes) * (4 bytes) operation                      ;
  1525            C        ; Description:    (reg_acc8, reg_acc7, reg_acc6, reg_acc5) *           ;
  1526            C        ;                 (reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
  1527            C        ;                 = (reg_acc8, reg_acc7, reg_acc6, reg_acc5, reg_acc4  ;
  1528            C        ;                 , reg_acc3, reg_acc2, reg_acc1)                      ;
  1529            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4,              ;
  1530            C        ;                 reg_acc5, reg_acc6, reg_acc7, reg_acc8               ;
  1531            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4,              ;
  1532            C        ;                 reg_acc5, reg_acc6, reg_acc7, reg_acc8               ;
  1533            C        ; Register change:reg_acc, reg_acc9, reg_acca, reg_accb, reg_accc      ;
  1534            C        ;**********************************************************************;
  1535            C        ;
  1536            C        mMUL4_4 MACRO   reg_acc8, reg_acc7, reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1537            C        ;
  1538            C                MOV     A, @32
  1539            C                MOV     reg_acc, A
  1540            C                MOV     A, reg_acc5
  1541            C                MOV     reg_acc9, A
  1542            C                MOV     A, reg_acc6
  1543            C                MOV     reg_acca, A
  1544            C                MOV     A, reg_acc7
  1545            C                MOV     reg_accb, A
  1546            C                MOV     A, reg_acc8
  1547            C                MOV     reg_accc, A
  1548            C                CLR     reg_acc5
  1549            C                CLR     reg_acc6
  1550            C                CLR     reg_acc7
  1551            C                CLR     reg_acc8
  1552            C        $Mul44_Loop:
  1553            C                BC      STATUS, C
  1554            C                JBS     reg_acc1, 0
  1555            C                JMP     $Mul44_Rs
  1556            C                MOV     A, reg_acc9
  1557            C                ADD     reg_acc5, A
  1558            C        ;--------------------------------------
  1559            C                MOV     A, reg_acc6
  1560            C                JBC     STATUS, C
  1561            C                ADD     A, @1
  1562            C                RLC     reg_acc
  1563            C                ADD     A, reg_acca
  1564            C                MOV     reg_acc6, A
  1565            C                JBC     STATUS, C
  1566            C                BS      reg_acc, 0
  1567            C                RRC     reg_acc
  1568            C        ;--------------------------------------
  1569            C                MOV     A, reg_acc7
  1570            C                JBC     STATUS, C
  1571            C                ADD     A, @1
  1572            C                RLC     reg_acc
  1573            C                ADD     A, reg_accb
  1574            C                MOV     reg_acc7, A
  1575            C                JBC     STATUS, C
  1576            C                BS      reg_acc, 0
  1577            C                RRC     reg_acc
  1578            C        ;--------------------------------------
  1579            C                MOV     A, reg_acc8
  1580            C                JBC     STATUS, C
  1581            C                ADD     A, @1
  1582            C                RLC     reg_acc
  1583            C                ADD     A, reg_accc
  1584            C                MOV     reg_acc8, A
  1585            C                JBC     STATUS, C
  1586            C                BS      reg_acc, 0
  1587            C                RRC     reg_acc
  1588            C        $Mul44_Rs:
  1589            C                RRC     reg_acc8
  1590            C                RRC     reg_acc7
  1591            C                RRC     reg_acc6
  1592            C                RRC     reg_acc5
  1593            C                RRC     reg_acc4
  1594            C                RRC     reg_acc3
  1595            C                RRC     reg_acc2
  1596            C                RRC     reg_acc1
  1597            C        ;
  1598            C                BC      reg_acc, 7
  1599            C                DJZ     reg_acc
  1600            C                JMP     $Mul44_Loop
  1601            C                ENDM
  1602            C        
  1603            C        
  1604            C        
  1605            C        ;*****************************************************************
  1606            C        ;Function:    generat random data
  1607            C        ;Input:       @banksel,@address,@length
  1608            C        ;Output:      rang by address which is the lowest address
  1609            C        ;description: used common register temp,temp1,temp2 for operation
  1610            C        ;             rand address must be in the same bank
  1611            C        ;             TEMP:  Operate Data TEMP
  1612            C        ;             TEMP1:
  1613            C        ;             TEMP2:
  1614            C        ;*****************************************************************
  1615            C        RAND_FUCTION MACRO @BankSel,Address,@length
  1616            C        	MOV         TEMP,A
  1617            C        	BANK        @BankSel
  1618            C        	MOV         A,Address
  1619            C        	ADD         TEMP,A        ; save latest data as current seed
  1620            C        
  1621            C        	CLR         RSR
  1622            C          $_RAND_SEED_LOOP1:
  1623            C        	MOV         A,R0
  1624            C        	ADD         TEMP,A        ; seed
  1625            C        
  1626            C        	RLC         TEMP          ; x*y+1 MOD z
  1627            C        	RLC         TEMP
  1628            C        	RLC         TEMP
  1629            C        	INC         TEMP
  1630            C        	RRC         TEMP
  1631            C        	RRC         TEMP
  1632            C        	RRC         TEMP
  1633            C        	JBS         STATUS,C
  1634            C        	BC          TEMP,0
  1635            C        	JBC         STATUS,C
  1636            C        	BS          TEMP,0
  1637            C        
  1638            C        	INC         RSR
  1639            C        	MOV         A,RSR
  1640            C        	AND         A,@0X40         ; adding form 0x00 to bank 0
  1641            C        	XOR         A,@0X40
  1642            C        	JBS         STATUS,Z
  1643            C        	JMP         $_RAND_SEED_LOOP1
  1644            C        	MOV         A,R0
  1645            C        	ADD         TEMP,A          ;next seed
  1646            C        
  1647            C        	MOV         A,@length
  1648            C        	MOV         TEMP1,A
  1649            C        	MOV         A,@Address
  1650            C        	MOV         TEMP2,A
  1651            C        	MOV         RSR,A
  1652            C        	BANK        @BankSel
  1653            C        	MOV         A,RSR
  1654            C        	MOV         TEMP2,A       ; save address base
  1655            C        	MESSAGE     "adding form 0x00 to bank 0"
  1656            C        
  1657            C          $_RAND_DATA_LOOP1:
  1658            C        	MOV         A,TEMP2
  1659            C        	MOV         RSR,A
  1660            C        	MOV         A,TEMP
  1661            C        	MOV         R0,A
  1662            C        
  1663            C        	RLC         TEMP          ; X*Y+1 MOD Z
  1664            C        	RLC         TEMP
  1665            C        	RLC         TEMP
  1666            C        	INC         TEMP
  1667            C        	RRC         TEMP
  1668            C        	RRC         TEMP
  1669            C        	RRC         TEMP
  1670            C        	JBS         STATUS,C
  1671            C        	BC          TEMP,0
  1672            C        	JBC         STATUS,C
  1673            C        	BS          TEMP,0
  1674            C        
  1675            C        	INC         TEMP2
  1676            C        	DJZ         TEMP1
  1677            C        	JMP         $_RAND_DATA_LOOP1:
  1678            C        	NOP
  1679            C        
  1680            C          ENDM
  1681            C        
    15                     include "D:\include\EM78xx\inc\EM78CtrlIns.H"
     1            C        /*****************************************************************
     2            C        * Filename     :  EM78CTRLINS.H
     3            C        * Author       :  yu.wei
     4            C        * Company      :  ELAN
     5            C        * VERSION      :  1.0
     6            C        * Creat date   :  2009/2
     7            C        * tool ver.    :  WicePlus II/eUIDE
     8            C        * Description  :  instruction aggregate
     9            C        *****************************************************************/
    10            C        ;------------------------------------------------------
    11            C        EM78CtrlIns.H    EQU         EM78CtrlIns.H
    12            C        
    13            C        ;-------------------------------------------------------
    14            C        
    15            C        ;***********************************************************
    16            C        ;sbit operator
    17            C        ;***********************************************************
    18            C        ; reg.bit exchange
    19            C        ;========================================
    20            C        COM MACRO REG,BIT
    21            C        	IF        BIT == 0
    22            C        		MOV        A,@0B00000001
    23            C        		XOR        REG,A
    24            C        	ELSEIF    BIT == 1
    25            C        		MOV        A,@0B00000010
    26            C        		XOR        REG,A
    27            C        	ELSEIF    BIT == 2
    28            C        		MOV        A,@0B00000100
    29            C        		XOR        REG,A
    30            C        	ELSEIF    BIT == 3
    31            C        		MOV        A,@0B00001000
    32            C        		XOR        REG,A
    33            C        	ELSEIF    BIT == 4
    34            C        		MOV        A,@0B00010000
    35            C        		XOR        REG,A
    36            C        	ELSEIF    BIT == 5
    37            C        		MOV        A,@0B00100000
    38            C        		XOR        REG,A
    39            C        	ELSEIF    BIT == 6
    40            C        		MOV        A,@0B01000000
    41            C        		XOR        REG,A
    42            C        	ELSEIF    BIT == 7
    43            C        		MOV        A,@0B10000000
    44            C        		XOR        REG,A
    45            C        	ELSE
    46            C        		MESSAGE    "BIT select ERROR"
    47            C        	ENDIF
    48            C        ENDM
    49            C        
    50            C        ;===============================================
    51            C        ; TO reg.bit1 = reg2.bit2
    52            C        ;================================================
    53            C        MOVB MACRO REG1,BIT1,REG2,BIT2
    54            C        	JBS       REG2,BIT2
    55            C        	BC        REG1,BIT1
    56            C        	JBC       REG2,BIT2
    57            C        	BS        REG1,BIT1
    58            C        ENDM
    59            C        
    60            C        ;===============================================
    61            C        ; TO reg1.bit1 = /reg2.bit2
    62            C        ;===============================================
    63            C        MOVBCPL MACRO REG1,BIT1,REG2,BIT2
    64            C        	JBS       REG2,BIT2
    65            C        	BS        REG1,BIT1
    66            C        	JBC       REG2,BIT2
    67            C        	BC        REG1,BIT1
    68            C        ENDM
    69            C        
    70            C        ;===============================================
    71            C        ; TO REG1=@DATA
    72            C        ;===============================================
    73            C        MOV MACRO REG,@DATA
    74            C        	MOV       A,@DATA
    75            C        	MOV       REG,A
    76            C        ENDM
    77            C        
    78            C        ;===============================================
    79            C        ; TO REG1=REG2
    80            C        ;===============================================
    81            C        MOV MACRO REG1,REG2
    82            C        	MOV       A,REG2
    83            C        	MOV       REG1,A
    84            C        ENDM
    85            C        
    86            C        
    87            C        
    88            C        ;***********************************************************
    89            C        ;条件分支结构类宏
    90            C        ;***********************************************************
    91            C        ;===============================================
    92            C        ;decrement reg and jump when not zero
    93            C        ;================================================
    94            C        DJNZ MACRO REG,ADDRESS
    95            C        	DJZ       REG
    96            C        	JMP       ADDRESS
    97            C        ENDM
    98            C        
    99            C        ;=====================================================
   100            C        ; INC reg and jump when not zero
   101            C        ;=====================================================
   102            C        IJNZ MACRO REG,ADDRESS
   103            C        	JZ        REG
   104            C        	JMP       ADDRESS
   105            C        ENDM
   106            C        
   107            C        ;=====================================================
   108            C        ; compare and jump
   109            C        ; if reg1 > reg2 jump to add1
   110            C        ; if reg1 < reg2 jump to add2
   111            C        ;=====================================================
   112            C        CJLJG MACRO REG1,REG2,ADD1,ADD2
   113            C        	MOV       A,REG2
   114            C        	SUB       A,REG1
   115            C        	JBS       0X03,0 ;R3==0X03
   116            C        	JMP       ADD1
   117            C        	JBS       0X03,2
   118            C        	JMP       ADD2
   119            C        ENDM
   120            C        
   121            C        ;=====================================================
   122            C        ; compare and jump if in range
   123            C        ; if @LITE1 <= REG <= @LITE2 jump to ADDR
   124            C        ;=====================================================
   125            C        CJIN MACRO REG,@LITE1,@LITE2,ADDR
   126            C        	MOV       A,REG
   127            C        	ADD       A,@255-LITE2
   128            C        	ADD       A,@LITE2-LITE1+1
   129            C        	JBC       0X03,0
   130            C        	JMP       ADDR
   131            C        ENDM
   132            C        
   133            C        ;=====================================================
   134            C        ; COMPARE AND JUMP IF OUT RANGE
   135            C        ; if REG > @LITE2 or REG < @LITE1 jump to ADDR
   136            C        ;=====================================================
   137            C        CJOUT MACRO REG,@LITE1,@LITE2,ADDR
   138            C        	MOV       A,REG
   139            C        	ADD       A,@255-LITE2
   140            C        	ADD       A,@LITE2-LITE1+1
   141            C        	JBS       0X03,0
   142            C        	JMP       ADDR
   143            C        ENDM
   144            C        
   145            C        ;=====================================================
   146            C        ; compare and jump if REG1 > REG2
   147            C        ;=====================================================
   148            C        CJG       MACRO REG1,REG2,ADDRESS
   149            C        	MOV       A,REG1
   150            C        	SUB       A,REG2
   151            C        	JBS       0X03,0
   152            C        	JMP       ADDRESS
   153            C        ENDM
   154            C        
   155            C        ;=====================================================
   156            C        ; compare and jump if REG1 >= REG2
   157            C        ;=====================================================
   158            C        CJGE MACRO REG1,REG2,ADDRESS
   159            C        	MOV       A,REG2
   160            C        	SUB       A,REG1
   161            C        	JBC       0X03,0
   162            C        	JMP       ADDRESS
   163            C        ENDM
   164            C        
   165            C        ;=====================================================
   166            C        ; compare and jump if REG1 < REG2
   167            C        ;=====================================================
   168            C        CJL MACRO REG1,REG2,ADDRESS
   169            C        	MOV       A,REG2
   170            C        	SUB       A,REG1
   171            C        	JBS       0X03,0
   172            C        	JMP       ADDRESS
   173            C        ENDM
   174            C        
   175            C        ;=====================================================
   176            C        ; compare and jump if REG1 <= REG2
   177            C        ;=====================================================
   178            C        CJLE MACRO REG1,REG2,ADDRESS
   179            C        	MOV       A,REG1
   180            C        	SUB       A,REG2
   181            C        	JBC       0X03,0
   182            C        	JMP       ADDRESS
   183            C        ENDM
   184            C        
   185            C        ;=====================================================
   186            C        ; compare and jump if REG1 = REG2
   187            C        ;=====================================================
   188            C        CJE MACRO REG1,REG2,ADDRESS
   189            C        	MOV       A,REG2
   190            C        	SUB       A,REG1
   191            C        	JBC       0X03,2
   192            C        	JMP       ADDRESS
   193            C        ENDM
   194            C        
   195            C        ;=====================================================
   196            C        ; compare and jump if REG1 = @DATA jmp to ADDRESS
   197            C        ;=====================================================
   198            C        CJE MACRO REG,@DATA,ADDRESS
   199            C        	MOV       A,REG
   200            C        	SUB       A,@DATA
   201            C        	JBC       0X03,2
   202            C        	JMP       ADDRESS
   203            C        ENDM
   204            C        
   205            C        ;=====================================================
   206            C        ; compare and jump if REG1=REG2=@DATA jmp to ADDRESS
   207            C        ;=====================================================
   208            C        CJE MACRO REG1,REG2,@DATA,ADDRESS
   209            C        	MOV       A,REG2
   210            C        	SUB       A,REG1
   211            C        	JBS       0X03,2
   212            C        	JMP       $_CJE_DONE
   213            C        	MOV       A,REG1
   214            C        	SUB       A,@DATA
   215            C        	JBC       0X03,2
   216            C        	JMP       ADDRESS
   217            C        $_CJE_DONE:
   218            C        ENDM
   219            C        
   220            C        ;=====================================================
   221            C        ; compare and jump if REG1 <> REG2
   222            C        ;=====================================================
   223            C        CJNE MACRO REG1,REG2,ADDRESS
   224            C        	MOV       A,REG2
   225            C        	SUB       A,REG1
   226            C        	JBS       0X03,2
   227            C        	JMP       ADDRESS
   228            C        ENDM
   229            C        
   230            C        ;=====================================================
   231            C        ;compare and jump if REG = 0 JMP ADDRESS
   232            C        ;=====================================================
   233            C        CJZ MACRO REG,ADDRESS
   234            C        	MOV       REG,REG
   235            C        	JBC       0X03,2
   236            C        	JMP       ADDRESS
   237            C        ENDM
   238            C        
   239            C        ;=====================================================
   240            C        ; compare and jump if REG <> 0
   241            C        ;=====================================================
   242            C        CJNZ MACRO REG,ADDRESS
   243            C        	MOV       REG,REG
   244            C        	JBS       0X03,2
   245            C        	JMP       ADDRESS
   246            C        ENDM
   247            C        
   248            C        ;=====================================================
   249            C        ; compare and jump if REG.BIT = 0
   250            C        ;=====================================================
   251            C        CJBC MACRO REG,BIT,ADDRESS
   252            C        	JBS       REG,BIT
   253            C        	JMP       ADDRESS
   254            C        ENDM
   255            C        
   256            C        ;=====================================================
   257            C        ; compare and jump if REG.BIT = 1
   258            C        ;=====================================================
   259            C        CJBS MACRO REG,BIT,ADDRESS
   260            C        	JBC       REG,BIT
   261            C        	JMP       ADDRESS
   262            C        ENDM
   263            C        
   264            C        ;=====================================================
   265            C        ; compare and jump if REG.BIT = 0 JMP ADDRESS1
   266            C        ;                  if REG.BIT = 1 JMP ADDRESS2
   267            C        ;=====================================================
   268            C        CJBCS MACRO REG,BIT,ADDRESS1,ADDRESS2
   269            C        	JBC       REG,BIT
   270            C        	JMP       ADDRESS1
   271            C        	JBS       REG,BIT
   272            C        	JMP       ADDRESS2
   273            C        ENDM
   274            C        
   275            C        
   276            C        
   277            C        
   278            C        
   279            C        ;***********************************************************
   280            C        ;中断压栈与出栈类宏
   281            C        ;***********************************************************
   282            C        ;===============================================
   283            C        ; 压栈程序
   284            C        ; 说明:中断入口调用此程序,将ACC,R3压栈
   285            C        ; A      -> A_TEMP
   286            C        ; R4    -> RSR_TEMP
   287            C        ; STATUS -> STATUS_TEMP
   288            C        ;================================================
   289            C        PUSH MACRO
   290            C        	MOV                 A_TEMP,A       ;A_TEMP,A         ;SAVE A
   291            C        	SWAP                A_TEMP         ;A_TEMP
   292            C        	SWAPA               0X03           ;STATUS           ;SAVE STATUS(R3)
   293            C        	MOV                 STATUS_TEMP,A  ;STATUS_TEMP,A
   294            C        IFDEF EM78P510.H
   295            C        	SWAPA               0X05           ;R5              ;SAVE R5(R5)
   296            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   297            C        ELSE
   298            C        	SWAPA               0X04           ;R4              ;SAVE R4(R4)
   299            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   300            C        ENDIF
   301            C        	CLR                 0X03           ;STATUS           ;SELECT PAGE0
   302            C        ENDM
   303            C        
   304            C        ;---------------------------------------
   305            C        POP MACRO
   306            C        	SWAPA               STATUS_TEMP    ;STATUS_TEMP    ;R3
   307            C        	MOV                 0X03,A         ;STATUS,A
   308            C        IFDEF EM78P510.H
   309            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   310            C        	MOV                 0X05,A         ;R4,A
   311            C        ELSE
   312            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   313            C        	MOV                 0X04,A         ;R4,A
   314            C        ENDIF
   315            C        	SWAPA               A_TEMP         ;A_TEMP
   316            C        ENDM
   317            C        
   318            C        ;========================== EM78P520 =================================
   319            C        PUSH MACRO A_Temp,STATUS_Temp,RSR_Temp,@BankSel,Ax_Temp,STATUSx_Temp,RSRx_Temp
   320            C        	MOV                 A_TEMP,A       ;A_TEMP,A         ;SAVE A
   321            C        	SWAP                A_TEMP         ;A_TEMP
   322            C        	SWAPA               0X03           ;STATUS           ;SAVE STATUS(R3)
   323            C        	MOV                 STATUS_TEMP,A  ;STATUS_TEMP,A
   324            C        	SWAPA               0X05           ;R4              ;SAVE R4(R4)
   325            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   326            C        	CLR                 0X03           ;STATUS           ;SELECT PAGE0
   327            C        
   328            C        	BANK                @BankSel
   329            C        	MOV                 A,A_TEMP
   330            C        	MOV                 Ax_Temp,A
   331            C        	MOV                 A,STATUS_Temp
   332            C        	MOV                 STATUSx_Temp,A
   333            C        	MOV                 A,RSR_Temp
   334            C        	MOV                 RSRx_Temp,A
   335            C        ENDM
   336            C        
   337            C        ;---------------------------------------
   338            C        POP MACRO A_Temp,STATUS_Temp,RSR_Temp,@BankSel,Ax_Temp,STATUSx_Temp,RSRx_TEMP
   339            C        	BANK                @BankSel
   340            C        	MOV                 A,Ax_Temp
   341            C        	MOV                 A_TEMP,A
   342            C        	MOV                 A,STATUSx_Temp
   343            C        	MOV                 STATUS_Temp,A
   344            C        	MOV                 A,RSR_TEMP
   345            C        	MOV                 RSRx_TEMP,A
   346            C        
   347            C        	SWAPA               STATUS_TEMP    ;STATUS_TEMP    ;R3
   348            C        	MOV                 0X03,A         ;STATUS,A
   349            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   350            C        	MOV                 0X05,A         ;R4,A
   351            C        	SWAPA               A_TEMP         ;A_TEMP
   352            C        ENDM
   353            C        
   354            C        ;***********************************************************
   355            C        ;long jmp/long call
   356            C        ;***********************************************************
   357            C        ;===================================================
   358            C        ; select page
   359            C        ;===================================================
   360            C        PAGE MACRO NUM
   361            C        IFDEF     EM78P510.H
   362            C        	ERROR
   363            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   364            C        	MESSAGE "can not use the instrction PAGE"
   365            C        ELSE
   366            C        	IF        NUM == 0
   367            C                      BC        0X03,7
   368            C                      BC        0X03,6
   369            C                      BC        0X03,5
   370            C        	ELSEIF    NUM == 1
   371            C        	          BC        0X03,7
   372            C        	          BC        0X03,6
   373            C        	          BS        0X03,5
   374            C        	ELSEIF    NUM == 2
   375            C        	          BC        0X03,7
   376            C        	          BS        0X03,6
   377            C        	          BC        0X03,5
   378            C        	ELSEIF    NUM == 3
   379            C        	          BC        0X03,7
   380            C        	          BS        0X03,6
   381            C        	          BS        0X03,5
   382            C        	ELSEIF    NUM == 4
   383            C        	          BS        0X03,7
   384            C        	          BC        0X03,6
   385            C        	          BC        0X03,5
   386            C        	ELSEIF    NUM == 5
   387            C        	          BS        0X03,7
   388            C        	          BC        0X03,6
   389            C        	          BS        0X03,5
   390            C        	ELSEIF    NUM == 6
   391            C        	          BS        0X03,7
   392            C        	          BS        0X03,6
   393            C        	          BC        0X03,5
   394            C        	ELSEIF    NUM == 7
   395            C        	          BS        0X03,7
   396            C        	          BS        0X03,6
   397            C        	          BS        0X03,5
   398            C        	ELSE
   399            C        	          MESSAGE "WARRING: don't have specify page"
   400            C        	ENDIF
   401            C        ENDIF
   402            C        
   403            C        ENDM
   404            C        
   405            C        ;===================================================%
   406            C        ; roboticized call
   407            C        ;===================================================
   408            C        FCALL MACRO ADDRESS
   409            C        IFDEF     EM78P510.H
   410            C        	ERROR
   411            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   412            C        	MESSAGE "can not use the instrction FCALL"
   413            C        ELSE
   414            C        	IF        ADDRESS/0X400 == $/0X400
   415            C        	          CALL      ADDRESS
   416            C        	ELSE
   417            C        	          PAGE      ADDRESS/0X400
   418            C        	          CALL      ADDRESS%0X400
   419            C        	          PAGE      $/0X400
   420            C        	ENDIF
   421            C        ENDIF
   422            C        ENDM
   423            C        
   424            C        ;===================================================
   425            C        ; roboticized call
   426            C        ; input:NUM = page number,  ADDRESS =  code address
   427            C        ;===================================================
   428            C        FCALL MACRO NUM,ADDRESS
   429            C        IFDEF     EM78P510.H
   430            C        	ERROR
   431            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   432            C        	MESSAGE "can not use the instrction FCALL"
   433            C        ELSE
   434            C        	PAGE      NUM
   435            C        	CALL      ADDRESS
   436            C        	PAGE      $/0X400
   437            C        ENDIF
   438            C        ENDM
   439            C        
   440            C        ;===================================================
   441            C        ; roboticized jmp
   442            C        ;===================================================
   443            C        FJMP MACRO ADDRESS
   444            C        IFDEF     EM78P510.H
   445            C        	ERROR
   446            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   447            C        	MESSAGE "can not use the instrction FJMP"
   448            C        ELSE
   449            C        	IF        ADDRESS/0X400 == $/0X400
   450            C        	          JMP       ADDRESS
   451            C        	ELSE
   452            C        	          PAGE      ADDRESS/0X400
   453            C        	          JMP       ADDRESS%0X400
   454            C        	ENDIF
   455            C        ENDIF
   456            C        ENDM
   457            C        
   458            C        ;===================================================
   459            C        ; roboticized jmp
   460            C        ; input:NUM = page number,  ADDRESS =  code address
   461            C        ;===================================================
   462            C        FJMP MACRO NUM,ADDRESS
   463            C        IFDEF     EM78P510.H
   464            C        	ERROR
   465            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   466            C        	MESSAGE "can not use the instrction FJMP"
   467            C        ELSE
   468            C        	PAGE      NUM
   469            C        	JMP       ADDRESS
   470            C        ENDIF
   471            C        ENDM
   472            C        
   473            C        ;===================================================
   474            C        ; select bank
   475            C        ;===================================================
   476            C        BANK MACRO @NUM
   477            C        IFDEF EM78M611E.H
   478            C        	IF        @NUM == 0
   479            C                      BC        0X04,7
   480            C                      BC        0X04,6
   481            C        	ELSEIF    @NUM == 1
   482            C        	          BC        0X04,7
   483            C        	          BS        0X04,6
   484            C        	ELSEIF    @NUM == 2
   485            C        	          BS        0X04,7
   486            C        	          BC        0X04,6
   487            C        	ELSEIF    @NUM == 3
   488            C        	          BS        0X04,7
   489            C        	          BS        0X04,6
   490            C        	ENDIF
   491            C        
   492            C        ELSEIFDEF EM78M612.H
   493            C        	IF        @NUM == 0
   494            C                      BC        0X04,6
   495            C        	ELSEIF    @NUM == 1
   496            C        	          BS        0X04,6
   497            C        	ENDIF
   498            C        ELSE
   499            C        	MESSAGE "the MCU defualt have 'bank' intruction"
   500            C        ENDIF
   501            C        ENDM
   502            C        
   503            C        
   504            C        
   505            C        ;*******************************************
   506            C        ; RAM clear function
   507            C        ; [ELSE]: default the MCU have four bank
   508            C        ; others: xx.h must be define in "xx.h"
   509            C        ;*******************************************
   510            C        ClrRamBank MACRO
   511            C        IFDEF EM78P520.H
   512            C         	CLR     0X05
   513            C        	MOV     A,@0XD0
   514            C        	MOV     0X04,A
   515            C        
   516            C        	CLR     0X00
   517            C        	INC     0X04
   518            C        	MOV     A,0X04
   519            C        	AND     A,@0X3F
   520            C        	JBS     0X03,2
   521            C        	JMP     $-5
   522            C        	BC      0X04,6
   523            C        	INC     0X05
   524            C        	BS      0X04,5
   525            C        	MOV     A,@0X07
   526            C        	AND     0X05,A
   527            C        	BS      0X04,6
   528            C        	JBS     0X03,2
   529            C        	JMP     $-13
   530            C        	CLR		0X04
   531            C        	BS      0X04,6
   532            C        
   533            C        ELSEIFDEF EM78M611E.H
   534            C         	MOV     A,@0x10
   535            C        	MOV     R4,A
   536            C        
   537            C        	CLR     R0
   538            C        	INC     R4
   539            C        	JBC     R4,6
   540            C        	BS      R4,5
   541            C        	JBC     R4,7
   542            C        	BS      R4,5
   543            C        	JBS     R3,Z
   544            C        	JMP     $-7
   545            C        	CLR     R4
   546            C        
   547            C        	MOV     A,@0X11
   548            C        	MOV     RD,A
   549            C        	CLR     RE
   550            C        	MOV     A,@1
   551            C        	MOV     RD,A
   552            C        	MOV     A,@0X00
   553            C        	MOV     RE,A
   554            C        	MOV     RE,A
   555            C        	MOV     RE,A
   556            C        	MOV     RE,A
   557            C        	MOV     RE,A
   558            C        	MOV     RE,A
   559            C        	MOV     RE,A
   560            C        	MOV     RE,A
   561            C        	BS      RC,5
   562            C        
   563            C        ELSEIFDEF EM78P447.H
   564            C         	MOV     A,@0x10
   565            C        	MOV     R4,A
   566            C        
   567            C        	CLR     R0
   568            C        	INC     R4
   569            C        	JBC     R4,6
   570            C        	BS      R4,5
   571            C        	JBC     R4,7
   572            C        	BS      R4,5
   573            C        	JBS     R3,Z
   574            C        	JMP     $-7
   575            C        	CLR     R4
   576            C        
   577            C        ELSEIFDEF EM78P468.H
   578            C        	MOV     A,@0X10
   579            C        	MOV     0X04,A
   580            C        
   581            C        	CLR     0X00
   582            C        	INC     0X04
   583            C        	JBC     0X04,6
   584            C        	BS      0X04,5
   585            C        	JBC     0X04,7
   586            C        	BS      0X04,5
   587            C        	JBS     0X03,2
   588            C        	JMP     $-7
   589            C        
   590            C        ELSEIFDEF EM78P458.H
   591            C        	MOV     A,@0X10
   592            C        	MOV     R4,A
   593            C        
   594            C        	CLR     R0
   595            C        	INC     R4
   596            C        	JBC     R4,6
   597            C        	BS      R4,5
   598            C        	JBS     R4,7
   599            C        	JMP     $-5
   600            C        	CLR     R4
   601            C        
   602            C        ELSEIFDEF EM78P451.H
   603            C        	MOV     A,@0X10
   604            C        	MOV     R4,A
   605            C        
   606            C        	CLR     R0
   607            C        	INC     R4
   608            C        	JBC     R4,6
   609            C        	BS      R4,5
   610            C        	JBC     R4,7
   611            C        	BS      R4,5
   612            C        	JBS     STATUS,Z
   613            C        	JMP     $-7
   614            C        	CLR		RSR
   615            C        
   616            C        ELSEIFDEF EM78F651.H
   617            C        	MOV		A,@0X10
   618            C        	MOV		RSR,A
   619            C        
   620            C        	CLR		R0
   621            C        	INC		RSR
   622            C        	JBC	 	RSR,6
   623            C        	BS		RSR,5
   624            C        	JBC		RSR,7
   625            C        	BS		RSR,5
   626            C        	JBS		Z
   627            C        	JMP             $-7
   628            C        	CLR		RSR
   629            C        
   630            C        ELSEIFDEF EM78P153N.H
   631            C                MOV     A,@0X10
   632            C                MOV     RSR,A
   633            C        
   634            C                CLR     R0
   635            C                INC     RSR
   636            C                JBC     RSR,5
   637            C                JBS     RSR,4
   638            C                JMP     $-4
   639            C         
   640            C        
   641            C        ELSE
   642            C        	MOV     A,@0x10        ; clear all ram bank
   643            C        	MOV     R4,A
   644            C        
   645            C        	CLR     R0
   646            C        	INC     R4
   647            C        	JBC     R4,6
   648            C        	BS      R4,5
   649            C        	JBC     R4,7
   650            C        	BS      R4,5
   651            C        	JBS     R3,Z
   652            C        	JMP     $-7
   653            C        	CLR     R4
   654            C        	MESSAGE "Clear all RAM bank"
   655            C        ENDIF
   656            C        ENDM
   657            C        
   658            C        ;*******************************************
   659            C        ; RAM clear function
   660            C        ; [ELSE]: default the MCU have four bank
   661            C        ; others: xx.h must be define in "xx.h"
   662            C        ;*******************************************
   663            C        ClrCommRamBank MACRO
   664            C        	MOV                 A, @0X10        ; 清RAM 初始地址
   665            C        	MOV                 R4, A
   666            C        
   667            C        	WDTC
   668            C        	CLR                 R0
   669            C        	INC                 R4
   670            C        	MOV                 A,@0B00111111
   671            C        	AND                 A,R4
   672            C        	SUB                 A,@0X1F
   673            C        	JBC                 R3,C
   674            C        	JMP                 $-7
   675            C        	CLR                 R4
   676            C        ENDM
   677            C        
   678            C        ;********************************************************************
   679            C        ;********************************************************************
   680            C        Clearbuffer MACRO
   681            C          ifdef EM78P520.H
   682            C        	MOV                 A,@0B11100000   ; clear bank0 ram
   683            C        	MOV                 R4,A
   684            C        	BANK                0               ; R5=0
   685            C        
   686            C        	WDTC
   687            C        	CLR                 R0
   688            C        	INC                 R4
   689            C        	MOV                 A,@0B00111111
   690            C        	AND                 A,R4
   691            C        	XOR                 A,@0X3F
   692            C        	JBS                 R3,Z
   693            C        	JMP                 $-7
   694            C        	CLR                 R0
   695            C        	MOV                 A,@0B11000000
   696            C        	MOV                 R4,A
   697            C        
   698            C          elseifdef EM78M611E.H
   699            C        	MOV                 A,@0B00100000   ; clear bank0 ram
   700            C        	MOV                 R4,A
   701            C        
   702            C        	WDTC
   703            C        	CLR                 R0
   704            C        	INC                 R4
   705            C        	MOV                 A,@0B00111111
   706            C        	AND                 A,R4
   707            C        	XOR                 A,@0X3F
   708            C        	JBS                 R3,Z
   709            C        	JMP                 $-7
   710            C        	CLR                 R0
   711            C        	CLR                 R4
   712            C        
   713            C          else
   714            C        	MOV                 A,@0B00100000   ; clear bank0 ram
   715            C        	MOV                 R4,A
   716            C        
   717            C        	WDTC
   718            C        	CLR                 R0
   719            C        	INC                 R4
   720            C        	MOV                 A,@0B00111111
   721            C        	AND                 A,R4
   722            C        	XOR                 A,@0X3F
   723            C        	JBS                 R3,Z
   724            C        	JMP                 $-7
   725            C        	CLR                 R4
   726            C          endif
   727            C        ENDM
   728            C        
   729            C        
    16                     include "config.h"
     1            C        /*****************************************************************
     2            C        ; Filename     :  EM78M611rxP40M1v6V10 config
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  4.0
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10            C        *****************************************************************/
    11            C        ;-------------------------------------------------------------------------
    12            C        config.h    EQU    config.h
    13            C        
    14            C        ;-------------------------------------------------------------------------
    15       0001 C        DebugDisplay                    EQU     1     ; debug switch
    16       0000 C        MassageDisplay                  EQU     0     ; massage display switch
    17       0000 C        USED_PID_FUNCTION               EQU     0     ; 1:used this function; 0:not used
    18       0002 C        GamePadsSum_Default             EQU     2
    19       0020 C        DataBufferBase                  EQU     0x20  ; Address:0x20 ,bit6:select all bank
    20       0004 C        SetComuSyncTime                 EQU     4     ; 4ms sync header time
    21       0004 C        SetComuTime                     EQU     4     ; 4ms Communicte System
    22       0000 C        RetryCNT                        EQU     0     ; transmit 0 Times Retry
    23       00D6 C        RX_IDH_DEFAULT                  EQU     0XD6  ; 0X9D
    24       00AC C        RX_IDL_DEFAULT                  EQU     0XAC  ; 0XCB  ; Adress_default = [RX_IDH_DEFAULT,RX_IDL_DEFAULT&0x0f]
    25       00C8 C        RX_ComuLoseCNT_Default          EQU     200   ; T=ComuTime+ComuSyncTime*RX_ComuLoseCNT_Default
    26       00CD C        SetChecksumH                    EQU     0XCD  ; host computer cheaksum high byte
    27       00EF C        SetChecksumL                    EQU     0XEF  ; host computer cheaksum low byte
    28            C        
    29            C        
    30            C        
    31            C        
    17                     include "M611rxP40.H"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  4.0
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10            C        ;  Description: PAGE0(0X0000-0X03FF): EM78M611 initial / EEprom setting / SYNC_COM_TX
    11            C        ;               PAGE1(0X0400-0X07FF): RX1_FUNCTION / RX2_FUNCTION / RX3_FUNCTION / RX4_FUNCTION
    12            C        ;               PAGE2(0X0800-0X0BFF): RX5_FUNCTION / RX6_FUNCTION / RX7_FUNCTION / RX8_FUNCTION
    13            C        ;               PAGE3(0X0C00-0X0FFF): Communicate_USB_Function table
    14            C        ;               PAGE4(0X1000-0X13FF): Communicate_USB_Function Function
    15            C        ;               PAGE5(0X1400-0X17FF): RF initial function
    16            C        
    17            C        ;==================================================================
    18            C        M611rxP40.H                     EQU     M611rxP40.H
    19            C        
    20            C        
    21            C        ;--------------------------- function config ----------------------------
    22       0001 C        TCC_T_DEBUG                     EQU     1
    23            C        
    24            C        
    25            C        ;----------------------------------------------------------------------
    26       0000 C        RX1                             EQU     0     ; CHN_FLAG[0]
    27       0001 C        RX2                             EQU     1     ; CHN_FLAG[1]
    28       0002 C        RX3                             EQU     2
    29       0003 C        RX4                             EQU     3
    30       0004 C        RX5                             EQU     4
    31       0005 C        RX6                             EQU     5     ; CHN_FLAG[5]
    32            C        
    33            C        
    34            C        ;==================================================================
    35       0010 C        TEMP                            EQU     0X10        ; used for rock-bottom RF initial
    36       0011 C        TEMP1                           EQU     0X11        ; used for rock-bottom RF initial
    37       0012 C        TEMP2                           EQU     0X12        ; used for rock-bottom RF initial
    38       0013 C        TEMP3                           EQU     0X13        ; used for rock-bottom RF initial
    39       0014 C        TEMP4                           EQU     0X14        ; used for rock-bottom RF initial
    40       0015 C        TEMP5                           EQU     0X15        ;
    41       0016 C        TEMP6                           EQU     0X16        ;
    42            C        
    43       0017 C        SystemTimeCNT                   EQU     0X17
    44       0018 C        TABLE_INDEX                     EQU     0x18        ; descriptor table's start position
    45       0019 C        DataShiftCounter                EQU     0X19        ; data counter
    46       001A C        DataByteLength                  EQU     0X1A		; READ/WRITE DATA LENGTH
    47       001B C        ComuClock                       EQU     0X1B        ; Communication clock
    48            C        
    49       001C C        TRANSFER                        EQU     0X1C		     ;
    50       00E0 C        	JudgeHandFlag1              ==      TRANSFER*8+0    ; judge which hand send to host,BYTE0
    51       00E1 C        	JudgeHandFlag2              ==      TRANSFER*8+1    ; judge which hand send to host,BYTE1
    52       00E2 C        	JudgeHandFlag3              ==      TRANSFER*8+2    ; judge which hand send to host,BYTE2
    53       00E3 C        	SetupDataStageFlag          ==      TRANSFER*8+3    ; select HID table 1
    54       00E4 C        	TableSelectFlag1            ==      TRANSFER*8+4    ; select HID table 1
    55       00E5 C        	TableSelectFlag2            ==      TRANSFER*8+5    ; select HID table 2
    56       00E6 C        	TableSelectFlag3            ==      TRANSFER*8+6    ; select HID table 3
    57       00E7 C        	UsbEP0interruptflag         ==      TRANSFER*8+7
    58            C        
    59       001D C        GeneralStatusFlag1              EQU     0X1D
    60       00EF C        	RFInitialFailFlag           ==      GeneralStatusFlag1*8+7 ;
    61       00EE C        	RFInitialOKFlag             ==      GeneralStatusFlag1*8+6
    62       00ED C        	RFTestFailFlag              ==      GeneralStatusFlag1*8+5
    63       00EC C        	ReadLengthError             ==      GeneralStatusFlag1*8+4
    64       00EB C        	USBReportFinishFlag         ==      GeneralStatusFlag1*8+3   ; DESCRIPTOR FINISH(1) OR NOT(USB)
    65            C        	;FRAMER_CONFIG_ERROR         ==      GeneralStatusFlag1*8+1 ; Framer Compare Bit Error Flag
    66            C        	;RECEIVE_ERROR               ==      GeneralStatusFlag1*8+1 ; Judge Receive Register 64 Error Flag
    67       00E8 C        	ModeSelectFlag              ==      GeneralStatusFlag1*8+0 ;1:analog  0:digital(default 0)
    68            C        
    69            C        
    70       001F C        GeneralStatusFlag2              EQU     0X1F
    71       00FB C        	KeyScanFinishFlag           ==      GeneralStatusFlag2*8+3
    72       00FA C        	KeyStatusFlag               ==      GeneralStatusFlag2*8+2
    73       00F9 C        	KeyScanStatusFlag           ==      GeneralStatusFlag2*8+1
    74       00F8 C        	KeyScanInitFlag             ==      GeneralStatusFlag2*8+0
    75            C        
    76       001E C        CommuStatusFlag                 EQU     0X1E
    77       00F7 C        	MotorStatusFlag             ==      CommuStatusFlag*8+7
    78       00F6 C        	FccTestModeFlag             ==      CommuStatusFlag*8+6
    79       00F5 C        	ForceLinkModeFlag           ==      CommuStatusFlag*8+5   ; force link flag
    80       00F4 C        	LinkModeFlag                ==      CommuStatusFlag*8+4   ; link flag
    81       00F3 C        	EEpromWRStatusFlag          ==      CommuStatusFlag*8+3
    82       00F2 C        	LoseFrameStatusFlag         ==      CommuStatusFlag*8+2   ; lose frequency and search mode flag
    83       00F1 C        	NormalStatusFlag            ==      CommuStatusFlag*8+1   ; Normal mode Flag
    84       00F0 C        	SearchStatusFlag            ==      CommuStatusFlag*8+0   ; Search mode flag
    85            C        
    86            C        
    87            C        ;-----------------------------------------------------------------------
    88       0010 C        SPIWB                           EQU     TEMP     ; SPI WRITE BYTE VALUE
    89       0010 C        SPIRB                           EQU     TEMP
    90       0011 C        r_acc1                          EQU     TEMP1    ; TEMP1 - TEMP5 used for EEPROM
    91       0012 C        r_acc2                          EQU     TEMP2
    92       0013 C        r_acc3                          EQU     TEMP3
    93       0014 C        DataAddressInMCU                EQU     TEMP4    ; 93C46
    94       0015 C        DataAddressInEEPROM             EQU     TEMP5
    95            C        
    96       0013 C        CMD_SELECT                      EQU     TEMP3
    97       0014 C        A_TEMP                          EQU     TEMP4    ; TEMP4 - TEMP6 used for PUSH and POP
    98       0015 C        RSR_TEMP                        EQU     TEMP5
    99       0016 C        STATUS_TEMP                     EQU     TEMP6
   100            C        
   101            C        
   102            C        ;==============================I/O Port Define==========================
   103       0030 C        SPI_MISO                        ==      PORT6*8+0   ;0
   104       0031 C        RESET_N                         ==      PORT6*8+1	;1
   105       0032 C        SPI_CLK                         ==      PORT6*8+2   ;2
   106       0033 C        SPI_MOSI                        ==      PORT6*8+3   ;3
   107       0034 C        SPI_SS                          ==      PORT6*8+4   ;4
   108       0035 C        FIFO_FLAG                       ==      PORT6*8+5   ;5
   109       0036 C        PKT_FLAG                        ==      PORT6*8+6   ;6
   110            C        
   111       002C C        IIC_SCL                         ==      Port5*8+4
   112       002D C        IIC_SDA                         ==      Port5*8+5
   113       002E C        AT93C46_CS                      ==      Port5*8+6 ;4  93c46 enable select
   114            C        
   115       004A C        Keystoke                        ==      Port9*8+2
   116       004B C        LED1_STATUS                     ==      PORT9*8+3 ;LED
   117            C        
   118            C        
   119            C        ;============================================== BANK 0 ============================================
   120            C        ; bank0 20-3f used for data exchange section[Data Buffer]
   121            C        ; such as read or write EEPROM and RF,it used for data buffer
   122            C        ; sync timing:             RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrl,CH_NO,TX1_ID,TX2_ID,TX3_ID,TX4_ID,TX5_ID,TX6_ID
   123            C        ; responses answer timing: RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrl,CH_NO,TXx_ID
   124            C        ; responses data timing:   RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrlO.)
   125            C        
   126            C        ;------------------------- Header code --------------------------------
   127       0020 C        PID_DATA_Buffer                 EQU     0X20 ; PID DATA, not used
   128       0021 C        RX_IDH_Buffer                   EQU     0X21 ; Master IDH
   129       0022 C        RX_IDL_Buffer                   EQU     0X22 ; Master IDL
   130       0023 C        CHN_FLAG_Buffer                 EQU     0X23 ; Channel flag, gamepad status
   131       0024 C        GamePadsSum_Buffer              EQU     0X24 ; Communication trsmitter direction
   132       0025 C        CommuStatusFlag_Buffer          EQU     0X25
   133       0026 C        CH_NO_Buffer                    EQU     0X26 ; N_CHN= ((TotalGamepads<<4) & 0xF0)|(CH_NO & 0x0F)
   134            C        
   135            C        ;-------------------------- search and connect ---------------------------
   136       0027 C        TX1_ID_Buffer                   EQU     0X27 ;
   137       0028 C        TX2_ID_Buffer                   EQU     0X28 ;
   138       0029 C        TX3_ID_Buffer                   EQU     0X29 ;
   139       002A C        TX4_ID_Buffer                   EQU     0X2A ;
   140       002B C        TX5_ID_Buffer                   EQU     0X2B ;
   141       002C C        TX6_ID_Buffer                   EQU     0X2C ;
   142            C        ;---------------------------- receive data ----------------------------
   143       0027 C        TX_ID_Buffer                    EQU     0X27 ; repeat package data
   144       0028 C        DataA_Buffer                    EQU     0X28 ; rocker, left-x(left-right) data
   145       0029 C        DataB_Buffer                    EQU     0X29 ; rocker, left-y(up-down) data
   146       002A C        DataC_Buffer                    EQU     0X2A ; rocker, right-x(left-right) data
   147       002B C        DataD_Buffer                    EQU     0X2B ; rocker, right-y(up-down) data
   148       002C C        DataE_Buffer                    EQU     0X2C ; A,B,C,D,L1,R1,L2,R2
   149       002D C        DataF_Buffer                    EQU     0X2D ; Select,start,LSW,RSW,MODE,MACRO,TEST1,TEST2
   150       002E C        DataG_Buffer                    EQU     0X2E ; 000:00’001:45’010:90’011:135’100:180’101:225’110:270’111:315’
   151            C        
   152       002F C        CMOS_xAxisL_Buffer              EQU     0X2F
   153       0030 C        CMOS_yAxisL_Buffer              EQU     0X30
   154       0031 C        CMOS_yxsAxisH_Buffer            EQU     0X31
   155            C        
   156       0032 C        GS_xAxisL_Buffer                EQU     0X32
   157       0033 C        GS_yAxisL_Buffer                EQU     0X33
   158       0034 C        GS_zAxisL_Buffer                EQU     0X34
   159       0035 C        GS_xyzAxisH_Buffer              EQU     0X35
   160            C        ;--------------------------- Transmitter data --------------------------
   161       0027 C        MOTOR_ID_Buffer                 EQU     0X27
   162       013D C        	Motor6CtrlFlag              ==      MOTOR_ID_Buffer*8+5
   163       013C C        	Motor5CtrlFlag              ==      MOTOR_ID_Buffer*8+4
   164       013B C        	Motor4CtrlFlag              ==      MOTOR_ID_Buffer*8+3
   165       013A C        	Motor3CtrlFlag              ==      MOTOR_ID_Buffer*8+2
   166       0139 C        	Motor2CtrlFlag              ==      MOTOR_ID_Buffer*8+1
   167       0138 C        	Motor1CtrlFlag              ==      MOTOR_ID_Buffer*8+0
   168       0028 C        MOTOR1_VibrInten_Buffer         EQU     0X28    ; Motor1 vibration Intensity byte
   169       0029 C        MOTOR2_VibrInten_Buffer         EQU     0X29    ; Motor2 vibration Intensity byte
   170       002A C        MOTOR3_VibrInten_Buffer         EQU     0X2A    ; Motor3 vibration Intensity byte
   171       002B C        MOTOR4_VibrInten_Buffer         EQU     0X2B    ; Motor4 vibration Intensity byte
   172       002C C        MOTOR5_VibrInten_Buffer         EQU     0X2C    ; Motor5 vibration Intensity byte
   173       002D C        MOTOR6_VibrInten_Buffer         EQU     0X2D    ; Motor6 vibration Intensity byte
   174            C        
   175            C        ;------------------------ checksum -------------------------------------
   176       003E C        ChecksumH                       EQU     0X3E
   177       003F C        ChecksumL                       EQU     0X3F
   178            C        
   179            C        ;-------------------------------------------------------------------------
   180            C        ;----------------------- used for USB Command ----------------------------
   181       0020 C        BYTE0                           EQU     0X20
   182       0021 C        BYTE1                           EQU     0X21
   183       0022 C        BYTE2                           EQU     0X22
   184       0023 C        BYTE3                           EQU     0X23
   185       0024 C        BYTE4                           EQU     0X24
   186       0025 C        BYTE5                           EQU     0X25
   187       0026 C        BYTE6                           EQU     0X26
   188       0027 C        BYTE7                           EQU     0X27
   189            C        
   190       0030 C        EP1_ReportID                    EQU     0X30
   191       0031 C        PROTOCOL_TEMP                   EQU     0X31 ; BYTE 2 , (0)Boot Protocol,(1)Report Protocol
   192       0032 C        IDLE_TEMP                       EQU     0X32 ; BYTE 3
   193       0033 C        PC_WANT0                        EQU     0X33 ; BYTE 6
   194       0034 C        PC_WANT1                        EQU     0X34 ; BYTE 7
   195       0035 C        DataMaxTable1                   EQU     0X35 ; descriptor table's data length (table 1)
   196       0036 C        DataMaxTable2                   EQU     0X36 ; descriptor table's data length (table 2)
   197       0037 C        DataMaxTable3                   EQU     0X37 ; descriptor table's data length (table 3)
   198            C        
   199            C        
   200            C        ;========================= BANK 1 ============================================
   201       0020 C        PID_DATA                        EQU     0X20
   202       0021 C        RX_IDH                          EQU     0X21    ; master ID
   203       0022 C        RX_IDL                          EQU     0X22
   204       0023 C        CHN_FLAG                        EQU     0X23    ; Channel flag, gamepad status
   205       0024 C        GamepadsSum                     EQU     0X24    ; gamepads sum
   206       0025 C        CH_NO                           EQU     0X25    ; Current frequency table index
   207       0026 C        TX_ID                           EQU     0X26    ;
   208            C        
   209       0027 C        TX1_ID                          EQU     0X27     ;
   210       0028 C        TX2_ID                          EQU     0X28     ;
   211       0029 C        TX3_ID                          EQU     0X29     ;
   212       002A C        TX4_ID                          EQU     0X2A     ;
   213       002B C        TX5_ID                          EQU     0X2B     ;
   214       002C C        TX6_ID                          EQU     0X2C     ;
   215            C        
   216            C        
   217       002F C        FccFreqIndex                    EQU     0X2F
   218            C        ;----------------------------------------------------------------------
   219       0030 C        ADDR                            EQU     0X30 ;OUTPUT DATA ADDRESS
   220       0031 C        VALUE                           EQU     0X31 ;OUTPUT DATA HIGH
   221       0032 C        MOTOR_ID                        EQU     0X32
   222       0033 C        CHN_FLAG_TEMP                   EQU     0X33
   223       0034 C        RF_RSSI                         EQU     0X34
   224            C        
   225            C        ;       Click                     Dblclick                    Lasting_Press
   226            C        ;________    _______...__________    ______    _______...___________         ____________
   227            C        ;        |__|                    |__|      |__|                     |_______|
   228            C        ;___________                         _________                               ____________
   229            C        ;           |_______..._____________|         |________...__________________|
   230            C        
   231       0035 C        KeystokeFlag_Befor              EQU     0X35
   232       0036 C        KeySystemTimeCNT                EQU     0X36 ;
   233       0037 C        KeystokeTimeCNT                 EQU     0X37
   234       0038 C        KEY_NUM                         EQU     0X38
   235       0039 C        RX_ComuLoseCNT                  EQU     0X39
   236       003A C        RX1_LossframeCNT                EQU     0X3A
   237       003B C        RX2_LossframeCNT                EQU     0X3B
   238       003C C        RX3_LossframeCNT                EQU     0X3C
   239       003D C        RX4_LossframeCNT                EQU     0X3D
   240       003E C        RX5_LossframeCNT                EQU     0X3E
   241       003F C        RX6_LossframeCNT                EQU     0X3F
   242            C        
   243            C        
   244            C        ;========================= BANK 2 ====================================
   245       0020 C        TX1_DATA1                       EQU     0X20
   246       0021 C        TX1_DATA2                       EQU     0X21
   247       0022 C        TX1_DATA3                       EQU     0X22
   248       0023 C        TX1_DATA4                       EQU     0X23
   249       0024 C        TX1_DATA5                       EQU     0X24
   250       0025 C        TX1_DATA6                       EQU     0X25
   251       0026 C        TX1_DATA7                       EQU     0X26
   252       0027 C        TX1_DATA8                       EQU     0X27
   253            C        
   254       0030 C        TX1_CMOS_xAxisH                 EQU     0X30
   255       0031 C        TX1_CMOS_xAxisL                 EQU     0X31
   256       0032 C        TX1_CMOS_yAxisH                 EQU     0X32
   257       0033 C        TX1_CMOS_yAxisL                 EQU     0X33
   258       0034 C        TX1_CMOS_yxsAxisH               EQU     0X34
   259            C        
   260       0035 C        TX1_GS_xAxisH                   EQU     0X35
   261       0036 C        TX1_GS_xAxisL                   EQU     0X36
   262       0037 C        TX1_GS_yAxisH                   EQU     0X37
   263       0038 C        TX1_GS_yAxisL                   EQU     0X38
   264       0039 C        TX1_GS_zAxisH                   EQU     0X39
   265       003A C        TX1_GS_zAxisL                   EQU     0X3A
   266       003B C        TX1_GS_xyzAxisH                 EQU     0X3B
   267            C        
   268       003C C        MOTOR1_VibrInten                EQU     0X3C
   269       003D C        MOTOR1_VibrDuraH                EQU     0X3D
   270       003E C        MOTOR1_VibrDuraL                EQU     0X3E
   271            C        
   272            C        ;========================= BANK 3 ====================================
   273       0020 C        TX2_DATA1                       EQU     0X20
   274       0021 C        TX2_DATA2                       EQU     0X21
   275       0022 C        TX2_DATA3                       EQU     0X22
   276       0023 C        TX2_DATA4                       EQU     0X23
   277       0024 C        TX2_DATA5                       EQU     0X24
   278       0025 C        TX2_DATA6                       EQU     0X25
   279       0026 C        TX2_DATA7                       EQU     0X26
   280       0027 C        TX2_DATA8                       EQU     0X27
   281            C        
   282       0030 C        TX2_CMOS_xAxisH                 EQU     0X30
   283       0031 C        TX2_CMOS_xAxisL                 EQU     0X31
   284       0032 C        TX2_CMOS_yAxisH                 EQU     0X32
   285       0033 C        TX2_CMOS_yAxisL                 EQU     0X33
   286       0034 C        TX2_CMOS_yxsAxisH               EQU     0X34
   287            C        
   288       0035 C        TX2_GS_xAxisH                   EQU     0X35
   289       0036 C        TX2_GS_xAxisL                   EQU     0X36
   290       0037 C        TX2_GS_yAxisH                   EQU     0X37
   291       0038 C        TX2_GS_yAxisL                   EQU     0X38
   292       0039 C        TX2_GS_zAxisH                   EQU     0X39
   293       003A C        TX2_GS_zAxisL                   EQU     0X3A
   294       003B C        TX2_GS_xyzAxisH                 EQU     0X3B
   295            C        
   296       003C C        MOTOR2_VibrInten                EQU     0X3C
   297       003D C        MOTOR2_VibrDuraH                EQU     0X3D
   298       003E C        MOTOR2_VibrDuraL                EQU     0X3E
   299            C        
   300            C        
   301            C        
   302            C        
   303            C        
    18                     include "EM198850_For_EM78M611.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;===================================================================
    11            C        
    12            C        EM198850_For_EM78M611.ASM    EQU    EM198850_For_EM78M611.ASM
    13            C        
    14            C        ifndef EM198850_For_EM78M611.H
    15            C        include	"EM198850_For_EM78M611.H"
     1            C        /*****************************************************************
     2            C        * Filename     :  EM78M611dev.ASM
     3            C        * Author       :  yu.wei
     4            C        * Company      :  ELAN
     5            C        * VERSION      :  1.0
     6            C        * CRYSTAL	   :  6MHZ
     7            C        * Creat date   :  2009/9/11
     8            C        * tool ver.    :  WicePlus 2.7
     9            C        * Description  :  modify for code conformity
    10            C        *****************************************************************/
    11            C        
    12            C        ;--------------------------------------------------------------------------
    13       0052 C        FIFO_PTR                EQU     82          ;FIFO POINTER CONTROL=REG 82
    14       0080 C        CLR_W_PTR               EQU     0X80        ;CLR POINTER MARK VALUE
    15       0050 C        FIFO_REG                EQU     80          ;FIFO POINTER=REG 80
    16       0080 C        READ_MASK               EQU     0X80        ;READ REG,MSB SET TO 1
    17       0080 C        RX_MASK                 EQU     0X80        ;ENABLE RX
    18            C        
    19       0020 C        PKT_LEN                 EQU     0X20        ;DataByteLength = 32
    20       0000 C        TXADDRL                 EQU     0X00
    21       0011 C        TXADDRH                 EQU     0X11
    22       0020 C        RX_BUF                  EQU     0B00100000  ;0x20(bank 0)
    23       0020 C        TX_BUF                  EQU     0B00100000  ;0x20(bank 0)
    24       0020 C        NoiseStrobe             EQU     0X20        ;dirty:0x08-0x0A, neatness:0x28-0x2A
    25       004C C        ChannelSum              EQU     76
    26            C        
    27            C        
    28            C        
    29            C        
    30            C        ;==================================================================
    31            C        
    16            C        endif
    17            C        
    18            C        	ORG                 0X1400    ;PAGE 5
    19            C          if MassageDisplay == 1
    20            C        	MESSAGE "define 'EM198850_For_EM78M611.ASM' ROM address"
    21            C          endif
    22            C        ;**************************************************
    23            C        ;LOOKUP TABLE
    24            C        ;Famer Register initial value(Reg48~57)
    25            C        ;**************************************************
    26 01400      C        FRAME_TABLE:
    27 01400 03C2 C        	ADD                 PC,A
    28 01401 1C4E C        	RETL                @0X4E		;1		01---16M
    29 01402 1C02 C        	RETL                @0X02		;2		10---24M
    30            C        
    31 01403 1C4D C        	RETL                @0X4D		;3		RESET FIFO
    32 01404 1C01 C        	RETL                @0X01		;4
    33            C        
    34 01405 1C42 C        	RETL                @0X42		;5		24M/1MBPS
    35 01406 1C98 C        	RETL                @0X98		;6
    36            C        
    37 01407 1C43 C        	RETL                @0X43		;7
    38 01408 1CC8 C        	RETL                @0XC8 		;8		;8		;default:C4  Set sync word length，CRC count
    39            C        
    40 01409 1C44 C        	RETL                @0X44		;9		PKT_LEN
    41 0140A 1C20 C        	RETL                @PKT_LEN	;10		24 DATA
    42            C        
    43 0140B 1C45 C        	RETL                @0X45		;11		PKTCNT
    44 0140C 1C10 C        	RETL                @0X10		;12		1 packet
    45            C        
    46 0140D 1C46 C        	RETL                @0X46		;13		BIT3~5	TX AMPLIFIER DELAY 10+5X
    47 0140E 1C09 C        	RETL                @0X09		;14		BIT0~2	PLL DELAY 120+20X
    48            C        
    49 0140F 1C47 C        	RETL                @0X47		;15		BIT4~7  RETRY CNT
    50 01410 1C01 C        	RETL                @0X01		;16		BIT0~3	Slot TIME UNIT 10US
    51            C        
    52 01411 1C48 C        	RETL                @0X48		;17		Slot
    53 01412 1C01 C        	RETL                @0X01		;18
    54            C        
    55 01413 1C49 C        	RETL                @0X49		;19		ACKTOSLOT
    56 01414 1C14 C        	RETL                @0X14 		;20     default: 0X8A
    57            C        
    58 01415 1C4A C        	RETL                @0X4A		;21		RSSITH
    59 01416 1C27 C        	RETL                @0X27		;22
    60            C        
    61 01417 1C4B C        	RETL                @0X4B		;23		RF_RSSI
    62 01418 1C00 C        	RETL                @0X00		;24
    63            C        
    64 01419 1C4C C        	RETL                @0X4C		;25		TD_PLL	IN UNIT 10US
    65 0141A 1C06 C        	RETL                @0X06		;26
    66            C        
    67 0141B 1C50 C        	RETL                @0X50		;27		TXADDR
    68 0141C 1C00 C        	RETL                @TXADDRL	;28
    69            C        
    70 0141D 1C51 C        	RETL                @0X51		;29		TX ADDR
    71 0141E 1C11 C        	RETL                @TXADDRH	;30
    72            C        
    73 0141F 1C52 C        	RETL                @0X52		;31		RX	ADDR1
    74 01420 1C22 C        	RETL                @0X22		;32
    75            C        
    76 01421 1C53 C        	RETL                @0X53		;33		RX	ADDR2
    77 01422 1C33 C        	RETL                @0X33		;34
    78            C        
    79 01423 1C54 C        	RETL                @0X54		;35		RX	ADDR3
    80 01424 1C44 C        	RETL                @0X44		;36
    81            C        
    82 01425 1C55 C        	RETL                @0X55		;37		RX	ADDR4
    83 01426 1C55 C        	RETL                @0X55		;38
    84            C        
    85 01427 1C56 C        	RETL                @0X56		;39		RX	ADDR5
    86 01428 1C66 C        	RETL                @0X66		;40
    87            C        
    88 01429 1C57 C        	RETL                @0X57		;41		RX	ADDR6
    89 0142A 1C77 C        	RETL                @0X77		;42
    90            C        
    91 0142B 1C58 C        	RETL                @0X58		;43
    92 0142C 1C08 C        	RETL                @0X08		;44
    93            C        
    94            C        ;-----------------------------------------------------------
    95 0142D 1C00 C        	RETL                @0X00		;45
    96 0142E 1CE5 C        	RETL                @0XE5		;46
    97            C        
    98 0142F 1C01 C        	RETL                @0X01		;47
    99 01430 1C84 C        	RETL                @0X84		;48
   100            C        
   101 01431 1C02 C        	RETL                @0X02		;49
   102 01432 1C00 C        	RETL                @0X00		;50		CHANNEL
   103            C        
   104 01433 1C03 C        	RETL                @0X03		;51
   105 01434 1CC6 C        	RETL                @0XC6		;52
   106            C        
   107 01435 1C04 C        	RETL                @0X04		;53
   108 01436 1C00 C        	RETL                @0X00		;54
   109            C        
   110 01437 1C05 C        	RETL                @0X05		;55
   111 01438 1C40 C        	RETL                @0X40		;56
   112            C        
   113 01439 1C06 C        	RETL                @0X06		;57
   114 0143A 1C5D C        	RETL                @0X5D		;58
   115            C        
   116 0143B 1C07 C        	RETL                @0X07		;59
   117 0143C 1C18 C        	RETL                @0X18		;60
   118            C        
   119 0143D 1C08 C        	RETL                @0X08		;61
   120 0143E 1C40 C        	RETL                @0X40		;62
   121            C        
   122 0143F 1C09 C        	RETL                @0X09		;63
   123 01440 1C18 C        	RETL                @0X18		;64
   124            C        
   125 01441 1C0A C        	RETL                @0X0A		;65
   126 01442 1C47 C        	RETL                @0X47		;66
   127            C        
   128 01443 1C0B C        	RETL                @0X0B		;67
   129 01444 1C0B C        	RETL                @0X0B		;68
   130            C        
   131 01445 1C0C C        	RETL                @0X0C		;69
   132 01446 1CE0 C        	RETL                @0XE0		;70
   133            C        
   134 01447 1C0D C        	RETL                @0X0D		;71
   135 01448 1C4F C        	RETL                @0X4F		;72
   136            C        
   137 01449 1C0E C        	RETL                @0X0E		;73
   138 0144A 1C11 C        	RETL                @0X11		;74
   139            C        
   140 0144B 1C0F C        	RETL                @0X0F		;75
   141 0144C 1C1C C        	RETL                @0X1C		;76
   142            C        
   143 0144D 1C20 C        	RETL                @0X20		;77
   144 0144E 1CAD C        	RETL                @0XAD		;78
   145            C        
   146 0144F 1C21 C        	RETL                @0X21		;79
   147 01450 1C64 C        	RETL                @0X64		;80
   148            C        
   149 01451 1C22 C        	RETL                @0X22		;81
   150 01452 1C00 C        	RETL                @0X00		;82
   151            C        
   152 01453 1C23 C        	RETL                @0X23		;83
   153 01454 1CC3 C        	RETL                @0XC3		;84
   154            C        
   155 01455 1C24 C        	RETL                @0X24		;85
   156 01456 1CBD C        	RETL                @0XBD		;86
   157            C        
   158 01457 1C25 C        	RETL                @0X25		;87
   159 01458 1CA2 C        	RETL                @0XA2		;88
   160            C        
   161 01459 1C26 C        	RETL                @0X26		;89
   162 0145A 1C1A C        	RETL                @0X1A		;90
   163            C        
   164 0145B 1C27 C        	RETL                @0X27		;91
   165 0145C 1C09 C        	RETL                @0X09		;92
   166            C        
   167 0145D 1C28 C        	RETL                @0X28		;93
   168 0145E 1C00 C        	RETL                @0X00		;94
   169            C        
   170 0145F 1C29 C        	RETL                @0X29		;95
   171 01460 1CB8 C        	RETL                @0XB8		;96
   172            C        
   173 01461 1C2A C        	RETL                @0X2A		;97
   174 01462 1C71 C        	RETL                @0X71		;98
   175            C        
   176 01463 1C2B C        	RETL                @0X2B		;99
   177 01464 1C06 C        	RETL                @0X06		;100
   178            C        
   179 01465 1C2C C        	RETL                @0X2C		;101
   180 01466 1C80 C        	RETL                @0X80		;102
   181            C        
   182 01467 1C2D C        	RETL                @0X2D		;103
   183 01468 1C1A C        	RETL                @0X1A		;104
   184            C        
   185 01469 1C2E C        	RETL                @0X2E		;105
   186 0146A 1C09 C        	RETL                @0X09;03		;106
   187            C        
   188 0146B 1C2F C        	RETL                @0X2F		;107
   189 0146C 1C64 C        	RETL                @0X64		;108
   190            C        
   191 0146D 1C30 C        	RETL                @0X30		;109
   192 0146E 1CC0 C        	RETL                @0XC0		;110
   193            C        
   194 0146F 1C31 C        	RETL                @0X31		;111
   195 01470 1C00 C        	RETL                @0X00		;112
   196            C        
   197 01471 1C32 C        	RETL                @0X32		;113
   198 01472 1C40 C        	RETL                @0X40		;114
   199            C        
   200 01473 1C33 C        	RETL                @0X33		;115
   201 01474 1C3B C        	RETL                @0X3B		;116
   202            C        
   203 01475 1C00 C        	RETL                @0X00		;117
   204 01476 1CA7 C        	RETL                @0XA7		;118
   205            C        
   206 01477 1C32 C        	RETL                @0X32		;119
   207 01478 1C4A C        	RETL                @0X4A		;120
   208            C        
   209 01479 1C00 C        	RETL                @0X00		;121
   210 0147A 1CE5 C        	RETL                @0XE5		;122
   211            C        
   212 0147B 1C0E C        	RETL                @0X0E		;123
   213 0147C 1C91 C        	RETL                @0X91		;124
   214            C        
   215 0147D 1C40 C        	RETL                @0X40		;125
   216 0147E 1C51 C        	RETL                @0X51		;126
   217            C        
   218 0147F 1C41 C        	RETL                @0X41		;127
   219 01480 1CBF C        	RETL                @0XBF		;128
   220            C        
   221 01481 1C0C C        	RETL                @0X0C		;129
   222 01482 1CC0 C        	RETL                @0XC0		;130
   223            C        
   224 01483 1C02 C        	RETL                @0X02		;131
   225 01484 1C80 C        	RETL                @0X80		;132
   226            C        
   227 01485 1C04 C        	RETL                @0X04		;133
   228 01486 1C4A C        	RETL                @0X4A		;134
   229            C        
   230 01487 1C05 C        	RETL                @0X05		;135
   231 01488 1CDA C        	RETL                @0XDA		;136
   232            C        
   233 01489 1C06 C        	RETL                @0X06		;137
   234 0148A 1CFA C        	RETL                @0XFA		;138
   235            C        
   236 0148B 1CFF C        	RETL                @0XFF
   237            C        
   238            C        ;===========================================================
   239 0148C      C        RF_TABLE:			;LENGTH 30
   240 0148C 03C2 C        	ADD                 PC,A
   241 0148D 1C4E C        	RETL                @0X4E
   242 0148E 1C02 C        	RETL                @0X02
   243            C        
   244 0148F 1C43 C        	RETL                @0X43
   245 01490 1CC8 C        	RETL                @0XC8
   246            C        
   247 01491 1C44 C        	RETL                @0X44
   248 01492 1C20 C        	RETL                @PKT_LEN
   249            C        
   250 01493 1C45 C        	RETL                @0X45
   251 01494 1C10 C        	RETL                @0X10
   252            C        
   253 01495 1C48 C        	RETL                @0X48
   254 01496 1C01 C        	RETL                @0X01
   255            C        
   256 01497 1C4C C        	RETL                @0X4C
   257 01498 1C06 C         	RETL                @0X06
   258            C        
   259 01499 1C50 C        	RETL                @0X50
   260 0149A 1C00 C        	RETL                @TXADDRL
   261            C        
   262 0149B 1C51 C        	RETL                @0X51
   263 0149C 1C11 C        	RETL                @TXADDRH
   264            C        
   265 0149D 1C52 C        	RETL                @0X52
   266 0149E 1C22 C        	RETL                @0X22
   267            C        
   268 0149F 1C53 C        	RETL                @0X53
   269 014A0 1C33 C        	RETL                @0X33
   270            C        
   271 014A1 1C54 C        	RETL                @0X54
   272 014A2 1C44 C        	RETL                @0X44
   273            C        
   274 014A3 1C55 C        	RETL                @0X55
   275 014A4 1C55 C        	RETL                @0X55
   276            C        
   277 014A5 1C56 C        	RETL                @0X56
   278 014A6 1C66 C        	RETL                @0X66
   279            C        
   280 014A7 1C57 C        	RETL                @0X57
   281 014A8 1C77 C        	RETL                @0X77
   282            C        
   283 014A9 1C58 C        	RETL                @0X58
   284 014AA 1C08 C        	RETL                @0X08
   285            C        
   286 014AB 1CFF C        	RETL                @0XFF
   287            C        
   288            C        ;===========================================================
   289 014AC      C        CH_TABLE:
   290 014AC 03C2 C        	ADD                 PC,A
   291            C        	;1
   292 014AD 1C14 C        	RETL                @20        ;00,Freq:0x14
   293 014AE 1C26 C        	RETL                @38        ;01,Freq:0x26
   294 014AF 1C38 C        	RETL                @56        ;02,Freq:0x38
   295 014B0 1C4F C        	RETL                @79        ;03,Freq:0x4F
   296            C        
   297            C        	;2
   298 014B1 1C04 C        	RETL                @4         ;04,Freq:0x04
   299 014B2 1C17 C        	RETL                @23        ;05,Freq:0x17
   300 014B3 1C2A C        	RETL                @42        ;06,Freq:0x2A
   301 014B4 1C3D C        	RETL                @61        ;07,Freq:0x3D
   302            C        
   303            C        	;3
   304 014B5 1C07 C        	RETL                @7         ;08,Freq:0x07
   305 014B6 1C1B C        	RETL                @27        ;09,Freq:0x1B
   306 014B7 1C2F C        	RETL                @47        ;10,Freq:0x2F
   307 014B8 1C3E C        	RETL                @62        ;11,Freq:0x3E
   308            C        
   309            C        	;4
   310 014B9 1C0A C        	RETL                @10        ;12,Freq:0x02
   311 014BA 1C1F C        	RETL                @31        ;13,Freq:0x1F
   312 014BB 1C34 C        	RETL                @52        ;14,Freq:0x34
   313 014BC 1C3F C        	RETL                @63        ;15,Freq:0x3F
   314            C        
   315            C        	;5
   316 014BD 1C0D C        	RETL                @13        ;16,Freq:0x0D
   317 014BE 1C23 C        	RETL                @35        ;17,Freq:0x23
   318 014BF 1C39 C        	RETL                @57        ;18,Freq:0x39
   319 014C0 1C40 C        	RETL                @64        ;19,Freq:0x40
   320            C        
   321            C        	;6
   322 014C1 1C10 C        	RETL                @16        ;20,Freq:0x10
   323 014C2 1C27 C        	RETL                @39        ;21,Freq:0x27
   324 014C3 1C2B C        	RETL                @43        ;22,Freq:0x2B
   325 014C4 1C41 C        	RETL                @65        ;23,Freq:0x41
   326            C        
   327            C        	;7
   328 014C5 1C13 C        	RETL                @19        ;24,Freq:0x13
   329 014C6 1C18 C        	RETL                @24        ;25,Freq:0x18
   330 014C7 1C30 C        	RETL                @48        ;26,Freq:0x30
   331 014C8 1C42 C        	RETL                @66        ;27,Freq:0x42
   332            C        
   333            C        	;8
   334 014C9 1C16 C        	RETL                @22        ;28,Freq:0x16
   335 014CA 1C1C C        	RETL                @28        ;29,Freq:0x1C
   336 014CB 1C35 C        	RETL                @53        ;30,Freq:0x35
   337 014CC 1C43 C        	RETL                @67        ;31,Freq:0x43
   338            C        
   339            C        	;9
   340 014CD 1C06 C        	RETL                @6         ;32,Freq:0x06
   341 014CE 1C20 C        	RETL                @32        ;33,Freq:0x20
   342 014CF 1C3A C        	RETL                @58        ;34,Freq:0x3A
   343 014D0 1C44 C        	RETL                @68        ;35,Freq:0x44
   344            C        
   345            C        	;10
   346 014D1 1C09 C        	RETL                @9         ;36,Freq:0x09
   347 014D2 1C24 C        	RETL                @36        ;37,Freq:0x24
   348 014D3 1C2C C        	RETL                @44        ;38,Freq:0x2C
   349 014D4 1C45 C        	RETL                @69        ;39,Freq:0x45
   350            C        
   351            C        	;11
   352 014D5 1C0C C        	RETL                @12        ;40,Freq:0x0C
   353 014D6 1C28 C        	RETL                @40        ;41,Freq:0x28
   354 014D7 1C31 C        	RETL                @49        ;42,Freq:0x31
   355 014D8 1C46 C        	RETL                @70        ;43,Freq:0x46
   356            C        
   357            C        	;12
   358 014D9 1C0F C        	RETL                @15        ;44,Freq:0x0F
   359 014DA 1C19 C        	RETL                @25        ;45,Freq:0x19
   360 014DB 1C36 C        	RETL                @54        ;46,Freq:0x36
   361 014DC 1C47 C        	RETL                @71        ;47,Freq:0x36
   362            C        
   363            C        	;13
   364 014DD 1C12 C        	RETL                @18        ;48,Freq:0x12
   365 014DE 1C1D C        	RETL                @29        ;49,Freq:0x1D
   366 014DF 1C3B C        	RETL                @59        ;50,Freq:0x3B
   367 014E0 1C48 C        	RETL                @72        ;51,Freq:0x48
   368            C        
   369            C        	;14
   370 014E1 1C15 C        	RETL                @21        ;52,Freq:0x15
   371 014E2 1C21 C        	RETL                @33        ;53,Freq:0x21
   372 014E3 1C2D C        	RETL                @45        ;54,Freq:0x2D
   373 014E4 1C49 C        	RETL                @73        ;55,Freq:0x49
   374            C        
   375            C        	;15
   376 014E5 1C05 C        	RETL                @5         ;56,Freq:0x05
   377 014E6 1C25 C        	RETL                @37        ;57,Freq:0x25
   378 014E7 1C32 C        	RETL                @50        ;58,Freq:0x32
   379 014E8 1C4A C        	RETL                @74        ;59,Freq:0x4A
   380            C        
   381            C        	;16
   382 014E9 1C08 C        	RETL                @8         ;60,Freq:0x08
   383 014EA 1C29 C        	RETL                @41        ;61,Freq:0x29
   384 014EB 1C37 C        	RETL                @55        ;62,Freq:0x37
   385 014EC 1C4B C        	RETL                @75        ;63,Freq:0x4B
   386            C        
   387            C        	;17
   388 014ED 1C0B C        	RETL                @11        ;64,Freq:0x03
   389 014EE 1C1A C        	RETL                @26        ;65,Freq:0x1A
   390 014EF 1C3C C        	RETL                @60        ;66,Freq:0x3C
   391 014F0 1C4C C        	RETL                @76        ;67,Freq:0x4C
   392            C        
   393            C        	;18
   394 014F1 1C0E C        	RETL                @14        ;68,Freq:0x0E
   395 014F2 1C1E C        	RETL                @30        ;69,Freq:0x1E
   396 014F3 1C2E C        	RETL                @46        ;70,Freq:0x2E
   397 014F4 1C4D C        	RETL                @77        ;71,Freq:0x4D
   398            C        
   399            C        	;19
   400 014F5 1C11 C        	RETL                @17        ;72,Freq:0x11
   401 014F6 1C22 C        	RETL                @34        ;73,Freq:0x22
   402 014F7 1C33 C        	RETL                @51        ;74,Freq:0x33
   403 014F8 1C4E C        	RETL                @78        ;75,Freq:0x4E
   404            C        
   405            C        
   406            C        ;===========================================================
   407            C        ; RF Initialize SubRoutine
   408            C        ;===========================================================
   409 014F9      C        EM198850_RESET:
   410 014F9 1342 C        	CALL                PAGE5BANK1
   411 014FA 0846 C        	BC                  RESET_N/8,RESET_N%8
   412 014FB 181E C        	MOV                 A,@30                         ; wating 3ms
   413 014FC 12FC C        	CALL                DELAY_X100US
   414 014FD 0A46 C        	BS                  RESET_N/8,RESET_N%8          ; RESET=1
   415 014FE 1864 C        	MOV                 A,@100                          ; wating 10ms
   416 014FF 12FC C        	CALL                DELAY_X100US
   417            C        
   418 01500 095D C        	BC                  RFTestfailFlag/8,RFTestfailFlag%8
   419 01501 110E C        	CALL                INIT_FRAMEREG                  ; load	FRAMER TABLE send
   420 01502 1805 C        	MOV                 A,@5
   421 01503 12FC C        	CALL                DELAY_X100US
   422 01504 0000 C        	NOP
   423 01505 1121 C        	CALL                INIT_RSSI_CALIBRATION
   424 01506 0000 C        	NOP
   425 01507 1304 C        	CALL                TEST_INITIAL_RF
   426 01508 0000 C        	NOP
   427 01509 0D5D C        	JBC                 RFTestfailFlag/8,RFTestfailFlag%8
   428 0150A 14F9 C        	JMP                 EM198850_RESET
   429            C        
   430 0150B 1276 C        	CALL                Enter_StandbyII_Mode
   431 0150C 0B9D C        	BS                  RFInitialOKflag/8,RFInitialOKflag%8
   432            C        
   433 0150D 0012 C        	RET
   434            C        
   435            C        ;===============================================
   436 0150E      C        INIT_FRAMEREG:
   437 0150E 1342 C        	CALL                PAGE5BANK1
   438 0150F 00D8 C        	CLR                 TABLE_INDEX
   439 01510      C          Set_FrameReg:
   440 01510 0418 C        	MOV                 A,TABLE_INDEX
   441 01511 1000 C        	CALL                FRAME_TABLE
   442 01512 0070 C        	MOV                 ADDR,A
   443 01513 1BFF C        	XOR                 A,@0XFF
   444 01514 0C83 C        	JBC                 STATUS,Z
   445 01515 151F C        	JMP                 Set_Framereg_End
   446 01516 0558 C        	INC                 TABLE_INDEX
   447 01517 0418 C        	MOV                 A,TABLE_INDEX
   448 01518 1000 C        	CALL                FRAME_TABLE
   449 01519 0000 C        	NOP
   450 0151A 0071 C        	MOV                 VALUE,A
   451 0151B 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   452 0151C 0000 C        	NOP
   453 0151D 0558 C        	INC                 TABLE_INDEX
   454 0151E 1510 C        	JMP                 Set_FrameReg
   455 0151F      C          Set_Framereg_End:
   456 0151F 0000 C        	NOP
   457 01520 0012 C        	RET
   458            C        
   459            C        ;=================================================
   460 01521      C        INIT_RSSI_CALIBRATION:
   461 01521 1342 C        	CALL                PAGE5BANK1
   462 01522 1805 C        	MOV                 A,@0X05
   463 01523 005A C        	MOV                 DataByteLength,A
   464 01524 00F4 C        	CLR                 RF_RSSI
   465 01525      C          Repeat_Read_RSSI:
   466 01525 184B C        	MOV                 A,@0X4B
   467 01526 0070 C        	MOV                 ADDR,A
   468 01527 1156 C        	CALL                READ_SPI_REG
   469 01528 0000 C        	NOP
   470 01529 0434 C        	MOV                 A,RF_RSSI
   471 0152A 0131 C        	SUB                 A,VALUE
   472 0152B 0E03 C        	JBS                 STATUS,C
   473 0152C 152F C        	JMP                 $+3
   474 0152D 0431 C        	MOV                 A,VALUE
   475 0152E 0074 C        	MOV                 RF_RSSI,A
   476 0152F 05DA C        	DJZ                 DataByteLength
   477 01530 1525 C        	JMP                 Repeat_Read_RSSI
   478            C        
   479 01531 1804 C        	MOV                 A,@0X04
   480 01532 0174 C        	SUB                 RF_RSSI,A
   481 01533 0434 C        	MOV                 A,RF_RSSI
   482 01534 0071 C        	MOV                 VALUE,A
   483 01535 184A C        	MOV                 A,@0X4A
   484 01536 0070 C        	MOV                 ADDR,A
   485 01537 114C C        	CALL                WRITE_SPI_REG
   486 01538 0000 C        	NOP
   487 01539 1805 C        	MOV                 A,@0X05
   488 0153A 0070 C        	MOV                 ADDR,A
   489 0153B 1840 C        	MOV                 A,@0X40
   490 0153C 0071 C        	MOV                 VALUE,A
   491 0153D 114C C        	CALL                WRITE_SPI_REG
   492 0153E 0000 C        	NOP
   493 0153F 1802 C        	MOV                 A,@0X02
   494 01540 0070 C        	MOV                 ADDR,A
   495 01541 1800 C        	MOV                 A,@0X00
   496 01542 0071 C        	MOV                 VALUE,A
   497 01543 114C C        	CALL                WRITE_SPI_REG
   498 01544 0000 C        	NOP
   499 01545 180C C        	MOV                 A,@0X0C
   500 01546 0070 C        	MOV                 ADDR,A
   501 01547 18E0 C        	MOV                 A,@0XE0
   502 01548 0071 C        	MOV                 VALUE,A
   503 01549 114C C        	CALL                WRITE_SPI_REG
   504 0154A 0000 C        	NOP
   505 0154B 0012 C        	RET
   506            C        
   507            C        ;===========================================================
   508            C        ; RF Initialize End
   509            C        ;===========================================================
   510            C        ;===============================================
   511            C        ; Function: Write SPI Register
   512            C        ; Input:    ADDR,VALUE
   513            C        ; Output:   None
   514            C        ;===============================================
   515 0154C      C        WRITE_SPI_REG:
   516 0154C 0906 C        	BC                  SPI_SS/8,SPI_SS%8				;	/SS	=0
   517 0154D 1342 C        	CALL                PAGE5BANK1
   518 0154E 0430 C        	MOV                 A,ADDR
   519 0154F 1162 C        	CALL                SIM_SPI_WRITE
   520 01550 0431 C        	MOV                 A,VALUE
   521 01551 1162 C        	CALL                SIM_SPI_WRITE
   522 01552 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   523 01553 0000 C        	NOP
   524 01554 0B06 C        	BS                  SPI_SS/8,SPI_SS%8			;	/SS	=1
   525 01555 0012 C        	RET
   526            C        
   527            C        ;===============================================
   528            C        ; Function: Read SPI Register
   529            C        ; Input:   SPIWB
   530            C        ; Output:  SPIRB
   531            C        ;===============================================
   532 01556      C        READ_SPI_REG:
   533 01556 1342 C        	CALL                PAGE5BANK1
   534 01557 0906 C        	BC                  SPI_SS/8,SPI_SS%8			;	/SS	=0
   535 01558 0430 C        	MOV                 A,ADDR
   536 01559 1980 C        	OR                  A,@0X80
   537 0155A 1162 C        	CALL                SIM_SPI_WRITE
   538 0155B 0000 C        	NOP
   539 0155C 1174 C        	CALL                SIM_SPI_READ
   540 0155D 0071 C        	MOV                 VALUE,A
   541 0155E 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   542 0155F 0000 C        	NOP
   543 01560 0B06 C        	BS                  SPI_SS/8,SPI_SS%8			;	/SS	=0
   544 01561 0012 C        	RET
   545            C        
   546            C        ;===============================================
   547            C        ; Function: Write SPI communication subroutine rising edge
   548            C        ; Input:    ACC
   549            C        ; Output:   None
   550            C        ;===============================================
   551 01562      C        SIM_SPI_WRITE:
   552 01562 0050 C        	MOV                 SPIWB,A
   553 01563 1808 C        	MOV                 A,@8
   554 01564 0059 C        	MOV                 DataShiftCounter,A
   555 01565      C          WRITE_SPI_1:
   556 01565 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   557 01566 06D0 C        	RLC                 SPIWB
   558 01567 0C03 C        	JBC                 STATUS,C
   559 01568 156B C        	JMP                 SET_SPI_MOSI
   560 01569 08C6 C        	BC                  SPI_MOSI/8,SPI_MOSI%8
   561 0156A 156C C        	JMP                 WRITE_SPI_COUNT_DEC
   562 0156B      C          SET_SPI_MOSI:
   563 0156B 0AC6 C        	BS                  SPI_MOSI/8,SPI_MOSI%8
   564 0156C      C          WRITE_SPI_COUNT_DEC:
   565 0156C 0A86 C        	BS                  SPI_CLK/8,SPI_CLK%8
   566 0156D 0000 C        	NOP
   567 0156E 05D9 C        	DJZ                 DataShiftCounter
   568 0156F 1565 C        	JMP                 WRITE_SPI_1
   569 01570 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   570 01571 0000 C        	NOP
   571 01572 08C6 C        	BC                  SPI_MOSI/8,SPI_MOSI%8
   572 01573 0012 C        	RET
   573            C        
   574            C        ;===============================================
   575            C        ; Function: Read SPI communication subroutine rising edge
   576            C        ; Input:    None
   577            C        ; Output:   SPI Data
   578            C        ;===============================================
   579 01574      C        SIM_SPI_READ:
   580 01574 00D0 C        	CLR                 SPIRB
   581 01575 1808 C        	MOV                 A,@8
   582 01576 0059 C        	MOV                 DataShiftCounter,A
   583 01577      C          READ_SPI_1:
   584 01577 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   585 01578 0000 C        	NOP
   586 01579 0000 C        	NOP
   587 0157A 0000 C        	NOP
   588 0157B 0A86 C        	BS                  SPI_CLK/8,SPI_CLK%8
   589 0157C 0E06 C        	JBS                 SPI_MISO/8,SPI_MISO%8
   590 0157D 1580 C        	JMP                 CLR_STATUS_C
   591 0157E 0A03 C        	BS                  STATUS,C
   592 0157F 1581 C        	JMP                 READ_SPI_MISO
   593 01580      C          CLR_STATUS_C:
   594 01580 0803 C        	BC                  STATUS,C
   595 01581      C          READ_SPI_MISO:
   596 01581 06D0 C        	RLC                 SPIRB
   597 01582 05D9 C        	DJZ                 DataShiftCounter
   598 01583 1577 C        	JMP                 READ_SPI_1
   599 01584 0886 C        	BC                  SPI_CLK/8,SPI_CLK%8
   600 01585 0410 C        	MOV                 A,SPIRB
   601 01586 0012 C        	RET
   602            C        
   603            C        
   604            C        ;***********************************************************
   605            C        ; Function: Read FIFO RAM
   606            C        ; Input:    None
   607            C        ; Output:   RX_BUF	,Receive_Error
   608            C        ;***********************************************************
   609 01587      C        READ_FIFO_RAM:
   610 01587 1820 C        	MOV                 A,@RX_BUF					;READ DATA START Address
   611 01588 0044 C        	MOV                 RSR,A
   612 01589 0000 C        	NOP
   613 0158A 0000 C        	NOP
   614 0158B 0906 C        	BC                  SPI_SS/8,SPI_SS%8				;/SS=0
   615 0158C 18FF C        	MOV                 A,@0XFF						;0X7F||0X80 FIFO ADDRESS
   616 0158D 1162 C        	CALL                SIM_SPI_WRITE
   617 0158E 0000 C        	NOP
   618 0158F 0000 C        	NOP
   619 01590 1820 C        	MOV                 A,@PKT_LEN
   620 01591 005A C        	MOV                 DataByteLength,A
   621 01592      C          Read_FIFO_Loop:
   622 01592 1174 C        	CALL                SIM_SPI_READ	 					;Packet & Device	ID
   623 01593 0040 C        	MOV                 R0, A
   624 01594 0544 C        	INC                 RSR
   625 01595 05DA C        	DJZ                 DataByteLength
   626 01596 1592 C        	JMP                 Read_FIFO_Loop
   627 01597 0000 C        	NOP
   628 01598 0B06 C        	BS                  SPI_SS/8,SPI_SS%8				;/SS=1
   629 01599 0012 C        	RET
   630            C        
   631            C        
   632            C        ;***********************************************************
   633            C        ; Function: Write FIFO RAM
   634            C        ; Input:    None
   635            C        ; Output:   RX_Buf	,Receive_Error%8
   636            C        ;***********************************************************
   637 0159A      C        WRITE_FIFO_RAM:
   638 0159A 0906 C        	BC                  SPI_SS/8,SPI_SS%8    ;/SS=1
   639 0159B 187F C        	MOV                 A,@0X7F         ;reg0X7F
   640 0159C 1162 C        	CALL                SIM_SPI_WRITE   ;use I/O as	SPI	pro
   641 0159D 0000 C        	NOP
   642 0159E 1820 C        	MOV                 A,@PKT_LEN
   643 0159F 005A C        	MOV                 DataByteLength,A
   644 015A0 1820 C        	MOV                 A,@TX_BUF       ;Write DATA START Address
   645 015A1 0044 C        	MOV                 RSR,A
   646 015A2      C         Write_FIFO_Loop:
   647 015A2 0400 C        	MOV                 A,R0
   648 015A3 1162 C        	CALL                SIM_SPI_WRITE   ;use I/O as	SPI	pro
   649 015A4 0000 C        	NOP
   650 015A5 0544 C        	INC                 RSR
   651 015A6 05DA C        	DJZ                 DataByteLength
   652 015A7 15A2 C        	JMP                 Write_FIFO_Loop
   653 015A8 0B06 C        	BS                  SPI_SS/8,SPI_SS%8    ;/SS=1
   654 015A9 0F86 C        	JBS                 PKT_FLAG/8,PKT_FLAG%8
   655 015AA 15A9 C        	JMP                 $-1
   656 015AB 0012 C        	RET
   657            C        
   658            C        
   659            C        ;===============================================
   660            C        ; Function: Reset RF FIFO
   661            C        ; Input:    None
   662            C        ; Output:   None
   663            C        ;===============================================
   664 015AC      C        RESET_RF_FIFO:
   665 015AC 1342 C        	CALL                PAGE5BANK1
   666 015AD 184D C        	MOV                 A,@0X4D
   667 015AE 0070 C        	MOV                 ADDR,A					;ADDR=0X4D
   668 015AF 1801 C        	MOV                 A,@0X01
   669 015B0 0071 C        	MOV                 VALUE,A
   670 015B1 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   671            C        	;MOV                 A,@12
   672            C        	;CALL                DELAY_X10US
   673            C          if MassageDisplay == 1
   674            C        	MESSAGE "Make sure that anything take-over or send out in 120us "
   675            C          endif
   676 015B2 0000 C        	NOP
   677 015B3 0012 C        	RET
   678            C        
   679            C        
   680            C        ;***********************************************************
   681            C        ; Function: Enter TX Buffered ACK
   682            C        ; Input:    None
   683            C        ; Output:   None
   684            C        ;***********************************************************
   685 015B4      C        ENTER_TX_BUFFER_ACK:
   686 015B4 1342 C        	CALL                PAGE5BANK1
   687 015B5 1800 C        	MOV                 A,@0X00
   688 015B6 0070 C        	MOV                 ADDR,A
   689 015B7 18E5 C        	MOV                 A,@0XE5
   690 015B8 0071 C        	MOV                 VALUE,A
   691 015B9 114C C        	CALL                WRITE_SPI_REG
   692 015BA 1801 C        	MOV                 A,@0X01
   693 015BB 0070 C        	MOV                 ADDR,A
   694 015BC 1884 C        	MOV                 A,@0X84
   695 015BD 0071 C        	MOV                 VALUE,A
   696 015BE 114C C        	CALL                WRITE_SPI_REG
   697 015BF 1841 C        	MOV                 A,@0X41
   698 015C0 0070 C        	MOV                 ADDR,A
   699 015C1 18BF C        	MOV                 A,@0XBF
   700 015C2 0071 C        	MOV                 VALUE,A
   701 015C3 114C C        	CALL                WRITE_SPI_REG
   702 015C4 1840 C        	MOV                 A,@0X40
   703 015C5 0070 C        	MOV                 ADDR,A
   704 015C6 1856 C        	MOV                 A,@0X56
   705            C        	if                  USED_PID_FUNCTION
   706            C        		OR              A,@0X80
   707            C        	endif
   708 015C7 0071 C        	MOV                 VALUE,A
   709 015C8 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   710 015C9 0012 C        	RET
   711            C        
   712            C        
   713            C        ;***********************************************************
   714            C        ; Function: Enter TX Buffered NACK
   715            C        ; Input:    None
   716            C        ; Output:   None
   717            C        ;***********************************************************
   718 015CA      C        ENTER_TX_BUFFER_NACK:
   719 015CA 1342 C        	CALL                PAGE5BANK1
   720 015CB 1800 C        	MOV                 A,@0X00
   721 015CC 0070 C        	MOV                 ADDR,A
   722 015CD 18E5 C        	MOV                 A,@0XE5
   723 015CE 0071 C        	MOV                 VALUE,A
   724 015CF 114C C        	CALL                WRITE_SPI_REG
   725 015D0 1801 C        	MOV                 A,@0X01
   726 015D1 0070 C        	MOV                 ADDR,A
   727 015D2 1884 C        	MOV                 A,@0X84
   728 015D3 0071 C        	MOV                 VALUE,A
   729 015D4 114C C        	CALL                WRITE_SPI_REG
   730 015D5 1841 C        	MOV                 A,@0X41
   731 015D6 0070 C        	MOV                 ADDR,A
   732 015D7 18BF C        	MOV                 A,@0XBF
   733 015D8 0071 C        	MOV                 VALUE,A
   734 015D9 114C C        	CALL                WRITE_SPI_REG
   735 015DA 1840 C        	MOV                 A,@0X40
   736 015DB 0070 C        	MOV                 ADDR,A
   737 015DC 1852 C        	MOV                 A,@0X52
   738            C        	if                  USED_PID_FUNCTION
   739            C        		OR              A,@0X80
   740            C        	endif
   741 015DD 0071 C        	MOV                 VALUE,A
   742 015DE 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   743 015DF 0012 C        	RET
   744            C        
   745            C        
   746            C        ;***********************************************************
   747            C        ; Function: Enter TX Direct ACK
   748            C        ; Input:    None
   749            C        ; Output:   None
   750            C        ;***********************************************************
   751 015E0      C        Enter_TX_Direct_ACK:
   752 015E0 1342 C        	CALL                PAGE5BANK1
   753 015E1 1800 C        	MOV                 A,@0X00
   754 015E2 0070 C        	MOV                 ADDR,A
   755 015E3 1885 C        	MOV                 A,@0X85
   756 015E4 0071 C        	MOV                 VALUE,A
   757 015E5 114C C        	CALL                WRITE_SPI_REG
   758 015E6 1801 C        	MOV                 A,@0X01
   759 015E7 0070 C        	MOV                 ADDR,A
   760 015E8 1884 C        	MOV                 A,@0X84
   761 015E9 0071 C        	MOV                 VALUE,A
   762 015EA 114C C        	CALL                WRITE_SPI_REG
   763 015EB 1841 C        	MOV                 A,@0X41
   764 015EC 0070 C        	MOV                 ADDR,A
   765 015ED 18BF C        	MOV                 A,@0XBF
   766 015EE 0071 C        	MOV                 VALUE,A
   767 015EF 114C C        	CALL                WRITE_SPI_REG
   768 015F0 1840 C        	MOV                 A,@0X40
   769 015F1 0070 C        	MOV                 ADDR,A
   770 015F2 1856 C        	MOV                 A,@0X56
   771            C        	if                  USED_PID_FUNCTION
   772            C        		OR              A,@0X80
   773            C        	endif
   774 015F3 0071 C        	MOV                 VALUE,A
   775 015F4 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   776 015F5 0012 C        	RET
   777            C        
   778            C        
   779            C        ;***********************************************************
   780            C        ; Function: Enter TX Direct NACK
   781            C        ; Input:    None
   782            C        ; Output:   None
   783            C        ;***********************************************************
   784 015F6      C        Enter_TX_Direct_NACK:
   785 015F6 1342 C        	CALL                PAGE5BANK1
   786 015F7 1800 C        	MOV                 A,@0X00
   787 015F8 0070 C        	MOV                 ADDR,A
   788 015F9 1885 C        	MOV                 A,@0X85
   789 015FA 0071 C        	MOV                 VALUE,A
   790 015FB 114C C        	CALL                WRITE_SPI_REG
   791 015FC 1801 C        	MOV                 A,@0X01
   792 015FD 0070 C        	MOV                 ADDR,A
   793 015FE 1884 C        	MOV                 A,@0X84
   794 015FF 0071 C        	MOV                 VALUE,A
   795 01600 114C C        	CALL                WRITE_SPI_REG
   796 01601 1841 C        	MOV                 A,@0X41
   797 01602 0070 C        	MOV                 ADDR,A
   798 01603 18BF C        	MOV                 A,@0XBF
   799 01604 0071 C        	MOV                 VALUE,A
   800 01605 114C C        	CALL                WRITE_SPI_REG
   801 01606 1840 C        	MOV                 A,@0X40
   802 01607 0070 C        	MOV                 ADDR,A
   803 01608 1852 C        	MOV                 A,@0X52
   804            C        	if                  USED_PID_FUNCTION
   805            C        		OR              A,@0X80
   806            C        	endif
   807 01609 0071 C        	MOV                 VALUE,A
   808 0160A 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   809 0160B 0012 C        	RET
   810            C        
   811            C        
   812            C        ;***********************************************************
   813            C        ; Function: Enter RX Buffered ACK
   814            C        ; Input:    None
   815            C        ; Output:   None
   816            C        ;***********************************************************
   817 0160C      C        Enter_RX_Buffer_ACK:
   818 0160C 1342 C        	CALL                PAGE5BANK1
   819 0160D 1800 C        	MOV                 A,@0X00
   820 0160E 0070 C        	MOV                 ADDR,A
   821 0160F 18E5 C        	MOV                 A,@0XE5
   822 01610 0071 C        	MOV                 VALUE,A
   823 01611 114C C        	CALL                WRITE_SPI_REG
   824 01612 1801 C        	MOV                 A,@0X01
   825 01613 0070 C        	MOV                 ADDR,A
   826 01614 1884 C        	MOV                 A,@0X84
   827 01615 0071 C        	MOV                 VALUE,A
   828 01616 114C C        	CALL                WRITE_SPI_REG
   829 01617 1841 C        	MOV                 A,@0X41
   830 01618 0070 C        	MOV                 ADDR,A
   831 01619 18BF C        	MOV                 A,@0XBF
   832 0161A 0071 C        	MOV                 VALUE,A
   833 0161B 114C C        	CALL                WRITE_SPI_REG
   834 0161C 1840 C        	MOV                 A,@0X40
   835 0161D 0070 C        	MOV                 ADDR,A
   836 0161E 1859 C        	MOV                 A,@0X59
   837            C        	if                  USED_PID_FUNCTION
   838            C        		OR              A,@0X80
   839            C        	endif
   840 0161F 0071 C        	MOV                 VALUE,A
   841 01620 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   842 01621 0000 C        	NOP
   843 01622 0012 C        	RET
   844            C        
   845            C        
   846            C        ;**********************************************************
   847            C        ; Function: Enter RX Buffered NACK
   848            C        ; Input:    None
   849            C        ; Output:   None
   850            C        ;***********************************************************
   851 01623      C        Enter_RX_Buffer_NACK:
   852 01623 1342 C        	CALL                PAGE5BANK1
   853 01624 1800 C        	MOV                 A,@0X00
   854 01625 0070 C        	MOV                 ADDR,A
   855 01626 18E5 C        	MOV                 A,@0XE5
   856 01627 0071 C        	MOV                 VALUE,A
   857 01628 114C C        	CALL                WRITE_SPI_REG
   858 01629 1801 C        	MOV                 A,@0X01
   859 0162A 0070 C        	MOV                 ADDR,A
   860 0162B 1884 C        	MOV                 A,@0X84
   861 0162C 0071 C        	MOV                 VALUE,A
   862 0162D 114C C        	CALL                WRITE_SPI_REG
   863 0162E 1841 C        	MOV                 A,@0X41
   864 0162F 0070 C        	MOV                 ADDR,A
   865 01630 18BF C        	MOV                 A,@0XBF
   866 01631 0071 C        	MOV                 VALUE,A
   867 01632 114C C        	CALL                WRITE_SPI_REG
   868 01633 1840 C        	MOV                 A,@0X40
   869 01634 0070 C        	MOV                 ADDR,A
   870 01635 1851 C        	MOV                 A,@0X51
   871            C        	if                  USED_PID_FUNCTION
   872            C        		OR              A,@0X80
   873            C        	endif
   874 01636 0071 C        	MOV                 VALUE,A
   875 01637 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   876 01638 0012 C        	RET
   877            C        
   878            C        
   879            C        ;***********************************************************
   880            C        ; Function: Enter RX Direct ACK
   881            C        ; Input:    None
   882            C        ; Output:   None
   883            C        ;***********************************************************
   884 01639      C        Enter_RX_Direct_ACK:
   885 01639 1342 C        	CALL                PAGE5BANK1
   886 0163A 1800 C        	MOV                 A,@0X00
   887 0163B 0070 C        	MOV                 ADDR,A
   888 0163C 1885 C        	MOV                 A,@0X85
   889 0163D 0071 C        	MOV                 VALUE,A
   890 0163E 114C C        	CALL                WRITE_SPI_REG
   891 0163F 1801 C        	MOV                 A,@0X01
   892 01640 0070 C        	MOV                 ADDR,A
   893 01641 1884 C        	MOV                 A,@0X84
   894 01642 0071 C        	MOV                 VALUE,A
   895 01643 114C C        	CALL                WRITE_SPI_REG
   896 01644 1841 C        	MOV                 A,@0X41
   897 01645 0070 C        	MOV                 ADDR,A
   898 01646 18BF C        	MOV                 A,@0XBF
   899 01647 0071 C        	MOV                 VALUE,A
   900 01648 114C C        	CALL                WRITE_SPI_REG
   901 01649 1840 C        	MOV                 A,@0X40
   902 0164A 0070 C        	MOV                 ADDR,A
   903 0164B 1859 C        	MOV                 A,@0X59
   904            C        	if                  USED_PID_FUNCTION
   905            C        		OR              A,@0X80
   906            C        	endif
   907 0164C 0071 C        	MOV                 VALUE,A
   908 0164D 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   909 0164E 0012 C        	RET
   910            C        
   911            C        
   912            C        ;**********************************************************
   913            C        ; Function: Enter RX Direct NACK
   914            C        ; Input:    None
   915            C        ; Output:   None
   916            C        ;***********************************************************
   917 0164F      C        Enter_RX_Direct_NACK:
   918 0164F 1342 C        	CALL                PAGE5BANK1
   919 01650 1800 C        	MOV                 A,@0X00
   920 01651 0070 C        	MOV                 ADDR,A
   921 01652 1885 C        	MOV                 A,@0X85
   922 01653 0071 C        	MOV                 VALUE,A
   923 01654 114C C        	CALL                WRITE_SPI_REG
   924 01655 1801 C        	MOV                 A,@0X01
   925 01656 0070 C        	MOV                 ADDR,A
   926 01657 1884 C        	MOV                 A,@0X84
   927 01658 0071 C        	MOV                 VALUE,A
   928 01659 114C C        	CALL                WRITE_SPI_REG
   929 0165A 1841 C        	MOV                 A,@0X41
   930 0165B 0070 C        	MOV                 ADDR,A
   931 0165C 18BF C        	MOV                 A,@0XBF
   932 0165D 0071 C        	MOV                 VALUE,A
   933 0165E 114C C        	CALL                WRITE_SPI_REG
   934 0165F 1840 C        	MOV                 A,@0X40
   935 01660 0070 C        	MOV                 ADDR,A
   936 01661 1851 C        	MOV                 A,@0X51
   937            C        	if                  USED_PID_FUNCTION
   938            C        		OR              A,@0X80
   939            C        	endif
   940 01662 0071 C        	MOV                 VALUE,A
   941 01663 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   942 01664 0012 C        	RET
   943            C        
   944            C        
   945            C        ;***********************************************************
   946            C        ; Function: Enter StandbyI Mode
   947            C        ; Input:    None
   948            C        ; Output:   None
   949            C        ; description:
   950            C        ;***********************************************************
   951 01665      C        Enter_StandbyI_Mode:
   952 01665 1342 C        	CALL                PAGE5BANK1
   953 01666 1800 C        	MOV                 A,@0X00
   954 01667 0070 C        	MOV                 ADDR,A
   955 01668 1865 C        	MOV                 A,@0X65
   956 01669 0071 C        	MOV                 VALUE,A
   957 0166A 114C C        	CALL                WRITE_SPI_REG
   958 0166B 1801 C        	MOV                 A,@0X01
   959 0166C 0070 C        	MOV                 ADDR,A
   960 0166D 188C C        	MOV                 A,@0X8C
   961 0166E 0071 C        	MOV                 VALUE,A
   962 0166F 114C C        	CALL                WRITE_SPI_REG
   963 01670 1840 C        	MOV                 A,@0X40
   964 01671 0070 C        	MOV                 ADDR,A
   965 01672 1850 C        	MOV                 A,@0X50
   966            C        	if USED_PID_FUNCTION
   967            C        		OR              A,@0X80
   968            C        	endif
   969 01673 0071 C        	MOV                 VALUE,A
   970 01674 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   971 01675 0012 C        	RET
   972            C        
   973            C        
   974            C        ;***********************************************************
   975            C        ; Function: Enter StandbyII Mode
   976            C        ; Input:    None
   977            C        ; Output:   None
   978            C        ; description: auto enter
   979            C        ;***********************************************************
   980 01676      C        Enter_StandbyII_Mode:
   981 01676 1342 C        	CALL                PAGE5BANK1
   982 01677 1800 C        	MOV                 A,@0X00
   983 01678 0070 C        	MOV                 ADDR,A
   984 01679 18E5 C        	MOV                 A,@0XE5
   985 0167A 0071 C        	MOV                 VALUE,A
   986 0167B 114C C        	CALL                WRITE_SPI_REG
   987 0167C 1801 C        	MOV                 A,@0X01
   988 0167D 0070 C        	MOV                 ADDR,A
   989 0167E 1884 C        	MOV                 A,@0X84
   990 0167F 0071 C        	MOV                 VALUE,A
   991 01680 114C C        	CALL                WRITE_SPI_REG
   992 01681 1841 C        	MOV                 A,@0X41
   993 01682 0070 C        	MOV                 ADDR,A
   994 01683 1880 C        	MOV                 A,@0X80
   995 01684 0071 C        	MOV                 VALUE,A
   996 01685 114C C        	CALL                WRITE_SPI_REG
   997 01686 1840 C        	MOV                 A,@0X40
   998 01687 0070 C        	MOV                 ADDR,A
   999 01688 1852 C        	MOV                 A,@0X52
  1000            C        	if                  USED_PID_FUNCTION
  1001            C        		OR              A,@0X80
  1002            C        	endif
  1003 01689 0071 C        	MOV                 VALUE,A
  1004 0168A 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
  1005 0168B 0012 C        	RET
  1006            C        
  1007            C        
  1008            C        ;===============================================
  1009            C        ; Function: Enter Idle Mode
  1010            C        ; Input:    None
  1011            C        ; Output:   None
  1012            C        ;===============================================
  1013 0168C      C        ENTER_IDLE_MODE:
  1014 0168C 1342 C        	CALL                PAGE5BANK1
  1015 0168D 1800 C        	MOV                 A,@0X00
  1016 0168E 0070 C        	MOV                 ADDR,A
  1017 0168F 18C0 C        	MOV                 A,@0XC0
  1018 01690 0071 C        	MOV                 VALUE,A
  1019 01691 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
  1020 01692 1801 C        	MOV                 A,@0X01
  1021 01693 0070 C        	MOV                 ADDR,A
  1022 01694 188A C        	MOV                 A,@0X8A
  1023 01695 0071 C        	MOV                 VALUE,A
  1024 01696 114C C        	CALL                WRITE_SPI_REG
  1025 01697 133F C        	CALL                PAGE5BANK0
  1026 01698 0846 C        	BC                  RESET_N/8,RESET_N%8
  1027 01699 1342 C        	CALL                PAGE5BANK1
  1028 0169A 0012 C        	RET
  1029            C        
  1030            C        
  1031            C        ;===============================================
  1032            C        ; Function: RF Enter Sleep Mode
  1033            C        ; Input:    ADDR,VALUE
  1034            C        ; Output:   None
  1035            C        ;===============================================
  1036 0169B      C        ENTER_RF_SLEEP:
  1037 0169B 1342 C        	CALL                PAGE5BANK1
  1038 0169C 1800 C        	MOV                 A,@0X00
  1039 0169D 0070 C        	MOV                 ADDR,A
  1040 0169E 18E5 C        	MOV                 A,@0XE5
  1041 0169F 0071 C        	MOV                 VALUE,A
  1042 016A0 114C C        	CALL                WRITE_SPI_REG
  1043 016A1 0000 C        	NOP
  1044 016A2 133F C        	CALL                PAGE5BANK0
  1045 016A3 0846 C        	BC                  RESET_N/8,RESET_N%8
  1046 016A4 1342 C        	CALL                PAGE5BANK1
  1047 016A5 0012 C        	RET
  1048            C        
  1049            C        
  1050            C        ;===============================================
  1051            C        ; Function: RF Wake Up
  1052            C        ; Input:    None
  1053            C        ; Output:   None
  1054            C        ;===============================================
  1055 016A6      C        RF_WAKEUP:
  1056 016A6 0A46 C        	BS                  RESET_N/8,RESET_N%8
  1057 016A7 1800 C        	MOV                 A,@0X00
  1058 016A8 0070 C        	MOV                 ADDR,A
  1059 016A9 18E5 C        	MOV                 A, @0XE5
  1060 016AA 0071 C        	MOV                 VALUE,A
  1061 016AB 114C C        	CALL                WRITE_SPI_REG
  1062 016AC 180F C        	MOV                 A,@0X0F
  1063 016AD 12FC C        	CALL                DELAY_X100US
  1064 016AE 0012 C        	RET
  1065            C        
  1066            C        
  1067            C        ;===============================================
  1068            C        ; Function: RF Channel Frequency Set
  1069            C        ; Input:    TABLE_INDEX
  1070            C        ; Output:   None
  1071            C        ;===============================================
  1072 016AF      C        RF_FREQ_SET:
  1073 016AF 1342 C        	CALL                PAGE5BANK1
  1074 016B0 1802 C        	MOV                 A,@0X02
  1075 016B1 0070 C        	MOV                 ADDR,A
  1076 016B2 0425 C        	MOV                 A,CH_NO
  1077 016B3 10AC C        	CALL                CH_TABLE
  1078 016B4 0071 C        	MOV                 VALUE,A
  1079 016B5 114C C        	CALL                WRITE_SPI_REG
  1080 016B6 0012 C        	RET
  1081            C        
  1082            C        
  1083            C        ;===============================================
  1084            C        ; Function: Read PKT Lost Count
  1085            C        ; Input:    None
  1086            C        ; Output:   PKT_Lost_Count
  1087            C        ;===============================================
  1088 016B7      C        READ_PKTLOSTCNT:
  1089 016B7 184F C        	MOV                 A,@0X4F
  1090 016B8 0070 C        	MOV                 ADDR,A
  1091 016B9 1156 C        	CALL                READ_SPI_REG
  1092 016BA 0012 C        	RET
  1093            C        
  1094            C        
  1095            C        ;===============================================
  1096            C        ; Function: Clr PKT Lost Count
  1097            C        ; Input:    Zero
  1098            C        ; Output:   None
  1099            C        ;===============================================
  1100 016BB      C        CLR_PKTLOSTCNT:
  1101 016BB 184F C        	MOV                 A,@0X4F
  1102 016BC 0070 C        	MOV                 ADDR,A
  1103 016BD 1800 C        	MOV                 A,@0X00
  1104 016BE 0071 C        	MOV                 VALUE,A
  1105 016BF 114C C        	CALL                WRITE_SPI_REG
  1106 016C0 0012 C        	RET
  1107            C        
  1108            C        ;===============================================
  1109            C        ; Function: Address change function
  1110            C        ; Input:    RX_IDH,RX_IDL
  1111            C        ; Output:   None
  1112            C        ;===============================================
  1113 016C1      C        CHANGE_ADDRESS_VALUE:
  1114 016C1 1342 C        	CALL                PAGE5BANK1
  1115 016C2 1851 C        	MOV                 A,@0X51
  1116 016C3 0070 C        	MOV                 ADDR,A
  1117 016C4 0421 C        	MOV                 A,RX_IDH
  1118 016C5 0071 C        	MOV                 VALUE,A
  1119 016C6 114C C        	CALL                WRITE_SPI_REG
  1120            C        
  1121 016C7 1853 C        	MOV                 A,@0X53
  1122 016C8 0070 C        	MOV                 ADDR,A
  1123 016C9 0421 C        	MOV                 A,RX_IDH
  1124 016CA 0071 C        	MOV                 VALUE,A
  1125 016CB 114C C        	CALL                WRITE_SPI_REG
  1126            C        
  1127 016CC 1850 C        	MOV                 A,@0X50
  1128 016CD 0070 C        	MOV                 ADDR,A
  1129 016CE 0422 C        	MOV                 A,RX_IDL
  1130 016CF 0071 C        	MOV                 VALUE,A
  1131 016D0 114C C        	CALL                WRITE_SPI_REG
  1132            C        /*
  1133            C        	MOV                 A,@0X52
  1134            C        	MOV                 ADDR,A
  1135            C        	MOV                 A,RX_IDL
  1136            C        	AND                 A,@0B11110000
  1137            C        	MOV                 VALUE,A
  1138            C        	INC                 VALUE         ; TX_ID1=(RX_IDL&0XF0)|0X01
  1139            C        	INC                 VALUE         ; TX_ID2=(RX_IDL&0XF0)|0X02
  1140            C        	CALL                WRITE_SPI_REG
  1141            C        
  1142            C        	MOV                 A,@0X54
  1143            C        	MOV                 ADDR,A
  1144            C        	INC                 VALUE         ; TX_ID3=(RX_IDL&0XF0)|0X03
  1145            C        	CALL                WRITE_SPI_REG
  1146            C        
  1147            C        	MOV                 A,@0X55
  1148            C        	MOV                 ADDR,A
  1149            C        	INC                 VALUE         ; TX_ID4=(RX_IDL&0XF0)|0X04
  1150            C        	CALL                WRITE_SPI_REG
  1151            C        
  1152            C        	MOV                 A,@0X56
  1153            C        	MOV                 ADDR,A
  1154            C        	INC                 VALUE         ; TX_ID5=(RX_IDL&0XF0)|0X05
  1155            C        	CALL                WRITE_SPI_REG
  1156            C        
  1157            C        	MOV                 A,@0X57
  1158            C        	MOV                 ADDR,A
  1159            C        	INC                 VALUE         ; TX_ID6=(RX_IDL&0XF0)|0X06
  1160            C        	CALL                WRITE_SPI_REG
  1161            C        */	
  1162 016D1 0000 C        	NOP
  1163 016D2 0012 C        	RET
  1164 016D3 0000 C        	NOP
  1165            C        
  1166            C        
  1167            C        ;***********************************************************
  1168            C        ; Function: RF RSSI Check the channel if is clean
  1169            C        ; Input:    None
  1170            C        ; Output:   None
  1171            C        ;***********************************************************
  1172 016D4      C        RSSI_TEST_FUNCTION:        ; RF_RSSI_CHECK:
  1173 016D4 1223 C        	CALL                Enter_RX_Buffer_NACK
  1174 016D5 1804 C        	MOV                 A,@4
  1175 016D6 0051 C        	MOV                 TEMP1,A
  1176 016D7 00D2 C        	CLR                 TEMP2
  1177            C        
  1178            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
  1179            C        	;XOR                 PORT5,A
  1180            C         
  1181 016D8      C          Scan_Clean_Channel:
  1182 016D8 1342 C        	CALL                PAGE5BANK1
  1183 016D9 184B C        	MOV                 A,@0X4B
  1184 016DA 0070 C        	MOV                 ADDR,A
  1185 016DB 1156 C        	CALL                READ_SPI_REG
  1186 016DC 0431 C        	MOV                 A,VALUE
  1187 016DD 03D2 C        	ADD                 TEMP2,A
  1188 016DE 05D1 C        	DJZ                 TEMP1
  1189 016DF 16D8 C        	JMP                 Scan_Clean_Channel
  1190            C        	
  1191 016E0 0652 C        	RRC                 TEMP2
  1192 016E1 0612 C        	RRCA                TEMP2
  1193 016E2 1D20 C        	SUB                 A,@NoiseStrobe
  1194 016E3 0E03 C        	JBS                 STATUS,C
  1195 016E4 16F0 C        	JMP                 Exit_RSSI_Check
  1196            C        
  1197 016E5 1342 C        	CALL                PAGE5BANK1
  1198 016E6 0565 C        	INC                 CH_NO
  1199 016E7 0425 C        	MOV                 A,CH_NO
  1200 016E8 1D4C C        	SUB                 A,@ChannelSum
  1201 016E9 0E03 C        	JBS                 STATUS,C
  1202 016EA 00E5 C        	CLR                 CH_NO
  1203 016EB 12AF C        	CALL                RF_FREQ_SET
  1204 016EC 1805 C        	MOV                 A,@5
  1205 016ED 12FC C        	CALL                DELAY_X100US
  1206 016EE 0000 C        	NOP
  1207            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
  1208            C        	;XOR                 PORT5,A
  1209            C        
  1210 016EF 16D8 C        	JMP                 Scan_Clean_Channel
  1211 016F0      C          Exit_RSSI_Check:
  1212 016F0 0000 C        	NOP
  1213 016F1 0012 C        	RET
  1214 016F2 0000 C        	NOP
  1215            C        
  1216            C        ;===============================================
  1217            C        ; Function: Delay 20us
  1218            C        ; Input:    None
  1219            C        ; Output:   None
  1220            C        ;===============================================
  1221 016F3      C        DELAY_X10US:
  1222 016F3 0051 C        	MOV                 TEMP1,A
  1223 016F4      C          Delay_Loop_X10US:
  1224 016F4 1808 C        	MOV                 A,@8      ;
  1225 016F5 0052 C        	MOV                 TEMP2,A
  1226 016F6      C          Waiting_X10US:
  1227 016F6 05D2 C        	DJZ                 TEMP2
  1228 016F7 16F6 C        	JMP                 Waiting_X10US
  1229 016F8 05D1 C        	DJZ                 TEMP1
  1230 016F9 16F4 C        	JMP                 Delay_Loop_X10US
  1231 016FA 0012 C        	RET
  1232 016FB 0000 C        	NOP
  1233            C        
  1234            C        
  1235            C        ;===============================================
  1236            C        ; Function: Delay 100us
  1237            C        ; Input:    None
  1238            C        ; Output:   None
  1239            C        ; CRYSTAL	   :  6MHZ
  1240            C        ;===============================================
  1241 016FC      C        DELAY_X100US:
  1242 016FC 0051 C        	MOV                 TEMP1,A
  1243 016FD      C          Delay_Loop_X100US:
  1244 016FD 1864 C        	MOV                 A,@100      ;
  1245 016FE 0052 C        	MOV                 TEMP2,A
  1246 016FF      C          Waiting_X100US:
  1247 016FF 05D2 C        	DJZ                 TEMP2
  1248 01700 16FF C        	JMP                 Waiting_X100US
  1249 01701 05D1 C        	DJZ                 TEMP1
  1250 01702 16FD C        	JMP                 Delay_Loop_X100US
  1251 01703 0012 C        	RET
  1252            C        
  1253            C        
  1254            C        ;===============================================
  1255            C        ;test RF Register, if read==write test pass
  1256            C        ;===============================================
  1257 01704      C        TEST_INITIAL_RF:
  1258 01704      C          Analog_Reg_Test:
  1259 01704 1807 C        	MOV                 A,@0X07
  1260 01705 0070 C        	MOV                 ADDR,A
  1261 01706 1858 C        	MOV                 A,@0X58						;R7[6]=1
  1262 01707 0071 C        	MOV                 VALUE,A
  1263 01708 114C C        	CALL                WRITE_SPI_REG
  1264 01709 0000 C        	NOP
  1265 0170A 180E C        	MOV                 A,@0X0E
  1266 0170B 0070 C        	MOV                 ADDR,A
  1267 0170C 1811 C        	MOV                 A,@0X11						;RE[7]=0
  1268 0170D 0071 C        	MOV                 VALUE,A
  1269 0170E 114C C        	CALL                WRITE_SPI_REG
  1270 0170F 0000 C        	NOP
  1271 01710 182E C        	MOV                 A,@0X2E
  1272 01711 0070 C        	MOV                 ADDR,A
  1273 01712 1823 C        	MOV                 A,@0X23						;R2E[5]=1
  1274 01713 0071 C        	MOV                 VALUE,A
  1275 01714 114C C        	CALL                WRITE_SPI_REG
  1276 01715 0000 C        	NOP
  1277 01716 180E C        	MOV                 A,@0X0E
  1278 01717 0070 C        	MOV                 ADDR,A
  1279 01718 1891 C        	MOV                 A,@0X91						;RE[7]=1
  1280 01719 0071 C        	MOV                 VALUE,A
  1281 0171A 114C C        	CALL                WRITE_SPI_REG
  1282 0171B 0000 C        	NOP
  1283 0171C 120C C        	CALL                Enter_RX_Buffer_ACK
  1284 0171D 0000 C        	NOP
  1285 0171E 1808 C        	MOV                 A,@8
  1286 0171F 12FC C        	CALL                DELAY_X100US
  1287 01720 0000 C        	NOP
  1288 01721 184B C        	MOV                 A,@0X4B
  1289 01722 0070 C        	MOV                 ADDR,A
  1290 01723 1156 C        	CALL                READ_SPI_REG
  1291 01724 0000 C        	NOP
  1292 01725 0C31 C        	JBC                 VALUE,0					;R4B[0]:LD=1,Analog Reg Initial is OK
  1293 01726 1729 C        	JMP                 Digit_Reg_Test
  1294 01727 0B5D C        	BS                  RFTestfailFlag/8,RFTestfailFlag%8
  1295 01728 173E C        	JMP                 RF_TEST_RET
  1296 01729      C          Digit_Reg_Test:
  1297 01729 00D8 C        	CLR                 TABLE_INDEX
  1298 0172A      C          Check_Digit_Reg:
  1299 0172A 0418 C        	MOV                 A,TABLE_INDEX
  1300 0172B 108C C        	CALL                RF_TABLE
  1301 0172C 0000 C        	NOP
  1302 0172D 0070 C        	MOV                 ADDR,A
  1303 0172E 1BFF C        	XOR                 A, @0XFF
  1304 0172F 0C83 C        	JBC                 STATUS,Z
  1305 01730 173E C        	JMP                 RF_TEST_RET
  1306 01731 1156 C        	CALL                READ_SPI_REG
  1307 01732 0000 C        	NOP
  1308 01733 0558 C        	INC                 TABLE_INDEX
  1309 01734 0418 C        	MOV                 A,TABLE_INDEX
  1310 01735 108C C        	CALL                RF_TABLE
  1311 01736 0000 C        	NOP
  1312 01737 0331 C        	XOR                 A,VALUE
  1313 01738 0C83 C        	JBC                 STATUS,Z
  1314 01739 173C C        	JMP                 RF_TABLE_INC
  1315 0173A 0B5D C        	BS                  RFTestfailFlag/8,RFTestfailFlag%8
  1316 0173B 173E C        	JMP                 RF_TEST_RET
  1317 0173C      C          RF_TABLE_INC:
  1318 0173C 0558 C        	INC                 TABLE_INDEX
  1319 0173D 172A C        	JMP                 Check_Digit_Reg
  1320 0173E      C          RF_TEST_RET:
  1321 0173E 0012 C        	RET
  1322            C        
  1323            C        
  1324            C        ;=====================================================================
  1325            C        ; BANK exchange function
  1326            C        ;=====================================================================
  1327 0173F      C        PAGE5BANK0:
  1328 0173F 09C4 C        	BC        0X04,7
  1329 01740 0984 C        	BC        0X04,6
  1330 01741 0012 C          RET
  1331 01742      C        PAGE5BANK1:
  1332 01742 09C4 C        	BC        0X04,7
  1333 01743 0B84 C        	BS        0X04,6
  1334 01744 0012 C          RET
  1335 01745      C        PAGE5BANK2:
  1336 01745 0BC4 C        	BS        0X04,7
  1337 01746 0984 C        	BC        0X04,6
  1338 01747 0012 C          RET
  1339 01748      C        PAGE5BANK3:
  1340 01748 0BC4 C        	BS        0X04,7
  1341 01749 0B84 C        	BS        0X04,6
  1342 0174A 0012 C          RET
    19                     include "M611SkipFreqFunc.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  4.0
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10            C        ;=========================================================================
    11            C        M611SkipFreqFunc.ASM    EQU    M611SkipFreqFunc.ASM
    12            C        
    13            C        include "M611SkipFreqFunc.h"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  4.0
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10            C        ;=========================================================================
    11            C        M611SkipFreqFunc.h    EQU    M611SkipFreqFunc.h
    12            C        
    13            C        
    14            C        ;------------------------- function config ---------------------------
    15       0001 C        COMMU_DEBUG                     EQU     1    ; enable Communication debug
    16       0001 C        COMMU_T_DEBUG                   EQU     1
    17            C        
    18            C        ;===============================================================
    19       0005 C        RX1_LossframeSum                EQU     5
    20       0001 C        RX2_LossframeSum                EQU     1
    21       0001 C        RX3_LossframeSum                EQU     1
    22       0001 C        RX4_LossframeSum                EQU     1
    23       0001 C        RX5_LossframeSum                EQU     1
    24       0001 C        RX6_LossframeSum                EQU     1
    14            C        include "M611ManageFunc.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  4.0
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity,multi-1v2 CMOS project
    10            C        ;=========================================================================
    11            C        M611ManageFunc.ASM    EQU    M611ManageFunc.ASM
    12            C        
    13            C        include "Keyscan.ASM"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        include "Keyscan.H"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        
    12            C        ;------------------------------------------------------
    13            C        KeyScan.H         EQU     KeyScan.H
    14            C        
    15            C        ;------------------------------------------------------
    16       0038 C        KeyScanTimeCNT_Default      EQU     56
    17            C        
    12            C        
    13            C        ifndef EM78CtrlIns.H
    14            C        include "EM78CtrlIns.H"
    15            C        endif
    16            C        ;=========================================================================
    17            C        
    18            C        
    19            C        	ORG                 0X1100 ;page 4
    20            C          if MassageDisplay == 1
    21            C        	MESSAGE "define 'keyscan.asm' ROM address"
    22            C          endif
    23            C        ;**********************************************************************************
    24            C        ;*********************************************************************************
    25            C        ; Connect Key Scan
    26            C        ; Input:
    27            C        ; output: KEY_NUM
    28            C        ;         KeyScanStatusFlag
    29            C        ;*********************************************************************************
    30 01100      C        ConnectKey_Scan:
    31 01100 10EE C        	CALL                PAGE4BANK1
    32 01101 0000 C        	NOP
    33 01102 0409 C        	MOV                 A,Port9                   ; Port9_2
    34 01103 1A04 C        	AND                 A,@00000100B
    35 01104 0050 C        	MOV                 TEMP,A
    36 01105 1804 C        	MOV                 A,@00000100B              ; Bit2
    37 01106 02F5 C        	AND                 KeystokeFlag_Befor,A
    38            C        	
    39 01107 0436 C        	MOV                 A,KeySystemTimeCNT
    40 01108 1D38 C        	SUB                 A,@KeyScanTimeCNT_Default        ; 
    41 01109 0C03 C        	JBC                 STATUS,C
    42 0110A 150D C        	JMP                 Falling_Edge_Judge
    43 0110B 0577 C        	INC                 KeystokeTimeCNT
    44 0110C 00F6 C        	CLR                 KeySystemTimeCNT
    45 0110D      C        Falling_Edge_Judge:
    46 0110D 0410 C        	MOV                 A,TEMP
    47 0110E 0335 C        	XOR                 A,KeystokeFlag_Befor      ; bit 3, Check edge
    48 0110F 0C83 C        	JBC                 STATUS,Z
    49 01110 151B C        	JMP                 Rising_Edge_Judge         ; no edge occur
    50 01111 0410 C        	MOV                 A,TEMP                    ; Falling edge will change
    51 01112 1B00 C        	XOR                 A,@00000000B
    52 01113 0E83 C        	JBS                 STATUS,Z
    53 01114 151B C        	JMP                 Rising_Edge_Judge         ; no falling edge
    54 01115 0E5F C        	JBS                 KeyScanStatusFlag/8,KeyScanStatusFlag%8        ; scan the first falling edge
    55 01116 0A38 C        	BS                  KEY_NUM,0                            ; Will into key scan, Set leader bit
    56 01117 00F7 C        	CLR                 KeystokeTimeCNT                      ; press times ,recalculate
    57 01118 089F C        	BC                  KeyStatusFlag/8,KeyStatusFlag%8    ; key status, press(0) or release(1)
    58 01119 0A5F C        	BS                  KeyScanStatusFlag/8,KeyScanStatusFlag%8	     ; into scan key status
    59 0111A 1527 C        	JMP                 Edge_Judge_End
    60            C        
    61            C        ;--------------------------------------------------------------------
    62 0111B      C        Rising_Edge_Judge:
    63 0111B 0410 C        	MOV                 A,TEMP
    64 0111C 0335 C        	XOR                 A,KeystokeFlag_Befor      ; bit 3, Check edge
    65 0111D 0C83 C        	JBC                 STATUS,Z
    66 0111E 1527 C        	JMP                 Edge_Judge_End
    67 0111F 0410 C        	MOV                 A,TEMP                    ; rising edge will change
    68 01120 1B04 C        	XOR                 A,@00000100B
    69 01121 0E83 C        	JBS                 STATUS,Z
    70 01122 1527 C        	JMP                 Edge_Judge_End
    71 01123 0000 C        	NOP
    72 01124 1135 C        	CALL                KeyStatus_Low_Scan        ; rising edge ,check low level time
    73 01125 00F7 C        	CLR                 KeystokeTimeCNT           ; press times ,recalculate
    74 01126 0A9F C        	BS                  KeyStatusFlag/8,KeyStatusFlag%8
    75 01127      C        Edge_Judge_End:
    76 01127 0410 C        	MOV                 A,TEMP                    ; save currently press key status used for next judge
    77 01128 0075 C        	MOV                 KeystokeFlag_Befor,A
    78            C        
    79            C        ;------------------------------------------------------------------------------
    80 01129      C        KeystokeScan_End:                                                   ; a cycle scan end
    81 01129 0DF8 C        	JBC                 KEY_NUM,7                                   ; Count overflow
    82 0112A 00F8 C        	CLR                 KEY_NUM
    83            C        
    84 0112B 0437 C        	MOV                 A,KeystokeTimeCNT
    85 0112C 1D46 C        	SUB                 A,@70                                       ; 70*56ms=3920ms(ComuTime=56ms)
    86 0112D 0C03 C        	JBC                 STATUS,C
    87            C        	;INC                 KeystokeTimeCNT                             ; press times ,recalculate
    88            C        
    89 0112E 0437 C        	MOV                 A,KeystokeTimeCNT
    90 0112F 1B11 C        	XOR                 A,@17                                       ; 17*56ms=960ms(ComuTime=56ms)
    91 01130 0E83 C        	JBS                 STATUS,Z                                    ;
    92 01131 0012 C        	RET
    93 01132 085F C        	BC                  KeyScanStatusFlag/8,KeyScanStatusFlag%8	            ; more than 800ms ,EXIT scan status
    94 01133 0ADF C        	BS                  KeyScanFinishFlag/8,KeyScanFinishFlag%8
    95 01134 0012 C        	RET
    96            C        
    97            C        
    98            C        ;=========================================================================
    99 01135      C        KeyStatus_Low_Scan:     ; rising edge ,check low level time
   100 01135 0437 C        	MOV                 A,KeystokeTimeCNT
   101 01136 1D06 C        	SUB                 A,@6                       ;40*8ms=320ms(ComuTime=8ms)
   102 01137 0C03 C        	JBC                 STATUS,C                   ;
   103 01138 153A C        	JMP                 KeyScan_Short_Press	       ;less than 510ms
   104 01139 153D C        	JMP                 KeyScan_Lasting_Press      ;more than 510ms
   105 0113A      C        KeyScan_Short_Press:
   106 0113A 0803 C        	BC                  STATUS,C
   107 0113B 06F8 C        	RLC                 KEY_NUM
   108 0113C 0012 C        	RET
   109 0113D      C        KeyScan_Lasting_Press:
   110 0113D 0A03 C        	BS                  STATUS,C
   111 0113E 06F8 C        	RLC                 KEY_NUM
   112 0113F 0012 C        	RET
   113            C        
   114            C        
   115            C        
    14            C        
    15            C        ifndef EM78CtrlIns.H
    16            C        include "EM78CtrlIns.H"
    17            C        endif
    18            C        
    19            C        ifndef M611rxP40.H
    20            C        include "M611rxP40.H"
    21            C        endif
    22            C        
    23            C        ifndef XX93C46_For_EM78M611.ASM
    24            C        include "XX93C46_For_EM78M611.ASM"
     1            C        ;***********************************************************************;
     2            C        ; Tilte: Em78M611 spi FOR AT93C46 Function macro Code for EM78P611      ;
     3            C        ; Description:库中共包括以下七个功能宏                                  ;
     4            C        ;     1."mEWEN"  允许写/擦数据的宏。                                    ;
     5            C        ;     2."mEWDS"  禁止写/擦数据的宏 。                                   ;
     6            C        ;     3."mWRITE" 写如数据的宏，可以连续写多个字节，且写入数据可以不同   ;
     7            C        ;     4."mREAD"  读数据的宏，可以连续读多个字节。                       ;
     8            C        ;     5."mERASE" 擦除数据的宏，可以擦除多个连续字节。                   ;
     9            C        ;     6."mERAL"  擦除所有数据的宏，所有地址的内容都为"FF"。             ;
    10            C        ;     7."mWRAL"  把所有地址写入同以数据的宏。                           ;
    11            C        ; Company: Elan Corp. Inc                                               ;
    12            C        ; Author:  yu.wei                                                     ;
    13            C        ; Date:    2009.3.20                                                    ;
    14            C        ; Version: v1.0                                                         ;
    15            C        ; 说明：在使用此库时先要定义好作为通讯口的定义。                        ;
    16            C        ;***********************************************************************
    17            C        ;说明：
    18            C        ;    1. 本程式所写及读的数据都为8bit;
    19            C        ;------------------------------------------------------
    20            C        ; spi          Port Used For 93C46 Control.
    21            C        ; cs           Port Pin Tied To cs On 93C46.
    22            C        ; sk           Port Pin Tied To sk On 93C46.
    23            C        ; di           Port Pin Tied To di On 93C46.
    24            C        ; DO           Port Pin Tied To DO On 93C46.
    25            C        ; r_acc1     This Register Contains The 2 Bit 93C46
    26            C        ;              Command Is The High 2 Bit Positions And
    27            C        ;              memory Address In The Lower 6.
    28            C        ;--------------------------------------------------
    29            C        ;Instruction   SB    Op Code     Address               Data	         
    30            C        ;                               x8       x16       x8       x16	
    31            C        ;    READ       1      10 	A6 - A0  A5 - A0				
    32            C        ;    EWEN       1 	   00     11XXXXX  11XXXX 				
    33            C        ;    ERASE      1      11     A6 - A0  A5 - A0 				
    34            C        ;    WRITE      1 	   01 	A6 - A0  A5 - A0   D7 - D0  D15- D0  
    35            C        ;    ERAL       1 	   00 	10XXXXX  10XXXX 					
    36            C        ;    WRAL       1 	   00 	01XXXXX  01XXXX    D7 - D0  D15- D0  
    37            C        ;    EWDS       1 	   00 	00XXXXX  00XXXX 				
    38            C        ;=================================================================================
    39            C        XX93C46_For_EM78M611.ASM       EQU        XX93C46_For_EM78M611.ASM
    40            C        
    41            C        ifndef XX93C46_For_EM78M611.H
    42            C        include "XX93C46_For_EM78M611.H"
     1            C        ;---------------------------------------------------
     2            C        XX93C46_For_EM78M611.H         EQU        XX93C46_For_EM78M611.H
     3            C        
     4            C        ;---------------------------------------------------
     5            C        ;  93C46 INSTRUCTION  COmmAND
     6            C        ;--------------------------------------------------
     7       0080 C                READ        EQU     0X80    ;93C46 Read Command.
     8       0040 C                WRITE       EQU     0X40    ;93C46 Write Command.
     9       00C0 C                ERASE       EQU     0XC0    ;93C46 Erase Command.
    10       0030 C                EWEN        EQU     0X30    ;93C46 Erase/Write Enable Command.
    11       0000 C                EWDS        EQU     0X00    ;93C46 Erase/Write Disable Command.
    12       0020 C                ERAL        EQU     0X20    ;92C46 Erase All Command.
    13       0010 C                WRAL        EQU     0X10    ;92C46 Write All Command.
    14            C        ;--------------------------------------------------
    43            C        endif
    44            C        
    45            C        ifndef EM78CtrlIns.H
    46            C        include "EM78CtrlIns.H"
    47            C        endif
    48            C        
    49            C        
    50            C        		ORG     0X300
    51            C        ;***********************************************************************;
    52            C        ;Program name: mEWEN m,spi    m 数据的位数（8BIT或16BIT）               ;
    53            C        ;Description:  允许写/擦除操作的指令写入                                ;
    54            C        ;Input:        选择数据类型 m==8或m==16  m代表数据位数                  ;
    55            C        ;              定义好spi及其cs,sk,di,DO位                               ;
    56            C        ;Output:       使能写/擦除操作                                          ;
    57            C        ;Variable Register:None                                                 ;
    58            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
    59            C        ;***********************************************************************;
    60            C        mEWEN   MACRO   
    61            C                FCALL    Start_Bit       ;load start bit
    62            C                MOV     A,@ewen         ;enable erase/write
    63            C                MOV     r_acc1,A
    64            C                ;
    65            C                MOV     A,@9
    66            C                ;
    67            C                FCALL    Rl_Comd         ;finish enable erase/write
    68            C                BC      AT93C46_CS/8,AT93C46_CS%8          ;load end bit
    69            C                BC      SPI_CLK/8,SPI_CLK%8
    70            C                BC      SPI_MOSI/8,SPI_MOSI%8
    71            C                ENDM
    72            C        ;
    73            C        ;***********************************************************************;
    74            C        ;Program name:  mEWDS m,spi    m 数据的位数（8BIT或16BIT）              ;
    75            C        ;Description:   禁止写/擦除操作的指令写入                               ;
    76            C        ;Input:         选择数据类型 m==8或m==16  m代表数据位数；               ;
    77            C        ;               定义好spi及其cs,sk,di,DO位                              ;
    78            C        ;Output:        禁止写/擦除操作                                         ;
    79            C        ;Variable Register:None                                                 ;
    80            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
    81            C        ;***********************************************************************;
    82            C        mEWDS   MACRO     
    83            C                FCALL     Start_Bit       ;写入起始位
    84            C                MOV      A,@ewds         ;禁止写和擦除动作
    85            C                MOV      r_acc1,A
    86            C                ;
    87            C                MOV      A,@9
    88            C                ;
    89            C                FCALL     Rl_Comd
    90            C                BC       AT93C46_CS/8,AT93C46_CS%8
    91            C                BC       SPI_CLK/8,SPI_CLK%8
    92            C                BC       SPI_MOSI/8,SPI_MOSI%8          ;完成使能写操作指令的写入
    93            C                ENDM
    94            C        ;
    95            C        ;***********************************************************************;
    96            C        ;Program name:  mWRITE m,DataAddressInEEPROM,k,DataAddressInMCU,spi                            ;
    97            C        ;Description:   指定数据块写入到指定地址                                ;
    98            C        ;Input:         m 选择数据类型 m==8或16                                 ;
    99            C        ;               DataAddressInEEPROM  内容为要写入数据的最低位地址(93C46的地址）      ;
   100            C        ;               k 要写入数据的地址总数                                  ;
   101            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   102            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   103            C        ;Output:        写入指定数据块到指定地址块                              ;
   104            C        ;Variable Register:None                                                 ;
   105            C        ;Register Changed: STATUS,ACC ,
   106            C        ;                  r_acc1(0X21) ,
   107            C        ;                  r_acc2(0X22),         ;
   108            C        ;                  r_acc3(0X23)                                       ;
   109            C        ;***********************************************************************;
   110            C        mWRITE  MACRO   DataAddressInEEPROM,@BankSel,DataAddressInMCU,@k
   111            C                BANK    @BankSel
   112            C                MOV     A,DataAddressInMCU    ;写入数据存放的最低地址为0X24（mCU的地址）
   113            C                MOV     R4,A                   ;存放数据的间接地址
   114            C                MOV     A,@k
   115            C                MOV     r_acc3,A               ;写入93C46的字节数
   116            C        $Write_Data:
   117            C                FCALL    Start_Bit             ;写入起始位
   118            C               ;
   119            C                BC      STATUS,C
   120            C                RRCA    DataAddressInEEPROM
   121            C                ;
   122            C                OR      A,@write
   123            C                MOV     r_acc1,A               ;高二位为写命令，低六位为地址
   124            C                MOV     A,@8                   ;向93C46写一个字节，控制数
   125            C                FCALL    Rl_Comd               ;写入指令“写”和要写入数据的地址
   126            C               ;
   127            C                BC      SPI_CLK/8,SPI_CLK%8
   128            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   129            C                BC      SPI_MOSI/8,SPI_MOSI%8
   130            C                JBC     DataAddressInEEPROM,0
   131            C                BS      SPI_MOSI/8,SPI_MOSI%8
   132            C                JMP     $+1
   133            C                BS      SPI_CLK/8,SPI_CLK%8          ;以上为写入OP和ADDRESS
   134            C                ;
   135            C                INC     DataAddressInEEPROM
   136            C        $Data_H_L:
   137            C                MOV     A,R0
   138            C                MOV     r_acc1,A      ;装入要写入的数据
   139            C                INC     R4
   140            C                MOV     A,@8
   141            C                FCALL    Rl_Comd         ;写入8BIT数据
   142            C               ;
   143            C                JMP     $+1
   144            C               ;
   145            C                BC      AT93C46_CS/8,AT93C46_CS%8
   146            C                BC      SPI_CLK/8,SPI_CLK%8          ;数据写完，写结束位
   147            C                ;BC      AT93C46_CS/8,AT93C46_CS%8
   148            C                BC      SPI_MOSI/8,SPI_MOSI%8
   149            C                JMP     $+1
   150            C                BS      SPI_CLK/8,SPI_CLK%8
   151            C                BS      AT93C46_CS/8,AT93C46_CS%8          ;完成结束位的写入
   152            C                JBS     SPI_MISO/8,SPI_MISO%8
   153            C                JMP     $-1
   154            C                BC      AT93C46_CS/8,AT93C46_CS%8
   155            C                DJZ     r_acc3        ;多字节写入控制
   156            C                JMP     $Write_Data
   157            C                ENDM
   158            C        ;
   159            C        ;***********************************************************************;
   160            C        ;Program name:  mREAD m,DataAddressInEEPROM,k,DataAddressInMCU,spi                             ;
   161            C        ;Description:   从指定地址块（93C46）读出数据到指定地址块(CPU)          ;
   162            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   163            C        ;               DataAddressInEEPROM  内容为要读出数据的最低位地址(93C46的地址）      ;
   164            C        ;               k 要写入数据的地址总数                                  ;
   165            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   166            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   167            C        ;Output:        指定地址读出指定数据块                                  ;
   168            C        ;Variable Register:None                                                 ;
   169            C        ;Register Changed: STATUS,ACC ,
   170            C        ;                  r_acc1(0X21) ,
   171            C        ;                  r_acc2(0X22),         ;
   172            C        ;                  r_acc3(0X23)                                       ;
   173            C        ;***********************************************************************;
   174            C        mREAD   MACRO   DataAddressInEEPROM,@BankSel,DataAddressInMCU,@k
   175            C                MOV     A,DataAddressInMCU              ;写入数据存放的最低地址（mCU的地址）     ;
   176            C                MOV     R4,A
   177            C                NOP
   178            C                BANK    @BankSel
   179            C                MOV     A,@k
   180            C                MOV     r_acc3,A
   181            C        $Write_Data:
   182            C                FCALL    Start_Bit       ;写入起始位
   183            C               ;
   184            C                RRCA    DataAddressInEEPROM
   185            C                ;
   186            C                OR      A,@READ
   187            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   188            C                MOV     A,@8            ;向93C46写一个字节，控制数
   189            C                FCALL    Rl_Comd         ;写入指令“读”和要写入数据的地址
   190            C               ;
   191            C                BC      SPI_CLK/8,SPI_CLK%8
   192            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   193            C                BC      SPI_MOSI/8,SPI_MOSI%8
   194            C                JBC     DataAddressInEEPROM,0
   195            C                BS      SPI_MOSI/8,SPI_MOSI%8
   196            C                JMP     $+1
   197            C                BS      SPI_CLK/8,SPI_CLK%8
   198            C               ;
   199            C                INC     DataAddressInEEPROM          ;地址加1
   200            C                BC      SPI_MOSI/8,SPI_MOSI%8
   201            C                JMP     $+1
   202            C                BC      SPI_CLK/8,SPI_CLK%8
   203            C                JMP     $+1
   204            C                JMP     $+1
   205            C                BS      SPI_CLK/8,SPI_CLK%8
   206            C        
   207            C        $Read_Data1:
   208            C                MOV     A,@8
   209            C                MOV     r_acc2,A
   210            C        $Read_Data2:
   211            C                BC      SPI_CLK/8,SPI_CLK%8
   212            C                NOP
   213            C                NOP
   214            C                JBC     SPI_MISO/8,SPI_MISO%8
   215            C                BS      STATUS,C
   216            C                JBS     SPI_MISO/8,SPI_MISO%8
   217            C                BC      STATUS,C
   218            C                RLC     R0
   219            C                BS      SPI_CLK/8,SPI_CLK%8
   220            C                JMP     $+1
   221            C                DJZ     r_acc2
   222            C                JMP     $Read_Data2
   223            C                INC     R4
   224            C                ;
   225            C                NOP
   226            C                ;
   227            C                BC      AT93C46_CS/8,AT93C46_CS%8
   228            C                DJZ     r_acc3
   229            C                JMP     $Write_Data
   230            C                ENDM
   231            C        ;
   232            C        ;***********************************************************************;
   233            C        ;Program name:  mERASE m,DataAddressInEEPROM,k,spi                                   ;
   234            C        ;Description:   从指定地址块擦除数据                                    ;
   235            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   236            C        ;               DataAddressInEEPROM 内容为要擦除数据的最低位地址(93C46的地址）       ;
   237            C        ;               k 要擦除数据的地址总数                                  ;
   238            C        ;               spi    选择PORT作为通信口，要定义好cs,sk,di,DO相关位    ;
   239            C        ;Output:        指定地址块的数据被擦除                                  ;
   240            C        ;Variable Register:None                                                 ;
   241            C        ;Register Changed: STATUS,ACC ,
   242            C        ;                  r_acc1(0X21) ,
   243            C        ;                  r_acc2(0X22),         ;
   244            C        ;                  r_acc3(0X23)                                       ;
   245            C        ;***********************************************************************;
   246            C        mERASE  MACRO    DataAddressInEEPROM,k
   247            C                MOV     A,@k
   248            C                MOV     r_acc3,A      ;写入93C46的字节数
   249            C        $Write_Data:
   250            C                CALL    Start_Bit       ;写入起始位
   251            C               ;
   252            C                RRCA    DataAddressInEEPROM
   253            C               ;
   254            C                OR      A,@ERASE
   255            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   256            C                MOV     A,@8            ;向93C46写一个字节，控制数
   257            C                CALL    Rl_Comd         ;写入指令“写”和要写入数据的地址
   258            C                ;
   259            C                BC      SPI_CLK/8,SPI_CLK%8
   260            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   261            C                BC      SPI_MOSI/8,SPI_MOSI%8
   262            C                JBC     DataAddressInEEPROM,0
   263            C                BS      SPI_MOSI/8,SPI_MOSI%8
   264            C                JMP     $+1
   265            C                BS      SPI_CLK/8,SPI_CLK%8          ;完成命令的写入
   266            C                JMP     $+1
   267            C                JMP     $+1
   268            C               ;
   269            C                INC     DataAddressInEEPROM
   270            C                BC      AT93C46_CS/8,AT93C46_CS%8
   271            C                BC      SPI_CLK/8,SPI_CLK%8
   272            C                BC      SPI_MOSI/8,SPI_MOSI%8
   273            C                JMP     $+1
   274            C                BS      SPI_CLK/8,SPI_CLK%8
   275            C                BS      AT93C46_CS/8,AT93C46_CS%8
   276            C                JBS     SPI_MISO/8,SPI_MISO%8
   277            C                JMP     $-1
   278            C                BC      AT93C46_CS/8,AT93C46_CS%8
   279            C        ;
   280            C                DJZ     r_acc3
   281            C                JMP     $Write_Data
   282            C                ENDM
   283            C        ;
   284            C        ;***********************************************************************;
   285            C        ;Program name:  mERAL m,spi                                             ;
   286            C        ;Description:   擦除所有地址的数据                                      ;
   287            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   288            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   289            C        ;Output:        所有地址的数据被擦除，变为“FF"                         ;
   290            C        ;Variable Register:None                                                 ;
   291            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
   292            C        ;***********************************************************************
   293            C        mERAL   MACRO   
   294            C        $Write_Data:
   295            C                FCALL   Start_Bit       ;写入起始位
   296            C                MOV     A,@ERAL
   297            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   298            C               ;
   299            C                MOV     A,@9
   300            C               ;
   301            C                FCALL    Rl_Comd
   302            C                BC      AT93C46_CS/8,AT93C46_CS%8
   303            C                BC      SPI_CLK/8,SPI_CLK%8
   304            C                BC      SPI_MOSI/8,SPI_MOSI%8
   305            C                JMP     $+1
   306            C                BS      SPI_CLK/8,SPI_CLK%8
   307            C                BS      AT93C46_CS/8,AT93C46_CS%8
   308            C                JBS     SPI_MISO/8,SPI_MISO%8
   309            C                JMP     $-1
   310            C                BC      AT93C46_CS/8,AT93C46_CS%8
   311            C                ENDM
   312            C        ;
   313            C        ;***********************************************************************;
   314            C        ;Program name:  mWRAL m,DataAddressInMCU,spi                                      ;
   315            C        ;Description:   一个指定数据写入到所有地址                              ;
   316            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   317            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   318            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   319            C        ;Output:        所有地址写入同一指定数据                                ;
   320            C        ;Variable Register:None                                                 ;
   321            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
   322            C        ;***********************************************************************;
   323            C        mWRAL   MACRO   @DataAddressInMCU
   324            C                MOV     A,@DataAddressInMCU
   325            C                MOV     R4,A            ;存放数据的间接地址
   326            C                CALL    Start_Bit       ;写入起始位
   327            C                MOV     A,@WRAL
   328            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   329            C                ;
   330            C                MOV     A,@9
   331            C                ;
   332            C                CALL    Rl_Comd
   333            C        $Data_H_L:
   334            C                MOV     A,R0
   335            C                MOV     r_acc1,A      ;装入要写入的数据
   336            C                INC     R4
   337            C                MOV     A,@8
   338            C                CALL    Rl_Comd         ;写入8BIT数据
   339            C                ;
   340            C                NOP
   341            C                ;
   342            C                BC      SPI_CLK/8,SPI_CLK%8          ;数据写完，写结束位
   343            C                BC      AT93C46_CS/8,AT93C46_CS%8
   344            C                BC      SPI_MOSI/8,SPI_MOSI%8
   345            C                JMP     $+1
   346            C                BS      SPI_CLK/8,SPI_CLK%8
   347            C                BS      AT93C46_CS/8,AT93C46_CS%8          ;完成结束位的写入
   348            C                JBS     SPI_MISO/8,SPI_MISO%8
   349            C                JMP     $-1
   350            C                BC      AT93C46_CS/8,AT93C46_CS%8
   351            C                BC      SPI_CLK/8,SPI_CLK%8
   352            C                ENDM
   353            C        
   354            C        
   355            C        
   356            C        
   357            C        ;-------------------------------------------------------
   358 00300      C        Start_Bit:
   359            C      M 		BANK    @0
       00300 09C4     1     BC  4 , 7 
       00301 0984     1     BC  4 , 6 
   360 00302 0985 C                BC      AT93C46_CS/8,AT93C46_CS%8
   361 00303 0886 C                BC      SPI_CLK/8,SPI_CLK%8
   362 00304 08C6 C                BC      SPI_MOSI/8,SPI_MOSI%8
   363 00305 1706 C                JMP     $+1
   364 00306 1707 C                JMP     $+1
   365 00307 0B85 C                BS      AT93C46_CS/8,AT93C46_CS%8
   366 00308 1709 C                JMP     $+1
   367 00309 170A C                JMP     $+1
   368 0030A 0AC6 C                BS      SPI_MOSI/8,SPI_MOSI%8       ;PORT6,SPI_MOSI;
   369 0030B 170C C                JMP     $+1
   370 0030C 170D C                JMP     $+1
   371 0030D 0A86 C                BS      SPI_CLK/8,SPI_CLK%8
   372 0030E 0012 C                RET
   373            C        
   374            C        ;--------------------------------------------------------
   375 0030F      C        Rl_Comd:
   376 0030F 0059 C        	MOV     DataShiftCounter,A
   377            C      M 	BANK    @0
       00310 09C4     1     BC  4 , 7 
       00311 0984     1     BC  4 , 6 
   378 00312      C        Rl_Comd1:
   379 00312 0886 C        	BC      SPI_CLK/8,SPI_CLK%8
   380 00313 1714 C        	JMP     $+1
   381 00314 0803 C        	bc      status,c
   382 00315 06D1 C        	RLC     r_acc1        ;要写入的数据
   383 00316 0E03 C        	JBS     STATUS,C
   384 00317 08C6 C        	BC      SPI_MOSI/8,SPI_MOSI%8
   385 00318 0C03 C        	JBC     STATUS,C
   386 00319 0AC6 C        	BS      SPI_MOSI/8,SPI_MOSI%8
   387 0031A 0000 C        	NOP
   388 0031B 0000 C        	NOP
   389 0031C 0A86 C        	BS      SPI_CLK/8,SPI_CLK%8
   390 0031D 171E C        	JMP     $+1
   391 0031E 05D9 C        	DJZ     DataShiftCounter
   392 0031F 1712 C        	JMP     Rl_Comd1
   393 00320 0012 C        	RET                   ;    return
   394            C        
   395            C        
    25            C        endif
    26            C        
    27            C        ;=========================================================================
    28            C        
    29            C        	ORG                 0X1000	;PAGE 4
    30            C          if MassageDisplay == 1
    31            C        	MESSAGE "define 'M611ManageFunc.ASM' ROM address"
    32            C          endif
    33            C        ;********************************************************************************
    34            C        ; TX data to PC
    35            C        ;********************************************************************************
    36            C        ;===================================================================
    37            C        ;Function:      setting
    38            C        ;Input:         None
    39            C        ;Output:        None
    40            C        ;====================================================================
    41 01000      C        CommTypeScan_Func:
    42 01000 10EE C        	CALL                PAGE4BANK1
    43 01001 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
    44 01002 1409 C        	JMP                 KeyType_Scan
    45            C        
    46 01003 0417 C        	MOV                 A,SystemTimeCNT
    47 01004 1DC8 C        	SUB                 A,@200              ; 200*1ms = 200ms
    48 01005 0C03 C        	JBC                 STATUS,C
    49 01006 1409 C        	JMP                 KeyType_Scan
    50 01007 00D7 C        	CLR                 SystemTimeCNT
    51 01008 0AC9 C        	BS                  LED1_STATUS/8,LED1_STATUS%8
    52            C        
    53            C        ;===========================================================================
    54 01009      C        KeyType_Scan:
    55 01009 1100 C        	CALL                ConnectKey_Scan
    56 0100A 0EDF C        	JBS                 KeyScanFinishFlag/8,KeyScanFinishFlag%8
    57 0100B 141A C        	JMP                 Keystoke_No_Press
    58 0100C 08DF C        	BC                  KeyScanFinishFlag/8,KeyScanFinishFlag%8
    59            C        
    60 0100D 0438 C        	MOV                 A,KEY_NUM
    61 0100E 1B02 C        	XOR                 A,@00000010B
    62 0100F 0C83 C        	JBC                 STATUS,Z
    63 01010 1433 C        	JMP                 Click_Select
    64            C        
    65 01011 0438 C        	MOV                 A,KEY_NUM
    66 01012 1B03 C        	XOR                 A,@00000011B
    67 01013 0C83 C        	JBC                 STATUS,Z
    68 01014 1440 C        	JMP                 Lasting_Press_Select
    69            C        
    70 01015 0438 C        	MOV                 A,KEY_NUM
    71 01016 1B04 C        	XOR                 A,@00000100B
    72 01017 0C83 C        	JBC                 STATUS,Z
    73 01018 1443 C        	JMP                 Dblclick_Select
    74            C        
    75            C        /*
    76            C        	MOV                 A,KEY_NUM
    77            C        	XOR                 A,@00000101B
    78            C        	JBC                 STATUS,Z
    79            C        	NOP
    80            C        
    81            C        	MOV                 A,KEY_NUM
    82            C        	XOR                 A,@00000110B
    83            C        	JBC                 STATUS,Z
    84            C        	NOP
    85            C        
    86            C        	MOV                 A,KEY_NUM
    87            C        	XOR                 A,@00000111B
    88            C        	JBC                 STATUS,Z
    89            C        	NOP
    90            C        */
    91            C        
    92 01019 0000 C        	NOP
    93            C        ;===========================================================================
    94            C        
    95            C        
    96            C        ;**********************************************************************************
    97            C        ;*********************************************************************************
    98            C        ; force link check CHN_FLAG
    99            C        ;*********************************************************************************
   100 0101A      C        Keystoke_No_Press:
   101 0101A 0000 C        	NOP
   102 0101B 0D1E C        	JBC                 LinkModeFlag/8,LinkModeFlag%8
   103 0101C 14CD C        	JMP                 Cycle_Waiting_End
   104 0101D 10EE C        	CALL                PAGE4BANK1
   105 0101E 0423 C        	MOV                 A,CHN_FLAG
   106 0101F 1B03 C        	XOR                 A,@0b00000011             ; (1-8) Gamepads
   107 01020 0E83 C        	JBS                 STATUS,Z
   108 01021 14CD C        	JMP                 Cycle_Waiting_End
   109 01022      C        Quit_Recognise_Scan:                             ; Exit ID scan
   110 01022 08C9 C        	BC                  LED1_STATUS/8,LED1_STATUS%8
   111            C      M 	PAGE                0
       01023 09C3     1     BC  3 , 7 
       01024 0983     1     BC  3 , 6 
       01025 0943     1     BC  3 , 5 
   112 01026 1268 C        	CALL                SearchLinkMode_Set
   113            C      M 	PAGE                5
       01027 0BC3     1     BS  3 , 7 
       01028 0983     1     BC  3 , 6 
       01029 0B43     1     BS  3 , 5 
   114            C        	;CALL                Reset_RF_FIFO
   115            C        	;CALL                Enter_StandbyII_Mode
   116 0102A 12C1 C        	CALL                CHANGE_ADDRESS_VALUE
   117            C      M 	PAGE                4
       0102B 0BC3     1     BS  3 , 7 
       0102C 0983     1     BC  3 , 6 
       0102D 0943     1     BC  3 , 5 
   118 0102E 10EE C        	CALL                PAGE4BANK1
   119 0102F 00E3 C        	CLR                 CHN_FLAG
   120            C        
   121            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   122            C        	;XOR                 PORT5,A
   123            C        
   124 01030 0000 C        	NOP
   125 01031 14CD C        	JMP                 Cycle_Waiting_End
   126 01032 0000 C        	NOP
   127            C        
   128            C        ;**********************************************************************************
   129            C        ;*********************************************************************************
   130            C        ; FCC test mode frequency index
   131            C        ;*********************************************************************************
   132 01033      C        Click_Select:
   133 01033 0F9E C        	JBS                 FccTestModeFlag/8,FccTestModeFlag%8
   134 01034 143B C        	JMP                 Not_Fcc_TestMode
   135 01035 056F C        	INC                 FccFreqIndex
   136 01036 042F C        	MOV                 A,FccFreqIndex
   137 01037 1D0F C        	SUB                 A,@0X0F
   138 01038 0E03 C        	JBS                 STATUS,C
   139 01039 00EF C        	CLR                 FccFreqIndex
   140 0103A 1409 C        	JMP                 KeyType_Scan
   141 0103B      C        Not_Fcc_TestMode:
   142 0103B 00F8 C        	CLR                 KEY_NUM
   143 0103C 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   144 0103D 14CD C        	JMP                 Cycle_Waiting_End
   145 0103E 1422 C        	JMP                 Quit_Recognise_Scan
   146 0103F 0000 C        	NOP
   147            C        
   148            C        
   149            C        
   150            C        ;**********************************************************************************
   151            C        ;*********************************************************************************
   152            C        ; Into FCC mode
   153            C        ;*********************************************************************************
   154 01040      C        Lasting_Press_Select:                                     	; Fcc Test
   155            C        	;PAGE                0
   156            C        	;CALL                NormalFccLinkMode_Set
   157            C        	;PAGE                4
   158 01040 0B9E C        	BS                  FccTestModeFlag/8,FccTestModeFlag%8
   159 01041 14CD C        	JMP                 Cycle_Waiting_End
   160 01042 0000 C        	NOP
   161            C        
   162            C        
   163            C        ;**********************************************************************************
   164            C        ;*********************************************************************************
   165            C        ; Into force link mode
   166            C        ;*********************************************************************************
   167 01043      C        Dblclick_Select:                                            ; Into Forcelink Mode:
   168 01043 0004 C        	WDTC
   169 01044 0AC9 C        	BS                  LED1_STATUS/8,LED1_STATUS%8
   170 01045 10EE C        	CALL                PAGE4BANK1
   171 01046 18D6 C        	MOV                 A,@RX_IDH_DEFAULT                   ; SYNC ,used default 0X0DB3
   172 01047 0061 C        	MOV                 RX_IDH,A
   173 01048 18AC C        	MOV                 A,@RX_IDL_DEFAULT
   174 01049 0062 C        	MOV                 RX_IDL,A
   175            C      M 	PAGE                5
       0104A 0BC3     1     BS  3 , 7 
       0104B 0983     1     BC  3 , 6 
       0104C 0B43     1     BS  3 , 5 
   176 0104D 1276 C        	CALL                Enter_StandbyII_Mode
   177 0104E 12C1 C        	CALL                CHANGE_ADDRESS_VALUE
   178            C      M 	PAGE                0
       0104F 09C3     1     BC  3 , 7 
       01050 0983     1     BC  3 , 6 
       01051 0943     1     BC  3 , 5 
   179 01052 1276 C        	CALL                SearchForceLinkMode_Set
   180 01053 1151 C        	CALL                Rand_ID_Function
   181            C      M 	PAGE                4
       01054 0BC3     1     BS  3 , 7 
       01055 0983     1     BC  3 , 6 
       01056 0943     1     BC  3 , 5 
   182 01057 0000 C        	NOP
   183 01058      C        Write_EEprom_Task:                                          ; Write EEprom Task
   184 01058 0011 C        	DISI
   185 01059 0000 C        	NOP
   186 0105A 0B06 C        	BS                  SPI_SS/8,SPI_SS%8                 ; Disable EM198810
   187            C        	;mERAL                                                  ; Clear all
   188            C      M 	mEWEN                                                   ; Enable
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       0105B 09C3     3     BC  3 , 7 
       0105C 0983     3     BC  3 , 6 
       0105D 0943     3     BC  3 , 5 
       0105E 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0105F 0BC3     3     BS  3 , 7 
       01060 0983     3     BC  3 , 6 
       01061 0943     3     BC  3 , 5 
       01062 1830     1     MOV A,@( EWEN )
       01063 0051     1     MOV  R_ACC1 ,A
       01064 1809     1     MOV A,@( 9 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01065 09C3     3     BC  3 , 7 
       01066 0983     3     BC  3 , 6 
       01067 0943     3     BC  3 , 5 
       01068 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       01069 0BC3     3     BS  3 , 7 
       0106A 0983     3     BC  3 , 6 
       0106B 0943     3     BC  3 , 5 
       0106C 0985     1     BC ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       0106D 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       0106E 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
   189 0106F 1800 C        	MOV                 A,@0X00
   190 01070 0055 C        	MOV                 DataAddressInEEPROM,A
   191 01071 1860 C        	MOV                 A,@0X60
   192 01072 0054 C        	MOV                 DataAddressInMCU,A
   193            C      M  	mWRITE              DataAddressInEEPROM,@0,DataAddressInMCU,@16
                      2  M  BANK @( 0 ),
       01073 09C4     2     BC  4 , 7 
       01074 0984     2     BC  4 , 6 
       01075 0414     1     MOV A, DATAADDRESSINMCU 
       01076 0044     1     MOV  R4 ,A
       01077 1810     1     MOV A,@( 16 )
       01078 0053     1     MOV  R_ACC3 ,A
       01079          1    ??0010$WRITE_DATA:   
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       01079 09C3     3     BC  3 , 7 
       0107A 0983     3     BC  3 , 6 
       0107B 0943     3     BC  3 , 5 
       0107C 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0107D 0BC3     3     BS  3 , 7 
       0107E 0983     3     BC  3 , 6 
       0107F 0943     3     BC  3 , 5 
       01080 0803     1     BC  STATUS , C 
       01081 0615     1     RRCA  DATAADDRESSINEEPROM ,
       01082 1940     1     OR A,@( WRITE )
       01083 0051     1     MOV  R_ACC1 ,A
       01084 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01085 09C3     3     BC  3 , 7 
       01086 0983     3     BC  3 , 6 
       01087 0943     3     BC  3 , 5 
       01088 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       01089 0BC3     3     BS  3 , 7 
       0108A 0983     3     BC  3 , 6 
       0108B 0943     3     BC  3 , 5 
       0108C 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       0108D 0E15     1     JBS  DATAADDRESSINEEPROM , 0 
       0108E 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       0108F 0C15     1     JBC  DATAADDRESSINEEPROM , 0 
       01090 0AC6     1     BS ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       01091 1492     1     JMP ( $ + 1 ),
       01092 0A86     1     BS ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       01093 0555     1     INC  DATAADDRESSINEEPROM ,
       01094          1    ??0010$DATA_H_L:   
       01094 0400     1     MOV A, R0 
       01095 0051     1     MOV  R_ACC1 ,A
       01096 0544     1     INC  R4 ,
       01097 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01098 09C3     3     BC  3 , 7 
       01099 0983     3     BC  3 , 6 
       0109A 0943     3     BC  3 , 5 
       0109B 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0109C 0BC3     3     BS  3 , 7 
       0109D 0983     3     BC  3 , 6 
       0109E 0943     3     BC  3 , 5 
       0109F 14A0     1     JMP ( $ + 1 ),
       010A0 0985     1     BC ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       010A1 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       010A2 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       010A3 14A4     1     JMP ( $ + 1 ),
       010A4 0A86     1     BS ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       010A5 0B85     1     BS ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       010A6 0E06     1     JBS ( SPI_MISO / 8 ),( SPI_MISO % 8 )
       010A7 14A6     1     JMP ( $ - 1 ),
       010A8 0985     1     BC ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       010A9 05D3     1     DJZ  R_ACC3 ,
       010AA 1479     1     JMP  ??0010$WRITE_DATA ,
   194            C      M  	mEWDS                                                   ; disable
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       010AB 09C3     3     BC  3 , 7 
       010AC 0983     3     BC  3 , 6 
       010AD 0943     3     BC  3 , 5 
       010AE 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       010AF 0BC3     3     BS  3 , 7 
       010B0 0983     3     BC  3 , 6 
       010B1 0943     3     BC  3 , 5 
       010B2 1800     1     MOV A,@( EWDS )
       010B3 0051     1     MOV  R_ACC1 ,A
       010B4 1809     1     MOV A,@( 9 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       010B5 09C3     3     BC  3 , 7 
       010B6 0983     3     BC  3 , 6 
       010B7 0943     3     BC  3 , 5 
       010B8 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       010B9 0BC3     3     BS  3 , 7 
       010BA 0983     3     BC  3 , 6 
       010BB 0943     3     BC  3 , 5 
       010BC 0985     1     BC ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       010BD 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       010BE 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
   195 010BF 0985 C        	BC                  AT93C46_CS/8,AT93C46_CS%8         ; Disable 93C46
   196            C        
   197 010C0 0010 C        	ENI
   198 010C1 10EE C         	CALL                PAGE4BANK1
   199 010C2 00DE C        	CLR                 CommuStatusFlag
   200 010C3 00E3 C        	CLR                 CHN_FLAG
   201 010C4 00F8 C        	CLR                 KEY_NUM
   202 010C5 00DE C        	CLR                 CommuStatusFlag
   203 010C6 0A1E C        	BS                  SearchStatusFlag/8,SearchStatusFlag%8
   204 010C7 0B5E C        	BS                  ForceLinkModeFlag/8,ForceLinkModeFlag%8    ;
   205            C        
   206 010C8 10EB C        	CALL                PAGE4BANK0
   207 010C9 0985 C        	BC                  AT93C46_CS/8,AT93C46_CS%8                  ; Disable 93C46
   208 010CA 0B06 C        	BS                  SPI_SS/8,SPI_SS%8                          ; Disable EM198810
   209 010CB 14CD C        	JMP                 Cycle_Waiting_End
   210 010CC 0000 C        	NOP
   211            C        
   212            C        
   213            C        
   214            C        ;===================================================================
   215            C        ;
   216            C        ;===================================================================
   217 010CD      C        Cycle_Waiting_End:
   218 010CD 10EE C        	CALL                PAGE4BANK1
   219 010CE 0417 C        	MOV                 A,SystemTimeCNT
   220 010CF 1DFA C        	SUB                 A,@250              ; 200*1ms = 200ms
   221 010D0 0E03 C        	JBS                 STATUS,C
   222 010D1 00D7 C        	CLR                 SystemTimeCNT
   223 010D2 0423 C        	MOV                 A,CHN_FLAG
   224 010D3 0073 C        	MOV                 CHN_FLAG_TEMP,A
   225            C        
   226 010D4 10EE C        	CALL                PAGE4BANK1
   227 010D5 0439 C        	MOV                 A,RX_ComuLoseCNT
   228 010D6 1DC8 C        	SUB                 A,@RX_ComuLoseCNT_Default
   229 010D7 0C03 C        	JBC                 STATUS,C                  ; t=RX_ComuLoseCNT_Default check one time
   230 010D8 14E8 C        	JMP                 Communicating_CHN_FLAG
   231 010D9 00F9 C        	CLR                 RX_ComuLoseCNT
   232            C        
   233 010DA 0423 C        	MOV                 A,CHN_FLAG
   234 010DB 1B00 C        	XOR                 A,@0B00000000        ; if connect anyone will check niose environment
   235 010DC 0E83 C        	JBS                 STATUS,Z
   236 010DD 14E8 C        	JMP                 Communicating_CHN_FLAG
   237            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   238            C        	;XOR                 PORT5,A
   239            C      M 	PAGE                5
       010DE 0BC3     1     BS  3 , 7 
       010DF 0983     1     BC  3 , 6 
       010E0 0B43     1     BS  3 , 5 
   240 010E1 11AC C        	CALL                Reset_RF_FIFO
   241 010E2 1276 C        	CALL                Enter_StandbyII_Mode
   242 010E3 12D4 C        	CALL                RSSI_TEST_FUNCTION
   243 010E4 1276 C        	CALL                Enter_StandbyII_Mode
   244            C      M 	PAGE                4
       010E5 0BC3     1     BS  3 , 7 
       010E6 0983     1     BC  3 , 6 
       010E7 0943     1     BC  3 , 5 
   245 010E8      C          Communicating_CHN_FLAG:
   246 010E8 0000 C         	NOP
   247 010E9 0012 C        	RET
   248 010EA 0000 C        	NOP
   249            C        
   250            C        ;=====================================================================
   251            C        ; BANK exchange function
   252            C        ;=====================================================================
   253 010EB      C        PAGE4BANK0:
   254 010EB 09C4 C        	BC                  0X04,7
   255 010EC 0984 C        	BC                  0X04,6
   256 010ED 0012 C        	RET
   257 010EE      C        PAGE4BANK1:
   258 010EE 09C4 C        	BC                  0X04,7
   259 010EF 0B84 C        	BS                  0X04,6
   260 010F0 0012 C        	RET
   261 010F1      C        PAGE4BANK2:
   262 010F1 0BC4 C        	BS                  0X04,7
   263 010F2 0984 C        	BC                  0X04,6
   264 010F3 0012 C        	RET
   265 010F4      C        PAGE4BANK3:
   266 010F4 0BC4 C        	BS                  0X04,7
   267 010F5 0B84 C        	BS                  0X04,6
   268 010F6 0012 C        	RET
   269            C        
   270            C        
   271            C        
   272            C        
    15            C        
    16            C        ifndef M611rxP40.H
    17            C        include "M611rxP40.H"
    18            C        endif
    19            C        
    20            C        ifndef EM78CtrlIns.H
    21            C        include "EM78CtrlIns.H"
    22            C        endif
    23            C        
    24            C        ;=========================================================================
    25            C        
    26            C        
    27            C        
    28            C        	ORG                 0X200    ;PAGE 0
    29            C          if MassageDisplay == 1
    30            C        	MESSAGE "define 'M611SKIPFREQFUN.ASM' ROM address"
    31            C          endif
    32            C        ;=======================================================================
    33            C        ; Sync    Communication function
    34            C        ; input:  none
    35            C        ; output: none
    36            C        ;=======================================================================
    37 00200      C        SYNC_COM_TX:
    38 00200 00DB C        	CLR                 ComuClock
    39 00201 0004 C        	WDTC
    40            C      M 	PAGE                5
       00202 0BC3     1     BS  3 , 7 
       00203 0983     1     BC  3 , 6 
       00204 0B43     1     BS  3 , 5 
    41 00205 11AC C        	CALL                Reset_RF_FIFO
    42 00206 1276 C        	CALL                Enter_StandbyII_Mode
    43 00207 12AF C        	CALL                RF_FREQ_SET
    44            C      M 	PAGE                4
       00208 0BC3     1     BS  3 , 7 
       00209 0983     1     BC  3 , 6 
       0020A 0943     1     BC  3 , 5 
    45 0020B 1000 C         	CALL                CommTypeScan_Func
    46            C      M  	PAGE                0
       0020C 09C3     1     BC  3 , 7 
       0020D 0983     1     BC  3 , 6 
       0020E 0943     1     BC  3 , 5 
    47 0020F 0000 C         	NOP
    48            C      M 	Clearbuffer
       00210 1820     1     MOV A,@( 32 )
       00211 0044     1     MOV  R4 ,A
       00212 0004     1     WDTC 
       00213 00C0     1     CLR  R0 ,
       00214 0544     1     INC  R4 ,
       00215 183F     1     MOV A,@( 63 )
       00216 0284     1     AND A, R4 
       00217 1B3F     1     XOR A,@( 63 )
       00218 0E83     1     JBS  R3 , Z 
       00219 1612     1     JMP ( $ - 7 ),
       0021A 00C0     1     CLR  R0 ,
       0021B 00C4     1     CLR  R4 ,
    49            C        ;-----------------------------------------------------------------
    50 0021C 041B C        	MOV                 A,ComuClock                  ; ComuClock == 6 will continue
    51 0021D 1D00 C        	SUB                 A,@0
    52 0021E 0C03 C        	JBC                 STATUS,C
    53 0021F 161C C        	JMP                 $-3
    54            C        ;-----------------------------------------------------------------
    55 00220 11BA C        	CALL                PAGE0BANK0
    56 00221 1800 C        	MOV                 A,@0X00
    57 00222 0060 C        	MOV                 PID_DATA_Buffer,A            ;PID_DATA
    58 00223 11BD C        	CALL                PAGE0BANK1
    59 00224 0421 C        	MOV                 A,RX_IDH
    60 00225 11BA C        	CALL                PAGE0BANK0
    61 00226 0061 C        	MOV                 RX_IDH_Buffer,A              ;RX_IDH
    62 00227 11BD C        	CALL                PAGE0BANK1
    63 00228 0422 C        	MOV                 A,RX_IDL
    64 00229 11BA C        	CALL                PAGE0BANK0
    65 0022A 0062 C        	MOV                 RX_IDL_Buffer,A              ;RX_IDL
    66 0022B 11BD C        	CALL                PAGE0BANK1
    67 0022C 0423 C        	MOV                 A,CHN_FLAG
    68 0022D 11BA C        	CALL                PAGE0BANK0
    69 0022E 0063 C        	MOV                 CHN_FLAG_Buffer,A            ;CHN_FLAG
    70 0022F 11BD C        	CALL                PAGE0BANK1
    71 00230 1802 C        	MOV                 A,@GamePadsSum_Default
    72 00231 11BA C        	CALL                PAGE0BANK0
    73 00232 0064 C        	MOV                 GamePadsSum_Buffer,A         ;GamePadsSum
    74            C        
    75 00233 041E C        	MOV                 A,CommuStatusFlag
    76 00234 0065 C        	MOV                 CommuStatusFlag_Buffer,A     ;CommuStatusFlag
    77 00235 11BD C        	CALL                PAGE0BANK1
    78 00236 0425 C        	MOV                 A,CH_NO
    79 00237 11BA C        	CALL                PAGE0BANK0
    80 00238 0066 C        	MOV                 CH_NO_Buffer,A               ;CH_NO
    81            C        
    82 00239 0D5E C        	JBC                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
    83 0023A 163C C        	JMP                 Loading_Forcelink_Data
    84 0023B 1645 C        	JMP                 Loading_Communication_Data
    85 0023C      C          Loading_Forcelink_Data:
    86 0023C 11BD C        	CALL                PAGE0BANK1
    87 0023D 0427 C        	MOV                 A,TX1_ID                     ;TX1_ID
    88 0023E 11BA C        	CALL                PAGE0BANK0
    89 0023F 0067 C        	MOV                 TX1_ID_Buffer,A
    90 00240 11BD C        	CALL                PAGE0BANK1
    91 00241 0428 C        	MOV                 A,TX2_ID                     ;TX2_ID
    92 00242 11BA C        	CALL                PAGE0BANK0
    93 00243 0068 C        	MOV                 TX2_ID_Buffer,A
    94 00244 1651 C        	JMP                 Loading_Data_End
    95 00245      C          Loading_Communication_Data:
    96 00245 11BD C        	CALL                PAGE0BANK1
    97 00246 0432 C        	MOV                 A,MOTOR_ID
    98 00247 11BA C        	CALL                PAGE0BANK0
    99 00248 0067 C        	MOV                 MOTOR_ID_Buffer,A
   100 00249 11C0 C        	CALL                PAGE0BANK2
   101 0024A 043C C        	MOV                 A,MOTOR1_VibrInten
   102 0024B 11BA C        	CALL                PAGE0BANK0
   103 0024C 0068 C        	MOV                 MOTOR1_VibrInten_Buffer,A
   104 0024D 11C3 C        	CALL                PAGE0BANK3
   105 0024E 043C C        	MOV                 A,MOTOR2_VibrInten
   106 0024F 11BA C        	CALL                PAGE0BANK0
   107 00250 0069 C        	MOV                 MOTOR2_VibrInten_Buffer,A
   108 00251      C          Loading_Data_End:
   109 00251 18CD C        	MOV                 A,@SetChecksumH
   110 00252 007E C        	MOV                 ChecksumH,A
   111 00253 18EF C        	MOV                 A,@SetChecksumL
   112 00254 007F C        	MOV                 ChecksumL,A
   113 00255 0000 C        	NOP
   114            C        
   115            C        ;-------------------------------------------------------------------
   116 00256 1807 C        	MOV                 A,@7
   117            C      M 	PAGE                5
       00257 0BC3     1     BS  3 , 7 
       00258 0983     1     BC  3 , 6 
       00259 0B43     1     BS  3 , 5 
   118 0025A 12FC C        	CALL                DELAY_X100US
   119 0025B 11CA C        	CALL                Enter_TX_Buffer_NACK
   120 0025C 119A C        	CALL                Write_FIFO_RAM
   121            C      M 	PAGE                0
       0025D 09C3     1     BC  3 , 7 
       0025E 0983     1     BC  3 , 6 
       0025F 0943     1     BC  3 , 5 
   122            C        ;---------------------------------------------------------------------------------
   123 00260 18D1 C        	MOV                 A,@(256-47)               ; N=47,P=64,f=4MHz ==> T=1ms
   124 00261 0041 C        	MOV                 TCC,A                     ; TCC reload by PKT pull high
   125            C          if COMMU_T_DEBUG & COMMU_DEBUG & DebugDisplay == 1
   126 00262 1880 C        	MOV                 A,@0X80                   ; (test)P57 exchange when intrrupt
   127 00263 0345 C        	XOR                 PORT5,A
   128            C          endif
   129 00264 00DB C        	CLR                 ComuClock                 ; ComuClock = 0
   130            C        ;-----------------------------------------------------------------------------------
   131 00265 0000 C        	NOP
   132 00266 0012 C        	RET
   133 00267 0000 C        	NOP
   134            C        
   135            C        ;*****************************************************************
   136            C        ;Function:    Mode select
   137            C        ;Input:
   138            C        ;Output:      None
   139            C        ;desciption:  set timing and select mode
   140            C        ;*****************************************************************
   141 00268      C        SearchLinkMode_Set: ;0x11
   142 00268 0A1E C        	BS                  SearchStatusFlag/8,SearchStatusFlag%8            ;set search mode
   143 00269 085E C        	BC                  NormalStatusFlag/8,NormalStatusFlag%8            ;Clear normal mode
   144 0026A 08DE C        	BC                  EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   145 0026B 0B1E C        	BS                  LinkModeFlag/8,LinkModeFlag%8
   146 0026C 095E C        	BC                  ForceLinkModeFlag/8,ForceLinkModeFlag%8
   147 0026D 099E C        	BC                  FccTestModeFlag/8,FccTestModeFlag%8
   148 0026E 0012 C        	RET
   149 0026F      C        NormalLinkMode_Set: ;0x12
   150 0026F 081E C        	BC                  SearchStatusFlag/8,SearchStatusFlag%8            ;set search mode
   151 00270 0A5E C        	BS                  NormalStatusFlag/8,NormalStatusFlag%8            ;Clear normal mode
   152 00271 08DE C        	BC                  EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   153 00272 0B1E C        	BS                  LinkModeFlag/8,LinkModeFlag%8
   154 00273 095E C        	BC                  ForceLinkModeFlag/8,ForceLinkModeFlag%8
   155 00274 099E C        	BC                  FccTestModeFlag/8,FccTestModeFlag%8
   156 00275 0012 C        	RET
   157 00276      C        SearchForceLinkMode_Set: ;0x21
   158 00276 0A1E C        	BS                  SearchStatusFlag/8,SearchStatusFlag%8            ;set search mode
   159 00277 085E C        	BC                  NormalStatusFlag/8,NormalStatusFlag%8            ;Clear normal mode
   160 00278 08DE C        	BC                  EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   161 00279 091E C        	BC                  LinkModeFlag/8,LinkModeFlag%8
   162 0027A 0B5E C        	BS                  ForceLinkModeFlag/8,ForceLinkModeFlag%8
   163 0027B 099E C        	BC                  FccTestModeFlag/8,FccTestModeFlag%8
   164 0027C 0012 C        	RET
   165 0027D      C        NormalFccLinkMode_Set: ;0x42
   166 0027D 081E C        	BC                  SearchStatusFlag/8,SearchStatusFlag%8            ;set search mode
   167 0027E 0A5E C        	BS                  NormalStatusFlag/8,NormalStatusFlag%8            ;Clear normal mode
   168 0027F 08DE C        	BC                  EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   169 00280 091E C        	BC                  LinkModeFlag/8,LinkModeFlag%8
   170 00281 095E C        	BC                  ForceLinkModeFlag/8,ForceLinkModeFlag%8
   171 00282 0B9E C        	BS                  FccTestModeFlag/8,FccTestModeFlag%8
   172 00283 0012 C        	RET
   173            C        
   174            C        
   175            C        
   176            C        ;***************************************************************************
   177            C        ; gamepad skip frequency RX1-RX4
   178            C        ;***************************************************************************
   179            C        	ORG                 0X400    ;PAGE 1
   180            C        ;========================================================================
   181            C        ;=========================================================================
   182            C        ;Function:  setting
   183            C        ;Input:
   184            C        ;Output:    None
   185            C        ;=========================================================================
   186 00400      C        RX1_FUNCTION:
   187 00400 0004 C        	WDTC
   188            C      M 	PAGE                5
       00401 0BC3     1     BS  3 , 7 
       00402 0983     1     BC  3 , 6 
       00403 0B43     1     BS  3 , 5 
   189 00404 11AC C        	CALL                RESET_RF_FIFO
   190 00405 1276 C        	CALL                Enter_StandbyII_Mode
   191 00406 120C C        	CALL                ENTER_RX_BUFFER_ACK
   192            C      M 	PAGE                1
       00407 09C3     1     BC  3 , 7 
       00408 0983     1     BC  3 , 6 
       00409 0B43     1     BS  3 , 5 
   193            C        
   194 0040A      C          RX1_DETECT_LOOP:
   195 0040A 041B C        	MOV                 A,ComuClock                  ;ComuClock == 4 will continue
   196 0040B 1D03 C        	SUB                 A,@3
   197 0040C 0E03 C        	JBS                 STATUS,C
   198 0040D 147A C        	JMP                 RX1_Detect_Timeout           ; RX1,Timeout but have not received TX data
   199 0040E 0F86 C        	JBS                 PKT_FLAG/8,PKT_FLAG%8	     ; 1:TX data receive finished  0:wating PKT pull high
   200 0040F 140A C        	JMP                 RX1_DETECT_LOOP
   201 00410 0000 C        	NOP
   202            C      M 	Clearbuffer
       00411 1820     1     MOV A,@( 32 )
       00412 0044     1     MOV  R4 ,A
       00413 0004     1     WDTC 
       00414 00C0     1     CLR  R0 ,
       00415 0544     1     INC  R4 ,
       00416 183F     1     MOV A,@( 63 )
       00417 0284     1     AND A, R4 
       00418 1B3F     1     XOR A,@( 63 )
       00419 0E83     1     JBS  R3 , Z 
       0041A 1413     1     JMP ( $ - 7 ),
       0041B 00C0     1     CLR  R0 ,
       0041C 00C4     1     CLR  R4 ,
   203            C      M 	PAGE                5
       0041D 0BC3     1     BS  3 , 7 
       0041E 0983     1     BC  3 , 6 
       0041F 0B43     1     BS  3 , 5 
   204 00420 1187 C        	CALL                READ_FIFO_RAM
   205 00421 1276 C        	CALL                Enter_StandbyII_Mode
   206            C      M 	PAGE                1
       00422 09C3     1     BC  3 , 7 
       00423 0983     1     BC  3 , 6 
       00424 0B43     1     BS  3 , 5 
   207            C        
   208            C        ;------------------- check sync imformation ---------------------
   209 00425 1163 C        	CALL                PAGE1BANK1
   210 00426 0421 C        	MOV                 A,RX_IDH
   211 00427 1160 C        	CALL                PAGE1BANK0
   212 00428 0361 C        	XOR                 RX_IDH_Buffer,A
   213 00429 0E83 C        	JBS                 STATUS,Z
   214 0042A 1486 C        	JMP                 LoseFrameStatus_RxTxID1_Error  ; RX_IDH ERROR
   215 0042B 1163 C        	CALL                PAGE1BANK1
   216 0042C 0422 C        	MOV                 A,RX_IDL
   217 0042D 1160 C        	CALL                PAGE1BANK0
   218 0042E 0362 C        	XOR                 RX_IDL_Buffer,A
   219 0042F 0E83 C        	JBS                 STATUS,Z
   220 00430 1486 C        	JMP                 LoseFrameStatus_RxTxID1_Error  ; RX_IDL ERROR
   221 00431 1163 C        	CALL                PAGE1BANK1
   222 00432 0427 C        	MOV                 A,TX1_ID
   223 00433 1160 C        	CALL                PAGE1BANK0
   224 00434 0367 C        	XOR                 TX_ID_Buffer,A
   225 00435 0E83 C        	JBS                 STATUS,Z
   226 00436 1486 C        	JMP                 LoseFrameStatus_RxTxID1_Error  ; TX_ID ERROR
   227 00437 0000 C        	NOP
   228            C        
   229            C        ;---------------------------------------------------------------
   230 00438 1160 C        	CALL                PAGE1BANK0                       ; Save data from buffer to local
   231 00439 0428 C        	MOV                 A,DataA_Buffer
   232 0043A 1166 C        	CALL                PAGE1BANK2
   233 0043B 0060 C        	MOV                 TX1_DATA1,A
   234 0043C 1160 C        	CALL                PAGE1BANK0
   235 0043D 0429 C        	MOV                 A,DataB_Buffer
   236 0043E 1166 C        	CALL                PAGE1BANK2
   237 0043F 0061 C        	MOV                 TX1_DATA2,A
   238 00440 1160 C        	CALL                PAGE1BANK0
   239 00441 042A C        	MOV                 A,DataC_Buffer
   240 00442 1166 C        	CALL                PAGE1BANK2
   241 00443 0062 C        	MOV                 TX1_DATA3,A
   242 00444 1160 C        	CALL                PAGE1BANK0
   243 00445 042B C        	MOV                 A,DataD_Buffer
   244 00446 1166 C        	CALL                PAGE1BANK2
   245 00447 0063 C        	MOV                 TX1_DATA4,A
   246 00448 1160 C        	CALL                PAGE1BANK0
   247 00449 042C C        	MOV                 A,DataE_Buffer
   248 0044A 1166 C        	CALL                PAGE1BANK2
   249 0044B 0064 C        	MOV                 TX1_DATA5,A
   250 0044C 1160 C        	CALL                PAGE1BANK0
   251 0044D 042D C        	MOV                 A,DataF_Buffer
   252 0044E 1166 C        	CALL                PAGE1BANK2
   253 0044F 0065 C        	MOV                 TX1_DATA6,A
   254 00450 1160 C        	CALL                PAGE1BANK0
   255 00451 042E C        	MOV                 A,DataG_Buffer
   256 00452 1166 C        	CALL                PAGE1BANK2
   257 00453 0066 C        	MOV                 TX1_DATA7,A
   258            C        
   259 00454 1160 C        	CALL                PAGE1BANK0
   260 00455 042F C        	MOV                 A,CMOS_xAxisL_Buffer
   261 00456 1166 C        	CALL                PAGE1BANK2
   262 00457 0071 C        	MOV                 TX1_CMOS_xAxisL,A          ; CMOS x Axis low byte
   263 00458 1160 C        	CALL                PAGE1BANK0
   264 00459 0430 C        	MOV                 A,CMOS_yAxisL_Buffer
   265 0045A 1166 C        	CALL                PAGE1BANK2
   266 0045B 0073 C        	MOV                 TX1_CMOS_yAxisL,A          ; CMOS y Axis low byte
   267 0045C 1160 C        	CALL                PAGE1BANK0
   268 0045D 0431 C        	MOV                 A,CMOS_yxsAxisH_Buffer
   269 0045E 1166 C        	CALL                PAGE1BANK2
   270 0045F 0074 C        	MOV                 TX1_CMOS_yxsAxisH,A        ; CMOS point size low byte
   271            C        
   272 00460 1160 C        	CALL                PAGE1BANK0
   273 00461 0432 C        	MOV                 A,GS_xAxisL_Buffer
   274 00462 1166 C        	CALL                PAGE1BANK2
   275 00463 0076 C        	MOV                 TX1_GS_xAxisL,A            ; GS x Axis low byte
   276 00464 1160 C        	CALL                PAGE1BANK0
   277 00465 0433 C        	MOV                 A,GS_yAxisL_Buffer
   278 00466 1166 C        	CALL                PAGE1BANK2
   279 00467 0078 C        	MOV                 TX1_GS_yAxisL,A            ; GS y Axis low byte
   280 00468 1160 C        	CALL                PAGE1BANK0
   281 00469 0434 C        	MOV                 A,GS_zAxisL_Buffer
   282 0046A 1166 C        	CALL                PAGE1BANK2
   283 0046B 007A C        	MOV                 TX1_GS_zAxisL,A            ; GS z Axis low byte
   284 0046C 1160 C        	CALL                PAGE1BANK0
   285 0046D 0435 C        	MOV                 A,GS_xyzAxisH_Buffer
   286 0046E 1166 C        	CALL                PAGE1BANK2
   287 0046F 007B C        	MOV                 TX1_GS_xyzAxisH,A          ; GS z Axis high byte
   288            C        
   289 00470 1163 C        	CALL                PAGE1BANK1
   290 00471 0A23 C        	BS                  CHN_FLAG,RX1
   291 00472 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   292 00473 149F C        	JMP                 EP1_REPORT_RX1
   293 00474 0C33 C        	JBC                 CHN_FLAG_TEMP,RX1             ; CHN_FLAG rising edge
   294 00475 14A6 C        	JMP                 Clear_RX1_LossframeCNT
   295 00476 08C9 C        	BC                  LED1_STATUS/8,LED1_STATUS%8   ;
   296 00477 00D7 C        	CLR                 SystemTimeCNT
   297 00478 14A6 C        	JMP                 Clear_RX1_LossframeCNT
   298 00479 0000 C        	NOP
   299            C        
   300            C        ;-------------------------------------------------------------------------
   301 0047A      C          Rx1_Detect_Timeout:
   302 0047A 0000 C        	NOP
   303 0047B 1163 C        	CALL                PAGE1BANK1
   304 0047C 0E23 C        	JBS                 CHN_FLAG,RX1                              ; Lossframe Status
   305 0047D 14A6 C        	JMP                 Clear_RX1_LossframeCNT                    ; if not SearchStatus,it must be in NormalStatus
   306 0047E 043A C        	MOV                 A,RX1_LossframeCNT                        ; result = constant - variable
   307 0047F 1D05 C        	SUB                 A,@RX1_LossframeSum                       ;   | result > 0   c=1  variable less than constant
   308 00480 0C03 C        	JBC                 STATUS,C	                              ;   | result < 0   c=0  variable more than constant
   309 00481 1492 C        	JMP                 Increase_RX1_LossframeCNT
   310 00482 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   311 00483 0823 C        	BC                  CHN_FLAG,RX1
   312 00484 14A6 C        	JMP                 Clear_RX1_LossframeCNT
   313 00485 0000 C        	NOP
   314            C        ;-----------------------------------------------------------------------------
   315 00486      C          LoseFrameStatus_RxTxID1_Error:
   316 00486 0000 C        	NOP
   317 00487 1163 C        	CALL                PAGE1BANK1
   318 00488 0E23 C        	JBS                 CHN_FLAG,RX1
   319 00489 14A6 C        	JMP                 Clear_RX1_LossframeCNT
   320 0048A 043A C        	MOV                 A,RX1_LossframeCNT                       ; RX1_LossframeSum times lossframe
   321 0048B 1D05 C        	SUB                 A,@RX1_LossframeSum
   322 0048C 0C03 C        	JBC                 STATUS,C
   323 0048D 1492 C        	JMP                 Increase_RX1_LossframeCNT
   324 0048E 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   325 0048F 0823 C        	BC                  CHN_FLAG,RX1
   326 00490 14A6 C        	JMP                 Clear_RX1_LossframeCNT
   327 00491 0000 C        	NOP
   328            C        
   329            C        ;--------------------------------------------------------------------------------
   330 00492      C          Increase_RX1_LossframeCNT:
   331 00492 0000 C        	NOP
   332 00493 057A C        	INC                 RX1_LossframeCNT
   333 00494 1800 C        	MOV                 A,@RX1
   334 00495 0070 C        	MOV                 EP1_ReportID,A
   335            C      M 	PAGE                4
       00496 0BC3     1     BS  3 , 7 
       00497 0983     1     BC  3 , 6 
       00498 0943     1     BC  3 , 5 
   336 00499 1316 C        	CALL                EP1_Report_Default
   337            C      M 	PAGE                1
       0049A 09C3     1     BC  3 , 7 
       0049B 0983     1     BC  3 , 6 
       0049C 0B43     1     BS  3 , 5 
   338 0049D 14A7 C        	JMP                 RX1_Over_Judge
   339 0049E 0000 C        	NOP
   340 0049F      C          EP1_REPORT_RX1:
   341            C      M 	PAGE                4
       0049F 0BC3     1     BS  3 , 7 
       004A0 0983     1     BC  3 , 6 
       004A1 0943     1     BC  3 , 5 
   342 004A2 132A C        	CALL                EP1_Report_1st
   343            C      M 	PAGE                1
       004A3 09C3     1     BC  3 , 7 
       004A4 0983     1     BC  3 , 6 
       004A5 0B43     1     BS  3 , 5 
   344 004A6      C          Clear_RX1_LossframeCNT:
   345 004A6 00FA C        	CLR                 RX1_LossframeCNT
   346 004A7      C          RX1_Over_Judge:
   347 004A7 041B C        	MOV                 A,ComuClock                  ; ComuClock == 4 will continue
   348 004A8 1D03 C        	SUB                 A,@3
   349 004A9 0C03 C        	JBC                 STATUS,C
   350 004AA 14A7 C        	JMP                 $-3
   351 004AB 0B06 C        	BS                  SPI_SS/8,SPI_SS%8          ; Dissable RF
   352 004AC 0000 C        	NOP
   353 004AD 0012 C        	RET
   354 004AE 0000 C        	NOP
   355            C        
   356            C        
   357            C        
   358            C        ;========================================================================
   359            C        ;=========================================================================
   360            C        ;Function:  setting
   361            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   362            C        ;Output:    None
   363            C        ;=========================================================================
   364 004AF      C        RX2_FUNCTION:
   365 004AF 0004 C        	WDTC
   366            C      M 	PAGE                5
       004B0 0BC3     1     BS  3 , 7 
       004B1 0983     1     BC  3 , 6 
       004B2 0B43     1     BS  3 , 5 
   367 004B3 11AC C        	CALL                RESET_RF_FIFO
   368 004B4 1276 C        	CALL                Enter_StandbyII_Mode
   369 004B5 120C C        	CALL                ENTER_RX_BUFFER_ACK
   370            C      M 	PAGE                1
       004B6 09C3     1     BC  3 , 7 
       004B7 0983     1     BC  3 , 6 
       004B8 0B43     1     BS  3 , 5 
   371            C        
   372 004B9      C          RX2_DETECT_LOOP:
   373 004B9 041B C        	MOV                 A,ComuClock                  ;ComuClock == 4 will continue
   374 004BA 1D07 C        	SUB                 A,@7
   375 004BB 0E03 C        	JBS                 STATUS,C
   376 004BC 1529 C        	JMP                 RX2_Detect_Timeout           ; RX2,Timeout but have not received TX data
   377 004BD 0F86 C        	JBS                 PKT_FLAG/8,PKT_FLAG%8	     ; 1:TX data receive finished  0:wating PKT pull high
   378 004BE 14B9 C        	JMP                 RX2_DETECT_LOOP
   379 004BF 0000 C        	NOP
   380            C      M 	Clearbuffer
       004C0 1820     1     MOV A,@( 32 )
       004C1 0044     1     MOV  R4 ,A
       004C2 0004     1     WDTC 
       004C3 00C0     1     CLR  R0 ,
       004C4 0544     1     INC  R4 ,
       004C5 183F     1     MOV A,@( 63 )
       004C6 0284     1     AND A, R4 
       004C7 1B3F     1     XOR A,@( 63 )
       004C8 0E83     1     JBS  R3 , Z 
       004C9 14C2     1     JMP ( $ - 7 ),
       004CA 00C0     1     CLR  R0 ,
       004CB 00C4     1     CLR  R4 ,
   381            C      M 	PAGE                5
       004CC 0BC3     1     BS  3 , 7 
       004CD 0983     1     BC  3 , 6 
       004CE 0B43     1     BS  3 , 5 
   382 004CF 1187 C        	CALL                READ_FIFO_RAM
   383 004D0 1276 C        	CALL                Enter_StandbyII_Mode
   384            C      M 	PAGE                1
       004D1 09C3     1     BC  3 , 7 
       004D2 0983     1     BC  3 , 6 
       004D3 0B43     1     BS  3 , 5 
   385            C        
   386            C        ;------------------- check sync imformation ---------------------
   387 004D4 1163 C        	CALL                PAGE1BANK1
   388 004D5 0421 C        	MOV                 A,RX_IDH
   389 004D6 1160 C        	CALL                PAGE1BANK0
   390 004D7 0361 C        	XOR                 RX_IDH_Buffer,A
   391 004D8 0E83 C        	JBS                 STATUS,Z
   392 004D9 1535 C        	JMP                 LoseFrameStatus_RxTxID2_Error  ; RX_IDH ERROR
   393 004DA 1163 C        	CALL                PAGE1BANK1
   394 004DB 0422 C        	MOV                 A,RX_IDL
   395 004DC 1160 C        	CALL                PAGE1BANK0
   396 004DD 0362 C        	XOR                 RX_IDL_Buffer,A
   397 004DE 0E83 C        	JBS                 STATUS,Z
   398 004DF 1535 C        	JMP                 LoseFrameStatus_RxTxID2_Error  ; RX_IDL ERROR
   399 004E0 1163 C        	CALL                PAGE1BANK1
   400 004E1 0428 C        	MOV                 A,TX2_ID
   401 004E2 1160 C        	CALL                PAGE1BANK0
   402 004E3 0367 C        	XOR                 TX_ID_Buffer,A
   403 004E4 0E83 C        	JBS                 STATUS,Z
   404 004E5 1535 C        	JMP                 LoseFrameStatus_RxTxID2_Error  ; TX_ID ERROR
   405 004E6 0000 C        	NOP
   406            C        
   407            C        ;---------------------------------------------------------------
   408 004E7 1160 C        	CALL                PAGE1BANK0                       ; Save data from buffer to local
   409 004E8 0428 C        	MOV                 A,DataA_Buffer
   410 004E9 1166 C        	CALL                PAGE1BANK2
   411 004EA 0060 C        	MOV                 TX2_DATA1,A
   412 004EB 1160 C        	CALL                PAGE1BANK0
   413 004EC 0429 C        	MOV                 A,DataB_Buffer
   414 004ED 1166 C        	CALL                PAGE1BANK2
   415 004EE 0061 C        	MOV                 TX2_DATA2,A
   416 004EF 1160 C        	CALL                PAGE1BANK0
   417 004F0 042A C        	MOV                 A,DataC_Buffer
   418 004F1 1166 C        	CALL                PAGE1BANK2
   419 004F2 0062 C        	MOV                 TX2_DATA3,A
   420 004F3 1160 C        	CALL                PAGE1BANK0
   421 004F4 042B C        	MOV                 A,DataD_Buffer
   422 004F5 1166 C        	CALL                PAGE1BANK2
   423 004F6 0063 C        	MOV                 TX2_DATA4,A
   424 004F7 1160 C        	CALL                PAGE1BANK0
   425 004F8 042C C        	MOV                 A,DataE_Buffer
   426 004F9 1166 C        	CALL                PAGE1BANK2
   427 004FA 0064 C        	MOV                 TX2_DATA5,A
   428 004FB 1160 C        	CALL                PAGE1BANK0
   429 004FC 042D C        	MOV                 A,DataF_Buffer
   430 004FD 1166 C        	CALL                PAGE1BANK2
   431 004FE 0065 C        	MOV                 TX2_DATA6,A
   432 004FF 1160 C        	CALL                PAGE1BANK0
   433 00500 042E C        	MOV                 A,DataG_Buffer
   434 00501 1166 C        	CALL                PAGE1BANK2
   435 00502 0066 C        	MOV                 TX2_DATA7,A
   436            C        
   437 00503 1160 C        	CALL                PAGE1BANK0
   438 00504 042F C        	MOV                 A,CMOS_xAxisL_Buffer
   439 00505 1166 C        	CALL                PAGE1BANK2
   440 00506 0071 C        	MOV                 TX2_CMOS_xAxisL,A          ; CMOS x Axis low byte
   441 00507 1160 C        	CALL                PAGE1BANK0
   442 00508 0430 C        	MOV                 A,CMOS_yAxisL_Buffer
   443 00509 1166 C        	CALL                PAGE1BANK2
   444 0050A 0073 C        	MOV                 TX2_CMOS_yAxisL,A          ; CMOS y Axis low byte
   445 0050B 1160 C        	CALL                PAGE1BANK0
   446 0050C 0431 C        	MOV                 A,CMOS_yxsAxisH_Buffer
   447 0050D 1166 C        	CALL                PAGE1BANK2
   448 0050E 0074 C        	MOV                 TX2_CMOS_yxsAxisH,A        ; CMOS point size low byte
   449            C        
   450 0050F 1160 C        	CALL                PAGE1BANK0
   451 00510 0432 C        	MOV                 A,GS_xAxisL_Buffer
   452 00511 1166 C        	CALL                PAGE1BANK2
   453 00512 0076 C        	MOV                 TX2_GS_xAxisL,A            ; GS x Axis low byte
   454 00513 1160 C        	CALL                PAGE1BANK0
   455 00514 0433 C        	MOV                 A,GS_yAxisL_Buffer
   456 00515 1166 C        	CALL                PAGE1BANK2
   457 00516 0078 C        	MOV                 TX2_GS_yAxisL,A            ; GS y Axis low byte
   458 00517 1160 C        	CALL                PAGE1BANK0
   459 00518 0434 C        	MOV                 A,GS_zAxisL_Buffer
   460 00519 1166 C        	CALL                PAGE1BANK2
   461 0051A 007A C        	MOV                 TX2_GS_zAxisL,A            ; GS z Axis low byte
   462 0051B 1160 C        	CALL                PAGE1BANK0
   463 0051C 0435 C        	MOV                 A,GS_xyzAxisH_Buffer
   464 0051D 1166 C        	CALL                PAGE1BANK2
   465 0051E 007B C        	MOV                 TX2_GS_xyzAxisH,A          ; GS z Axis high byte
   466            C        
   467 0051F 1163 C        	CALL                PAGE1BANK1
   468 00520 0A63 C        	BS                  CHN_FLAG,RX2
   469 00521 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   470 00522 154E C        	JMP                 EP1_REPORT_RX2
   471 00523 0C73 C        	JBC                 CHN_FLAG_TEMP,RX2             ; CHN_FLAG rising edge
   472 00524 1555 C        	JMP                 Clear_RX2_LossframeCNT
   473 00525 08C9 C        	BC                  LED1_STATUS/8,LED1_STATUS%8   ;
   474 00526 00D7 C        	CLR                 SystemTimeCNT
   475 00527 1555 C        	JMP                 Clear_RX2_LossframeCNT
   476 00528 0000 C        	NOP
   477            C        
   478            C        ;-------------------------------------------------------------------------
   479 00529      C          RX2_Detect_Timeout:
   480 00529 0000 C        	NOP
   481 0052A 1163 C        	CALL                PAGE1BANK1
   482 0052B 0E63 C        	JBS                 CHN_FLAG,RX2                              ; Lossframe Status
   483 0052C 1555 C        	JMP                 Clear_RX2_LossframeCNT                    ; if not SearchStatus,it must be in NormalStatus
   484 0052D 043B C        	MOV                 A,RX2_LossframeCNT                        ; result = constant - variable
   485 0052E 1D01 C        	SUB                 A,@RX2_LossframeSum                       ;   | result > 0   c=1  variable less than constant
   486 0052F 0C03 C        	JBC                 STATUS,C	                              ;   | result < 0   c=0  variable more than constant
   487 00530 1541 C        	JMP                 Increase_RX2_LossframeCNT
   488 00531 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   489 00532 0863 C        	BC                  CHN_FLAG,RX2
   490 00533 1555 C        	JMP                 Clear_RX2_LossframeCNT
   491 00534 0000 C        	NOP
   492            C        ;-----------------------------------------------------------------------------
   493 00535      C          LoseFrameStatus_RxTxID2_Error:
   494 00535 0000 C        	NOP
   495 00536 1163 C        	CALL                PAGE1BANK1
   496 00537 0E63 C        	JBS                 CHN_FLAG,RX2
   497 00538 1555 C        	JMP                 Clear_RX2_LossframeCNT
   498 00539 043B C        	MOV                 A,RX2_LossframeCNT                       ; RX2_LossframeSum times lossframe
   499 0053A 1D01 C        	SUB                 A,@RX2_LossframeSum
   500 0053B 0C03 C        	JBC                 STATUS,C
   501 0053C 1541 C        	JMP                 Increase_RX2_LossframeCNT
   502 0053D 0F5E C        	JBS                 ForceLinkModeFlag/8,ForceLinkModeFlag%8
   503 0053E 0863 C        	BC                  CHN_FLAG,RX2
   504 0053F 1555 C        	JMP                 Clear_RX2_LossframeCNT
   505 00540 0000 C        	NOP
   506            C        
   507            C        ;--------------------------------------------------------------------------------
   508 00541      C          Increase_RX2_LossframeCNT:
   509 00541 0000 C        	NOP
   510 00542 057B C        	INC                 RX2_LossframeCNT
   511 00543 1801 C        	MOV                 A,@RX2
   512 00544 0070 C        	MOV                 EP1_ReportID,A
   513            C      M 	PAGE                4
       00545 0BC3     1     BS  3 , 7 
       00546 0983     1     BC  3 , 6 
       00547 0943     1     BC  3 , 5 
   514 00548 1316 C        	CALL                EP1_Report_Default
   515            C      M 	PAGE                1
       00549 09C3     1     BC  3 , 7 
       0054A 0983     1     BC  3 , 6 
       0054B 0B43     1     BS  3 , 5 
   516 0054C 1556 C        	JMP                 RX2_Over_Judge
   517 0054D 0000 C        	NOP
   518 0054E      C          EP1_REPORT_RX2:
   519            C      M 	PAGE                4
       0054E 0BC3     1     BS  3 , 7 
       0054F 0983     1     BC  3 , 6 
       00550 0943     1     BC  3 , 5 
   520 00551 133E C        	CALL                EP1_Report_2nd
   521            C      M 	PAGE                1
       00552 09C3     1     BC  3 , 7 
       00553 0983     1     BC  3 , 6 
       00554 0B43     1     BS  3 , 5 
   522 00555      C          Clear_RX2_LossframeCNT:
   523 00555 00FB C        	CLR                 RX2_LossframeCNT
   524 00556      C          RX2_Over_Judge:
   525 00556 041B C        	MOV                 A,ComuClock                  ; ComuClock == 4 will continue
   526 00557 1D07 C        	SUB                 A,@7
   527 00558 0C03 C        	JBC                 STATUS,C
   528 00559 1556 C        	JMP                 $-3
   529 0055A 0B06 C        	BS                  SPI_SS/8,SPI_SS%8          ; Dissable RF
   530 0055B 0000 C        	NOP
   531 0055C 0012 C        	RET
   532 0055D 0000 C        	NOP
   533            C        
   534            C        
   535            C        
   536            C        
   537            C        ;========================================================================
   538            C        ;=========================================================================
   539            C        ;Function:  setting
   540            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   541            C        ;Output:    None
   542            C        ;=========================================================================
   543 0055E      C        RX3_FUNCTION:
   544            C        
   545 0055E 0012 C        	RET
   546            C        
   547            C        
   548            C        ;========================================================================
   549            C        ;=========================================================================
   550            C        ;Function:  setting
   551            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   552            C        ;Output:    None
   553            C        ;=========================================================================
   554 0055F      C        RX4_FUNCTION:
   555            C        
   556 0055F 0012 C        	RET
   557            C        
   558            C        ;=====================================================================
   559            C        ; BANK exchange function
   560            C        ;=====================================================================
   561 00560      C        	PAGE1BANK0:
   562 00560 09C4 C        		BC              0X04,7
   563 00561 0984 C        		BC              0X04,6
   564 00562 0012 C        	RET
   565 00563      C        	PAGE1BANK1:
   566 00563 09C4 C        		BC              0X04,7
   567 00564 0B84 C        		BS              0X04,6
   568 00565 0012 C        	RET
   569 00566      C        	PAGE1BANK2:
   570 00566 0BC4 C        		BS              0X04,7
   571 00567 0984 C        		BC              0X04,6
   572 00568 0012 C        	RET
   573 00569      C        	PAGE1BANK3:
   574 00569 0BC4 C        		BS              0X04,7
   575 0056A 0B84 C        		BS              0X04,6
   576 0056B 0012 C        	RET
   577            C        
   578            C        
   579            C        
   580            C        ;***************************************************************************
   581            C        ; gamepad skip frequency RX5-RX8
   582            C        ;***************************************************************************
   583            C        	ORG                 0X800   ;PAGE 2
   584            C        ;========================================================================
   585            C        ;=========================================================================
   586            C        ;Function:  setting
   587            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   588            C        ;Output:    None
   589            C        ;=========================================================================
   590 00800      C        RX5_FUNCTION:
   591            C        
   592 00800 0012 C        	RET
   593            C        
   594            C        
   595            C        
   596            C        
   597            C        ;========================================================================
   598            C        ;=========================================================================
   599            C        ;Function:  setting
   600            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   601            C        ;Output:    None
   602            C        ;=========================================================================
   603 00801      C        RX6_FUNCTION:
   604            C        
   605 00801 0012 C        	RET
   606            C        
   607            C        
   608            C        
   609            C        ;=====================================================================
   610            C        ; BANK exchange function
   611            C        ;=====================================================================
   612 00802      C        	PAGE2BANK0:
   613 00802 09C4 C        		BC              0X04,7
   614 00803 0984 C        		BC              0X04,6
   615 00804 0012 C        	RET
   616 00805      C        	PAGE2BANK1:
   617 00805 09C4 C        		BC              0X04,7
   618 00806 0B84 C        		BS              0X04,6
   619 00807 0012 C        	RET
   620 00808      C        	PAGE2BANK2:
   621 00808 0BC4 C        		BS              0X04,7
   622 00809 0984 C        		BC              0X04,6
   623 0080A 0012 C        	RET
   624 0080B      C        	PAGE2BANK3:
   625 0080B 0BC4 C        		BS              0X04,7
   626 0080C 0B84 C        		BS              0X04,6
   627 0080D 0012 C        	RET
    20                     include "M611USBDriver.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;=========================================================================
    11            C        M611USBDriver.ASM    EQU    M611USBDriver.ASM
    12            C        
    13            C        
    14            C        include "M611USBDescData.ASM"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        M611USBDescData.ASM    EQU    M611USBDescData.ASM
    12            C        
    13            C        
    14            C        ;********************************************************************************
    15            C        ; initial USB communiate to PC,INITIAL
    16            C        ;********************************************************************************
    17            C        ;============================================================
    18            C        ;	DESCRIPTORS
    19            C        ;============================================================
    20            C        
    21            C        /*
    22            C        		ORG 	0XC00	;PAGE 3
    23            C          if MassageDisplay == 1
    24            C        	MESSAGE "define 'M611USBDescData.ASM' ROM address"
    25            C          endif
    26            C        DEVICE_TABLE:
    27            C        		TBL
    28            C        		;Device Descriptor
    29            C        		RETL	@0X12;01	bLength
    30            C        		RETL	@0X01;02	bDescriptorType
    31            C        		RETL	@0X10;03	bcdUSB
    32            C        		RETL	@0X01;04
    33            C        		RETL	@0X00;05	bDeviceCalss
    34            C        		RETL	@0X00;06	bDeviceSubClass
    35            C        		RETL	@0X00;07	bDeviceProtocol
    36            C        		RETL	@0X08;08	bMaxPacketSize0 ,MCU point0 byte length
    37            C        		RETL	@0XF3;09	idVendor 0X04F3
    38            C        		RETL	@0X04;0A
    39            C        		RETL	@0X1F;0B	idProduct (joystick:0x0f1f)
    40            C        		RETL	@0X0F;0C
    41            C        		RETL	@0X70;0D	bcdDevice v1.7.0
    42            C        		RETL	@0X01;0E
    43            C        		RETL	@0X01;0F	iManufacturer
    44            C        		RETL	@0X02;10	iProduct
    45            C        		RETL	@0X03;11	iSerialNumber
    46            C        		RETL	@0X01;12	bNumConfigurations
    47            C        
    48            C        
    49            C        CONFIG_TABLE:
    50            C        		TBL
    51            C        		;Configuration Descriptor
    52            C        		RETL	@0X09;01	bLength
    53            C        		RETL	@0X02;02	bDescritorType
    54            C        		RETL	@0X22;03	wTotalLength
    55            C        		RETL	@0X00;04
    56            C        		RETL	@0X01;05	bConfigurationValue
    57            C        		RETL	@0X01;06	bNumInterfaces
    58            C        		RETL	@0X00;07	iConfiguration
    59            C        		RETL	@0X80;08	bmAttributes
    60            C        		RETL	@0X32;09	bMaxPower ,Imax=100mA
    61            C        
    62            C        		;Interface Descriptor
    63            C        		RETL	@0X09;0A	bLength
    64            C        		RETL	@0X04;0B	bDescriptorType
    65            C        		RETL	@0X00;0C	bInterfaceNumber
    66            C        		RETL	@0X00;0D	bAlternateSetting
    67            C        		RETL	@0X01;0E	bNumEndpoints
    68            C        		RETL	@0X03;0F	bInterfaceClass (Class:HID)
    69            C        		RETL	@0X00;10	bInterfaceSubClass (BOOT DEVICE)
    70            C        		RETL	@0X00;11	bInterfaceProtocol (joystick)
    71            C        		RETL	@0X00;12	iConfiguration
    72            C        
    73            C        		;HID Descriptor
    74            C        		RETL	@0X09            ;13    bLength
    75            C        		RETL	@0X21            ;14    bDescriptorType
    76            C        		RETL	@0X10            ;15    bcdHID
    77            C        		RETL	@0X01            ;16
    78            C        		RETL	@0X21            ;17    bCountryCode
    79            C        		RETL	@0X01            ;18    bNumDescriptors
    80            C        		RETL	@0X22            ;19    bDescriptorType. report descriptor:0x22, physics descriptor:0x23
    81            C                                                ;1A    bLength of the Report Descriptor ;0XF8
    82            C        		RETL	@(End_HID_Report_Table1-Begin_HID_Report_Table1)+(End_HID_Report_Table2-Begin_HID_Report_HID_Report_Table3)-0X100
    83            C        		RETL	@0X01            ;1B    ;0X01
    84            C        
    85            C        		;Endpoint Descriptor
    86            C        		RETL	@0X07;1C	bLength
    87            C        		RETL	@0X05;1D	bDescriptorType
    88            C        		RETL	@0X81;1E	bEndpointAddress
    89            C        		RETL	@0X03;1F	bmAttributes
    90            C        		RETL	@0X08;20	wMaxPackerSize
    91            C        		RETL	@0X00;21
    92            C        		RETL	@0X05;22	bInterval    ;change 20ms
    93            C        
    94            C        
    95            C        ;---------------------------------------------------------------------
    96            C        ;---------------------------------------------------------------------
    97            C        STRING0T:
    98            C        		;String Descriptor Of Languages
    99            C        		TBL
   100            C        		RETL	@0X04;01	bLength
   101            C        		RETL	@0X03;02	bdescriptorType
   102            C        		RETL	@0X09;03
   103            C        		RETL	@0X04;04	END OF LANGUAGES
   104            C        
   105            C        
   106            C        ;---------------------------------------------------------------------
   107            C        ;---------------------------------------------------------------------
   108            C        		ORG         0XD00
   109            C        HID_REPORT_TABLE1:
   110            C        	TBL
   111            C        	Begin_HID_Report_Table1:
   112            C        ;----------------------------------------------------------
   113            C        	;--REPORT DESCRIPTOR--
   114            C        	RETL @0X05    ;USAGE PAGE
   115            C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   116            C        	RETL @0X09    ;USAGE
   117            C        	RETL @0X04    ;(JOYSTICK)
   118            C        	;{
   119            C        		RETL @0XA1    ;COLLECTION
   120            C        		RETL @0X01    ;(APPLICATION)
   121            C        		RETL @0X85    ;REPORT ID
   122            C        		RETL @0X01
   123            C        		;{
   124            C        		;{X,Y,Z,Rz
   125            C        			RETL	@0XA1    ;Collection
   126            C        			RETL	@0X02    ;Logical
   127            C        			RETL	@0X09    ;USAGE
   128            C        			RETL	@0X30    ;(X)
   129            C        			RETL	@0X09    ;USAGE
   130            C        			RETL	@0X31    ;(Y)
   131            C        			RETL	@0X09    ;USAGE
   132            C        			RETL	@0X35    ;(Rz)
   133            C        			RETL	@0X09    ;USAGE
   134            C        			RETL	@0X32    ;(Z)
   135            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   136            C        			RETL	@0X00    ;(0)
   137            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   138            C        			RETL	@0XFF    ;(FF)
   139            C        			RETL	@0X00
   140            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   141            C        			RETL	@0X00    ;(0)
   142            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   143            C        			RETL	@0XFF    ;(FF)
   144            C        			RETL	@0X00
   145            C        			RETL	@0X75    ;REPORT_SIZE
   146            C        			RETL	@0X08    ;(8)
   147            C        			RETL	@0X95    ;REPORT_COUNT
   148            C        			RETL	@0X04    ;(4)
   149            C        			RETL	@0X81    ;INPUT
   150            C        			RETL	@0X02    ;(Data Ary,Abs)
   151            C        		;}
   152            C        		;{Button
   153            C        			RETL @0X05    ;USAGE_PAGE
   154            C        			RETL @0X09    ;(Button)
   155            C        			RETL @0X19    ;USAGE MINIMUN
   156            C        			RETL @0X01    ;(BUTTON 1)
   157            C        			RETL @0X29    ;USAGE MAXIMUM
   158            C        			RETL @0X10    ;(BUTTON 16)
   159            C        			RETL @0X25    ;LOGICAL MAXIMUM
   160            C        			RETL @0X01    ;(1)
   161            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   162            C        			RETL @0X01    ;(1)
   163            C        			RETL @0X75    ;REPORT_SIZE
   164            C        			RETL @0X01    ;(1)
   165            C        			RETL @0X95    ;REPORT_COUNT
   166            C        			RETL @0X10    ;(16)
   167            C        			RETL @0X81    ;INPUT
   168            C        			RETL @0X02    ;(Data Ary,Abs)
   169            C        		;}
   170            C        		;{Hat Switch
   171            C        			RETL @0X06
   172            C        			RETL @0X01
   173            C        			RETL @0X00
   174            C        			RETL @0X09    ;USAGE
   175            C        			RETL @0X39    ;(Hat Switch)
   176            C        			RETL @0X75    ;REPORT_SIZE
   177            C        			RETL @0X04    ;(4)
   178            C        			RETL @0X95    ;REPORT_COUNT
   179            C        			RETL @0X01    ;(1)
   180            C        			RETL @0X25    ;LOGICAL_MAX
   181            C        			RETL @0X07    ;(7)
   182            C        			RETL @0X46    ;PHYSICAL_MAX
   183            C        			RETL @0X3B    ;(315)
   184            C        			RETL @0X01
   185            C        			RETL @0X65    ;UNIT
   186            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   187            C        			RETL @0X81    ;INPUT
   188            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   189            C        		;}
   190            C        		;{Const
   191            C        			RETL @0X65    ;UNIT
   192            C        			RETL @0X00    ;(None)
   193            C        			RETL @0X75    ;REPORT_SIZE
   194            C        			RETL @0X04    ;(4)
   195            C        			RETL @0X95    ;REPORT_COUNT
   196            C        			RETL @0X01    ;(1)
   197            C        			RETL @0X81    ;INPUT
   198            C        			RETL @0X01    ;(Const,Var,Abs)
   199            C        			RETL @0XC0    ;END COLLECTION
   200            C        		;}
   201            C        	;}
   202            C          RETL @0XC0              ;78;END COLLECTION
   203            C        
   204            C        ;----------------------------------------------------
   205            C        	;--REPORT DESCRIPTOR--
   206            C        	RETL @0X05    ;USAGE PAGE
   207            C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   208            C        	RETL @0X09    ;USAGE
   209            C        	RETL @0X04    ;(JOYSTICK)
   210            C        	;{
   211            C        		RETL @0XA1    ;COLLECTION
   212            C        		RETL @0X01    ;(APPLICATION)
   213            C        		RETL @0X85    ;REPORT ID
   214            C        		RETL @0X02
   215            C        		;{
   216            C        		;{X,Y,Z,Rz
   217            C        			RETL	@0XA1    ;Collection
   218            C        			RETL	@0X02    ;Logical
   219            C        			RETL	@0X09    ;USAGE
   220            C        			RETL	@0X30    ;(X)
   221            C        			RETL	@0X09    ;USAGE
   222            C        			RETL	@0X31    ;(Y)
   223            C        			RETL	@0X09    ;USAGE
   224            C        			RETL	@0X35    ;(Rz)
   225            C        			RETL	@0X09    ;USAGE
   226            C        			RETL	@0X32    ;(Z)
   227            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   228            C        			RETL	@0X00    ;(0)
   229            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   230            C        			RETL	@0XFF    ;(FF)
   231            C        			RETL	@0X00
   232            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   233            C        			RETL	@0X00    ;(0)
   234            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   235            C        			RETL	@0XFF    ;(FF)
   236            C        			RETL	@0X00
   237            C        			RETL	@0X75    ;REPORT_SIZE
   238            C        			RETL	@0X08    ;(8)
   239            C        			RETL	@0X95    ;REPORT_COUNT
   240            C        			RETL	@0X04    ;(4)
   241            C        			RETL	@0X81    ;INPUT
   242            C        			RETL	@0X02    ;(Data Ary,Abs)
   243            C        		;}
   244            C        		;{Button
   245            C        			RETL @0X05    ;USAGE_PAGE
   246            C        			RETL @0X09    ;(Button)
   247            C        			RETL @0X19    ;USAGE MINIMUN
   248            C        			RETL @0X01    ;(BUTTON 1)
   249            C        			RETL @0X29    ;USAGE MAXIMUM
   250            C        			RETL @0X10    ;(BUTTON 16)
   251            C        			RETL @0X25    ;LOGICAL MAXIMUM
   252            C        			RETL @0X01    ;(1)
   253            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   254            C        			RETL @0X01    ;(1)
   255            C        			RETL @0X75    ;REPORT_SIZE
   256            C        			RETL @0X01    ;(1)
   257            C        			RETL @0X95    ;REPORT_COUNT
   258            C        			RETL @0X10    ;(16)
   259            C        			RETL @0X81    ;INPUT
   260            C        			RETL @0X02    ;(Data Ary,Abs)
   261            C        		;}
   262            C        		;{Hat Switch
   263            C        			RETL @0X06
   264            C        			RETL @0X01
   265            C        			RETL @0X00
   266            C        			RETL @0X09    ;USAGE
   267            C        			RETL @0X39    ;(Hat Switch)
   268            C        			RETL @0X75    ;REPORT_SIZE
   269            C        			RETL @0X04    ;(4)
   270            C        			RETL @0X95    ;REPORT_COUNT
   271            C        			RETL @0X01    ;(1)
   272            C        			RETL @0X25    ;LOGICAL_MAX
   273            C        			RETL @0X07    ;(7)
   274            C        			RETL @0X46    ;PHYSICAL_MAX
   275            C        			RETL @0X3B    ;(315)
   276            C        			RETL @0X01
   277            C        			RETL @0X65    ;UNIT
   278            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   279            C        			RETL @0X81    ;INPUT
   280            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   281            C        		;}
   282            C        		;{Const
   283            C        			RETL @0X65    ;UNIT
   284            C        			RETL @0X00    ;(None)
   285            C        			RETL @0X75    ;REPORT_SIZE
   286            C        			RETL @0X04    ;(4)
   287            C        			RETL @0X95    ;REPORT_COUNT
   288            C        			RETL @0X01    ;(1)
   289            C        			RETL @0X81    ;INPUT
   290            C        			RETL @0X01    ;(Const,Var,Abs)
   291            C        			RETL @0XC0    ;END COLLECTION
   292            C        		;}
   293            C        	;}
   294            C        	RETL @0XC0              ;78;END COLLECTION
   295            C        	End_HID_Report_Table1:
   296            C        
   297            C        ;---------------------------------------------------------------------
   298            C        ;---------------------------------------------------------------------
   299            C        		ORG         0XE00
   300            C        HID_REPORT_TABLE2:
   301            C        	TBL
   302            C        	Begin_HID_Report_Table2:
   303            C        ;-------------------------------------------------------
   304            C        	;--REPORT DESCRIPTOR--
   305            C        		RETL @0X05    ;USAGE PAGE
   306            C        		RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   307            C        		RETL @0X09    ;USAGE
   308            C        		RETL @0X04    ;(JOYSTICK)
   309            C        	;{
   310            C        		RETL @0XA1    ;COLLECTION
   311            C        		RETL @0X01    ;(APPLICATION)
   312            C        		RETL @0X85    ;REPORT ID
   313            C        		RETL @0X03
   314            C        		;{
   315            C        		;{X,Y,Z,Rz
   316            C        			RETL	@0XA1    ;Collection
   317            C        			RETL	@0X02    ;Logical
   318            C        			RETL	@0X09    ;USAGE
   319            C        			RETL	@0X30    ;(X)
   320            C        			RETL	@0X09    ;USAGE
   321            C        			RETL	@0X31    ;(Y)
   322            C        			RETL	@0X09    ;USAGE
   323            C        			RETL	@0X35    ;(Rz)
   324            C        			RETL	@0X09    ;USAGE
   325            C        			RETL	@0X32    ;(Z)
   326            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   327            C        			RETL	@0X00    ;(0)
   328            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   329            C        			RETL	@0XFF    ;(FF)
   330            C        			RETL	@0X00
   331            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   332            C        			RETL	@0X00    ;(0)
   333            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   334            C        			RETL	@0XFF    ;(FF)
   335            C        			RETL	@0X00
   336            C        			RETL	@0X75    ;REPORT_SIZE
   337            C        			RETL	@0X08    ;(8)
   338            C        			RETL	@0X95    ;REPORT_COUNT
   339            C        			RETL	@0X04    ;(4)
   340            C        			RETL	@0X81    ;INPUT
   341            C        			RETL	@0X02    ;(Data Ary,Abs)
   342            C        		;}
   343            C        		;{Button
   344            C        			RETL @0X05    ;USAGE_PAGE
   345            C        			RETL @0X09    ;(Button)
   346            C        			RETL @0X19    ;USAGE MINIMUN
   347            C        			RETL @0X01    ;(BUTTON 1)
   348            C        			RETL @0X29    ;USAGE MAXIMUM
   349            C        			RETL @0X10    ;(BUTTON 16)
   350            C        			RETL @0X25    ;LOGICAL MAXIMUM
   351            C        			RETL @0X01    ;(1)
   352            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   353            C        			RETL @0X01    ;(1)
   354            C        			RETL @0X75    ;REPORT_SIZE
   355            C        			RETL @0X01    ;(1)
   356            C        			RETL @0X95    ;REPORT_COUNT
   357            C        			RETL @0X10    ;(16)
   358            C        			RETL @0X81    ;INPUT
   359            C        			RETL @0X02    ;(Data Ary,Abs)
   360            C        		;}
   361            C        		;{Hat Switch
   362            C        			RETL @0X06
   363            C        			RETL @0X01
   364            C        			RETL @0X00
   365            C        			RETL @0X09    ;USAGE
   366            C        			RETL @0X39    ;(Hat Switch)
   367            C        			RETL @0X75    ;REPORT_SIZE
   368            C        			RETL @0X04    ;(4)
   369            C        			RETL @0X95    ;REPORT_COUNT
   370            C        			RETL @0X01    ;(1)
   371            C        			RETL @0X25    ;LOGICAL_MAX
   372            C        			RETL @0X07    ;(7)
   373            C        			RETL @0X46    ;PHYSICAL_MAX
   374            C        			RETL @0X3B    ;(315)
   375            C        			RETL @0X01
   376            C        			RETL @0X65    ;UNIT
   377            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   378            C        			RETL @0X81    ;INPUT
   379            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   380            C        		;}
   381            C        		;{Const
   382            C        			RETL @0X65    ;UNIT
   383            C        			RETL @0X00    ;(None)
   384            C        			RETL @0X75    ;REPORT_SIZE
   385            C        			RETL @0X04    ;(4)
   386            C        			RETL @0X95    ;REPORT_COUNT
   387            C        			RETL @0X01    ;(1)
   388            C        			RETL @0X81    ;INPUT
   389            C        			RETL @0X01    ;(Const,Var,Abs)
   390            C        			RETL @0XC0    ;END COLLECTION
   391            C        		;}
   392            C        	;}
   393            C        	RETL @0XC0              ;78;END COLLECTION
   394            C        
   395            C        ;-----------------------------------------------------
   396            C        	;--REPORT DESCRIPTOR--
   397            C        	RETL @0X05    ;USAGE PAGE
   398            C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   399            C        	RETL @0X09    ;USAGE
   400            C        	RETL @0X04    ;(JOYSTICK)
   401            C        	;{
   402            C        		RETL @0XA1    ;COLLECTION
   403            C        		RETL @0X01    ;(APPLICATION)
   404            C        		RETL @0X85    ;REPORT ID
   405            C        		RETL @0X04
   406            C        		;{
   407            C        		;{X,Y,Z,Rz
   408            C        			RETL	@0XA1    ;Collection
   409            C        			RETL	@0X02    ;Logical
   410            C        			RETL	@0X09    ;USAGE
   411            C        			RETL	@0X30    ;(X)
   412            C        			RETL	@0X09    ;USAGE
   413            C        			RETL	@0X31    ;(Y)
   414            C        			RETL	@0X09    ;USAGE
   415            C        			RETL	@0X35    ;(Rz)
   416            C        			RETL	@0X09    ;USAGE
   417            C        			RETL	@0X32    ;(Z)
   418            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   419            C        			RETL	@0X00    ;(0)
   420            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   421            C        			RETL	@0XFF    ;(FF)
   422            C        			RETL	@0X00
   423            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   424            C        			RETL	@0X00    ;(0)
   425            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   426            C        			RETL	@0XFF    ;(FF)
   427            C        			RETL	@0X00
   428            C        			RETL	@0X75    ;REPORT_SIZE
   429            C        			RETL	@0X08    ;(8)
   430            C        			RETL	@0X95    ;REPORT_COUNT
   431            C        			RETL	@0X04    ;(4)
   432            C        			RETL	@0X81    ;INPUT
   433            C        			RETL	@0X02    ;(Data Ary,Abs)
   434            C        		;}
   435            C        		;{Button
   436            C        			RETL @0X05    ;USAGE_PAGE
   437            C        			RETL @0X09    ;(Button)
   438            C        			RETL @0X19    ;USAGE MINIMUN
   439            C        			RETL @0X01    ;(BUTTON 1)
   440            C        			RETL @0X29    ;USAGE MAXIMUM
   441            C        			RETL @0X10    ;(BUTTON 16)
   442            C        			RETL @0X25    ;LOGICAL MAXIMUM
   443            C        			RETL @0X01    ;(1)
   444            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   445            C        			RETL @0X01    ;(1)
   446            C        			RETL @0X75    ;REPORT_SIZE
   447            C        			RETL @0X01    ;(1)
   448            C        			RETL @0X95    ;REPORT_COUNT
   449            C        			RETL @0X10    ;(16)
   450            C        			RETL @0X81    ;INPUT
   451            C        			RETL @0X02    ;(Data Ary,Abs)
   452            C        		;}
   453            C        		;{Hat Switch
   454            C        			RETL @0X06
   455            C        			RETL @0X01
   456            C        			RETL @0X00
   457            C        			RETL @0X09    ;USAGE
   458            C        			RETL @0X39    ;(Hat Switch)
   459            C        			RETL @0X75    ;REPORT_SIZE
   460            C        			RETL @0X04    ;(4)
   461            C        			RETL @0X95    ;REPORT_COUNT
   462            C        			RETL @0X01    ;(1)
   463            C        			RETL @0X25    ;LOGICAL_MAX
   464            C        			RETL @0X07    ;(7)
   465            C        			RETL @0X46    ;PHYSICAL_MAX
   466            C        			RETL @0X3B    ;(315)
   467            C        			RETL @0X01
   468            C        			RETL @0X65    ;UNIT
   469            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   470            C        			RETL @0X81    ;INPUT
   471            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   472            C        		;}
   473            C        		;{Const
   474            C        			RETL @0X65    ;UNIT
   475            C        			RETL @0X00    ;(None)
   476            C        			RETL @0X75    ;REPORT_SIZE
   477            C        			RETL @0X04    ;(4)
   478            C        			RETL @0X95    ;REPORT_COUNT
   479            C        			RETL @0X01    ;(1)
   480            C        			RETL @0X81    ;INPUT
   481            C        			RETL @0X01    ;(Const,Var,Abs)
   482            C        			RETL @0XC0    ;END COLLECTION
   483            C        		;}
   484            C        	;}
   485            C        	RETL @0XC0              ;78;END COLLECTION
   486            C        	End_HID_Report_Table2:
   487            C        
   488            C        ;---------------------------------------------------------------------
   489            C        ;---------------------------------------------------------------------
   490            C        		ORG         0XF00
   491            C        HID_REPORT_TABLE3:
   492            C        	TBL
   493            C        	Begin_HID_Report_Table3:
   494            C        ;--------------------------------------------------
   495            C        	;--REPORT DESCRIPTOR--
   496            C        	RETL @0X05    ;USAGE PAGE
   497            C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   498            C        	RETL @0X09    ;USAGE
   499            C        	RETL @0X04    ;(JOYSTICK)
   500            C        	;{
   501            C        		RETL @0XA1    ;COLLECTION
   502            C        		RETL @0X01    ;(APPLICATION)
   503            C        		RETL @0X85    ;REPORT ID
   504            C        		RETL @0X05
   505            C        		;{
   506            C        		;{X,Y,Z,Rz
   507            C        			RETL	@0XA1    ;Collection
   508            C        			RETL	@0X02    ;Logical
   509            C        			RETL	@0X09    ;USAGE
   510            C        			RETL	@0X30    ;(X)
   511            C        			RETL	@0X09    ;USAGE
   512            C        			RETL	@0X31    ;(Y)
   513            C        			RETL	@0X09    ;USAGE
   514            C        			RETL	@0X35    ;(Rz)
   515            C        			RETL	@0X09    ;USAGE
   516            C        			RETL	@0X32    ;(Z)
   517            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   518            C        			RETL	@0X00    ;(0)
   519            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   520            C        			RETL	@0XFF    ;(FF)
   521            C        			RETL	@0X00
   522            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   523            C        			RETL	@0X00    ;(0)
   524            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   525            C        			RETL	@0XFF    ;(FF)
   526            C        			RETL	@0X00
   527            C        			RETL	@0X75    ;REPORT_SIZE
   528            C        			RETL	@0X08    ;(8)
   529            C        			RETL	@0X95    ;REPORT_COUNT
   530            C        			RETL	@0X04    ;(4)
   531            C        			RETL	@0X81    ;INPUT
   532            C        			RETL	@0X02    ;(Data Ary,Abs)
   533            C        		;}
   534            C        		;{Button
   535            C        			RETL @0X05    ;USAGE_PAGE
   536            C        			RETL @0X09    ;(Button)
   537            C        			RETL @0X19    ;USAGE MINIMUN
   538            C        			RETL @0X01    ;(BUTTON 1)
   539            C        			RETL @0X29    ;USAGE MAXIMUM
   540            C        			RETL @0X10    ;(BUTTON 16)
   541            C        			RETL @0X25    ;LOGICAL MAXIMUM
   542            C        			RETL @0X01    ;(1)
   543            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   544            C        			RETL @0X01    ;(1)
   545            C        			RETL @0X75    ;REPORT_SIZE
   546            C        			RETL @0X01    ;(1)
   547            C        			RETL @0X95    ;REPORT_COUNT
   548            C        			RETL @0X10    ;(16)
   549            C        			RETL @0X81    ;INPUT
   550            C        			RETL @0X02    ;(Data Ary,Abs)
   551            C        		;}
   552            C        		;{Hat Switch
   553            C        			RETL @0X06
   554            C        			RETL @0X01
   555            C        			RETL @0X00
   556            C        			RETL @0X09    ;USAGE
   557            C        			RETL @0X39    ;(Hat Switch)
   558            C        			RETL @0X75    ;REPORT_SIZE
   559            C        			RETL @0X04    ;(4)
   560            C        			RETL @0X95    ;REPORT_COUNT
   561            C        			RETL @0X01    ;(1)
   562            C        			RETL @0X25    ;LOGICAL_MAX
   563            C        			RETL @0X07    ;(7)
   564            C        			RETL @0X46    ;PHYSICAL_MAX
   565            C        			RETL @0X3B    ;(315)
   566            C        			RETL @0X01
   567            C        			RETL @0X65    ;UNIT
   568            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   569            C        			RETL @0X81    ;INPUT
   570            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   571            C        		;}
   572            C        		;{Const
   573            C        			RETL @0X65    ;UNIT
   574            C        			RETL @0X00    ;(None)
   575            C        			RETL @0X75    ;REPORT_SIZE
   576            C        			RETL @0X04    ;(4)
   577            C        			RETL @0X95    ;REPORT_COUNT
   578            C        			RETL @0X01    ;(1)
   579            C        			RETL @0X81    ;INPUT
   580            C        			RETL @0X01    ;(Const,Var,Abs)
   581            C        			RETL @0XC0    ;END COLLECTION
   582            C        		;}
   583            C        	;}
   584            C        	RETL @0XC0              ;78;END COLLECTION
   585            C        
   586            C        ;--------------------------------------------------
   587            C        	;--REPORT DESCRIPTOR--
   588            C        	RETL @0X05    ;USAGE PAGE
   589            C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   590            C        	RETL @0X09    ;USAGE
   591            C        	RETL @0X04    ;(JOYSTICK)
   592            C        	;{
   593            C        		RETL @0XA1    ;COLLECTION
   594            C        		RETL @0X01    ;(APPLICATION)
   595            C        		RETL @0X85    ;REPORT ID
   596            C        		RETL @0X06
   597            C        		;{
   598            C        		;{X,Y,Z,Rz
   599            C        			RETL	@0XA1    ;Collection
   600            C        			RETL	@0X02    ;Logical
   601            C        			RETL	@0X09    ;USAGE
   602            C        			RETL	@0X30    ;(X)
   603            C        			RETL	@0X09    ;USAGE
   604            C        			RETL	@0X31    ;(Y)
   605            C        			RETL	@0X09    ;USAGE
   606            C        			RETL	@0X35    ;(Rz)
   607            C        			RETL	@0X09    ;USAGE
   608            C        			RETL	@0X32    ;(Z)
   609            C        			RETL	@0X15    ;LOGICAL_MINIMUN
   610            C        			RETL	@0X00    ;(0)
   611            C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   612            C        			RETL	@0XFF    ;(FF)
   613            C        			RETL	@0X00
   614            C        			RETL	@0X35    ;PHYSICAL MINIMUM
   615            C        			RETL	@0X00    ;(0)
   616            C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   617            C        			RETL	@0XFF    ;(FF)
   618            C        			RETL	@0X00
   619            C        			RETL	@0X75    ;REPORT_SIZE
   620            C        			RETL	@0X08    ;(8)
   621            C        			RETL	@0X95    ;REPORT_COUNT
   622            C        			RETL	@0X04    ;(4)
   623            C        			RETL	@0X81    ;INPUT
   624            C        			RETL	@0X02    ;(Data Ary,Abs)
   625            C        		;}
   626            C        		;{Button
   627            C        			RETL @0X05    ;USAGE_PAGE
   628            C        			RETL @0X09    ;(Button)
   629            C        			RETL @0X19    ;USAGE MINIMUN
   630            C        			RETL @0X01    ;(BUTTON 1)
   631            C        			RETL @0X29    ;USAGE MAXIMUM
   632            C        			RETL @0X10    ;(BUTTON 16)
   633            C        			RETL @0X25    ;LOGICAL MAXIMUM
   634            C        			RETL @0X01    ;(1)
   635            C        			RETL @0X45    ;PHYSICAL MAXIMUM
   636            C        			RETL @0X01    ;(1)
   637            C        			RETL @0X75    ;REPORT_SIZE
   638            C        			RETL @0X01    ;(1)
   639            C        			RETL @0X95    ;REPORT_COUNT
   640            C        			RETL @0X10    ;(16)
   641            C        			RETL @0X81    ;INPUT
   642            C        			RETL @0X02    ;(Data Ary,Abs)
   643            C        		;}
   644            C        		;{Hat Switch
   645            C        			RETL @0X06
   646            C        			RETL @0X01
   647            C        			RETL @0X00
   648            C        			RETL @0X09    ;USAGE
   649            C        			RETL @0X39    ;(Hat Switch)
   650            C        			RETL @0X75    ;REPORT_SIZE
   651            C        			RETL @0X04    ;(4)
   652            C        			RETL @0X95    ;REPORT_COUNT
   653            C        			RETL @0X01    ;(1)
   654            C        			RETL @0X25    ;LOGICAL_MAX
   655            C        			RETL @0X07    ;(7)
   656            C        			RETL @0X46    ;PHYSICAL_MAX
   657            C        			RETL @0X3B    ;(315)
   658            C        			RETL @0X01
   659            C        			RETL @0X65    ;UNIT
   660            C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   661            C        			RETL @0X81    ;INPUT
   662            C        			RETL @0X42    ;(Data,Var,Abs,Null)
   663            C        		;}
   664            C        		;{Const
   665            C        			RETL @0X65    ;UNIT
   666            C        			RETL @0X00    ;(None)
   667            C        			RETL @0X75    ;REPORT_SIZE
   668            C        			RETL @0X04    ;(4)
   669            C        			RETL @0X95    ;REPORT_COUNT
   670            C        			RETL @0X01    ;(1)
   671            C        			RETL @0X81    ;INPUT
   672            C        			RETL @0X01    ;(Const,Var,Abs)
   673            C        			RETL @0XC0    ;END COLLECTION
   674            C        		;}
   675            C        	;}
   676            C        	RETL @0XC0              ;78;END COLLECTION
   677            C        	End_HID_Report_Table3:
   678            C        */
   679            C        
   680            C        
   681            C        
   682            C        
   683            C        		ORG 	0XC00	;PAGE 3
   684            C          if MassageDisplay == 1
   685            C        	MESSAGE "define 'M611USBDescData.ASM' ROM address"
   686            C          endif
   687 00C00      C        DEVICE_TABLE:
   688 00C00 0020 C        		TBL
   689            C        		;Device Descriptor
   690 00C01 1C12 C        		RETL	@0X12;01	bLength
   691 00C02 1C01 C        		RETL	@0X01;02	bDescriptorType
   692 00C03 1C10 C        		RETL	@0X10;03	bcdUSB
   693 00C04 1C01 C        		RETL	@0X01;04
   694 00C05 1C00 C        		RETL	@0X00;05	bDeviceCalss
   695 00C06 1C00 C        		RETL	@0X00;06	bDeviceSubClass
   696 00C07 1C00 C        		RETL	@0X00;07	bDeviceProtocol
   697 00C08 1C08 C        		RETL	@0X08;08	bMaxPacketSize0 ,MCU point0 byte length
   698 00C09 1CF3 C        		RETL	@0XF3;09	idVendor 0X04F3
   699 00C0A 1C04 C        		RETL	@0X04;0A
   700 00C0B 1C13 C        		RETL	@0X13;0B	idProduct (joystick:0x0f1f)
   701 00C0C 1C2F C        		RETL	@0X2F;0C
   702 00C0D 1C70 C        		RETL	@0X70;0D	bcdDevice v1.7.0
   703 00C0E 1C01 C        		RETL	@0X01;0E
   704 00C0F 1C01 C        		RETL	@0X01;0F	iManufacturer
   705 00C10 1C02 C        		RETL	@0X02;10	iProduct
   706 00C11 1C03 C        		RETL	@0X03;11	iSerialNumber
   707 00C12 1C01 C        		RETL	@0X01;12	bNumConfigurations
   708            C        
   709            C        
   710 00C13      C        CONFIG_TABLE:
   711 00C13 0020 C        		TBL
   712            C        		;Configuration Descriptor
   713 00C14 1C09 C        		RETL	@0X09;01	bLength
   714 00C15 1C02 C        		RETL	@0X02;02	bDescritorType
   715 00C16 1C22 C        		RETL	@0X22;03	wTotalLength
   716 00C17 1C00 C        		RETL	@0X00;04
   717 00C18 1C01 C        		RETL	@0X01;05	bConfigurationValue
   718 00C19 1C01 C        		RETL	@0X01;06	bNumInterfaces
   719 00C1A 1C00 C        		RETL	@0X00;07	iConfiguration
   720 00C1B 1C80 C        		RETL	@0X80;08	bmAttributes
   721 00C1C 1C32 C        		RETL	@0X32;09	bMaxPower ,Imax=100mA
   722            C        
   723            C        		;Interface Descriptor
   724 00C1D 1C09 C        		RETL	@0X09;0A	bLength
   725 00C1E 1C04 C        		RETL	@0X04;0B	bDescriptorType(mouse)
   726 00C1F 1C00 C        		RETL	@0X00;0C	bInterfaceNumber
   727 00C20 1C00 C        		RETL	@0X00;0D	bAlternateSetting
   728 00C21 1C01 C        		RETL	@0X01;0E	bNumEndpoints
   729 00C22 1C03 C        		RETL	@0X03;0F	bInterfaceClass (Class:HID)
   730 00C23 1C01 C        		RETL	@0X01;10	bInterfaceSubClass (BOOT DEVICE)
   731 00C24 1C02 C        		RETL	@0X02;11	bInterfaceProtocol (joystick)
   732 00C25 1C00 C        		RETL	@0X00;12	iConfiguration
   733            C        
   734            C        		;HID Descriptor
   735 00C26 1C09 C        		RETL	@0X09            ;13    bLength
   736 00C27 1C21 C        		RETL	@0X21            ;14    bDescriptorType
   737 00C28 1C10 C        		RETL	@0X10            ;15    bcdHID
   738 00C29 1C01 C        		RETL	@0X01            ;16
   739 00C2A 1C21 C        		RETL	@0X21            ;17    bCountryCode
   740 00C2B 1C01 C        		RETL	@0X01            ;18    bNumDescriptors
   741 00C2C 1C22 C        		RETL	@0X22            ;19    bDescriptorType. report descriptor:0x22, physics descriptor:0x23
   742            C                                         ;1A    bLength of the Report Descriptor ;0XF8
   743 00C2D 1C3E C        		RETL	@(End_HID_Report_Table1-Begin_HID_Report_Table1)+(End_HID_Report_Table2-Begin_HID_Report_HID_Report_Table3)
   744 00C2E 1C00 C        		RETL	@0X00            ;1B    ;0X01
   745            C        
   746            C        		;Endpoint Descriptor
   747 00C2F 1C07 C        		RETL	@0X07;1C	bLength
   748 00C30 1C05 C        		RETL	@0X05;1D	bDescriptorType
   749 00C31 1C81 C        		RETL	@0X81;1E	bEndpointAddress
   750 00C32 1C03 C        		RETL	@0X03;1F	bmAttributes
   751 00C33 1C08 C        		RETL	@0X08;20	wMaxPackerSize
   752 00C34 1C00 C        		RETL	@0X00;21
   753 00C35 1C05 C        		RETL	@0X05;22	bInterval    ;change 20ms
   754            C        
   755            C        
   756            C        ;---------------------------------------------------------------------
   757            C        ;---------------------------------------------------------------------
   758 00C36      C        STRING0T:
   759            C        		;String Descriptor Of Languages
   760 00C36 0020 C        		TBL
   761 00C37 1C04 C        		RETL	@0X04;01	bLength
   762 00C38 1C03 C        		RETL	@0X03;02	bdescriptorType
   763 00C39 1C09 C        		RETL	@0X09;03
   764 00C3A 1C04 C        		RETL	@0X04;04	END OF LANGUAGES
   765            C        
   766            C        
   767            C        ;***********************************************************
   768            C        ;HID Report Table
   769            C        ;***********************************************************
   770            C        		ORG         0XD00
   771 00D00      C        HID_REPORT_TABLE1:
   772 00D00 0020 C        	TBL
   773 00D01      C        	Begin_HID_Report_Table1:
   774            C        ;----------------------------------------------------------
   775            C        	;--REPORT DESCRIPTOR--
   776 00D01 1C05 C        	RETL @0X05    ;USAGE PAGE
   777 00D02 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   778 00D03 1C09 C        	RETL @0X09    ;USAGE
   779 00D04 1C02 C        	RETL @0X02    ;(Mouse)
   780            C        	;{
   781 00D05 1CA1 C        		RETL @0XA1    ;COLLECTION
   782 00D06 1C01 C        		RETL @0X01    ;(APPLICATION)
   783            C        		;{
   784 00D07 1C05 C        			RETL @0X05    ;USAGE_PAGE
   785 00D08 1C09 C        			RETL @0X09    ;(Button)
   786 00D09 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   787 00D0A 1C01 C        			RETL @0X01    ;(BUTTON 1)
   788 00D0B 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   789 00D0C 1C03 C        			RETL @0X03    ;(BUTTON 3)
   790 00D0D 1C15 C        			RETL @0X15    ;LOGICAL MINMUM
   791 00D0E 1C00 C        			RETL @0X00    ;(0)
   792 00D0F 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   793 00D10 1C01 C        			RETL @0X01    ;(1)
   794 00D11 1C75 C        			RETL @0X75    ;REPORT_SIZE
   795 00D12 1C01 C        			RETL @0X01    ;(1)
   796 00D13 1C95 C        			RETL @0X95    ;REPORT_COUNT
   797 00D14 1C03 C        			RETL @0X03    ;(03)
   798 00D15 1C81 C        			RETL @0X81    ;INPUT
   799 00D16 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   800            C        		;}
   801            C          		;{
   802 00D17 1C75 C        			RETL @0X75    ;REPORT_SIZE
   803 00D18 1C05 C        			RETL @0X05    ;(5)
   804 00D19 1C95 C        			RETL @0X95    ;REPORT_COUNT
   805 00D1A 1C01 C        			RETL @0X01    ;(15)
   806 00D1B 1C81 C           			RETL @0X81    ;INPUT
   807 00D1C 1C03 C        			RETL @0X03    ;(Const,Var,Abs)
   808            C        		;}
   809 00D1D 1C05 C        		RETL @0X05    ;USAGE PAGE
   810 00D1E 1C01 C        		RETL @0X01    ;(GENERIC DESKTOP)
   811 00D1F 1C09 C        		RETL @0X09    ;USAGE
   812 00D20 1C01 C        		RETL @0X01    ;(Poniter)
   813 00D21 1CA1 C        		RETL @0XA1    ;COLLECTION
   814 00D22 1C00 C        		RETL @0X00    ;(Physical)
   815            C        		;{
   816 00D23 1C09 C        			RETL @0X09    ;USAGE
   817 00D24 1C30 C        			RETL @0X30    ;(X)
   818 00D25 1C09 C        			RETL @0X09    ;USAGE
   819 00D26 1C31 C        			RETL @0X31    ;(Y)
   820 00D27 1C15 C        			RETL @0X15    ;LOGICAL_MINIMUN
   821 00D28 1C81 C        			RETL @0X81    ;(-127)
   822 00D29 1C25 C        			RETL @0X25    ;LOGICAL_MAXIMUM
   823 00D2A 1C7F C        			RETL @0X7F    ;(127)
   824 00D2B 1C75 C        			RETL @0X75    ;REPORT_SIZE
   825 00D2C 1C08 C        			RETL @0X08    ;(8)
   826 00D2D 1C95 C        			RETL @0X95    ;REPORT_COUNT
   827 00D2E 1C02 C        			RETL @0X02    ;(2)
   828 00D2F 1C81 C        			RETL @0X81    ;INPUT
   829 00D30 1C06 C        			RETL @0X06    ;(Data Ary,Rel)
   830            C        		;}
   831 00D31 1CC0 C        		RETL @0XC0    ;END COLLECTION
   832            C        		;{
   833 00D32 1C09 C        			RETL @0X09    ;USAGE
   834 00D33 1C38 C        			RETL @0X38    ;(Wheel)
   835 00D34 1C15 C        			RETL @0X15    ;LOGICAL_MINIMUN
   836 00D35 1C81 C        			RETL @0X81    ;(-127)
   837 00D36 1C25 C        			RETL @0X25    ;LOGICAL_MAXIMUM
   838 00D37 1C7F C        			RETL @0X7F    ;(127)
   839 00D38 1C75 C        			RETL @0X75    ;REPORT_SIZE
   840 00D39 1C08 C        			RETL @0X08    ;(8)
   841 00D3A 1C95 C        			RETL @0X95    ;REPORT_COUNT
   842 00D3B 1C01 C        			RETL @0X01    ;(1)
   843 00D3C 1C81 C        			RETL @0X81    ;INPUT
   844 00D3D 1C06 C        			RETL @0X06    ;(Data Ary,Rel)
   845            C        		;}
   846 00D3E 1CC0 C        		RETL @0XC0    ;END COLLECTION
   847            C        	;}
   848 00D3F      C        	End_HID_Report_Table1:
   849 00D3F 0012 C        	RET
   850            C        
   851 00D40      C        HID_REPORT_TABLE2:
   852 00D40 0020 C        	TBL
   853 00D41      C        	Begin_HID_Report_Table2:
   854 00D41      C        	End_HID_Report_Table2:
   855 00D41 0012 C        	RET
   856            C        
   857 00D42      C        HID_REPORT_TABLE3:
   858 00D42 0020 C        	TBL
   859 00D43      C        	Begin_HID_Report_Table3:
   860 00D43      C        	End_HID_Report_Table3:
   861 00D43 0012 C        	RET
   862            C        
    15            C        
    16            C        ifndef EM78CtrlIns.H
    17            C        include "EM78CtrlIns.H"
    18            C        endif
    19            C        
    20            C        ifndef M611rxP40.H
    21            C        include "M611rxP40.H"
    22            C        endif
    23            C        ;=========================================================================
    24            C        
    25            C        	ORG                 0X1150    ;PAGE 4
    26            C          if MassageDisplay == 1
    27            C        	MESSAGE "define 'M611USBDriver.ASM' ROM address"
    28            C          endif
    29            C        ;***********************************************************************************
    30            C        ;**********************************************************************************
    31            C        ; USB Driver
    32            C        ;*********************************************************************************
    33            C        ;==============================================================================
    34            C        ;==============================================================================
    35            C        ; READ USB COMMAND ,HOST command
    36            C        ;==============================================================================
    37            C        
    38 01150      C        READ_COMMAND:
    39 01150 0C4C C        	JBC                 RC,EP0_BUSY           ;CHECK UDC BUSY OR NOT
    40 01151 1550 C        	JMP                 READ_COMMAND
    41 01152 0FCC C        	JBS                 RC,EP0_W              ;CHECK EP0 W HAVE DATA OR NOT
    42 01153 1550 C        	JMP                 READ_COMMAND
    43 01154 098C C        	BC                  RC,EP0_R              ;DISABLE UDC READ
    44            C        
    45 01155 1810 C        	MOV                 A,@0X10
    46 01156 004D C        	MOV                 RD,A
    47 01157 00CE C        	CLR                 RE                    ;RESET POINTER & COUNTER
    48 01158 00CD C        	CLR                 RD
    49            C        
    50 01159 040E C        	MOV                 A,RE
    51 0115A 0060 C        	MOV                 BYTE0,A
    52 0115B 040E C        	MOV                 A,RE
    53 0115C 0061 C        	MOV                 BYTE1,A
    54 0115D 040E C        	MOV                 A,RE
    55 0115E 0062 C        	MOV                 BYTE2,A
    56 0115F 040E C        	MOV                 A,RE
    57 01160 0063 C        	MOV                 BYTE3,A
    58 01161 040E C        	MOV                 A,RE
    59 01162 0064 C        	MOV                 BYTE4,A
    60 01163 040E C        	MOV                 A,RE
    61 01164 0065 C        	MOV                 BYTE5,A
    62 01165 040E C        	MOV                 A,RE
    63 01166 0066 C        	MOV                 BYTE6,A
    64 01167 040E C        	MOV                 A,RE
    65 01168 0067 C        	MOV                 BYTE7,A
    66 01169 1810 C        	MOV                 A,@0X10
    67 0116A 004D C        	MOV                 RD,A
    68 0116B 00CE C        	CLR                 RE                                             ;RESET POINTER & COUNTER
    69 0116C 00CD C        	CLR                 RD
    70 0116D 09CC C        	BC                  RC,EP0_W                                       ;CLEAR EP0_W
    71 0116E 08DC C        	BC                  SetupDataStageFlag/8,SetupDataStageFlag%8    ;REFRESH EP0_REPORT COMMAND
    72 0116F 09DC C        	BC                  UsbEP0interruptflag/8,UsbEP0interruptflag%8
    73            C        	;CLR                 TRANSFER
    74            C        
    75            C        ;=========================================================
    76            C        ;USB COMMAND DECODE:
    77            C        ;	|
    78            C        ;	|---STANDARD_DEVICE_REQUESTS
    79            C        ;	|	|
    80            C        ;	|	|---GET_DESCRIPTOR
    81            C        ;	|		|
    82            C        ;	|		|---STANDARD_DESCRIPTOR_TYPE
    83            C        ;	|		|	|
    84            C        ;	|		|	|---GET_DEVICE_D
    85            C        ;	|		|	|---GET_CONFIGURATION_D
    86            C        ;	|		|	|---GET_STRING_D
    87            C        ;	|		|
    88            C        ;	|		|---CLASS_DESCRIPTOR_TYPE
    89            C        ;	|			|
    90            C        ;	|			|---GET_HID_D
    91            C        ;	|			|---GET_REPORT_D
    92            C        ;	|
    93            C        ;	|---CLASS_SPECIFIC_REQUESTS
    94            C        ;		|
    95            C        ;		|---HID_SET_REQUEST
    96            C        ;		|	|
    97            C        ;		|	|---SET_REPORT_R
    98            C        ;		|	|---SET_IDLE_R
    99            C        ;		|	|---SET_PROTOCOL_R
   100            C        ;		|
   101            C        ;		|---HID_GET_REQUEST
   102            C        ;			|
   103            C        ;			|---GET_REPORT_R
   104            C        ;			|---GET_IDLE_R
   105            C        ;			|---GET_PROTOCOL_R
   106            C        ;=========================================================
   107 01170      C        DECODE:
   108 01170 0420 C        	MOV                 A,BYTE0				        ;bmRequestType
   109 01171 1A60 C        	AND                 A,@0B01100000
   110 01172 0C83 C        	JBC                 STATUS,Z
   111 01173 1578 C        	JMP                 STANDARD_DEVICE_REQUESTS	;bmRequestType[6,5]=[0,0]
   112 01174 1B20 C        	XOR                 A,@0B00100000
   113 01175 0C83 C        	JBC                 STATUS,Z
   114 01176 15D5 C        	JMP                 CLASS_SPECIFIC_REQUESTS		;bmRequestType[6,5]=[0,1]    [0,1]
   115 01177 1597 C        	JMP                 STALL_STATUS				;bmRequestType[6,5]=[1,0] OR [1,1]
   116            C        
   117 01178      C        STANDARD_DEVICE_REQUESTS:
   118 01178 1806 C        	MOV                 A,@0B00000110                  ;0X06
   119 01179 0321 C        	XOR                 A,BYTE1				        ;bRequest (Request Code)
   120 0117A 0C83 C        	JBC                 STATUS,Z
   121 0117B 157D C        	JMP                 GET_DESCRIPTOR
   122 0117C 1597 C        	JMP                 STALL_STATUS
   123 0117D      C          GET_DESCRIPTOR:
   124 0117D 00D8 C        	CLR                 TABLE_INDEX
   125 0117E 0423 C        	MOV                 A,BYTE3				        ;wValue (Descriptor Type)
   126 0117F 1A60 C        	AND                 A,@0B01100000
   127 01180 0C83 C        	JBC                 STATUS,Z
   128 01181 1586 C        	JMP                 STANDARD_DESCRIPTOR_TYPE	;wValue[6,5]=[0,0]
   129 01182 1B20 C        	XOR                 A,@0B00100000
   130 01183 0C83 C        	JBC                 STATUS,Z
   131 01184 158F C        	JMP                 CLASS_DESCRIPTOR_TYPE		;wValue[6,5]=[0,1]
   132 01185 1597 C        	JMP                 STALL_STATUS				;wValue[6,5]=[1,0] OR [1,1]
   133            C        
   134 01186      C          STANDARD_DESCRIPTOR_TYPE:
   135 01186 0423 C        	MOV                 A,BYTE3
   136 01187 1D03 C        	SUB                 A,@0X03
   137 01188 0E03 C        	JBS                 STATUS,C
   138 01189 1597 C        	JMP                 STALL_STATUS
   139            C        
   140 0118A 0020 C        	TBL
   141 0118B 15BD C        	JMP                 STRING_SET          ;	3
   142 0118C 15A2 C        	JMP                 CONFIG_SET          ;	2
   143 0118D 159B C        	JMP                 DEVICE_SET          ;	1
   144 0118E 1597 C        	JMP                 STALL_STATUS        ;	0
   145            C        
   146 0118F      C          CLASS_DESCRIPTOR_TYPE:
   147 0118F 1821 C        	MOV                 A,@0X21
   148 01190 0323 C        	XOR                 A,BYTE3
   149 01191 0C83 C        	JBC                 STATUS,2
   150 01192 15AA C        	JMP                 HID_SET             ; GET HID
   151            C        
   152 01193 1822 C        	MOV                 A,@0X22
   153 01194 0323 C        	XOR                 A,BYTE3
   154 01195 0C83 C        	JBC                 STATUS,2
   155 01196 15B4 C        	JMP                 HID_REPORT_SET      ; GET REPORT
   156            C        
   157 01197      C          STALL_STATUS:
   158 01197 0A0C C        	BS                  RC,0
   159 01198 09CC C        	BC                  RC,7
   160 01199 084F C        	BC                  ISR,EP0IF
   161 0119A 160C C        	JMP                 BC_EP0_FLAG
   162            C        ;----------------------------
   163            C        ;	GET DESCRIPTOR
   164            C        ;----------------------------
   165 0119B      C          DEVICE_SET:
   166 0119B 00D3 C        	CLR                 CMD_SELECT
   167 0119C 1812 C        	MOV                 A,@0X12
   168 0119D 0075 C        	MOV                 DataMaxTable1,A
   169 0119E 00F6 C        	CLR                 DataMaxTable2
   170 0119F 00F7 C        	CLR                 DataMaxTable3
   171 011A0 12D1 C        	CALL                Set_Table1_Select
   172 011A1 15CF C        	JMP                 END_DESCRIPTOR
   173            C        
   174 011A2      C          CONFIG_SET:
   175 011A2 1801 C        	MOV                 A,@0X01
   176 011A3 0053 C        	MOV                 CMD_SELECT,A
   177 011A4 1822 C        	MOV                 A,@0X22
   178 011A5 0075 C        	MOV                 DataMaxTable1,A
   179 011A6 00F6 C        	CLR                 DataMaxTable2
   180 011A7 00F7 C        	CLR                 DataMaxTable3
   181 011A8 12D1 C        	CALL                Set_Table1_Select
   182 011A9 15CF C        	JMP                 END_DESCRIPTOR
   183            C        
   184 011AA      C          HID_SET:
   185 011AA 1801 C        	MOV                 A,@0X01
   186 011AB 0053 C        	MOV                 CMD_SELECT,A
   187 011AC 1812 C        	MOV                 A,@0X12
   188 011AD 0058 C        	MOV                 TABLE_INDEX,A
   189 011AE 1809 C        	MOV                 A,@0X09
   190 011AF 0075 C        	MOV                 DataMaxTable1,A
   191 011B0 00F6 C        	CLR                 DataMaxTable2
   192 011B1 00F7 C        	CLR                 DataMaxTable3
   193 011B2 12D1 C        	CALL                Set_Table1_Select
   194 011B3 15CF C        	JMP                 END_DESCRIPTOR
   195            C        
   196 011B4      C          HID_REPORT_SET:
   197 011B4 1802 C        	MOV                 A,@0X02
   198 011B5 0053 C        	MOV                 CMD_SELECT,A
   199 011B6 183E C        	MOV                 A,@(End_HID_Report_Table1-Begin_HID_Report_Table1)
   200 011B7 0075 C        	MOV                 DataMaxTable1,A
   201 011B8 1800 C        	MOV                 A,@(End_HID_Report_Table2-Begin_HID_Report_Table2)
   202 011B9 0076 C        	MOV                 DataMaxTable2,A
   203 011BA 1800 C        	MOV                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   204 011BB 0077 C        	MOV                 DataMaxTable3,A
   205 011BC 15CF C        	JMP                 END_DESCRIPTOR
   206            C        
   207 011BD      C          STRING_SET:
   208 011BD 1800 C        	MOV                 A,@0X00
   209 011BE 0322 C        	XOR                 A,BYTE2
   210 011BF 0C83 C        	JBC                 STATUS,2
   211 011C0 15C5 C        	JMP                 STRING0
   212            C        
   213 011C1 1802 C        	MOV                 A,@0X02
   214 011C2 0322 C        	XOR                 A,BYTE2
   215 011C3 0C83 C        	JBC                 STATUS,2
   216 011C4 15CA C        	JMP                 STRING2
   217 011C5      C          STRING0:
   218 011C5 1806 C        	MOV                 A,@0X06
   219 011C6 0053 C        	MOV                 CMD_SELECT,A
   220 011C7 1804 C        	MOV                 A,@0X04
   221 011C8 0075 C        	MOV                 DataMaxTable1,A
   222 011C9 15CF C        	JMP                 END_DESCRIPTOR
   223            C        
   224 011CA      C          STRING2:
   225 011CA 1807 C        	MOV                 A,@0X07
   226 011CB 0053 C        	MOV                 CMD_SELECT,A
   227 011CC 181E C        	MOV                 A,@0X1E
   228 011CD 0075 C        	MOV                 DataMaxTable1,A
   229 011CE 15CF C        	JMP                 END_DESCRIPTOR
   230            C        
   231 011CF      C          END_DESCRIPTOR:
   232 011CF 0426 C        	MOV                 A,BYTE6
   233 011D0 0073 C        	MOV                 PC_WANT0,A
   234 011D1 0427 C        	MOV                 A,BYTE7
   235 011D2 0074 C        	MOV                 PC_WANT1,A
   236 011D3 0ADC C        	BS                  SetupDataStageFlag/8,SetupDataStageFlag%8
   237 011D4 160C C        	JMP                 BC_EP0_FLAG
   238            C        
   239            C        ;------------------------------------------
   240            C        ;	HID_CLASS_SPECIFIC_REQUESTS
   241            C        ;------------------------------------------
   242 011D5      C        CLASS_SPECIFIC_REQUESTS:
   243 011D5 1821 C        	MOV                 A,@0X21
   244 011D6 0320 C        	XOR                 A,BYTE0
   245 011D7 0C83 C        	JBC                 STATUS,Z
   246 011D8 15DE C        	JMP                 HID_SET_REQUEST
   247            C        
   248 011D9 18A1 C        	MOV                 A,@0XA1
   249 011DA 0320 C        	XOR                 A,BYTE0
   250 011DB 0C83 C        	JBC                 STATUS,Z
   251 011DC 15F8 C        	JMP                 HID_GET_REQUEST
   252 011DD 1597 C        	JMP                 STALL_STATUS
   253            C        
   254 011DE      C          HID_SET_REQUEST:
   255 011DE 1809 C        	MOV                 A,@0X09
   256 011DF 0321 C        	XOR                 A,BYTE1
   257 011E0 0C83 C        	JBC                 STATUS,Z
   258 011E1 15EB C        	JMP                 SET_REPORT
   259            C        
   260 011E2 180A C        	MOV                 A,@0X0A
   261 011E3 0321 C        	XOR                 A,BYTE1
   262 011E4 0C83 C        	JBC                 STATUS,Z
   263 011E5 15EC C        	JMP                 SET_IDLE
   264            C        
   265 011E6 180B C        	MOV                 A,@0X0B
   266 011E7 0321 C        	XOR                 A,BYTE1
   267 011E8 0C83 C        	JBC                 STATUS,Z
   268 011E9 15EF C        	JMP                 SET_PROTOCOL
   269 011EA 1597 C        	JMP                 STALL_STATUS
   270            C        
   271 011EB      C          SET_REPORT:
   272 011EB 15F1 C        	JMP                 SET_RET
   273 011EC      C          SET_IDLE:
   274 011EC 0423 C        	MOV                 A,BYTE3
   275 011ED 0072 C        	MOV                 IDLE_TEMP,A
   276 011EE 15F1 C        	JMP                 SET_RET
   277 011EF      C          SET_PROTOCOL:
   278 011EF 0422 C        	MOV                 A,BYTE2
   279 011F0 0071 C        	MOV                 PROTOCOL_TEMP,A
   280 011F1      C          SET_RET:
   281 011F1 00D8 C        	CLR                 TABLE_INDEX
   282 011F2 00F5 C        	CLR                 DataMaxTable1
   283 011F3 00F3 C        	CLR                 PC_WANT0
   284 011F4 00F4 C        	CLR                 PC_WANT1
   285 011F5 0ADC C        	BS                  SetupDataStageFlag/8,SetupDataStageFlag%8
   286 011F6 0080 C        	CLRA
   287 011F7 160C C        	JMP                 BC_EP0_FLAG
   288            C        
   289 011F8      C          HID_GET_REQUEST:
   290 011F8 0421 C        	MOV                 A,BYTE1
   291 011F9 1D03 C        	SUB                 A,@0X03
   292 011FA 0E03 C        	JBS                 STATUS,C
   293 011FB 1597 C        	JMP                 STALL_STATUS
   294 011FC 0020 C        	TBL
   295 011FD 1604 C        	JMP                 GET_PROTOCOL     ; BYTE1 = 0X03
   296 011FE 1601 C        	JMP                 GET_IDLE         ; BYTE1 = 0X02
   297 011FF 1607 C        	JMP                 GET_REPORT       ; BYTE1 = 0X01
   298 01200 1597 C        	JMP                 STALL_STATUS
   299            C        
   300 01201      C          GET_IDLE:
   301 01201 1803 C        	MOV                 A,@0X03
   302 01202 0053 C        	MOV                 CMD_SELECT,A
   303 01203 1609 C        	JMP                 GET_RET
   304 01204      C          GET_PROTOCOL:
   305 01204 1804 C        	MOV                 A,@0X04
   306 01205 0053 C        	MOV                 CMD_SELECT,A
   307 01206 1609 C        	JMP                 GET_RET
   308 01207      C          GET_REPORT:
   309 01207 1805 C        	MOV                 A,@0X05
   310 01208 0053 C        	MOV                 CMD_SELECT,A
   311 01209      C          GET_RET:
   312 01209 1801 C        	MOV                 A,@0X01
   313 0120A 0075 C        	MOV                 DataMaxTable1,A
   314 0120B 15CF C        	JMP                 END_DESCRIPTOR
   315            C        
   316 0120C      C          BC_EP0_FLAG:
   317 0120C 084F C        	BC                  ISR,EP0IF
   318            C      M 	PAGE                0
       0120D 09C3     1     BC  3 , 7 
       0120E 0983     1     BC  3 , 6 
       0120F 0943     1     BC  3 , 5 
   319 01210 146E C        	JMP                 INT_RET
   320            C        
   321            C        
   322            C        ;===================================================================================
   323            C        ;===================================================================================
   324 01211      C        EP0_REPORT:
   325 01211 0BCC C        	BS                  RC,EP0_W          ;Set 1, when MCU will write data to FIFO
   326 01212 0E4C C        	JBS                 RC,EP0_BUSY       ;It is '1' while UDC write/read endpoint0 FIFO
   327 01213 1616 C        	JMP                 REPORT_INITIAL
   328 01214 09CC C        	BC                  RC,EP0_W          ;if EP0 busy go back main loop wait for udc non-busy
   329 01215 0012 C        	RET
   330 01216      C          REPORT_INITIAL:	                   ;clear pointer and counter
   331 01216 1810 C        	MOV                 A,@0X10
   332 01217 004D C        	MOV                 RD,A       ;set to control pointer & counter
   333 01218 00CE C        	CLR                 RE         ;clear pointer & counter
   334 01219 00CD C        	CLR                 RD         ; FIFO adress=base
   335 0121A      C          REPORT_START:
   336 0121A 0475 C        	MOV                 DataMaxTable1,DataMaxTable1
   337 0121B 0E83 C        	JBS                 STATUS,Z
   338 0121C 1623 C        	JMP                 Load_FIFO_ByteLength	    ;if DataMaxTable1/2/3 = 0  jmp to finish
   339 0121D 0476 C        	MOV                 DataMaxTable2,DataMaxTable2
   340 0121E 0E83 C        	JBS                 STATUS,Z
   341 0121F 1623 C        	JMP                 Load_FIFO_ByteLength
   342 01220 0477 C        	MOV                 DataMaxTable3,DataMaxTable3
   343 01221 0C83 C        	JBC                 STATUS,Z
   344 01222 16E9 C        	JMP                 FINISH
   345            C        
   346 01223      C          Load_FIFO_ByteLength:
   347 01223 1808 C        	MOV                 A,@0X08
   348 01224 005A C        	MOV                 DataByteLength,A
   349            C        	;CLR                 RE
   350 01225 00CD C        	CLR                 RD
   351 01226      C          REPORT_LOOP:
   352 01226 0413 C        	MOV                 A,CMD_SELECT
   353 01227 0020 C        	TBL
   354 01228 1630 C        	JMP                 DEVICE_LOOP	;0
   355 01229 1639 C        	JMP                 CONFIG_LOOP	;1
   356 0122A 1642 C        	JMP                 HID_REPORTL	;2
   357 0122B 1663 C        	JMP                 IDLE_LOOP	;3
   358 0122C 1665 C        	JMP                 PROTOCOLL	;4
   359 0122D 1667 C        	JMP                 REPORT_EP0	;5
   360 0122E 166E C        	JMP                 STRING0L	;6
   361            C        	;JMP                 STRING1L    ;7
   362 0122F 1677 C        	JMP                 STRING2L	;8
   363            C        
   364            C        ;-------------------------------------------------------------
   365 01230      C          DEVICE_LOOP:
   366 01230 0418 C        	MOV                 A,TABLE_INDEX
   367            C      M 	PAGE                3
       01231 09C3     1     BC  3 , 7 
       01232 0B83     1     BS  3 , 6 
       01233 0B43     1     BS  3 , 5 
   368 01234 1000 C        	CALL                DEVICE_TABLE
   369            C      M 	PAGE                4
       01235 0BC3     1     BS  3 , 7 
       01236 0983     1     BC  3 , 6 
       01237 0943     1     BC  3 , 5 
   370 01238 1682 C        	JMP                 RLOOP
   371            C        ;-------------------------------------------------------------
   372 01239      C          CONFIG_LOOP:
   373 01239 0418 C        	MOV                 A,TABLE_INDEX
   374            C      M 	PAGE                3
       0123A 09C3     1     BC  3 , 7 
       0123B 0B83     1     BS  3 , 6 
       0123C 0B43     1     BS  3 , 5 
   375 0123D 1013 C        	CALL                CONFIG_TABLE
   376            C      M 	PAGE                4
       0123E 0BC3     1     BS  3 , 7 
       0123F 0983     1     BC  3 , 6 
       01240 0943     1     BC  3 , 5 
   377 01241 1682 C        	JMP                 RLOOP
   378            C        ;-------------------------------------------------------------
   379 01242      C          HID_REPORTL:
   380 01242 0D1C C        	JBC                 TableSelectFlag1/8,TableSelectFlag1%8
   381 01243 1648 C        	JMP                 HID_Table_1st
   382 01244 0D5C C        	JBC                 TableSelectFlag2/8,TableSelectFlag2%8
   383 01245 1651 C        	JMP                 HID_Table_2nd
   384 01246 0D9C C        	JBC                 TableSelectFlag3/8,TableSelectFlag3%8
   385 01247 165A C        	JMP                 HID_Table_3rd
   386            C        
   387 01248      C          HID_Table_1st:
   388 01248 0418 C        	MOV                 A,TABLE_INDEX
   389            C      M 	PAGE                3
       01249 09C3     1     BC  3 , 7 
       0124A 0B83     1     BS  3 , 6 
       0124B 0B43     1     BS  3 , 5 
   390 0124C 1100 C        	CALL                HID_REPORT_TABLE1
   391            C      M 	PAGE                4
       0124D 0BC3     1     BS  3 , 7 
       0124E 0983     1     BC  3 , 6 
       0124F 0943     1     BC  3 , 5 
   392 01250 1682 C        	JMP                 RLOOP
   393 01251      C          HID_Table_2nd:
   394 01251 0418 C        	MOV                 A,TABLE_INDEX
   395            C      M 	PAGE                3
       01252 09C3     1     BC  3 , 7 
       01253 0B83     1     BS  3 , 6 
       01254 0B43     1     BS  3 , 5 
   396 01255 1140 C        	CALL                HID_REPORT_TABLE2
   397            C      M 	PAGE                4
       01256 0BC3     1     BS  3 , 7 
       01257 0983     1     BC  3 , 6 
       01258 0943     1     BC  3 , 5 
   398 01259 1682 C        	JMP                 RLOOP
   399 0125A      C          HID_Table_3rd:
   400 0125A 0418 C        	MOV                 A,TABLE_INDEX
   401            C      M 	PAGE                3
       0125B 09C3     1     BC  3 , 7 
       0125C 0B83     1     BS  3 , 6 
       0125D 0B43     1     BS  3 , 5 
   402 0125E 1142 C        	CALL                HID_REPORT_TABLE3
   403            C      M 	PAGE                4
       0125F 0BC3     1     BS  3 , 7 
       01260 0983     1     BC  3 , 6 
       01261 0943     1     BC  3 , 5 
   404 01262 1682 C        	JMP                 RLOOP
   405            C        ;--------------------------------------------------------------
   406 01263      C          IDLE_LOOP:
   407 01263 0432 C        	MOV                 A,IDLE_TEMP
   408 01264 1682 C        	JMP                 RLOOP
   409            C        ;---------------------------------------------------------------
   410 01265      C          PROTOCOLL:
   411 01265 0431 C        	MOV                 A,PROTOCOL_TEMP
   412 01266 1682 C        	JMP                 RLOOP
   413            C        ;---------------------------------------------------------------
   414 01267      C          REPORT_EP0:
   415 01267 1810 C        	MOV                 A,@0X10
   416 01268 004D C        	MOV                 RD,A		;EP0 POINTER&COUNTER
   417 01269 00CE C        	CLR                 RE
   418 0126A 1800 C        	MOV                 A,@0X00
   419 0126B 004D C        	MOV                 RD,A		;EP0 FIFO
   420 0126C 12ED C        	CALL                SEND_USB_DATA
   421 0126D 16E9 C        	JMP                 FINISH
   422            C        ;---------------------------------------------------------------
   423 0126E      C          STRING0L:
   424 0126E 0418 C        	MOV                 A,TABLE_INDEX
   425            C      M 	PAGE                3
       0126F 09C3     1     BC  3 , 7 
       01270 0B83     1     BS  3 , 6 
       01271 0B43     1     BS  3 , 5 
   426 01272 1036 C        	CALL                STRING0T
   427            C      M 	PAGE                4
       01273 0BC3     1     BS  3 , 7 
       01274 0983     1     BC  3 , 6 
       01275 0943     1     BC  3 , 5 
   428 01276 1682 C        	JMP                 RLOOP
   429            C        
   430            C        ;STRING1L:
   431            C        ;	CALL                STRING_SUB
   432            C        ;	CALL                STRING1T
   433            C        ;	JMP                 RLOOP
   434            C        
   435 01277      C          STRING2L:
   436 01277 1279 C        	CALL                STRING_SUB
   437 01278 1682 C        	JMP                 RLOOP
   438            C        
   439 01279      C          STRING_SUB:
   440 01279 0418 C        	MOV                 A,TABLE_INDEX
   441 0127A 1D01 C        	SUB	                A,@0X01
   442 0127B 0C03 C        	JBC                 STATUS,C
   443 0127C 0012 C        	RET
   444 0127D 0C18 C        	JBC                 TABLE_INDEX,0
   445 0127E 1C02 C        	RETL                @0X02
   446 0127F 0618 C        	RRCA                TABLE_INDEX
   447 01280 1F02 C        	ADD                 A,@0X02
   448 01281 0012 C        	RET
   449            C        
   450            C        ;***************************************************************
   451            C        ;***************************************************************
   452 01282      C        RLOOP:
   453 01282 004E C        	MOV                 RE,A
   454 01283 0558 C        	INC                 TABLE_INDEX
   455 01284 01F3 C        	DEC                 PC_WANT0
   456 01285 0473 C        	MOV                 PC_WANT0,PC_WANT0
   457 01286 0C83 C        	JBC                 STATUS,Z
   458 01287 16BE C        	JMP                 Null_Data                 ;PC_WANT0 null data
   459            C        
   460 01288      C          To_Continue:
   461 01288 0477 C        	MOV                 DataMaxTable3,DataMaxTable3
   462 01289 0E83 C        	JBS                 STATUS,Z
   463 0128A 1691 C        	JMP                 Continue_Fill_In_8Byte
   464 0128B 0476 C        	MOV                 DataMaxTable2,DataMaxTable2
   465 0128C 0E83 C        	JBS                 STATUS,Z
   466 0128D 1691 C        	JMP                 Continue_Fill_In_8Byte
   467 0128E 0475 C        	MOV                 DataMaxTable1,DataMaxTable1
   468 0128F 0C83 C        	JBC                 STATUS,Z
   469 01290 16E9 C        	JMP                 FINISH
   470            C        
   471 01291      C          Continue_Fill_In_8Byte:
   472 01291 05DA C        	DJZ                 DataByteLength
   473 01292 169B C        	JMP                 Fill_In_8Byte_Cycle
   474            C        
   475 01293 0D9C C        	JBC                 TableSelectFlag3/8,TableSelectFlag3%8
   476 01294 01F7 C        	DEC                 DataMaxTable3
   477 01295 0D5C C        	JBC                 TableSelectFlag2/8,TableSelectFlag2%8
   478 01296 01F6 C        	DEC                 DataMaxTable2
   479 01297 0D1C C        	JBC                 TableSelectFlag1/8,TableSelectFlag1%8
   480 01298 01F5 C        	DEC                 DataMaxTable1
   481 01299 12C7 C        	CALL                Set_Table_Select
   482 0129A 16C3 C        	JMP                 END_Fill_In_8Byte_Cycle   ;8 byte full , End this cycle
   483            C        
   484 0129B      C          Fill_In_8Byte_Cycle:
   485 0129B 0D9C C        	JBC                 TableSelectFlag3/8,TableSelectFlag3%8
   486 0129C 01F7 C        	DEC                 DataMaxTable3
   487 0129D 0D5C C        	JBC                 TableSelectFlag2/8,TableSelectFlag2%8
   488 0129E 01F6 C        	DEC                 DataMaxTable2
   489 0129F 0D1C C        	JBC                 TableSelectFlag1/8,TableSelectFlag1%8
   490 012A0 01F5 C        	DEC                 DataMaxTable1
   491 012A1 12C7 C        	CALL                Set_Table_Select
   492 012A2 0477 C        	MOV                 DataMaxTable3,DataMaxTable3
   493 012A3 0E83 C        	JBS                 STATUS,Z
   494 012A4 16AC C        	JMP                 HID_NOT_END
   495 012A5 0476 C        	MOV                 DataMaxTable2,DataMaxTable2
   496 012A6 0E83 C        	JBS                 STATUS,Z
   497 012A7 16AC C        	JMP                 HID_NOT_END
   498 012A8 0475 C        	MOV                 DataMaxTable1,DataMaxTable1
   499 012A9 0E83 C        	JBS                 STATUS,Z
   500 012AA 16AC C        	JMP                 HID_NOT_END
   501 012AB 16C3 C        	JMP                 END_Fill_In_8Byte_Cycle
   502 012AC      C          HID_NOT_END:
   503 012AC 0D1C C        	JBC                 TableSelectFlag1/8,TableSelectFlag1%8
   504 012AD 16B2 C        	JMP                 Table1_Sel
   505 012AE 0D5C C        	JBC                 TableSelectFlag2/8,TableSelectFlag2%8
   506 012AF 16B6 C        	JMP                 Table2_Sel
   507 012B0 0D9C C        	JBC                 TableSelectFlag3/8,TableSelectFlag3%8
   508 012B1 16BA C        	JMP                 Table3_Sel
   509 012B2      C          Table1_Sel:
   510            C        	;DEC                 DataMaxTable1
   511 012B2 0475 C        	MOV                 DataMaxTable1,DataMaxTable1
   512 012B3 0C83 C        	JBC                 STATUS,Z
   513 012B4 16E9 C        	JMP                 FINISH
   514 012B5 1626 C        	JMP                 REPORT_LOOP
   515 012B6      C          Table2_Sel:
   516            C        	;DEC                 DataMaxTable2
   517 012B6 0476 C        	MOV                 DataMaxTable2,DataMaxTable2
   518 012B7 0C83 C        	JBC                 STATUS,Z
   519 012B8 16E9 C        	JMP                 FINISH
   520 012B9 1626 C        	JMP                 REPORT_LOOP
   521 012BA      C          Table3_Sel:
   522            C        	;DEC                 DataMaxTable3
   523 012BA 0477 C        	MOV                 DataMaxTable3,DataMaxTable3
   524 012BB 0C83 C        	JBC                 STATUS,Z
   525 012BC 16E9 C        	JMP                 FINISH
   526 012BD 1626 C        	JMP                 REPORT_LOOP
   527            C        
   528 012BE      C          Null_Data:
   529 012BE 0434 C        	MOV                 A,PC_WANT1
   530 012BF 0C83 C        	JBC                 STATUS,Z
   531 012C0 16E9 C        	JMP                 FINISH
   532 012C1 01F4 C        	DEC                 PC_WANT1
   533 012C2 1688 C        	JMP                 To_Continue
   534            C        
   535 012C3      C          END_Fill_In_8Byte_Cycle:
   536 012C3 0000 C        	NOP
   537 012C4 09CC C        	BC                  RC,7
   538 012C5 0B8C C        	BS                  RC,6
   539 012C6 0012 C        	RET
   540            C        
   541 012C7      C          Set_Table_Select:
   542 012C7 0477 C        	MOV                 DataMaxTable3,DataMaxTable3
   543 012C8 0E83 C        	JBS                 STATUS,Z
   544 012C9 12E1 C        	CALL                Set_Table3_Select
   545 012CA 0476 C        	MOV                 DataMaxTable2,DataMaxTable2
   546 012CB 0E83 C        	JBS                 STATUS,Z
   547 012CC 12D9 C        	CALL                Set_Table2_Select
   548 012CD 0475 C        	MOV                 DataMaxTable1,DataMaxTable1
   549 012CE 0E83 C        	JBS                 STATUS,Z
   550 012CF 12D1 C        	CALL                Set_Table1_Select
   551 012D0 0012 C        	RET
   552 012D1      C          Set_Table1_Select:
   553 012D1 0B1C C        	BS                  TableSelectFlag1/8,TableSelectFlag1%8
   554 012D2 095C C        	BC                  TableSelectFlag2/8,TableSelectFlag2%8
   555 012D3 099C C        	BC                  TableSelectFlag3/8,TableSelectFlag3%8
   556 012D4 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   557 012D5 1B00 C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   558 012D6 0C83 C        	JBC                 STATUS,Z
   559 012D7 00D8 C        	CLR                 TABLE_INDEX
   560 012D8 0012 C        	RET
   561 012D9      C          Set_Table2_Select:
   562 012D9 091C C        	BC                  TableSelectFlag1/8,TableSelectFlag1%8
   563 012DA 0B5C C        	BS                  TableSelectFlag2/8,TableSelectFlag2%8
   564 012DB 099C C        	BC                  TableSelectFlag3/8,TableSelectFlag3%8
   565 012DC 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   566 012DD 1B00 C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   567 012DE 0C83 C        	JBC                 STATUS,Z
   568 012DF 00D8 C        	CLR                 TABLE_INDEX
   569 012E0 0012 C        	RET
   570 012E1      C          Set_Table3_Select:
   571 012E1 091C C        	BC                  TableSelectFlag1/8,TableSelectFlag1%8
   572 012E2 095C C        	BC                  TableSelectFlag2/8,TableSelectFlag2%8
   573 012E3 0B9C C        	BS                  TableSelectFlag3/8,TableSelectFlag3%8
   574 012E4 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   575 012E5 1B00 C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   576 012E6 0C83 C        	JBC                 STATUS,Z
   577 012E7 00D8 C        	CLR                 TABLE_INDEX
   578 012E8 0012 C        	RET
   579            C        ;=========================================================
   580 012E9      C          FINISH:
   581 012E9 09CC C        	BC                  RC,7
   582 012EA 0B8C C        	BS                  RC,6
   583 012EB 08DC C        	BC                  SetupDataStageFlag/8,SetupDataStageFlag%8
   584 012EC 0012 C        	RET
   585            C        
   586            C        
   587            C        ;=================================================================
   588            C        ;	USB DATA FORMAT
   589            C        ;	BYTE1	BYTE2	BYTE3	BYTE4	BYTE5	BYTE6	BYTE7	BYTE8
   590            C        ;   BOOT	BTM	X_8	Y_8	--	--	--	--	--
   591            C        ;=================================================================
   592 012ED      C        SEND_USB_DATA:
   593 012ED 1801 C        	MOV                 A,@0X01
   594 012EE 004E C        	MOV                 RE,A			;BYTE1(BTM)
   595            C        
   596 012EF      C          REPORT_PROTOCOL_DATA:
   597 012EF 187F C        	MOV                 A,@0X7F
   598 012F0 004E C        	MOV                 RE,A			;BYTE2(X)
   599 012F1 004E C        	MOV                 RE,A			;BYTE3(Y)
   600 012F2 004E C        	MOV                 RE,A			;BYTE4
   601 012F3 004E C        	MOV                 RE,A			;BYTE5
   602 012F4 183F C        	MOV                 A,@0X3F
   603 012F5 004E C        	MOV                 RE,A			;BYTE6(X)
   604 012F6 1800 C        	MOV                 A,@0X00
   605 012F7 004E C        	MOV                 RE,A			;BYTE7(X)
   606 012F8 004E C        	MOV                 RE,A			;BYTE8(X)
   607            C        
   608 012F9 0C0D C        	JBC                 RD,0		;CHECK EP0 or EP1
   609 012FA 0B4C C        	BS                  RC,EP1_R
   610 012FB      C          RETURN:
   611 012FB 0012 C        	RET
   612            C        
   613            C        
   614            C        
   615            C        ;=================================================================================
   616            C        ;================================================================================
   617 012FC      C        USB_MAIN:
   618 012FC 0DDC C        	JBC                 UsbEP0interruptflag/8,UsbEP0interruptflag%8
   619 012FD 0012 C        	RET
   620 012FE 08DD C        	BC                  USBReportFinishFlag/8,USBReportFinishFlag%8
   621 012FF 041B C        	MOV                 A,ComuClock    ;8ms
   622 01300 1D64 C        	SUB                 A,@100
   623 01301 0C03 C        	JBC                 STATUS,C
   624 01302 170E C        	JMP                 Add_TimeCount
   625 01303 0550 C        	INC                 TEMP
   626 01304 00DB C        	CLR                 ComuClock
   627 01305 0410 C        	MOV                 A,TEMP
   628 01306 1D0A C        	SUB                 A,@10           ;T = 0x10*0X30*ComuClock
   629 01307 0C03 C        	JBC                 STATUS,C
   630 01308 170E C        	JMP                 Add_TimeCount
   631 01309 0000 C        	NOP
   632 0130A 00D0 C        	CLR                 TEMP
   633 0130B 0BDC C        	BS                  UsbEP0interruptflag/8,UsbEP0interruptflag%8
   634 0130C 0ADD C        	BS                  USBReportFinishFlag/8,USBReportFinishFlag%8
   635 0130D 0012 C        	RET
   636 0130E      C         Add_TimeCount:
   637 0130E 0000 C        	NOP
   638 0130F 10EB C        	CALL                PAGE4BANK0
   639 01310 0D8C C        	JBC                 RC,EP0_R       ;EP0 FIFO READED ；it is auto clear by udc and data send out finish
   640 01311 16FC C        	JMP                 USB_MAIN
   641 01312 0CDC C        	JBC                 SetupDataStageFlag/8,SetupDataStageFlag%8    ;CHECK SETUP TRANSFER DATA STAGE
   642 01313 1211 C        	CALL                EP0_REPORT
   643 01314 0000 C        	NOP
   644 01315 16FC C        	JMP                 USB_MAIN
   645            C        
   646            C        
   647            C        /*
   648            C        ;=====================================================================
   649            C        EP1_Report_Default:
   650            C        	CALL                PAGE4BANK3
   651            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   652            C        	RET
   653            C        	BC                  RC,EP1_R
   654            C        	MOV                 A,@0X11
   655            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   656            C        	CLR                 RE
   657            C        	MOV                 A,@0X01
   658            C        	MOV                 RD,A        ;EP1 FIFO
   659            C        
   660            C        	MOV                 A,EP1_ReportID
   661            C        	MOV                 RE,A             ;BYTE1 (ID)
   662            C        	MOV                 A,@0X7F
   663            C        	MOV                 RE,A             ;BYTE2 (LX)
   664            C        	MOV                 RE,A             ;BYTE3 (LY)
   665            C        	MOV                 RE,A             ;BYTE4 (RX)
   666            C        	MOV                 RE,A             ;BYTE5 (RY)
   667            C        	MOV                 A,@0X00
   668            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   669            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   670            C        	MOV                 A,@0X0F
   671            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   672            C        
   673            C        	BS                  RC,EP1_R
   674            C        	RET
   675            C        
   676            C        
   677            C        ;--------------------------------------------------------------------
   678            C        EP1_Report_1st:
   679            C        	CALL                PAGE4BANK2
   680            C        	JBC                 RC,EP1_R         ;CHECK EP1 DATA HAS BEEN READED BY HOST
   681            C        	RET
   682            C        	BC                  RC,EP1_R
   683            C        	MOV                 A,@0X11
   684            C        	MOV                 RD,A		     ;EP1 POINTER&COUNTER
   685            C        	CLR                 RE
   686            C        	MOV                 A,@0X01
   687            C        	MOV                 RD,A             ;EP1 FIFO
   688            C        
   689            C        	MOV                 A,@0X01
   690            C        	MOV                 RE,A             ;BYTE1 (ID)
   691            C        	MOV                 A,TX1_DATA1
   692            C        	MOV                 RE,A             ;BYTE2 (LX)
   693            C        	MOV                 A,TX1_DATA2
   694            C        	MOV                 RE,A             ;BYTE3 (LY)
   695            C        	MOV                 A,TX1_DATA3
   696            C        	MOV                 RE,A             ;BYTE4 (RX)
   697            C        	MOV                 A,TX1_DATA4
   698            C        	MOV                 RE,A             ;BYTE5 (RY)
   699            C        	MOV                 A,TX1_DATA5
   700            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   701            C        	MOV                 A,TX1_DATA6
   702            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   703            C        	MOV                 A,TX1_DATA7
   704            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   705            C        
   706            C        	BS                  RC,EP1_R
   707            C        	RET
   708            C        
   709            C        ;------------------------------------------------------------------------
   710            C        EP1_Report_2nd:
   711            C        	NOP
   712            C        	CALL                PAGE4BANK2
   713            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   714            C        	RET
   715            C        	BC                  RC,EP1_R
   716            C        	MOV                 A,@0X11
   717            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   718            C        	CLR                 RE
   719            C        	MOV                 A,@0X01
   720            C        	MOV                 RD,A        ;EP1 FIFO
   721            C        
   722            C        	MOV                 A,@0X02
   723            C        	MOV                 RE,A             ;BYTE1 (ID)
   724            C        	MOV                 A,TX2_DATA1
   725            C        	MOV                 RE,A             ;BYTE2 (LX)
   726            C        	MOV                 A,TX2_DATA2
   727            C        	MOV                 RE,A             ;BYTE3 (LY)
   728            C        	MOV                 A,TX2_DATA3
   729            C        	MOV                 RE,A             ;BYTE4 (RX)
   730            C        	MOV                 A,TX2_DATA4
   731            C        	MOV                 RE,A             ;BYTE5 (RY)
   732            C        	MOV                 A,TX2_DATA5
   733            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   734            C        	MOV                 A,TX2_DATA6
   735            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   736            C        	MOV                 A,TX2_DATA7
   737            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   738            C        
   739            C        	BS                  RC,EP1_R
   740            C        	RET
   741            C        
   742            C        
   743            C        ;---------------------------------------------------------------------------
   744            C        EP1_Report_3rd:
   745            C        	CALL                PAGE4BANK2
   746            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   747            C        	RET
   748            C        	BC                  RC,EP1_R
   749            C        	MOV                 A,@0X11
   750            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   751            C        	CLR                 RE
   752            C        	MOV                 A,@0X01
   753            C        	MOV                 RD,A        ;EP1 FIFO
   754            C        
   755            C        	MOV                 A,@0X03
   756            C        	MOV                 RE,A             ;BYTE1 (ID)
   757            C        	MOV                 A,TX3_DATA1
   758            C        	MOV                 RE,A             ;BYTE2 (LX)
   759            C        	MOV                 A,TX3_DATA2
   760            C        	MOV                 RE,A             ;BYTE3 (LY)
   761            C        	MOV                 A,TX3_DATA3
   762            C        	MOV                 RE,A             ;BYTE4 (RX)
   763            C        	MOV                 A,TX3_DATA4
   764            C        	MOV                 RE,A             ;BYTE5 (RY)
   765            C        	MOV                 A,TX3_DATA5
   766            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   767            C        	MOV                 A,TX3_DATA6
   768            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   769            C        	MOV                 A,TX3_DATA7
   770            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   771            C        
   772            C        	BS                  RC,EP1_R
   773            C        	RET
   774            C        
   775            C        ;---------------------------------------------------------------------------
   776            C        EP1_Report_4th:
   777            C        	CALL                PAGE4BANK2
   778            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   779            C        	RET
   780            C        	BC                  RC,EP1_R
   781            C        	MOV                 A,@0X11
   782            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   783            C        	CLR                 RE
   784            C        	MOV                 A,@0X01
   785            C        	MOV                 RD,A        ;EP1 FIFO
   786            C        
   787            C        	MOV                 A,@0X04
   788            C        	MOV                 RE,A             ;BYTE1 (ID)
   789            C        	MOV                 A,TX4_DATA1
   790            C        	MOV                 RE,A             ;BYTE2 (LX)
   791            C        	MOV                 A,TX4_DATA2
   792            C        	MOV                 RE,A             ;BYTE3 (LY)
   793            C        	MOV                 A,TX4_DATA3
   794            C        	MOV                 RE,A             ;BYTE4 (RX)
   795            C        	MOV                 A,TX4_DATA4
   796            C        	MOV                 RE,A             ;BYTE5 (RY)
   797            C        	MOV                 A,TX4_DATA5
   798            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   799            C        	MOV                 A,TX4_DATA6
   800            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   801            C        	MOV                 A,TX4_DATA7
   802            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   803            C        
   804            C        	BS                  RC,EP1_R
   805            C        	RET
   806            C        
   807            C        ;---------------------------------------------------------------------------
   808            C        EP1_Report_5th:
   809            C        	CALL                PAGE4BANK3
   810            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   811            C        	RET
   812            C        	BC                  RC,EP1_R
   813            C        	MOV                 A,@0X11
   814            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   815            C        	CLR                 RE
   816            C        	MOV                 A,@0X01
   817            C        	MOV                 RD,A        ;EP1 FIFO
   818            C        
   819            C        	MOV                 A,@0X05
   820            C        	MOV                 RE,A             ;BYTE1 (ID)
   821            C        	MOV                 A,TX5_DATA1
   822            C        	MOV                 RE,A             ;BYTE2 (LX)
   823            C        	MOV                 A,TX5_DATA2
   824            C        	MOV                 RE,A             ;BYTE3 (LY)
   825            C        	MOV                 A,TX5_DATA3
   826            C        	MOV                 RE,A             ;BYTE4 (RX)
   827            C        	MOV                 A,TX5_DATA4
   828            C        	MOV                 RE,A             ;BYTE5 (RY)
   829            C        	MOV                 A,TX5_DATA5
   830            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   831            C        	MOV                 A,TX5_DATA6
   832            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   833            C        	MOV                 A,TX5_DATA7
   834            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   835            C        
   836            C        	BS                  RC,EP1_R
   837            C        	RET
   838            C        
   839            C        ;---------------------------------------------------------------------------
   840            C        EP1_Report_6th:
   841            C        	CALL                PAGE4BANK3
   842            C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   843            C        	RET
   844            C        	BC                  RC,EP1_R
   845            C        	MOV                 A,@0X11
   846            C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   847            C        	CLR                 RE
   848            C        	MOV                 A,@0X01
   849            C        	MOV                 RD,A        ;EP1 FIFO
   850            C        
   851            C        	MOV                 A,@0X06
   852            C        	MOV                 RE,A             ;BYTE1 (ID)
   853            C        	MOV                 A,TX6_DATA1
   854            C        	MOV                 RE,A             ;BYTE2 (LX)
   855            C        	MOV                 A,TX6_DATA2
   856            C        	MOV                 RE,A             ;BYTE3 (LY)
   857            C        	MOV                 A,TX6_DATA3
   858            C        	MOV                 RE,A             ;BYTE4 (RX)
   859            C        	MOV                 A,TX6_DATA4
   860            C        	MOV                 RE,A             ;BYTE5 (RY)
   861            C        	MOV                 A,TX6_DATA5
   862            C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   863            C        	MOV                 A,TX6_DATA6
   864            C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   865            C        	MOV                 A,TX6_DATA7
   866            C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   867            C        
   868            C        	BS                  RC,EP1_R
   869            C        	RET
   870            C        */
   871            C        
   872            C        ;=====================================================================
   873 01316      C        EP1_Report_Default:
   874 01316 0000 C        	NOP
   875 01317 10F4 C        	CALL                PAGE4BANK3
   876 01318 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   877 01319 0012 C        	RET
   878 0131A 094C C        	BC                  RC,EP1_R
   879 0131B 1811 C        	MOV                 A,@0X11
   880 0131C 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   881 0131D 00CE C        	CLR                 RE
   882 0131E 1801 C        	MOV                 A,@0X01
   883 0131F 004D C        	MOV                 RD,A        ;EP1 FIFO
   884            C        
   885 01320 1800 C        	MOV                 A,@0x00
   886 01321 004E C        	MOV                 RE,A             ;BYTE1 (buttom)
   887 01322 1800 C        	MOV                 A,@0x00
   888 01323 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   889 01324 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   890 01325 1800 C        	MOV                 A,@0x00
   891 01326 004E C        	MOV                 RE,A             ;BYTE8 (roll)
   892            C        
   893 01327 0B4C C        	BS                  RC,EP1_R
   894 01328 0000 C        	NOP
   895 01329 0012 C        	RET
   896            C        
   897            C        
   898            C        ;--------------------------------------------------------------------
   899 0132A      C        EP1_Report_1st:
   900 0132A 0000 C        	NOP
   901 0132B 10F1 C        	CALL                PAGE4BANK2
   902 0132C 0D4C C        	JBC                 RC,EP1_R         ;CHECK EP1 DATA HAS BEEN READED BY HOST
   903 0132D 0012 C        	RET
   904 0132E 094C C        	BC                  RC,EP1_R
   905 0132F 1811 C        	MOV                 A,@0X11
   906 01330 004D C        	MOV                 RD,A		     ;EP1 POINTER&COUNTER
   907 01331 00CE C        	CLR                 RE
   908 01332 1801 C        	MOV                 A,@0X01
   909 01333 004D C        	MOV                 RD,A             ;EP1 FIFO
   910            C        
   911 01334 1800 C        	MOV                 A,@0x00
   912 01335 004E C        	MOV                 RE,A             ;BYTE1 (buttom)
   913 01336 0428 C        	MOV                 A,DataA_Buffer
   914 01337 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   915 01338 0429 C        	MOV                 A,DataB_Buffer
   916 01339 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   917 0133A 1800 C        	MOV                 A,@0x00
   918 0133B 004E C        	MOV                 RE,A             ;BYTE8 (roll)
   919            C        
   920 0133C 0B4C C        	BS                  RC,EP1_R
   921 0133D 0012 C        	RET
   922            C        
   923            C        ;------------------------------------------------------------------------
   924 0133E      C        EP1_Report_2nd:
   925 0133E 0000 C        	NOP
   926 0133F 10F1 C        	CALL                PAGE4BANK2
   927 01340 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   928 01341 0012 C        	RET
   929 01342 094C C        	BC                  RC,EP1_R
   930 01343 1811 C        	MOV                 A,@0X11
   931 01344 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   932 01345 00CE C        	CLR                 RE
   933 01346 1801 C        	MOV                 A,@0X01
   934 01347 004D C        	MOV                 RD,A        ;EP1 FIFO
   935            C        
   936 01348 1800 C        	MOV                 A,@0x00
   937 01349 004E C        	MOV                 RE,A             ;BYTE1 (buttom)
   938 0134A 0428 C        	MOV                 A,DataA_Buffer
   939 0134B 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   940 0134C 0429 C        	MOV                 A,DataB_Buffer
   941 0134D 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   942 0134E 1800 C        	MOV                 A,@0x00
   943 0134F 004E C        	MOV                 RE,A             ;BYTE8 (roll)
   944            C        
   945 01350 0B4C C        	BS                  RC,EP1_R
   946 01351 0012 C        	RET
   947            C        
   948            C        
   949            C        
   950            C        
   951            C        
    21                     ;include "XX24C04.ASM"
    22                     ;include "FccTest.ASM"
    23                     
    24                     ifndef XX93C46_For_EM78M611.ASM
    25                     include "XX93C46_For_EM78M611.ASM"
    26                     endif
    27                     
    28                     
    29                     ;=======================================================================
    30                     ;-------------------------- Program start ---------------------------
    31                     ;=======================================================================
    32                     	ORG                 0X0000
    33 00000 1474          	JMP                 MCU_RESET
    34                     	ORG                 0X0001        ; TCC interrupt vector
    35                   M 	PUSH                              ; save ACC,R3,R4
       00001 0054     1     MOV  A_TEMP ,A
       00002 0754     1     SWAP  A_TEMP ,
       00003 0703     1     SWAPA  3 ,
       00004 0056     1     MOV  STATUS_TEMP ,A
       00005 0704     1     SWAPA  4 ,
       00006 0055     1     MOV  RSR_TEMP ,A
       00007 00C3     1     CLR  3 ,
    36 00008 00C4          	CLR                 RSR
    37 00009 1450          	JMP                 TCC_INT_STATE
    38                     
    39                     ;=========================================================================
    40                     ; Program code
    41                     ;=========================================================================
    42                     	ORG                 0X0050
    43 00050               TCC_INT_STATE:
    44 00050 0000          	NOP
    45 00051 0C4F          	JBC                 ISR,EP0IF
    46 00052 1464          	JMP                 USB_EP0_INT
    47 00053 0CCF          	JBC                 ISR,USBRIF
    48 00054 146A          	JMP                 USB_RESET_INT
    49 00055 0C0F          	JBC                 ISR,TCCIF
    50 00056 1459          	JMP                 RF_CYCLE_INT
    51 00057 0C8F          	JBC                 ISR,USBSIF
    52 00058 1468          	JMP                 USB_SUSPEND_INT
    53 00059               RF_CYCLE_INT:
    54 00059 18D1          	MOV                 A,@(256-47)  ; N=47,P=64,f=6MHz ==> T=1ms
    55 0005A 0041          	MOV                 TCC,A
    56 0005B 080F          	BC                  ISR,TCCIF
    57 0005C 055B          	INC                 ComuClock    ; 1ms intrrupt and the master timing
    58 0005D 0557          	INC                 SystemTimeCNT
    59                       if TCC_T_DEBUG & DebugDisplay == 1
    60 0005E 1880          	MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
    61 0005F 0345          	XOR                 PORT5,A
    62                       endif
    63 00060 11BD          	CALL                PAGE0BANK1
    64 00061 0579          	INC                 RX_ComuLoseCNT
    65 00062 0576          	INC                 KeySystemTimeCNT
    66 00063 146E          	JMP                 INT_RET
    67 00064               USB_EP0_INT:
    68                   M 	PAGE                4
       00064 0BC3     1     BS  3 , 7 
       00065 0983     1     BC  3 , 6 
       00066 0943     1     BC  3 , 5 
    69 00067 1550          	JMP                 READ_COMMAND ; EP0 Intrrupt flag,wating for Host'CMD
    70 00068               USB_SUSPEND_INT:                     ; USB bus terminated intrrupt
    71 00068 088F          	BC                  ISR,USBSIF
    72 00069 146E          	JMP                 INT_RET
    73 0006A               USB_RESET_INT:
    74 0006A 1801          	MOV                 A,@0X01
    75 0006B 0071          	MOV                 PROTOCOL_TEMP,A
    76 0006C 08CF          	BC                  ISR,USBRIF
    77 0006D 146E          	JMP                 INT_RET
    78 0006E               INT_RET:
    79                   M 	POP                              ; restore ACC,R3,R4
       0006E 0716     1     SWAPA  STATUS_TEMP ,
       0006F 0043     1     MOV  3 ,A
       00070 0715     1     SWAPA  RSR_TEMP ,
       00071 0044     1     MOV  4 ,A
       00072 0714     1     SWAPA  A_TEMP ,
    80 00073 0013          	RETI
    81                     
    82                     ;========================= START =======================================
    83 00074               MCU_RESET:
    84 00074 0011          	DISI
    85 00075 18C8          	MOV                 A,@200          ; delay 20ms
    86                   M 	PAGE                5
       00076 0BC3     1     BS  3 , 7 
       00077 0983     1     BC  3 , 6 
       00078 0B43     1     BS  3 , 5 
    87 00079 12FC          	CALL                DELAY_X100US
    88                   M 	PAGE                0
       0007A 09C3     1     BC  3 , 7 
       0007B 0983     1     BC  3 , 6 
       0007C 0943     1     BC  3 , 5 
    89 0007D 0000          	NOP
    90                   M 	ClrRamBank
       0007E 1810     1     MOV A,@( 16 )
       0007F 0044     1     MOV  R4 ,A
       00080 00C0     1     CLR  R0 ,
       00081 0544     1     INC  R4 ,
       00082 0D84     1     JBC  R4 , 6 
       00083 0B44     1     BS  R4 , 5 
       00084 0DC4     1     JBC  R4 , 7 
       00085 0B44     1     BS  R4 , 5 
       00086 0E83     1     JBS  R3 , Z 
       00087 1480     1     JMP ( $ - 7 ),
       00088 00C4     1     CLR  R4 ,
       00089 1811     1     MOV A,@( 17 )
       0008A 004D     1     MOV  RD ,A
       0008B 00CE     1     CLR  RE ,
       0008C 1801     1     MOV A,@( 1 )
       0008D 004D     1     MOV  RD ,A
       0008E 1800     1     MOV A,@( 0 )
       0008F 004E     1     MOV  RE ,A
       00090 004E     1     MOV  RE ,A
       00091 004E     1     MOV  RE ,A
       00092 004E     1     MOV  RE ,A
       00093 004E     1     MOV  RE ,A
       00094 004E     1     MOV  RE ,A
       00095 004E     1     MOV  RE ,A
       00096 004E     1     MOV  RE ,A
       00097 0B4C     1     BS  RC , 5 
    91                     ;============================ I/O CONFIG ==========================
    92 00098 1830          	MOV                 A,@00110000B    ;set P50 D+/CLOCK, P51 D-/DATA pins input
    93 00099 0007          	IOW                 IOC7
    94 0009A 0000          	NOP
    95 0009B 1804          	MOV                 A,@00000100B
    96 0009C 0009          	IOW                 IOC9
    97 0009D 0000          	NOP
    98 0009E 1800          	MOV                 A,@00000000B
    99 0009F 0008          	IOW                 IOC8
   100 000A0 0000          	NOP
   101 000A1 1820          	MOV                 A,@00100000B    ;SET P55 INPUT
   102 000A2 0005          	IOW                 IOC5
   103 000A3 0000          	NOP
   104 000A4 1861          	MOV                 A,@01100001B	;SPI_MISO/PKT_FLAG/FIFO_FLAG -> input port
   105 000A5 0006          	IOW                 IOC6
   106 000A6 0000          	NOP
   107 000A7 18F3          	MOV                 A,@11110011B	;PULL HIGH PORT92,PORT93
   108 000A8 000D          	IOW                 IOCD
   109 000A9 0000          	NOP
   110 000AA 18D0          	MOV                 A,@11010000B	;Disable WDT,PORT (PULL HIGH)
   111 000AB 000E          	IOW                 IOCE
   112 000AC 0000          	NOP
   113 000AD 1801          	MOV                 A,@00000001B	;USB Mode
   114 000AE 000A          	IOW                 IOCA
   115 000AF 0000          	NOP
   116                     
   117                     ;============================ Intrrupt Config ==========================
   118 000B0 1868          	MOV                 A,@01101000B		; Disable WDT, TCC clock source is Main CLK   1:64
   119 000B1 0002          	CONTW				                    ; TCC 1MS overflow
   120 000B2 00C1          	CLR                 TCC                 ; Clear TCC
   121 000B3 00CF          	CLR                 ISR                 ; interrupt flag
   122 000B4 1803          	MOV                 A,@00000011B
   123 000B5 000F          	IOW                 IMR                 ; enable EP0 interrupt / enable TCC interrupt
   124 000B6 0000          	NOP
   125                     
   126                     ;=============================== Initial Equipment ==========================
   127 000B7 0B06          	BS                  SPI_SS/8,SPI_SS%8           ; Disable EM198810
   128 000B8 0985          	BC                  AT93C46_CS/8,AT93C46_CS%8   ; Disable 93C46
   129                   M 	PAGE                5
       000B9 0BC3     1     BS  3 , 7 
       000BA 0983     1     BC  3 , 6 
       000BB 0B43     1     BS  3 , 5 
   130 000BC 10F9          	CALL                EM198850_RESET          ;initial RF
   131                   M 	PAGE                0
       000BD 09C3     1     BC  3 , 7 
       000BE 0983     1     BC  3 , 6 
       000BF 0943     1     BC  3 , 5 
   132                     ;-------------------------------------------------------------------------
   133 000C0 0B06          	BS                  SPI_SS/8,SPI_SS%8           ; Disable EM198810
   134 000C1 0985          	BC                  AT93C46_CS/8,AT93C46_CS%8   ; Disable 93C46	MOV                 A,@0X00
   135 000C2 1800          	MOV                 A,@0X00
   136 000C3 0055          	MOV                 DataAddressInEEPROM,A
   137 000C4 1820          	MOV                 A,@0X20
   138 000C5 0054          	MOV                 DataAddressInMCU,A
   139                   M 	mREAD               DataAddressInEEPROM,@1,DataAddressInMCU,@16
       000C6 0414     1     MOV A, DATAADDRESSINMCU 
       000C7 0044     1     MOV  R4 ,A
       000C8 0000     1     NOP 
                      2  M  BANK @( 1 ),
       000C9 09C4     2     BC  4 , 7 
       000CA 0B84     2     BS  4 , 6 
       000CB 1810     1     MOV A,@( 16 )
       000CC 0053     1     MOV  R_ACC3 ,A
       000CD          1    ??0051$WRITE_DATA:   
                      2  M  FCALL  START_BIT 
       000CD 1300     2     CALL  START_BIT ,
       000CE 0615     1     RRCA  DATAADDRESSINEEPROM ,
       000CF 1980     1     OR A,@( READ )
       000D0 0051     1     MOV  R_ACC1 ,A
       000D1 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
       000D2 130F     2     CALL  RL_COMD ,
       000D3 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000D4 0E15     1     JBS  DATAADDRESSINEEPROM , 0 
       000D5 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       000D6 0C15     1     JBC  DATAADDRESSINEEPROM , 0 
       000D7 0AC6     1     BS ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       000D8 14D9     1     JMP ( $ + 1 ),
       000D9 0A86     1     BS ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000DA 0555     1     INC  DATAADDRESSINEEPROM ,
       000DB 08C6     1     BC ( SPI_MOSI / 8 ),( SPI_MOSI % 8 )
       000DC 14DD     1     JMP ( $ + 1 ),
       000DD 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000DE 14DF     1     JMP ( $ + 1 ),
       000DF 14E0     1     JMP ( $ + 1 ),
       000E0 0A86     1     BS ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000E1          1    ??0051$READ_DATA1:   
       000E1 1808     1     MOV A,@( 8 )
       000E2 0052     1     MOV  R_ACC2 ,A
       000E3          1    ??0051$READ_DATA2:   
       000E3 0886     1     BC ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000E4 0000     1     NOP 
       000E5 0000     1     NOP 
       000E6 0C06     1     JBC ( SPI_MISO / 8 ),( SPI_MISO % 8 )
       000E7 0A03     1     BS  STATUS , C 
       000E8 0E06     1     JBS ( SPI_MISO / 8 ),( SPI_MISO % 8 )
       000E9 0803     1     BC  STATUS , C 
       000EA 06C0     1     RLC  R0 ,
       000EB 0A86     1     BS ( SPI_CLK / 8 ),( SPI_CLK % 8 )
       000EC 14ED     1     JMP ( $ + 1 ),
       000ED 05D2     1     DJZ  R_ACC2 ,
       000EE 14E3     1     JMP  ??0051$READ_DATA2 ,
       000EF 0544     1     INC  R4 ,
       000F0 0000     1     NOP 
       000F1 0985     1     BC ( AT93C46_CS / 8 ),( AT93C46_CS % 8 )
       000F2 05D3     1     DJZ  R_ACC3 ,
       000F3 14CD     1     JMP  ??0051$WRITE_DATA ,
   140 000F4 0B06          	BS                  SPI_SS/8,SPI_SS%8           ; Disable EM198810
   141 000F5 0985          	BC                  AT93C46_CS/8,AT93C46_CS%8   ; Disable 93C46
   142                     
   143 000F6 11BA          	CALL                PAGE0BANK0                             ; Save ID
   144 000F7 0421          	MOV                 A,RX_IDH_Buffer
   145 000F8 11BD          	CALL                PAGE0BANK1
   146 000F9 0061          	MOV                 RX_IDH,A
   147 000FA 11BA          	CALL                PAGE0BANK0
   148 000FB 0422          	MOV                 A,RX_IDL_Buffer
   149 000FC 11BD          	CALL                PAGE0BANK1
   150 000FD 0062          	MOV                 RX_IDL,A
   151                     
   152 000FE 11BA          	CALL                PAGE0BANK0
   153 000FF 0427          	MOV                 A,TX1_ID_Buffer
   154 00100 11BD          	CALL                PAGE0BANK1
   155 00101 0067          	MOV                 TX1_ID,A
   156 00102 11BA          	CALL                PAGE0BANK0
   157 00103 0428          	MOV                 A,TX2_ID_Buffer
   158 00104 11BD          	CALL                PAGE0BANK1
   159 00105 0068          	MOV                 TX2_ID,A
   160 00106 11BA          	CALL                PAGE0BANK0
   161 00107 0429          	MOV                 A,TX3_ID_Buffer
   162 00108 11BD          	CALL                PAGE0BANK1
   163 00109 0069          	MOV                 TX3_ID,A
   164 0010A 11BA          	CALL                PAGE0BANK0
   165 0010B 042A          	MOV                 A,TX4_ID_Buffer
   166 0010C 11BD          	CALL                PAGE0BANK1
   167 0010D 006A          	MOV                 TX4_ID,A
   168 0010E 11BA          	CALL                PAGE0BANK0
   169 0010F 042B          	MOV                 A,TX5_ID_Buffer
   170 00110 11BD          	CALL                PAGE0BANK1
   171 00111 006B          	MOV                 TX5_ID,A
   172 00112 11BA          	CALL                PAGE0BANK0
   173 00113 042C          	MOV                 A,TX6_ID_Buffer
   174 00114 11BD          	CALL                PAGE0BANK1
   175 00115 006C          	MOV                 TX6_ID,A
   176                     
   177                     ;===========================================================================
   178 00116 11BD          	CALL                PAGE0BANK1
   179 00117 0421          	MOV                 A,RX_IDH
   180 00118 0322          	XOR                 A,RX_IDL
   181 00119 0E83          	JBS                 STATUS,Z
   182 0011A 151F          	JMP                 Run_Start  ;if RX_IDH!=RX_IDL will jump
   183 0011B 0422          	MOV                 A,RX_IDL
   184 0011C 1BFF          	XOR                 A,@0XFF
   185 0011D 0C83          	JBC                 STATUS,Z   ;if RX_IDH==RX==0xff set EEpromWRStatusFlag
   186 0011E 0ADE          	BS                  EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   187 0011F               Run_Start:
   188 0011F 0CDE          	JBC                 EEpromWRStatusFlag/8,EEpromWRStatusFlag%8
   189 00120 1151          	CALL                Rand_ID_Function
   190                   M 	PAGE                5
       00121 0BC3     1     BS  3 , 7 
       00122 0983     1     BC  3 , 6 
       00123 0B43     1     BS  3 , 5 
   191 00124 1276          	CALL                Enter_StandbyII_Mode
   192 00125 12C1          	CALL                CHANGE_ADDRESS_VALUE
   193                   M 	PAGE                0
       00126 09C3     1     BC  3 , 7 
       00127 0983     1     BC  3 , 6 
       00128 0943     1     BC  3 , 5 
   194 00129 11BA          	CALL                PAGE0BANK0
   195 0012A 0000          	NOP
   196                     
   197 0012B 0010          	ENI
   198 0012C 00DB          	CLR                 ComuClock
   199 0012D 00DE          	CLR                 CommuStatusFlag
   200 0012E 00DF          	CLR                 GeneralStatusFlag2
   201 0012F 00E3          	CLR                 CHN_FLAG
   202 00130 00D0          	CLR                 TEMP
   203 00131 11BD          	CALL                PAGE0BANK1
   204                     
   205 00132 0A9F          	BS                  KeyStatusFlag/8,KeyStatusFlag%8
   206 00133 18FF          	MOV                 A,@0XFF
   207 00134 0075          	MOV                 KeystokeFlag_Befor,A
   208 00135 0077          	MOV                 KeystokeTimeCNT,A
   209 00136 08C9          	BC                  LED1_STATUS/8,LED1_STATUS%8
   210 00137 1268          	CALL                SearchLinkMode_Set
   211 00138 0808          	BC                  PORT8,0
   212                     
   213 00139 18D1           	MOV                 A,@(256-47)  ; N=94,P=64,f=6MHz ==> T=1ms
   214 0013A 0041          	MOV                 TCC,A        ; TCC reload by PKT pull high
   215 0013B 00DB          	CLR                 ComuClock
   216                       if DebugDisplay == 1
   217 0013C 1880          	MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   218 0013D 0345          	XOR                 PORT5,A
   219                       endif
   220 0013E 0000           	NOP
   221                     
   222                     ;=====================================================================
   223                     ;======================== MAIN =======================================
   224                     ;=====================================================================
   225 0013F               MAIN:
   226                     
   227                   M 	PAGE                4
       0013F 0BC3     1     BS  3 , 7 
       00140 0983     1     BC  3 , 6 
       00141 0943     1     BC  3 , 5 
   228 00142 12FC          	CALL                USB_MAIN
   229                   M  	PAGE                0
       00143 09C3     1     BC  3 , 7 
       00144 0983     1     BC  3 , 6 
       00145 0943     1     BC  3 , 5 
   230                     
   231                      /*
   232                     	JBS                 USBReportFinishFlag/8,USBReportFinishFlag%8
   233                     	JMP                 MAIN
   234                     	PAGE                4
   235                     	CALL                EP1_Report_Default
   236                     	PAGE                0
   237                     */
   238                     
   239 00146 1200          	CALL                SYNC_COM_TX
   240                   M 	PAGE                1
       00147 09C3     1     BC  3 , 7 
       00148 0983     1     BC  3 , 6 
       00149 0B43     1     BS  3 , 5 
   241 0014A 1000           	CALL                RX1_FUNCTION
   242 0014B 10AF           	CALL                RX2_FUNCTION
   243                   M 	PAGE                0
       0014C 09C3     1     BC  3 , 7 
       0014D 0983     1     BC  3 , 6 
       0014E 0943     1     BC  3 , 5 
   244                     
   245                     
   246                     /*
   247                     	PAGE                5
   248                     	CALL                RSSI_TEST_FUNCTION
   249                     	PAGE                0
   250                     */
   251                     
   252 0014F 0000          	NOP
   253 00150 153F          	JMP                 MAIN
   254                     
   255                     
   256                     ;======================================================================
   257                     ;Function:     COMMAND TX setting
   258                     ;Input:        None
   259                     ;Output:       None
   260                     ;======================================================================
   261                     ;========================================================================
   262                     ; Rand RX_ID and synthesize TX1_ID,TX2_ID...TXx_ID
   263                     ;========================================================================
   264 00151               Rand_ID_Function:
   265 00151 1802          	MOV                 A,@2
   266 00152 0051          	MOV                 TEMP1,A
   267 00153 1861          	MOV                 A,@0X61
   268 00154 0052          	MOV                 TEMP2,A
   269 00155 1195          	CALL                RAND_FUCTION  ; Creat RX_IDH,RX_IDL
   270                     
   271 00156 11BD          	CALL                PAGE0BANK1
   272 00157 0421          	MOV                 A,RX_IDH
   273 00158 1BD6          	XOR                 A,@RX_IDH_DEFAULT
   274 00159 0E83          	JBS                 STATUS,Z
   275 0015A 1560          	JMP                 Creat_TX_ID
   276 0015B 0422          	MOV                 A,RX_IDL
   277 0015C 1BAC          	XOR                 A,@RX_IDL_DEFAULT
   278 0015D 0E83          	JBS                 STATUS,Z
   279 0015E 1560          	JMP                 Creat_TX_ID
   280 0015F 1551          	JMP                 Rand_ID_Function
   281 00160                 Creat_TX_ID:
   282 00160 18F0          	MOV                 A,@0XF0       ; synthesize TX_IDx
   283 00161 02A2          	AND                 A,RX_IDL
   284 00162 0067          	MOV                 TX1_ID,A
   285 00163 0068          	MOV                 TX2_ID,A
   286 00164 0069          	MOV                 TX3_ID,A
   287 00165 006A          	MOV                 TX4_ID,A
   288 00166 006B          	MOV                 TX5_ID,A
   289 00167 006C          	MOV                 TX6_ID,A
   290 00168 1801          	MOV                 A,@0X01
   291 00169 03E7          	ADD                 TX1_ID,A
   292 0016A 1802          	MOV                 A,@0X02
   293 0016B 03E8          	ADD                 TX2_ID,A
   294 0016C 1803          	MOV                 A,@0X03
   295 0016D 03E9          	ADD                 TX3_ID,A
   296 0016E 1804          	MOV                 A,@0X04
   297 0016F 03EA          	ADD                 TX4_ID,A
   298 00170 1805          	MOV                 A,@0X05
   299 00171 03EB          	ADD                 TX5_ID,A
   300 00172 1806          	MOV                 A,@0X06
   301 00173 03EC          	ADD                 TX6_ID,A
   302                     
   303 00174 11BD          	CALL                PAGE0BANK1   ; write ID to buffer
   304 00175 0421          	MOV                 A,RX_IDH
   305 00176 11BA          	CALL                PAGE0BANK0
   306 00177 0061          	MOV                 RX_IDH_Buffer,A
   307 00178 11BD          	CALL                PAGE0BANK1
   308 00179 0422          	MOV                 A,RX_IDL
   309 0017A 11BA          	CALL                PAGE0BANK0
   310 0017B 0062          	MOV                 RX_IDL_Buffer,A
   311                     
   312 0017C 11BD          	CALL                PAGE0BANK1
   313 0017D 0427          	MOV                 A,TX1_ID
   314 0017E 11BA          	CALL                PAGE0BANK0
   315 0017F 0067          	MOV                 TX1_ID_Buffer,A
   316 00180 11BD          	CALL                PAGE0BANK1
   317 00181 0428          	MOV                 A,TX2_ID
   318 00182 11BA          	CALL                PAGE0BANK0
   319 00183 0068          	MOV                 TX2_ID_Buffer,A
   320 00184 11BD          	CALL                PAGE0BANK1
   321 00185 0429          	MOV                 A,TX3_ID
   322 00186 11BA          	CALL                PAGE0BANK0
   323 00187 0069          	MOV                 TX3_ID_Buffer,A
   324 00188 11BD          	CALL                PAGE0BANK1
   325 00189 042A          	MOV                 A,TX4_ID
   326 0018A 11BA          	CALL                PAGE0BANK0
   327 0018B 006A          	MOV                 TX4_ID_Buffer,A
   328 0018C 11BD          	CALL                PAGE0BANK1
   329 0018D 042B          	MOV                 A,TX5_ID
   330 0018E 11BA          	CALL                PAGE0BANK0
   331 0018F 006B          	MOV                 TX5_ID_Buffer,A
   332 00190 11BD          	CALL                PAGE0BANK1
   333 00191 042C          	MOV                 A,TX6_ID
   334 00192 11BA          	CALL                PAGE0BANK0
   335 00193 006C          	MOV                 TX6_ID_Buffer,A
   336 00194 0012          	RET
   337                     
   338                     ;===================================================================
   339                     ; Rand Fuction
   340                     ; Input:       Temp1(Length)
   341                     ;              Temp2(Base address)  ;
   342                     ; output:      rang data from temp2 address base
   343                     ; description: Temp (seed [operand])
   344                     
   345                     ;===================================================================
   346 00195               RAND_FUCTION:
   347 00195 0050          	MOV                 TEMP,A
   348 00196 0412          	MOV                 A,TEMP2
   349 00197 03D0          	ADD                 TEMP,A        ; save latest data as current seed
   350                     
   351 00198 00C4          	CLR                 RSR
   352 00199                 RAND_SEED_LOOP1:
   353 00199 0400          	MOV                 A,R0
   354 0019A 03D0          	ADD                 TEMP,A          ; seed
   355 0019B 11AE          	CALL                ArithmeticIns
   356 0019C 0544          	INC                 RSR
   357 0019D 0404          	MOV                 A,RSR
   358 0019E 1A40          	AND                 A,@0X40         ; adding form 0x00 to bank 0
   359 0019F 1B40          	XOR                 A,@0X40
   360 001A0 0E83          	JBS                 STATUS,Z
   361 001A1 1599          	JMP                 RAND_SEED_LOOP1
   362 001A2 0400          	MOV                 A,R0
   363 001A3 03D0          	ADD                 TEMP,A          ; next seed
   364                       if MassageDisplay == 1
   365                     	MESSAGE             "adding form 0x00 to bank 0"
   366                       endif
   367                     
   368 001A4                 RAND_DATA_LOOP1:
   369 001A4 0412          	MOV                 A,TEMP2
   370 001A5 0044          	MOV                 RSR,A
   371 001A6 0410          	MOV                 A,TEMP
   372 001A7 0040          	MOV                 R0,A
   373 001A8 11AE          	CALL                ArithmeticIns
   374 001A9 0552          	INC                 TEMP2
   375 001AA 05D1          	DJZ                 TEMP1
   376 001AB 15A4          	JMP                 RAND_DATA_LOOP1:
   377 001AC 0000          	NOP
   378 001AD 0012          	RET
   379                     
   380 001AE                 ArithmeticIns:
   381 001AE 06D0          	RLC         TEMP          ; X*Y+1 MOD Z
   382 001AF 06D0          	RLC         TEMP
   383 001B0 06D0          	RLC         TEMP
   384 001B1 0550          	INC         TEMP
   385 001B2 0650          	RRC         TEMP
   386 001B3 0650          	RRC         TEMP
   387 001B4 0650          	RRC         TEMP
   388 001B5 0E03          	JBS         STATUS,C
   389 001B6 0810          	BC          TEMP,0
   390 001B7 0C03          	JBC         STATUS,C
   391 001B8 0A10          	BS          TEMP,0
   392 001B9 0012          	RET
   393                     
   394                     ;=====================================================================
   395                     ; BANK exchange function
   396                     ;=====================================================================
   397 001BA               	PAGE0BANK0:
   398 001BA 09C4          		BC              0X04,7
   399 001BB 0984          		BC              0X04,6
   400 001BC 0012          	RET
   401 001BD               	PAGE0BANK1:
   402 001BD 09C4          		BC              0X04,7
   403 001BE 0B84          		BS              0X04,6
   404 001BF 0012          	RET
   405 001C0               	PAGE0BANK2:
   406 001C0 0BC4          		BS              0X04,7
   407 001C1 0984          		BC              0X04,6
   408 001C2 0012          	RET
   409 001C3               	PAGE0BANK3:
   410 001C3 0BC4          		BS              0X04,7
   411 001C4 0B84          		BS              0X04,6
   412 001C5 0012          	RET
  0 Error(s), 0 Warning(s), 0 User Message(s)