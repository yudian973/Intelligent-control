     1                     ;==================================================================
     2                     ; Filename     :  EM78M611
     3                     ; Author       :  yu.wei
     4                     ; Company      :  ELAN
     5                     ; VERSION      :  1.1
     6                     ; CRYSTAL      :  6MHZ
     7                     ; Creat date   :  2009/11/4
     8                     ; tool ver.    :  eUIDE
     9                     ; Description  :  modify for code conformity
    10                     ;=========================================================================
    11                     M611rxP40.H.ASM    EQU    M611rxP40.H.ASM
    12                     
    13                     include "D:\include\EM78xx\EM78M611.H"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M612 include file                ;
     3            C        ;  Description: The Definition of EM78M612 Registers ;
     4            C        ;  Company:     Elan Electronic Corp.                  ;
     5            C        ;  Author:      YU.WEI                            ;
     6            C        ;  Date:        2009.02.26                             ;
     7            C        ;  Version:     v1.0                                   ;
     8            C        ;===================================================================
     9            C        ;-----------------------------------------------------------------
    10            C        EM78M611.H     EQU     EM78M611.H
    11            C        
    12            C        ;-----------------------------------------------------------------
    13            C        ; Indirect Addressing register
    14       0000 C        	R0      ==      0X00
    15            C        
    16            C        ; Time Clock/Counter
    17       0001 C        	R1      ==      0X01
    18       0001 C        	TCC     ==      0X01
    19            C        
    20            C        ; Program Counter
    21       0002 C        	R2      ==      0X02
    22       0002 C        	PC      ==      0X02
    23            C        
    24            C        ; Status Register
    25       0003 C        	R3      ==      0X03
    26       0003 C        	STATUS  ==      0X03
    27            C        	;{
    28       0000 C        		C       == 0X00; CARRYFLAG
    29       0001 C        		DC      == 0X01; AUXILIARY CARRY FLAG
    30       0002 C        		Z       == 0X02; ZERO FLAG
    31       0003 C        		P       == 0X03; POWER DOWN BIT
    32       0004 C        		T       == 0X04; TIME-OUT BIT
    33       0005 C        		PS0     == 0X05; PAGE select BIT 1
    34       0006 C        		PS1     == 0X06; PAGE select BIT 2
    35       0007 C        		PS2     == 0X07; PAGE select BIT 3
    36            C        		;{
    37            C        			PAGE0	MACRO			;000
    38            C        				BC	STATUS,PS2
    39            C        				BC	STATUS,PS1
    40            C        				BC	STATUS,PS0
    41            C        				ENDM
    42            C        			PAGE1	MACRO			;001
    43            C        				BC	STATUS,PS2
    44            C        				BC	STATUS,PS1
    45            C        				BS	STATUS,PS0
    46            C        				ENDM
    47            C        			PAGE2	MACRO			;010
    48            C        				BC	STATUS,PS2
    49            C        				BS	STATUS,PS1
    50            C        				BC	STATUS,PS0
    51            C        				ENDM
    52            C        			PAGE3	MACRO			;011
    53            C        				BC	STATUS,PS2
    54            C        				BS	STATUS,PS1
    55            C        				BS	STATUS,PS0
    56            C        				ENDM
    57            C        			PAGE4	MACRO			;100
    58            C        				BS	STATUS,PS2
    59            C        				BC	STATUS,PS1
    60            C        				BC	STATUS,PS0
    61            C        				ENDM
    62            C        			PAGE5	MACRO			;101
    63            C        				BS	STATUS,PS2
    64            C        				BC	STATUS,PS1
    65            C        				BS	STATUS,PS0
    66            C        				ENDM
    67            C        
    68            C        		;}
    69            C                  ;}
    70            C        
    71            C        
    72            C        ; RAM Select Register (RSR)
    73       0004 C        	R4             ==     0X04;
    74       0004 C        	RSR            ==     0X04
    75            C        	;{
    76       0006 C        		BK0     == 0X06; BANK selector BIT 0
    77       0007 C        		BK1     == 0X07; BANK selector BIT 1
    78            C        
    79            C        		BANK0	MACRO		;00
    80            C        			BC	RSR,BK0
    81            C        			BC	RSR,BK1
    82            C        			ENDM
    83            C        		BANK1	MACRO		;01
    84            C        			BS	RSR,BK0
    85            C        			BC	RSR,BK1
    86            C        			ENDM
    87            C        		BANK2	MACRO		;10
    88            C        			BC	RSR,BK0
    89            C        			BS	RSR,BK1
    90            C        			ENDM
    91            C        		BANK3	MACRO		;11
    92            C        			BS	RSR,BK0
    93            C        			BS	RSR,BK1
    94            C        			ENDM
    95            C        	;}
    96            C        
    97            C        ;====================================================================
    98       0005 C        	R5      == 0X05
    99       0005 C        	PORT5   == 0X05
   100            C        	;{
   101       0007 C        		P57	== 0X07
   102       0006 C        		P56	== 0X06
   103       0005 C        		P55	== 0X05
   104       0004 C        		P54	== 0X04
   105       0003 C        		P53	== 0X03
   106       0002 C        		P52	== 0X02
   107       0001 C        		P51	== 0X01
   108       0000 C        		P50	== 0X00
   109            C        	;}
   110            C        
   111            C        ;====================================================================
   112       0006 C        	R6      == 0X06
   113       0006 C        	PORT6   == 0X06
   114            C        	;{
   115       0007 C        		P67	== 0X07
   116       0006 C        		P66	== 0X06
   117       0005 C        		P65	== 0X05
   118       0004 C        		P64	== 0X04
   119       0003 C        		P63	== 0X03
   120       0002 C        		P62	== 0X02
   121       0001 C        		P61	== 0X01
   122       0000 C        		P60	== 0X00
   123            C        	;}
   124            C        
   125            C        ;====================================================================
   126       0007 C        	R7      == 0X07
   127       0007 C        	PORT7   == 0X07
   128            C        	;{
   129       0007 C        		P77	== 0X07
   130       0006 C        		P76	== 0X06
   131       0005 C        		P75	== 0X05
   132       0004 C        		P74	== 0X04
   133       0003 C        		P73	== 0X03
   134       0002 C        		P72	== 0X02
   135       0001 C        		P71	== 0X01
   136       0000 C        		P70	== 0X00
   137            C        	;}
   138            C        
   139            C        ;====================================================================
   140       0008 C        	R8      == 0X08; /PORT6 WAKE-UP PIN SELECT REGISTER
   141       0008 C        	PORT8   == 0X08
   142            C        	;{
   143       0007 C        		P87	== 0X07
   144       0006 C        		P86	== 0X06
   145       0005 C        		P85	== 0X05
   146       0004 C        		P84	== 0X04
   147       0003 C        		P83	== 0X03
   148       0002 C        		P82	== 0X02
   149       0001 C        		P81	== 0X01
   150       0000 C        		P80	== 0X00
   151            C        	;}
   152            C        
   153            C        ;====================================================================
   154       0009 C        	R9      == 0X09; /PORT7 WAKE-UP PIN SELECT REGISTER
   155       0009 C        	PORT9   == 0X09;
   156            C        	;{
   157       0007 C        		P97	== 0X07
   158       0006 C        		P96	== 0X06
   159       0005 C        		P95	== 0X05
   160       0004 C        		P94	== 0X04
   161       0003 C        		P93	== 0X03
   162       0002 C        		P92	== 0X02
   163       0001 C        		P91	== 0X01
   164       0000 C        		P90	== 0X00
   165            C        	;}
   166            C        
   167            C        ;====================================================================
   168       000A C        	RA      == 0X0A; HIGH PATTERN COUNTER
   169       000A C        	EECR    == 0X0A
   170            C        	;{
   171       0002 C        		EE_OK	== 0X02
   172       0001 C        		EE_C1	== 0X01
   173       0000 C        		EE_C0	== 0X00
   174            C        	;}
   175            C        
   176            C        ;====================================================================
   177       000B C        	RB      == 0X0B; LOW PATTERN COUNTER
   178       000B C        	PDACR       == 0X0B
   179            C        	;{
   180       0007 C        		SE2F    == 0X07
   181       0006 C        		SE1F    == 0X06
   182       0005 C        		SR2	== 0X05
   183       0004 C        		SR1	== 0X04
   184       0003 C        		SR0	== 0X03
   185       0002 C        		DB2	== 0X02
   186       0001 C        		DB1	== 0X01
   187       0000 C        		DB0	== 0X00
   188            C        	;}
   189            C        
   190            C        ;====================================================================
   191       000C C        	RC      == 0X0C; USB APPLICATION STATUS REGISTER
   192       000C C        	USBASR  == 0X0C
   193            C        	;{
   194       0007 C        		EP0_W           == 0X07
   195       0006 C        		EP0_R           == 0X06
   196       0005 C        		EP1_R           == 0X05
   197       0004 C        		EP2_R           == 0X04
   198       0003 C        		EP2_W           == 0X03
   199       0002 C        		HOST_SUSPEND    == 0X02
   200       0001 C        		EP0_BUSY        == 0X01
   201       0000 C        		STALL           == 0X00
   202            C        	;}
   203            C        
   204            C        ;====================================================================
   205       000D C        	RD       == 0X0D; USB APPLICATION FIFO ADDRESS REGISTER
   206       000D C        	FIFOAR   == 0X0D
   207            C        	;{
   208            C        		;---------------------------
   209            C        		;   00	Endpoint 0
   210            C        			;---------
   211            C        			;    0
   212            C        			;---------
   213            C        			;    1
   214            C        			;---------
   215            C        			;    2
   216            C        			;---------
   217            C        			;    3
   218            C        			;---------
   219            C        			;    4
   220            C        			;---------
   221            C        			;    5
   222            C        			;---------
   223            C        			;    6
   224            C        			;---------
   225            C        			;    7
   226            C        		;---------------------------
   227            C        		;    01    ;
   228            C        		;    :     ;
   229            C        		;    :	   ; Endpoint address
   230            C        		;    :     ;
   231            C        		;    0F    ;
   232            C        		;---------------------------
   233            C        		;    10	   ; EP0_STATUS
   234            C        		;---------------------------
   235            C        		;    11    ;
   236            C        		;    :     ;
   237            C        		;    :     ; EP_STATUS
   238            C        		;    :     ;
   239            C        		;    1F    ;
   240            C        		;---------------------------
   241            C        
   242            C        	;}
   243            C        
   244            C        ;====================================================================
   245       000E C        	RE          == 0X0E; USB APPLICATION FIFO DATA REGISTER A[0..3]POINTER [4..7]COUNTER
   246       000E C        	FIFODR      == 0X0E
   247            C        	;{
   248            C        
   249            C        	;}
   250            C        
   251            C        ;====================================================================
   252       000F C        	RF      == 0X0F; INTERRUPT STATUS REGISTER
   253       000F C        	ISR     == 0X0F; INTERRUPT STATUS REGISTER
   254            C        	;{
   255       0000 C        		TCCIF       == 0X00
   256       0001 C        		EP0IF       == 0X01
   257       0002 C        		USBSIF      == 0X02
   258       0003 C        		USBRIF      == 0X03
   259       0004 C        		P7SCIF      == 0X04
   260       0005 C        		SE1IF       == 0X05
   261       0006 C        		SE2IF       == 0X06
   262       0007 C        		USBHRIF     == 0X07
   263            C        	;}
   264            C        
   265            C        ;====================================================================
   266            C        
   267            C        
   268       0005 C        	IOC5		== 0X05;	port 5 direction control register
   269       0006 C        	IOC6		== 0X06;	port 6 direction control register
   270       0007 C        	IOC7		== 0X07;	port 7 direction control register
   271       0008 C        	IOC8		== 0X08; 	port 8 direction control register
   272       0009 C        	IOC9		== 0X09; 	port 9 direction control register
   273       000A C        	IOCA		== 0X0A; 	OPERATION MODE
   274            C        	;{
   275       0000 C        		USBM        == 0X00
   276       0001 C        		PS2M        == 0X01
   277       0002 C        		PDAM        == 0X02
   278       0003 C        		EXRegSel    == 0X03
   279            C        	;}
   280            C        ;====================================================================
   281       000B C        	IOCB		== 0X0B; PORT6 PULL-LOW
   282            C        
   283            C        ;====================================================================
   284       000C C        	IOCC		== 0X0C; PORT6 PULL-HIGH
   285            C        
   286            C        ;====================================================================
   287       000D C        	IOCD		== 0X0D; PORT7 PULL-HIGH
   288            C        
   289            C        ;====================================================================
   290       000E C        	IOCE		== 0X0E; SPECIAL FUNCTION
   291       000E C        	SFCR		== 0X0E;
   292            C        	;{
   293       0004 C        		RUN         == 0X04
   294       0005 C        		WTE         == 0X05
   295       0002 C        		_PULL8      == 0X02
   296       0001 C        		_PULL6      == 0X01
   297       0000 C        		_PULL5      == 0X00
   298            C        	;}
   299            C        
   300            C        ;====================================================================
   301       000F C        	IOCF    == 0X0F; INTERRUPT MASK
   302       000F C        	IMR     == 0X0F
   303            C        	;{
   304       0000 C        		TCIE        == 0X00
   305       0001 C        		EPOIE       == 0X01
   306       0002 C        		USBSIE      == 0X02
   307       0003 C        		USBRIE      == 0X03
   308       0004 C        		P5SCIE      == 0X04
   309       0005 C        		SE1IE       == 0X05
   310       0006 C        		SE2IE       == 0X06
   311       0004 C        		USBHRIE     == 0X04
   312            C        	;}
   313            C        
   314            C        
   315            C        
   316            C        
   317            C        ;======================================================;
   318            C        ; Register R10~R3F                                     ;
   319            C        ;======================================================;
   320            C        ;
   321            C        ; (R10 ~ R3F): General Purpose Register
   322            C        ;
   323       0010 C         R10    ==    0x10
   324       0011 C         R11    ==    0x11
   325       0012 C         R12    ==    0x12
   326       0013 C         R13    ==    0x13
   327       0014 C         R14    ==    0x14
   328       0015 C         R15    ==    0x15
   329       0016 C         R16    ==    0x16
   330       0017 C         R17    ==    0x17
   331       0018 C         R18    ==    0x18
   332       0019 C         R19    ==    0x19
   333       001A C         R1A    ==    0x1A
   334       001B C         R1B    ==    0x1B
   335       001C C         R1C    ==    0x1C
   336       001D C         R1D    ==    0x1D
   337       001E C         R1E    ==    0x1E
   338       001F C         R1F    ==    0x1F
   339            C        ;
   340       0020 C         R20    ==    0x20
   341       0021 C         R21    ==    0x21
   342       0022 C         R22    ==    0x22
   343       0023 C         R23    ==    0x23
   344       0024 C         R24    ==    0x24
   345       0025 C         R25    ==    0x25
   346       0026 C         R26    ==    0x26
   347       0027 C         R27    ==    0x27
   348       0028 C         R28    ==    0x28
   349       0029 C         R29    ==    0x29
   350       002A C         R2A    ==    0x2A
   351       002B C         R2B    ==    0x2B
   352       002C C         R2C    ==    0x2C
   353       002D C         R2D    ==    0x2D
   354       002E C         R2E    ==    0x2E
   355       002F C         R2F    ==    0x2F
   356            C        ;
   357       0030 C         R30    ==    0x30
   358       0031 C         R31    ==    0x31
   359       0032 C         R32    ==    0x32
   360       0033 C         R33    ==    0x33
   361       0034 C         R34    ==    0x34
   362       0035 C         R35    ==    0x35
   363       0036 C         R36    ==    0x36
   364       0037 C         R37    ==    0x37
   365       0038 C         R38    ==    0x38
   366       0039 C         R39    ==    0x39
   367       003A C         R3A    ==    0x3A
   368       003B C         R3B    ==    0x3B
   369       003C C         R3C    ==    0x3C
   370       003D C         R3D    ==    0x3D
   371       003E C         R3E    ==    0x3E
   372       003F C         R3F    ==    0x3F
    14                     include "D:\include\EM78xx\EM78CtrlIns.H"
     1            C        /*****************************************************************
     2            C        * Filename     :  EM78CTRLINS.H
     3            C        * Author       :  yu.wei
     4            C        * Company      :  ELAN
     5            C        * VERSION      :  1.0
     6            C        * Creat date   :  2009/2
     7            C        * tool ver.    :  WicePlus II/eUIDE
     8            C        * Description  :  instruction aggregate
     9            C        *****************************************************************/
    10            C        ;------------------------------------------------------
    11            C        EM78CtrlIns.H    EQU         EM78CtrlIns.H
    12            C        
    13            C        ;-------------------------------------------------------
    14            C        
    15            C        ;***********************************************************
    16            C        ;位操作类宏
    17            C        ;***********************************************************
    18            C        ; reg.bit exchange
    19            C        ;========================================
    20            C        COM MACRO REG,BIT
    21            C        	IF        BIT == 0
    22            C        		MOV        A,@0B00000001
    23            C        		XOR        REG,A
    24            C        	ELSEIF    BIT == 1
    25            C        		MOV        A,@0B00000010
    26            C        		XOR        REG,A
    27            C        	ELSEIF    BIT == 2
    28            C        		MOV        A,@0B00000100
    29            C        		XOR        REG,A
    30            C        	ELSEIF    BIT == 3
    31            C        		MOV        A,@0B00001000
    32            C        		XOR        REG,A
    33            C        	ELSEIF    BIT == 4
    34            C        		MOV        A,@0B00010000
    35            C        		XOR        REG,A
    36            C        	ELSEIF    BIT == 5
    37            C        		MOV        A,@0B00100000
    38            C        		XOR        REG,A
    39            C        	ELSEIF    BIT == 6
    40            C        		MOV        A,@0B01000000
    41            C        		XOR        REG,A
    42            C        	ELSEIF    BIT == 7
    43            C        		MOV        A,@0B10000000
    44            C        		XOR        REG,A
    45            C        	ELSE
    46            C        		MESSAGE    "BIT select ERROR"
    47            C        	ENDIF
    48            C        ENDM
    49            C        
    50            C        ;===============================================
    51            C        ; TO reg.bit1 = reg2.bit2
    52            C        ;================================================
    53            C        MOVB MACRO REG1,BIT1,REG2,BIT2
    54            C        	JBS       REG2,BIT2
    55            C        	BC        REG1,BIT1
    56            C        	JBC       REG2,BIT2
    57            C        	BS        REG1,BIT1
    58            C        ENDM
    59            C        
    60            C        ;===============================================
    61            C        ; TO reg1.bit1 = /reg2.bit2
    62            C        ;===============================================
    63            C        MOVBCPL MACRO REG1,BIT1,REG2,BIT2
    64            C        	JBS       REG2,BIT2
    65            C        	BS        REG1,BIT1
    66            C        	JBC       REG2,BIT2
    67            C        	BC        REG1,BIT1
    68            C        ENDM
    69            C        
    70            C        ;===============================================
    71            C        ; TO REG1=@DATA
    72            C        ;===============================================
    73            C        MOV MACRO REG,@DATA
    74            C        	MOV       A,@DATA
    75            C        	MOV       REG,A
    76            C        ENDM
    77            C        
    78            C        ;===============================================
    79            C        ; TO REG1=REG2
    80            C        ;===============================================
    81            C        MOV MACRO REG1,REG2
    82            C        	MOV       A,REG2
    83            C        	MOV       REG1,A
    84            C        ENDM
    85            C        
    86            C        
    87            C        
    88            C        ;***********************************************************
    89            C        ;条件分支结构类宏
    90            C        ;***********************************************************
    91            C        ;===============================================
    92            C        ;decrement reg and jump when not zero
    93            C        ;================================================
    94            C        DJNZ MACRO REG,ADDRESS
    95            C        	DJZ       REG
    96            C        	JMP       ADDRESS
    97            C        ENDM
    98            C        
    99            C        ;=====================================================
   100            C        ; INC reg and jump when not zero
   101            C        ;=====================================================
   102            C        IJNZ MACRO REG,ADDRESS
   103            C        	JZ        REG
   104            C        	JMP       ADDRESS
   105            C        ENDM
   106            C        
   107            C        ;=====================================================
   108            C        ; compare and jump
   109            C        ; if reg1 > reg2 jump to add1
   110            C        ; if reg1 < reg2 jump to add2
   111            C        ;=====================================================
   112            C        CJLJG MACRO REG1,REG2,ADD1,ADD2
   113            C        	MOV       A,REG2
   114            C        	SUB       A,REG1
   115            C        	JBS       0X03,0 ;R3==0X03
   116            C        	JMP       ADD1
   117            C        	JBS       0X03,2
   118            C        	JMP       ADD2
   119            C        ENDM
   120            C        
   121            C        ;=====================================================
   122            C        ; compare and jump if in range
   123            C        ; if @LITE1 <= REG <= @LITE2 jump to ADDR
   124            C        ;=====================================================
   125            C        CJIN MACRO REG,@LITE1,@LITE2,ADDR
   126            C        	MOV       A,REG
   127            C        	ADD       A,@255-LITE2
   128            C        	ADD       A,@LITE2-LITE1+1
   129            C        	JBC       0X03,0
   130            C        	JMP       ADDR
   131            C        ENDM
   132            C        
   133            C        ;=====================================================
   134            C        ; COMPARE AND JUMP IF OUT RANGE
   135            C        ; if REG > @LITE2 or REG < @LITE1 jump to ADDR
   136            C        ;=====================================================
   137            C        CJOUT MACRO REG,@LITE1,@LITE2,ADDR
   138            C        	MOV       A,REG
   139            C        	ADD       A,@255-LITE2
   140            C        	ADD       A,@LITE2-LITE1+1
   141            C        	JBS       0X03,0
   142            C        	JMP       ADDR
   143            C        ENDM
   144            C        
   145            C        ;=====================================================
   146            C        ; compare and jump if REG1 > REG2
   147            C        ;=====================================================
   148            C        CJG       MACRO REG1,REG2,ADDRESS
   149            C        	MOV       A,REG1
   150            C        	SUB       A,REG2
   151            C        	JBS       0X03,0
   152            C        	JMP       ADDRESS
   153            C        ENDM
   154            C        
   155            C        ;=====================================================
   156            C        ; compare and jump if REG1 >= REG2
   157            C        ;=====================================================
   158            C        CJGE MACRO REG1,REG2,ADDRESS
   159            C        	MOV       A,REG2
   160            C        	SUB       A,REG1
   161            C        	JBC       0X03,0
   162            C        	JMP       ADDRESS
   163            C        ENDM
   164            C        
   165            C        ;=====================================================
   166            C        ; compare and jump if REG1 < REG2
   167            C        ;=====================================================
   168            C        CJL MACRO REG1,REG2,ADDRESS
   169            C        	MOV       A,REG2
   170            C        	SUB       A,REG1
   171            C        	JBS       0X03,0
   172            C        	JMP       ADDRESS
   173            C        ENDM
   174            C        
   175            C        ;=====================================================
   176            C        ; compare and jump if REG1 <= REG2
   177            C        ;=====================================================
   178            C        CJLE MACRO REG1,REG2,ADDRESS
   179            C        	MOV       A,REG1
   180            C        	SUB       A,REG2
   181            C        	JBC       0X03,0
   182            C        	JMP       ADDRESS
   183            C        ENDM
   184            C        
   185            C        ;=====================================================
   186            C        ; compare and jump if REG1 = REG2
   187            C        ;=====================================================
   188            C        CJE MACRO REG1,REG2,ADDRESS
   189            C        	MOV       A,REG2
   190            C        	SUB       A,REG1
   191            C        	JBC       0X03,2
   192            C        	JMP       ADDRESS
   193            C        ENDM
   194            C        
   195            C        ;=====================================================
   196            C        ; compare and jump if REG1 = @DATA jmp to ADDRESS
   197            C        ;=====================================================
   198            C        CJE MACRO REG,@DATA,ADDRESS
   199            C        	MOV       A,REG
   200            C        	SUB       A,@DATA
   201            C        	JBC       0X03,2
   202            C        	JMP       ADDRESS
   203            C        ENDM
   204            C        
   205            C        ;=====================================================
   206            C        ; compare and jump if REG1=REG2=@DATA jmp to ADDRESS
   207            C        ;=====================================================
   208            C        CJE MACRO REG1,REG2,@DATA,ADDRESS
   209            C        	MOV       A,REG2
   210            C        	SUB       A,REG1
   211            C        	JBS       0X03,2
   212            C        	JMP       $_CJE_DONE
   213            C        	MOV       A,REG1
   214            C        	SUB       A,@DATA
   215            C        	JBC       0X03,2
   216            C        	JMP       ADDRESS
   217            C        $_CJE_DONE:
   218            C        ENDM
   219            C        
   220            C        ;=====================================================
   221            C        ; compare and jump if REG1 <> REG2
   222            C        ;=====================================================
   223            C        CJNE MACRO REG1,REG2,ADDRESS
   224            C        	MOV       A,REG2
   225            C        	SUB       A,REG1
   226            C        	JBS       0X03,2
   227            C        	JMP       ADDRESS
   228            C        ENDM
   229            C        
   230            C        ;=====================================================
   231            C        ;compare and jump if REG = 0 JMP ADDRESS
   232            C        ;=====================================================
   233            C        CJZ MACRO REG,ADDRESS
   234            C        	MOV       REG,REG
   235            C        	JBC       0X03,2
   236            C        	JMP       ADDRESS
   237            C        ENDM
   238            C        
   239            C        ;=====================================================
   240            C        ; compare and jump if REG <> 0
   241            C        ;=====================================================
   242            C        CJNZ MACRO REG,ADDRESS
   243            C        	MOV       REG,REG
   244            C        	JBS       0X03,2
   245            C        	JMP       ADDRESS
   246            C        ENDM
   247            C        
   248            C        ;=====================================================
   249            C        ; compare and jump if REG.BIT = 0
   250            C        ;=====================================================
   251            C        CJBC MACRO REG,BIT,ADDRESS
   252            C        	JBS       REG,BIT
   253            C        	JMP       ADDRESS
   254            C        ENDM
   255            C        
   256            C        ;=====================================================
   257            C        ; compare and jump if REG.BIT = 1
   258            C        ;=====================================================
   259            C        CJBS MACRO REG,BIT,ADDRESS
   260            C        	JBC       REG,BIT
   261            C        	JMP       ADDRESS
   262            C        ENDM
   263            C        
   264            C        ;=====================================================
   265            C        ; compare and jump if REG.BIT = 0 JMP ADDRESS1
   266            C        ;                  if REG.BIT = 1 JMP ADDRESS2
   267            C        ;=====================================================
   268            C        CJBCS MACRO REG,BIT,ADDRESS1,ADDRESS2
   269            C        	JBC       REG,BIT
   270            C        	JMP       ADDRESS1
   271            C        	JBS       REG,BIT
   272            C        	JMP       ADDRESS2
   273            C        ENDM
   274            C        
   275            C        
   276            C        
   277            C        
   278            C        
   279            C        ;***********************************************************
   280            C        ;中断压栈与出栈类宏
   281            C        ;***********************************************************
   282            C        ;===============================================
   283            C        ; 压栈程序
   284            C        ; 说明:中断入口调用此程序,将ACC,R3压栈
   285            C        ; A      -> A_TEMP
   286            C        ; RSR    -> RSR_TEMP
   287            C        ; STATUS -> STATUS_TEMP
   288            C        ;================================================
   289            C        PUSH MACRO
   290            C        	MOV                 A_TEMP,A       ;A_TEMP,A         ;SAVE A
   291            C        	SWAP                A_TEMP         ;A_TEMP
   292            C        	SWAPA               0X03           ;STATUS           ;SAVE STATUS(R3)
   293            C        	MOV                 STATUS_TEMP,A  ;STATUS_TEMP,A
   294            C        IFDEF EM78P510.H
   295            C        	SWAPA               0X05           ;RSR              ;SAVE RSR(R4)
   296            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   297            C        ELSE
   298            C        	SWAPA               0X04           ;RSR              ;SAVE RSR(R4)
   299            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   300            C        ENDIF
   301            C        	CLR                 0X03           ;STATUS           ;SELECT PAGE0
   302            C        ENDM
   303            C        
   304            C        ;---------------------------------------
   305            C        POP MACRO
   306            C        	SWAPA               STATUS_TEMP    ;STATUS_TEMP    ;R3
   307            C        	MOV                 0X03,A         ;STATUS,A
   308            C        IFDEF EM78P510.H
   309            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   310            C        	MOV                 0X05,A         ;RSR,A
   311            C        ELSE
   312            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   313            C        	MOV                 0X04,A         ;RSR,A
   314            C        ENDIF
   315            C        	SWAPA               A_TEMP         ;A_TEMP
   316            C        ENDM
   317            C        
   318            C        ;=================== EM78P520 ======================
   319            C        PUSH MACRO A_Temp,STATUS_Temp,RSR_Temp,@BankSel,Ax_Temp,STATUSx_Temp,RSRx_Temp
   320            C        	MOV                 A_TEMP,A       ;A_TEMP,A         ;SAVE A
   321            C        	SWAP                A_TEMP         ;A_TEMP
   322            C        	SWAPA               0X03           ;STATUS           ;SAVE STATUS(R3)
   323            C        	MOV                 STATUS_TEMP,A  ;STATUS_TEMP,A
   324            C        	SWAPA               0X05           ;RSR              ;SAVE RSR(R4)
   325            C        	MOV                 RSR_TEMP,A     ;RSR_TEMP,A
   326            C        	CLR                 0X03           ;STATUS           ;SELECT PAGE0
   327            C        
   328            C        	BANK                @BankSel
   329            C        	MOV                 A,A_TEMP
   330            C        	MOV                 Ax_Temp,A
   331            C        	MOV                 A,STATUS_Temp
   332            C        	MOV                 STATUSx_Temp,A
   333            C        	MOV                 A,RSR_Temp
   334            C        	MOV                 RSRx_Temp,A
   335            C        ENDM
   336            C        
   337            C        ;---------------------------------------
   338            C        POP MACRO A_Temp,STATUS_Temp,RSR_Temp,@BankSel,Ax_Temp,STATUSx_Temp,RSRx_TEMP
   339            C        	BANK                @BankSel
   340            C        	MOV                 A,Ax_Temp
   341            C        	MOV                 A_TEMP,A
   342            C        	MOV                 A,STATUSx_Temp
   343            C        	MOV                 STATUS_Temp,A
   344            C        	MOV                 A,RSR_TEMP
   345            C        	MOV                 RSRx_TEMP,A
   346            C        
   347            C        	SWAPA               STATUS_TEMP    ;STATUS_TEMP    ;R3
   348            C        	MOV                 0X03,A         ;STATUS,A
   349            C        	SWAPA               RSR_TEMP       ;RSR_TEMP       ;R4
   350            C        	MOV                 0X05,A         ;RSR,A
   351            C        	SWAPA               A_TEMP         ;A_TEMP
   352            C        ENDM
   353            C        
   354            C        ;***********************************************************
   355            C        ; 跨页调用与跳转类宏
   356            C        ;***********************************************************
   357            C        ;===================================================
   358            C        ; 选择程序页面
   359            C        ;===================================================
   360            C        PAGE MACRO NUM
   361            C        IFDEF     EM78P510.H
   362            C        	ERROR
   363            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   364            C        	MESSAGE "can not use the instrction PAGE"
   365            C        ELSE
   366            C        	IF        NUM == 0
   367            C                      BC        0X03,7
   368            C                      BC        0X03,6
   369            C                      BC        0X03,5
   370            C        	ELSEIF    NUM == 1
   371            C        	          BC        0X03,7
   372            C        	          BC        0X03,6
   373            C        	          BS        0X03,5
   374            C        	ELSEIF    NUM == 2
   375            C        	          BC        0X03,7
   376            C        	          BS        0X03,6
   377            C        	          BC        0X03,5
   378            C        	ELSEIF    NUM == 3
   379            C        	          BC        0X03,7
   380            C        	          BS        0X03,6
   381            C        	          BS        0X03,5
   382            C        	ELSEIF    NUM == 4
   383            C        	          BS        0X03,7
   384            C        	          BC        0X03,6
   385            C        	          BC        0X03,5
   386            C        	ELSEIF    NUM == 5
   387            C        	          BS        0X03,7
   388            C        	          BC        0X03,6
   389            C        	          BS        0X03,5
   390            C        	ELSEIF    NUM == 6
   391            C        	          BS        0X03,7
   392            C        	          BS        0X03,6
   393            C        	          BC        0X03,5
   394            C        	ELSEIF    NUM == 7
   395            C        	          BS        0X03,7
   396            C        	          BS        0X03,6
   397            C        	          BS        0X03,5
   398            C        	ELSE
   399            C        	          MESSAGE "WARRING: don't have specify page"
   400            C        	ENDIF
   401            C        ENDIF
   402            C        
   403            C        ENDM
   404            C        
   405            C        ;===================================================%
   406            C        ; 智能跨页调用
   407            C        ;===================================================
   408            C        FCALL MACRO ADDRESS
   409            C        IFDEF     EM78P510.H
   410            C        	ERROR
   411            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   412            C        	MESSAGE "can not use the instrction FCALL"
   413            C        ELSE
   414            C        	IF        ADDRESS/0X400 == $/0X400
   415            C        	          CALL      ADDRESS
   416            C        	ELSE
   417            C        	          PAGE      ADDRESS/0X400
   418            C        	          CALL      ADDRESS%0X400
   419            C        	          PAGE      $/0X400
   420            C        	ENDIF
   421            C        ENDIF
   422            C        ENDM
   423            C        
   424            C        ;===================================================
   425            C        ; 跨页调用
   426            C        ; 入口:NUM = 被调用程序页号,  ADDRESS =  B被调用程序地址
   427            C        ;===================================================
   428            C        FCALL MACRO NUM,ADDRESS
   429            C        IFDEF     EM78P510.H
   430            C        	ERROR
   431            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   432            C        	MESSAGE "can not use the instrction FCALL"
   433            C        ELSE
   434            C        	PAGE      NUM
   435            C        	CALL      ADDRESS
   436            C        	PAGE      $/0X400
   437            C        ENDIF
   438            C        ENDM
   439            C        
   440            C        ;===================================================
   441            C        ; 智能跨页跳转
   442            C        ;===================================================
   443            C        FJMP MACRO ADDRESS
   444            C        IFDEF     EM78P510.H
   445            C        	ERROR
   446            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   447            C        	MESSAGE "can not use the instrction FJMP"
   448            C        ELSE
   449            C        	IF        ADDRESS/0X400 == $/0X400
   450            C        	          JMP       ADDRESS
   451            C        	ELSE
   452            C        	          PAGE      ADDRESS/0X400
   453            C        	          JMP       ADDRESS%0X400
   454            C        	ENDIF
   455            C        ENDIF
   456            C        ENDM
   457            C        
   458            C        ;===================================================
   459            C        ;跨页跳转
   460            C        ; 入口:NUM = 被调用程序页号,  ADDRESS =  B被调用程序地址
   461            C        ;===================================================
   462            C        FJMP MACRO NUM,ADDRESS
   463            C        IFDEF     EM78P510.H
   464            C        	ERROR
   465            C        	MESSAGE "ERROR:THe EM78510 Not Support PAGE insruction but used LCALL or LJMP"
   466            C        	MESSAGE "can not use the instrction FJMP"
   467            C        ELSE
   468            C        	PAGE      NUM
   469            C        	JMP       ADDRESS
   470            C        ENDIF
   471            C        ENDM
   472            C        
   473            C        ;===================================================
   474            C        ; 选择程序页面
   475            C        ;===================================================
   476            C        BANK MACRO @NUM
   477            C        IFDEF EM78M611.H
   478            C        	IF        @NUM == 0
   479            C                      BC        0X04,7
   480            C                      BC        0X04,6
   481            C        	ELSEIF    @NUM == 1
   482            C        	          BC        0X04,7
   483            C        	          BS        0X04,6
   484            C        	ELSEIF    @NUM == 2
   485            C        	          BS        0X04,7
   486            C        	          BC        0X04,6
   487            C        	ELSEIF    @NUM == 3
   488            C        	          BS        0X04,7
   489            C        	          BS        0X04,6
   490            C        	ENDIF
   491            C        
   492            C        ELSEIFDEF EM78M612.H
   493            C        	IF        @NUM == 0
   494            C                      BC        0X04,6
   495            C        	ELSEIF    @NUM == 1
   496            C        	          BS        0X04,6
   497            C        	ENDIF
   498            C        ELSE
   499            C        	MESSAGE "the MCU defualt have 'bank' intruction"
   500            C        ENDIF
   501            C        ENDM
   502            C        
   503            C        
   504            C        
   505            C        ;*******************************************
   506            C        ; RAM clear function
   507            C        ; [ELSE]: default the MCU have four bank
   508            C        ; others: xx.h must be define in "xx.h"
   509            C        ;*******************************************
   510            C        ClrRamBank MACRO
   511            C        IFDEF EM78P520.H
   512            C        	MOV     A, @0XE0        ; 清RAM 初始地址
   513            C        	MOV     R4, A           ;
   514            C        	CLR     BSR
   515            C        	;INC     BSR            ; BANK 0 is used for exchange reg(FIFO)
   516            C        ;CLEAR_RAM_LOOP_P510:
   517            C        	WDTC
   518            C        	CLR     R0
   519            C        	INC     R4
   520            C        	MOV     A, R4
   521            C        	AND     A, @0X3F
   522            C        	JBS     R3, Z
   523            C        	JMP     $-5            ; CLEAR_RAM_LOOP_P510
   524            C        	INC     BSR
   525            C        	MOV     A, BSR         ; 选择BANK0 (BSR == 0X05)
   526            C        	AND     A, @0X07
   527            C        	BS      R4, 5
   528            C        	BS      R4, 6
   529            C        	JBS     R3, 2
   530            C        	JMP     $-13           ; CLEAR_RAM_LOOP_P510
   531            C        	CLR     R4
   532            C        	CLR     BSR
   533            C        	BS      R4,6
   534            C        
   535            C        ELSEIFDEF EM78M611.H
   536            C        	CLR     RC
   537            C        	CLR     RD
   538            C        	CLR     0X10
   539            C        	MOV     A,@0X2F
   540            C        	MOV     0X10,A
   541            C        
   542            C        	MOV     A,@0X11
   543            C        	MOV     RSR,A
   544            C        ;CLRLOOPU1:
   545            C        	CLR     R0
   546            C        	INC     RSR
   547            C        	DJZ     0X10
   548            C        	JMP     $-3        ;CLRLOOPU1
   549            C            CLR     R0
   550            C        	MOV     A,@0X20
   551            C        	MOV     0X10,A
   552            C        	MOV     A,@0X60
   553            C        	MOV     RSR,A
   554            C        
   555            C        ;CLRLOOPU2:
   556            C        	CLR     R0
   557            C        	INC     RSR
   558            C        	DJZ     0X10
   559            C        	JMP     $-3             ;CLRLOOPU2
   560            C        
   561            C        	CLR     R0
   562            C        	MOV     A,@0X20
   563            C        	MOV     0X10,A
   564            C        	MOV     A,@0XA0
   565            C        	MOV     RSR,A
   566            C        
   567            C        ;CLRLOOPU3:
   568            C        	CLR     R0
   569            C        	INC     RSR
   570            C        	DJZ     0X10
   571            C        	JMP     $-3            ;CLRLOOPU3
   572            C        	CLR     R0
   573            C        
   574            C        	MOV     A,@0X11
   575            C        	MOV     RD,A
   576            C        	CLR     RE
   577            C        	MOV     A,@1
   578            C        	MOV     RD,A
   579            C        	MOV     A,@0X00
   580            C        	MOV     RE,A
   581            C        	MOV     RE,A
   582            C        	MOV     RE,A
   583            C        	MOV     RE,A
   584            C        	MOV     RE,A
   585            C        	MOV     RE,A
   586            C        	MOV     RE,A
   587            C        	MOV     RE,A
   588            C        	BS      RC,5
   589            C        
   590            C        
   591            C        ELSEIFDEF EM78P447.H
   592            C         	MOV     A,@0x10
   593            C        	MOV     R4,A
   594            C        ;CLEAR_RAM_LOOP_P447:
   595            C        	CLR     R0
   596            C        	INC     R4
   597            C        	JBC     R4,6
   598            C        	BS      R4,5
   599            C        	JBC     R4,7
   600            C        	BS      R4,5
   601            C        	JBS     R3,Z
   602            C        	JMP     $-7            ; CLEAR_RAM_LOOP_P447:
   603            C        	CLR     R4
   604            C        
   605            C        ELSEIFDEF EM78P468.H
   606            C        	MOV     A,@0X10
   607            C        	MOV     RSR,A
   608            C        ;CLEAR_RAM_LOOP_P468:
   609            C        	CLR     R0
   610            C        	INC     RSR
   611            C        	JBC     RSR,6
   612            C        	BS      RSR,5
   613            C        	JBC     RSR,7
   614            C        	BS      RSR,5
   615            C        	JBS     STATUS,Z
   616            C        	JMP     $-7            ; CLEAR_RAM_LOOP_P468
   617            C        	CLR     RSR
   618            C        
   619            C        ELSEIFDEF EM78P458.H
   620            C                MOV     A,@0X10
   621            C                MOV     RSR,A
   622            C        ;CLEAR_RAM_LOOP_P458:
   623            C                CLR     R0
   624            C                INC     RSR
   625            C                JBC     RSR,6
   626            C                BS      RSR,5
   627            C                JBS     RSR,7
   628            C                JMP     $-5        ; CLEAR_RAM_LOOP_P458
   629            C                CLR     RSR
   630            C        
   631            C        ELSEIFDEF EM78P451.H
   632            C                MOV     A,@0X10
   633            C                MOV     RSR,A
   634            C        ;CLEAR_RAM_LOOP_P451:
   635            C                CLR     R0
   636            C                INC     RSR
   637            C                JBC     RSR,6
   638            C                BS      RSR,5
   639            C                JBC     RSR,7
   640            C                BS      RSR,5
   641            C                JBS     STATUS,Z
   642            C                JMP     $-7        ; CLEAR_RAM_LOOP_P451
   643            C        
   644            C        ELSE
   645            C        	MOV     A,@0x10        ; clear all ram bank
   646            C        	MOV     R4,A
   647            C        ;CLEAR_RAM_LOOP:
   648            C        	CLR     R0
   649            C        	INC     R4
   650            C        	JBC     R4,6
   651            C        	BS      R4,5
   652            C        	JBC     R4,7
   653            C        	BS      R4,5
   654            C        	JBS     R3,Z
   655            C        	JMP     $-7            ; CLEAR_RAM_LOOP:
   656            C        	CLR     R4
   657            C        	MESSAGE "Clear all RAM bank"
   658            C        ENDIF
   659            C        ENDM
   660            C        
   661            C        ;*******************************************
   662            C        ; RAM clear function
   663            C        ; [ELSE]: default the MCU have four bank
   664            C        ; others: xx.h must be define in "xx.h"
   665            C        ;*******************************************
   666            C        ClrCommRamBank MACRO
   667            C        	MOV                 A, @0X10                ; 清RAM 初始地址
   668            C        	MOV                 R4, A
   669            C        CLEAR_10_1F_RAM_LOOP:
   670            C        	WDTC
   671            C        	CLR                 R0
   672            C        	INC                 R4
   673            C        	MOV                 A,@0B00111111
   674            C        	AND                 A,R4
   675            C        	SUB                 A,@0X1F
   676            C        	JBC                 R3,C
   677            C        	JMP                 CLEAR_10_1F_RAM_LOOP
   678            C        	CLR                 R4
   679            C        ENDM
   680            C        
   681            C        
    15                     include "D:\include\EM78xx\EM78Math.H"
     1            C        ;**********************************************************************;
     2            C        ; Title:        EM78Math Macros Define                                 ;
     3            C        ; Description:  The Maths for EM78x447xxx                              ;
     4            C        ; Company:      Elan Corp.Inc                                          ;
     5            C        ; Author:       Shenzhen 8Bit Tean                                     ;
     6            C        ; Date:         5/26/2004                                              ;
     7            C        ; Version:      1.0                                                    ;
     8            C        ;**********************************************************************
     9            C        ;----------------------------------------------------------------
    10            C        EM78Math.H      EQU     EM78Math.H
    11            C        
    12            C        
    13            C        ;----------------------------------------------------------------
    14            C        
    15            C        
    16            C        
    17            C        ;**********************************************************************;
    18            C        ; Title:       1 Byte Binary Code Transform BCD Code                   ;
    19            C        ; Description: Hundred Bigit Of Bcd Cade Storage In  Low Bigit  Of     ;
    20            C        ;              reg_acc3,Entries Bigit Of Bcd Cade Storage In High      ;
    21            C        ;              Bigit Of reg_acc2, Binary Data Storage In reg_acc1      ;
    22            C        ; Arithmetic:  BCD==100*a+10*b+c                                       ;
    23            C        ; Input:       reg_acc1                                                ;
    24            C        ; Output:      reg_acc3, reg_acc2                                      ;
    25            C        ; Variable Register:None                                               ;
    26            C        ; Register Changed: R3, 0 ;ACC                                         ;
    27            C        ;**********************************************************************;
    28            C        ;-----------------------------------------------------------------
    29            C        mBinToBcd1 MACRO reg_acc1, reg_acc3, reg_acc2
    30            C        ;
    31            C                CLR     reg_acc2        ;clear BCD data register
    32            C                CLR     reg_acc3
    33            C                MOV     A, reg_acc1
    34            C        $Bin_Bcd1:
    35            C                ADD     A, @156         ;subtract 100 from binary that is transform
    36            C                JBS     STATUS, C       ;borrow bigit?
    37            C                JMP     $Bin_Bcd2       ;borrow bigit jump to Bin_Bcd2
    38            C                INC     reg_acc3        ;if don't borrow bigit then hundred bigit adding 1
    39            C                JMP     $Bin_Bcd1       ;backing out
    40            C        $Bin_Bcd2:
    41            C                ADD     A, @100         ;有借位，则加回被减去的数100
    42            C                MOV     reg_acc1, A
    43            C        $Bin_Bcd3:
    44            C                ADD     A, @246         ;余下的被减数再减10
    45            C                JBS     STATUS, C       ;有借位吗？
    46            C                JMP     $Bin_Bcd4       ;有借位，则跳出
    47            C                INC     reg_acc2        ;无借位，则BCD码的十位寄存器加1
    48            C                JMP     $Bin_Bcd3
    49            C        $Bin_Bcd4:
    50            C                ADD     A, @10          ;有借位，则加回被减去的数10
    51            C                SWAP    reg_acc2        ;将BCD码的十位存到reg_acc2的高半字节
    52            C                ADD     reg_acc2, A     ;将BCD码的个位存到reg_acc2的低半字节
    53            C                ENDM
    54            C        ;
    55            C        ;**********************************************************************;
    56            C        ; Title:       2 Byte Binary Code Transform BCD Code                   ;
    57            C        ; Description: Highest Bigit Of Bcd Storage In Low Byte Of reg_acc5,   ;
    58            C        ;              Lowest Bigit Of Bcd Storage In Low Byte Of reg_acc3,    ;
    59            C        ;              High Bigit Of Binary Storage In reg_acc1,               ;
    60            C        ;              Low Bigit Of Binart Storage In reg_acc2,                ;
    61            C        ; Input:       reg_acc1, reg_acc2                                      ;
    62            C        ; Output:      reg_acc3, reg_acc4, reg_acc5                            ;
    63            C        ; Variable Register:reg_acc, reg_accd                                  ;
    64            C        ; Register Changed: R3, 0; ACC                                         ;
    65            C        ; Status:      1                                                       ;
    66            C        ;**********************************************************************;
    67            C        ;
    68            C        mBinToBcd2 MACRO reg_acc2, reg_acc1, reg_acc5, reg_acc4, reg_acc3
    69            C        ;
    70            C                MOV     A, @16          ;设定移位字节长度(其值=byte*8)
    71            C                MOV     reg_acc, A
    72            C                CLR     reg_acc5        ;清BCD码寄存器
    73            C                CLR     reg_acc4
    74            C                CLR     reg_acc3
    75            C                BC      STATUS, C       ;清R3标志位C
    76            C        $Bin_Bcd1:
    77            C                RLC     reg_acc1        ;左移被转换的字节的最低位寄存器
    78            C                RLC     reg_acc2        ;左移被转换的字节的最高位寄存器
    79            C                RLC     reg_acc3        ;左移BCD码的最低位寄存器
    80            C                RLC     reg_acc4
    81            C                RLC     reg_acc5        ;左移BCD码的最高位寄存器
    82            C                DJZ     reg_acc         ;移位完成了吗？
    83            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
    84            C                JMP     $Bin_Bcd3       ;移位完，跳出
    85            C        $Bin_Bcd2:
    86            C                MOV     A, reg_acc3     ;对reg_acc3进行BCD码调整
    87            C                CALL    $bcdadj         ;调BCD码调整子程序
    88            C                MOV     reg_acc3, A     ;
    89            C                MOV     A, reg_acc4     ;对reg_acc4进行BCD码调整
    90            C                CALL    $BCDADJ
    91            C                MOV     reg_acc4, A
    92            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
    93            C                CALL    $BCDADJ
    94            C                MOV     reg_acc5, A
    95            C                JMP     $Bin_Bcd1       ;返回，继续进行移位处理
    96            C        ;-------BCD Code Adjust Subprogram---------------
    97            C        $BCDADJ:
    98            C                ADD     A, @51
    99            C                MOV     reg_accd, A
   100            C                JBS     reg_accd, 3
   101            C                ADD     A, @253
   102            C                JBS     reg_accd, 7
   103            C                ADD     A, @208
   104            C                RET
   105            C        $Bin_Bcd3:
   106            C                ENDM
   107            C        ;
   108            C        ;**********************************************************************;
   109            C        ; Title:      3 Byte Binary Code Transform Bcd Code                    ;
   110            C        ; Description:reg_acc7的高半字节存放BCD码的最高位，                    ;
   111            C        ;             reg_acc4的低半字节存放BCD码的最低位,                     ;
   112            C        ;             reg_acc3存放被转换字节的最高位，                         ;
   113            C        ;             reg_acc1存放被转换字节的最低位。                         ;
   114            C        ; Input:      reg_acc1, reg_acc2, reg_acc3                             ;
   115            C        ; Output:     reg_acc4, reg_acc5, reg_acc6, reg_acc7                   ;
   116            C        ; Variable Register:reg_acc, reg_accd                                  ;
   117            C        ; Register Changed: R3, 0;ACC                                          ;
   118            C        ; stack:      1                                                        ;
   119            C        ;**********************************************************************;
   120            C        ;
   121            C        mBinToBcd3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc7, reg_acc6, reg_acc5, reg_acc4
   122            C        ;
   123            C                MOV     A, @24          ;设定移位字节长度（其值=byte*8)
   124            C                MOV     reg_acc, A
   125            C                CLR     reg_acc4
   126            C                CLR     reg_acc5
   127            C                CLR     reg_acc6
   128            C                CLR     reg_acc7
   129            C                BC      STATUS, C       ;清R3标志位C
   130            C        $Bin_Bcd1:
   131            C                RLC     reg_acc1        ;左移被转换字节数的最低位寄存器
   132            C                RLC     reg_acc2
   133            C                RLC     reg_acc3        ;左移被转换字节数的最高位寄存器
   134            C                RLC     reg_acc4        ;左移BCD码的最低位寄存器
   135            C                RLC     reg_acc5
   136            C                RLC     reg_acc6
   137            C                RLC     reg_acc7        ;左移BCD码的最高位寄存器
   138            C                DJZ     reg_acc         ;移位完成了吗？
   139            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   140            C                JMP     $Bin_Bcd3       ;移位完，跳出
   141            C        $Bin_Bcd2:
   142            C                MOV     A, reg_acc4     ;对reg_acc4进行BCD码调整
   143            C                CALL    $BCDADJ         ;调BCD码调整子程序
   144            C                MOV     reg_acc4, A
   145            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
   146            C                CALL    $BCDADJ
   147            C                MOV     reg_acc5, A
   148            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   149            C                CALL    $BCDADJ
   150            C                MOV     reg_acc6, A
   151            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   152            C                CALL    $BCDADJ
   153            C                MOV     reg_acc7, A
   154            C                JMP     $Bin_Bcd1       ;移位未完，返回，继续进行移位处理
   155            C        ;-------BCD Code Adjust Subprogram---------------
   156            C        $BCDADJ:
   157            C                ADD     A, @51
   158            C                MOV     reg_accd, A
   159            C                JBS     reg_accd, 3
   160            C                ADD     A, @253
   161            C                JBS     reg_accd, 7
   162            C                ADD     A, @208
   163            C                RET
   164            C        $Bin_Bcd3:
   165            C                ENDM
   166            C        ;
   167            C        ;**********************************************************************;
   168            C        ; Title:      4 Byte Binary Code Transform Bcd Code                    ;
   169            C        ; Description:reg_acc9的高半字节存放BCD码的最高位，                    ;
   170            C        ;             reg_acc5的低半字节存放BCD码的最低位，                    ;
   171            C        ;             reg_acc4存放被转换字节的最高位，                         ;
   172            C        ;             reg_acc1存放被转换字节的最低位?                          ;
   173            C        ; Arithmetic:                                                          ;
   174            C        ; Input:      reg_acc1, reg_acc2, reg_acc3, reg_acc4                   ;
   175            C        ; Output:     reg_acc5, reg_acc6, reg_acc7, reg_acc8, reg_acc9         ;
   176            C        ; Variable Register:reg_acc, reg_accd                                  ;
   177            C        ; Register Changed: R3, 0; ACC                                         ;
   178            C        ; stack:      1                                                        ;
   179            C        ;**********************************************************************;
   180            C        ;
   181            C        mBinToBcd4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc9, reg_acc8, reg_acc7, reg_acc6, reg_acc5
   182            C        ;
   183            C                MOV     A,  @32         ;设定移位字节长度(其值=byte*8)
   184            C                MOV     reg_acc, A
   185            C                CLR     reg_acc5        ;清BCD码寄存器
   186            C                CLR     reg_acc6
   187            C                CLR     reg_acc7
   188            C                CLR     reg_acc8
   189            C                CLR     reg_acc9
   190            C                BC      STATUS, C       ;清R3标志位C
   191            C        $Bin_Bcd1:
   192            C                RLC     reg_acc1        ;左移被转换字节数的最低位寄存器
   193            C                RLC     reg_acc2
   194            C                RLC     reg_acc3
   195            C                RLC     reg_acc4        ;左移被转换字节数的最高位寄存器
   196            C                RLC     reg_acc5
   197            C                RLC     reg_acc6        ;左移BCD码的最低位寄存器
   198            C                RLC     reg_acc7
   199            C                RLC     reg_acc8
   200            C                RLC     reg_acc9        ;左移BCD码的最高位寄存器
   201            C                DJZ     reg_acc         ;移位完成了吗？
   202            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   203            C                JMP     $Bin_Bcd3       ;移位完，跳出
   204            C        $Bin_Bcd2:
   205            C                MOV     A, reg_acc5     ;对reg_acc5进行BCD码调整
   206            C                CALL    $BCDADJ         ;调BCD码调整子程序
   207            C                MOV     reg_acc5, A
   208            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   209            C                CALL    $BCDADJ
   210            C                MOV     reg_acc6, A
   211            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   212            C                CALL    $BCDADJ
   213            C                MOV     reg_acc7, A
   214            C                MOV     A, reg_acc8     ;对reg_acc8进行BCD码调整
   215            C                CALL    $BCDADJ
   216            C                MOV     reg_acc8, A
   217            C                MOV     A, reg_acc9     ;对reg_acc9进行BCD码调整
   218            C                CALL    $BCDADJ
   219            C                MOV     reg_acc9, A
   220            C                JMP     $Bin_Bcd1       ;移位未完成，返回，继续进行移位处理
   221            C        ;-------BCD Code Adjust Subprogram---------------
   222            C        $BCDADJ:
   223            C                ADD     A, @51
   224            C                MOV     reg_accd, A
   225            C                JBS     reg_accd, 3
   226            C                ADD     A, @253
   227            C                JBS     reg_accd, 7
   228            C                ADD     A, @208
   229            C                RET
   230            C        $Bin_Bcd3:
   231            C                ENDM
   232            C        ;**********************************************************************;
   233            C        ; Title:      5 Byte Binary Code Transform Bcd Code                    ;
   234            C        ; Description:reg_accc的低半字节存放BCD的最高位，                      ;
   235            C        ;             reg_acc6的低半字节存放BCD的最低位，                      ;
   236            C        ;             reg_acc5存放被转换字节的最高位，                         ;
   237            C        ;             reg_acc1存放被转换字节的最低位。                         ;
   238            C        ; Input:      reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,        ;
   239            C        ; Output:     reg_acc6, reg_acc7, reg_acc8, reg_acc9, reg_acca,        ;
   240            C        ;             reg_accb, reg_accc                                       ;
   241            C        ; Variable Register:reg_acc, reg_accd                                  ;
   242            C        ; Register Changed: R3, 0;ACC                                          ;
   243            C        ; Stack:      1                                                        ;
   244            C        ;**********************************************************************;
   245            C        ;
   246            C        mBinToBcd5 MACRO reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
   247            C        ;
   248            C                MOV     A,  @40         ;设定移位字节长度(其值=byte*8)
   249            C                MOV     reg_acc, A
   250            C                CLR     reg_acc6        ;清BCD码寄存器
   251            C                CLR     reg_acc7
   252            C                CLR     reg_acc8
   253            C                CLR     reg_acc9
   254            C                CLR     reg_acca
   255            C                CLR     reg_accb
   256            C                CLR     reg_accc
   257            C                BC      STATUS, C       ;清R3标志位C
   258            C        $Bin_Bcd1:
   259            C                RLC     reg_acc1
   260            C                RLC     reg_acc2
   261            C                RLC     reg_acc3        ;左移被转换字节的最低位寄存器
   262            C                RLC     reg_acc4        ;
   263            C                RLC     reg_acc5        ;左移被转换字节的最高位寄存器
   264            C        ;
   265            C                RLC     reg_acc6        ;左移BCD码寄存器的最低位
   266            C                RLC     reg_acc7
   267            C                RLC     reg_acc8
   268            C                RLC     reg_acc9
   269            C                RLC     reg_acca
   270            C                RLC     reg_accb
   271            C                RLC     reg_accc        ;左移BCD码寄存器的最高位
   272            C                DJZ     reg_acc         ;移位完成了吗？
   273            C                JMP     $Bin_Bcd2       ;未完，进行BCD码调整
   274            C                JMP     $Bin_Bcd3       ;移位完，跳出
   275            C        $Bin_Bcd2:
   276            C                MOV     A, reg_acc6     ;对reg_acc6进行BCD码调整
   277            C                CALL    $BCDADJ         ;调BCD码调整子程序
   278            C                MOV     reg_acc6, A
   279            C                MOV     A, reg_acc7     ;对reg_acc7进行BCD码调整
   280            C                CALL    $BCDADJ
   281            C                MOV     reg_acc7, A
   282            C                MOV     A, reg_acc8     ;对reg_acc8进行BCD码调整
   283            C                CALL    $BCDADJ
   284            C                MOV     reg_acc8, A
   285            C                MOV     A, reg_acc9     ;对reg_acc9进行BCD码调整
   286            C                CALL    $BCDADJ
   287            C                MOV     reg_acc9, A
   288            C                MOV     A, reg_acca     ;对reg_acca进行BCD码调整
   289            C                CALL    $BCDADJ
   290            C                MOV     reg_acca, A
   291            C                MOV     A, reg_accb     ;对reg_accb进行BCD码调整
   292            C                CALL    $BCDADJ
   293            C                MOV     reg_accb, A
   294            C                MOV     A, reg_accc     ;对reg_accc进行BCD码调整
   295            C                CALL    $BCDADJ
   296            C                MOV     reg_accc, A
   297            C                JMP     $Bin_Bcd1       ;未移完，返回，继续进行移位处理
   298            C        ;
   299            C        ;-------BCD Code Adjust Subprogram---------------
   300            C        $BCDADJ:
   301            C                ADD     A, @51
   302            C                MOV     reg_accd, A
   303            C                JBS     reg_accd, 3
   304            C                ADD     A, @253
   305            C                JBS     reg_accd, 7
   306            C                ADD     A, @208
   307            C                RET
   308            C        $Bin_Bcd3:
   309            C                ENDM
   310            C        ;
   311            C        ;**********************************************************************;
   312            C        ; Title:      1 Byte Bcd Code Transform 1 Byte Binary Code             ;
   313            C        ; Input:      reg_acc1(BCD code)                                       ;
   314            C        ; Output:     reg_acc2(Binary Code)                                    ;
   315            C        ; Register Changed: STATUS, C;ACC                                      ;
   316            C        ;**********************************************************************;
   317            C        ;
   318            C        mBcdToBin1 MACRO reg_acc1, reg_acc2
   319            C        ;
   320            C                CLR     reg_acc2
   321            C                SWAPA   reg_acc1        ;将reg_acc1的高半字节送到A的低半字节
   322            C                AND     A, @0X0F        ;屏蔽reg_acc1, 0-3bit.
   323            C                MOV     reg_acc2, A
   324            C                BC      STATUS, C
   325            C                RLC     reg_acc2        ;reg_acc2*10
   326            C                RLC     reg_acc2
   327            C                ADD     reg_acc2, A
   328            C                RLC     reg_acc2
   329            C                MOV     A, reg_acc1
   330            C                AND     A, @0X0F        ;屏蔽reg_acc1, 4-7bit
   331            C                ADD     reg_acc2, A     ;bcd code的十位数乘10后加bcd code的个位数
   332            C                ENDM
   333            C        ;
   334            C        ;**********************************************************************;
   335            C        ; Title:     2 Byte Bcd Code Transform 2 Byte Binary Code              ;
   336            C        ; Input:     reg_acc1, reg_acc2;reg_acc2:High Bigit Of Bcd Code;       ;
   337            C        ;            reg_acc1:Low Bigit Of Bcd Code.                           ;
   338            C        ; Output:    reg_acc3, reg_acc4;reg_acc4:High Byte Binary Code;        ;
   339            C        ;            reg_acc3:Low Byte Of Binary Code.                         ;
   340            C        ; Register Changed: STATUS, C; ACC                                     ;
   341            C        ; Stack:     1                                                         ;
   342            C        ;**********************************************************************;
   343            C        ;
   344            C        mBcdToBin2 MACRO reg_acc2, reg_acc1, reg_acc4, reg_acc3
   345            C        ;
   346            C                CLR     reg_acc3        ;clear binary code register
   347            C                CLR     reg_acc4
   348            C                MOV     A, @16          ;移位的次数（reg_acc==byte*8)
   349            C                Mov     reg_acc, A
   350            C        $Bcd_Bin1:
   351            C                BC      STATUS, C
   352            C                RRC     reg_acc2        ;将BCD数和BINARY数一起右移，从高移到低
   353            C                RRC     reg_acc1
   354            C                RRC     reg_acc4
   355            C                RRC     reg_acc3
   356            C                MOV     A, reg_acc1     ;对BCD数进行BCD调整
   357            C                CALL    $Binadj
   358            C                MOV     reg_acc1, A
   359            C                MOV     A, reg_acc2
   360            C                CALL    $Binadj
   361            C                MOV     reg_acc2, A
   362            C                DJZ     reg_acc
   363            C                JMP     $Bcd_Bin1
   364            C                JMP     $Bcd_Bin2
   365            C        $Binadj:
   366            C                MOV     reg_accd, A
   367            C                JBC     reg_accd, 3
   368            C                ADD     A, @253
   369            C                JBC     reg_accd, 7
   370            C                ADD     A, @208
   371            C                RET
   372            C        $Bcd_Bin2:
   373            C                ENDM
   374            C        ;
   375            C        ;**********************************************************************;
   376            C        ; Title:    3 Byte Bcd Code Transform 3 Byte Binary Code               ;
   377            C        ; Input:    reg_acc1,reg_acc2,reg_acc3;reg_acc3:High Bigit Of Bcd Code;;
   378            C        ;           reg_acc1:Low Bigit Of Bcd Code.                            ;
   379            C        ; Output:   reg_acc4,reg_acc5,reg_acc6;reg_acc6:High Byte Binary Code; ;
   380            C        ;           reg_acc4:Low Byte Of Binary Code.                          ;
   381            C        ; Register Changed: STATUS, C; ACC                                     ;
   382            C        ; Stack:     1                                                         ;
   383            C        ;**********************************************************************;
   384            C        ;
   385            C        mBcdToBin3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5, reg_acc4
   386            C        ;
   387            C                CLR     reg_acc4
   388            C                CLR     reg_acc5
   389            C                CLR     reg_acc6
   390            C                MOV     A, @24          ;移位的次数（reg_acc==BYTE*8)
   391            C                MOV     reg_acc, A
   392            C        $Bcd_Bin1:
   393            C                BC      STATUS, C
   394            C                RRC     reg_acc3
   395            C                RRC     reg_acc2
   396            C                RRC     reg_acc1
   397            C                RRC     reg_acc6
   398            C                RRC     reg_acc5
   399            C                RRC     reg_acc4
   400            C                MOV     A, reg_acc1
   401            C                CALL    $Binadj
   402            C                MOV     reg_acc1, A
   403            C                MOV     A, reg_acc2
   404            C                CALL    $Binadj
   405            C                MOV     reg_acc2, A
   406            C                MOV     A, reg_acc3
   407            C                CALL    $Binadj
   408            C                MOV     reg_acc3, A
   409            C                DJZ     reg_acc
   410            C                JMP     $Bcd_Bin1
   411            C                JMP     $Bcd_Bin2
   412            C        $Binadj:
   413            C                MOV     reg_accd, A
   414            C                JBC     reg_accd, 3
   415            C                ADD     A, @253
   416            C                JBC     reg_accd, 7
   417            C                ADD     A, @208
   418            C                RET
   419            C        $Bcd_Bin2:
   420            C                ENDM
   421            C        ;
   422            C        ;**********************************************************************;
   423            C        ; Title:     4 Byte Bcd Code Transform 4 Byte Binary Code              ;
   424            C        ; Input:     reg_acc1, reg_acc2, reg_acc3, reg_acc4;reg_acc4:High Bigit;
   425            C        ;            Of Bcd Code;reg_acc1:Low Bigit Of Bcd Code.               ;
   426            C        ; Output:    reg_acc5, reg_acc6, reg_acc7, reg_acc8;reg_acc8:High Byte ;
   427            C        ;            Binary Code;reg_acc5:Low Byte Of Binary Code.             ;
   428            C        ; Register Changed: STATUS, C;ACC                                      ;
   429            C        ; Stack:     1                                                         ;
   430            C        ;**********************************************************************;
   431            C        ;
   432            C        mBcdToBin4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc8, reg_acc7, reg_acc6, reg_acc5
   433            C        ;
   434            C                CLR     reg_acc5
   435            C                CLR     reg_acc6
   436            C                CLR     reg_acc7
   437            C                CLR     reg_acc8
   438            C                MOV     A, @32          ;移位的次数（reg_acc==BYTE*8)
   439            C                MOV     reg_acc, A
   440            C        $Bcd_Bin1:
   441            C                BC      STATUS, C
   442            C                RRC     reg_acc4
   443            C                RRC     reg_acc3
   444            C                RRC     reg_acc2
   445            C                RRC     reg_acc1
   446            C                RRC     reg_acc8
   447            C                RRC     reg_acc7
   448            C                RRC     reg_acc6
   449            C                RRC     reg_acc5
   450            C                MOV     A, reg_acc1
   451            C                CALL    $Binadj
   452            C                MOV     reg_acc1, A
   453            C                MOV     A, reg_acc2
   454            C                CALL    $Binadj
   455            C                MOV     reg_acc2, A
   456            C                MOV     A, reg_acc3
   457            C                CALL    $Binadj
   458            C                MOV     reg_acc3, A
   459            C                MOV     A, reg_acc4
   460            C                CALL    $Binadj
   461            C                MOV     reg_acc4, A
   462            C                DJZ     reg_acc
   463            C                JMP     $Bcd_Bin1
   464            C                JMP     $Bcd_Bin2
   465            C        $Binadj:
   466            C                MOV     reg_accd, A
   467            C                JBC     reg_accd, 3
   468            C                ADD     A, @253
   469            C                JBC     reg_accd, 7
   470            C                ADD     A, @208
   471            C                RET
   472            C        $Bcd_Bin2:
   473            C                ENDM
   474            C        ;
   475            C        ;**********************************************************************;
   476            C        ; Title:     5 Byte Bcd Code Transform 5 Byte Binary Code              ;
   477            C        ; Input:     reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5;         ;
   478            C        ;            reg_acc5:High Bigit Of Bcd Code;reg_acc1:lOw Bigit Of     ;
   479            C        ;            Bcd Code.                                                 ;
   480            C        ; Output:    reg_acc6, reg_acc7, reg_acc8, reg_acc9, reg_acca;         ;
   481            C        ;            reg_acca:High Byte Of Binary Code;reg_acc6:Low Byte       ;
   482            C        ;            Of Binary Code.                                           ;
   483            C        ; Register Changed: STATUS, C; ACC                                     ;
   484            C        ; Stack:     1                                                         ;
   485            C        ;**********************************************************************;
   486            C        ;
   487            C        mBcdToBin5 MACRO  reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
   488            C        ;
   489            C                CLR     reg_acc6
   490            C                CLR     reg_acc7
   491            C                CLR     reg_acc8
   492            C                CLR     reg_acc9
   493            C                CLR     reg_acca
   494            C                MOV     A, @40          ;移位的次数（reg_acc==BYTE*8)
   495            C                MOV     reg_acc, A
   496            C        $Bcd_Bin1:
   497            C                BC      STATUS, C
   498            C                RRC     reg_acc5
   499            C                RRC     reg_acc4
   500            C                RRC     reg_acc3
   501            C                RRC     reg_acc2
   502            C                RRC     reg_acc1
   503            C                RRC     reg_acca
   504            C                RRC     reg_acc9
   505            C                RRC     reg_acc8
   506            C                RRC     reg_acc7
   507            C                RRC     reg_acc6
   508            C                MOV     A, reg_acc1
   509            C                CALL    $Binadj
   510            C                MOV     reg_acc1, A
   511            C                MOV     A, reg_acc2
   512            C                CALL    $Binadj
   513            C                MOV     reg_acc2, A
   514            C                MOV     A, reg_acc3
   515            C                CALL    $Binadj
   516            C                MOV     reg_acc3, A
   517            C                MOV     A, reg_acc4
   518            C                CALL    $Binadj
   519            C                MOV     reg_acc4, A
   520            C                MOV     A, reg_acc5
   521            C                CALL    $Binadj
   522            C                MOV     reg_acc5, A
   523            C                DJZ     reg_acc
   524            C                JMP     $Bcd_Bin1
   525            C                JMP     $Bcd_Bin2
   526            C        $Binadj:
   527            C                MOV     reg_accd, A
   528            C                JBC     reg_accd, 3
   529            C                ADD     A, @253
   530            C                JBC     reg_accd, 7
   531            C                ADD     A, @208
   532            C                RET
   533            C        $Bcd_Bin2:
   534            C                ENDM
   535            C        
   536            C        
   537            C        ;*****************************************************************
   538            C        ;Function:    Subtration
   539            C        ;Input:       reg_acc2, reg_acc1, reg_acc3
   540            C        ;Output:      reg_acc2, reg_acc1
   541            C        ;description: reg_acc2/reg_acc1 is the reslut;
   542            C        ;             reg_acc3 is a symbol:
   543            C        ;             0X00 Mean reslut is plus
   544            C        ;             0X01 Mean reslut is negative
   545            C        ;*****************************************************************
   546            C        mSubtration2_1 MACRO reg_acc2, reg_acc1, reg_acc3
   547            C                BC      STATUS,C
   548            C                MOV     A,reg_acc3
   549            C                SUB     reg_acc1,A
   550            C                JBC     STATUS,C
   551            C                JMP     Subtration_End  
   552            C                CLR     reg_acc3
   553            C                MOV     A,@0X01
   554            C                SUB     A,reg_acc2
   555            C                JBC     STATUS,C
   556            C                DEC     reg_acc2
   557            C                JBC     STATUS,C
   558            C                INC     reg_acc3        
   559            C        Subtration_End:
   560            C                ENDM
   561            C        
   562            C        ;**********************************************************************;
   563            C        ; Title:        Division 8 bits /8 bits -> 8 bit --8 bits              ;
   564            C        ; Description:  reg_acc1/reg_acc2->reg_acc1 --reg_acc2                 ;
   565            C        ; Input:        Dividend reg_acc1        Divisor    reg_acc2           ;
   566            C        ; Output:       Result   reg_acc1        Remainder  reg_acc2           ;
   567            C        ; Variable Register:None                                               ;
   568            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   569            C        ;**********************************************************************;
   570            C        mDIV1_1 MACRO reg_acc1, reg_acc2
   571            C        ;
   572            C                MOV     A, @8           ;Recurrence Cortrol Data
   573            C                MOV     reg_acc, A
   574            C                CLRA                    ;Check Divisor Is Zero
   575            C                OR      A, reg_acc2     ;Divisor load into A register
   576            C                JBC     STATUS, 2
   577            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   578            C                CLR     reg_acc2        ;Divisor Is Not Zero, Begin Peration，Then A=1
   579            C        $_Div_Sub:
   580            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   581            C                RLC     reg_acc2
   582            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   583            C                SUB     reg_acc2, a
   584            C                JBC     STATUS, C
   585            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   586            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   587            C                ADD     reg_acc2, A     ;Revert Dividend
   588            C        $_Div_Cnt:
   589            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   590            C                JMP     $_Div_Sub
   591            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   592            C        $_Div_Out:
   593            C                ENDM
   594            C        ;
   595            C        ;**********************************************************************;
   596            C        ; Title:        Division 16 bits /8 bits -> 16 bit --8 bits            ;
   597            C        ; Description:  (reg_acc2,reg_acc1)/reg_acc3                           ;
   598            C        ;               ->(reg_acc2,reg_acc1)--reg_acc3                        ;
   599            C        ; Input:        Dividend reg_acc2,reg_acc1       Divisor    reg_acc3   ;
   600            C        ; Output:       Result   reg_acc2,reg_acc1       Remainder  reg_acc3   ;
   601            C        ; Variable Register:None                                               ;
   602            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   603            C        ;**********************************************************************;
   604            C        ;
   605            C        mDIV2_1 MACRO reg_acc2, reg_acc1, reg_acc3
   606            C        ;
   607            C                MOV     A, @16          ;Recurrence Cortrol Data
   608            C                MOV     reg_acc, A
   609            C                CLRA                    ;Check Divisor Is Zero
   610            C                OR      A, reg_acc3     ;Divisor load into A register
   611            C                JBC     STATUS, Z
   612            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   613            C                CLR     reg_acc3        ;Divisor Is Not Zero, Begin Peration，Then A=1
   614            C        $_Div_Sub:
   615            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   616            C                RLC     reg_acc2
   617            C                RLC     reg_acc3
   618            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   619            C                JBS     STATUS, C
   620            C                JMP     $_Div_S_0
   621            C                SUB     reg_acc3, A
   622            C                JMP     $_Div_Cnt
   623            C        $_Div_S_0:
   624            C                SUB     reg_acc3, A
   625            C                JBC     STATUS, C
   626            C                JMP     $_Div_Cnt
   627            C                BC      reg_acc1, 0
   628            C                ADD     reg_acc3, A
   629            C        $_Div_Cnt:
   630            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   631            C                JMP     $_Div_Sub
   632            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   633            C        $_Div_Out:
   634            C                ENDM
   635            C        ;
   636            C        ;**********************************************************************;
   637            C        ; Title:        Division 16 bits /16 bits -> 16 bit --16 bits          ;
   638            C        ; Description:  (reg_acc2, reg_acc1)/(reg_acc4, reg_acc3)              ;
   639            C        ;               ->(reg_acc2, reg_acc1)--(reg_acc4, reg_acc3)           ;
   640            C        ; Input:        Dividend reg_acc2,reg_acc1 Divisor   reg_acc4,reg_acc3 ;
   641            C        ; Output:       Result   reg_acc2,reg_acc1 Remainder reg_acc4,reg_acc3 ;
   642            C        ; Variable Register:None                                               ;
   643            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   644            C        ;                   , reg_acc5(0x025), reg_acc6(0x26)                  ;
   645            C        ;**********************************************************************;
   646            C        ;
   647            C        mDIV2_2 MACRO reg_acc2, reg_acc1, reg_acc4, reg_acc3
   648            C        ;
   649            C                CLRA
   650            C                OR      A, reg_acc3     ;Check Divisor Is Zero
   651            C                OR      A, reg_acc4
   652            C                JBC     STATUS, Z
   653            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   654            C                MOV     A, @16          ;Recurrence Cortrol Data
   655            C                MOV     reg_acc, A
   656            C                CLR     reg_acc5        ;Divisor Is Not Zero, Begin Peration，Then A=1
   657            C                CLR     reg_acc6
   658            C        $_Div_Sub:
   659            C                BC      STATUS, C       ;Clear c Flag
   660            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   661            C                RLC     reg_acc2
   662            C                RLC     reg_acc5
   663            C                RLC     reg_acc6
   664            C                MOV     A, reg_acc4     ;Check If Dividend > Divisor
   665            C                SUB     A, reg_acc6     ;Check High Word  Equal
   666            C                JBS     STATUS, Z
   667            C                JMP     $_Div_Set
   668            C                MOV     A, reg_acc3     ;High Word Equal Then Check  Low Word
   669            C                SUB     A, reg_acc5
   670            C        $_Div_Set:
   671            C                JBS     STATUS, C
   672            C                JMP     $_Div_S_0       ;Dividend < Divisor, Quotient Add 0.
   673            C                BS      reg_acc1, 0     ;Dividend > Divisor, Quotient Add 1.
   674            C                MOV     A, reg_acc3     ;Dividend-Divisor, From Low Word To High Word.
   675            C                SUB     reg_acc5, A     ;Save Diviso
   676            C                JBS     STATUS, C
   677            C                DEC     reg_acc6        ;If Low Word < High Word, Next High Word Sub 1.
   678            C                MOV     A, reg_acc4
   679            C                SUB     reg_acc6, A
   680            C        $_Div_S_0:
   681            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   682            C                JMP     $_Div_Sub
   683            C                MOV     A, reg_acc6     ;Save Result Into User's Register.
   684            C                MOV     reg_acc4, A
   685            C                MOV     A, reg_acc5
   686            C                MOV     reg_acc3, A
   687            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   688            C        $_Div_Out:
   689            C                ENDM
   690            C        ;
   691            C        ;**********************************************************************;
   692            C        ; Title:        Division 24 bits /8 bits -> 24 bit --8 bits            ;
   693            C        ; Description:  (reg_acc3, reg_acc2, reg_acc1)/reg_acc4                ;
   694            C        ;               ->(reg_acc3, reg_acc2, reg_acc1) --reg_acc4            ;
   695            C        ; Input:        Dividend reg_acc3,reg_acc2,reg_acc1 Divisor   reg_acc4 ;
   696            C        ; Output:       Result   reg_acc3,reg_acc2,reg_acc1 Remainder reg_acc4 ;
   697            C        ; Variable Register:None                                               ;
   698            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   699            C        ;**********************************************************************;
   700            C        ;
   701            C        mDIV3_1 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc4
   702            C        ;
   703            C                MOV     A, @24          ;Recurrence Cortrol Data
   704            C                MOV     reg_acc, A
   705            C                CLRA                    ;Check Divisor Is Zero
   706            C                OR      A, reg_acc4     ;Divisor load into A register
   707            C                JBC     STATUS, Z
   708            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   709            C                CLR     reg_acc4        ;Divisor Is Not Zero, Begin Peration，Then A=1
   710            C        $_Div_Sub:
   711            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   712            C                RLC     reg_acc2
   713            C                RLC     reg_acc3
   714            C                RLC     reg_acc4
   715            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Set 1.
   716            C                JBS     STATUS, C
   717            C                JMP     $_Div_S_0       ;C Flag Is 0, Check Dividend > Divisor
   718            C                SUB     reg_acc4, A     ;C Flag Is 1, Quotient Low Bit Set 1
   719            C                JMP     $_Div_Cnt
   720            C        $_Div_S_0:
   721            C                SUB     reg_acc4, A
   722            C                JBC     STATUS, C
   723            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   724            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   725            C                ADD     reg_acc4, A     ;Revert Dividend
   726            C        $_Div_Cnt:
   727            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   728            C                JMP     $_Div_Sub
   729            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   730            C        $_Div_Out:
   731            C                ENDM
   732            C        ;
   733            C        ;**********************************************************************;
   734            C        ; Title:        Division 24 bits /16 bits -> 24 bit --16 bits          ;
   735            C        ; Description:  (reg_acc3, reg_acc2, reg_acc1)/(reg_acc5, reg_acc4)    ;
   736            C        ;               ->(reg_acc3, reg_acc2, reg_acc1) --(reg_acc5, reg_acc4);
   737            C        ; Input:        Dividend  reg_acc3 reg_acc2 reg_acc1                   ;
   738            C        ;               Divisor   reg_acc5, reg_acc4                           ;
   739            C        ; Output:       Result    reg_acc3 reg_acc2 reg_acc1                   ;
   740            C        ;               Remainder reg_acc5, reg_acc4                           ;
   741            C        ; Variable Register: None                                              ;
   742            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc6(0x26) ;
   743            C        ;                   , reg_acc7(0x27)                                   ;
   744            C        ;**********************************************************************;
   745            C        ;
   746            C        mDIV3_2 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc5, reg_acc4
   747            C        ;
   748            C                CLRA
   749            C                OR      A, reg_acc4     ;Check Divisor Is Zero
   750            C                OR      A, reg_acc5
   751            C                JBC     STATUS, Z
   752            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   753            C                MOV     A, @24          ;Recurrence Cortrol Data
   754            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   755            C                CLR     reg_acc6        ;clear Remainder register
   756            C                CLR     reg_acc7
   757            C        $_Div_Sub:
   758            C                BC      STATUS, C       ;Clear c Flag
   759            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   760            C                RLC     reg_acc2
   761            C                RLC     reg_acc3
   762            C                RLC     reg_acc6
   763            C                RLC     reg_acc7
   764            C                JBC     STATUS, C
   765            C                JMP     $_Div_Set_1     ;C Flag Is 1, Quotient Low Bit Set 1
   766            C                MOV     A, reg_acc5     ;Check If Dividend > Divisor
   767            C                SUB     A, reg_acc7     ;Check High Word  Equal
   768            C                JBS     STATUS, Z
   769            C                JMP     $_Div_Set
   770            C                MOV     A, reg_acc4     ;High Word Equal Then Check  Low Word
   771            C                SUB     A, reg_acc6
   772            C        $_Div_Set:
   773            C                JBS     STATUS, C
   774            C                JMP     $_Div_S_0       ;Dividend < Divisor, Quotient Add 0.
   775            C        $_Div_Set_1:
   776            C                BS      reg_acc1, 0     ;Dividend > Divisor, Quotient Add 1.
   777            C                MOV     A, reg_acc4     ;Dividend-Divisor, From Low Word To High Word.
   778            C                SUB     reg_acc6, A     ;Save Diviso
   779            C                JBS     STATUS, C
   780            C                DEC     reg_acc7        ;If Low Word < High Word, Next High Word Sub 1.
   781            C                MOV     A, reg_acc5
   782            C                SUB     reg_acc7, A
   783            C        $_Div_S_0:
   784            C                DJZ     reg_acc         ;If Finish Shift, SetA=1 Exit
   785            C                JMP     $_Div_Sub
   786            C                MOV     A, reg_acc7     ;Save Result Into User's Register.
   787            C                MOV     reg_acc5, A
   788            C                MOV     A, reg_acc6
   789            C                MOV     reg_acc4, A
   790            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   791            C        $_Div_Out:
   792            C                ENDM
   793            C        ;
   794            C        ;**********************************************************************;
   795            C        ; Title:        Division 24 bits /24 bits -> 24 bit --24 bits          ;
   796            C        ; Description:  (reg_acc3,reg_acc2,reg_acc1)/                          ;
   797            C        ;               (reg_acc6,reg_acc5,reg_acc4)                           ;
   798            C        ;               ->(reg_acc3,reg_acc2,reg_acc1)                         ;
   799            C        ;               --(reg_acc6,reg_acc5,reg_acc4)                         ;
   800            C        ; Input:        Dividend  reg_acc3 reg_acc2 reg_acc1                   ;
   801            C        ;               Divisor   reg_acc6 reg_acc5, reg_acc4                  ;
   802            C        ; Output:       Result    reg_acc3 reg_acc2 reg_acc1                   ;
   803            C        ;               Remainder reg_acc6, reg_acc5, reg_acc4                 ;
   804            C        ; Variable Register:None                                               ;
   805            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc7(x027) ;
   806            C        ;                   , reg_acc8(0x28),  reg_acc9(0x29)                  ;
   807            C        ;**********************************************************************;
   808            C        ;
   809            C        mDIV3_3 MACRO reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5, reg_acc4
   810            C        ;
   811            C                CLRA
   812            C                OR      A, reg_acc4     ;Check Divisor Is Zero
   813            C                OR      A, reg_acc5
   814            C                OR      A, reg_acc6
   815            C                JBC     STATUS, Z
   816            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   817            C                MOV     A, @24          ;Recurrence Cortrol Data
   818            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   819            C                CLR     reg_acc7        ;clear Remainder register
   820            C                CLR     reg_acc8
   821            C                CLR     reg_acc9
   822            C        $_Div_Sub:
   823            C                BC      STATUS, C       ;Clear c Flag
   824            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   825            C                RLC     reg_acc2
   826            C                RLC     reg_acc3
   827            C                RLC     reg_acc7
   828            C                RLC     reg_acc8
   829            C                RLC     reg_acc9
   830            C                MOV     A, reg_acc6     ;Check If Dividend > Divisor
   831            C                SUB     A, reg_acc9     ;Check High Word  Equal
   832            C                JBS     STATUS, Z
   833            C                JMP     $_Div_Set
   834            C                MOV     A, reg_acc5     ;High Word Equal Then Check  Low Word
   835            C                SUB     A, reg_acc8
   836            C                JBS     STATUS, Z
   837            C                JMP     $_Div_Set
   838            C                MOV     A, reg_acc4
   839            C                SUB     A, reg_acc7
   840            C        $_Div_Set:
   841            C                JBS     STATUS, C
   842            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
   843            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
   844            C                MOV     A, reg_acc4     ;Dividend-Divisor, From Low Word To High Word.
   845            C                SUB     reg_acc7, A     ;Save Diviso
   846            C                JBS     STATUS, C
   847            C                DEC     reg_acc8        ;If Low Word < High Word, Next High Word Sub 1.
   848            C                MOV     A, reg_acc5
   849            C                SUB     reg_acc8, A
   850            C                JBS     STATUS, C
   851            C                DEC     reg_acc9
   852            C                MOV     A, reg_acc6
   853            C                SUB     reg_acc9, A
   854            C        $_Div_S_0:
   855            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   856            C                JMP     $_Div_Sub
   857            C                MOV     A, reg_acc9     ;Save Result Into User's Register.
   858            C                MOV     reg_acc6, A
   859            C                MOV     A, reg_acc8
   860            C                MOV     reg_acc5, A
   861            C                MOV     A, reg_acc7
   862            C                MOV     reg_acc4, A
   863            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   864            C        $_Div_Out:
   865            C                ENDM
   866            C        ;
   867            C        ;**********************************************************************;
   868            C        ; Title:        Division 32 bits /8 bits -> 32 bit --8 bits            ;
   869            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/reg_acc5      ;
   870            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1) --reg_acc5  ;
   871            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   872            C        ;               Divisor   reg_acc5                                     ;
   873            C        ; Output:       Result    reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   874            C        ;               Remainder reg_acc5                                     ;
   875            C        ; Variable Register:None                                               ;
   876            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20)                 ;
   877            C        ;**********************************************************************;
   878            C        ;
   879            C        mDIV4_1 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc5
   880            C        ;
   881            C                MOV     A, @32          ;Recurrence Cortrol Data
   882            C                MOV     reg_acc, A
   883            C                CLRA                    ;Check Divisor Is Zero
   884            C                OR      A, reg_acc5     ;Divisor load into A register
   885            C                JBC     STATUS, Z
   886            C                JMP     $_Div_Out       ;Divisor Is Zero, A=0，Exit Peration.
   887            C                CLR     reg_acc5        ;Divisor Is Not Zero, Begin Peration，Then A=1.
   888            C        $_Div_Sub:
   889            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   890            C                RLC     reg_acc2
   891            C                RLC     reg_acc3
   892            C                RLC     reg_acc4
   893            C                RLC     reg_acc5
   894            C                BS      reg_acc1, 0     ;Before Check Dividend > Divisor,  Quotient Low Bit _Div_Set 1.
   895            C                JBS     STATUS, C
   896            C                JMP     $_Div_S_0       ;C Flag Is 0, Check Dividend > Divisor
   897            C                SUB     reg_acc5, A     ;C Flag Is 1, Quotient Low Bit Set 1
   898            C                JMP     $_Div_Cnt
   899            C        $_Div_S_0:
   900            C                SUB     reg_acc5, A
   901            C                JBC     STATUS, C
   902            C                JMP     $_Div_Cnt       ;Dividend > Divisor
   903            C                BC      reg_acc1, 0     ;Dividend < Divisor, Quotient low bit clear 0.
   904            C                ADD     reg_acc5, A     ;Revert Dividend
   905            C        $_Div_Cnt:
   906            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   907            C                JMP     $_Div_Sub
   908            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   909            C        $_Div_Out:
   910            C                ENDM
   911            C        ;
   912            C        ;**********************************************************************;
   913            C        ; Title:        Division 32 bits /16 bits -> 32 bit --16 bits          ;
   914            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
   915            C        ;               (reg_acc6, reg_acc5)                                   ;
   916            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
   917            C        ;               --(reg_acc6, reg_acc5)                                 ;
   918            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   919            C        ;               Divisor   reg_acc6 reg_acc5                            ;
   920            C        ; Output:       Result    reg_acc4, reg_acc3 reg_acc2 reg_acc1         ;
   921            C        ;               Remainder reg_acc6, reg_acc5                           ;
   922            C        ; Variable Register:None                                               ;
   923            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc7(x027) ;
   924            C        ;                   , reg_acc8(0x28)                                   ;
   925            C        ;**********************************************************************;
   926            C        ;
   927            C        mDIV4_2 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc6, reg_acc5
   928            C        ;
   929            C                CLRA
   930            C                OR      A, reg_acc6     ;Check Divisor Is Zero
   931            C                OR      A, reg_acc5
   932            C                JBC     STATUS, Z
   933            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   934            C                MOV     A, @32          ;Recurrence Cortrol Data
   935            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
   936            C                CLR     reg_acc7        ;clear Remainder register
   937            C                CLR     reg_acc8
   938            C        $_Div_Sub:
   939            C                BC      STATUS, C       ;Clear c Flag
   940            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
   941            C                RLC     reg_acc2
   942            C                RLC     reg_acc3
   943            C                RLC     reg_acc4
   944            C                RLC     reg_acc7
   945            C                RLC     reg_acc8
   946            C                JBC     STATUS, C
   947            C                JMP     $_Div_Set_1     ;C Flag Is 1, Quotient Low Bit Set 1
   948            C                MOV     A, reg_acc6     ;Check If Dividend > Divisor
   949            C                SUB     A, reg_acc8     ;Check High Word  Equal
   950            C                JBS     STATUS, Z
   951            C                JMP     $_Div_Set
   952            C                MOV     A, reg_acc5     ;if High Word Equal Then Check  Low Word
   953            C                SUB     A, reg_acc7
   954            C        $_Div_Set:
   955            C                JBS     STATUS, C
   956            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
   957            C        $_Div_Set_1:
   958            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
   959            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
   960            C                SUB     reg_acc7, A     ;Save Divisor
   961            C                JBS     STATUS, C
   962            C                DEC     reg_acc8        ;If Low Word < High Word, Next High Word Sub 1.
   963            C                MOV     A, reg_acc6
   964            C                SUB     reg_acc8, A
   965            C        $_Div_S_0:
   966            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
   967            C                JMP     $_Div_Sub
   968            C                MOV     A, reg_acc8     ;Save Result Into User's Register.
   969            C                MOV     reg_acc6, A
   970            C                MOV     A, reg_acc7
   971            C                MOV     reg_acc5, A
   972            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
   973            C        $_Div_Out:
   974            C                ENDM
   975            C        ;
   976            C        ;**********************************************************************;
   977            C        ; Title:        Division 32 bits /24 bits -> 32 bit --24 bits          ;
   978            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
   979            C        ;               (reg_acc7, reg_acc6, reg_acc5)                         ;
   980            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
   981            C        ;               --(reg_acc7, reg_acc6, reg_acc5)                       ;
   982            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
   983            C        ;               Divisor   reg_acc7 reg_acc6 reg_acc5                   ;
   984            C        ; Output:       Result    reg_acc4, reg_acc3 reg_acc2 reg_acc1         ;
   985            C        ;               Remainder reg_acc7 reg_acc6, reg_acc5                  ;
   986            C        ; Variable Register:None                                               ;
   987            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc8(x028) ;
   988            C        ;                   , reg_acc9(0x29) , reg_acca(0x2a)                  ;
   989            C        ;**********************************************************************;
   990            C        ;
   991            C        mDIV4_3 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc7, reg_acc6, reg_acc5
   992            C        ;
   993            C                CLRA
   994            C                OR      A, reg_acc7     ;Check Divisor Is Zero
   995            C                OR      A, reg_acc6
   996            C                OR      A, reg_acc5
   997            C                JBC     STATUS, Z
   998            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
   999            C                MOV     A, @32          ;Recurrence Cortrol Data
  1000            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
  1001            C                CLR     reg_acc8        ;clear Remainder register
  1002            C                CLR     reg_acc9
  1003            C                CLR     reg_acca
  1004            C        $_Div_Sub:
  1005            C                BC      STATUS, 0       ;Clear c Flag
  1006            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
  1007            C                RLC     reg_acc2
  1008            C                RLC     reg_acc3
  1009            C                RLC     reg_acc4
  1010            C                RLC     reg_acc8
  1011            C                RLC     reg_acc9
  1012            C                RLC     reg_acca
  1013            C                JBC     STATUS, C       ;C Flag Is 1, Quotient Low Bit Set 1
  1014            C                JMP     $_Div_Set_1
  1015            C                MOV     A, reg_acc7     ;Check If Dividend > Divisor
  1016            C                SUB     A, reg_acca     ;Check High Word  Equal
  1017            C                JBS     STATUS, Z
  1018            C                JMP     $_Div_Set
  1019            C                MOV     A, reg_acc6     ;if High Word Equal Then Check  Low Word
  1020            C                SUB     A, reg_acc9
  1021            C                JBS     STATUS, Z
  1022            C                JMP     $_Div_Set
  1023            C                MOV     A, reg_acc5
  1024            C                SUB     A, reg_acc8
  1025            C        $_Div_Set:
  1026            C                JBS     STATUS, C
  1027            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
  1028            C        $_Div_Set_1:
  1029            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
  1030            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
  1031            C                SUB     reg_acc8, A     ;Save Divisor
  1032            C                JBS     STATUS, C
  1033            C                DEC     reg_acc9        ;If Low Word < High Word, Next High Word Sub 1.
  1034            C                MOV     A, reg_acc6
  1035            C                SUB     reg_acc9, A
  1036            C                JBS     STATUS, C
  1037            C                DEC     reg_acca
  1038            C                MOV     A, reg_acc7
  1039            C                SUB     reg_acca, A
  1040            C        $_Div_S_0:
  1041            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
  1042            C                JMP     $_Div_Sub
  1043            C                MOV     A, reg_acca     ;Save Result Into User's Register.
  1044            C                MOV     reg_acc7, A
  1045            C                MOV     A, reg_acc9
  1046            C                MOV     reg_acc6, A
  1047            C                MOV     A, reg_acc8
  1048            C                MOV     reg_acc5, A
  1049            C                MOV     A, @1           ;Finish Peration, A Register Return 1
  1050            C        $_Div_Out:
  1051            C                ENDM
  1052            C        ;
  1053            C        ;**********************************************************************;
  1054            C        ; Title:        Division 32 bits /32 bits -> 32 bit --32 bits          ;
  1055            C        ; Description:  (reg_acc4, reg_acc3, reg_acc2, reg_acc1)/              ;
  1056            C        ;               (reg_acc8, reg_acc7, reg_acc6, reg_acc5)               ;
  1057            C        ;               ->(reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
  1058            C        ;               --(reg_acc8, reg_acc7, reg_acc6, reg_acc5)             ;
  1059            C        ; Input:        Dividend  reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
  1060            C        ;               Divisor   reg_acc8 reg_acc7 reg_acc6 reg_acc5          ;
  1061            C        ; Output:       Result    reg_acc4 reg_acc3 reg_acc2 reg_acc1          ;
  1062            C        ;               Remainder reg_acc8 reg_acc7 reg_acc6, reg_acc5         ;
  1063            C        ; Variable Register:None                                               ;
  1064            C        ; Register Changed: STATUS, ACC, reg_acc(address 0x20), reg_acc9(x029) ;
  1065            C        ;                   , reg_acca(0x2a) , reg_accb(0x2b) , reg_accc(0x2c) ;
  1066            C        ;**********************************************************************;
  1067            C        ;
  1068            C        mDIV4_4 MACRO reg_acc4, reg_acc3, reg_acc2, reg_acc1, reg_acc8, reg_acc7, reg_acc6, reg_acc5
  1069            C        ;
  1070            C                CLRA
  1071            C                OR      A, reg_acc8     ;Check Divisor Is Zero
  1072            C                OR      A, reg_acc7
  1073            C                OR      A, reg_acc6
  1074            C                OR      A, reg_acc5
  1075            C                JBC     STATUS, Z
  1076            C                JMP     $_Div_Out       ;If Divisor Is Zero, A=0，Exit Peration.
  1077            C                MOV     A, @32          ;Recurrence Cortrol Data
  1078            C                MOV     reg_acc, A      ;Divisor Is Not Zero, Begin Peration，Then A=1.
  1079            C                CLR     reg_acc9        ;clear Remainder register
  1080            C                CLR     reg_acca
  1081            C                CLR     reg_accb
  1082            C                CLR     reg_accc
  1083            C        $_Div_Sub:
  1084            C                BC      STATUS, C       ;Clear c Flag
  1085            C                RLC     reg_acc1        ;Dividend Left Shift 1Bit
  1086            C                RLC     reg_acc2
  1087            C                RLC     reg_acc3
  1088            C                RLC     reg_acc4
  1089            C                RLC     reg_acc9
  1090            C                RLC     reg_acca
  1091            C                RLC     reg_accb
  1092            C                RLC     reg_accc
  1093            C                MOV     A, reg_acc8     ;Check If Dividend > Divisor
  1094            C                SUB     A, reg_accc     ;Check High Word  Equal
  1095            C                JBS     STATUS, Z
  1096            C                JMP     $_Div_Set
  1097            C                MOV     A, reg_acc7     ;if High Word Equal Then Check  Low Word
  1098            C                SUB     A, reg_accb
  1099            C                JBS     STATUS, Z
  1100            C                JMP     $_Div_Set
  1101            C                MOV     A, reg_acc6
  1102            C                SUB     A, reg_acca
  1103            C                JBS     STATUS, Z
  1104            C                JMP     $_Div_Set
  1105            C                MOV     A, reg_acc5
  1106            C                SUB     A, reg_acc9
  1107            C        $_Div_Set:
  1108            C                JBS     STATUS, C
  1109            C                JMP     $_Div_S_0       ;If Dividend < Divisor, Quotient Add 0.
  1110            C                BS      reg_acc1, 0     ;If Dividend > Divisor, Quotient Add 1.
  1111            C                MOV     A, reg_acc5     ;Dividend-Divisor, From Low Word To High Word.
  1112            C                SUB     reg_acc9, A     ;Save Divisor
  1113            C                JBS     STATUS, C
  1114            C                DEC     reg_acca        ;If Low Word < High Word, Next High Word Sub 1.
  1115            C                MOV     A, reg_acc6
  1116            C                SUB     reg_acca, A
  1117            C                JBS     STATUS, C
  1118            C                DEC     reg_accb
  1119            C                MOV     A, reg_acc7
  1120            C                SUB     reg_accb, A
  1121            C                JBS     STATUS, C
  1122            C                DEC     reg_accc
  1123            C                MOV     A, reg_acc8
  1124            C                SUB     reg_accc, A
  1125            C        $_Div_S_0:
  1126            C                DJZ     reg_acc         ;If Finish Shift, Set A=1 Exit
  1127            C                JMP     $_Div_Sub
  1128            C                MOV     A, reg_accc     ;Save Result Into User's Register.
  1129            C                MOV     reg_acc8, A
  1130            C                MOV     A, reg_accb
  1131            C                MOV     reg_acc7, A
  1132            C                MOV     A, reg_acca
  1133            C                MOV     reg_acc6, A
  1134            C                MOV     A, reg_acc9
  1135            C                MOV     reg_acc5, A
  1136            C                MOV     A, @1           ;Finish Peration ,  A Register Return 1
  1137            C        $_Div_Out:
  1138            C                ENDM
  1139            C        ;
  1140            C        ;**********************************************************************;
  1141            C        ; Title:          (1 byte) * (1 byte) operation                        ;
  1142            C        ; Description:    reg_acc2 * reg_acc1 = (reg_acc2, reg_acc1)           ;
  1143            C        ; Input:          reg_acc1, reg_acc2                                   ;
  1144            C        ; Output:         reg_acc1, reg_acc2                                   ;
  1145            C        ; Register change:reg_acc                                              ;
  1146            C        ;**********************************************************************;
  1147            C        ;
  1148            C        mMUL1_1 MACRO   reg_acc2, reg_acc1
  1149            C        ;
  1150            C                MOV     A, @8
  1151            C                MOV     reg_acc, A
  1152            C                MOV     A, reg_acc2
  1153            C                CLR     reg_acc2
  1154            C        $Mul11_Loop:
  1155            C                BC      STATUS, C
  1156            C                JBC     reg_acc1, 0
  1157            C                ADD     reg_acc2, A
  1158            C                RRC     reg_acc2
  1159            C                RRC     reg_acc1
  1160            C        ;
  1161            C                DJZ     reg_acc
  1162            C                JMP     $Mul11_Loop
  1163            C                ENDM
  1164            C        ;
  1165            C        ;**********************************************************************;
  1166            C        ; Title:          (1 byte) * (2 bytes) operation                       ;
  1167            C        ; Description:    reg_acc3 * (reg_acc2, reg_acc1)                      ;
  1168            C        ;                 = (reg_acc3, reg_acc2, reg_acc1)                     ;
  1169            C        ; Input:          reg_acc1, reg_acc2, reg_acc3                         ;
  1170            C        ; Output:         reg_acc1, reg_acc2, reg_acc3                         ;
  1171            C        ; Register change:reg_acc                                              ;
  1172            C        ;**********************************************************************;
  1173            C        ;
  1174            C        mMUL1_2 MACRO   reg_acc3, reg_acc2, reg_acc1
  1175            C        ;
  1176            C                MOV     A, @16
  1177            C                MOV     reg_acc, A
  1178            C                MOV     A, reg_acc3
  1179            C                CLR     reg_acc3
  1180            C        $Mul12_Loop:
  1181            C                BC      STATUS, C
  1182            C                JBC     reg_acc1, 0
  1183            C                ADD     reg_acc3, A
  1184            C                RRC     reg_acc3
  1185            C                RRC     reg_acc2
  1186            C                RRC     reg_acc1
  1187            C        ;
  1188            C                DJZ     reg_acc
  1189            C                JMP     $Mul12_Loop
  1190            C                ENDM
  1191            C        ;
  1192            C        ;**********************************************************************;
  1193            C        ; Title:          (1 byte) * (3 bytes) operation                       ;
  1194            C        ; Description:    reg_acc4 * (reg_acc3, reg_acc2, reg_acc1)            ;
  1195            C        ;                 = (reg_acc4, reg_acc3, reg_acc2, reg_acc1)           ;
  1196            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1197            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1198            C        ; Register change:reg_acc                                              ;
  1199            C        ;**********************************************************************;
  1200            C        ;
  1201            C        mMUL1_3 MACRO   reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1202            C        ;
  1203            C                MOV     A, @24
  1204            C                MOV     reg_acc, A
  1205            C                MOV     A, reg_acc4
  1206            C                CLR     reg_acc4
  1207            C        $Mul13_Loop:
  1208            C                BC      STATUS, C
  1209            C                JBC     reg_acc1, 0
  1210            C                ADD     reg_acc4, A
  1211            C                RRC     reg_acc4
  1212            C                RRC     reg_acc3
  1213            C                RRC     reg_acc2
  1214            C                RRC     reg_acc1
  1215            C        ;
  1216            C                DJZ     reg_acc
  1217            C                JMP     $Mul13_Loop
  1218            C                ENDM
  1219            C        ;
  1220            C        ;**********************************************************************;
  1221            C        ; Title:          (1 byte) * (4 bytes) operation                       ;
  1222            C        ; Description:    reg_acc5 * (reg_acc4, reg_acc3, reg_acc2, reg_acc1)  ;
  1223            C        ;                 = (reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1) ;
  1224            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1225            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1226            C        ; Register change:reg_acc                                              ;
  1227            C        ;**********************************************************************;
  1228            C        ;
  1229            C        mMUL1_4  MACRO   reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1230            C        ;
  1231            C                MOV     A, @32
  1232            C                MOV     reg_acc, A
  1233            C                MOV     A, reg_acc5
  1234            C                CLR     reg_acc5
  1235            C        $Mul14_Loop:
  1236            C                BC      STATUS, C
  1237            C                JBC     reg_acc1, 0
  1238            C                ADD     reg_acc5, A
  1239            C                RRC     reg_acc5
  1240            C                RRC     reg_acc4
  1241            C                RRC     reg_acc3
  1242            C                RRC     reg_acc2
  1243            C                RRC     reg_acc1
  1244            C        ;
  1245            C                DJZ     reg_acc
  1246            C                JMP     $Mul14_Loop
  1247            C                ENDM
  1248            C        ;
  1249            C        ;**********************************************************************;
  1250            C        ; Title:          (2 bytes) * (2 bytes) operation                      ;
  1251            C        ; Description:    (reg_acc4, reg_acc3) * (reg_acc2, reg_acc1)          ;
  1252            C        ;                 = (reg_acc4, reg_acc3, reg_acc2, reg_acc1)           ;
  1253            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1254            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4               ;
  1255            C        ; Register change:reg_acc, reg_acc5, reg_acc6                          ;
  1256            C        ;**********************************************************************;
  1257            C        ;
  1258            C        mMUL2_2 MACRO   reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1259            C        ;
  1260            C                MOV     A, @16
  1261            C                MOV     reg_acc, A
  1262            C                MOV     A, reg_acc4
  1263            C                MOV     reg_acc6, A
  1264            C                MOV     A, reg_acc3
  1265            C                MOV     reg_acc5, A
  1266            C                CLR     reg_acc3
  1267            C                CLR     reg_acc4
  1268            C        $Mul22_Loop:
  1269            C                BC      STATUS, C
  1270            C                JBS     reg_acc1, 0
  1271            C                JMP     $Mul22_Rs
  1272            C                MOV     A, reg_acc5
  1273            C                ADD     reg_acc3, A
  1274            C        ;--------------------------------------
  1275            C                MOV     A, reg_acc4
  1276            C                JBC     STATUS, C
  1277            C                ADD     A, @1
  1278            C                RLC     reg_acc
  1279            C                ADD     A, reg_acc6
  1280            C                MOV     reg_acc4, A
  1281            C                JBC     STATUS, C
  1282            C                BS      reg_acc, 0
  1283            C                RRC     reg_acc
  1284            C        $Mul22_Rs:
  1285            C                RRC     reg_acc4
  1286            C                RRC     reg_acc3
  1287            C                RRC     reg_acc2
  1288            C                RRC     reg_acc1
  1289            C        ;
  1290            C                BC      reg_acc, 7
  1291            C                DJZ     reg_acc
  1292            C                JMP     $Mul22_Loop
  1293            C                ENDM
  1294            C        ;
  1295            C        ;**********************************************************************;
  1296            C        ; Title:          (2 bytes) * (3 bytes) operation                      ;
  1297            C        ; Description:    (reg_acc5, reg_acc4) * (reg_acc3, reg_acc2, reg_acc1);
  1298            C        ;                 = (reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1) ;
  1299            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1300            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1301            C        ; Register change:reg_acc, reg_acc6, reg_acc7                          ;
  1302            C        ;**********************************************************************;
  1303            C        ;
  1304            C        mMUL2_3 MACRO   reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1305            C        ;
  1306            C                MOV     A, @24
  1307            C                MOV     reg_acc, A
  1308            C                MOV     A, reg_acc5
  1309            C                MOV     reg_acc7, A
  1310            C                MOV     A, reg_acc4
  1311            C                MOV     reg_acc6, A
  1312            C                CLR     reg_acc4
  1313            C                CLR     reg_acc5
  1314            C        $Mul23_Loop:
  1315            C                BC      STATUS, C
  1316            C                JBS     reg_acc1, 0
  1317            C                JMP     $Mul23_Rs
  1318            C                MOV     A, reg_acc6
  1319            C                ADD     reg_acc4, A
  1320            C        ;--------------------------------------
  1321            C                MOV     A, reg_acc5
  1322            C                JBC     STATUS, C
  1323            C                ADD     A, @1
  1324            C                RLC     reg_acc
  1325            C                ADD     A, reg_acc7
  1326            C                MOV     reg_acc5, A
  1327            C                JBC     STATUS, C
  1328            C                BS      reg_acc, 0
  1329            C                RRC     reg_acc
  1330            C        $Mul23_Rs:
  1331            C                RRC     reg_acc5
  1332            C                RRC     reg_acc4
  1333            C                RRC     reg_acc3
  1334            C                RRC     reg_acc2
  1335            C                RRC     reg_acc1
  1336            C        ;
  1337            C                BC      reg_acc, 7
  1338            C                DJZ     reg_acc
  1339            C                JMP     $Mul23_Loop
  1340            C                ENDM
  1341            C        ;
  1342            C        ;**********************************************************************;
  1343            C        ; Title:          (2 bytes) * (4 bytes) operation                      ;
  1344            C        ; Description:    (reg_acc6, reg_acc5) * (reg_acc4, reg_acc3, reg_acc2 ;
  1345            C        ;                 , reg_acc1) = (reg_acc6, reg_acc5, reg_acc4, reg_acc3;
  1346            C        ;                 , reg_acc2, reg_acc1)                                ;
  1347            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,    ;
  1348            C        ;                 reg_acc6                                             ;
  1349            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5,    ;
  1350            C        ;                 reg_acc6                                             ;
  1351            C        ; Register change:reg_acc, reg_acc7, reg_acc8                          ;
  1352            C        ;**********************************************************************;
  1353            C        ;
  1354            C        mMUL2_4 MACRO   reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1355            C        ;
  1356            C                MOV     A, @32
  1357            C                MOV     reg_acc, A
  1358            C                MOV     A, reg_acc6
  1359            C                MOV     reg_acc8, A
  1360            C                MOV     A, reg_acc5
  1361            C                MOV     reg_acc7, A
  1362            C                CLR     reg_acc5
  1363            C                CLR     reg_acc6
  1364            C        $Mul24_Loop:
  1365            C                BC      STATUS, C
  1366            C                JBS     reg_acc1, 0
  1367            C                JMP     $Mul24_Rs
  1368            C                MOV     A, reg_acc7
  1369            C                ADD     reg_acc5, A
  1370            C        ;--------------------------------------
  1371            C                MOV     A, reg_acc6
  1372            C                JBC     STATUS, C
  1373            C                ADD     A, @1
  1374            C                RLC     reg_acc
  1375            C                ADD     A, reg_acc8
  1376            C                MOV     reg_acc6, A
  1377            C                JBC     STATUS, C
  1378            C                BS      reg_acc, 0
  1379            C                RRC     reg_acc
  1380            C        $Mul24_Rs:
  1381            C                RRC     reg_acc6
  1382            C                RRC     reg_acc5
  1383            C                RRC     reg_acc4
  1384            C                RRC     reg_acc3
  1385            C                RRC     reg_acc2
  1386            C                RRC     reg_acc1
  1387            C        ;
  1388            C                BC      reg_acc, 7
  1389            C                DJZ     reg_acc
  1390            C                JMP     $Mul24_Loop
  1391            C                ENDM
  1392            C        ;
  1393            C        ;**********************************************************************;
  1394            C        ; Title:          (3 bytes) * (3 bytes) operation                      ;
  1395            C        ; Description:    (reg_acc6, reg_acc5, reg_acc4) * (reg_acc3, reg_acc2 ;
  1396            C        ;                 , reg_acc1) = (reg_acc6, reg_acc5, reg_acc4, reg_acc3;
  1397            C        ;                 , reg_acc2, reg_acc1)                                ;
  1398            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1399            C        ;                 , reg_acc6                                           ;
  1400            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1401            C        ;                 , reg_acc6                                           ;
  1402            C        ; Register change:reg_acc, reg_acc7, reg_acc8, reg_acc9                ;
  1403            C        ;**********************************************************************;
  1404            C        ;
  1405            C        mMUL3_3 MACRO   reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1406            C        ;
  1407            C                MOV     A, @24
  1408            C                MOV     reg_acc, A
  1409            C                MOV     A, reg_acc4
  1410            C                MOV     reg_acc7, A
  1411            C                MOV     A, reg_acc5
  1412            C                MOV     reg_acc8, A
  1413            C                MOV     A, reg_acc6
  1414            C                MOV     reg_acc9, A
  1415            C                CLR     reg_acc4
  1416            C                CLR     reg_acc5
  1417            C                CLR     reg_acc6
  1418            C        $Mul33_Loop:
  1419            C                BC      STATUS, C
  1420            C                JBS     reg_acc1, 0
  1421            C                JMP     $Mul33_Rs
  1422            C                MOV     A, reg_acc7
  1423            C                ADD     reg_acc4, A
  1424            C        ;--------------------------------------
  1425            C                MOV     A, reg_acc5
  1426            C                JBC     STATUS, C
  1427            C                ADD     A, @1
  1428            C                RLC     reg_acc
  1429            C                ADD     A, reg_acc8
  1430            C                MOV     reg_acc5, A
  1431            C                JBC     STATUS, C
  1432            C                BS      reg_acc, 0
  1433            C                RRC     reg_acc
  1434            C        ;--------------------------------------
  1435            C                MOV     A, reg_acc6
  1436            C                JBC     STATUS, C
  1437            C                ADD     A, @1
  1438            C                RLC     reg_acc
  1439            C                ADD     A, reg_acc9
  1440            C                MOV     reg_acc6, A
  1441            C                JBC     STATUS, C
  1442            C                BS      reg_acc, 0
  1443            C                RRC     reg_acc
  1444            C        $Mul33_Rs:
  1445            C                RRC     reg_acc6
  1446            C                RRC     reg_acc5
  1447            C                RRC     reg_acc4
  1448            C                RRC     reg_acc3
  1449            C                RRC     reg_acc2
  1450            C                RRC     reg_acc1
  1451            C        ;
  1452            C                BC      reg_acc, 7
  1453            C                DJZ     reg_acc
  1454            C                JMP     $Mul33_Loop
  1455            C                ENDM
  1456            C        ;
  1457            C        ;**********************************************************************;
  1458            C        ; Title:          (3 bytes) * (4 bytes) operation                      ;
  1459            C        ; Description:    (reg_acc7, reg_acc6, reg_acc5) * (reg_acc4, reg_acc3 ;
  1460            C        ;                 , reg_acc2, reg_acc1) = (reg_acc7, reg_acc6, reg_acc5;
  1461            C        ;                 , reg_acc4, reg_acc3, reg_acc2, reg_acc1)            ;
  1462            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1463            C        ;                 , reg_acc6, reg_acc7                                 ;
  1464            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4, reg_acc5     ;
  1465            C        ;                 , reg_acc6, reg_acc7                                 ;
  1466            C        ; Register change:reg_acc, reg_acc8, reg_acc9, reg_acca                ;
  1467            C        ;**********************************************************************;
  1468            C        ;
  1469            C        mMUL3_4 MACRO   reg_acc7, reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1470            C        ;
  1471            C                MOV     A, @32
  1472            C                MOV     reg_acc, A
  1473            C                MOV     A, reg_acc5
  1474            C                MOV     reg_acc8, A
  1475            C                MOV     A, reg_acc6
  1476            C                MOV     reg_acc9, A
  1477            C                MOV     A, reg_acc7
  1478            C                MOV     reg_acca, A
  1479            C                CLR     reg_acc5
  1480            C                CLR     reg_acc6
  1481            C                CLR     reg_acc7
  1482            C        $Mul34_Loop:
  1483            C                BC      STATUS, C
  1484            C                JBS     reg_acc1, 0
  1485            C                JMP     $Mul34_Rs
  1486            C                MOV     A, reg_acc8
  1487            C                ADD     reg_acc5, A
  1488            C        ;--------------------------------------
  1489            C                MOV     A, reg_acc6
  1490            C                JBC     STATUS, C
  1491            C                ADD     A, @1
  1492            C                RLC     reg_acc
  1493            C                ADD     A, reg_acc9
  1494            C                MOV     reg_acc6, A
  1495            C                JBC     STATUS, C
  1496            C                BS      reg_acc, 0
  1497            C                RRC     reg_acc
  1498            C        ;--------------------------------------
  1499            C                MOV     A, reg_acc7
  1500            C                JBC     STATUS, C
  1501            C                ADD     A, @1
  1502            C                RLC     reg_acc
  1503            C                ADD     A, reg_acca
  1504            C                MOV     reg_acc7, A
  1505            C                JBC     STATUS, C
  1506            C                BS      reg_acc, 0
  1507            C                RRC     reg_acc
  1508            C        $Mul34_Rs:
  1509            C                RRC     reg_acc7
  1510            C                RRC     reg_acc6
  1511            C                RRC     reg_acc5
  1512            C                RRC     reg_acc4
  1513            C                RRC     reg_acc3
  1514            C                RRC     reg_acc2
  1515            C                RRC     reg_acc1
  1516            C        ;
  1517            C                BC      reg_acc, 7
  1518            C                DJZ     reg_acc
  1519            C                JMP     $Mul34_Loop
  1520            C                ENDM
  1521            C        ;
  1522            C        ;**********************************************************************;
  1523            C        ; Title:          (4 bytes) * (4 bytes) operation                      ;
  1524            C        ; Description:    (reg_acc8, reg_acc7, reg_acc6, reg_acc5) *           ;
  1525            C        ;                 (reg_acc4, reg_acc3, reg_acc2, reg_acc1)             ;
  1526            C        ;                 = (reg_acc8, reg_acc7, reg_acc6, reg_acc5, reg_acc4  ;
  1527            C        ;                 , reg_acc3, reg_acc2, reg_acc1)                      ;
  1528            C        ; Input:          reg_acc1, reg_acc2, reg_acc3, reg_acc4,              ;
  1529            C        ;                 reg_acc5, reg_acc6, reg_acc7, reg_acc8               ;
  1530            C        ; Output:         reg_acc1, reg_acc2, reg_acc3, reg_acc4,              ;
  1531            C        ;                 reg_acc5, reg_acc6, reg_acc7, reg_acc8               ;
  1532            C        ; Register change:reg_acc, reg_acc9, reg_acca, reg_accb, reg_accc      ;
  1533            C        ;**********************************************************************;
  1534            C        ;
  1535            C        mMUL4_4 MACRO   reg_acc8, reg_acc7, reg_acc6, reg_acc5, reg_acc4, reg_acc3, reg_acc2, reg_acc1
  1536            C        ;
  1537            C                MOV     A, @32
  1538            C                MOV     reg_acc, A
  1539            C                MOV     A, reg_acc5
  1540            C                MOV     reg_acc9, A
  1541            C                MOV     A, reg_acc6
  1542            C                MOV     reg_acca, A
  1543            C                MOV     A, reg_acc7
  1544            C                MOV     reg_accb, A
  1545            C                MOV     A, reg_acc8
  1546            C                MOV     reg_accc, A
  1547            C                CLR     reg_acc5
  1548            C                CLR     reg_acc6
  1549            C                CLR     reg_acc7
  1550            C                CLR     reg_acc8
  1551            C        $Mul44_Loop:
  1552            C                BC      STATUS, C
  1553            C                JBS     reg_acc1, 0
  1554            C                JMP     $Mul44_Rs
  1555            C                MOV     A, reg_acc9
  1556            C                ADD     reg_acc5, A
  1557            C        ;--------------------------------------
  1558            C                MOV     A, reg_acc6
  1559            C                JBC     STATUS, C
  1560            C                ADD     A, @1
  1561            C                RLC     reg_acc
  1562            C                ADD     A, reg_acca
  1563            C                MOV     reg_acc6, A
  1564            C                JBC     STATUS, C
  1565            C                BS      reg_acc, 0
  1566            C                RRC     reg_acc
  1567            C        ;--------------------------------------
  1568            C                MOV     A, reg_acc7
  1569            C                JBC     STATUS, C
  1570            C                ADD     A, @1
  1571            C                RLC     reg_acc
  1572            C                ADD     A, reg_accb
  1573            C                MOV     reg_acc7, A
  1574            C                JBC     STATUS, C
  1575            C                BS      reg_acc, 0
  1576            C                RRC     reg_acc
  1577            C        ;--------------------------------------
  1578            C                MOV     A, reg_acc8
  1579            C                JBC     STATUS, C
  1580            C                ADD     A, @1
  1581            C                RLC     reg_acc
  1582            C                ADD     A, reg_accc
  1583            C                MOV     reg_acc8, A
  1584            C                JBC     STATUS, C
  1585            C                BS      reg_acc, 0
  1586            C                RRC     reg_acc
  1587            C        $Mul44_Rs:
  1588            C                RRC     reg_acc8
  1589            C                RRC     reg_acc7
  1590            C                RRC     reg_acc6
  1591            C                RRC     reg_acc5
  1592            C                RRC     reg_acc4
  1593            C                RRC     reg_acc3
  1594            C                RRC     reg_acc2
  1595            C                RRC     reg_acc1
  1596            C        ;
  1597            C                BC      reg_acc, 7
  1598            C                DJZ     reg_acc
  1599            C                JMP     $Mul44_Loop
  1600            C                ENDM
  1601            C        
  1602            C        
  1603            C        
  1604            C        ;*****************************************************************
  1605            C        ;Function:    generat random data
  1606            C        ;Input:       @banksel,@address,@length
  1607            C        ;Output:      rang by address which is the lowest address
  1608            C        ;description: used common register temp,temp1,temp2 for operation
  1609            C        ;             rand address must be in the same bank
  1610            C        ;             TEMP:  Operate Data TEMP
  1611            C        ;             TEMP1:
  1612            C        ;             TEMP2:
  1613            C        ;*****************************************************************
  1614            C        RAND_FUCTION MACRO @BankSel,Address,@length
  1615            C        	MOV         TEMP,A
  1616            C        	BANK        @BankSel
  1617            C        	MOV         A,Address
  1618            C        	ADD         TEMP,A        ; save latest data as current seed
  1619            C        
  1620            C        	CLR         RSR
  1621            C        $_RAND_SEED_LOOP1:
  1622            C        	MOV         A,R0
  1623            C        	ADD         TEMP,A        ; seed
  1624            C        
  1625            C        	RLC         TEMP          ; x*y+1 MOD z
  1626            C        	RLC         TEMP
  1627            C        	RLC         TEMP
  1628            C        	INC         TEMP
  1629            C        	RRC         TEMP
  1630            C        	RRC         TEMP
  1631            C        	RRC         TEMP
  1632            C        	JBS         STATUS,C
  1633            C        	BC          TEMP,0
  1634            C        	JBC         STATUS,C
  1635            C        	BS          TEMP,0
  1636            C        
  1637            C        	INC         RSR
  1638            C        	MOV         A,RSR
  1639            C        	AND         A,@0X40         ; adding form 0x00 to bank 0
  1640            C        	XOR         A,@0X40
  1641            C        	JBS         STATUS,Z
  1642            C        	JMP         $_RAND_SEED_LOOP1
  1643            C        	MOV         A,R0
  1644            C        	ADD         TEMP,A          ;next seed
  1645            C        
  1646            C        	MOV         A,@length
  1647            C        	MOV         TEMP1,A
  1648            C        	MOV         A,@Address
  1649            C        	MOV         TEMP2,A
  1650            C        	MOV         RSR,A
  1651            C        	BANK        @BankSel
  1652            C        	MOV         A,RSR
  1653            C        	MOV         TEMP2,A       ; save address base
  1654            C        	MESSAGE     "adding form 0x00 to bank 0"
  1655            C        
  1656            C        $_RAND_DATA_LOOP1:
  1657            C        	MOV         A,TEMP2
  1658            C        	MOV         RSR,A
  1659            C        	MOV         A,TEMP
  1660            C        	MOV         R0,A
  1661            C        
  1662            C        	RLC         TEMP          ; X*Y+1 MOD Z
  1663            C        	RLC         TEMP
  1664            C        	RLC         TEMP
  1665            C        	INC         TEMP
  1666            C        	RRC         TEMP
  1667            C        	RRC         TEMP
  1668            C        	RRC         TEMP
  1669            C        	JBS         STATUS,C
  1670            C        	BC          TEMP,0
  1671            C        	JBC         STATUS,C
  1672            C        	BS          TEMP,0
  1673            C        
  1674            C        	INC         TEMP2
  1675            C        	DJZ         TEMP1
  1676            C        	JMP         $_RAND_DATA_LOOP1:
  1677            C        	NOP
  1678            C        
  1679            C        ENDM
  1680            C        
    16                     include "config.h"
     1            C        /*****************************************************************
     2            C        ; Filename     :  EM78M611rxP40M1v6V10 config
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        *****************************************************************/
    11            C        ;-------------------------------------------------------------------------
    12            C        config.h    EQU    config.h
    13            C        
    14            C        ;-------------------------------------------------------------------------
    15            C        
    16       0000 C        USED_PID_FUNCTION               EQU     0     ; 1:used this function; 0:not used
    17       0001 C        TotalGamePads                   EQU     1
    18       0020 C        DataBufferBase                  EQU     0x20  ; Address:0x20 ,bit6:select all bank
    19       0004 C        ComuSyncTime                    EQU     4     ; 4ms sync header time
    20       0004 C        ComuTime                        EQU     4     ; 4ms Communicte System
    21       0000 C        RetryCNT                        EQU     0X00  ; transmit 0 Times Retry
    22       009D C        RX_IDH_DEFAULT                  EQU     0X9D
    23       00BC C        RX_IDL_DEFAULT                  EQU     0XBC  ; Adress_default =  [RX_IDH_DEFAULT,RX_IDL_DEFAULT&0x0f]
    24       00C8 C        RX_ComuLoseCNT_Default          EQU     200   ; T=ComuTime+ComuSyncTime*RX_ComuLoseCNT_Default
    25            C        
    26            C        
    27            C        
    28       0005 C        RX1_LossframeSum                EQU     5
    29       0001 C        RX2_LossframeSum                EQU     1
    30       0001 C        RX3_LossframeSum                EQU     1
    31       0001 C        RX4_LossframeSum                EQU     1
    32       0001 C        RX5_LossframeSum                EQU     1
    33       0001 C        RX6_LossframeSum                EQU     1
    34            C        
    35            C        
    36            C        
    37            C        
    17                     include "M611rxP40.H"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;  Description: PAGE0(0X0000-0X03FF): EM78M611 initial / EEprom setting / SYNC_COM_TX
    11            C        ;               PAGE1(0X0400-0X07FF): RX1_FUNCTION / RX2_FUNCTION / RX3_FUNCTION / RX4_FUNCTION
    12            C        ;               PAGE2(0X0800-0X0BFF): RX5_FUNCTION / RX6_FUNCTION / RX7_FUNCTION / RX8_FUNCTION
    13            C        ;               PAGE3(0X0C00-0X0FFF): Communicate_USB_Function table
    14            C        ;               PAGE4(0X1000-0X13FF): Communicate_USB_Function Function
    15            C        ;               PAGE5(0X1400-0X17FF): RF initial function
    16            C        
    17            C        ;==================================================================
    18            C        M611rxP40.H                     EQU     M611rxP40.H
    19            C        
    20       0000 C        RX1                             EQU     0     ; CHN_FLAG[0]
    21       0001 C        RX2                             EQU     1     ; CHN_FLAG[1]
    22       0002 C        RX3                             EQU     2 
    23       0003 C        RX4                             EQU     3
    24       0004 C        RX5                             EQU     4
    25       0005 C        RX6                             EQU     5     ; CHN_FLAG[5]
    26            C        
    27            C        ;==================================================================
    28       0010 C        TEMP                            EQU     0X10        ; used for rock-bottom RF initial
    29       0011 C        TEMP1                           EQU     0X11        ; used for rock-bottom RF initial
    30       0012 C        TEMP2                           EQU     0X12        ; used for rock-bottom RF initial
    31       0013 C        TEMP3                           EQU     0X13        ; used for rock-bottom RF initial
    32       0014 C        TEMP4                           EQU     0X14        ; used for rock-bottom RF initial
    33       0015 C        TEMP5                           EQU     0X15        ;
    34       0016 C        TEMP6                           EQU     0X16        ;
    35            C        
    36       0017 C        SystemTimeCNT                   EQU     0X17
    37       0018 C        TABLE_INDEX                     EQU     0x18        ; descriptor table's start position
    38       0019 C        DataShiftCounter                EQU     0X19        ; data counter
    39       001A C        DataByteLength                  EQU     0X1A		; READ/WRITE DATA LENGTH
    40       001B C        ComuClock                       EQU     0X1B        ; Communication clock
    41            C        
    42       001C C        TRANSFER                        EQU     0X1C		     ;
    43       01C0 C        	JudgeHandFlag1              ==      TRANSFER*16+0    ; judge which hand send to host,BYTE0
    44       01C1 C        	JudgeHandFlag2              ==      TRANSFER*16+1    ; judge which hand send to host,BYTE1
    45       01C2 C        	JudgeHandFlag3              ==      TRANSFER*16+2    ; judge which hand send to host,BYTE2
    46       01C3 C        	SetupDataStageFlag          ==      TRANSFER*16+3    ; select HID table 1
    47       01C4 C        	TableSelectFlag1            ==      TRANSFER*16+4    ; select HID table 1
    48       01C5 C        	TableSelectFlag2            ==      TRANSFER*16+5    ; select HID table 2
    49       01C6 C        	TableSelectFlag3            ==      TRANSFER*16+6    ; select HID table 3
    50       01C7 C        	UsbEP0interruptflag         ==      TRANSFER*16+7	
    51            C        
    52       001D C        GeneralStatusFlag1              EQU     0X1D
    53       01D7 C        	RFInitialFailFlag           ==      GeneralStatusFlag1*16+7 ; 
    54       01D6 C        	RFInitialOKFlag             ==      GeneralStatusFlag1*16+6
    55       01D5 C        	RFTestFailFlag              ==      GeneralStatusFlag1*16+5
    56       01D0 C        	ModeSelectFlag              ==      GeneralStatusFlag1*16+0 ;1:analog  0:digital(default 0)
    57            C        
    58            C        
    59       001F C        GeneralStatusFlag               EQU     0X1F
    60       01F7 C        	ReadLengthError             ==      GeneralStatusFlag*16+7
    61       01F6 C        	KeyScanStatusFlag           ==      GeneralStatusFlag*16+6	
    62       01F5 C        	KeyStatusFlag               ==      GeneralStatusFlag*16+5	
    63       01F4 C        	KeyScanFinishFlag           ==      GeneralStatusFlag*16+4
    64            C        	
    65       01F0 C        	FRAMER_CONFIG_ERROR         ==      GeneralStatusFlag*16+0 ; Framer Compare Bit Error Flag
    66       01F0 C        	RECEIVE_ERROR               ==      GeneralStatusFlag*16+0 ; Judge Receive Register 64 Error Flag
    67            C        
    68       001E C        CommuStatusFlag                 EQU     0X1E
    69            C        ;SearchStatusFlag,NormalStatusFlag,LoseFreqStatusFlag,LoseFrameStatusFlag is used for working status
    70            C        ;LinkModeFlag,ForceLinkModeFlag,FccTestModeFlag is used for check master ID and FCC test
    71       01E7 C        	DescriptorFinishFlag        ==      CommuStatusFlag*16+7   ; DESCRIPTOR FINISH(1) OR NOT(USB)
    72       01E6 C        	FccTestModeFlag             ==      CommuStatusFlag*16+6
    73       01E5 C        	ForceLinkModeFlag           ==      CommuStatusFlag*16+5   ; force link flag
    74       01E4 C        	LinkModeFlag                ==      CommuStatusFlag*16+4   ; link flag
    75       01E3 C        	EEpromWRStatusFlag          ==      CommuStatusFlag*16+3
    76       01E2 C        	LoseFrameStatusFlag         ==      CommuStatusFlag*16+2   ; lose frequency and search mode flag
    77       01E1 C        	NormalStatusFlag            ==      CommuStatusFlag*16+1   ; Normal mode Flag
    78       01E0 C        	SearchStatusFlag            ==      CommuStatusFlag*16+0   ; Search mode flag
    79            C        
    80            C        
    81            C        ;-----------------------------------------------------------------------
    82       0010 C        SPIWB                           EQU     TEMP     ; SPI WRITE BYTE VALUE
    83       0010 C        SPIRB                           EQU     TEMP
    84       0011 C        r_acc1                          EQU     TEMP1    ; TEMP1 - TEMP5 used for EEPROM
    85       0012 C        r_acc2                          EQU     TEMP2
    86       0013 C        r_acc3                          EQU     TEMP3
    87       0014 C        DataAddressInMCU                EQU     TEMP4    ; 93C46
    88       0015 C        DataAddressInEEPROM             EQU     TEMP5
    89            C        
    90       0013 C        CMD_SELECT                      EQU     TEMP3
    91       0014 C        A_TEMP                          EQU     TEMP4    ; TEMP4 - TEMP6 used for PUSH and POP
    92       0015 C        RSR_TEMP                        EQU     TEMP5
    93       0016 C        STATUS_TEMP                     EQU     TEMP6
    94            C        
    95            C        
    96            C        ;==============================I/O Port Define==========================
    97       0060 C        SPI_MISO                        ==      PORT6*16+0   ;0
    98       0061 C        RESET_N                         ==      PORT6*16+1	;1
    99       0062 C        SPI_CLK                         ==      PORT6*16+2   ;2
   100       0063 C        SPI_MOSI                        ==      PORT6*16+3   ;3
   101       0064 C        SPI_SS                          ==      PORT6*16+4   ;4
   102       0065 C        FIFO_FLAG                       ==      PORT6*16+5   ;5
   103       0066 C        PKT_FLAG                        ==      PORT6*16+6   ;6
   104            C        
   105       0054 C        IIC_SCL                         ==      Port5*16+4
   106       0055 C        IIC_Sda                         ==      Port5*16+5
   107       0056 C        AT93C46_CS                      ==      Port5*16+6 ;4  93c46 enable select
   108            C        
   109       0092 C        Keystoke                        ==      Port9*16+2
   110       0093 C        LED1_STATUS                     ==      PORT9*16+3 ;LED
   111            C        
   112            C        
   113            C        ;============================================== BANK 0 ============================================
   114            C        ; bank0 20-3f used for data exchange section[Data Buffer]
   115            C        ; such as read or write EEPROM and RF,it used for data buffer
   116            C        ; sync timing:             RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrl,CH_NO,TX1_ID,TX2_ID,TX3_ID,TX4_ID,TX5_ID,TX6_ID
   117            C        ; responses answer timing: RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrl,CH_NO,TXx_ID
   118            C        ; responses data timing:   RX_IDH,RX_IDL,CHN_FLAG,CommuStatusFlag,DirectionCtrlO.)
   119            C        
   120            C        ;------------------------ used for RF communicate --------------------
   121       0020 C        PID_DATA_Buffer         EQU     0X20    ; PID DATARX_IDH_Buffer           EQU     0X20    ; master ID
   122       0021 C        RX_IDH_Buffer           EQU     0X21    ; master ID
   123       0022 C        RX_IDL_Buffer           EQU     0X22
   124       0023 C        CHN_FLAG_Buffer         EQU     0X23    ; Channel flag, gamepad status
   125       0024 C        CommuStatusFlag_Buffer  EQU     0X24
   126       0025 C        DirectionCtrl_Buffer    EQU     0X25    ; Communication trsmitter direction
   127       0026 C        N_CHN_Buffer            EQU     0X26    ; N_CHN= ((TotalGamepads<<4) & 0xF0)|(CH_NO & 0x0F)
   128       0026 C        TX_ID_Buffer            EQU     0X26    ; repeat package data
   129            C        
   130       0027 C        TX1_ID_Buffer           EQU     0X27     ;
   131       0028 C        TX2_ID_Buffer           EQU     0X28     ;
   132       0029 C        TX3_ID_Buffer           EQU     0X29     ;
   133       002A C        TX4_ID_Buffer           EQU     0X2A     ;
   134       002B C        TX5_ID_Buffer           EQU     0X2B     ;
   135       002C C        TX6_ID_Buffer           EQU     0X2C     ;
   136            C        
   137            C        ;--------------------------------------------------------
   138       0027 C        DataA_Buffer            EQU     0X27 ;rocker, left-x(left-right) data
   139       0028 C        DataB_Buffer            EQU     0X28 ;rocker, left-y(up-down) data
   140       0029 C        DataC_Buffer            EQU     0X29 ;rocker, right-x(left-right) data
   141       002A C        DataD_Buffer            EQU     0X2A ;rocker, right-y(up-down) data
   142       002B C        DataE_Buffer            EQU     0X2B ;A,B,C,D,L1,R1,L2,R2
   143       002C C        DataF_Buffer            EQU     0X2C ;Select,start,LSW,RSW,MODE,MACRO,TEST1,TEST2
   144       002D C        DataG_Buffer            EQU     0X2D ;000:45’ 001:90’ 010:135’ 011:180’ 100:225’ 101:270’ 110:315’
   145            C        
   146            C        ;--------------------------------------------------------
   147       0030 C        GS_XPoint_LOW_Buffer    EQU     0X30
   148       0031 C        GS_YPoint_LOW_Buffer    EQU     0X31
   149       0032 C        GS_ZPoint_LOW_Buffer    EQU     0X32
   150       0033 C        GS_Point_HIGH_Buffer    EQU     0X33
   151       0034 C        CMOS_XPoint_LOW_Buffer  EQU     0X34
   152       0035 C        CMOS_YPoint_LOW_Buffer  EQU     0X35
   153       0036 C        CMOS_Point_HIGH_Buffer  EQU     0X36
   154            C        
   155       0039 C        GS_XPoint_LOW           EQU     0X39
   156       003A C        GS_YPoint_LOW           EQU     0X3A
   157       003B C        GS_ZPoint_LOW           EQU     0X3B
   158       003C C        GS_Point_HIGH           EQU     0X3C
   159       003D C        CMOS_XPoint_LOW         EQU     0X3D
   160       003E C        CMOS_YPoint_LOW         EQU     0X3E
   161       003F C        CMOS_Point_HIGH         EQU     0X3F
   162            C        
   163            C        ;----------------------- used for USB Command ----------------------------
   164       0020 C        BYTE0                   EQU     0X20
   165       0021 C        BYTE1                   EQU     0X21
   166       0022 C        BYTE2                   EQU     0X22
   167       0023 C        BYTE3                   EQU     0X23
   168       0024 C        BYTE4                   EQU     0X24
   169       0025 C        BYTE5                   EQU     0X25
   170       0026 C        BYTE6                   EQU     0X26
   171       0027 C        BYTE7                   EQU     0X27
   172            C        
   173            C        
   174       0039 C        PROTOCOL_TEMP           EQU     0X39                ; BYTE 2 , (0)Boot Protocol,(1)Report Protocol
   175       003A C        IDLE_TEMP               EQU     0X3A                ; BYTE 3
   176       003B C        PC_WANT0                EQU     0X3B                ; BYTE 6
   177       003C C        PC_WANT1                EQU     0X3C                ; BYTE 7
   178            C        
   179       003D C        DataMaxTable1           EQU     0X3D                ; descriptor table's data length (table 1)
   180       003E C        DataMaxTable2           EQU     0X3E                ; descriptor table's data length (table 2)
   181       003F C        DataMaxTable3           EQU     0X3F                ; descriptor table's data length (table 3)
   182            C        
   183            C        ;============================================== BANK 1 ============================================
   184       0020 C        PID_DATA                EQU     0X20    ; PID DATA
   185       0021 C        RX_IDH                  EQU     0X21    ; master ID
   186       0022 C        RX_IDL                  EQU     0X22
   187       0023 C        CHN_FLAG                EQU     0X23    ; Channel flag, gamepad status
   188       0024 C        DirectionCtrl           EQU     0X24    ; Communication trsmitter direction
   189       0025 C        N_CHN                   EQU     0X25    ; N_CHN= ((TotalGamepads<<4) & 0xF0)|(CH_NO & 0x0F)
   190       0026 C        TX_ID                   EQU     0X26     ;
   191       0027 C        TX1_ID                  EQU     0X27     ;
   192       0028 C        TX2_ID                  EQU     0X28     ;
   193       0029 C        TX3_ID                  EQU     0X29     ;
   194       002A C        TX4_ID                  EQU     0X2A     ;
   195       002B C        TX5_ID                  EQU     0X2B     ;
   196       002C C        TX6_ID                  EQU     0X2C     ;
   197            C        
   198       002E C        CHN_FLAG_TEMP           EQU     0X2E
   199       002F C        FccFreqIndex            EQU     0X2F
   200            C        ;----------------------------------------------------------------------
   201       0030 C        ADDR                    EQU     0X30 ;OUTPUT DATA ADDRESS
   202       0031 C        VALUE                   EQU     0X31 ;OUTPUT DATA HIGH
   203       0032 C        CH_NO                   EQU     0X32
   204            C        
   205       0033 C        RF_RSSI                 EQU     0X33
   206       0034 C        KeystokeFlag_Befor      EQU     0X34 ;       Click                     Dblclick                    Lasting_Press
   207       0035 C        KeySystemTimeCNT        EQU     0X35 ; 
   208       0036 C        KeystokeTimeCNT         EQU     0X36
   209            C                                             ;________    _______.__________    ______    _______.___________         ____________
   210            C                                             ;        |__|                  |__|      |__|                   |_______|
   211       0037 C        KEY_NUM                 EQU     0X37
   212            C                                             ;___________                       _________                             ____________
   213            C                                             ;           |_______._____________|         |________.__________________|
   214       0038 C        RX_ComuLoseCNT          EQU     0X38
   215       0039 C        RX1_LossframeCNT        EQU     0X39
   216       003A C        RX2_LossframeCNT        EQU     0X3A
   217       003B C        RX3_LossframeCNT        EQU     0X3B
   218       003C C        RX4_LossframeCNT        EQU     0X3C
   219       003D C        RX5_LossframeCNT        EQU     0X3D
   220       003E C        RX6_LossframeCNT        EQU     0X3E
   221            C        
   222            C        
   223            C        
   224            C        ;============================================== BANK 2 ============================================
   225       0020 C        TX1_DATA1               EQU     0X20
   226       0021 C        TX1_DATA2               EQU     0X21
   227       0022 C        TX1_DATA3               EQU     0X22
   228       0023 C        TX1_DATA4               EQU     0X23
   229       0024 C        TX1_DATA5               EQU     0X24
   230       0025 C        TX1_DATA6               EQU     0X25
   231       0026 C        TX1_DATA7               EQU     0X26
   232       0027 C        TX1_DATA8               EQU     0X27
   233            C        ;------------------------------------------------------------
   234       0028 C        TX2_DATA1               EQU     0X28    ; sensor x-axis
   235       0029 C        TX2_Data2               EQU     0X29
   236       002A C        TX2_DATA3               EQU     0X2A    ; sensor y-axis
   237       002B C        TX2_DATA4               EQU     0X2B
   238       002C C        TX2_DATA5               EQU     0X2C    ; sensor z-axis
   239       002D C        TX2_DATA6               EQU     0X2D
   240       002E C        TX2_DATA7               EQU     0X2E
   241       002F C        TX2_DATA8               EQU     0X2F
   242            C        ;------------------------------------------------------------
   243       0030 C        TX3_DATA1               EQU     0X30
   244       0031 C        TX3_DATA2               EQU     0X31
   245       0032 C        TX3_DATA3               EQU     0X32
   246       0033 C        TX3_DATA4               EQU     0X33
   247       0034 C        TX3_DATA5               EQU     0X34
   248       0035 C        TX3_DATA6               EQU     0X35
   249       0036 C        TX3_DATA7               EQU     0X36
   250       0037 C        TX3_DATA8               EQU     0X37
   251            C        ;------------------------------------------------------------
   252       0038 C        TX4_DATA1               EQU     0X38    ; sensor x-axis
   253       0039 C        TX4_DATA2               EQU     0X39
   254       003A C        TX4_DATA3               EQU     0X3A    ; sensor y-axis
   255       003B C        TX4_DATA4               EQU     0X3B
   256       003C C        TX4_DATA5               EQU     0X3C    ; sensor z-axis
   257       003D C        TX4_DATA6               EQU     0X3D
   258       003E C        TX4_DATA7               EQU     0X3E
   259       003F C        TX4_DATA8               EQU     0X3F
   260            C        
   261            C        ;============================================== BANK 3 ============================================
   262       0020 C        TX5_DATA1               EQU     0X20
   263       0021 C        TX5_DATA2               EQU     0X21
   264       0022 C        TX5_DATA3               EQU     0X22
   265       0023 C        TX5_DATA4               EQU     0X23
   266       0024 C        TX5_DATA5               EQU     0X24
   267       0025 C        TX5_DATA6               EQU     0X25
   268       0026 C        TX5_DATA7               EQU     0X26
   269       0027 C        TX5_DATA8               EQU     0X27
   270            C        ;------------------------------------------------------------
   271       0028 C        TX6_DATA1               EQU     0X28    ; sensor x-axis
   272       0029 C        TX6_DATA2               EQU     0X29
   273       002A C        TX6_DATA3               EQU     0X2A    ; sensor y-axis
   274       002B C        TX6_DATA4               EQU     0X2B
   275       002C C        TX6_DATA5               EQU     0X2C    ; sensor z-axis   ;flash byte 1
   276       002D C        TX6_DATA6               EQU     0X2D                      ;flash byte 2
   277       002E C        TX6_DATA7               EQU     0X2E                      ;flash byte 3
   278       002F C        TX6_DATA8               EQU     0X2F                      ;flash byte 4
   279            C        ;--------------------------------------------------------
   280       0030 C        TX7_DATA1               EQU     0X30
   281       0031 C        TX7_DATA2               EQU     0X31
   282       0032 C        TX7_DATA3               EQU     0X32
   283       0033 C        TX7_DATA4               EQU     0X33
   284       0034 C        TX7_DATA5               EQU	    0X34
   285       0035 C        TX7_DATA6               EQU     0X35
   286       0026 C        TX7_DATA7               EQU     0X26
   287       0037 C        TX7_DATA8               EQU     0X37
   288            C        ;------------------------------------------------------------
   289       0038 C        TX8_DATA1               EQU     0X38    ; sensor x-axis
   290       0039 C        TX8_DATA2               EQU     0X39
   291       003A C        TX8_DATA3               EQU     0X3A    ; sensor y-axis
   292       003B C        TX8_DATA4               EQU     0X3B
   293       003C C        TX8_DATA5               EQU	    0X3C    ; sensor z-axis
   294       003D C        TX8_DATA6               EQU     0X3D
   295       002E C        TX8_DATA7               EQU     0X2E
   296       003F C        TX8_DATA8               EQU     0X3F
   297            C        
    18                     include "EM198850_For_EM78M611.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;===================================================================
    11            C        
    12            C        include	"EM198850_For_EM78M611.H"
     1            C        /*****************************************************************
     2            C        * Filename     :  EM78M611dev.ASM
     3            C        * Author       :  yu.wei
     4            C        * Company      :  ELAN
     5            C        * VERSION      :  1.0
     6            C        * CRYSTAL	   :  6MHZ
     7            C        * Creat date   :  2009/9/11
     8            C        * tool ver.    :  WicePlus 2.7
     9            C        * Description  :  modify for code conformity
    10            C        *****************************************************************/
    11            C        
    12            C        ;--------------------------------------------------------------------------
    13       0052 C        FIFO_PTR                EQU     82          ;FIFO POINTER CONTROL=REG 82
    14       0080 C        CLR_W_PTR               EQU     0X80        ;CLR POINTER MARK VALUE
    15       0050 C        FIFO_REG                EQU     80          ;FIFO POINTER=REG 80
    16       0080 C        READ_MASK               EQU     0X80        ;READ REG,MSB SET TO 1
    17       0080 C        RX_MASK                 EQU     0X80        ;ENABLE RX
    18            C        
    19       0020 C        PKT_LEN                 EQU     0X20        ;DataByteLength = 32
    20       0000 C        TXADDRL                 EQU     0X00
    21       0011 C        TXADDRH                 EQU     0X11
    22       0020 C        RX_BUF                  EQU     0B00100000  ;0x20(bank 0)
    23       0020 C        TX_BUF                  EQU     0B00100000  ;0x20(bank 0)
    24       0020 C        NoiseStrobe             EQU     0X20        ;dirty:0x08-0x0A, neatness:0x28-0x2A
    25       004C C        ChannelSum              EQU     76
    26            C        
    27            C        
    28            C        
    29            C        
    30            C        ;==================================================================
    31            C        
    13            C        
    14            C        	ORG                 0X1400    ;PAGE 5
    15            C        	MESSAGE "define 'EM198850_For_EM78M611.ASM' ROM address"
***     USER MESSAGE: DEFINE 'EM198850_FOR_EM78M611.ASM' ROM ADDRESS
    16            C        ;**************************************************
    17            C        ;LOOKUP TABLE
    18            C        ;Famer Register initial value(Reg48~57)
    19            C        ;**************************************************
    20 01400      C        FRAME_TABLE:
    21 01400 03C2 C        	ADD                 PC,A
    22 01401 1C4E C        	RETL                @0X4E		;1		01---16M
    23 01402 1C02 C        	RETL                @0X02		;2		10---24M
    24            C        
    25 01403 1C4D C        	RETL                @0X4D		;3		RESET FIFO
    26 01404 1C01 C        	RETL                @0X01		;4
    27            C        
    28 01405 1C42 C        	RETL                @0X42		;5		24M/1MBPS
    29 01406 1C98 C        	RETL                @0X98		;6
    30            C        
    31 01407 1C43 C        	RETL                @0X43		;7
    32 01408 1CC8 C        	RETL                @0XC8 		;8		;8		;default:C4  Set sync word length，CRC count
    33            C        
    34 01409 1C44 C        	RETL                @0X44		;9		PKT_LEN
    35 0140A 1C20 C        	RETL                @PKT_LEN	;10		24 DATA
    36            C        
    37 0140B 1C45 C        	RETL                @0X45		;11		PKTCNT
    38 0140C 1C10 C        	RETL                @0X10		;12		1 packet
    39            C        
    40 0140D 1C46 C        	RETL                @0X46		;13		BIT3~5	TX AMPLIFIER DELAY 10+5X
    41 0140E 1C09 C        	RETL                @0X09		;14		BIT0~2	PLL DELAY 120+20X
    42            C        
    43 0140F 1C47 C        	RETL                @0X47		;15		BIT4~7  RETRY CNT
    44 01410 1C01 C        	RETL                @0X01		;16		BIT0~3	Slot TIME UNIT 10US
    45            C        
    46 01411 1C48 C        	RETL                @0X48		;17		Slot
    47 01412 1C01 C        	RETL                @0X01		;18
    48            C        
    49 01413 1C49 C        	RETL                @0X49		;19		ACKTOSLOT
    50 01414 1C14 C        	RETL                @0X14 		;20     default: 0X8A
    51            C        
    52 01415 1C4A C        	RETL                @0X4A		;21		RSSITH
    53 01416 1C27 C        	RETL                @0X27		;22
    54            C        
    55 01417 1C4B C        	RETL                @0X4B		;23		RF_RSSI
    56 01418 1C00 C        	RETL                @0X00		;24
    57            C        
    58 01419 1C4C C        	RETL                @0X4C		;25		TD_PLL	IN UNIT 10US
    59 0141A 1C06 C        	RETL                @0X06		;26
    60            C        
    61 0141B 1C50 C        	RETL                @0X50		;27		TXADDR
    62 0141C 1C00 C        	RETL                @TXADDRL	;28
    63            C        
    64 0141D 1C51 C        	RETL                @0X51		;29		TX ADDR
    65 0141E 1C11 C        	RETL                @TXADDRH	;30
    66            C        
    67 0141F 1C52 C        	RETL                @0X52		;31		RX	ADDR1
    68 01420 1C22 C        	RETL                @0X22		;32
    69            C        
    70 01421 1C53 C        	RETL                @0X53		;33		RX	ADDR2
    71 01422 1C33 C        	RETL                @0X33		;34
    72            C        
    73 01423 1C54 C        	RETL                @0X54		;35		RX	ADDR3
    74 01424 1C44 C        	RETL                @0X44		;36
    75            C        
    76 01425 1C55 C        	RETL                @0X55		;37		RX	ADDR4
    77 01426 1C55 C        	RETL                @0X55		;38
    78            C        
    79 01427 1C56 C        	RETL                @0X56		;39		RX	ADDR5
    80 01428 1C66 C        	RETL                @0X66		;40
    81            C        
    82 01429 1C57 C        	RETL                @0X57		;41		RX	ADDR6
    83 0142A 1C77 C        	RETL                @0X77		;42
    84            C        
    85 0142B 1C58 C        	RETL                @0X58		;43
    86 0142C 1C08 C        	RETL                @0X08		;44
    87            C        
    88            C        ;-----------------------------------------------------------
    89 0142D 1C00 C        	RETL                @0X00		;45
    90 0142E 1CE5 C        	RETL                @0XE5		;46
    91            C        
    92 0142F 1C01 C        	RETL                @0X01		;47
    93 01430 1C84 C        	RETL                @0X84		;48
    94            C        
    95 01431 1C02 C        	RETL                @0X02		;49
    96 01432 1C00 C        	RETL                @0X00		;50		CHANNEL
    97            C        
    98 01433 1C03 C        	RETL                @0X03		;51
    99 01434 1CC6 C        	RETL                @0XC6		;52
   100            C        
   101 01435 1C04 C        	RETL                @0X04		;53
   102 01436 1C00 C        	RETL                @0X00		;54
   103            C        
   104 01437 1C05 C        	RETL                @0X05		;55
   105 01438 1C40 C        	RETL                @0X40		;56
   106            C        
   107 01439 1C06 C        	RETL                @0X06		;57
   108 0143A 1C5D C        	RETL                @0X5D		;58
   109            C        
   110 0143B 1C07 C        	RETL                @0X07		;59
   111 0143C 1C18 C        	RETL                @0X18		;60
   112            C        
   113 0143D 1C08 C        	RETL                @0X08		;61
   114 0143E 1C40 C        	RETL                @0X40		;62
   115            C        
   116 0143F 1C09 C        	RETL                @0X09		;63
   117 01440 1C18 C        	RETL                @0X18		;64
   118            C        
   119 01441 1C0A C        	RETL                @0X0A		;65
   120 01442 1C47 C        	RETL                @0X47		;66
   121            C        
   122 01443 1C0B C        	RETL                @0X0B		;67
   123 01444 1C0B C        	RETL                @0X0B		;68
   124            C        
   125 01445 1C0C C        	RETL                @0X0C		;69
   126 01446 1CE0 C        	RETL                @0XE0		;70
   127            C        
   128 01447 1C0D C        	RETL                @0X0D		;71
   129 01448 1C4F C        	RETL                @0X4F		;72
   130            C        
   131 01449 1C0E C        	RETL                @0X0E		;73
   132 0144A 1C11 C        	RETL                @0X11		;74
   133            C        
   134 0144B 1C0F C        	RETL                @0X0F		;75
   135 0144C 1C1C C        	RETL                @0X1C		;76
   136            C        
   137 0144D 1C20 C        	RETL                @0X20		;77
   138 0144E 1CAD C        	RETL                @0XAD		;78
   139            C        
   140 0144F 1C21 C        	RETL                @0X21		;79
   141 01450 1C64 C        	RETL                @0X64		;80
   142            C        
   143 01451 1C22 C        	RETL                @0X22		;81
   144 01452 1C00 C        	RETL                @0X00		;82
   145            C        
   146 01453 1C23 C        	RETL                @0X23		;83
   147 01454 1CC3 C        	RETL                @0XC3		;84
   148            C        
   149 01455 1C24 C        	RETL                @0X24		;85
   150 01456 1CBD C        	RETL                @0XBD		;86
   151            C        
   152 01457 1C25 C        	RETL                @0X25		;87
   153 01458 1CA2 C        	RETL                @0XA2		;88
   154            C        
   155 01459 1C26 C        	RETL                @0X26		;89
   156 0145A 1C1A C        	RETL                @0X1A		;90
   157            C        
   158 0145B 1C27 C        	RETL                @0X27		;91
   159 0145C 1C09 C        	RETL                @0X09		;92
   160            C        
   161 0145D 1C28 C        	RETL                @0X28		;93
   162 0145E 1C00 C        	RETL                @0X00		;94
   163            C        
   164 0145F 1C29 C        	RETL                @0X29		;95
   165 01460 1CB8 C        	RETL                @0XB8		;96
   166            C        
   167 01461 1C2A C        	RETL                @0X2A		;97
   168 01462 1C71 C        	RETL                @0X71		;98
   169            C        
   170 01463 1C2B C        	RETL                @0X2B		;99
   171 01464 1C06 C        	RETL                @0X06		;100
   172            C        
   173 01465 1C2C C        	RETL                @0X2C		;101
   174 01466 1C80 C        	RETL                @0X80		;102
   175            C        
   176 01467 1C2D C        	RETL                @0X2D		;103
   177 01468 1C1A C        	RETL                @0X1A		;104
   178            C        
   179 01469 1C2E C        	RETL                @0X2E		;105
   180 0146A 1C09 C        	RETL                @0X09;03		;106
   181            C        
   182 0146B 1C2F C        	RETL                @0X2F		;107
   183 0146C 1C64 C        	RETL                @0X64		;108
   184            C        
   185 0146D 1C30 C        	RETL                @0X30		;109
   186 0146E 1CC0 C        	RETL                @0XC0		;110
   187            C        
   188 0146F 1C31 C        	RETL                @0X31		;111
   189 01470 1C00 C        	RETL                @0X00		;112
   190            C        
   191 01471 1C32 C        	RETL                @0X32		;113
   192 01472 1C40 C        	RETL                @0X40		;114
   193            C        
   194 01473 1C33 C        	RETL                @0X33		;115
   195 01474 1C3B C        	RETL                @0X3B		;116
   196            C        
   197 01475 1C00 C        	RETL                @0X00		;117
   198 01476 1CA7 C        	RETL                @0XA7		;118
   199            C        
   200 01477 1C32 C        	RETL                @0X32		;119
   201 01478 1C4A C        	RETL                @0X4A		;120
   202            C        
   203 01479 1C00 C        	RETL                @0X00		;121
   204 0147A 1CE5 C        	RETL                @0XE5		;122
   205            C        
   206 0147B 1C0E C        	RETL                @0X0E		;123
   207 0147C 1C91 C        	RETL                @0X91		;124
   208            C        
   209 0147D 1C40 C        	RETL                @0X40		;125
   210 0147E 1C51 C        	RETL                @0X51		;126
   211            C        
   212 0147F 1C41 C        	RETL                @0X41		;127
   213 01480 1CBF C        	RETL                @0XBF		;128
   214            C        
   215 01481 1C0C C        	RETL                @0X0C		;129
   216 01482 1CC0 C        	RETL                @0XC0		;130
   217            C        
   218 01483 1C02 C        	RETL                @0X02		;131
   219 01484 1C80 C        	RETL                @0X80		;132
   220            C        
   221 01485 1C04 C        	RETL                @0X04		;133
   222 01486 1C4A C        	RETL                @0X4A		;134
   223            C        
   224 01487 1C05 C        	RETL                @0X05		;135
   225 01488 1CDA C        	RETL                @0XDA		;136
   226            C        
   227 01489 1C06 C        	RETL                @0X06		;137
   228 0148A 1CFA C        	RETL                @0XFA		;138
   229            C        
   230 0148B 1CFF C        	RETL                @0XFF
   231            C        
   232            C        ;===========================================================
   233 0148C      C        RF_TABLE:			;LENGTH 30
   234 0148C 03C2 C        	ADD                 PC,A
   235 0148D 1C4E C        	RETL                @0X4E
   236 0148E 1C02 C        	RETL                @0X02
   237            C        
   238 0148F 1C43 C        	RETL                @0X43
   239 01490 1CC8 C        	RETL                @0XC8
   240            C        
   241 01491 1C44 C        	RETL                @0X44
   242 01492 1C20 C        	RETL                @PKT_LEN
   243            C        
   244 01493 1C45 C        	RETL                @0X45
   245 01494 1C10 C        	RETL                @0X10
   246            C        
   247 01495 1C48 C        	RETL                @0X48
   248 01496 1C01 C        	RETL                @0X01
   249            C        
   250 01497 1C4C C        	RETL                @0X4C
   251 01498 1C06 C         	RETL                @0X06
   252            C        
   253 01499 1C50 C        	RETL                @0X50
   254 0149A 1C00 C        	RETL                @TXADDRL
   255            C        
   256 0149B 1C51 C        	RETL                @0X51
   257 0149C 1C11 C        	RETL                @TXADDRH
   258            C        
   259 0149D 1C52 C        	RETL                @0X52
   260 0149E 1C22 C        	RETL                @0X22
   261            C        
   262 0149F 1C53 C        	RETL                @0X53
   263 014A0 1C33 C        	RETL                @0X33
   264            C        
   265 014A1 1C54 C        	RETL                @0X54
   266 014A2 1C44 C        	RETL                @0X44
   267            C        
   268 014A3 1C55 C        	RETL                @0X55
   269 014A4 1C55 C        	RETL                @0X55
   270            C        
   271 014A5 1C56 C        	RETL                @0X56
   272 014A6 1C66 C        	RETL                @0X66
   273            C        
   274 014A7 1C57 C        	RETL                @0X57
   275 014A8 1C77 C        	RETL                @0X77
   276            C        
   277 014A9 1C58 C        	RETL                @0X58
   278 014AA 1C08 C        	RETL                @0X08
   279            C        
   280 014AB 1CFF C        	RETL                @0XFF
   281            C        
   282            C        ;===========================================================
   283 014AC      C        CH_TABLE:
   284 014AC 03C2 C        	ADD                 PC,A
   285            C        	;1
   286 014AD 1C14 C        	RETL                @20        ;00 ;0x14
   287 014AE 1C26 C        	RETL                @38        ;01 ;0x26
   288 014AF 1C38 C        	RETL                @56        ;02 ;0x38
   289 014B0 1C4F C        	RETL                @79        ;03 ;0x4F
   290            C        
   291            C        	;2
   292 014B1 1C04 C        	RETL                @4         ;04 ;0x04
   293 014B2 1C17 C        	RETL                @23        ;05 ;0x17
   294 014B3 1C2A C        	RETL                @42        ;06 ;0x2A
   295 014B4 1C3D C        	RETL                @61        ;07 ;0x3D
   296            C        
   297            C        	;3
   298 014B5 1C07 C        	RETL                @7         ;08 ;0x07
   299 014B6 1C1B C        	RETL                @27        ;09 ;0x1B
   300 014B7 1C2F C        	RETL                @47        ;10 ;0x2F
   301 014B8 1C3E C        	RETL                @62        ;11 ;0x3E
   302            C        
   303            C        	;4
   304 014B9 1C0A C        	RETL                @10        ;12 ;0x02
   305 014BA 1C1F C        	RETL                @31        ;13 ;0x1F
   306 014BB 1C34 C        	RETL                @52        ;14 ;0x34
   307 014BC 1C3F C        	RETL                @63        ;15 ;0x3F
   308            C        
   309            C        	;5
   310 014BD 1C0D C        	RETL                @13        ;16 ;0x0D
   311 014BE 1C23 C        	RETL                @35        ;17 ;0x23
   312 014BF 1C39 C        	RETL                @57        ;18 ;0x39
   313 014C0 1C40 C        	RETL                @64        ;19 ;0x40
   314            C        
   315            C        	;6
   316 014C1 1C10 C        	RETL                @16        ;20 ;0x10
   317 014C2 1C27 C        	RETL                @39        ;21 ;0x27
   318 014C3 1C2B C        	RETL                @43        ;22 ;0x2B
   319 014C4 1C41 C        	RETL                @65        ;23 ;0x41
   320            C        
   321            C        	;7
   322 014C5 1C13 C        	RETL                @19        ;24 ;0x13
   323 014C6 1C18 C        	RETL                @24        ;25 ;0x18
   324 014C7 1C30 C        	RETL                @48        ;26 ;0x30
   325 014C8 1C42 C        	RETL                @66        ;27 ;0x42
   326            C        
   327            C        	;8
   328 014C9 1C16 C        	RETL                @22        ;28 ;0x16
   329 014CA 1C1C C        	RETL                @28        ;29 ;0x1C
   330 014CB 1C35 C        	RETL                @53        ;30 ;0x35
   331 014CC 1C43 C        	RETL                @67        ;31 ;0x43
   332            C        
   333            C        	;9
   334 014CD 1C06 C        	RETL                @6         ;32 ;0x06
   335 014CE 1C20 C        	RETL                @32        ;33 ;0x20
   336 014CF 1C3A C        	RETL                @58        ;34 ;0x3A
   337 014D0 1C44 C        	RETL                @68        ;35 ;0x44
   338            C        
   339            C        	;10
   340 014D1 1C09 C        	RETL                @9         ;36 ;0x09
   341 014D2 1C24 C        	RETL                @36        ;37 ;0x24
   342 014D3 1C2C C        	RETL                @44        ;38 ;0x2C
   343 014D4 1C45 C        	RETL                @69        ;39 ;0x45
   344            C        
   345            C        	;11
   346 014D5 1C0C C        	RETL                @12        ;40 ;0x0C
   347 014D6 1C28 C        	RETL                @40        ;41 ;0x28
   348 014D7 1C31 C        	RETL                @49        ;42 ;0x31
   349 014D8 1C46 C        	RETL                @70        ;43 ;0x46
   350            C        
   351            C        	;12
   352 014D9 1C0F C        	RETL                @15        ;44 ;0x0F
   353 014DA 1C19 C        	RETL                @25        ;45 ;0x19
   354 014DB 1C36 C        	RETL                @54        ;46 ;0x36
   355 014DC 1C47 C        	RETL                @71        ;47 ;0x36
   356            C        
   357            C        	;13
   358 014DD 1C12 C        	RETL                @18        ;48 ;0x12
   359 014DE 1C1D C        	RETL                @29        ;49 ;0x1D
   360 014DF 1C3B C        	RETL                @59        ;50 ;0x3B
   361 014E0 1C48 C        	RETL                @72        ;51 ;0x48
   362            C        
   363            C        	;14
   364 014E1 1C15 C        	RETL                @21        ;52 ;0x15
   365 014E2 1C21 C        	RETL                @33        ;53 ;0x21
   366 014E3 1C2D C        	RETL                @45        ;54 ;0x2D
   367 014E4 1C49 C        	RETL                @73        ;55 ;0x49
   368            C        
   369            C        	;15
   370 014E5 1C05 C        	RETL                @5         ;56 ;0x05
   371 014E6 1C25 C        	RETL                @37        ;57 ;0x25
   372 014E7 1C32 C        	RETL                @50        ;58 ;0x32
   373 014E8 1C4A C        	RETL                @74        ;59 ;0x4A
   374            C        
   375            C        	;16
   376 014E9 1C08 C        	RETL                @8         ;60 ;0x08
   377 014EA 1C29 C        	RETL                @41        ;61 ;0x29
   378 014EB 1C37 C        	RETL                @55        ;62 ;0x37
   379 014EC 1C4B C        	RETL                @75        ;63 ;0x4B
   380            C        
   381            C        	;17
   382 014ED 1C0B C        	RETL                @11        ;64 ;0x03
   383 014EE 1C1A C        	RETL                @26        ;65 ;0x1A
   384 014EF 1C3C C        	RETL                @60        ;66 ;0x3C
   385 014F0 1C4C C        	RETL                @76        ;67 ;0x4C
   386            C        
   387            C        	;18
   388 014F1 1C0E C        	RETL                @14        ;68 ;0x0E
   389 014F2 1C1E C        	RETL                @30        ;69 ;0x1E
   390 014F3 1C2E C        	RETL                @46        ;70 ;0x2E
   391 014F4 1C4D C        	RETL                @77        ;71 ;0x4D
   392            C        
   393            C        	;19
   394 014F5 1C11 C        	RETL                @17        ;72 ;0x11
   395 014F6 1C22 C        	RETL                @34        ;73 ;0x22
   396 014F7 1C33 C        	RETL                @51        ;74 ;0x33
   397 014F8 1C4E C        	RETL                @78        ;75 ;0x4E
   398            C        
   399            C        
   400            C        ;===========================================================
   401            C        ; RF Initialize SubRoutine
   402            C        ;===========================================================
   403 014F9      C        EM198850_RESET:
   404 014F9 1347 C        	CALL                PAGE5BANK1
   405 014FA 0846 C        	BC                  RESET_N/16,RESET_N%16
   406 014FB 181E C        	MOV                 A,@30                         ; wating 3ms
   407 014FC 1301 C        	CALL                DELAY_X100US
   408 014FD 0A46 C        	BS                  RESET_N/16,RESET_N%16          ; RESET=1
   409 014FE 1864 C        	MOV                 A,@100                          ; wating 10ms
   410 014FF 1301 C        	CALL                DELAY_X100US
   411            C        
   412 01500 095D C        	BC                  RFTestfailFlag/16,RFTestfailFlag%16
   413 01501 110E C        	CALL                INIT_FRAMEREG                  ; load	FRAMER TABLE send
   414 01502 1805 C        	MOV                 A,@5
   415 01503 1301 C        	CALL                DELAY_X100US
   416 01504 0000 C        	NOP
   417 01505 1121 C        	CALL                INIT_RSSI_CALIBRATION
   418 01506 0000 C        	NOP
   419 01507 1309 C        	CALL                TEST_INITIAL_RF
   420 01508 0000 C        	NOP
   421 01509 0D5D C        	JBC                 RFTestfailFlag/16,RFTestfailFlag%16
   422 0150A 14F9 C        	JMP                 EM198850_RESET
   423            C        
   424 0150B 1276 C        	CALL                Enter_StandbyII_Mode
   425 0150C 0B9D C        	BS                  RFInitialOKflag/16,RFInitialOKflag%16
   426            C        
   427 0150D 0012 C        	RET
   428            C        
   429            C        ;===============================================
   430 0150E      C        INIT_FRAMEREG:
   431 0150E 1347 C        	CALL                PAGE5BANK1
   432 0150F 00D8 C        	CLR                 TABLE_INDEX
   433 01510      C          Set_FrameReg:
   434 01510 0418 C        	MOV                 A,TABLE_INDEX
   435 01511 1000 C        	CALL                FRAME_TABLE
   436 01512 0070 C        	MOV                 ADDR,A
   437 01513 1BFF C        	XOR                 A,@0XFF
   438 01514 0C83 C        	JBC                 STATUS,Z
   439 01515 151F C        	JMP                 Set_Framereg_End
   440 01516 0558 C        	INC                 TABLE_INDEX
   441 01517 0418 C        	MOV                 A,TABLE_INDEX
   442 01518 1000 C        	CALL                FRAME_TABLE
   443 01519 0000 C        	NOP
   444 0151A 0071 C        	MOV                 VALUE,A
   445 0151B 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   446 0151C 0000 C        	NOP
   447 0151D 0558 C        	INC                 TABLE_INDEX
   448 0151E 1510 C        	JMP                 Set_FrameReg
   449 0151F      C          Set_Framereg_End:
   450 0151F 0000 C        	NOP
   451 01520 0012 C        	RET
   452            C        
   453            C        ;=================================================
   454 01521      C        INIT_RSSI_CALIBRATION:
   455 01521 1347 C        	CALL                PAGE5BANK1
   456 01522 1805 C        	MOV                 A,@0X05
   457 01523 005A C        	MOV                 DataByteLength,A
   458 01524 00F3 C        	CLR                 RF_RSSI
   459 01525      C          Repeat_Read_RSSI:
   460 01525 184B C        	MOV                 A,@0X4B
   461 01526 0070 C        	MOV                 ADDR,A
   462 01527 1157 C        	CALL                READ_SPI_REG
   463 01528 0000 C        	NOP
   464 01529 0433 C        	MOV                 A,RF_RSSI
   465 0152A 0131 C        	SUB                 A,VALUE
   466 0152B 0E03 C        	JBS                 STATUS,C
   467 0152C 152F C        	JMP                 $+3
   468 0152D 0431 C        	MOV                 A,VALUE
   469 0152E 0073 C        	MOV                 RF_RSSI,A
   470 0152F 05DA C        	DJZ                 DataByteLength
   471 01530 1525 C        	JMP                 Repeat_Read_RSSI
   472            C        
   473 01531 1804 C        	MOV                 A,@0X04
   474 01532 0173 C        	SUB                 RF_RSSI,A
   475 01533 0433 C        	MOV                 A,RF_RSSI
   476 01534 0071 C        	MOV                 VALUE,A
   477 01535 184A C        	MOV                 A,@0X4A
   478 01536 0070 C        	MOV                 ADDR,A
   479 01537 114C C        	CALL                WRITE_SPI_REG
   480 01538 0000 C        	NOP
   481 01539 1805 C        	MOV                 A,@0X05
   482 0153A 0070 C        	MOV                 ADDR,A
   483 0153B 1840 C        	MOV                 A,@0X40
   484 0153C 0071 C        	MOV                 VALUE,A
   485 0153D 114C C        	CALL                WRITE_SPI_REG
   486 0153E 0000 C        	NOP
   487 0153F 1802 C        	MOV                 A,@0X02
   488 01540 0070 C        	MOV                 ADDR,A
   489 01541 1800 C        	MOV                 A,@0X00
   490 01542 0071 C        	MOV                 VALUE,A
   491 01543 114C C        	CALL                WRITE_SPI_REG
   492 01544 0000 C        	NOP
   493 01545 180C C        	MOV                 A,@0X0C
   494 01546 0070 C        	MOV                 ADDR,A
   495 01547 18E0 C        	MOV                 A,@0XE0
   496 01548 0071 C        	MOV                 VALUE,A
   497 01549 114C C        	CALL                WRITE_SPI_REG
   498 0154A 0000 C        	NOP
   499 0154B 0012 C        	RET
   500            C        
   501            C        ;===========================================================
   502            C        ; RF Initialize End
   503            C        ;===========================================================
   504            C        ;===============================================
   505            C        ; Function: Write SPI Register
   506            C        ; Input:    ADDR,VALUE
   507            C        ; Output:   None
   508            C        ;===============================================
   509 0154C      C        WRITE_SPI_REG:
   510 0154C 1344 C        	CALL                PAGE5BANK0
   511 0154D 0906 C        	BC                  SPI_SS/16,SPI_SS%16				;	/SS	=0
   512 0154E 1347 C        	CALL                PAGE5BANK1
   513 0154F 0430 C        	MOV                 A,ADDR
   514 01550 1163 C        	CALL                SIM_SPI_WRITE
   515 01551 0431 C        	MOV                 A,VALUE
   516 01552 1163 C        	CALL                SIM_SPI_WRITE
   517 01553 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   518 01554 0000 C        	NOP
   519 01555 0B06 C        	BS                  SPI_SS/16,SPI_SS%16			;	/SS	=1
   520 01556 0012 C        	RET
   521            C        
   522            C        ;===============================================
   523            C        ; Function: Read SPI Register
   524            C        ; Input:   SPIWB
   525            C        ; Output:  SPIRB
   526            C        ;===============================================
   527 01557      C        READ_SPI_REG:
   528 01557 1347 C        	CALL                PAGE5BANK1
   529 01558 0906 C        	BC                  SPI_SS/16,SPI_SS%16			;	/SS	=0
   530 01559 0430 C        	MOV                 A,ADDR
   531 0155A 1980 C        	OR                  A,@0X80
   532 0155B 1163 C        	CALL                SIM_SPI_WRITE
   533 0155C 0000 C        	NOP
   534 0155D 1175 C        	CALL                SIM_SPI_READ
   535 0155E 0071 C        	MOV                 VALUE,A
   536 0155F 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   537 01560 0000 C        	NOP
   538 01561 0B06 C        	BS                  SPI_SS/16,SPI_SS%16			;	/SS	=0
   539 01562 0012 C        	RET
   540            C        
   541            C        ;===============================================
   542            C        ; Function: Write SPI communication subroutine rising edge
   543            C        ; Input:    ACC
   544            C        ; Output:   None
   545            C        ;===============================================
   546 01563      C        SIM_SPI_WRITE:
   547 01563 0050 C        	MOV                 SPIWB,A
   548 01564 1808 C        	MOV                 A,@8
   549 01565 0059 C        	MOV                 DataShiftCounter,A
   550 01566      C          WRITE_SPI_1:
   551 01566 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   552 01567 06D0 C        	RLC                 SPIWB
   553 01568 0C03 C        	JBC                 STATUS,C
   554 01569 156C C        	JMP                 SET_SPI_MOSI
   555 0156A 08C6 C        	BC                  SPI_MOSI/16,SPI_MOSI%16
   556 0156B 156D C        	JMP                 WRITE_SPI_COUNT_DEC
   557 0156C      C          SET_SPI_MOSI:
   558 0156C 0AC6 C        	BS                  SPI_MOSI/16,SPI_MOSI%16
   559 0156D      C          WRITE_SPI_COUNT_DEC:
   560 0156D 0A86 C        	BS                  SPI_CLK/16,SPI_CLK%16
   561 0156E 0000 C        	NOP
   562 0156F 05D9 C        	DJZ                 DataShiftCounter
   563 01570 1566 C        	JMP                 WRITE_SPI_1
   564 01571 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   565 01572 0000 C        	NOP
   566 01573 08C6 C        	BC                  SPI_MOSI/16,SPI_MOSI%16
   567 01574 0012 C        	RET
   568            C        
   569            C        ;===============================================
   570            C        ; Function: Read SPI communication subroutine rising edge
   571            C        ; Input:    None
   572            C        ; Output:   SPI Data
   573            C        ;===============================================
   574 01575      C        SIM_SPI_READ:
   575 01575 00D0 C        	CLR                 SPIRB
   576 01576 1808 C        	MOV                 A,@8
   577 01577 0059 C        	MOV                 DataShiftCounter,A
   578 01578      C          READ_SPI_1:
   579 01578 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   580 01579 0000 C        	NOP
   581 0157A 0000 C        	NOP
   582 0157B 0000 C        	NOP
   583 0157C 0A86 C        	BS                  SPI_CLK/16,SPI_CLK%16
   584 0157D 0E06 C        	JBS                 SPI_MISO/16,SPI_MISO%16
   585 0157E 1581 C        	JMP                 CLR_STATUS_C
   586 0157F 0A03 C        	BS                  STATUS,C
   587 01580 1582 C        	JMP                 READ_SPI_MISO
   588 01581      C          CLR_STATUS_C:
   589 01581 0803 C        	BC                  STATUS,C
   590 01582      C          READ_SPI_MISO:
   591 01582 06D0 C        	RLC                 SPIRB
   592 01583 05D9 C        	DJZ                 DataShiftCounter
   593 01584 1578 C        	JMP                 READ_SPI_1
   594 01585 0886 C        	BC                  SPI_CLK/16,SPI_CLK%16
   595 01586 0410 C        	MOV                 A,SPIRB
   596 01587 0012 C        	RET
   597            C        
   598            C        
   599            C        ;***********************************************************
   600            C        ; Function: Read FIFO RAM
   601            C        ; Input:    None
   602            C        ; Output:   RX_BUF	,Receive_Error
   603            C        ;***********************************************************
   604 01588      C        READ_FIFO_RAM:
   605 01588 1820 C        	MOV                 A,@RX_BUF					;READ DATA START Address
   606 01589 0044 C        	MOV                 RSR,A
   607 0158A 0000 C        	NOP
   608 0158B 0000 C        	NOP
   609 0158C 0906 C        	BC                  SPI_SS/16,SPI_SS%16				;/SS=0
   610 0158D 18FF C        	MOV                 A,@0XFF						;0X7F||0X80 FIFO ADDRESS
   611 0158E 1163 C        	CALL                SIM_SPI_WRITE
   612 0158F 0000 C        	NOP
   613 01590 0000 C        	NOP
   614 01591 1820 C        	MOV                 A,@PKT_LEN
   615 01592 005A C        	MOV                 DataByteLength,A
   616 01593      C          Read_FIFO_Loop:
   617 01593 1175 C        	CALL                SIM_SPI_READ	 					;Packet & Device	ID
   618 01594 0040 C        	MOV                 R0, A
   619 01595 0544 C        	INC                 RSR
   620 01596 05DA C        	DJZ                 DataByteLength
   621 01597 1593 C        	JMP                 Read_FIFO_Loop
   622 01598 0000 C        	NOP
   623 01599 0B06 C        	BS                  SPI_SS/16,SPI_SS%16				;/SS=1
   624 0159A 0012 C        	RET
   625            C        
   626            C        
   627            C        ;***********************************************************
   628            C        ; Function: Write FIFO RAM
   629            C        ; Input:    None
   630            C        ; Output:   RX_Buf	,Receive_Error%16
   631            C        ;***********************************************************
   632 0159B      C        WRITE_FIFO_RAM:
   633 0159B 0906 C        	BC                  SPI_SS/16,SPI_SS%16    ;/SS=1
   634 0159C 187F C        	MOV                 A,@0X7F         ;reg0X7F
   635 0159D 1163 C        	CALL                SIM_SPI_WRITE   ;use I/O as	SPI	pro
   636 0159E 0000 C        	NOP
   637 0159F 1820 C        	MOV                 A,@PKT_LEN
   638 015A0 005A C        	MOV                 DataByteLength,A
   639 015A1 1820 C        	MOV                 A,@TX_BUF       ;Write DATA START Address
   640 015A2 0044 C        	MOV                 RSR,A
   641 015A3      C         Write_FIFO_Loop:
   642 015A3 0400 C        	MOV                 A,R0
   643 015A4 1163 C        	CALL                SIM_SPI_WRITE   ;use I/O as	SPI	pro
   644 015A5 0000 C        	NOP
   645 015A6 0544 C        	INC                 RSR
   646 015A7 05DA C        	DJZ                 DataByteLength
   647 015A8 15A3 C        	JMP                 Write_FIFO_Loop
   648 015A9 0B06 C        	BS                  SPI_SS/16,SPI_SS%16    ;/SS=1
   649 015AA 0F86 C        	JBS                 PKT_FLAG/16,PKT_FLAG%16
   650 015AB 15AA C        	JMP                 $-1
   651 015AC 0012 C        	RET
   652            C        
   653            C        
   654            C        ;===============================================
   655            C        ; Function: Reset RF FIFO
   656            C        ; Input:    None
   657            C        ; Output:   None
   658            C        ;===============================================
   659 015AD      C        RESET_RF_FIFO:
   660 015AD 1347 C        	CALL                PAGE5BANK1
   661 015AE 184D C        	MOV                 A,@0X4D
   662 015AF 0070 C        	MOV                 ADDR,A					;ADDR=0X4D
   663 015B0 1801 C        	MOV                 A,@0X01
   664 015B1 0071 C        	MOV                 VALUE,A
   665 015B2 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   666            C        	;MOV                 A,@12
   667            C        	;CALL                DELAY_X10US
   668            C        	MESSAGE "Make sure that anything take-over or send out in 120us "
***     USER MESSAGE: MAKE SURE THAT ANYTHING TAKE-OVER OR SEND OUT IN 120US 
   669 015B3 0012 C        	RET
   670            C        
   671            C        
   672            C        ;***********************************************************
   673            C        ; Function: Enter TX Buffered ACK
   674            C        ; Input:    None
   675            C        ; Output:   None
   676            C        ;***********************************************************
   677 015B4      C        ENTER_TX_BUFFER_ACK:
   678 015B4 1347 C        	CALL                PAGE5BANK1
   679 015B5 1800 C        	MOV                 A,@0X00
   680 015B6 0070 C        	MOV                 ADDR,A
   681 015B7 18E5 C        	MOV                 A,@0XE5
   682 015B8 0071 C        	MOV                 VALUE,A
   683 015B9 114C C        	CALL                WRITE_SPI_REG
   684 015BA 1801 C        	MOV                 A,@0X01
   685 015BB 0070 C        	MOV                 ADDR,A
   686 015BC 1884 C        	MOV                 A,@0X84
   687 015BD 0071 C        	MOV                 VALUE,A
   688 015BE 114C C        	CALL                WRITE_SPI_REG
   689 015BF 1841 C        	MOV                 A,@0X41
   690 015C0 0070 C        	MOV                 ADDR,A
   691 015C1 18BF C        	MOV                 A,@0XBF
   692 015C2 0071 C        	MOV                 VALUE,A
   693 015C3 114C C        	CALL                WRITE_SPI_REG
   694 015C4 1840 C        	MOV                 A,@0X40
   695 015C5 0070 C        	MOV                 ADDR,A
   696 015C6 1856 C        	MOV                 A,@0X56
   697            C        	if                  USED_PID_FUNCTION
   698            C        		OR              A,@0X80
   699            C        	endif
   700 015C7 0071 C        	MOV                 VALUE,A
   701 015C8 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   702 015C9 0012 C        	RET
   703            C        
   704            C        
   705            C        ;***********************************************************
   706            C        ; Function: Enter TX Buffered NACK
   707            C        ; Input:    None
   708            C        ; Output:   None
   709            C        ;***********************************************************
   710 015CA      C        ENTER_TX_BUFFER_NACK:
   711 015CA 1347 C        	CALL                PAGE5BANK1
   712 015CB 1800 C        	MOV                 A,@0X00
   713 015CC 0070 C        	MOV                 ADDR,A
   714 015CD 18E5 C        	MOV                 A,@0XE5
   715 015CE 0071 C        	MOV                 VALUE,A
   716 015CF 114C C        	CALL                WRITE_SPI_REG
   717 015D0 1801 C        	MOV                 A,@0X01
   718 015D1 0070 C        	MOV                 ADDR,A
   719 015D2 1884 C        	MOV                 A,@0X84
   720 015D3 0071 C        	MOV                 VALUE,A
   721 015D4 114C C        	CALL                WRITE_SPI_REG
   722 015D5 1841 C        	MOV                 A,@0X41
   723 015D6 0070 C        	MOV                 ADDR,A
   724 015D7 18BF C        	MOV                 A,@0XBF
   725 015D8 0071 C        	MOV                 VALUE,A
   726 015D9 114C C        	CALL                WRITE_SPI_REG
   727 015DA 1840 C        	MOV                 A,@0X40
   728 015DB 0070 C        	MOV                 ADDR,A
   729 015DC 1852 C        	MOV                 A,@0X52
   730            C        	if                  USED_PID_FUNCTION
   731            C        		OR              A,@0X80
   732            C        	endif
   733 015DD 0071 C        	MOV                 VALUE,A
   734 015DE 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   735 015DF 0012 C        	RET
   736            C        
   737            C        
   738            C        ;***********************************************************
   739            C        ; Function: Enter TX Direct ACK
   740            C        ; Input:    None
   741            C        ; Output:   None
   742            C        ;***********************************************************
   743 015E0      C        Enter_TX_Direct_ACK:
   744 015E0 1347 C        	CALL                PAGE5BANK1
   745 015E1 1800 C        	MOV                 A,@0X00
   746 015E2 0070 C        	MOV                 ADDR,A
   747 015E3 1885 C        	MOV                 A,@0X85
   748 015E4 0071 C        	MOV                 VALUE,A
   749 015E5 114C C        	CALL                WRITE_SPI_REG
   750 015E6 1801 C        	MOV                 A,@0X01
   751 015E7 0070 C        	MOV                 ADDR,A
   752 015E8 1884 C        	MOV                 A,@0X84
   753 015E9 0071 C        	MOV                 VALUE,A
   754 015EA 114C C        	CALL                WRITE_SPI_REG
   755 015EB 1841 C        	MOV                 A,@0X41
   756 015EC 0070 C        	MOV                 ADDR,A
   757 015ED 18BF C        	MOV                 A,@0XBF
   758 015EE 0071 C        	MOV                 VALUE,A
   759 015EF 114C C        	CALL                WRITE_SPI_REG
   760 015F0 1840 C        	MOV                 A,@0X40
   761 015F1 0070 C        	MOV                 ADDR,A
   762 015F2 1856 C        	MOV                 A,@0X56
   763            C        	if                  USED_PID_FUNCTION
   764            C        		OR              A,@0X80
   765            C        	endif
   766 015F3 0071 C        	MOV                 VALUE,A
   767 015F4 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   768 015F5 0012 C        	RET
   769            C        
   770            C        
   771            C        ;***********************************************************
   772            C        ; Function: Enter TX Direct NACK
   773            C        ; Input:    None
   774            C        ; Output:   None
   775            C        ;***********************************************************
   776 015F6      C        Enter_TX_Direct_NACK:
   777 015F6 1347 C        	CALL                PAGE5BANK1
   778 015F7 1800 C        	MOV                 A,@0X00
   779 015F8 0070 C        	MOV                 ADDR,A
   780 015F9 1885 C        	MOV                 A,@0X85
   781 015FA 0071 C        	MOV                 VALUE,A
   782 015FB 114C C        	CALL                WRITE_SPI_REG
   783 015FC 1801 C        	MOV                 A,@0X01
   784 015FD 0070 C        	MOV                 ADDR,A
   785 015FE 1884 C        	MOV                 A,@0X84
   786 015FF 0071 C        	MOV                 VALUE,A
   787 01600 114C C        	CALL                WRITE_SPI_REG
   788 01601 1841 C        	MOV                 A,@0X41
   789 01602 0070 C        	MOV                 ADDR,A
   790 01603 18BF C        	MOV                 A,@0XBF
   791 01604 0071 C        	MOV                 VALUE,A
   792 01605 114C C        	CALL                WRITE_SPI_REG
   793 01606 1840 C        	MOV                 A,@0X40
   794 01607 0070 C        	MOV                 ADDR,A
   795 01608 1852 C        	MOV                 A,@0X52
   796            C        	if                  USED_PID_FUNCTION
   797            C        		OR              A,@0X80
   798            C        	endif
   799 01609 0071 C        	MOV                 VALUE,A
   800 0160A 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   801 0160B 0012 C        	RET
   802            C        
   803            C        
   804            C        ;***********************************************************
   805            C        ; Function: Enter RX Buffered ACK
   806            C        ; Input:    None
   807            C        ; Output:   None
   808            C        ;***********************************************************
   809 0160C      C        Enter_RX_Buffer_ACK:
   810 0160C 1347 C        	CALL                PAGE5BANK1
   811 0160D 1800 C        	MOV                 A,@0X00
   812 0160E 0070 C        	MOV                 ADDR,A
   813 0160F 18E5 C        	MOV                 A,@0XE5
   814 01610 0071 C        	MOV                 VALUE,A
   815 01611 114C C        	CALL                WRITE_SPI_REG
   816 01612 1801 C        	MOV                 A,@0X01
   817 01613 0070 C        	MOV                 ADDR,A
   818 01614 1884 C        	MOV                 A,@0X84
   819 01615 0071 C        	MOV                 VALUE,A
   820 01616 114C C        	CALL                WRITE_SPI_REG
   821 01617 1841 C        	MOV                 A,@0X41
   822 01618 0070 C        	MOV                 ADDR,A
   823 01619 18BF C        	MOV                 A,@0XBF
   824 0161A 0071 C        	MOV                 VALUE,A
   825 0161B 114C C        	CALL                WRITE_SPI_REG
   826 0161C 1840 C        	MOV                 A,@0X40
   827 0161D 0070 C        	MOV                 ADDR,A
   828 0161E 1859 C        	MOV                 A,@0X59
   829            C        	if                  USED_PID_FUNCTION
   830            C        		OR              A,@0X80
   831            C        	endif
   832 0161F 0071 C        	MOV                 VALUE,A
   833 01620 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   834 01621 0000 C        	NOP
   835 01622 0012 C        	RET
   836            C        
   837            C        
   838            C        ;**********************************************************
   839            C        ; Function: Enter RX Buffered NACK
   840            C        ; Input:    None
   841            C        ; Output:   None
   842            C        ;***********************************************************
   843 01623      C        Enter_RX_Buffer_NACK:
   844 01623 1347 C        	CALL                PAGE5BANK1
   845 01624 1800 C        	MOV                 A,@0X00
   846 01625 0070 C        	MOV                 ADDR,A
   847 01626 18E5 C        	MOV                 A,@0XE5
   848 01627 0071 C        	MOV                 VALUE,A
   849 01628 114C C        	CALL                WRITE_SPI_REG
   850 01629 1801 C        	MOV                 A,@0X01
   851 0162A 0070 C        	MOV                 ADDR,A
   852 0162B 1884 C        	MOV                 A,@0X84
   853 0162C 0071 C        	MOV                 VALUE,A
   854 0162D 114C C        	CALL                WRITE_SPI_REG
   855 0162E 1841 C        	MOV                 A,@0X41
   856 0162F 0070 C        	MOV                 ADDR,A
   857 01630 18BF C        	MOV                 A,@0XBF
   858 01631 0071 C        	MOV                 VALUE,A
   859 01632 114C C        	CALL                WRITE_SPI_REG
   860 01633 1840 C        	MOV                 A,@0X40
   861 01634 0070 C        	MOV                 ADDR,A
   862 01635 1851 C        	MOV                 A,@0X51
   863            C        	if                  USED_PID_FUNCTION
   864            C        		OR              A,@0X80
   865            C        	endif
   866 01636 0071 C        	MOV                 VALUE,A
   867 01637 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   868 01638 0012 C        	RET
   869            C        
   870            C        
   871            C        ;***********************************************************
   872            C        ; Function: Enter RX Direct ACK
   873            C        ; Input:    None
   874            C        ; Output:   None
   875            C        ;***********************************************************
   876 01639      C        Enter_RX_Direct_ACK:
   877 01639 1347 C        	CALL                PAGE5BANK1
   878 0163A 1800 C        	MOV                 A,@0X00
   879 0163B 0070 C        	MOV                 ADDR,A
   880 0163C 1885 C        	MOV                 A,@0X85
   881 0163D 0071 C        	MOV                 VALUE,A
   882 0163E 114C C        	CALL                WRITE_SPI_REG
   883 0163F 1801 C        	MOV                 A,@0X01
   884 01640 0070 C        	MOV                 ADDR,A
   885 01641 1884 C        	MOV                 A,@0X84
   886 01642 0071 C        	MOV                 VALUE,A
   887 01643 114C C        	CALL                WRITE_SPI_REG
   888 01644 1841 C        	MOV                 A,@0X41
   889 01645 0070 C        	MOV                 ADDR,A
   890 01646 18BF C        	MOV                 A,@0XBF
   891 01647 0071 C        	MOV                 VALUE,A
   892 01648 114C C        	CALL                WRITE_SPI_REG
   893 01649 1840 C        	MOV                 A,@0X40
   894 0164A 0070 C        	MOV                 ADDR,A
   895 0164B 1859 C        	MOV                 A,@0X59
   896            C        	if                  USED_PID_FUNCTION
   897            C        		OR              A,@0X80
   898            C        	endif
   899 0164C 0071 C        	MOV                 VALUE,A
   900 0164D 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   901 0164E 0012 C        	RET
   902            C        
   903            C        
   904            C        ;**********************************************************
   905            C        ; Function: Enter RX Direct NACK
   906            C        ; Input:    None
   907            C        ; Output:   None
   908            C        ;***********************************************************
   909 0164F      C        Enter_RX_Direct_NACK:
   910 0164F 1347 C        	CALL                PAGE5BANK1
   911 01650 1800 C        	MOV                 A,@0X00
   912 01651 0070 C        	MOV                 ADDR,A
   913 01652 1885 C        	MOV                 A,@0X85
   914 01653 0071 C        	MOV                 VALUE,A
   915 01654 114C C        	CALL                WRITE_SPI_REG
   916 01655 1801 C        	MOV                 A,@0X01
   917 01656 0070 C        	MOV                 ADDR,A
   918 01657 1884 C        	MOV                 A,@0X84
   919 01658 0071 C        	MOV                 VALUE,A
   920 01659 114C C        	CALL                WRITE_SPI_REG
   921 0165A 1841 C        	MOV                 A,@0X41
   922 0165B 0070 C        	MOV                 ADDR,A
   923 0165C 18BF C        	MOV                 A,@0XBF
   924 0165D 0071 C        	MOV                 VALUE,A
   925 0165E 114C C        	CALL                WRITE_SPI_REG
   926 0165F 1840 C        	MOV                 A,@0X40
   927 01660 0070 C        	MOV                 ADDR,A
   928 01661 1851 C        	MOV                 A,@0X51
   929            C        	if                  USED_PID_FUNCTION
   930            C        		OR              A,@0X80
   931            C        	endif
   932 01662 0071 C        	MOV                 VALUE,A
   933 01663 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   934 01664 0012 C        	RET
   935            C        
   936            C        
   937            C        ;***********************************************************
   938            C        ; Function: Enter StandbyI Mode
   939            C        ; Input:    None
   940            C        ; Output:   None
   941            C        ; description:
   942            C        ;***********************************************************
   943 01665      C        Enter_StandbyI_Mode:
   944 01665 1347 C        	CALL                PAGE5BANK1
   945 01666 1800 C        	MOV                 A,@0X00
   946 01667 0070 C        	MOV                 ADDR,A
   947 01668 1865 C        	MOV                 A,@0X65
   948 01669 0071 C        	MOV                 VALUE,A
   949 0166A 114C C        	CALL                WRITE_SPI_REG
   950 0166B 1801 C        	MOV                 A,@0X01
   951 0166C 0070 C        	MOV                 ADDR,A
   952 0166D 188C C        	MOV                 A,@0X8C
   953 0166E 0071 C        	MOV                 VALUE,A
   954 0166F 114C C        	CALL                WRITE_SPI_REG
   955 01670 1840 C        	MOV                 A,@0X40
   956 01671 0070 C        	MOV                 ADDR,A
   957 01672 1850 C        	MOV                 A,@0X50
   958            C        	if USED_PID_FUNCTION
   959            C        		OR              A,@0X80
   960            C        	endif
   961 01673 0071 C        	MOV                 VALUE,A
   962 01674 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   963 01675 0012 C        	RET
   964            C        
   965            C        
   966            C        ;***********************************************************
   967            C        ; Function: Enter StandbyII Mode
   968            C        ; Input:    None
   969            C        ; Output:   None
   970            C        ; description: auto enter
   971            C        ;***********************************************************
   972 01676      C        Enter_StandbyII_Mode:
   973 01676 1347 C        	CALL                PAGE5BANK1
   974 01677 1800 C        	MOV                 A,@0X00
   975 01678 0070 C        	MOV                 ADDR,A
   976 01679 18E5 C        	MOV                 A,@0XE5
   977 0167A 0071 C        	MOV                 VALUE,A
   978 0167B 114C C        	CALL                WRITE_SPI_REG
   979 0167C 1801 C        	MOV                 A,@0X01
   980 0167D 0070 C        	MOV                 ADDR,A
   981 0167E 1884 C        	MOV                 A,@0X84
   982 0167F 0071 C        	MOV                 VALUE,A
   983 01680 114C C        	CALL                WRITE_SPI_REG
   984 01681 1841 C        	MOV                 A,@0X41
   985 01682 0070 C        	MOV                 ADDR,A
   986 01683 18BF C        	MOV                 A,@0XBF
   987 01684 0071 C        	MOV                 VALUE,A
   988 01685 114C C        	CALL                WRITE_SPI_REG
   989 01686 1840 C        	MOV                 A,@0X40
   990 01687 0070 C        	MOV                 ADDR,A
   991 01688 1852 C        	MOV                 A,@0X52
   992            C        	if                  USED_PID_FUNCTION
   993            C        		OR              A,@0X80
   994            C        	endif
   995 01689 0071 C        	MOV                 VALUE,A
   996 0168A 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
   997 0168B 0012 C        	RET
   998            C        
   999            C        
  1000            C        ;===============================================
  1001            C        ; Function: Enter Idle Mode
  1002            C        ; Input:    None
  1003            C        ; Output:   None
  1004            C        ;===============================================
  1005 0168C      C        ENTER_IDLE_MODE:
  1006 0168C 1347 C        	CALL                PAGE5BANK1
  1007 0168D 1800 C        	MOV                 A,@0X00
  1008 0168E 0070 C        	MOV                 ADDR,A
  1009 0168F 18C0 C        	MOV                 A,@0XC0
  1010 01690 0071 C        	MOV                 VALUE,A
  1011 01691 114C C        	CALL                WRITE_SPI_REG				;send SPI data to EM198810
  1012 01692 1801 C        	MOV                 A,@0X01
  1013 01693 0070 C        	MOV                 ADDR,A
  1014 01694 188A C        	MOV                 A,@0X8A
  1015 01695 0071 C        	MOV                 VALUE,A
  1016 01696 114C C        	CALL                WRITE_SPI_REG
  1017 01697 1344 C        	CALL                PAGE5BANK0
  1018 01698 0846 C        	BC                  RESET_N/16,RESET_N%16
  1019 01699 1347 C        	CALL                PAGE5BANK1
  1020 0169A 0012 C        	RET
  1021            C        
  1022            C        
  1023            C        ;===============================================
  1024            C        ; Function: RF Enter Sleep Mode
  1025            C        ; Input:    ADDR,VALUE
  1026            C        ; Output:   None
  1027            C        ;===============================================
  1028 0169B      C        ENTER_RF_SLEEP:
  1029 0169B 1347 C        	CALL                PAGE5BANK1
  1030 0169C 1800 C        	MOV                 A,@0X00
  1031 0169D 0070 C        	MOV                 ADDR,A
  1032 0169E 18E5 C        	MOV                 A,@0XE5
  1033 0169F 0071 C        	MOV                 VALUE,A
  1034 016A0 114C C        	CALL                WRITE_SPI_REG
  1035 016A1 0000 C        	NOP
  1036 016A2 1344 C        	CALL                PAGE5BANK0
  1037 016A3 0846 C        	BC                  RESET_N/16,RESET_N%16
  1038 016A4 1347 C        	CALL                PAGE5BANK1
  1039 016A5 0012 C        	RET
  1040            C        
  1041            C        
  1042            C        ;===============================================
  1043            C        ; Function: RF Wake Up
  1044            C        ; Input:    None
  1045            C        ; Output:   None
  1046            C        ;===============================================
  1047 016A6      C        RF_WAKEUP:
  1048 016A6 0A46 C        	BS                  RESET_N/16,RESET_N%16
  1049 016A7 1800 C        	MOV                 A,@0X00
  1050 016A8 0070 C        	MOV                 ADDR,A
  1051 016A9 18E5 C        	MOV                 A, @0XE5
  1052 016AA 0071 C        	MOV                 VALUE,A
  1053 016AB 114C C        	CALL                WRITE_SPI_REG
  1054 016AC 180F C        	MOV                 A,@0X0F
  1055 016AD 1301 C        	CALL                DELAY_X100US
  1056 016AE 0012 C        	RET
  1057            C        
  1058            C        
  1059            C        ;===============================================
  1060            C        ; Function: RF Channel Frequency Set
  1061            C        ; Input:    TABLE_INDEX
  1062            C        ; Output:   None
  1063            C        ;===============================================
  1064 016AF      C        RF_FREQ_SET:
  1065 016AF 1347 C        	CALL                PAGE5BANK1
  1066 016B0 1802 C        	MOV                 A,@0X02
  1067 016B1 0070 C        	MOV                 ADDR,A
  1068 016B2 0432 C        	MOV                 A,CH_NO
  1069 016B3 10AC C        	CALL                CH_TABLE
  1070 016B4 0071 C        	MOV                 VALUE,A
  1071 016B5 114C C        	CALL                WRITE_SPI_REG
  1072 016B6 0012 C        	RET
  1073            C        
  1074            C        
  1075            C        ;===============================================
  1076            C        ; Function: Read PKT Lost Count
  1077            C        ; Input:    None
  1078            C        ; Output:   PKT_Lost_Count
  1079            C        ;===============================================
  1080 016B7      C        READ_PKTLOSTCNT:
  1081 016B7 184F C        	MOV                 A,@0X4F
  1082 016B8 0070 C        	MOV                 ADDR,A
  1083 016B9 1157 C        	CALL                READ_SPI_REG
  1084 016BA 0012 C        	RET
  1085            C        
  1086            C        
  1087            C        ;===============================================
  1088            C        ; Function: Clr PKT Lost Count
  1089            C        ; Input:    Zero
  1090            C        ; Output:   None
  1091            C        ;===============================================
  1092 016BB      C        CLR_PKTLOSTCNT:
  1093 016BB 184F C        	MOV                 A,@0X4F
  1094 016BC 0070 C        	MOV                 ADDR,A
  1095 016BD 1800 C        	MOV                 A,@0X00
  1096 016BE 0071 C        	MOV                 VALUE,A
  1097 016BF 114C C        	CALL                WRITE_SPI_REG
  1098 016C0 0012 C        	RET
  1099            C        
  1100            C        ;===============================================
  1101            C        ; Function: Address change function
  1102            C        ; Input:    RX_IDH,RX_IDL
  1103            C        ; Output:   None
  1104            C        ;===============================================
  1105 016C1      C        CHANGE_ADDRESS_VALUE:
  1106 016C1 1347 C        	CALL                PAGE5BANK1
  1107 016C2 1841 C        	MOV                 A,@0X41
  1108 016C3 0070 C        	MOV                 ADDR,A
  1109 016C4 18BF C        	MOV                 A,@0B10111111
  1110 016C5 0071 C        	MOV                 VALUE,A
  1111 016C6 114C C        	CALL                WRITE_SPI_REG    ; Enalbe 6 TX
  1112            C        
  1113 016C7 1851 C        	MOV                 A,@0X51
  1114 016C8 0070 C        	MOV                 ADDR,A
  1115 016C9 0421 C        	MOV                 A,RX_IDH
  1116 016CA 0071 C        	MOV                 VALUE,A
  1117 016CB 114C C        	CALL                WRITE_SPI_REG
  1118            C        
  1119 016CC 1853 C        	MOV                 A,@0X53
  1120 016CD 0070 C        	MOV                 ADDR,A
  1121 016CE 0421 C        	MOV                 A,RX_IDH
  1122 016CF 0071 C        	MOV                 VALUE,A
  1123 016D0 114C C        	CALL                WRITE_SPI_REG
  1124            C        
  1125 016D1 1850 C        	MOV                 A,@0X50
  1126 016D2 0070 C        	MOV                 ADDR,A
  1127 016D3 0422 C        	MOV                 A,RX_IDL
  1128 016D4 0071 C        	MOV                 VALUE,A
  1129 016D5 114C C        	CALL                WRITE_SPI_REG
  1130            C        /*
  1131            C        	MOV                 A,@0X52
  1132            C        	MOV                 ADDR,A
  1133            C        	MOV                 A,RX_IDL
  1134            C        	AND                 A,@0B11110000
  1135            C        	MOV                 VALUE,A
  1136            C        	INC                 VALUE         ; TX_ID1=(RX_IDL&0XF0)|0X01
  1137            C        	INC                 VALUE         ; TX_ID2=(RX_IDL&0XF0)|0X02
  1138            C        	CALL                WRITE_SPI_REG
  1139            C        
  1140            C        	MOV                 A,@0X54
  1141            C        	MOV                 ADDR,A
  1142            C        	INC                 VALUE         ; TX_ID3=(RX_IDL&0XF0)|0X03
  1143            C        	CALL                WRITE_SPI_REG
  1144            C        
  1145            C        	MOV                 A,@0X55
  1146            C        	MOV                 ADDR,A
  1147            C        	INC                 VALUE         ; TX_ID4=(RX_IDL&0XF0)|0X04
  1148            C        	CALL                WRITE_SPI_REG
  1149            C        
  1150            C        	MOV                 A,@0X56
  1151            C        	MOV                 ADDR,A
  1152            C        	INC                 VALUE         ; TX_ID5=(RX_IDL&0XF0)|0X05
  1153            C        	CALL                WRITE_SPI_REG
  1154            C        
  1155            C        	MOV                 A,@0X57
  1156            C        	MOV                 ADDR,A
  1157            C        	INC                 VALUE         ; TX_ID6=(RX_IDL&0XF0)|0X06
  1158            C        	CALL                WRITE_SPI_REG
  1159            C        */	
  1160 016D6 0000 C        	NOP
  1161 016D7 0012 C        	RET
  1162 016D8 0000 C        	NOP
  1163            C        
  1164            C        
  1165            C        ;***********************************************************
  1166            C        ; Function: RF RSSI Check the channel if is clean
  1167            C        ; Input:    None
  1168            C        ; Output:   None
  1169            C        ;***********************************************************
  1170 016D9      C        RSSI_TEST_FUNCTION:        ; RF_RSSI_CHECK:
  1171 016D9 1223 C        	CALL                Enter_RX_Buffer_NACK
  1172 016DA 1804 C        	MOV                 A,@4
  1173 016DB 0051 C        	MOV                 TEMP1,A
  1174 016DC 00D2 C        	CLR                 TEMP2
  1175            C        
  1176            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
  1177            C        	;XOR                 PORT5,A
  1178            C         
  1179 016DD      C          Scan_Clean_Channel:
  1180 016DD 1347 C        	CALL                PAGE5BANK1
  1181 016DE 184B C        	MOV                 A,@0X4B
  1182 016DF 0070 C        	MOV                 ADDR,A
  1183 016E0 1157 C        	CALL                READ_SPI_REG
  1184 016E1 0431 C        	MOV                 A,VALUE
  1185 016E2 03D2 C        	ADD                 TEMP2,A
  1186 016E3 05D1 C        	DJZ                 TEMP1
  1187 016E4 16DD C        	JMP                 Scan_Clean_Channel
  1188            C        	
  1189 016E5 0652 C        	RRC                 TEMP2
  1190 016E6 0612 C        	RRCA                TEMP2
  1191 016E7 1D20 C        	SUB                 A,@NoiseStrobe
  1192 016E8 0E03 C        	JBS                 STATUS,C
  1193 016E9 16F5 C        	JMP                 Exit_RSSI_Check
  1194            C        
  1195 016EA 1347 C        	CALL                PAGE5BANK1
  1196 016EB 0572 C        	INC                 CH_NO
  1197 016EC 0432 C        	MOV                 A,CH_NO
  1198 016ED 1D4C C        	SUB                 A,@ChannelSum
  1199 016EE 0E03 C        	JBS                 STATUS,C
  1200 016EF 00F2 C        	CLR                 CH_NO
  1201 016F0 12AF C        	CALL                RF_FREQ_SET
  1202 016F1 1805 C        	MOV                 A,@5
  1203 016F2 1301 C        	CALL                DELAY_X100US
  1204 016F3 0000 C        	NOP
  1205            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
  1206            C        	;XOR                 PORT5,A
  1207            C        
  1208 016F4 16DD C        	JMP                 Scan_Clean_Channel
  1209 016F5      C          Exit_RSSI_Check:
  1210 016F5 0000 C        	NOP
  1211 016F6 0012 C        	RET
  1212 016F7 0000 C        	NOP
  1213            C        
  1214            C        ;===============================================
  1215            C        ; Function: Delay 20us
  1216            C        ; Input:    None
  1217            C        ; Output:   None
  1218            C        ;===============================================
  1219 016F8      C        DELAY_X10US:
  1220 016F8 0051 C        	MOV                 TEMP1,A
  1221 016F9      C          Delay_Loop_X10US:
  1222 016F9 1808 C        	MOV                 A,@8      ;
  1223 016FA 0052 C        	MOV                 TEMP2,A
  1224 016FB      C          Waiting_X10US:
  1225 016FB 05D2 C        	DJZ                 TEMP2
  1226 016FC 16FB C        	JMP                 Waiting_X10US
  1227 016FD 05D1 C        	DJZ                 TEMP1
  1228 016FE 16F9 C        	JMP                 Delay_Loop_X10US
  1229 016FF 0012 C        	RET
  1230 01700 0000 C        	NOP
  1231            C        
  1232            C        
  1233            C        ;===============================================
  1234            C        ; Function: Delay 100us
  1235            C        ; Input:    None
  1236            C        ; Output:   None
  1237            C        ; CRYSTAL	   :  6MHZ
  1238            C        ;===============================================
  1239 01701      C        DELAY_X100US:
  1240 01701 0051 C        	MOV                 TEMP1,A
  1241 01702      C          Delay_Loop_X100US:
  1242 01702 1864 C        	MOV                 A,@100      ;
  1243 01703 0052 C        	MOV                 TEMP2,A
  1244 01704      C          Waiting_X100US:
  1245 01704 05D2 C        	DJZ                 TEMP2
  1246 01705 1704 C        	JMP                 Waiting_X100US
  1247 01706 05D1 C        	DJZ                 TEMP1
  1248 01707 1702 C        	JMP                 Delay_Loop_X100US
  1249 01708 0012 C        	RET
  1250            C        
  1251            C        
  1252            C        ;===============================================
  1253            C        ;test RF Register, if read==write test pass
  1254            C        ;===============================================
  1255 01709      C        TEST_INITIAL_RF:
  1256 01709      C          Analog_Reg_Test:
  1257 01709 1807 C        	MOV                 A,@0X07
  1258 0170A 0070 C        	MOV                 ADDR,A
  1259 0170B 1858 C        	MOV                 A,@0X58						;R7[6]=1
  1260 0170C 0071 C        	MOV                 VALUE,A
  1261 0170D 114C C        	CALL                WRITE_SPI_REG
  1262 0170E 0000 C        	NOP
  1263 0170F 180E C        	MOV                 A,@0X0E
  1264 01710 0070 C        	MOV                 ADDR,A
  1265 01711 1811 C        	MOV                 A,@0X11						;RE[7]=0
  1266 01712 0071 C        	MOV                 VALUE,A
  1267 01713 114C C        	CALL                WRITE_SPI_REG
  1268 01714 0000 C        	NOP
  1269 01715 182E C        	MOV                 A,@0X2E
  1270 01716 0070 C        	MOV                 ADDR,A
  1271 01717 1823 C        	MOV                 A,@0X23						;R2E[5]=1
  1272 01718 0071 C        	MOV                 VALUE,A
  1273 01719 114C C        	CALL                WRITE_SPI_REG
  1274 0171A 0000 C        	NOP
  1275 0171B 180E C        	MOV                 A,@0X0E
  1276 0171C 0070 C        	MOV                 ADDR,A
  1277 0171D 1891 C        	MOV                 A,@0X91						;RE[7]=1
  1278 0171E 0071 C        	MOV                 VALUE,A
  1279 0171F 114C C        	CALL                WRITE_SPI_REG
  1280 01720 0000 C        	NOP
  1281 01721 120C C        	CALL                Enter_RX_Buffer_ACK
  1282 01722 0000 C        	NOP
  1283 01723 1808 C        	MOV                 A,@8
  1284 01724 1301 C        	CALL                DELAY_X100US
  1285 01725 0000 C        	NOP
  1286 01726 184B C        	MOV                 A,@0X4B
  1287 01727 0070 C        	MOV                 ADDR,A
  1288 01728 1157 C        	CALL                READ_SPI_REG
  1289 01729 0000 C        	NOP
  1290 0172A 0C31 C        	JBC                 VALUE,0					;R4B[0]:LD=1,Analog Reg Initial is OK
  1291 0172B 172E C        	JMP                 Digit_Reg_Test
  1292 0172C 0B5D C        	BS                  RFTestfailFlag/16,RFTestfailFlag%16
  1293 0172D 1743 C        	JMP                 RF_TEST_RET
  1294 0172E      C          Digit_Reg_Test:
  1295 0172E 00D8 C        	CLR                 TABLE_INDEX
  1296 0172F      C          Check_Digit_Reg:
  1297 0172F 0418 C        	MOV                 A,TABLE_INDEX
  1298 01730 108C C        	CALL                RF_TABLE
  1299 01731 0000 C        	NOP
  1300 01732 0070 C        	MOV                 ADDR,A
  1301 01733 1BFF C        	XOR                 A, @0XFF
  1302 01734 0C83 C        	JBC                 STATUS,Z
  1303 01735 1743 C        	JMP                 RF_TEST_RET
  1304 01736 1157 C        	CALL                READ_SPI_REG
  1305 01737 0000 C        	NOP
  1306 01738 0558 C        	INC                 TABLE_INDEX
  1307 01739 0418 C        	MOV                 A,TABLE_INDEX
  1308 0173A 108C C        	CALL                RF_TABLE
  1309 0173B 0000 C        	NOP
  1310 0173C 0331 C        	XOR                 A,VALUE
  1311 0173D 0C83 C        	JBC                 STATUS,Z
  1312 0173E 1741 C        	JMP                 RF_TABLE_INC
  1313 0173F 0B5D C        	BS                  RFTestfailFlag/16,RFTestfailFlag%16
  1314 01740 1743 C        	JMP                 RF_TEST_RET
  1315 01741      C          RF_TABLE_INC:
  1316 01741 0558 C        	INC                 TABLE_INDEX
  1317 01742 172F C        	JMP                 Check_Digit_Reg
  1318 01743      C          RF_TEST_RET:
  1319 01743 0012 C        	RET
  1320            C        
  1321            C        
  1322            C        ;=====================================================================
  1323            C        ; BANK exchange function
  1324            C        ;=====================================================================
  1325 01744      C        PAGE5BANK0:
  1326 01744 09C4 C        	BC        0X04,7
  1327 01745 0984 C        	BC        0X04,6
  1328 01746 0012 C          RET
  1329 01747      C        PAGE5BANK1:
  1330 01747 09C4 C        	BC        0X04,7
  1331 01748 0B84 C        	BS        0X04,6
  1332 01749 0012 C          RET
  1333 0174A      C        PAGE5BANK2:
  1334 0174A 0BC4 C        	BS        0X04,7
  1335 0174B 0984 C        	BC        0X04,6
  1336 0174C 0012 C          RET
  1337 0174D      C        PAGE5BANK3:
  1338 0174D 0BC4 C        	BS        0X04,7
  1339 0174E 0B84 C        	BS        0X04,6
  1340 0174F 0012 C          RET
    19                     include "M611SkipFreqFunc.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;=========================================================================
    11            C        M611SkipFreqFunc.ASM    EQU    M611SkipFreqFunc.ASM
    12            C        
    13            C        ifndef M611rxP40.H
    14            C        include "M611rxP40.H"
    15            C        endif
    16            C        
    17            C        ifndef EM78CtrlIns.H
    18            C        include "EM78CtrlIns.H"
    19            C        endif
    20            C        ;=========================================================================
    21            C        
    22            C        
    23            C        
    24            C        	ORG                 0X200    ;PAGE 0
    25            C        	MESSAGE "define 'M611SKIPFREQFUN.ASM' ROM address"
***     USER MESSAGE: DEFINE 'M611SKIPFREQFUN.ASM' ROM ADDRESS
    26            C        ;=======================================================================
    27            C        ; Sync    Communication function
    28            C        ; input:  none
    29            C        ; output: none
    30            C        ;=======================================================================
    31 00200      C        SYNC_COM_TX:
    32 00200 0000 C        	NOP
    33 00201 0004 C        	WDTC
    34            C      M 	PAGE                5
       00202 0BC3     1     BS  3 , 7 
       00203 0983     1     BC  3 , 6 
       00204 0B43     1     BS  3 , 5 
    35            C        	;CALL                Enter_StandbyII_Mode
    36 00205 12AF C        	CALL                RF_FREQ_SET
    37 00206 11AD C        	CALL                Reset_RF_FIFO
    38            C      M 	PAGE                4
       00207 0BC3     1     BS  3 , 7 
       00208 0983     1     BC  3 , 6 
       00209 0943     1     BC  3 , 5 
    39 0020A 1000 C         	CALL                CommTypeScan_Func
    40            C      M  	PAGE                0
       0020B 09C3     1     BC  3 , 7 
       0020C 0983     1     BC  3 , 6 
       0020D 0943     1     BC  3 , 5 
    41            C        ;-----------------------------------------------------------------
    42 0020E 041B C        	MOV                 A,ComuClock                  ; ComuClock == 6 will continue
    43 0020F 1D00 C        	SUB                 A,@0
    44 00210 0C03 C        	JBC                 STATUS,C
    45 00211 160E C        	JMP                 $-3
    46            C        ;-----------------------------------------------------------------
    47            C        
    48            C        	;MOV                 A,@PKT_LEN                   ;16 Bytes length
    49            C        	;MOV                 DataByteLength,A
    50            C        
    51 00212 11C9 C        	CALL                PAGE0BANK0
    52 00213 1800 C        	MOV                 A,@0X00                      ;PID_DATA
    53 00214 0060 C        	MOV                 PID_DATA_Buffer,A
    54            C        
    55 00215 11CC C        	CALL                PAGE0BANK1
    56 00216 0421 C        	MOV                 A,RX_IDH			         ;RX_IDH
    57 00217 11C9 C        	CALL                PAGE0BANK0
    58 00218 0061 C        	MOV                 RX_IDH_Buffer,A
    59            C        
    60 00219 11CC C        	CALL                PAGE0BANK1
    61 0021A 0422 C        	MOV                 A,RX_IDL                     ;RX_IDL
    62 0021B 11C9 C        	CALL                PAGE0BANK0
    63 0021C 0062 C        	MOV                 RX_IDL_Buffer,A
    64            C        
    65 0021D 11CC C        	CALL                PAGE0BANK1
    66 0021E 0423 C        	MOV                 A,CHN_FLAG                   ;CHN_FLAG
    67 0021F 11C9 C        	CALL                PAGE0BANK0
    68 00220 0063 C        	MOV                 CHN_FLAG_Buffer,A
    69            C        
    70 00221 041E C        	MOV                 A,CommuStatusFlag            ;CommuStatusFlag
    71 00222 0064 C        	MOV                 CommuStatusFlag_Buffer,A
    72            C        
    73 00223 11CC C        	CALL                PAGE0BANK1
    74 00224 0424 C        	MOV                 A,DirectionCtrl              ;DirectionCtrl
    75 00225 11C9 C        	CALL                PAGE0BANK0
    76 00226 0065 C        	MOV                 DirectionCtrl_Buffer,A
    77            C        
    78 00227 11CC C        	CALL                PAGE0BANK1
    79 00228 1801 C        	MOV                 A,@TotalGamepads             ;N_CHN=(TotalGamepads << 4) | CH_NO
    80 00229 0065 C        	MOV                 N_CHN,A
    81 0022A 0765 C        	SWAP                N_CHN
    82 0022B 0432 C        	MOV                 A,CH_NO
    83 0022C 0265 C        	OR                  N_CHN,A
    84 0022D 0425 C        	MOV                 A,N_CHN                      ;CH_NO,  ;Current freqency NUM
    85 0022E 11C9 C        	CALL                PAGE0BANK0
    86 0022F 0066 C        	MOV                 N_CHN_Buffer,A
    87            C        
    88 00230 041E C        	MOV                 A,CommuStatusFlag            ;CommuStatusFlag
    89 00231 0064 C        	MOV                 CommuStatusFlag_Buffer,A
    90            C        
    91 00232 11CC C        	CALL                PAGE0BANK1
    92 00233 0424 C        	MOV                 A,DirectionCtrl              ;DirectionCtrl
    93 00234 11C9 C        	CALL                PAGE0BANK0
    94 00235 0065 C        	MOV                 DirectionCtrl_Buffer,A
    95            C        
    96 00236 11CC C        	CALL                PAGE0BANK1
    97 00237 0427 C        	MOV                 A,TX1_ID                     ;TX1_ID
    98 00238 11C9 C        	CALL                PAGE0BANK0
    99 00239 0067 C        	MOV                 TX1_ID_Buffer,A
   100            C        
   101 0023A 11CC C        	CALL                PAGE0BANK1
   102 0023B 0428 C        	MOV                 A,TX2_ID                     ;TX2_ID
   103 0023C 11C9 C        	CALL                PAGE0BANK0
   104 0023D 0068 C        	MOV                 TX2_ID_Buffer,A
   105            C        
   106 0023E 11CC C        	CALL                PAGE0BANK1
   107 0023F 0429 C        	MOV                 A,TX3_ID                     ;TX3_ID
   108 00240 11C9 C        	CALL                PAGE0BANK0
   109 00241 0069 C        	MOV                 TX3_ID_Buffer,A
   110            C        
   111 00242 11CC C        	CALL                PAGE0BANK1
   112 00243 042A C        	MOV                 A,TX4_ID                     ;TX4_ID
   113 00244 11C9 C        	CALL                PAGE0BANK0
   114 00245 006A C        	MOV                 TX4_ID_Buffer,A
   115            C        
   116 00246 11CC C        	CALL                PAGE0BANK1
   117 00247 042B C        	MOV                 A,TX5_ID                     ;TX5_ID
   118 00248 11C9 C        	CALL                PAGE0BANK0
   119 00249 006B C        	MOV                 TX5_ID_Buffer,A
   120            C        
   121 0024A 11CC C        	CALL                PAGE0BANK1
   122 0024B 042C C        	MOV                 A,TX6_ID                     ;TX6_ID
   123 0024C 11C9 C        	CALL                PAGE0BANK0
   124 0024D 006C C        	MOV                 TX6_ID_Buffer,A
   125            C        
   126            C        ;---------------------------------------------------------------------
   127 0024E 11C9 C        	CALL                PAGE0BANK0
   128 0024F 0430 C        	MOV                 A,GS_XPoint_LOW_Buffer
   129 00250 11CC C        	CALL                PAGE0BANK1
   130 00251 0079 C        	MOV                 GS_XPoint_LOW,A
   131            C        
   132 00252 11C9 C        	CALL                PAGE0BANK0
   133 00253 0431 C        	MOV                 A,GS_YPoint_LOW_Buffer
   134 00254 11CC C        	CALL                PAGE0BANK1
   135 00255 007A C        	MOV                 GS_YPoint_LOW,A
   136            C        
   137 00256 11C9 C        	CALL                PAGE0BANK0
   138 00257 0432 C        	MOV                 A,GS_ZPoint_LOW_Buffer
   139 00258 11CC C        	CALL                PAGE0BANK1
   140 00259 007B C        	MOV                 GS_ZPoint_LOW,A
   141            C        
   142 0025A 11C9 C        	CALL                PAGE0BANK0
   143 0025B 0433 C        	MOV                 A,GS_Point_HIGH_Buffer
   144 0025C 11CC C        	CALL                PAGE0BANK1
   145 0025D 007C C        	MOV                 GS_Point_HIGH,A
   146            C        
   147 0025E 11C9 C        	CALL                PAGE0BANK0
   148 0025F 0434 C        	MOV                 A,CMOS_XPoint_LOW_Buffer
   149 00260 11CC C        	CALL                PAGE0BANK1
   150 00261 007D C        	MOV                 CMOS_XPoint_LOW,A
   151            C        
   152 00262 11C9 C        	CALL                PAGE0BANK0
   153 00263 0435 C        	MOV                 A,CMOS_YPoint_LOW_Buffer
   154 00264 11CC C        	CALL                PAGE0BANK1
   155 00265 007E C        	MOV                 CMOS_YPoint_LOW,A
   156            C        
   157 00266 11C9 C        	CALL                PAGE0BANK0
   158 00267 0436 C        	MOV                 A,CMOS_Point_HIGH_Buffer
   159 00268 11CC C        	CALL                PAGE0BANK1
   160 00269 007F C        	MOV                 CMOS_Point_HIGH,A
   161            C        
   162            C        ;-------------------------------------------------------------------
   163 0026A 1807 C        	MOV                 A,@7	
   164            C      M 	PAGE                5
       0026B 0BC3     1     BS  3 , 7 
       0026C 0983     1     BC  3 , 6 
       0026D 0B43     1     BS  3 , 5 
   165 0026E 1301 C        	CALL                DELAY_X100US
   166 0026F 11CA C        	CALL                Enter_TX_Buffer_NACK
   167 00270 119B C        	CALL                Write_FIFO_RAM
   168            C      M 	PAGE                0
       00271 09C3     1     BC  3 , 7 
       00272 0983     1     BC  3 , 6 
       00273 0943     1     BC  3 , 5 
   169            C        ;---------------------------------------------------------------------------------
   170 00274 18D1 C        	MOV                 A,@(256-47)               ; N=47,P=64,f=4MHz ==> T=1ms
   171 00275 0041 C        	MOV                 TCC,A                     ; TCC reload by PKT pull high
   172            C        	;MOV                 A,@0X80                   ; (test)P57 exchange when intrrupt
   173            C        	;XOR                 PORT5,A
   174 00276 00DB C        	CLR                 ComuClock                 ; ComuClock = 0
   175            C        ;-----------------------------------------------------------------------------------
   176 00277 0000 C        	NOP
   177 00278 0012 C        	RET
   178 00279 0000 C        	NOP
   179            C        
   180            C        ;*****************************************************************
   181            C        ;Function:    mode select
   182            C        ;Input:
   183            C        ;Output:      None
   184            C        ;desciption:  set timing and select mode
   185            C        ;*****************************************************************
   186 0027A      C        SearchLinkMode_Set: ;0x11
   187 0027A 0A1E C        	BS                  SearchStatusFlag/16,SearchStatusFlag%16            ;set search mode
   188 0027B 085E C        	BC                  NormalStatusFlag/16,NormalStatusFlag%16            ;Clear normal mode
   189 0027C 08DE C        	BC                  EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   190 0027D 0B1E C        	BS                  LinkModeFlag/16,LinkModeFlag%16
   191 0027E 095E C        	BC                  ForceLinkModeFlag/16,ForceLinkModeFlag%16
   192 0027F 099E C        	BC                  FccTestModeFlag/16,FccTestModeFlag%16
   193 00280 0012 C        	RET
   194 00281      C        NormalLinkMode_Set: ;0x12
   195 00281 081E C        	BC                  SearchStatusFlag/16,SearchStatusFlag%16            ;set search mode
   196 00282 0A5E C        	BS                  NormalStatusFlag/16,NormalStatusFlag%16            ;Clear normal mode
   197 00283 08DE C        	BC                  EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   198 00284 0B1E C        	BS                  LinkModeFlag/16,LinkModeFlag%16
   199 00285 095E C        	BC                  ForceLinkModeFlag/16,ForceLinkModeFlag%16
   200 00286 099E C        	BC                  FccTestModeFlag/16,FccTestModeFlag%16
   201 00287 0012 C        	RET
   202 00288      C        SearchForceLinkMode_Set: ;0x21
   203 00288 0A1E C        	BS                  SearchStatusFlag/16,SearchStatusFlag%16            ;set search mode
   204 00289 085E C        	BC                  NormalStatusFlag/16,NormalStatusFlag%16            ;Clear normal mode
   205 0028A 08DE C        	BC                  EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   206 0028B 091E C        	BC                  LinkModeFlag/16,LinkModeFlag%16
   207 0028C 0B5E C        	BS                  ForceLinkModeFlag/16,ForceLinkModeFlag%16
   208 0028D 099E C        	BC                  FccTestModeFlag/16,FccTestModeFlag%16
   209 0028E 0012 C        	RET
   210 0028F      C        NormalFccLinkMode_Set: ;0x42
   211 0028F 081E C        	BC                  SearchStatusFlag/16,SearchStatusFlag%16            ;set search mode
   212 00290 0A5E C        	BS                  NormalStatusFlag/16,NormalStatusFlag%16            ;Clear normal mode
   213 00291 08DE C        	BC                  EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   214 00292 091E C        	BC                  LinkModeFlag/16,LinkModeFlag%16
   215 00293 095E C        	BC                  ForceLinkModeFlag/16,ForceLinkModeFlag%16
   216 00294 0B9E C        	BS                  FccTestModeFlag/16,FccTestModeFlag%16
   217 00295 0012 C        	RET
   218            C        
   219            C        
   220            C        
   221            C        ;***************************************************************************
   222            C        ; gamepad skip frequency RX1-RX4
   223            C        ;***************************************************************************
   224            C        	ORG                 0X400    ;PAGE 1
   225            C        ;========================================================================
   226            C        ;=========================================================================
   227            C        ;Function:  setting
   228            C        ;Input:
   229            C        ;Output:    None
   230            C        ;=========================================================================
   231 00400      C        RX1_FUNCTION:
   232 00400 0004 C        	WDTC
   233            C      M 	PAGE                5
       00401 0BC3     1     BS  3 , 7 
       00402 0983     1     BC  3 , 6 
       00403 0B43     1     BS  3 , 5 
   234 00404 11AD C        	CALL                RESET_RF_FIFO
   235            C        	;CALL                Enter_StandbyII_Mode
   236 00405 120C C        	CALL                ENTER_RX_BUFFER_ACK
   237            C      M 	PAGE                1
       00406 09C3     1     BC  3 , 7 
       00407 0983     1     BC  3 , 6 
       00408 0B43     1     BS  3 , 5 
   238            C        
   239 00409      C          RX1_DETECT_LOOP:
   240 00409 041B C        	MOV                 A,ComuClock                  ;ComuClock == 4 will continue
   241 0040A 1D03 C        	SUB                 A,@3
   242 0040B 0E03 C        	JBS                 STATUS,C
   243 0040C 1450 C        	JMP                 Rx1_Detect_Timeout           ; RX1,Timeout but have not received TX data
   244 0040D 0F86 C        	JBS                 PKT_FLAG/16,PKT_FLAG%16	     ; 1:TX data receive finished  0:wating PKT pull high
   245 0040E 1409 C        	JMP                 RX1_DETECT_LOOP
   246 0040F 0000 C        	NOP
   247            C      M 	PAGE                5
       00410 0BC3     1     BS  3 , 7 
       00411 0983     1     BC  3 , 6 
       00412 0B43     1     BS  3 , 5 
   248 00413 1188 C        	CALL                READ_FIFO_RAM
   249 00414 1265 C        	CALL                Enter_StandbyI_Mode
   250            C      M 	PAGE                1
       00415 09C3     1     BC  3 , 7 
       00416 0983     1     BC  3 , 6 
       00417 0B43     1     BS  3 , 5 
   251            C        
   252            C        ;------------------- check sync imformation ---------------------
   253 00418 1082 C        	CALL                PAGE1BANK1
   254 00419 0421 C        	MOV                 A,RX_IDH
   255 0041A 107F C        	CALL                PAGE1BANK0
   256 0041B 0361 C        	XOR                 RX_IDH_Buffer,A
   257 0041C 0E83 C        	JBS                 STATUS,Z
   258 0041D 145C C        	JMP                 LoseFrameStatus_RxTxID1_Error
   259 0041E 1082 C        	CALL                PAGE1BANK1
   260 0041F 0422 C        	MOV                 A,RX_IDL
   261 00420 107F C        	CALL                PAGE1BANK0
   262 00421 0362 C        	XOR                 RX_IDL_Buffer,A
   263 00422 0E83 C        	JBS                 STATUS,Z
   264 00423 145C C        	JMP                 LoseFrameStatus_RxTxID1_Error
   265 00424 1082 C        	CALL                PAGE1BANK1
   266 00425 0427 C        	MOV                 A,TX1_ID
   267 00426 107F C        	CALL                PAGE1BANK0
   268 00427 0366 C        	XOR                 TX_ID_Buffer,A
   269 00428 0E83 C        	JBS                 STATUS,Z
   270 00429 145C C        	JMP                 LoseFrameStatus_RxTxID1_Error
   271            C        
   272            C        ;---------------------------------------------------------------
   273 0042A 107F C        	CALL                PAGE1BANK0                       ; Save data from buffer to local
   274 0042B 0427 C        	MOV                 A,DataA_Buffer
   275 0042C 1085 C        	CALL                PAGE1BANK2
   276 0042D 0060 C        	MOV                 TX1_DATA1,A
   277            C        
   278 0042E 107F C        	CALL                PAGE1BANK0
   279 0042F 0428 C        	MOV                 A,DataB_Buffer
   280 00430 1085 C        	CALL                PAGE1BANK2
   281 00431 0061 C        	MOV                 TX1_DATA2,A
   282            C        
   283 00432 107F C        	CALL                PAGE1BANK0
   284 00433 0429 C        	MOV                 A,DataC_Buffer
   285 00434 1085 C        	CALL                PAGE1BANK2
   286 00435 0062 C        	MOV                 TX1_DATA3,A
   287            C        
   288 00436 107F C        	CALL                PAGE1BANK0
   289 00437 042A C        	MOV                 A,DataD_Buffer
   290 00438 1085 C        	CALL                PAGE1BANK2
   291 00439 0063 C        	MOV                 TX1_DATA4,A
   292            C        
   293 0043A 107F C        	CALL                PAGE1BANK0
   294 0043B 042B C        	MOV                 A,DataE_Buffer
   295 0043C 1085 C        	CALL                PAGE1BANK2
   296 0043D 0064 C        	MOV                 TX1_DATA5,A
   297            C        
   298 0043E 107F C        	CALL                PAGE1BANK0
   299 0043F 042C C        	MOV                 A,DataF_Buffer
   300 00440 1085 C        	CALL                PAGE1BANK2
   301 00441 0065 C        	MOV                 TX1_DATA6,A
   302            C        
   303 00442 107F C        	CALL                PAGE1BANK0
   304 00443 042D C        	MOV                 A,DataG_Buffer
   305 00444 1085 C        	CALL                PAGE1BANK2
   306 00445 0066 C        	MOV                 TX1_DATA7,A
   307            C        
   308            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   309            C        	;XOR                 PORT5,A	
   310            C        
   311 00446 1082 C        	CALL                PAGE1BANK1
   312 00447 0A23 C        	BS                  CHN_FLAG,RX1
   313 00448 0F5E C        	JBS                 ForceLinkModeFlag/16,ForceLinkModeFlag%16
   314 00449 146A C        	JMP                 EP1_REPORT_RX1
   315 0044A 0C2E C        	JBC                 CHN_FLAG_TEMP,RX1                           ; CHN_FLAG rising edge
   316 0044B 1471 C        	JMP                 Clear_RX1_LossframeCNT
   317 0044C 08C9 C        	BC                  LED1_STATUS/16,LED1_STATUS%16             ;
   318 0044D 00D7 C        	CLR                 SystemTimeCNT
   319 0044E 1471 C        	JMP                 Clear_RX1_LossframeCNT
   320 0044F 0000 C        	NOP
   321            C        
   322            C        ;-------------------------------------------------------------------------
   323 00450      C          Rx1_Detect_Timeout:
   324 00450 0000 C        	NOP
   325 00451 1082 C        	CALL                PAGE1BANK1
   326 00452 0E23 C        	JBS                 CHN_FLAG,RX1                                ; Lossframe Status
   327 00453 1471 C        	JMP                 Clear_RX1_LossframeCNT                    ; if not SearchStatus,it must be in NormalStatus
   328 00454 0439 C        	MOV                 A,RX1_LossframeCNT                        ; result = constant - variable
   329 00455 1D05 C        	SUB                 A,@RX1_LossframeSum                       ;   | result > 0   c=1  variable less than constant
   330 00456 0C03 C        	JBC                 STATUS,C	                              ;   | result < 0   c=0  variable more than constant
   331 00457 1467 C        	JMP                 Increase_RX1_LossframeCNT
   332 00458 0F5E C        	JBS                 ForceLinkModeFlag/16,ForceLinkModeFlag%16
   333 00459 0823 C        	BC                  CHN_FLAG,RX1
   334 0045A 1471 C        	JMP                 Clear_RX1_LossframeCNT
   335 0045B 0000 C        	NOP
   336            C        ;-----------------------------------------------------------------------------
   337 0045C      C          LoseFrameStatus_RxTxID1_Error:
   338 0045C 1082 C        	CALL                PAGE1BANK1
   339 0045D 0E23 C        	JBS                 CHN_FLAG,RX1
   340 0045E 1471 C        	JMP                 Clear_RX1_LossframeCNT
   341 0045F 0439 C        	MOV                 A,RX1_LossframeCNT                       ; RX1_LossframeSum times lossframe
   342 00460 1D05 C        	SUB                 A,@RX1_LossframeSum
   343 00461 0C03 C        	JBC                 STATUS,C
   344 00462 1467 C        	JMP                 Increase_RX1_LossframeCNT
   345 00463 0F5E C        	JBS                 ForceLinkModeFlag/16,ForceLinkModeFlag%16
   346 00464 0823 C        	BC                  CHN_FLAG,RX1
   347 00465 1471 C        	JMP                 Clear_RX1_LossframeCNT
   348 00466 0000 C        	NOP
   349            C        
   350            C        ;--------------------------------------------------------------------------------
   351 00467      C          Increase_RX1_LossframeCNT:
   352 00467 0579 C        	INC                 RX1_LossframeCNT
   353 00468 1472 C        	JMP                 RX1_Over_Judge
   354 00469 0000 C        	NOP
   355 0046A      C          EP1_REPORT_RX1:
   356            C      M 	PAGE                4
       0046A 0BC3     1     BS  3 , 7 
       0046B 0983     1     BC  3 , 6 
       0046C 0943     1     BC  3 , 5 
   357 0046D 1314 C        	CALL                EP1_Report_1st
   358            C      M 	PAGE                1
       0046E 09C3     1     BC  3 , 7 
       0046F 0983     1     BC  3 , 6 
       00470 0B43     1     BS  3 , 5 
   359 00471      C          Clear_RX1_LossframeCNT:
   360 00471 00F9 C        	CLR                 RX1_LossframeCNT
   361 00472      C          RX1_Over_Judge:
   362 00472 041B C        	MOV                 A,ComuClock                  ; ComuClock == 4 will continue
   363 00473 1D03 C        	SUB                 A,@3
   364 00474 0C03 C        	JBC                 STATUS,C
   365 00475 1472 C        	JMP                 $-3
   366 00476 0B06 C        	BS                  SPI_SS/16,SPI_SS%16          ; Dissable RF
   367 00477 0000 C        	NOP
   368 00478 00DB C        	CLR                 ComuClock
   369 00479 0000 C        	NOP
   370 0047A 0012 C        	RET
   371 0047B 0000 C        	NOP
   372            C        
   373            C        
   374            C        
   375            C        ;========================================================================
   376            C        ;=========================================================================
   377            C        ;Function:  setting
   378            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   379            C        ;Output:    None
   380            C        ;=========================================================================
   381 0047C      C        RX2_FUNCTION:
   382            C        
   383 0047C 0012 C        	RET
   384            C        
   385            C        
   386            C        
   387            C        ;========================================================================
   388            C        ;=========================================================================
   389            C        ;Function:  setting
   390            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   391            C        ;Output:    None
   392            C        ;=========================================================================
   393 0047D      C        RX3_FUNCTION:
   394            C        
   395 0047D 0012 C        	RET
   396            C        
   397            C        
   398            C        ;========================================================================
   399            C        ;=========================================================================
   400            C        ;Function:  setting
   401            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   402            C        ;Output:    None
   403            C        ;=========================================================================
   404 0047E      C        RX4_FUNCTION:
   405            C        
   406 0047E 0012 C        	RET
   407            C        
   408            C        ;=====================================================================
   409            C        ; BANK exchange function
   410            C        ;=====================================================================
   411 0047F      C        	PAGE1BANK0:
   412 0047F 09C4 C        		BC              0X04,7
   413 00480 0984 C        		BC              0X04,6
   414 00481 0012 C        	RET
   415 00482      C        	PAGE1BANK1:
   416 00482 09C4 C        		BC              0X04,7
   417 00483 0B84 C        		BS              0X04,6
   418 00484 0012 C        	RET
   419 00485      C        	PAGE1BANK2:
   420 00485 0BC4 C        		BS              0X04,7
   421 00486 0984 C        		BC              0X04,6
   422 00487 0012 C        	RET
   423 00488      C        	PAGE1BANK3:
   424 00488 0BC4 C        		BS              0X04,7
   425 00489 0B84 C        		BS              0X04,6
   426 0048A 0012 C        	RET
   427            C        
   428            C        
   429            C        
   430            C        ;***************************************************************************
   431            C        ; gamepad skip frequency RX5-RX8
   432            C        ;***************************************************************************
   433            C        	ORG                 0X800   ;PAGE 2
   434            C        ;========================================================================
   435            C        ;=========================================================================
   436            C        ;Function:  setting
   437            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   438            C        ;Output:    None
   439            C        ;=========================================================================
   440 00800      C        RX5_FUNCTION:
   441            C        
   442 00800 0012 C        	RET
   443            C        
   444            C        
   445            C        
   446            C        
   447            C        ;========================================================================
   448            C        ;=========================================================================
   449            C        ;Function:  setting
   450            C        ;Input:     LossFrameCNTCNT,LossFreqCNT,DataBaseAddress
   451            C        ;Output:    None
   452            C        ;=========================================================================
   453 00801      C        RX6_FUNCTION:
   454            C        
   455 00801 0012 C        	RET
   456            C        
   457            C        
   458            C        
   459            C        ;=====================================================================
   460            C        ; BANK exchange function
   461            C        ;=====================================================================
   462 00802      C        	PAGE2BANK0:
   463 00802 09C4 C        		BC              0X04,7
   464 00803 0984 C        		BC              0X04,6
   465 00804 0012 C        	RET
   466 00805      C        	PAGE2BANK1:
   467 00805 09C4 C        		BC              0X04,7
   468 00806 0B84 C        		BS              0X04,6
   469 00807 0012 C        	RET
   470 00808      C        	PAGE2BANK2:
   471 00808 0BC4 C        		BS              0X04,7
   472 00809 0984 C        		BC              0X04,6
   473 0080A 0012 C        	RET
   474 0080B      C        	PAGE2BANK3:
   475 0080B 0BC4 C        		BS              0X04,7
   476 0080C 0B84 C        		BS              0X04,6
   477 0080D 0012 C        	RET
    20                     include "M611ManageFunc.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;=========================================================================
    11            C        M611ManageFunc.ASM    EQU    M611ManageFunc.ASM
    12            C        
    13            C        include "M611USBDriver.ASM"
     1            C        ;==================================================================
     2            C        ; Filename     :  EM78M611
     3            C        ; Author       :  yu.wei
     4            C        ; Company      :  ELAN
     5            C        ; VERSION      :  1.1
     6            C        ; CRYSTAL      :  6MHZ
     7            C        ; Creat date   :  2009/11/4
     8            C        ; tool ver.    :  eUIDE
     9            C        ; Description  :  modify for code conformity
    10            C        ;=========================================================================
    11            C        M611USBDriver.ASM    EQU    M611USBDriver.ASM
    12            C        
    13            C        
    14            C        include "M611USBDescData.ASM"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        M611USBDescData.ASM    EQU    M611USBDescData.ASM
    12            C        
    13            C        
    14            C        ;********************************************************************************
    15            C        ; initial USB communiate to PC,INITIAL
    16            C        ;********************************************************************************
    17            C        ;============================================================
    18            C        ;	DESCRIPTORS
    19            C        ;============================================================
    20            C        
    21            C        		ORG 	0XC00	;PAGE 3
    22 00C00      C        DEVICE_TABLE:
    23 00C00 0020 C        		TBL
    24            C        		;Device Descriptor
    25 00C01 1C12 C        		RETL	@0X12;01	bLength
    26 00C02 1C01 C        		RETL	@0X01;02	bDescriptorType
    27 00C03 1C10 C        		RETL	@0X10;03	bcdUSB
    28 00C04 1C01 C        		RETL	@0X01;04
    29 00C05 1C00 C        		RETL	@0X00;05	bDeviceCalss
    30 00C06 1C00 C        		RETL	@0X00;06	bDeviceSubClass
    31 00C07 1C00 C        		RETL	@0X00;07	bDeviceProtocol
    32 00C08 1C08 C        		RETL	@0X08;08	bMaxPacketSize0 ,MCU point0 byte length
    33 00C09 1CF3 C        		RETL	@0XF3;09	idVendor 0X04F3
    34 00C0A 1C04 C        		RETL	@0X04;0A
    35 00C0B 1C1F C        		RETL	@0X1F;0B	idProduct (joystick:0x0f1f)
    36 00C0C 1C0F C        		RETL	@0X0F;0C
    37 00C0D 1C70 C        		RETL	@0X70;0D	bcdDevice v1.7.0
    38 00C0E 1C01 C        		RETL	@0X01;0E
    39 00C0F 1C01 C        		RETL	@0X01;0F	iManufacturer
    40 00C10 1C02 C        		RETL	@0X02;10	iProduct
    41 00C11 1C03 C        		RETL	@0X03;11	iSerialNumber
    42 00C12 1C01 C        		RETL	@0X01;12	bNumConfigurations
    43            C        
    44            C        
    45 00C13      C        CONFIG_TABLE:
    46 00C13 0020 C        		TBL
    47            C        		;Configuration Descriptor
    48 00C14 1C09 C        		RETL	@0X09;01	bLength
    49 00C15 1C02 C        		RETL	@0X02;02	bDescritorType
    50 00C16 1C22 C        		RETL	@0X22;03	wTotalLength
    51 00C17 1C00 C        		RETL	@0X00;04
    52 00C18 1C01 C        		RETL	@0X01;05	bConfigurationValue
    53 00C19 1C01 C        		RETL	@0X01;06	bNumInterfaces
    54 00C1A 1C00 C        		RETL	@0X00;07	iConfiguration
    55 00C1B 1C80 C        		RETL	@0X80;08	bmAttributes
    56 00C1C 1C32 C        		RETL	@0X32;09	bMaxPower ,Imax=100mA
    57            C        
    58            C        		;Interface Descriptor
    59 00C1D 1C09 C        		RETL	@0X09;0A	bLength
    60 00C1E 1C04 C        		RETL	@0X04;0B	bDescriptorType
    61 00C1F 1C00 C        		RETL	@0X00;0C	bInterfaceNumber
    62 00C20 1C00 C        		RETL	@0X00;0D	bAlternateSetting
    63 00C21 1C01 C        		RETL	@0X01;0E	bNumEndpoints
    64 00C22 1C03 C        		RETL	@0X03;0F	bInterfaceClass (Class:HID)
    65 00C23 1C00 C        		RETL	@0X00;10	bInterfaceSubClass (BOOT DEVICE)
    66 00C24 1C00 C        		RETL	@0X00;11	bInterfaceProtocol (joystick)
    67 00C25 1C00 C        		RETL	@0X00;12	iConfiguration
    68            C        
    69            C        		;HID Descriptor
    70 00C26 1C09 C        		RETL	@0X09            ;13    bLength
    71 00C27 1C21 C        		RETL	@0X21            ;14    bDescriptorType
    72 00C28 1C10 C        		RETL	@0X10            ;15    bcdHID
    73 00C29 1C01 C        		RETL	@0X01            ;16
    74 00C2A 1C21 C        		RETL	@0X21            ;17    bCountryCode
    75 00C2B 1C01 C        		RETL	@0X01            ;18    bNumDescriptors
    76 00C2C 1C22 C        		RETL	@0X22            ;19    bDescriptorType. report descriptor:0x22, physics descriptor:0x23
    77            C                                                ;1A    bLength of the Report Descriptor ;0XF8
    78 00C2D 1CD4 C        		RETL	@(End_HID_Report_Table1-Begin_HID_Report_Table1)+(End_HID_Report_Table2-Begin_HID_Report_HID_Report_Table3)-0X100
    79 00C2E 1C01 C        		RETL	@0X01            ;1B    ;0X01
    80            C        
    81            C        		;Endpoint Descriptor
    82 00C2F 1C07 C        		RETL	@0X07;1C	bLength
    83 00C30 1C05 C        		RETL	@0X05;1D	bDescriptorType
    84 00C31 1C81 C        		RETL	@0X81;1E	bEndpointAddress
    85 00C32 1C03 C        		RETL	@0X03;1F	bmAttributes
    86 00C33 1C08 C        		RETL	@0X08;20	wMaxPackerSize
    87 00C34 1C00 C        		RETL	@0X00;21
    88 00C35 1C05 C        		RETL	@0X05;22	bInterval    ;change 20ms
    89            C        
    90            C        
    91            C        ;---------------------------------------------------------------------
    92            C        ;---------------------------------------------------------------------
    93 00C36      C        STRING0T:
    94            C        		;String Descriptor Of Languages
    95 00C36 0020 C        		TBL
    96 00C37 1C04 C        		RETL	@0X04;01	bLength
    97 00C38 1C03 C        		RETL	@0X03;02	bdescriptorType
    98 00C39 1C09 C        		RETL	@0X09;03
    99 00C3A 1C04 C        		RETL	@0X04;04	END OF LANGUAGES
   100            C        
   101            C        
   102            C        ;---------------------------------------------------------------------
   103            C        ;---------------------------------------------------------------------
   104            C        		ORG         0XD00
   105 00D00      C        HID_REPORT_TABLE1:
   106 00D00 0020 C        		TBL
   107 00D01      C        	Begin_HID_Report_Table1:
   108            C        ;----------------------------------------------------------
   109            C        	;--REPORT DESCRIPTOR--
   110 00D01 1C05 C        	RETL @0X05    ;USAGE PAGE
   111 00D02 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   112 00D03 1C09 C        	RETL @0X09    ;USAGE
   113 00D04 1C04 C        	RETL @0X04    ;(JOYSTICK)
   114            C        	;{
   115 00D05 1CA1 C        		RETL @0XA1    ;COLLECTION
   116 00D06 1C01 C        		RETL @0X01    ;(APPLICATION)
   117 00D07 1C85 C        		RETL @0X85    ;REPORT ID
   118 00D08 1C01 C        		RETL @0X01
   119            C        		;{
   120            C        		;{X,Y,Z,Rz
   121 00D09 1CA1 C        			RETL	@0XA1    ;Collection
   122 00D0A 1C02 C        			RETL	@0X02    ;Logical
   123 00D0B 1C09 C        			RETL	@0X09    ;USAGE
   124 00D0C 1C30 C        			RETL	@0X30    ;(X)
   125 00D0D 1C09 C        			RETL	@0X09    ;USAGE
   126 00D0E 1C31 C        			RETL	@0X31    ;(Y)
   127 00D0F 1C09 C        			RETL	@0X09    ;USAGE
   128 00D10 1C35 C        			RETL	@0X35    ;(Rz)
   129 00D11 1C09 C        			RETL	@0X09    ;USAGE
   130 00D12 1C32 C        			RETL	@0X32    ;(Z)
   131 00D13 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   132 00D14 1C00 C        			RETL	@0X00    ;(0)
   133 00D15 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   134 00D16 1CFF C        			RETL	@0XFF    ;(FF)
   135 00D17 1C00 C        			RETL	@0X00
   136 00D18 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   137 00D19 1C00 C        			RETL	@0X00    ;(0)
   138 00D1A 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   139 00D1B 1CFF C        			RETL	@0XFF    ;(FF)
   140 00D1C 1C00 C        			RETL	@0X00
   141 00D1D 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   142 00D1E 1C08 C        			RETL	@0X08    ;(8)
   143 00D1F 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   144 00D20 1C04 C        			RETL	@0X04    ;(4)
   145 00D21 1C81 C        			RETL	@0X81    ;INPUT
   146 00D22 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   147            C        		;}
   148            C        		;{Button
   149 00D23 1C05 C        			RETL @0X05    ;USAGE_PAGE
   150 00D24 1C09 C        			RETL @0X09    ;(Button)
   151 00D25 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   152 00D26 1C01 C        			RETL @0X01    ;(BUTTON 1)
   153 00D27 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   154 00D28 1C10 C        			RETL @0X10    ;(BUTTON 16)
   155 00D29 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   156 00D2A 1C01 C        			RETL @0X01    ;(1)
   157 00D2B 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   158 00D2C 1C01 C        			RETL @0X01    ;(1)
   159 00D2D 1C75 C        			RETL @0X75    ;REPORT_SIZE
   160 00D2E 1C01 C        			RETL @0X01    ;(1)
   161 00D2F 1C95 C        			RETL @0X95    ;REPORT_COUNT
   162 00D30 1C10 C        			RETL @0X10    ;(16)
   163 00D31 1C81 C        			RETL @0X81    ;INPUT
   164 00D32 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   165            C        		;}
   166            C        		;{Hat Switch
   167 00D33 1C06 C        			RETL @0X06
   168 00D34 1C01 C        			RETL @0X01
   169 00D35 1C00 C        			RETL @0X00
   170 00D36 1C09 C        			RETL @0X09    ;USAGE
   171 00D37 1C39 C        			RETL @0X39    ;(Hat Switch)
   172 00D38 1C75 C        			RETL @0X75    ;REPORT_SIZE
   173 00D39 1C04 C        			RETL @0X04    ;(4)
   174 00D3A 1C95 C        			RETL @0X95    ;REPORT_COUNT
   175 00D3B 1C01 C        			RETL @0X01    ;(1)
   176 00D3C 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   177 00D3D 1C07 C        			RETL @0X07    ;(7)
   178 00D3E 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   179 00D3F 1C3B C        			RETL @0X3B    ;(315)
   180 00D40 1C01 C        			RETL @0X01
   181 00D41 1C65 C        			RETL @0X65    ;UNIT
   182 00D42 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   183 00D43 1C81 C        			RETL @0X81    ;INPUT
   184 00D44 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   185            C        		;}
   186            C        		;{Const
   187 00D45 1C65 C        			RETL @0X65    ;UNIT
   188 00D46 1C00 C        			RETL @0X00    ;(None)
   189 00D47 1C75 C        			RETL @0X75    ;REPORT_SIZE
   190 00D48 1C04 C        			RETL @0X04    ;(4)
   191 00D49 1C95 C        			RETL @0X95    ;REPORT_COUNT
   192 00D4A 1C01 C        			RETL @0X01    ;(1)
   193 00D4B 1C81 C        			RETL @0X81    ;INPUT
   194 00D4C 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   195 00D4D 1CC0 C        			RETL @0XC0    ;END COLLECTION
   196            C        		;}
   197            C        	;}
   198 00D4E 1CC0 C          RETL @0XC0              ;78;END COLLECTION
   199            C        
   200            C        ;----------------------------------------------------
   201            C        	;--REPORT DESCRIPTOR--
   202 00D4F 1C05 C        	RETL @0X05    ;USAGE PAGE
   203 00D50 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   204 00D51 1C09 C        	RETL @0X09    ;USAGE
   205 00D52 1C04 C        	RETL @0X04    ;(JOYSTICK)
   206            C        	;{
   207 00D53 1CA1 C        		RETL @0XA1    ;COLLECTION
   208 00D54 1C01 C        		RETL @0X01    ;(APPLICATION)
   209 00D55 1C85 C        		RETL @0X85    ;REPORT ID
   210 00D56 1C02 C        		RETL @0X02
   211            C        		;{
   212            C        		;{X,Y,Z,Rz
   213 00D57 1CA1 C        			RETL	@0XA1    ;Collection
   214 00D58 1C02 C        			RETL	@0X02    ;Logical
   215 00D59 1C09 C        			RETL	@0X09    ;USAGE
   216 00D5A 1C30 C        			RETL	@0X30    ;(X)
   217 00D5B 1C09 C        			RETL	@0X09    ;USAGE
   218 00D5C 1C31 C        			RETL	@0X31    ;(Y)
   219 00D5D 1C09 C        			RETL	@0X09    ;USAGE
   220 00D5E 1C35 C        			RETL	@0X35    ;(Rz)
   221 00D5F 1C09 C        			RETL	@0X09    ;USAGE
   222 00D60 1C32 C        			RETL	@0X32    ;(Z)
   223 00D61 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   224 00D62 1C00 C        			RETL	@0X00    ;(0)
   225 00D63 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   226 00D64 1CFF C        			RETL	@0XFF    ;(FF)
   227 00D65 1C00 C        			RETL	@0X00
   228 00D66 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   229 00D67 1C00 C        			RETL	@0X00    ;(0)
   230 00D68 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   231 00D69 1CFF C        			RETL	@0XFF    ;(FF)
   232 00D6A 1C00 C        			RETL	@0X00
   233 00D6B 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   234 00D6C 1C08 C        			RETL	@0X08    ;(8)
   235 00D6D 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   236 00D6E 1C04 C        			RETL	@0X04    ;(4)
   237 00D6F 1C81 C        			RETL	@0X81    ;INPUT
   238 00D70 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   239            C        		;}
   240            C        		;{Button
   241 00D71 1C05 C        			RETL @0X05    ;USAGE_PAGE
   242 00D72 1C09 C        			RETL @0X09    ;(Button)
   243 00D73 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   244 00D74 1C01 C        			RETL @0X01    ;(BUTTON 1)
   245 00D75 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   246 00D76 1C10 C        			RETL @0X10    ;(BUTTON 16)
   247 00D77 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   248 00D78 1C01 C        			RETL @0X01    ;(1)
   249 00D79 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   250 00D7A 1C01 C        			RETL @0X01    ;(1)
   251 00D7B 1C75 C        			RETL @0X75    ;REPORT_SIZE
   252 00D7C 1C01 C        			RETL @0X01    ;(1)
   253 00D7D 1C95 C        			RETL @0X95    ;REPORT_COUNT
   254 00D7E 1C10 C        			RETL @0X10    ;(16)
   255 00D7F 1C81 C        			RETL @0X81    ;INPUT
   256 00D80 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   257            C        		;}
   258            C        		;{Hat Switch
   259 00D81 1C06 C        			RETL @0X06
   260 00D82 1C01 C        			RETL @0X01
   261 00D83 1C00 C        			RETL @0X00
   262 00D84 1C09 C        			RETL @0X09    ;USAGE
   263 00D85 1C39 C        			RETL @0X39    ;(Hat Switch)
   264 00D86 1C75 C        			RETL @0X75    ;REPORT_SIZE
   265 00D87 1C04 C        			RETL @0X04    ;(4)
   266 00D88 1C95 C        			RETL @0X95    ;REPORT_COUNT
   267 00D89 1C01 C        			RETL @0X01    ;(1)
   268 00D8A 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   269 00D8B 1C07 C        			RETL @0X07    ;(7)
   270 00D8C 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   271 00D8D 1C3B C        			RETL @0X3B    ;(315)
   272 00D8E 1C01 C        			RETL @0X01
   273 00D8F 1C65 C        			RETL @0X65    ;UNIT
   274 00D90 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   275 00D91 1C81 C        			RETL @0X81    ;INPUT
   276 00D92 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   277            C        		;}
   278            C        		;{Const
   279 00D93 1C65 C        			RETL @0X65    ;UNIT
   280 00D94 1C00 C        			RETL @0X00    ;(None)
   281 00D95 1C75 C        			RETL @0X75    ;REPORT_SIZE
   282 00D96 1C04 C        			RETL @0X04    ;(4)
   283 00D97 1C95 C        			RETL @0X95    ;REPORT_COUNT
   284 00D98 1C01 C        			RETL @0X01    ;(1)
   285 00D99 1C81 C        			RETL @0X81    ;INPUT
   286 00D9A 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   287 00D9B 1CC0 C        			RETL @0XC0    ;END COLLECTION
   288            C        		;}
   289            C        	;}
   290 00D9C 1CC0 C        	RETL @0XC0              ;78;END COLLECTION
   291 00D9D      C        	End_HID_Report_Table1:
   292            C        
   293            C        ;---------------------------------------------------------------------
   294            C        ;---------------------------------------------------------------------
   295            C        		ORG         0XE00
   296 00E00      C        HID_REPORT_TABLE2:
   297 00E00 0020 C        		TBL
   298 00E01      C        	Begin_HID_Report_Table2:
   299            C        ;-------------------------------------------------------
   300            C        	;--REPORT DESCRIPTOR--
   301 00E01 1C05 C        		RETL @0X05    ;USAGE PAGE
   302 00E02 1C01 C        		RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   303 00E03 1C09 C        		RETL @0X09    ;USAGE
   304 00E04 1C04 C        		RETL @0X04    ;(JOYSTICK)
   305            C        	;{
   306 00E05 1CA1 C        		RETL @0XA1    ;COLLECTION
   307 00E06 1C01 C        		RETL @0X01    ;(APPLICATION)
   308 00E07 1C85 C        		RETL @0X85    ;REPORT ID
   309 00E08 1C03 C        		RETL @0X03
   310            C        		;{
   311            C        		;{X,Y,Z,Rz
   312 00E09 1CA1 C        			RETL	@0XA1    ;Collection
   313 00E0A 1C02 C        			RETL	@0X02    ;Logical
   314 00E0B 1C09 C        			RETL	@0X09    ;USAGE
   315 00E0C 1C30 C        			RETL	@0X30    ;(X)
   316 00E0D 1C09 C        			RETL	@0X09    ;USAGE
   317 00E0E 1C31 C        			RETL	@0X31    ;(Y)
   318 00E0F 1C09 C        			RETL	@0X09    ;USAGE
   319 00E10 1C35 C        			RETL	@0X35    ;(Rz)
   320 00E11 1C09 C        			RETL	@0X09    ;USAGE
   321 00E12 1C32 C        			RETL	@0X32    ;(Z)
   322 00E13 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   323 00E14 1C00 C        			RETL	@0X00    ;(0)
   324 00E15 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   325 00E16 1CFF C        			RETL	@0XFF    ;(FF)
   326 00E17 1C00 C        			RETL	@0X00
   327 00E18 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   328 00E19 1C00 C        			RETL	@0X00    ;(0)
   329 00E1A 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   330 00E1B 1CFF C        			RETL	@0XFF    ;(FF)
   331 00E1C 1C00 C        			RETL	@0X00
   332 00E1D 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   333 00E1E 1C08 C        			RETL	@0X08    ;(8)
   334 00E1F 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   335 00E20 1C04 C        			RETL	@0X04    ;(4)
   336 00E21 1C81 C        			RETL	@0X81    ;INPUT
   337 00E22 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   338            C        		;}
   339            C        		;{Button
   340 00E23 1C05 C        			RETL @0X05    ;USAGE_PAGE
   341 00E24 1C09 C        			RETL @0X09    ;(Button)
   342 00E25 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   343 00E26 1C01 C        			RETL @0X01    ;(BUTTON 1)
   344 00E27 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   345 00E28 1C10 C        			RETL @0X10    ;(BUTTON 16)
   346 00E29 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   347 00E2A 1C01 C        			RETL @0X01    ;(1)
   348 00E2B 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   349 00E2C 1C01 C        			RETL @0X01    ;(1)
   350 00E2D 1C75 C        			RETL @0X75    ;REPORT_SIZE
   351 00E2E 1C01 C        			RETL @0X01    ;(1)
   352 00E2F 1C95 C        			RETL @0X95    ;REPORT_COUNT
   353 00E30 1C10 C        			RETL @0X10    ;(16)
   354 00E31 1C81 C        			RETL @0X81    ;INPUT
   355 00E32 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   356            C        		;}
   357            C        		;{Hat Switch
   358 00E33 1C06 C        			RETL @0X06
   359 00E34 1C01 C        			RETL @0X01
   360 00E35 1C00 C        			RETL @0X00
   361 00E36 1C09 C        			RETL @0X09    ;USAGE
   362 00E37 1C39 C        			RETL @0X39    ;(Hat Switch)
   363 00E38 1C75 C        			RETL @0X75    ;REPORT_SIZE
   364 00E39 1C04 C        			RETL @0X04    ;(4)
   365 00E3A 1C95 C        			RETL @0X95    ;REPORT_COUNT
   366 00E3B 1C01 C        			RETL @0X01    ;(1)
   367 00E3C 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   368 00E3D 1C07 C        			RETL @0X07    ;(7)
   369 00E3E 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   370 00E3F 1C3B C        			RETL @0X3B    ;(315)
   371 00E40 1C01 C        			RETL @0X01
   372 00E41 1C65 C        			RETL @0X65    ;UNIT
   373 00E42 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   374 00E43 1C81 C        			RETL @0X81    ;INPUT
   375 00E44 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   376            C        		;}
   377            C        		;{Const
   378 00E45 1C65 C        			RETL @0X65    ;UNIT
   379 00E46 1C00 C        			RETL @0X00    ;(None)
   380 00E47 1C75 C        			RETL @0X75    ;REPORT_SIZE
   381 00E48 1C04 C        			RETL @0X04    ;(4)
   382 00E49 1C95 C        			RETL @0X95    ;REPORT_COUNT
   383 00E4A 1C01 C        			RETL @0X01    ;(1)
   384 00E4B 1C81 C        			RETL @0X81    ;INPUT
   385 00E4C 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   386 00E4D 1CC0 C        			RETL @0XC0    ;END COLLECTION
   387            C        		;}
   388            C        	;}
   389 00E4E 1CC0 C        	RETL @0XC0              ;78;END COLLECTION
   390            C        
   391            C        ;-----------------------------------------------------
   392            C        	;--REPORT DESCRIPTOR--
   393 00E4F 1C05 C        	RETL @0X05    ;USAGE PAGE
   394 00E50 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   395 00E51 1C09 C        	RETL @0X09    ;USAGE
   396 00E52 1C04 C        	RETL @0X04    ;(JOYSTICK)
   397            C        	;{
   398 00E53 1CA1 C        		RETL @0XA1    ;COLLECTION
   399 00E54 1C01 C        		RETL @0X01    ;(APPLICATION)
   400 00E55 1C85 C        		RETL @0X85    ;REPORT ID
   401 00E56 1C04 C        		RETL @0X04
   402            C        		;{
   403            C        		;{X,Y,Z,Rz
   404 00E57 1CA1 C        			RETL	@0XA1    ;Collection
   405 00E58 1C02 C        			RETL	@0X02    ;Logical
   406 00E59 1C09 C        			RETL	@0X09    ;USAGE
   407 00E5A 1C30 C        			RETL	@0X30    ;(X)
   408 00E5B 1C09 C        			RETL	@0X09    ;USAGE
   409 00E5C 1C31 C        			RETL	@0X31    ;(Y)
   410 00E5D 1C09 C        			RETL	@0X09    ;USAGE
   411 00E5E 1C35 C        			RETL	@0X35    ;(Rz)
   412 00E5F 1C09 C        			RETL	@0X09    ;USAGE
   413 00E60 1C32 C        			RETL	@0X32    ;(Z)
   414 00E61 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   415 00E62 1C00 C        			RETL	@0X00    ;(0)
   416 00E63 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   417 00E64 1CFF C        			RETL	@0XFF    ;(FF)
   418 00E65 1C00 C        			RETL	@0X00
   419 00E66 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   420 00E67 1C00 C        			RETL	@0X00    ;(0)
   421 00E68 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   422 00E69 1CFF C        			RETL	@0XFF    ;(FF)
   423 00E6A 1C00 C        			RETL	@0X00
   424 00E6B 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   425 00E6C 1C08 C        			RETL	@0X08    ;(8)
   426 00E6D 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   427 00E6E 1C04 C        			RETL	@0X04    ;(4)
   428 00E6F 1C81 C        			RETL	@0X81    ;INPUT
   429 00E70 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   430            C        		;}
   431            C        		;{Button
   432 00E71 1C05 C        			RETL @0X05    ;USAGE_PAGE
   433 00E72 1C09 C        			RETL @0X09    ;(Button)
   434 00E73 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   435 00E74 1C01 C        			RETL @0X01    ;(BUTTON 1)
   436 00E75 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   437 00E76 1C10 C        			RETL @0X10    ;(BUTTON 16)
   438 00E77 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   439 00E78 1C01 C        			RETL @0X01    ;(1)
   440 00E79 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   441 00E7A 1C01 C        			RETL @0X01    ;(1)
   442 00E7B 1C75 C        			RETL @0X75    ;REPORT_SIZE
   443 00E7C 1C01 C        			RETL @0X01    ;(1)
   444 00E7D 1C95 C        			RETL @0X95    ;REPORT_COUNT
   445 00E7E 1C10 C        			RETL @0X10    ;(16)
   446 00E7F 1C81 C        			RETL @0X81    ;INPUT
   447 00E80 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   448            C        		;}
   449            C        		;{Hat Switch
   450 00E81 1C06 C        			RETL @0X06
   451 00E82 1C01 C        			RETL @0X01
   452 00E83 1C00 C        			RETL @0X00
   453 00E84 1C09 C        			RETL @0X09    ;USAGE
   454 00E85 1C39 C        			RETL @0X39    ;(Hat Switch)
   455 00E86 1C75 C        			RETL @0X75    ;REPORT_SIZE
   456 00E87 1C04 C        			RETL @0X04    ;(4)
   457 00E88 1C95 C        			RETL @0X95    ;REPORT_COUNT
   458 00E89 1C01 C        			RETL @0X01    ;(1)
   459 00E8A 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   460 00E8B 1C07 C        			RETL @0X07    ;(7)
   461 00E8C 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   462 00E8D 1C3B C        			RETL @0X3B    ;(315)
   463 00E8E 1C01 C        			RETL @0X01
   464 00E8F 1C65 C        			RETL @0X65    ;UNIT
   465 00E90 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   466 00E91 1C81 C        			RETL @0X81    ;INPUT
   467 00E92 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   468            C        		;}
   469            C        		;{Const
   470 00E93 1C65 C        			RETL @0X65    ;UNIT
   471 00E94 1C00 C        			RETL @0X00    ;(None)
   472 00E95 1C75 C        			RETL @0X75    ;REPORT_SIZE
   473 00E96 1C04 C        			RETL @0X04    ;(4)
   474 00E97 1C95 C        			RETL @0X95    ;REPORT_COUNT
   475 00E98 1C01 C        			RETL @0X01    ;(1)
   476 00E99 1C81 C        			RETL @0X81    ;INPUT
   477 00E9A 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   478 00E9B 1CC0 C        			RETL @0XC0    ;END COLLECTION
   479            C        		;}
   480            C        	;}
   481 00E9C 1CC0 C        	RETL @0XC0              ;78;END COLLECTION
   482 00E9D      C        	End_HID_Report_Table2:
   483            C        
   484            C        ;---------------------------------------------------------------------
   485            C        ;---------------------------------------------------------------------
   486            C        		ORG         0XF00
   487 00F00      C        HID_REPORT_TABLE3:
   488 00F00 0020 C        		TBL
   489 00F01      C        	Begin_HID_Report_Table3:
   490            C        ;--------------------------------------------------
   491            C        	;--REPORT DESCRIPTOR--
   492 00F01 1C05 C        	RETL @0X05    ;USAGE PAGE
   493 00F02 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   494 00F03 1C09 C        	RETL @0X09    ;USAGE
   495 00F04 1C04 C        	RETL @0X04    ;(JOYSTICK)
   496            C        	;{
   497 00F05 1CA1 C        		RETL @0XA1    ;COLLECTION
   498 00F06 1C01 C        		RETL @0X01    ;(APPLICATION)
   499 00F07 1C85 C        		RETL @0X85    ;REPORT ID
   500 00F08 1C05 C        		RETL @0X05
   501            C        		;{
   502            C        		;{X,Y,Z,Rz
   503 00F09 1CA1 C        			RETL	@0XA1    ;Collection
   504 00F0A 1C02 C        			RETL	@0X02    ;Logical
   505 00F0B 1C09 C        			RETL	@0X09    ;USAGE
   506 00F0C 1C30 C        			RETL	@0X30    ;(X)
   507 00F0D 1C09 C        			RETL	@0X09    ;USAGE
   508 00F0E 1C31 C        			RETL	@0X31    ;(Y)
   509 00F0F 1C09 C        			RETL	@0X09    ;USAGE
   510 00F10 1C35 C        			RETL	@0X35    ;(Rz)
   511 00F11 1C09 C        			RETL	@0X09    ;USAGE
   512 00F12 1C32 C        			RETL	@0X32    ;(Z)
   513 00F13 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   514 00F14 1C00 C        			RETL	@0X00    ;(0)
   515 00F15 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   516 00F16 1CFF C        			RETL	@0XFF    ;(FF)
   517 00F17 1C00 C        			RETL	@0X00
   518 00F18 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   519 00F19 1C00 C        			RETL	@0X00    ;(0)
   520 00F1A 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   521 00F1B 1CFF C        			RETL	@0XFF    ;(FF)
   522 00F1C 1C00 C        			RETL	@0X00
   523 00F1D 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   524 00F1E 1C08 C        			RETL	@0X08    ;(8)
   525 00F1F 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   526 00F20 1C04 C        			RETL	@0X04    ;(4)
   527 00F21 1C81 C        			RETL	@0X81    ;INPUT
   528 00F22 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   529            C        		;}
   530            C        		;{Button
   531 00F23 1C05 C        			RETL @0X05    ;USAGE_PAGE
   532 00F24 1C09 C        			RETL @0X09    ;(Button)
   533 00F25 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   534 00F26 1C01 C        			RETL @0X01    ;(BUTTON 1)
   535 00F27 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   536 00F28 1C10 C        			RETL @0X10    ;(BUTTON 16)
   537 00F29 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   538 00F2A 1C01 C        			RETL @0X01    ;(1)
   539 00F2B 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   540 00F2C 1C01 C        			RETL @0X01    ;(1)
   541 00F2D 1C75 C        			RETL @0X75    ;REPORT_SIZE
   542 00F2E 1C01 C        			RETL @0X01    ;(1)
   543 00F2F 1C95 C        			RETL @0X95    ;REPORT_COUNT
   544 00F30 1C10 C        			RETL @0X10    ;(16)
   545 00F31 1C81 C        			RETL @0X81    ;INPUT
   546 00F32 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   547            C        		;}
   548            C        		;{Hat Switch
   549 00F33 1C06 C        			RETL @0X06
   550 00F34 1C01 C        			RETL @0X01
   551 00F35 1C00 C        			RETL @0X00
   552 00F36 1C09 C        			RETL @0X09    ;USAGE
   553 00F37 1C39 C        			RETL @0X39    ;(Hat Switch)
   554 00F38 1C75 C        			RETL @0X75    ;REPORT_SIZE
   555 00F39 1C04 C        			RETL @0X04    ;(4)
   556 00F3A 1C95 C        			RETL @0X95    ;REPORT_COUNT
   557 00F3B 1C01 C        			RETL @0X01    ;(1)
   558 00F3C 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   559 00F3D 1C07 C        			RETL @0X07    ;(7)
   560 00F3E 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   561 00F3F 1C3B C        			RETL @0X3B    ;(315)
   562 00F40 1C01 C        			RETL @0X01
   563 00F41 1C65 C        			RETL @0X65    ;UNIT
   564 00F42 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   565 00F43 1C81 C        			RETL @0X81    ;INPUT
   566 00F44 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   567            C        		;}
   568            C        		;{Const
   569 00F45 1C65 C        			RETL @0X65    ;UNIT
   570 00F46 1C00 C        			RETL @0X00    ;(None)
   571 00F47 1C75 C        			RETL @0X75    ;REPORT_SIZE
   572 00F48 1C04 C        			RETL @0X04    ;(4)
   573 00F49 1C95 C        			RETL @0X95    ;REPORT_COUNT
   574 00F4A 1C01 C        			RETL @0X01    ;(1)
   575 00F4B 1C81 C        			RETL @0X81    ;INPUT
   576 00F4C 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   577 00F4D 1CC0 C        			RETL @0XC0    ;END COLLECTION
   578            C        		;}
   579            C        	;}
   580 00F4E 1CC0 C        	RETL @0XC0              ;78;END COLLECTION
   581            C        
   582            C        ;--------------------------------------------------
   583            C        	;--REPORT DESCRIPTOR--
   584 00F4F 1C05 C        	RETL @0X05    ;USAGE PAGE
   585 00F50 1C01 C        	RETL @0X01    ;(GENERIC DESKTOP CONTROL)
   586 00F51 1C09 C        	RETL @0X09    ;USAGE
   587 00F52 1C04 C        	RETL @0X04    ;(JOYSTICK)
   588            C        	;{
   589 00F53 1CA1 C        		RETL @0XA1    ;COLLECTION
   590 00F54 1C01 C        		RETL @0X01    ;(APPLICATION)
   591 00F55 1C85 C        		RETL @0X85    ;REPORT ID
   592 00F56 1C06 C        		RETL @0X06
   593            C        		;{
   594            C        		;{X,Y,Z,Rz
   595 00F57 1CA1 C        			RETL	@0XA1    ;Collection
   596 00F58 1C02 C        			RETL	@0X02    ;Logical
   597 00F59 1C09 C        			RETL	@0X09    ;USAGE
   598 00F5A 1C30 C        			RETL	@0X30    ;(X)
   599 00F5B 1C09 C        			RETL	@0X09    ;USAGE
   600 00F5C 1C31 C        			RETL	@0X31    ;(Y)
   601 00F5D 1C09 C        			RETL	@0X09    ;USAGE
   602 00F5E 1C35 C        			RETL	@0X35    ;(Rz)
   603 00F5F 1C09 C        			RETL	@0X09    ;USAGE
   604 00F60 1C32 C        			RETL	@0X32    ;(Z)
   605 00F61 1C15 C        			RETL	@0X15    ;LOGICAL_MINIMUN
   606 00F62 1C00 C        			RETL	@0X00    ;(0)
   607 00F63 1C26 C        			RETL	@0X26    ;LOGICAL_MAXIMUM
   608 00F64 1CFF C        			RETL	@0XFF    ;(FF)
   609 00F65 1C00 C        			RETL	@0X00
   610 00F66 1C35 C        			RETL	@0X35    ;PHYSICAL MINIMUM
   611 00F67 1C00 C        			RETL	@0X00    ;(0)
   612 00F68 1C46 C        			RETL	@0X46    ;PHYSICAL MAXIMUM
   613 00F69 1CFF C        			RETL	@0XFF    ;(FF)
   614 00F6A 1C00 C        			RETL	@0X00
   615 00F6B 1C75 C        			RETL	@0X75    ;REPORT_SIZE
   616 00F6C 1C08 C        			RETL	@0X08    ;(8)
   617 00F6D 1C95 C        			RETL	@0X95    ;REPORT_COUNT
   618 00F6E 1C04 C        			RETL	@0X04    ;(4)
   619 00F6F 1C81 C        			RETL	@0X81    ;INPUT
   620 00F70 1C02 C        			RETL	@0X02    ;(Data Ary,Abs)
   621            C        		;}
   622            C        		;{Button
   623 00F71 1C05 C        			RETL @0X05    ;USAGE_PAGE
   624 00F72 1C09 C        			RETL @0X09    ;(Button)
   625 00F73 1C19 C        			RETL @0X19    ;USAGE MINIMUN
   626 00F74 1C01 C        			RETL @0X01    ;(BUTTON 1)
   627 00F75 1C29 C        			RETL @0X29    ;USAGE MAXIMUM
   628 00F76 1C10 C        			RETL @0X10    ;(BUTTON 16)
   629 00F77 1C25 C        			RETL @0X25    ;LOGICAL MAXIMUM
   630 00F78 1C01 C        			RETL @0X01    ;(1)
   631 00F79 1C45 C        			RETL @0X45    ;PHYSICAL MAXIMUM
   632 00F7A 1C01 C        			RETL @0X01    ;(1)
   633 00F7B 1C75 C        			RETL @0X75    ;REPORT_SIZE
   634 00F7C 1C01 C        			RETL @0X01    ;(1)
   635 00F7D 1C95 C        			RETL @0X95    ;REPORT_COUNT
   636 00F7E 1C10 C        			RETL @0X10    ;(16)
   637 00F7F 1C81 C        			RETL @0X81    ;INPUT
   638 00F80 1C02 C        			RETL @0X02    ;(Data Ary,Abs)
   639            C        		;}
   640            C        		;{Hat Switch
   641 00F81 1C06 C        			RETL @0X06
   642 00F82 1C01 C        			RETL @0X01
   643 00F83 1C00 C        			RETL @0X00
   644 00F84 1C09 C        			RETL @0X09    ;USAGE
   645 00F85 1C39 C        			RETL @0X39    ;(Hat Switch)
   646 00F86 1C75 C        			RETL @0X75    ;REPORT_SIZE
   647 00F87 1C04 C        			RETL @0X04    ;(4)
   648 00F88 1C95 C        			RETL @0X95    ;REPORT_COUNT
   649 00F89 1C01 C        			RETL @0X01    ;(1)
   650 00F8A 1C25 C        			RETL @0X25    ;LOGICAL_MAX
   651 00F8B 1C07 C        			RETL @0X07    ;(7)
   652 00F8C 1C46 C        			RETL @0X46    ;PHYSICAL_MAX
   653 00F8D 1C3B C        			RETL @0X3B    ;(315)
   654 00F8E 1C01 C        			RETL @0X01
   655 00F8F 1C65 C        			RETL @0X65    ;UNIT
   656 00F90 1C14 C        			RETL @0X14    ;(Eng Rot:Angular Pos)
   657 00F91 1C81 C        			RETL @0X81    ;INPUT
   658 00F92 1C42 C        			RETL @0X42    ;(Data,Var,Abs,Null)
   659            C        		;}
   660            C        		;{Const
   661 00F93 1C65 C        			RETL @0X65    ;UNIT
   662 00F94 1C00 C        			RETL @0X00    ;(None)
   663 00F95 1C75 C        			RETL @0X75    ;REPORT_SIZE
   664 00F96 1C04 C        			RETL @0X04    ;(4)
   665 00F97 1C95 C        			RETL @0X95    ;REPORT_COUNT
   666 00F98 1C01 C        			RETL @0X01    ;(1)
   667 00F99 1C81 C        			RETL @0X81    ;INPUT
   668 00F9A 1C01 C        			RETL @0X01    ;(Const,Var,Abs)
   669 00F9B 1CC0 C        			RETL @0XC0    ;END COLLECTION
   670            C        		;}
   671            C        	;}
   672 00F9C 1CC0 C        	RETL @0XC0              ;78;END COLLECTION
   673            C        
   674 00F9D      C        	End_HID_Report_Table3:
   675            C        
   676            C        
   677            C        
    15            C        
    16            C        ifndef EM78CtrlIns.H
    17            C        include "EM78CtrlIns.H"
    18            C        endif
    19            C        
    20            C        ifndef M611rxP40.H
    21            C        include "M611rxP40.H"
    22            C        endif
    23            C        ;=========================================================================
    24            C        
    25            C        	ORG                 0X1150    ;PAGE 4
    26            C        	MESSAGE "define 'M611USBDriver.ASM' ROM address"
***     USER MESSAGE: DEFINE 'M611USBDRIVER.ASM' ROM ADDRESS
    27            C        ;***********************************************************************************
    28            C        ;**********************************************************************************
    29            C        ; USB Driver
    30            C        ;*********************************************************************************
    31            C        ;==============================================================================
    32            C        ;==============================================================================
    33            C        ; READ USB COMMAND ,HOST command
    34            C        ;==============================================================================
    35            C        
    36 01150      C        READ_COMMAND:
    37 01150 0C4C C        	JBC                 RC,EP0_BUSY           ;CHECK UDC BUSY OR NOT
    38 01151 1550 C        	JMP                 READ_COMMAND
    39 01152 0FCC C        	JBS                 RC,EP0_W              ;CHECK EP0 W HAVE DATA OR NOT
    40 01153 1550 C        	JMP                 READ_COMMAND
    41 01154 098C C        	BC                  RC,EP0_R              ;DISABLE UDC READ
    42            C        
    43 01155 1810 C        	MOV                 A,@0X10
    44 01156 004D C        	MOV                 RD,A
    45 01157 00CE C        	CLR                 RE                    ;RESET POINTER & COUNTER
    46 01158 00CD C        	CLR                 RD
    47            C        
    48 01159 040E C        	MOV                 A,RE
    49 0115A 0060 C        	MOV                 BYTE0,A
    50 0115B 040E C        	MOV                 A,RE
    51 0115C 0061 C        	MOV                 BYTE1,A
    52 0115D 040E C        	MOV                 A,RE
    53 0115E 0062 C        	MOV                 BYTE2,A
    54 0115F 040E C        	MOV                 A,RE
    55 01160 0063 C        	MOV                 BYTE3,A
    56 01161 040E C        	MOV                 A,RE
    57 01162 0064 C        	MOV                 BYTE4,A
    58 01163 040E C        	MOV                 A,RE
    59 01164 0065 C        	MOV                 BYTE5,A
    60 01165 040E C        	MOV                 A,RE
    61 01166 0066 C        	MOV                 BYTE6,A
    62 01167 040E C        	MOV                 A,RE
    63 01168 0067 C        	MOV                 BYTE7,A
    64 01169 1810 C        	MOV                 A,@0X10
    65 0116A 004D C        	MOV                 RD,A
    66 0116B 00CE C        	CLR                 RE                                             ;RESET POINTER & COUNTER
    67 0116C 00CD C        	CLR                 RD
    68 0116D 09CC C        	BC                  RC,EP0_W                                       ;CLEAR EP0_W
    69 0116E 08DC C        	BC                  SetupDataStageFlag/16,SetupDataStageFlag%16    ;REFRESH EP0_REPORT COMMAND
    70 0116F 09DC C        	BC                  UsbEP0interruptflag/16,UsbEP0interruptflag%16
    71            C        	;CLR                 TRANSFER
    72            C        
    73            C        ;=========================================================
    74            C        ;USB COMMAND DECODE:
    75            C        ;	|
    76            C        ;	|---STANDARD_DEVICE_REQUESTS
    77            C        ;	|	|
    78            C        ;	|	|---GET_DESCRIPTOR
    79            C        ;	|		|
    80            C        ;	|		|---STANDARD_DESCRIPTOR_TYPE
    81            C        ;	|		|	|
    82            C        ;	|		|	|---GET_DEVICE_D
    83            C        ;	|		|	|---GET_CONFIGURATION_D
    84            C        ;	|		|	|---GET_STRING_D
    85            C        ;	|		|
    86            C        ;	|		|---CLASS_DESCRIPTOR_TYPE
    87            C        ;	|			|
    88            C        ;	|			|---GET_HID_D
    89            C        ;	|			|---GET_REPORT_D
    90            C        ;	|
    91            C        ;	|---CLASS_SPECIFIC_REQUESTS
    92            C        ;		|
    93            C        ;		|---HID_SET_REQUEST
    94            C        ;		|	|
    95            C        ;		|	|---SET_REPORT_R
    96            C        ;		|	|---SET_IDLE_R
    97            C        ;		|	|---SET_PROTOCOL_R
    98            C        ;		|
    99            C        ;		|---HID_GET_REQUEST
   100            C        ;			|
   101            C        ;			|---GET_REPORT_R
   102            C        ;			|---GET_IDLE_R
   103            C        ;			|---GET_PROTOCOL_R
   104            C        ;=========================================================
   105 01170      C        DECODE:
   106 01170 0420 C        	MOV                 A,BYTE0				        ;bmRequestType
   107 01171 1A60 C        	AND                 A,@0B01100000
   108 01172 0C83 C        	JBC                 STATUS,Z
   109 01173 1578 C        	JMP                 STANDARD_DEVICE_REQUESTS	;bmRequestType[6,5]=[0,0]
   110 01174 1B20 C        	XOR                 A,@0B00100000
   111 01175 0C83 C        	JBC                 STATUS,Z
   112 01176 15D5 C        	JMP                 CLASS_SPECIFIC_REQUESTS		;bmRequestType[6,5]=[0,1]    [0,1]
   113 01177 1597 C        	JMP                 STALL_STATUS				;bmRequestType[6,5]=[1,0] OR [1,1]
   114            C        
   115 01178      C        STANDARD_DEVICE_REQUESTS:
   116 01178 1806 C        	MOV                 A,@0B00000110                  ;0X06
   117 01179 0321 C        	XOR                 A,BYTE1				        ;bRequest (Request Code)
   118 0117A 0C83 C        	JBC                 STATUS,Z
   119 0117B 157D C        	JMP                 GET_DESCRIPTOR
   120 0117C 1597 C        	JMP                 STALL_STATUS
   121 0117D      C          GET_DESCRIPTOR:
   122 0117D 00D8 C        	CLR                 TABLE_INDEX
   123 0117E 0423 C        	MOV                 A,BYTE3				        ;wValue (Descriptor Type)
   124 0117F 1A60 C        	AND                 A,@0B01100000
   125 01180 0C83 C        	JBC                 STATUS,Z
   126 01181 1586 C        	JMP                 STANDARD_DESCRIPTOR_TYPE	;wValue[6,5]=[0,0]
   127 01182 1B20 C        	XOR                 A,@0B00100000
   128 01183 0C83 C        	JBC                 STATUS,Z
   129 01184 158F C        	JMP                 CLASS_DESCRIPTOR_TYPE		;wValue[6,5]=[0,1]
   130 01185 1597 C        	JMP                 STALL_STATUS				;wValue[6,5]=[1,0] OR [1,1]
   131            C        
   132 01186      C          STANDARD_DESCRIPTOR_TYPE:
   133 01186 0423 C        	MOV                 A,BYTE3
   134 01187 1D03 C        	SUB                 A,@0X03
   135 01188 0E03 C        	JBS                 STATUS,C
   136 01189 1597 C        	JMP                 STALL_STATUS
   137            C        
   138 0118A 0020 C        	TBL
   139 0118B 15BD C        	JMP                 STRING_SET          ;	3
   140 0118C 15A2 C        	JMP                 CONFIG_SET          ;	2
   141 0118D 159B C        	JMP                 DEVICE_SET          ;	1
   142 0118E 1597 C        	JMP                 STALL_STATUS        ;	0
   143            C        
   144 0118F      C          CLASS_DESCRIPTOR_TYPE:
   145 0118F 1821 C        	MOV                 A,@0X21
   146 01190 0323 C        	XOR                 A,BYTE3
   147 01191 0C83 C        	JBC                 STATUS,2
   148 01192 15AA C        	JMP                 HID_SET             ; GET HID
   149            C        
   150 01193 1822 C        	MOV                 A,@0X22
   151 01194 0323 C        	XOR                 A,BYTE3
   152 01195 0C83 C        	JBC                 STATUS,2
   153 01196 15B4 C        	JMP                 HID_REPORT_SET      ; GET REPORT
   154            C        
   155 01197      C          STALL_STATUS:
   156 01197 0A0C C        	BS                  RC,0
   157 01198 09CC C        	BC                  RC,7
   158 01199 084F C        	BC                  ISR,EP0IF
   159 0119A 160C C        	JMP                 BC_EP0_FLAG
   160            C        ;----------------------------
   161            C        ;	GET DESCRIPTOR
   162            C        ;----------------------------
   163 0119B      C          DEVICE_SET:
   164 0119B 00D3 C        	CLR                 CMD_SELECT
   165 0119C 1812 C        	MOV                 A,@0X12
   166 0119D 007D C        	MOV                 DataMaxTable1,A
   167 0119E 00FE C        	CLR                 DataMaxTable2
   168 0119F 00FF C        	CLR                 DataMaxTable3
   169 011A0 12D1 C        	CALL                Set_Table1_Select
   170 011A1 15CF C        	JMP                 END_DESCRIPTOR
   171            C        
   172 011A2      C          CONFIG_SET:
   173 011A2 1801 C        	MOV                 A,@0X01
   174 011A3 0053 C        	MOV                 CMD_SELECT,A
   175 011A4 1822 C        	MOV                 A,@0X22
   176 011A5 007D C        	MOV                 DataMaxTable1,A
   177 011A6 00FE C        	CLR                 DataMaxTable2
   178 011A7 00FF C        	CLR                 DataMaxTable3
   179 011A8 12D1 C        	CALL                Set_Table1_Select
   180 011A9 15CF C        	JMP                 END_DESCRIPTOR
   181            C        
   182 011AA      C          HID_SET:
   183 011AA 1801 C        	MOV                 A,@0X01
   184 011AB 0053 C        	MOV                 CMD_SELECT,A
   185 011AC 1812 C        	MOV                 A,@0X12
   186 011AD 0058 C        	MOV                 TABLE_INDEX,A
   187 011AE 1809 C        	MOV                 A,@0X09
   188 011AF 007D C        	MOV                 DataMaxTable1,A
   189 011B0 00FE C        	CLR                 DataMaxTable2
   190 011B1 00FF C        	CLR                 DataMaxTable3
   191 011B2 12D1 C        	CALL                Set_Table1_Select
   192 011B3 15CF C        	JMP                 END_DESCRIPTOR
   193            C        
   194 011B4      C          HID_REPORT_SET:
   195 011B4 1802 C        	MOV                 A,@0X02
   196 011B5 0053 C        	MOV                 CMD_SELECT,A
   197 011B6 189C C        	MOV                 A,@(End_HID_Report_Table1-Begin_HID_Report_Table1)
   198 011B7 007D C        	MOV                 DataMaxTable1,A
   199 011B8 189C C        	MOV                 A,@(End_HID_Report_Table2-Begin_HID_Report_Table2)
   200 011B9 007E C        	MOV                 DataMaxTable2,A
   201 011BA 189C C        	MOV                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   202 011BB 007F C        	MOV                 DataMaxTable3,A
   203 011BC 15CF C        	JMP                 END_DESCRIPTOR
   204            C        
   205 011BD      C          STRING_SET:
   206 011BD 1800 C        	MOV                 A,@0X00
   207 011BE 0322 C        	XOR                 A,BYTE2
   208 011BF 0C83 C        	JBC                 STATUS,2
   209 011C0 15C5 C        	JMP                 STRING0
   210            C        
   211 011C1 1802 C        	MOV                 A,@0X02
   212 011C2 0322 C        	XOR                 A,BYTE2
   213 011C3 0C83 C        	JBC                 STATUS,2
   214 011C4 15CA C        	JMP                 STRING2
   215 011C5      C          STRING0:
   216 011C5 1806 C        	MOV                 A,@0X06
   217 011C6 0053 C        	MOV                 CMD_SELECT,A
   218 011C7 1804 C        	MOV                 A,@0X04
   219 011C8 007D C        	MOV                 DataMaxTable1,A
   220 011C9 15CF C        	JMP                 END_DESCRIPTOR
   221            C        
   222 011CA      C          STRING2:
   223 011CA 1807 C        	MOV                 A,@0X07
   224 011CB 0053 C        	MOV                 CMD_SELECT,A
   225 011CC 181E C        	MOV                 A,@0X1E
   226 011CD 007D C        	MOV                 DataMaxTable1,A
   227 011CE 15CF C        	JMP                 END_DESCRIPTOR
   228            C        
   229 011CF      C          END_DESCRIPTOR:
   230 011CF 0426 C        	MOV                 A,BYTE6
   231 011D0 007B C        	MOV                 PC_WANT0,A
   232 011D1 0427 C        	MOV                 A,BYTE7
   233 011D2 007C C        	MOV                 PC_WANT1,A
   234 011D3 0ADC C        	BS                  SetupDataStageFlag/16,SetupDataStageFlag%16
   235 011D4 160C C        	JMP                 BC_EP0_FLAG
   236            C        
   237            C        ;------------------------------------------
   238            C        ;	HID_CLASS_SPECIFIC_REQUESTS
   239            C        ;------------------------------------------
   240 011D5      C        CLASS_SPECIFIC_REQUESTS:
   241 011D5 1821 C        	MOV                 A,@0X21
   242 011D6 0320 C        	XOR                 A,BYTE0
   243 011D7 0C83 C        	JBC                 STATUS,Z
   244 011D8 15DE C        	JMP                 HID_SET_REQUEST
   245            C        
   246 011D9 18A1 C        	MOV                 A,@0XA1
   247 011DA 0320 C        	XOR                 A,BYTE0
   248 011DB 0C83 C        	JBC                 STATUS,Z
   249 011DC 15F8 C        	JMP                 HID_GET_REQUEST
   250 011DD 1597 C        	JMP                 STALL_STATUS
   251            C        
   252 011DE      C          HID_SET_REQUEST:
   253 011DE 1809 C        	MOV                 A,@0X09
   254 011DF 0321 C        	XOR                 A,BYTE1
   255 011E0 0C83 C        	JBC                 STATUS,Z
   256 011E1 15EB C        	JMP                 SET_REPORT
   257            C        
   258 011E2 180A C        	MOV                 A,@0X0A
   259 011E3 0321 C        	XOR                 A,BYTE1
   260 011E4 0C83 C        	JBC                 STATUS,Z
   261 011E5 15EC C        	JMP                 SET_IDLE
   262            C        
   263 011E6 180B C        	MOV                 A,@0X0B
   264 011E7 0321 C        	XOR                 A,BYTE1
   265 011E8 0C83 C        	JBC                 STATUS,Z
   266 011E9 15EF C        	JMP                 SET_PROTOCOL
   267 011EA 1597 C        	JMP                 STALL_STATUS
   268            C        
   269 011EB      C          SET_REPORT:
   270 011EB 15F1 C        	JMP                 SET_RET
   271 011EC      C          SET_IDLE:
   272 011EC 0423 C        	MOV                 A,BYTE3
   273 011ED 007A C        	MOV                 IDLE_TEMP,A
   274 011EE 15F1 C        	JMP                 SET_RET
   275 011EF      C          SET_PROTOCOL:
   276 011EF 0422 C        	MOV                 A,BYTE2
   277 011F0 0079 C        	MOV                 PROTOCOL_TEMP,A
   278 011F1      C          SET_RET:
   279 011F1 00D8 C        	CLR                 TABLE_INDEX
   280 011F2 00FD C        	CLR                 DataMaxTable1
   281 011F3 00FB C        	CLR                 PC_WANT0
   282 011F4 00FC C        	CLR                 PC_WANT1
   283 011F5 0ADC C        	BS                  SetupDataStageFlag/16,SetupDataStageFlag%16
   284 011F6 0080 C        	CLRA
   285 011F7 160C C        	JMP                 BC_EP0_FLAG
   286            C        
   287 011F8      C          HID_GET_REQUEST:
   288 011F8 0421 C        	MOV                 A,BYTE1
   289 011F9 1D03 C        	SUB                 A,@0X03
   290 011FA 0E03 C        	JBS                 STATUS,C
   291 011FB 1597 C        	JMP                 STALL_STATUS
   292 011FC 0020 C        	TBL
   293 011FD 1604 C        	JMP                 GET_PROTOCOL     ; BYTE1 = 0X03
   294 011FE 1601 C        	JMP                 GET_IDLE         ; BYTE1 = 0X02
   295 011FF 1607 C        	JMP                 GET_REPORT       ; BYTE1 = 0X01
   296 01200 1597 C        	JMP                 STALL_STATUS
   297            C        
   298 01201      C          GET_IDLE:
   299 01201 1803 C        	MOV                 A,@0X03
   300 01202 0053 C        	MOV                 CMD_SELECT,A
   301 01203 1609 C        	JMP                 GET_RET
   302 01204      C          GET_PROTOCOL:
   303 01204 1804 C        	MOV                 A,@0X04
   304 01205 0053 C        	MOV                 CMD_SELECT,A
   305 01206 1609 C        	JMP                 GET_RET
   306 01207      C          GET_REPORT:
   307 01207 1805 C        	MOV                 A,@0X05
   308 01208 0053 C        	MOV                 CMD_SELECT,A
   309 01209      C          GET_RET:
   310 01209 1801 C        	MOV                 A,@0X01
   311 0120A 007D C        	MOV                 DataMaxTable1,A
   312 0120B 15CF C        	JMP                 END_DESCRIPTOR
   313            C        
   314 0120C      C          BC_EP0_FLAG:
   315 0120C 084F C        	BC                  ISR,EP0IF
   316            C      M 	PAGE                0
       0120D 09C3     1     BC  3 , 7 
       0120E 0983     1     BC  3 , 6 
       0120F 0943     1     BC  3 , 5 
   317 01210 146C C        	JMP                 INT_RET
   318            C        
   319            C        
   320            C        ;===================================================================================
   321            C        ;===================================================================================
   322 01211      C        EP0_REPORT:
   323 01211 0BCC C        	BS                  RC,EP0_W          ;Set 1, when MCU will write data to FIFO
   324 01212 0E4C C        	JBS                 RC,EP0_BUSY       ;It is '1' while UDC write/read endpoint0 FIFO
   325 01213 1616 C        	JMP                 REPORT_INITIAL
   326 01214 09CC C        	BC                  RC,EP0_W          ;if EP0 busy go back main loop wait for udc non-busy
   327 01215 0012 C        	RET
   328 01216      C          REPORT_INITIAL:	                   ;clear pointer and counter
   329 01216 1810 C        	MOV                 A,@0X10
   330 01217 004D C        	MOV                 RD,A       ;set to control pointer & counter
   331 01218 00CE C        	CLR                 RE         ;clear pointer & counter
   332 01219 00CD C        	CLR                 RD         ; FIFO adress=base
   333 0121A      C          REPORT_START:
   334 0121A 047D C        	MOV                 DataMaxTable1,DataMaxTable1
   335 0121B 0E83 C        	JBS                 STATUS,Z
   336 0121C 1623 C        	JMP                 Load_FIFO_ByteLength	    ;if DataMaxTable1/2/3 = 0  jmp to finish
   337 0121D 047E C        	MOV                 DataMaxTable2,DataMaxTable2
   338 0121E 0E83 C        	JBS                 STATUS,Z
   339 0121F 1623 C        	JMP                 Load_FIFO_ByteLength
   340 01220 047F C        	MOV                 DataMaxTable3,DataMaxTable3
   341 01221 0C83 C        	JBC                 STATUS,Z
   342 01222 16E9 C        	JMP                 FINISH
   343            C        
   344 01223      C          Load_FIFO_ByteLength:
   345 01223 1808 C        	MOV                 A,@0X08
   346 01224 005A C        	MOV                 DataByteLength,A
   347            C        	;CLR                 RE
   348 01225 00CD C        	CLR                 RD
   349 01226      C          REPORT_LOOP:
   350 01226 0413 C        	MOV                 A,CMD_SELECT
   351 01227 0020 C        	TBL
   352 01228 1630 C        	JMP                 DEVICE_LOOP	;0
   353 01229 1639 C        	JMP                 CONFIG_LOOP	;1
   354 0122A 1642 C        	JMP                 HID_REPORTL	;2
   355 0122B 1663 C        	JMP                 IDLE_LOOP	;3
   356 0122C 1665 C        	JMP                 PROTOCOLL	;4
   357 0122D 1667 C        	JMP                 REPORT_EP0	;5
   358 0122E 166E C        	JMP                 STRING0L	;6
   359            C        	;JMP                 STRING1L    ;7
   360 0122F 1677 C        	JMP                 STRING2L	;8
   361            C        
   362            C        ;-------------------------------------------------------------
   363 01230      C          DEVICE_LOOP:
   364 01230 0418 C        	MOV                 A,TABLE_INDEX
   365            C      M 	PAGE                3
       01231 09C3     1     BC  3 , 7 
       01232 0B83     1     BS  3 , 6 
       01233 0B43     1     BS  3 , 5 
   366 01234 1000 C        	CALL                DEVICE_TABLE
   367            C      M 	PAGE                4
       01235 0BC3     1     BS  3 , 7 
       01236 0983     1     BC  3 , 6 
       01237 0943     1     BC  3 , 5 
   368 01238 1682 C        	JMP                 RLOOP
   369            C        ;-------------------------------------------------------------
   370 01239      C          CONFIG_LOOP:
   371 01239 0418 C        	MOV                 A,TABLE_INDEX
   372            C      M 	PAGE                3
       0123A 09C3     1     BC  3 , 7 
       0123B 0B83     1     BS  3 , 6 
       0123C 0B43     1     BS  3 , 5 
   373 0123D 1013 C        	CALL                CONFIG_TABLE
   374            C      M 	PAGE                4
       0123E 0BC3     1     BS  3 , 7 
       0123F 0983     1     BC  3 , 6 
       01240 0943     1     BC  3 , 5 
   375 01241 1682 C        	JMP                 RLOOP
   376            C        ;-------------------------------------------------------------
   377 01242      C          HID_REPORTL:
   378 01242 0D1C C        	JBC                 TableSelectFlag1/16,TableSelectFlag1%16
   379 01243 1648 C        	JMP                 HID_Table_1st
   380 01244 0D5C C        	JBC                 TableSelectFlag2/16,TableSelectFlag2%16
   381 01245 1651 C        	JMP                 HID_Table_2nd
   382 01246 0D9C C        	JBC                 TableSelectFlag3/16,TableSelectFlag3%16
   383 01247 165A C        	JMP                 HID_Table_3rd
   384            C        
   385 01248      C          HID_Table_1st:
   386 01248 0418 C        	MOV                 A,TABLE_INDEX
   387            C      M 	PAGE                3
       01249 09C3     1     BC  3 , 7 
       0124A 0B83     1     BS  3 , 6 
       0124B 0B43     1     BS  3 , 5 
   388 0124C 1100 C        	CALL                HID_REPORT_TABLE1
   389            C      M 	PAGE                4
       0124D 0BC3     1     BS  3 , 7 
       0124E 0983     1     BC  3 , 6 
       0124F 0943     1     BC  3 , 5 
   390 01250 1682 C        	JMP                 RLOOP
   391 01251      C          HID_Table_2nd:
   392 01251 0418 C        	MOV                 A,TABLE_INDEX
   393            C      M 	PAGE                3
       01252 09C3     1     BC  3 , 7 
       01253 0B83     1     BS  3 , 6 
       01254 0B43     1     BS  3 , 5 
   394 01255 1200 C        	CALL                HID_REPORT_TABLE2
   395            C      M 	PAGE                4
       01256 0BC3     1     BS  3 , 7 
       01257 0983     1     BC  3 , 6 
       01258 0943     1     BC  3 , 5 
   396 01259 1682 C        	JMP                 RLOOP
   397 0125A      C          HID_Table_3rd:
   398 0125A 0418 C        	MOV                 A,TABLE_INDEX
   399            C      M 	PAGE                3
       0125B 09C3     1     BC  3 , 7 
       0125C 0B83     1     BS  3 , 6 
       0125D 0B43     1     BS  3 , 5 
   400 0125E 1300 C        	CALL                HID_REPORT_TABLE3
   401            C      M 	PAGE                4
       0125F 0BC3     1     BS  3 , 7 
       01260 0983     1     BC  3 , 6 
       01261 0943     1     BC  3 , 5 
   402 01262 1682 C        	JMP                 RLOOP
   403            C        ;--------------------------------------------------------------
   404 01263      C          IDLE_LOOP:
   405 01263 043A C        	MOV                 A,IDLE_TEMP
   406 01264 1682 C        	JMP                 RLOOP
   407            C        ;---------------------------------------------------------------
   408 01265      C          PROTOCOLL:
   409 01265 0439 C        	MOV                 A,PROTOCOL_TEMP
   410 01266 1682 C        	JMP                 RLOOP
   411            C        ;---------------------------------------------------------------
   412 01267      C          REPORT_EP0:
   413 01267 1810 C        	MOV                 A,@0X10
   414 01268 004D C        	MOV                 RD,A		;EP0 POINTER&COUNTER
   415 01269 00CE C        	CLR                 RE
   416 0126A 1800 C        	MOV                 A,@0X00
   417 0126B 004D C        	MOV                 RD,A		;EP0 FIFO
   418 0126C 12ED C        	CALL                SEND_USB_DATA
   419 0126D 16E9 C        	JMP                 FINISH
   420            C        ;---------------------------------------------------------------
   421 0126E      C          STRING0L:
   422 0126E 0418 C        	MOV                 A,TABLE_INDEX
   423            C      M 	PAGE                3
       0126F 09C3     1     BC  3 , 7 
       01270 0B83     1     BS  3 , 6 
       01271 0B43     1     BS  3 , 5 
   424 01272 1036 C        	CALL                STRING0T
   425            C      M 	PAGE                4
       01273 0BC3     1     BS  3 , 7 
       01274 0983     1     BC  3 , 6 
       01275 0943     1     BC  3 , 5 
   426 01276 1682 C        	JMP                 RLOOP
   427            C        
   428            C        ;STRING1L:
   429            C        ;	CALL                STRING_SUB
   430            C        ;	CALL                STRING1T
   431            C        ;	JMP                 RLOOP
   432            C        
   433 01277      C          STRING2L:
   434 01277 1279 C        	CALL                STRING_SUB
   435 01278 1682 C        	JMP                 RLOOP
   436            C        
   437 01279      C          STRING_SUB:
   438 01279 0418 C        	MOV                 A,TABLE_INDEX
   439 0127A 1D01 C        	SUB	                A,@0X01
   440 0127B 0C03 C        	JBC                 STATUS,C
   441 0127C 0012 C        	RET
   442 0127D 0C18 C        	JBC                 TABLE_INDEX,0
   443 0127E 1C02 C        	RETL                @0X02
   444 0127F 0618 C        	RRCA                TABLE_INDEX
   445 01280 1F02 C        	ADD                 A,@0X02
   446 01281 0012 C        	RET
   447            C        
   448            C        ;***************************************************************
   449            C        ;***************************************************************
   450 01282      C        RLOOP:
   451 01282 004E C        	MOV                 RE,A
   452 01283 0558 C        	INC                 TABLE_INDEX
   453 01284 01FB C        	DEC                 PC_WANT0
   454 01285 047B C        	MOV                 PC_WANT0,PC_WANT0
   455 01286 0C83 C        	JBC                 STATUS,Z
   456 01287 16BE C        	JMP                 Null_Data                 ;PC_WANT0 null data
   457            C        
   458 01288      C          To_Continue:
   459 01288 047F C        	MOV                 DataMaxTable3,DataMaxTable3
   460 01289 0E83 C        	JBS                 STATUS,Z
   461 0128A 1691 C        	JMP                 Continue_Fill_In_8Byte
   462 0128B 047E C        	MOV                 DataMaxTable2,DataMaxTable2
   463 0128C 0E83 C        	JBS                 STATUS,Z
   464 0128D 1691 C        	JMP                 Continue_Fill_In_8Byte
   465 0128E 047D C        	MOV                 DataMaxTable1,DataMaxTable1
   466 0128F 0C83 C        	JBC                 STATUS,Z
   467 01290 16E9 C        	JMP                 FINISH
   468            C        
   469 01291      C          Continue_Fill_In_8Byte:
   470 01291 05DA C        	DJZ                 DataByteLength
   471 01292 169B C        	JMP                 Fill_In_8Byte_Cycle
   472            C        
   473 01293 0D9C C        	JBC                 TableSelectFlag3/16,TableSelectFlag3%16
   474 01294 01FF C        	DEC                 DataMaxTable3
   475 01295 0D5C C        	JBC                 TableSelectFlag2/16,TableSelectFlag2%16
   476 01296 01FE C        	DEC                 DataMaxTable2
   477 01297 0D1C C        	JBC                 TableSelectFlag1/16,TableSelectFlag1%16
   478 01298 01FD C        	DEC                 DataMaxTable1
   479 01299 12C7 C        	CALL                Set_Table_Select
   480 0129A 16C3 C        	JMP                 END_Fill_In_8Byte_Cycle   ;8 byte full , End this cycle
   481            C        
   482 0129B      C          Fill_In_8Byte_Cycle:
   483 0129B 0D9C C        	JBC                 TableSelectFlag3/16,TableSelectFlag3%16
   484 0129C 01FF C        	DEC                 DataMaxTable3
   485 0129D 0D5C C        	JBC                 TableSelectFlag2/16,TableSelectFlag2%16
   486 0129E 01FE C        	DEC                 DataMaxTable2
   487 0129F 0D1C C        	JBC                 TableSelectFlag1/16,TableSelectFlag1%16
   488 012A0 01FD C        	DEC                 DataMaxTable1
   489 012A1 12C7 C        	CALL                Set_Table_Select
   490 012A2 047F C        	MOV                 DataMaxTable3,DataMaxTable3
   491 012A3 0E83 C        	JBS                 STATUS,Z
   492 012A4 16AC C        	JMP                 HID_NOT_END
   493 012A5 047E C        	MOV                 DataMaxTable2,DataMaxTable2
   494 012A6 0E83 C        	JBS                 STATUS,Z
   495 012A7 16AC C        	JMP                 HID_NOT_END
   496 012A8 047D C        	MOV                 DataMaxTable1,DataMaxTable1
   497 012A9 0E83 C        	JBS                 STATUS,Z
   498 012AA 16AC C        	JMP                 HID_NOT_END
   499 012AB 16C3 C        	JMP                 END_Fill_In_8Byte_Cycle
   500 012AC      C          HID_NOT_END:
   501 012AC 0D1C C        	JBC                 TableSelectFlag1/16,TableSelectFlag1%16
   502 012AD 16B2 C        	JMP                 Table1_Sel
   503 012AE 0D5C C        	JBC                 TableSelectFlag2/16,TableSelectFlag2%16
   504 012AF 16B6 C        	JMP                 Table2_Sel
   505 012B0 0D9C C        	JBC                 TableSelectFlag3/16,TableSelectFlag3%16
   506 012B1 16BA C        	JMP                 Table3_Sel
   507 012B2      C          Table1_Sel:
   508            C        	;DEC                 DataMaxTable1
   509 012B2 047D C        	MOV                 DataMaxTable1,DataMaxTable1
   510 012B3 0C83 C        	JBC                 STATUS,Z
   511 012B4 16E9 C        	JMP                 FINISH
   512 012B5 1626 C        	JMP                 REPORT_LOOP
   513 012B6      C          Table2_Sel:
   514            C        	;DEC                 DataMaxTable2
   515 012B6 047E C        	MOV                 DataMaxTable2,DataMaxTable2
   516 012B7 0C83 C        	JBC                 STATUS,Z
   517 012B8 16E9 C        	JMP                 FINISH
   518 012B9 1626 C        	JMP                 REPORT_LOOP
   519 012BA      C          Table3_Sel:
   520            C        	;DEC                 DataMaxTable3
   521 012BA 047F C        	MOV                 DataMaxTable3,DataMaxTable3
   522 012BB 0C83 C        	JBC                 STATUS,Z
   523 012BC 16E9 C        	JMP                 FINISH
   524 012BD 1626 C        	JMP                 REPORT_LOOP
   525            C        
   526 012BE      C          Null_Data:
   527 012BE 043C C        	MOV                 A,PC_WANT1
   528 012BF 0C83 C        	JBC                 STATUS,Z
   529 012C0 16E9 C        	JMP                 FINISH
   530 012C1 01FC C        	DEC                 PC_WANT1
   531 012C2 1688 C        	JMP                 To_Continue
   532            C        
   533 012C3      C          END_Fill_In_8Byte_Cycle:
   534 012C3 0000 C        	NOP
   535 012C4 09CC C        	BC                  RC,7
   536 012C5 0B8C C        	BS                  RC,6
   537 012C6 0012 C        	RET
   538            C        
   539 012C7      C          Set_Table_Select:
   540 012C7 047F C        	MOV                 DataMaxTable3,DataMaxTable3
   541 012C8 0E83 C        	JBS                 STATUS,Z
   542 012C9 12E1 C        	CALL                Set_Table3_Select
   543 012CA 047E C        	MOV                 DataMaxTable2,DataMaxTable2
   544 012CB 0E83 C        	JBS                 STATUS,Z
   545 012CC 12D9 C        	CALL                Set_Table2_Select
   546 012CD 047D C        	MOV                 DataMaxTable1,DataMaxTable1
   547 012CE 0E83 C        	JBS                 STATUS,Z
   548 012CF 12D1 C        	CALL                Set_Table1_Select
   549 012D0 0012 C        	RET
   550 012D1      C          Set_Table1_Select:
   551 012D1 0B1C C        	BS                  TableSelectFlag1/16,TableSelectFlag1%16
   552 012D2 095C C        	BC                  TableSelectFlag2/16,TableSelectFlag2%16
   553 012D3 099C C        	BC                  TableSelectFlag3/16,TableSelectFlag3%16
   554 012D4 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   555 012D5 1B9C C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   556 012D6 0C83 C        	JBC                 STATUS,Z
   557 012D7 00D8 C        	CLR                 TABLE_INDEX
   558 012D8 0012 C        	RET
   559 012D9      C          Set_Table2_Select:
   560 012D9 091C C        	BC                  TableSelectFlag1/16,TableSelectFlag1%16
   561 012DA 0B5C C        	BS                  TableSelectFlag2/16,TableSelectFlag2%16
   562 012DB 099C C        	BC                  TableSelectFlag3/16,TableSelectFlag3%16
   563 012DC 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   564 012DD 1B9C C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   565 012DE 0C83 C        	JBC                 STATUS,Z
   566 012DF 00D8 C        	CLR                 TABLE_INDEX
   567 012E0 0012 C        	RET
   568 012E1      C          Set_Table3_Select:
   569 012E1 091C C        	BC                  TableSelectFlag1/16,TableSelectFlag1%16
   570 012E2 095C C        	BC                  TableSelectFlag2/16,TableSelectFlag2%16
   571 012E3 0B9C C        	BS                  TableSelectFlag3/16,TableSelectFlag3%16
   572 012E4 0418 C        	MOV                 A,TABLE_INDEX         ;table max mustn't at 8*N,or it will error
   573 012E5 1B9C C        	XOR                 A,@(End_HID_Report_Table3-Begin_HID_Report_Table3)
   574 012E6 0C83 C        	JBC                 STATUS,Z
   575 012E7 00D8 C        	CLR                 TABLE_INDEX
   576 012E8 0012 C        	RET
   577            C        ;=========================================================
   578 012E9      C          FINISH:
   579 012E9 09CC C        	BC                  RC,7
   580 012EA 0B8C C        	BS                  RC,6
   581 012EB 08DC C        	BC                  SetupDataStageFlag/16,SetupDataStageFlag%16
   582 012EC 0012 C        	RET
   583            C        
   584            C        
   585            C        ;=================================================================
   586            C        ;	USB DATA FORMAT
   587            C        ;	BYTE1	BYTE2	BYTE3	BYTE4	BYTE5	BYTE6	BYTE7	BYTE8
   588            C        ;   BOOT	BTM	X_8	Y_8	--	--	--	--	--
   589            C        ;=================================================================
   590 012ED      C        SEND_USB_DATA:
   591 012ED 1801 C        	MOV                 A,@0X01
   592 012EE 004E C        	MOV                 RE,A			;BYTE1(BTM)
   593            C        
   594 012EF      C          REPORT_PROTOCOL_DATA:
   595 012EF 187F C        	MOV                 A,@0X7F
   596 012F0 004E C        	MOV                 RE,A			;BYTE2(X)
   597 012F1 004E C        	MOV                 RE,A			;BYTE3(Y)
   598 012F2 004E C        	MOV                 RE,A			;BYTE4
   599 012F3 004E C        	MOV                 RE,A			;BYTE5
   600 012F4 183F C        	MOV                 A,@0X3F
   601 012F5 004E C        	MOV                 RE,A			;BYTE6(X)
   602 012F6 1800 C        	MOV                 A,@0X00
   603 012F7 004E C        	MOV                 RE,A			;BYTE7(X)
   604 012F8 004E C        	MOV                 RE,A			;BYTE8(X)
   605            C        
   606 012F9 0C0D C        	JBC                 RD,0		;CHECK EP0 or EP1
   607 012FA 0B4C C        	BS                  RC,EP1_R
   608 012FB      C          RETURN:
   609 012FB 0012 C        	RET
   610            C        
   611            C        ;=================================================================================
   612            C        ;================================================================================
   613 012FC      C        USB_MAIN:
   614 012FC 0DDC C        	JBC                 UsbEP0interruptflag/16,UsbEP0interruptflag%16
   615 012FD 0012 C        	RET
   616 012FE 041B C        	MOV                 A,ComuClock    ;8ms
   617 012FF 1D40 C        	SUB                 A,@0X40
   618 01300 0C03 C        	JBC                 STATUS,C
   619 01301 170C C        	JMP                 Add_TimeCount
   620 01302 0550 C        	INC                 TEMP
   621 01303 00DB C        	CLR                 ComuClock
   622 01304 0410 C        	MOV                 A,TEMP
   623 01305 1D10 C        	SUB                 A,@0X10        ;T = 0x10*0X50*ComuClock
   624 01306 0C03 C        	JBC                 STATUS,C
   625 01307 170C C        	JMP                 Add_TimeCount
   626 01308 0000 C        	NOP
   627 01309 00D0 C        	CLR                 TEMP
   628 0130A 0BDC C        	BS                  UsbEP0interruptflag/16,UsbEP0interruptflag%16
   629 0130B 0012 C        	RET
   630 0130C      C         Add_TimeCount:
   631 0130C 0000 C        	NOP
   632 0130D 10E6 C        	CALL                PAGE4BANK0
   633 0130E 0D8C C        	JBC                 RC,EP0_R       ;EP0 FIFO READED ；it is auto clear by udc and data send out finish
   634 0130F 16FC C        	JMP                 USB_MAIN
   635 01310 0CDC C        	JBC                 SetupDataStageFlag/16,SetupDataStageFlag%16    ;CHECK SETUP TRANSFER DATA STAGE
   636 01311 1211 C        	CALL                EP0_REPORT
   637 01312 0000 C        	NOP
   638 01313 16FC C        	JMP                 USB_MAIN
   639            C        
   640            C        
   641            C        
   642            C        
   643            C        ;===================================================================================
   644            C        ; ipnut data
   645            C        ;=================================================================================
   646            C        
   647            C        
   648            C        
   649            C        
   650            C        ;============================ Digital MODE=================================
   651 01314      C        EP1_Report_1st:
   652            C        ;--------------------------------------------------------------------
   653 01314 10EC C        	CALL                PAGE4BANK2
   654 01315 0D4C C        	JBC                 RC,EP1_R         ;CHECK EP1 DATA HAS BEEN READED BY HOST
   655 01316 0012 C        	RET
   656 01317 094C C        	BC                  RC,EP1_R
   657 01318 1811 C        	MOV                 A,@0X11
   658 01319 004D C        	MOV                 RD,A		     ;EP1 POINTER&COUNTER
   659 0131A 00CE C        	CLR                 RE
   660 0131B 1801 C        	MOV                 A,@0X01
   661 0131C 004D C        	MOV                 RD,A             ;EP1 FIFO
   662            C        
   663 0131D 1801 C        	MOV                 A,@0X01
   664 0131E 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   665 0131F 0420 C        	MOV                 A,TX1_DATA1
   666 01320 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   667 01321 0421 C        	MOV                 A,TX1_DATA2
   668 01322 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   669 01323 0422 C        	MOV                 A,TX1_DATA3
   670 01324 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   671 01325 0423 C        	MOV                 A,TX1_DATA4
   672 01326 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   673 01327 0424 C        	MOV                 A,TX1_DATA5
   674 01328 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   675 01329 0425 C        	MOV                 A,TX1_DATA6
   676 0132A 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   677 0132B 0426 C        	MOV                 A,TX1_DATA7
   678 0132C 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   679            C        
   680 0132D 0B4C C        	BS                  RC,5
   681 0132E 0012 C        	RET
   682            C        
   683            C        ;------------------------------------------------------------------------
   684 0132F      C        EP1_Report_2nd:
   685 0132F 0000 C        	NOP
   686 01330 10EC C        	CALL                PAGE4BANK2
   687 01331 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   688 01332 0012 C        	RET
   689 01333 094C C        	BC                  RC,EP1_R
   690 01334 1811 C        	MOV                 A,@0X11
   691 01335 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   692 01336 00CE C        	CLR                 RE
   693 01337 1801 C        	MOV                 A,@0X01
   694 01338 004D C        	MOV                 RD,A        ;EP1 FIFO
   695            C        
   696 01339 1802 C        	MOV                 A,@0X02
   697 0133A 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   698 0133B 0428 C        	MOV                 A,TX2_DATA1
   699 0133C 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   700 0133D 0429 C        	MOV                 A,TX2_DATA2
   701 0133E 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   702 0133F 042A C        	MOV                 A,TX2_DATA3
   703 01340 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   704 01341 042B C        	MOV                 A,TX2_DATA4
   705 01342 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   706 01343 042C C        	MOV                 A,TX2_DATA5
   707 01344 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   708 01345 042D C        	MOV                 A,TX2_DATA6
   709 01346 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   710 01347 042E C        	MOV                 A,TX2_DATA7
   711 01348 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   712            C        
   713 01349 0B4C C        	BS                  RC,5
   714 0134A 0012 C        	RET
   715            C        
   716            C        ;---------------------------------------------------------------------------
   717 0134B      C        EP1_Report_3rd:
   718 0134B 10EC C        	CALL                PAGE4BANK2
   719 0134C 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   720 0134D 0012 C        	RET
   721 0134E 094C C        	BC                  RC,EP1_R
   722 0134F 1811 C        	MOV                 A,@0X11
   723 01350 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   724 01351 00CE C        	CLR                 RE
   725 01352 1801 C        	MOV                 A,@0X01
   726 01353 004D C        	MOV                 RD,A        ;EP1 FIFO
   727            C        
   728 01354 1803 C        	MOV                 A,@0X03
   729 01355 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   730 01356 0430 C        	MOV                 A,TX3_DATA1
   731 01357 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   732 01358 0431 C        	MOV                 A,TX3_DATA2
   733 01359 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   734 0135A 0432 C        	MOV                 A,TX3_DATA3
   735 0135B 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   736 0135C 0433 C        	MOV                 A,TX3_DATA4
   737 0135D 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   738 0135E 0434 C        	MOV                 A,TX3_DATA5
   739 0135F 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   740 01360 0435 C        	MOV                 A,TX3_DATA6
   741 01361 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   742 01362 0436 C        	MOV                 A,TX3_DATA7
   743 01363 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   744            C        
   745 01364 0B4C C        	BS                  RC,5
   746 01365 0012 C        	RET
   747            C        
   748            C        ;---------------------------------------------------------------------------
   749 01366      C        EP1_Report_4th:
   750 01366 10EC C        	CALL                PAGE4BANK2
   751 01367 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   752 01368 0012 C        	RET
   753 01369 094C C        	BC                  RC,EP1_R
   754 0136A 1811 C        	MOV                 A,@0X11
   755 0136B 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   756 0136C 00CE C        	CLR                 RE
   757 0136D 1801 C        	MOV                 A,@0X01
   758 0136E 004D C        	MOV                 RD,A        ;EP1 FIFO
   759            C        
   760 0136F 1804 C        	MOV                 A,@0X04
   761 01370 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   762 01371 0438 C        	MOV                 A,TX4_DATA1
   763 01372 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   764 01373 0439 C        	MOV                 A,TX4_DATA2
   765 01374 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   766 01375 043A C        	MOV                 A,TX4_DATA3
   767 01376 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   768 01377 043B C        	MOV                 A,TX4_DATA4
   769 01378 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   770 01379 043C C        	MOV                 A,TX4_DATA5
   771 0137A 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   772 0137B 043D C        	MOV                 A,TX4_DATA6
   773 0137C 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   774 0137D 043E C        	MOV                 A,TX4_DATA7
   775 0137E 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   776            C        
   777 0137F 0B4C C        	BS                  RC,5
   778 01380 0012 C        	RET
   779            C        
   780            C        ;---------------------------------------------------------------------------
   781 01381      C        EP1_Report_5th:
   782 01381 10EF C        	CALL                PAGE4BANK3
   783 01382 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   784 01383 0012 C        	RET
   785 01384 094C C        	BC                  RC,EP1_R
   786 01385 1811 C        	MOV                 A,@0X11
   787 01386 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   788 01387 00CE C        	CLR                 RE
   789 01388 1801 C        	MOV                 A,@0X01
   790 01389 004D C        	MOV                 RD,A        ;EP1 FIFO
   791            C        
   792 0138A 1805 C        	MOV                 A,@0X05
   793 0138B 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   794 0138C 0420 C        	MOV                 A,TX5_DATA1
   795 0138D 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   796 0138E 0421 C        	MOV                 A,TX5_DATA2
   797 0138F 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   798 01390 0422 C        	MOV                 A,TX5_DATA3
   799 01391 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   800 01392 0423 C        	MOV                 A,TX5_DATA4
   801 01393 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   802 01394 0424 C        	MOV                 A,TX5_DATA5
   803 01395 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   804 01396 0425 C        	MOV                 A,TX5_DATA6
   805 01397 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   806 01398 0426 C        	MOV                 A,TX5_DATA7
   807 01399 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   808            C        
   809 0139A 0B4C C        	BS                  RC,5
   810 0139B 0012 C        	RET
   811            C        
   812            C        ;---------------------------------------------------------------------------
   813 0139C      C        EP1_Report_6th:
   814 0139C 10EF C        	CALL                PAGE4BANK3
   815 0139D 0D4C C        	JBC                 RC,EP1_R    ;CHECK EP1 DATA HAS BEEN READED BY HOST
   816 0139E 0012 C        	RET
   817 0139F 094C C        	BC                  RC,EP1_R
   818 013A0 1811 C        	MOV                 A,@0X11
   819 013A1 004D C        	MOV                 RD,A		;EP1 POINTER&COUNTER
   820 013A2 00CE C        	CLR                 RE
   821 013A3 1801 C        	MOV                 A,@0X01
   822 013A4 004D C        	MOV                 RD,A        ;EP1 FIFO
   823            C        
   824 013A5 1806 C        	MOV                 A,@0X06
   825 013A6 004E C        	MOV                 RE,A             ;BYTE1 (ID)
   826 013A7 0428 C        	MOV                 A,TX6_DATA1
   827 013A8 004E C        	MOV                 RE,A             ;BYTE2 (LX)
   828 013A9 0429 C        	MOV                 A,TX6_DATA2
   829 013AA 004E C        	MOV                 RE,A             ;BYTE3 (LY)
   830 013AB 042A C        	MOV                 A,TX6_DATA3
   831 013AC 004E C        	MOV                 RE,A             ;BYTE4 (RX)
   832 013AD 042B C        	MOV                 A,TX6_DATA4
   833 013AE 004E C        	MOV                 RE,A             ;BYTE5 (RY)
   834 013AF 042C C        	MOV                 A,TX6_DATA5
   835 013B0 004E C        	MOV                 RE,A             ;BYTE6 "A_1  B_2  C_3  D_4  L1_5  R1_6  L2_7  R2_8"
   836 013B1 042D C        	MOV                 A,TX6_DATA6
   837 013B2 004E C        	MOV                 RE,A             ;BYTE7 "SEL_9  START_10  LSW_11  RSW_12  T_13  T_14  MACRO   MODE"
   838 013B3 042E C        	MOV                 A,TX6_DATA7
   839 013B4 004E C        	MOV                 RE,A             ;BYTE8 (Hat Switch)
   840            C        
   841 013B5 0B4C C        	BS                  RC,5
   842 013B6 0012 C        	RET
   843            C        
    14            C        include "Keyscan.ASM"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        include "Keyscan.H"
     1            C        ;==================================================================
     2            C        ;  Tilte:       EM78M198810 include file		;
     3            C        ;  NAME:        EM198810_FOR_EM78M611.ASM
     4            C        ;  Description: The Definition of EM78M198810 for EM78612 Registers ;
     5            C        ;  Company:     Elan Electronic Corp.		;
     6            C        ;  Author:      YU.WEI				;
     7            C        ;  Date:        2009.02.26			;
     8            C        ;  Version:     v1.0				;
     9            C        ;  Tool:        wiceplus 2.7
    10            C        ;=========================================================================
    11            C        
    12            C        ;------------------------------------------------------
    13            C        KeyScan.H         EQU     KeyScan.H
    14            C        
    15            C        ;------------------------------------------------------
    16       0038 C        KeyScanTimeCNT_Default      EQU     56
    17            C        
    12            C        
    13            C        ifndef EM78CtrlIns.H
    14            C        include "EM78CtrlIns.H"
    15            C        endif
    16            C        ;=========================================================================
    17            C        
    18            C        
    19            C        	ORG                 0X1100 ;page 4
    20            C        	MESSAGE "define 'keyscan.asm' ROM address"
***     USER MESSAGE: DEFINE 'KEYSCAN.ASM' ROM ADDRESS
    21            C        ;**********************************************************************************
    22            C        ;*********************************************************************************
    23            C        ; Connect Key Scan
    24            C        ; Input:
    25            C        ; output: KEY_NUM
    26            C        ;         KeyScanStatusFlag
    27            C        ;*********************************************************************************
    28 01100      C        ConnectKey_Scan:
    29 01100 10E9 C        	CALL                PAGE4BANK1
    30 01101 0000 C        	NOP
    31 01102 0409 C        	MOV                 A,Port9                   ; Port9_2
    32 01103 1A04 C        	AND                 A,@00000100B
    33 01104 0050 C        	MOV                 TEMP,A
    34 01105 1804 C        	MOV                 A,@00000100B              ; Bit2
    35 01106 02F4 C        	AND                 KeystokeFlag_Befor,A
    36            C        	
    37 01107 0435 C        	MOV                 A,KeySystemTimeCNT
    38 01108 1D38 C        	SUB                 A,@KeyScanTimeCNT_Default        ; 
    39 01109 0C03 C        	JBC                 STATUS,C
    40 0110A 150D C        	JMP                 Falling_Edge_Judge
    41 0110B 0576 C        	INC                 KeystokeTimeCNT
    42 0110C 00F5 C        	CLR                 KeySystemTimeCNT
    43 0110D      C        Falling_Edge_Judge:
    44 0110D 0410 C        	MOV                 A,TEMP
    45 0110E 0334 C        	XOR                 A,KeystokeFlag_Befor      ; bit 3, Check edge
    46 0110F 0C83 C        	JBC                 STATUS,Z
    47 01110 151B C        	JMP                 Rising_Edge_Judge         ; no edge occur
    48 01111 0410 C        	MOV                 A,TEMP                    ; Falling edge will change
    49 01112 1B00 C        	XOR                 A,@00000000B
    50 01113 0E83 C        	JBS                 STATUS,Z
    51 01114 151B C        	JMP                 Rising_Edge_Judge         ; no falling edge
    52 01115 0F9F C        	JBS                 KeyScanStatusFlag/16,KeyScanStatusFlag%16        ; scan the first falling edge
    53 01116 0A37 C        	BS                  KEY_NUM,0                            ; Will into key scan, Set leader bit
    54 01117 00F6 C        	CLR                 KeystokeTimeCNT                      ; press times ,recalculate
    55 01118 095F C        	BC                  KeyStatusFlag/16,KeyStatusFlag%16    ; key status, press(0) or release(1)
    56 01119 0B9F C        	BS                  KeyScanStatusFlag/16,KeyScanStatusFlag%16	     ; into scan key status
    57 0111A 1527 C        	JMP                 Edge_Judge_End
    58            C        
    59            C        ;--------------------------------------------------------------------
    60 0111B      C        Rising_Edge_Judge:
    61 0111B 0410 C        	MOV                 A,TEMP
    62 0111C 0334 C        	XOR                 A,KeystokeFlag_Befor      ; bit 3, Check edge
    63 0111D 0C83 C        	JBC                 STATUS,Z
    64 0111E 1527 C        	JMP                 Edge_Judge_End
    65 0111F 0410 C        	MOV                 A,TEMP                    ; rising edge will change
    66 01120 1B04 C        	XOR                 A,@00000100B
    67 01121 0E83 C        	JBS                 STATUS,Z
    68 01122 1527 C        	JMP                 Edge_Judge_End
    69 01123 0000 C        	NOP
    70 01124 1135 C        	CALL                KeyStatus_Low_Scan        ; rising edge ,check low level time
    71 01125 00F6 C        	CLR                 KeystokeTimeCNT           ; press times ,recalculate
    72 01126 0B5F C        	BS                  KeyStatusFlag/16,KeyStatusFlag%16
    73 01127      C        Edge_Judge_End:
    74 01127 0410 C        	MOV                 A,TEMP                    ; save currently press key status used for next judge
    75 01128 0074 C        	MOV                 KeystokeFlag_Befor,A
    76            C        
    77            C        ;------------------------------------------------------------------------------
    78 01129      C        KeystokeScan_End:                                                   ; a cycle scan end
    79 01129 0DF7 C        	JBC                 KEY_NUM,7                                   ; Count overflow
    80 0112A 00F7 C        	CLR                 KEY_NUM
    81            C        
    82 0112B 0436 C        	MOV                 A,KeystokeTimeCNT
    83 0112C 1D46 C        	SUB                 A,@70                                       ; 70*56ms=3920ms(ComuTime=56ms)
    84 0112D 0C03 C        	JBC                 STATUS,C
    85            C        	;INC                 KeystokeTimeCNT                             ; press times ,recalculate
    86            C        
    87 0112E 0436 C        	MOV                 A,KeystokeTimeCNT
    88 0112F 1B11 C        	XOR                 A,@17                                       ; 17*56ms=960ms(ComuTime=56ms)
    89 01130 0E83 C        	JBS                 STATUS,Z                                    ;
    90 01131 0012 C        	RET
    91 01132 099F C        	BC                  KeyScanStatusFlag/16,KeyScanStatusFlag%16	            ; more than 800ms ,EXIT scan status
    92 01133 0B1F C        	BS                  KeyScanFinishFlag/16,KeyScanFinishFlag%16
    93 01134 0012 C        	RET
    94            C        
    95            C        
    96            C        ;=========================================================================
    97 01135      C        KeyStatus_Low_Scan:     ; rising edge ,check low level time
    98 01135 0436 C        	MOV                 A,KeystokeTimeCNT
    99 01136 1D06 C        	SUB                 A,@6                       ;40*8ms=320ms(ComuTime=8ms)
   100 01137 0C03 C        	JBC                 STATUS,C                   ;
   101 01138 153A C        	JMP                 KeyScan_Short_Press	       ;less than 510ms
   102 01139 153D C        	JMP                 KeyScan_Lasting_Press      ;more than 510ms
   103 0113A      C        KeyScan_Short_Press:
   104 0113A 0803 C        	BC                  STATUS,C
   105 0113B 06F7 C        	RLC                 KEY_NUM
   106 0113C 0012 C        	RET
   107 0113D      C        KeyScan_Lasting_Press:
   108 0113D 0A03 C        	BS                  STATUS,C
   109 0113E 06F7 C        	RLC                 KEY_NUM
   110 0113F 0012 C        	RET
   111            C        
   112            C        
   113            C        
    15            C        
    16            C        ifndef EM78CtrlIns.H
    17            C        include "EM78CtrlIns.H"
    18            C        endif
    19            C        
    20            C        ifndef M611rxP40.H
    21            C        include "M611rxP40.H"
    22            C        endif
    23            C        
    24            C        ifndef XX93C46_For_EM78M611.ASM
    25            C        include "XX93C46_For_EM78M611.ASM"
     1            C        ;***********************************************************************;
     2            C        ; Tilte: Em78M611 spi FOR AT93C46 Function macro Code                  ;
     3            C        ; Description:库中共包括以下七个功能宏                                  ;
     4            C        ;     1."mEWEN"  允许写/擦数据的宏。                                    ;
     5            C        ;     2."mEWDS"  禁止写/擦数据的宏 。                                   ;
     6            C        ;     3."mWRITE" 写如数据的宏，可以连续写多个字节，且写入数据可以不同   ;
     7            C        ;     4."mREAD"  读数据的宏，可以连续读多个字节。                       ;
     8            C        ;     5."mERASE" 擦除数据的宏，可以擦除多个连续字节。                   ;
     9            C        ;     6."mERAL"  擦除所有数据的宏，所有地址的内容都为"FF"。             ;
    10            C        ;     7."mWRAL"  把所有地址写入同以数据的宏。                           ;
    11            C        ; Company: Elan Corp. Inc                                               ;
    12            C        ; Author:  yu.wei                                                     ;
    13            C        ; Date:    2009.3.20                                                    ;
    14            C        ; Version: v1.0                                                         ;
    15            C        ; 说明：在使用此库时先要定义好作为通讯口的定义。                        ;
    16            C        ;***********************************************************************
    17            C        ;说明：
    18            C        ;    1. 本程式所写及读的数据都为8bit;
    19            C        ;------------------------------------------------------
    20            C        ; spi          Port Used For 93C46 Control.
    21            C        ; cs           Port Pin Tied To cs On 93C46.
    22            C        ; sk           Port Pin Tied To sk On 93C46.
    23            C        ; di           Port Pin Tied To di On 93C46.
    24            C        ; DO           Port Pin Tied To DO On 93C46.
    25            C        ; r_acc1     This Register Contains The 2 Bit 93C46
    26            C        ;              Command Is The High 2 Bit Positions And
    27            C        ;              memory Address In The Lower 6.
    28            C        ;--------------------------------------------------
    29            C        ;Instruction   SB    Op Code     Address               Data	         
    30            C        ;                               x8       x16       x8       x16	
    31            C        ;    READ       1      10 	A6 - A0  A5 - A0				
    32            C        ;    EWEN       1 	   00     11XXXXX  11XXXX 				
    33            C        ;    ERASE      1      11     A6 - A0  A5 - A0 				
    34            C        ;    WRITE      1 	   01 	A6 - A0  A5 - A0   D7 - D0  D15- D0  
    35            C        ;    ERAL       1 	   00 	10XXXXX  10XXXX 					
    36            C        ;    WRAL       1 	   00 	01XXXXX  01XXXX    D7 - D0  D15- D0  
    37            C        ;    EWDS       1 	   00 	00XXXXX  00XXXX 				
    38            C        ;=================================================================================
    39            C        XX93C46_For_EM78M611.ASM       EQU        XX93C46_For_EM78M611.ASM
    40            C        
    41            C        ifndef XX93C46_For_EM78M611.H
    42            C        include "XX93C46_For_EM78M611.H"
     1            C        ;---------------------------------------------------
     2            C        XX93C46_For_EM78M611.H         EQU        XX93C46_For_EM78M611.H
     3            C        
     4            C        ;---------------------------------------------------
     5            C        ;  93C46 INSTRUCTION  COmmAND
     6            C        ;--------------------------------------------------
     7       0080 C                READ        EQU     0X80    ;93C46 Read Command.
     8       0040 C                WRITE       EQU     0X40    ;93C46 Write Command.
     9       00C0 C                ERASE       EQU     0XC0    ;93C46 Erase Command.
    10       0030 C                EWEN        EQU     0X30    ;93C46 Erase/Write Enable Command.
    11       0000 C                EWDS        EQU     0X00    ;93C46 Erase/Write Disable Command.
    12       0020 C                ERAL        EQU     0X20    ;92C46 Erase All Command.
    13       0010 C                WRAL        EQU     0X10    ;92C46 Write All Command.
    14            C        ;--------------------------------------------------
    43            C        endif
    44            C        
    45            C        ifndef EM78CtrlIns.H
    46            C        include "EM78CtrlIns.H"
    47            C        endif
    48            C        
    49            C        
    50            C        		ORG     0X300
    51            C        ;***********************************************************************;
    52            C        ;Program name: mEWEN m,spi    m 数据的位数（8BIT或16BIT）               ;
    53            C        ;Description:  允许写/擦除操作的指令写入                                ;
    54            C        ;Input:        选择数据类型 m==8或m==16  m代表数据位数                  ;
    55            C        ;              定义好spi及其cs,sk,di,DO位                               ;
    56            C        ;Output:       使能写/擦除操作                                          ;
    57            C        ;Variable Register:None                                                 ;
    58            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
    59            C        ;***********************************************************************;
    60            C        mEWEN   MACRO   
    61            C                FCALL    Start_Bit       ;load start bit
    62            C                MOV     A,@ewen         ;enable erase/write
    63            C                MOV     r_acc1,A
    64            C                ;
    65            C                MOV     A,@9
    66            C                ;
    67            C                FCALL    Rl_Comd         ;finish enable erase/write
    68            C                BC      AT93C46_CS/16,AT93C46_CS%16          ;load end bit
    69            C                BC      SPI_CLK/16,SPI_CLK%16
    70            C                BC      SPI_MOSI/16,SPI_MOSI%16
    71            C                ENDM
    72            C        ;
    73            C        ;***********************************************************************;
    74            C        ;Program name:  mEWDS m,spi    m 数据的位数（8BIT或16BIT）              ;
    75            C        ;Description:   禁止写/擦除操作的指令写入                               ;
    76            C        ;Input:         选择数据类型 m==8或m==16  m代表数据位数；               ;
    77            C        ;               定义好spi及其cs,sk,di,DO位                              ;
    78            C        ;Output:        禁止写/擦除操作                                         ;
    79            C        ;Variable Register:None                                                 ;
    80            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
    81            C        ;***********************************************************************;
    82            C        mEWDS   MACRO     
    83            C                FCALL     Start_Bit       ;写入起始位
    84            C                MOV      A,@ewds         ;禁止写和擦除动作
    85            C                MOV      r_acc1,A
    86            C                ;
    87            C                MOV      A,@9
    88            C                ;
    89            C                FCALL     Rl_Comd
    90            C                BC       AT93C46_CS/16,AT93C46_CS%16
    91            C                BC       SPI_CLK/16,SPI_CLK%16
    92            C                BC       SPI_MOSI/16,SPI_MOSI%16          ;完成使能写操作指令的写入
    93            C                ENDM
    94            C        ;
    95            C        ;***********************************************************************;
    96            C        ;Program name:  mWRITE m,DataAddressInEEPROM,k,DataAddressInMCU,spi                            ;
    97            C        ;Description:   指定数据块写入到指定地址                                ;
    98            C        ;Input:         m 选择数据类型 m==8或16                                 ;
    99            C        ;               DataAddressInEEPROM  内容为要写入数据的最低位地址(93C46的地址）      ;
   100            C        ;               k 要写入数据的地址总数                                  ;
   101            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   102            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   103            C        ;Output:        写入指定数据块到指定地址块                              ;
   104            C        ;Variable Register:None                                                 ;
   105            C        ;Register Changed: STATUS,ACC ,
   106            C        ;                  r_acc1(0X21) ,
   107            C        ;                  r_acc2(0X22),         ;
   108            C        ;                  r_acc3(0X23)                                       ;
   109            C        ;***********************************************************************;
   110            C        mWRITE  MACRO   DataAddressInEEPROM,@BankSel,DataAddressInMCU,@k
   111            C                BANK    @BankSel
   112            C                MOV     A,DataAddressInMCU    ;写入数据存放的最低地址为0X24（mCU的地址）
   113            C                MOV     R4,A                   ;存放数据的间接地址
   114            C                MOV     A,@k
   115            C                MOV     r_acc3,A               ;写入93C46的字节数
   116            C        $Write_Data:
   117            C                FCALL    Start_Bit             ;写入起始位
   118            C               ;
   119            C                BC      STATUS,C
   120            C                RRCA    DataAddressInEEPROM
   121            C                ;
   122            C                OR      A,@write
   123            C                MOV     r_acc1,A               ;高二位为写命令，低六位为地址
   124            C                MOV     A,@8                   ;向93C46写一个字节，控制数
   125            C                FCALL    Rl_Comd               ;写入指令“写”和要写入数据的地址
   126            C               ;
   127            C                BC      SPI_CLK/16,SPI_CLK%16
   128            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   129            C                BC      SPI_MOSI/16,SPI_MOSI%16
   130            C                JBC     DataAddressInEEPROM,0
   131            C                BS      SPI_MOSI/16,SPI_MOSI%16
   132            C                JMP     $+1
   133            C                BS      SPI_CLK/16,SPI_CLK%16          ;以上为写入OP和ADDRESS
   134            C                ;
   135            C                INC     DataAddressInEEPROM
   136            C        $Data_H_L:
   137            C                MOV     A,R0
   138            C                MOV     r_acc1,A      ;装入要写入的数据
   139            C                INC     R4
   140            C                MOV     A,@8
   141            C                FCALL    Rl_Comd         ;写入8BIT数据
   142            C               ;
   143            C                JMP     $+1
   144            C               ;
   145            C                BC      AT93C46_CS/16,AT93C46_CS%16
   146            C                BC      SPI_CLK/16,SPI_CLK%16          ;数据写完，写结束位
   147            C                ;BC      AT93C46_CS/16,AT93C46_CS%16
   148            C                BC      SPI_MOSI/16,SPI_MOSI%16
   149            C                JMP     $+1
   150            C                BS      SPI_CLK/16,SPI_CLK%16
   151            C                BS      AT93C46_CS/16,AT93C46_CS%16          ;完成结束位的写入
   152            C                JBS     SPI_MISO/16,SPI_MISO%16
   153            C                JMP     $-1
   154            C                BC      AT93C46_CS/16,AT93C46_CS%16
   155            C                DJZ     r_acc3        ;多字节写入控制
   156            C                JMP     $Write_Data
   157            C                ENDM
   158            C        ;
   159            C        ;***********************************************************************;
   160            C        ;Program name:  mREAD m,DataAddressInEEPROM,k,DataAddressInMCU,spi                             ;
   161            C        ;Description:   从指定地址块（93C46）读出数据到指定地址块(CPU)          ;
   162            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   163            C        ;               DataAddressInEEPROM  内容为要读出数据的最低位地址(93C46的地址）      ;
   164            C        ;               k 要写入数据的地址总数                                  ;
   165            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   166            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   167            C        ;Output:        指定地址读出指定数据块                                  ;
   168            C        ;Variable Register:None                                                 ;
   169            C        ;Register Changed: STATUS,ACC ,
   170            C        ;                  r_acc1(0X21) ,
   171            C        ;                  r_acc2(0X22),         ;
   172            C        ;                  r_acc3(0X23)                                       ;
   173            C        ;***********************************************************************;
   174            C        mREAD   MACRO   DataAddressInEEPROM,@BankSel,DataAddressInMCU,@k
   175            C                MOV     A,DataAddressInMCU              ;写入数据存放的最低地址（mCU的地址）     ;
   176            C                MOV     R4,A
   177            C                BANK    @BankSel
   178            C                MOV     A,@k
   179            C                MOV     r_acc3,A
   180            C        $Write_Data:
   181            C                FCALL    Start_Bit       ;写入起始位
   182            C               ;
   183            C                RRCA    DataAddressInEEPROM
   184            C                ;
   185            C                OR      A,@READ
   186            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   187            C                MOV     A,@8            ;向93C46写一个字节，控制数
   188            C                FCALL    Rl_Comd         ;写入指令“读”和要写入数据的地址
   189            C               ;
   190            C                BC      SPI_CLK/16,SPI_CLK%16
   191            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   192            C                BC      SPI_MOSI/16,SPI_MOSI%16
   193            C                JBC     DataAddressInEEPROM,0
   194            C                BS      SPI_MOSI/16,SPI_MOSI%16
   195            C                JMP     $+1
   196            C                BS      SPI_CLK/16,SPI_CLK%16
   197            C               ;
   198            C                INC     DataAddressInEEPROM          ;地址加1
   199            C                BC      SPI_MOSI/16,SPI_MOSI%16
   200            C                JMP     $+1
   201            C                BC      SPI_CLK/16,SPI_CLK%16
   202            C                JMP     $+1
   203            C                JMP     $+1
   204            C                BS      SPI_CLK/16,SPI_CLK%16
   205            C        
   206            C        $Read_Data1:
   207            C                MOV     A,@8
   208            C                MOV     r_acc2,A
   209            C        $Read_Data2:
   210            C                BC      SPI_CLK/16,SPI_CLK%16
   211            C                NOP
   212            C                NOP
   213            C                JBC     SPI_MISO/16,SPI_MISO%16
   214            C                BS      STATUS,C
   215            C                JBS     SPI_MISO/16,SPI_MISO%16
   216            C                BC      STATUS,C
   217            C                RLC     R0
   218            C                BS      SPI_CLK/16,SPI_CLK%16
   219            C                JMP     $+1
   220            C                DJZ     r_acc2
   221            C                JMP     $Read_Data2
   222            C                INC     R4
   223            C                ;
   224            C                NOP
   225            C                ;
   226            C                BC      AT93C46_CS/16,AT93C46_CS%16
   227            C                DJZ     r_acc3
   228            C                JMP     $Write_Data
   229            C                ENDM
   230            C        ;
   231            C        ;***********************************************************************;
   232            C        ;Program name:  mERASE m,DataAddressInEEPROM,k,spi                                   ;
   233            C        ;Description:   从指定地址块擦除数据                                    ;
   234            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   235            C        ;               DataAddressInEEPROM 内容为要擦除数据的最低位地址(93C46的地址）       ;
   236            C        ;               k 要擦除数据的地址总数                                  ;
   237            C        ;               spi    选择PORT作为通信口，要定义好cs,sk,di,DO相关位    ;
   238            C        ;Output:        指定地址块的数据被擦除                                  ;
   239            C        ;Variable Register:None                                                 ;
   240            C        ;Register Changed: STATUS,ACC ,
   241            C        ;                  r_acc1(0X21) ,
   242            C        ;                  r_acc2(0X22),         ;
   243            C        ;                  r_acc3(0X23)                                       ;
   244            C        ;***********************************************************************;
   245            C        mERASE  MACRO    DataAddressInEEPROM,k
   246            C                MOV     A,@k
   247            C                MOV     r_acc3,A      ;写入93C46的字节数
   248            C        $Write_Data:
   249            C                CALL    Start_Bit       ;写入起始位
   250            C               ;
   251            C                RRCA    DataAddressInEEPROM
   252            C               ;
   253            C                OR      A,@ERASE
   254            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   255            C                MOV     A,@8            ;向93C46写一个字节，控制数
   256            C                CALL    Rl_Comd         ;写入指令“写”和要写入数据的地址
   257            C                ;
   258            C                BC      SPI_CLK/16,SPI_CLK%16
   259            C                JBS     DataAddressInEEPROM,0        ;写入8BIT模式时的地址最低位
   260            C                BC      SPI_MOSI/16,SPI_MOSI%16
   261            C                JBC     DataAddressInEEPROM,0
   262            C                BS      SPI_MOSI/16,SPI_MOSI%16
   263            C                JMP     $+1
   264            C                BS      SPI_CLK/16,SPI_CLK%16          ;完成命令的写入
   265            C                JMP     $+1
   266            C                JMP     $+1
   267            C               ;
   268            C                INC     DataAddressInEEPROM
   269            C                BC      AT93C46_CS/16,AT93C46_CS%16
   270            C                BC      SPI_CLK/16,SPI_CLK%16
   271            C                BC      SPI_MOSI/16,SPI_MOSI%16
   272            C                JMP     $+1
   273            C                BS      SPI_CLK/16,SPI_CLK%16
   274            C                BS      AT93C46_CS/16,AT93C46_CS%16
   275            C                JBS     SPI_MISO/16,SPI_MISO%16
   276            C                JMP     $-1
   277            C                BC      AT93C46_CS/16,AT93C46_CS%16
   278            C        ;
   279            C                DJZ     r_acc3
   280            C                JMP     $Write_Data
   281            C                ENDM
   282            C        ;
   283            C        ;***********************************************************************;
   284            C        ;Program name:  mERAL m,spi                                             ;
   285            C        ;Description:   擦除所有地址的数据                                      ;
   286            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   287            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   288            C        ;Output:        所有地址的数据被擦除，变为“FF"                         ;
   289            C        ;Variable Register:None                                                 ;
   290            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
   291            C        ;***********************************************************************
   292            C        mERAL   MACRO   
   293            C        $Write_Data:
   294            C                FCALL   Start_Bit       ;写入起始位
   295            C                MOV     A,@ERAL
   296            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   297            C               ;
   298            C                MOV     A,@9
   299            C               ;
   300            C                FCALL    Rl_Comd
   301            C                BC      AT93C46_CS/16,AT93C46_CS%16
   302            C                BC      SPI_CLK/16,SPI_CLK%16
   303            C                BC      SPI_MOSI/16,SPI_MOSI%16
   304            C                JMP     $+1
   305            C                BS      SPI_CLK/16,SPI_CLK%16
   306            C                BS      AT93C46_CS/16,AT93C46_CS%16
   307            C                JBS     SPI_MISO/16,SPI_MISO%16
   308            C                JMP     $-1
   309            C                BC      AT93C46_CS/16,AT93C46_CS%16
   310            C                ENDM
   311            C        ;
   312            C        ;***********************************************************************;
   313            C        ;Program name:  mWRAL m,DataAddressInMCU,spi                                      ;
   314            C        ;Description:   一个指定数据写入到所有地址                              ;
   315            C        ;Input:         m 选择数据类型 m==8或16                                 ;
   316            C        ;               spi  选择PORT作为通信口，要定义好cs,sk,di,DO相关位      ;
   317            C        ;               DataAddressInMCU  内容为存放数据的最低位地址（mCU的地址）         ;
   318            C        ;Output:        所有地址写入同一指定数据                                ;
   319            C        ;Variable Register:None                                                 ;
   320            C        ;Register Changed: STATUS,ACC ,r_acc1(0X21) , r_acc2(0X22)          ;
   321            C        ;***********************************************************************;
   322            C        mWRAL   MACRO   @DataAddressInMCU
   323            C                MOV     A,@DataAddressInMCU
   324            C                MOV     R4,A            ;存放数据的间接地址
   325            C                CALL    Start_Bit       ;写入起始位
   326            C                MOV     A,@WRAL
   327            C                MOV     r_acc1,A      ;高二位为写命令，低六位为地址
   328            C                ;
   329            C                MOV     A,@9
   330            C                ;
   331            C                CALL    Rl_Comd
   332            C        $Data_H_L:
   333            C                MOV     A,R0
   334            C                MOV     r_acc1,A      ;装入要写入的数据
   335            C                INC     R4
   336            C                MOV     A,@8
   337            C                CALL    Rl_Comd         ;写入8BIT数据
   338            C                ;
   339            C                NOP
   340            C                ;
   341            C                BC      SPI_CLK/16,SPI_CLK%16          ;数据写完，写结束位
   342            C                BC      AT93C46_CS/16,AT93C46_CS%16
   343            C                BC      SPI_MOSI/16,SPI_MOSI%16
   344            C                JMP     $+1
   345            C                BS      SPI_CLK/16,SPI_CLK%16
   346            C                BS      AT93C46_CS/16,AT93C46_CS%16          ;完成结束位的写入
   347            C                JBS     SPI_MISO/16,SPI_MISO%16
   348            C                JMP     $-1
   349            C                BC      AT93C46_CS/16,AT93C46_CS%16
   350            C                BC      SPI_CLK/16,SPI_CLK%16
   351            C                ENDM
   352            C        
   353            C        
   354            C        
   355            C        
   356            C        ;-------------------------------------------------------
   357 00300      C        Start_Bit:
   358            C      M 		BANK    @0
       00300 09C4     1     BC  4 , 7 
       00301 0984     1     BC  4 , 6 
   359 00302 0985 C                BC      AT93C46_CS/16,AT93C46_CS%16
   360 00303 0886 C                BC      SPI_CLK/16,SPI_CLK%16
   361 00304 08C6 C                BC      SPI_MOSI/16,SPI_MOSI%16
   362 00305 1706 C                JMP     $+1
   363 00306 1707 C                JMP     $+1
   364 00307 0B85 C                BS      AT93C46_CS/16,AT93C46_CS%16
   365 00308 1709 C                JMP     $+1
   366 00309 170A C                JMP     $+1
   367 0030A 0AC6 C                BS      SPI_MOSI/16,SPI_MOSI%16       ;PORT6,SPI_MOSI;
   368 0030B 170C C                JMP     $+1
   369 0030C 170D C                JMP     $+1
   370 0030D 0A86 C                BS      SPI_CLK/16,SPI_CLK%16
   371 0030E 0012 C                RET
   372            C        
   373            C        ;--------------------------------------------------------
   374 0030F      C        Rl_Comd:
   375 0030F 0059 C        	MOV     DataShiftCounter,A
   376            C      M 	BANK    @0
       00310 09C4     1     BC  4 , 7 
       00311 0984     1     BC  4 , 6 
   377 00312      C        Rl_Comd1:
   378 00312 0886 C        	BC      SPI_CLK/16,SPI_CLK%16
   379 00313 1714 C        	JMP     $+1
   380 00314 0803 C        	bc      status,c
   381 00315 06D1 C        	RLC     r_acc1        ;要写入的数据
   382 00316 0E03 C        	JBS     STATUS,C
   383 00317 08C6 C        	BC      SPI_MOSI/16,SPI_MOSI%16
   384 00318 0C03 C        	JBC     STATUS,C
   385 00319 0AC6 C        	BS      SPI_MOSI/16,SPI_MOSI%16
   386 0031A 0000 C        	NOP
   387 0031B 0000 C        	NOP
   388 0031C 0A86 C        	BS      SPI_CLK/16,SPI_CLK%16
   389 0031D 171E C        	JMP     $+1
   390 0031E 05D9 C        	DJZ     DataShiftCounter
   391 0031F 1712 C        	JMP     Rl_Comd1
   392 00320 0012 C        	RET                   ;    return
   393            C        
   394            C        
    26            C        endif
    27            C        
    28            C        ;=========================================================================
    29            C        
    30            C        	ORG                 0X1000	;PAGE 4
    31            C        	MESSAGE "define 'M611ManageFunc.ASM' ROM address"
***     USER MESSAGE: DEFINE 'M611MANAGEFUNC.ASM' ROM ADDRESS
    32            C        ;********************************************************************************
    33            C        ; TX data to PC
    34            C        ;********************************************************************************
    35            C        ;===================================================================
    36            C        ;Function:      setting
    37            C        ;Input:         None
    38            C        ;Output:        None
    39            C        ;====================================================================
    40 01000      C        CommTypeScan_Func:
    41 01000 10E9 C        	CALL                PAGE4BANK1
    42 01001 0F5E C        	JBS                 ForceLinkModeFlag/16,ForceLinkModeFlag%16
    43 01002 1409 C        	JMP                 KeyType_Scan
    44            C        
    45 01003 0417 C        	MOV                 A,SystemTimeCNT
    46 01004 1DC8 C        	SUB                 A,@200              ; 200*1ms = 200ms
    47 01005 0C03 C        	JBC                 STATUS,C
    48 01006 1409 C        	JMP                 KeyType_Scan
    49 01007 00D7 C        	CLR                 SystemTimeCNT
    50 01008 0AC9 C        	BS                  LED1_STATUS/16,LED1_STATUS%16
    51            C        
    52            C        ;===========================================================================
    53 01009      C        KeyType_Scan:
    54 01009 1100 C        	CALL                ConnectKey_Scan
    55 0100A 0F1F C        	JBS                 KeyScanFinishFlag/16,KeyScanFinishFlag%16
    56 0100B 141A C        	JMP                 Keystoke_No_Press
    57 0100C 091F C        	BC                  KeyScanFinishFlag/16,KeyScanFinishFlag%16
    58            C        
    59 0100D 0437 C        	MOV                 A,KEY_NUM
    60 0100E 1B02 C        	XOR                 A,@00000010B
    61 0100F 0C83 C        	JBC                 STATUS,Z
    62 01010 1432 C        	JMP                 Click_Select
    63            C        
    64 01011 0437 C        	MOV                 A,KEY_NUM
    65 01012 1B03 C        	XOR                 A,@00000011B
    66 01013 0C83 C        	JBC                 STATUS,Z
    67 01014 143F C        	JMP                 Lasting_Press_Select
    68            C        
    69 01015 0437 C        	MOV                 A,KEY_NUM
    70 01016 1B04 C        	XOR                 A,@00000100B
    71 01017 0C83 C        	JBC                 STATUS,Z
    72 01018 1442 C        	JMP                 Dblclick_Select
    73            C        
    74            C        /*
    75            C        	MOV                 A,KEY_NUM
    76            C        	XOR                 A,@00000101B
    77            C        	JBC                 STATUS,Z
    78            C        	NOP
    79            C        
    80            C        	MOV                 A,KEY_NUM
    81            C        	XOR                 A,@00000110B
    82            C        	JBC                 STATUS,Z
    83            C        	NOP
    84            C        
    85            C        	MOV                 A,KEY_NUM
    86            C        	XOR                 A,@00000111B
    87            C        	JBC                 STATUS,Z
    88            C        	NOP
    89            C        */
    90            C        
    91 01019 0000 C        	NOP
    92            C        ;===========================================================================
    93            C        
    94            C        
    95            C        ;**********************************************************************************
    96            C        ;*********************************************************************************
    97            C        ; force link check CHN_FLAG
    98            C        ;*********************************************************************************
    99 0101A      C        Keystoke_No_Press:
   100 0101A 0000 C        	NOP
   101 0101B 0D1E C        	JBC                 LinkModeFlag/16,LinkModeFlag%16
   102 0101C 14CB C        	JMP                 Cycle_Waiting_End
   103 0101D 10E9 C        	CALL                PAGE4BANK1
   104 0101E 0423 C        	MOV                 A,CHN_FLAG
   105 0101F 1B01 C        	XOR                 A,@00000001B             ; (1-8) Gamepads
   106 01020 0E83 C        	JBS                 STATUS,Z
   107 01021 14CB C        	JMP                 Cycle_Waiting_End
   108 01022      C        Quit_Recognise_Scan:                             ; Exit ID scan
   109 01022 08C9 C        	BC                  LED1_STATUS/16,LED1_STATUS%16
   110            C      M 	PAGE                0
       01023 09C3     1     BC  3 , 7 
       01024 0983     1     BC  3 , 6 
       01025 0943     1     BC  3 , 5 
   111 01026 127A C        	CALL                SearchLinkMode_Set
   112            C      M 	PAGE                5
       01027 0BC3     1     BS  3 , 7 
       01028 0983     1     BC  3 , 6 
       01029 0B43     1     BS  3 , 5 
   113 0102A 12C1 C        	CALL                CHANGE_ADDRESS_VALUE
   114            C      M 	PAGE                4
       0102B 0BC3     1     BS  3 , 7 
       0102C 0983     1     BC  3 , 6 
       0102D 0943     1     BC  3 , 5 
   115 0102E 10E9 C        	CALL                PAGE4BANK1
   116 0102F 00E3 C        	CLR                 CHN_FLAG
   117 01030 14CB C        	JMP                 Cycle_Waiting_End
   118 01031 0000 C        	NOP
   119            C        
   120            C        ;**********************************************************************************
   121            C        ;*********************************************************************************
   122            C        ; FCC test mode frequency index
   123            C        ;*********************************************************************************
   124 01032      C        Click_Select:
   125 01032 0F9E C        	JBS                 FccTestModeFlag/16,FccTestModeFlag%16
   126 01033 143A C        	JMP                 Not_Fcc_TestMode
   127 01034 056F C        	INC                 FccFreqIndex
   128 01035 042F C        	MOV                 A,FccFreqIndex
   129 01036 1D0F C        	SUB                 A,@0X0F
   130 01037 0E03 C        	JBS                 STATUS,C
   131 01038 00EF C        	CLR                 FccFreqIndex
   132 01039 1409 C        	JMP                 KeyType_Scan
   133 0103A      C        Not_Fcc_TestMode:
   134 0103A 00F7 C        	CLR                 KEY_NUM
   135 0103B 0F5E C        	JBS                 ForceLinkModeFlag/16,ForceLinkModeFlag%16
   136 0103C 14CB C        	JMP                 Cycle_Waiting_End
   137 0103D 1422 C        	JMP                 Quit_Recognise_Scan
   138 0103E 0000 C        	NOP
   139            C        
   140            C        
   141            C        
   142            C        ;**********************************************************************************
   143            C        ;*********************************************************************************
   144            C        ; Into FCC mode
   145            C        ;*********************************************************************************
   146 0103F      C        Lasting_Press_Select:                                     	; Fcc Test
   147            C        	;PAGE                0
   148            C        	;CALL                NormalFccLinkMode_Set
   149            C        	;PAGE                4
   150 0103F 0B9E C        	BS                  FccTestModeFlag/16,FccTestModeFlag%16
   151 01040 14CB C        	JMP                 Cycle_Waiting_End
   152 01041 0000 C        	NOP
   153            C        
   154            C        
   155            C        ;**********************************************************************************
   156            C        ;*********************************************************************************
   157            C        ; Into force link mode
   158            C        ;*********************************************************************************
   159 01042      C        Dblclick_Select:                                            ; Into Forcelink Mode:
   160 01042 0004 C        	WDTC
   161 01043 0AC9 C        	BS                  LED1_STATUS/16,LED1_STATUS%16
   162 01044 10E9 C        	CALL                PAGE4BANK1
   163 01045 189D C        	MOV                 A,@RX_IDH_DEFAULT                   ; SYNC ,used default 0X0DB3
   164 01046 0061 C        	MOV                 RX_IDH,A
   165 01047 18BC C        	MOV                 A,@RX_IDL_DEFAULT
   166 01048 0062 C        	MOV                 RX_IDL,A
   167            C      M 	PAGE                5
       01049 0BC3     1     BS  3 , 7 
       0104A 0983     1     BC  3 , 6 
       0104B 0B43     1     BS  3 , 5 
   168 0104C 12C1 C        	CALL                CHANGE_ADDRESS_VALUE
   169            C      M 	PAGE                0
       0104D 09C3     1     BC  3 , 7 
       0104E 0983     1     BC  3 , 6 
       0104F 0943     1     BC  3 , 5 
   170 01050 1288 C        	CALL                SearchForceLinkMode_Set
   171 01051 1160 C        	CALL                Rand_ID_Function
   172            C      M 	PAGE                4
       01052 0BC3     1     BS  3 , 7 
       01053 0983     1     BC  3 , 6 
       01054 0943     1     BC  3 , 5 
   173 01055 0000 C        	NOP
   174 01056      C        Write_EEprom_Task:                                          ; Write EEprom Task
   175 01056 0011 C        	DISI
   176 01057 0000 C        	NOP
   177 01058 0B06 C        	BS                  SPI_SS/16,SPI_SS%16                 ; Disable EM198810
   178            C        	;mERAL                                                  ; Clear all
   179            C      M 	mEWEN                                                   ; Enable
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       01059 09C3     3     BC  3 , 7 
       0105A 0983     3     BC  3 , 6 
       0105B 0943     3     BC  3 , 5 
       0105C 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0105D 0BC3     3     BS  3 , 7 
       0105E 0983     3     BC  3 , 6 
       0105F 0943     3     BC  3 , 5 
       01060 1830     1     MOV A,@( EWEN )
       01061 0051     1     MOV  R_ACC1 ,A
       01062 1809     1     MOV A,@( 9 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01063 09C3     3     BC  3 , 7 
       01064 0983     3     BC  3 , 6 
       01065 0943     3     BC  3 , 5 
       01066 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       01067 0BC3     3     BS  3 , 7 
       01068 0983     3     BC  3 , 6 
       01069 0943     3     BC  3 , 5 
       0106A 0985     1     BC ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       0106B 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       0106C 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
   180 0106D 1800 C        	MOV                 A,@0X00
   181 0106E 0055 C        	MOV                 DataAddressInEEPROM,A
   182 0106F 1860 C        	MOV                 A,@0X60
   183 01070 0054 C        	MOV                 DataAddressInMCU,A
   184            C      M  	mWRITE              DataAddressInEEPROM,@0,DataAddressInMCU,@16
                      2  M  BANK @( 0 ),
       01071 09C4     2     BC  4 , 7 
       01072 0984     2     BC  4 , 6 
       01073 0414     1     MOV A, DATAADDRESSINMCU 
       01074 0044     1     MOV  R4 ,A
       01075 1810     1     MOV A,@( 16 )
       01076 0053     1     MOV  R_ACC3 ,A
       01077          1    ??0028$WRITE_DATA:   
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       01077 09C3     3     BC  3 , 7 
       01078 0983     3     BC  3 , 6 
       01079 0943     3     BC  3 , 5 
       0107A 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0107B 0BC3     3     BS  3 , 7 
       0107C 0983     3     BC  3 , 6 
       0107D 0943     3     BC  3 , 5 
       0107E 0803     1     BC  STATUS , C 
       0107F 0615     1     RRCA  DATAADDRESSINEEPROM ,
       01080 1940     1     OR A,@( WRITE )
       01081 0051     1     MOV  R_ACC1 ,A
       01082 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01083 09C3     3     BC  3 , 7 
       01084 0983     3     BC  3 , 6 
       01085 0943     3     BC  3 , 5 
       01086 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       01087 0BC3     3     BS  3 , 7 
       01088 0983     3     BC  3 , 6 
       01089 0943     3     BC  3 , 5 
       0108A 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       0108B 0E15     1     JBS  DATAADDRESSINEEPROM , 0 
       0108C 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       0108D 0C15     1     JBC  DATAADDRESSINEEPROM , 0 
       0108E 0AC6     1     BS ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       0108F 1490     1     JMP ( $ + 1 ),
       01090 0A86     1     BS ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       01091 0555     1     INC  DATAADDRESSINEEPROM ,
       01092          1    ??0028$DATA_H_L:   
       01092 0400     1     MOV A, R0 
       01093 0051     1     MOV  R_ACC1 ,A
       01094 0544     1     INC  R4 ,
       01095 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       01096 09C3     3     BC  3 , 7 
       01097 0983     3     BC  3 , 6 
       01098 0943     3     BC  3 , 5 
       01099 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       0109A 0BC3     3     BS  3 , 7 
       0109B 0983     3     BC  3 , 6 
       0109C 0943     3     BC  3 , 5 
       0109D 149E     1     JMP ( $ + 1 ),
       0109E 0985     1     BC ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       0109F 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       010A0 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       010A1 14A2     1     JMP ( $ + 1 ),
       010A2 0A86     1     BS ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       010A3 0B85     1     BS ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       010A4 0E06     1     JBS ( SPI_MISO / 16 ),( SPI_MISO % 16 )
       010A5 14A4     1     JMP ( $ - 1 ),
       010A6 0985     1     BC ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       010A7 05D3     1     DJZ  R_ACC3 ,
       010A8 1477     1     JMP  ??0028$WRITE_DATA ,
   185            C      M  	mEWDS                                                   ; disable
                      2  M  FCALL  START_BIT 
                      3  M  PAGE ( START_BIT / 1024 ),
       010A9 09C3     3     BC  3 , 7 
       010AA 0983     3     BC  3 , 6 
       010AB 0943     3     BC  3 , 5 
       010AC 1300     2     CALL ( START_BIT % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       010AD 0BC3     3     BS  3 , 7 
       010AE 0983     3     BC  3 , 6 
       010AF 0943     3     BC  3 , 5 
       010B0 1800     1     MOV A,@( EWDS )
       010B1 0051     1     MOV  R_ACC1 ,A
       010B2 1809     1     MOV A,@( 9 )
                      2  M  FCALL  RL_COMD 
                      3  M  PAGE ( RL_COMD / 1024 ),
       010B3 09C3     3     BC  3 , 7 
       010B4 0983     3     BC  3 , 6 
       010B5 0943     3     BC  3 , 5 
       010B6 130F     2     CALL ( RL_COMD % 1024 ),
                      3  M  PAGE ( $ / 1024 ),
       010B7 0BC3     3     BS  3 , 7 
       010B8 0983     3     BC  3 , 6 
       010B9 0943     3     BC  3 , 5 
       010BA 0985     1     BC ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       010BB 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       010BC 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
   186 010BD 0985 C        	BC                  AT93C46_CS/16,AT93C46_CS%16         ; Disable 93C46
   187            C        
   188 010BE 0010 C        	ENI
   189 010BF 10E9 C         	CALL                PAGE4BANK1
   190 010C0 00DF C        	CLR                 GeneralStatusFlag
   191 010C1 00E3 C        	CLR                 CHN_FLAG
   192 010C2 00F7 C        	CLR                 KEY_NUM
   193 010C3 00DE C        	CLR                 CommuStatusFlag
   194 010C4 0A1E C        	BS                  SearchStatusFlag/16,SearchStatusFlag%16
   195 010C5 0B5E C        	BS                  ForceLinkModeFlag/16,ForceLinkModeFlag%16    ;
   196            C        
   197 010C6 10E6 C        	CALL                PAGE4BANK0
   198 010C7 0985 C        	BC                  AT93C46_CS/16,AT93C46_CS%16                  ; Disable 93C46
   199 010C8 0B06 C        	BS                  SPI_SS/16,SPI_SS%16                          ; Disable EM198810
   200 010C9 14CB C        	JMP                 Cycle_Waiting_End
   201 010CA 0000 C        	NOP
   202            C        
   203            C        
   204            C        
   205            C        ;===================================================================
   206            C        ;
   207            C        ;===================================================================
   208 010CB      C        Cycle_Waiting_End:
   209 010CB 10E9 C        	CALL                PAGE4BANK1
   210 010CC 0438 C        	MOV                 A,RX_ComuLoseCNT
   211 010CD 1DC8 C        	SUB                 A,@RX_ComuLoseCNT_Default
   212 010CE 0C03 C        	JBC                 STATUS,C
   213 010CF 14DE C        	JMP                 Communicating_CHN_FLAG
   214 010D0 00F8 C        	CLR                 RX_ComuLoseCNT
   215            C        
   216            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   217            C        	;XOR                 PORT5,A
   218            C        
   219 010D1 0C23 C        	JBC                 CHN_FLAG,RX1
   220 010D2 14DE C        	JMP                 Communicating_CHN_FLAG
   221 010D3 14D4 C        	JMP                 Disconnect_CHN_FLAG
   222 010D4      C          Disconnect_CHN_FLAG:
   223 010D4 0000 C        	NOP
   224            C        
   225            C        	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   226            C        	;XOR                 PORT5,A
   227            C        
   228            C      M 	PAGE                5
       010D5 0BC3     1     BS  3 , 7 
       010D6 0983     1     BC  3 , 6 
       010D7 0B43     1     BS  3 , 5 
   229 010D8 12D9 C        	CALL                RSSI_TEST_FUNCTION
   230 010D9 1276 C        	CALL                Enter_StandbyII_Mode
   231            C      M 	PAGE                4
       010DA 0BC3     1     BS  3 , 7 
       010DB 0983     1     BC  3 , 6 
       010DC 0943     1     BC  3 , 5 
   232 010DD 0000 C        	NOP
   233 010DE      C          Communicating_CHN_FLAG:
   234 010DE 0417 C        	MOV                 A,SystemTimeCNT
   235 010DF 1DFA C        	SUB                 A,@250              ; 200*1ms = 200ms
   236 010E0 0E03 C        	JBS                 STATUS,C
   237 010E1 00D7 C        	CLR                 SystemTimeCNT
   238            C        
   239 010E2 0423 C        	MOV                 A,CHN_FLAG
   240 010E3 006E C        	MOV                 CHN_FLAG_TEMP,A
   241 010E4 0012 C        	RET
   242 010E5 0000 C        	NOP
   243            C        
   244            C        ;=====================================================================
   245            C        ; BANK exchange function
   246            C        ;=====================================================================
   247 010E6      C        PAGE4BANK0:
   248 010E6 09C4 C        	BC                  0X04,7
   249 010E7 0984 C        	BC                  0X04,6
   250 010E8 0012 C        	RET
   251 010E9      C        PAGE4BANK1:
   252 010E9 09C4 C        	BC                  0X04,7
   253 010EA 0B84 C        	BS                  0X04,6
   254 010EB 0012 C        	RET
   255 010EC      C        PAGE4BANK2:
   256 010EC 0BC4 C        	BS                  0X04,7
   257 010ED 0984 C        	BC                  0X04,6
   258 010EE 0012 C        	RET
   259 010EF      C        PAGE4BANK3:
   260 010EF 0BC4 C        	BS                  0X04,7
   261 010F0 0B84 C        	BS                  0X04,6
   262 010F1 0012 C        	RET
    21                     ;include "XX24C04.ASM"
    22                     ;include "FccTest.ASM"
    23                     
    24                     ifndef XX93C46_For_EM78M611.ASM
    25                     include "XX93C46_For_EM78M611.ASM"
    26                     endif
    27                     
    28                     ;=========================================================================
    29                     	ORG                 0X0000
    30 00000 1472          	JMP                 MCU_RESET
    31                     	ORG                 0X0001        ; TCC interrupt vector
    32                   M 	PUSH                              ; save ACC,R3,R4
       00001 0054     1     MOV  A_TEMP ,A
       00002 0754     1     SWAP  A_TEMP ,
       00003 0703     1     SWAPA  3 ,
       00004 0056     1     MOV  STATUS_TEMP ,A
       00005 0704     1     SWAPA  4 ,
       00006 0055     1     MOV  RSR_TEMP ,A
       00007 00C3     1     CLR  3 ,
    33 00008 00C4          	CLR                 RSR
    34 00009 1450          	JMP                 TCC_INT_STATE
    35                     
    36                     
    37                     ;=========================================================================
    38                     ;============================ Program Code ===============================
    39                     	ORG                 0X0050
    40 00050               TCC_INT_STATE:
    41 00050 0000          	NOP
    42 00051 0C4F          	JBC                 ISR,EP0IF
    43 00052 1462          	JMP                 USB_EP0_INT
    44 00053 0CCF          	JBC                 ISR,USBRIF
    45 00054 1468          	JMP                 USB_RESET_INT
    46 00055 0C0F          	JBC                 ISR,TCCIF
    47 00056 1459          	JMP                 RF_CYCLE_INT
    48 00057 0C8F          	JBC                 ISR,USBSIF
    49 00058 1466          	JMP                 USB_SUSPEND_INT
    50 00059               RF_CYCLE_INT:
    51 00059 18D1          	MOV                 A,@(256-47)  ; N=47,P=64,f=6MHz ==> T=1ms
    52 0005A 0041          	MOV                 TCC,A
    53 0005B 080F          	BC                  ISR,TCCIF
    54 0005C 055B          	INC                 ComuClock    ; 1ms intrrupt and the master timing
    55 0005D 0557          	INC                 SystemTimeCNT
    56                     	;MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
    57                     	;XOR                 PORT5,A
    58 0005E 11CC          	CALL                PAGE0BANK1
    59 0005F 0578          	INC                 RX_ComuLoseCNT
    60 00060 0575          	INC                 KeySystemTimeCNT
    61 00061 146C          	JMP                 INT_RET
    62 00062               USB_EP0_INT:
    63                   M 	PAGE                4
       00062 0BC3     1     BS  3 , 7 
       00063 0983     1     BC  3 , 6 
       00064 0943     1     BC  3 , 5 
    64 00065 1550          	JMP                 READ_COMMAND ; EP0 Intrrupt flag,wating for Host'CMD
    65 00066               USB_SUSPEND_INT:                     ; USB bus terminated intrrupt
    66 00066 088F          	BC                  ISR,USBSIF
    67 00067 146C          	JMP                 INT_RET
    68 00068               USB_RESET_INT:
    69 00068 1801          	MOV                 A,@0X01
    70 00069 0079          	MOV                 PROTOCOL_TEMP,A
    71 0006A 08CF          	BC                  ISR,USBRIF
    72 0006B 146C          	JMP                 INT_RET
    73 0006C               INT_RET:
    74                   M 	POP                              ; restore ACC,R3,R4
       0006C 0716     1     SWAPA  STATUS_TEMP ,
       0006D 0043     1     MOV  3 ,A
       0006E 0715     1     SWAPA  RSR_TEMP ,
       0006F 0044     1     MOV  4 ,A
       00070 0714     1     SWAPA  A_TEMP ,
    75 00071 0013          	RETI
    76                     
    77                     ;========================= START =======================================
    78 00072               MCU_RESET:
    79 00072 0011          	DISI
    80 00073 18C8          	MOV                 A,@200          ; delay 20ms
    81                   M 	PAGE                5
       00074 0BC3     1     BS  3 , 7 
       00075 0983     1     BC  3 , 6 
       00076 0B43     1     BS  3 , 5 
    82 00077 1301          	CALL                DELAY_X100US
    83                   M 	PAGE                0
       00078 09C3     1     BC  3 , 7 
       00079 0983     1     BC  3 , 6 
       0007A 0943     1     BC  3 , 5 
    84 0007B 0000          	NOP
    85                   M 	ClrRamBank
       0007C 00CC     1     CLR  RC ,
       0007D 00CD     1     CLR  RD ,
       0007E 00D0     1     CLR  16 ,
       0007F 182F     1     MOV A,@( 47 )
       00080 0050     1     MOV  16 ,A
       00081 1811     1     MOV A,@( 17 )
       00082 0044     1     MOV  RSR ,A
       00083 00C0     1     CLR  R0 ,
       00084 0544     1     INC  RSR ,
       00085 05D0     1     DJZ  16 ,
       00086 1483     1     JMP ( $ - 3 ),
       00087 00C0     1     CLR  R0 ,
       00088 1820     1     MOV A,@( 32 )
       00089 0050     1     MOV  16 ,A
       0008A 1860     1     MOV A,@( 96 )
       0008B 0044     1     MOV  RSR ,A
       0008C 00C0     1     CLR  R0 ,
       0008D 0544     1     INC  RSR ,
       0008E 05D0     1     DJZ  16 ,
       0008F 148C     1     JMP ( $ - 3 ),
       00090 00C0     1     CLR  R0 ,
       00091 1820     1     MOV A,@( 32 )
       00092 0050     1     MOV  16 ,A
       00093 18A0     1     MOV A,@( 160 )
       00094 0044     1     MOV  RSR ,A
       00095 00C0     1     CLR  R0 ,
       00096 0544     1     INC  RSR ,
       00097 05D0     1     DJZ  16 ,
       00098 1495     1     JMP ( $ - 3 ),
       00099 00C0     1     CLR  R0 ,
       0009A 1811     1     MOV A,@( 17 )
       0009B 004D     1     MOV  RD ,A
       0009C 00CE     1     CLR  RE ,
       0009D 1801     1     MOV A,@( 1 )
       0009E 004D     1     MOV  RD ,A
       0009F 1800     1     MOV A,@( 0 )
       000A0 004E     1     MOV  RE ,A
       000A1 004E     1     MOV  RE ,A
       000A2 004E     1     MOV  RE ,A
       000A3 004E     1     MOV  RE ,A
       000A4 004E     1     MOV  RE ,A
       000A5 004E     1     MOV  RE ,A
       000A6 004E     1     MOV  RE ,A
       000A7 004E     1     MOV  RE ,A
       000A8 0B4C     1     BS  RC , 5 
    86 000A9 0000          	NOP
    87                     
    88                     ;============================ I/O CONFIG ==========================
    89 000AA 1830          	MOV                 A,@00110000B    ;set P50 D+/CLOCK, P51 D-/DATA pins input
    90 000AB 0007          	IOW                 IOC7
    91 000AC 0000          	NOP
    92 000AD 1804          	MOV                 A,@00000100B
    93 000AE 0009          	IOW                 IOC9
    94 000AF 0000          	NOP
    95 000B0 1800          	MOV                 A,@00000000B
    96 000B1 0008          	IOW                 IOC8
    97 000B2 0000          	NOP
    98 000B3 1820          	MOV                 A,@00100000B    ;SET P55 INPUT
    99 000B4 0005          	IOW                 IOC5
   100 000B5 0000          	NOP
   101 000B6 1861          	MOV                 A,@01100001B	;SPI_MISO/PKT_FLAG/FIFO_FLAG -> input port
   102 000B7 0006          	IOW                 IOC6
   103 000B8 0000          	NOP
   104 000B9 18F3          	MOV                 A,@11110011B	;PULL HIGH PORT92,PORT93
   105 000BA 000D          	IOW                 IOCD
   106 000BB 0000          	NOP
   107 000BC 18D0          	MOV                 A,@11010000B	;Disable WDT,PORT (PULL HIGH)
   108 000BD 000E          	IOW                 IOCE
   109 000BE 0000          	NOP
   110 000BF 1801          	MOV                 A,@00000001B	;USB Mode
   111 000C0 000A          	IOW                 IOCA
   112 000C1 0000          	NOP
   113                     
   114                     ;============================ Intrrupt Config ==========================
   115 000C2 1868          	MOV                 A,@01101000B		; Disable WDT, TCC clock source is Main CLK   1:64
   116 000C3 0002          	CONTW				                    ; TCC 1MS overflow
   117 000C4 00C1          	CLR                 TCC                 ; Clear TCC
   118 000C5 00CF          	CLR                 ISR                 ; interrupt flag
   119 000C6 1803          	MOV                 A,@00000011B
   120 000C7 000F          	IOW                 IMR                 ; enable EP0 interrupt / enable TCC interrupt
   121 000C8 0000          	NOP
   122                     
   123                     ;=============================== Initial Equipment ==========================
   124                   M 	PAGE                5
       000C9 0BC3     1     BS  3 , 7 
       000CA 0983     1     BC  3 , 6 
       000CB 0B43     1     BS  3 , 5 
   125 000CC 0000          	NOP
   126 000CD 10F9          	CALL                EM198850_RESET          ;initial RF
   127 000CE 0000          	NOP
   128                   M 	PAGE                0
       000CF 09C3     1     BC  3 , 7 
       000D0 0983     1     BC  3 , 6 
       000D1 0943     1     BC  3 , 5 
   129                     
   130                     ;-------------------------------------------------------------------------
   131 000D2 0B06          	BS                  SPI_SS/16,SPI_SS%16                    ; Disable RF
   132 000D3 1800          	MOV                 A,@0X00
   133 000D4 0055          	MOV                 DataAddressInEEPROM,A
   134 000D5 1860          	MOV                 A,@0X60
   135 000D6 0054          	MOV                 DataAddressInMCU,A
   136                   M 	mREAD               DataAddressInEEPROM,@0,DataAddressInMCU,@16
       000D7 0414     1     MOV A, DATAADDRESSINMCU 
       000D8 0044     1     MOV  R4 ,A
                      2  M  BANK @( 0 ),
       000D9 09C4     2     BC  4 , 7 
       000DA 0984     2     BC  4 , 6 
       000DB 1810     1     MOV A,@( 16 )
       000DC 0053     1     MOV  R_ACC3 ,A
       000DD          1    ??0044$WRITE_DATA:   
                      2  M  FCALL  START_BIT 
       000DD 1300     2     CALL  START_BIT ,
       000DE 0615     1     RRCA  DATAADDRESSINEEPROM ,
       000DF 1980     1     OR A,@( READ )
       000E0 0051     1     MOV  R_ACC1 ,A
       000E1 1808     1     MOV A,@( 8 )
                      2  M  FCALL  RL_COMD 
       000E2 130F     2     CALL  RL_COMD ,
       000E3 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000E4 0E15     1     JBS  DATAADDRESSINEEPROM , 0 
       000E5 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       000E6 0C15     1     JBC  DATAADDRESSINEEPROM , 0 
       000E7 0AC6     1     BS ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       000E8 14E9     1     JMP ( $ + 1 ),
       000E9 0A86     1     BS ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000EA 0555     1     INC  DATAADDRESSINEEPROM ,
       000EB 08C6     1     BC ( SPI_MOSI / 16 ),( SPI_MOSI % 16 )
       000EC 14ED     1     JMP ( $ + 1 ),
       000ED 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000EE 14EF     1     JMP ( $ + 1 ),
       000EF 14F0     1     JMP ( $ + 1 ),
       000F0 0A86     1     BS ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000F1          1    ??0044$READ_DATA1:   
       000F1 1808     1     MOV A,@( 8 )
       000F2 0052     1     MOV  R_ACC2 ,A
       000F3          1    ??0044$READ_DATA2:   
       000F3 0886     1     BC ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000F4 0000     1     NOP 
       000F5 0000     1     NOP 
       000F6 0C06     1     JBC ( SPI_MISO / 16 ),( SPI_MISO % 16 )
       000F7 0A03     1     BS  STATUS , C 
       000F8 0E06     1     JBS ( SPI_MISO / 16 ),( SPI_MISO % 16 )
       000F9 0803     1     BC  STATUS , C 
       000FA 06C0     1     RLC  R0 ,
       000FB 0A86     1     BS ( SPI_CLK / 16 ),( SPI_CLK % 16 )
       000FC 14FD     1     JMP ( $ + 1 ),
       000FD 05D2     1     DJZ  R_ACC2 ,
       000FE 14F3     1     JMP  ??0044$READ_DATA2 ,
       000FF 0544     1     INC  R4 ,
       00100 0000     1     NOP 
       00101 0985     1     BC ( AT93C46_CS / 16 ),( AT93C46_CS % 16 )
       00102 05D3     1     DJZ  R_ACC3 ,
       00103 14DD     1     JMP  ??0044$WRITE_DATA ,
   137 00104 0985          	BC                  AT93C46_CS/16,AT93C46_CS%16            ; Disable 93C46
   138                     
   139 00105 11C9          	CALL                PAGE0BANK0                             ; Save ID
   140 00106 0421          	MOV                 A,RX_IDH_Buffer
   141 00107 11CC          	CALL                PAGE0BANK1
   142 00108 0061          	MOV                 RX_IDH,A
   143 00109 11C9          	CALL                PAGE0BANK0
   144 0010A 0422          	MOV                 A,RX_IDL_Buffer
   145 0010B 11CC          	CALL                PAGE0BANK1
   146 0010C 0062          	MOV                 RX_IDL,A
   147                     
   148 0010D 11C9          	CALL                PAGE0BANK0
   149 0010E 0427          	MOV                 A,TX1_ID_Buffer
   150 0010F 11CC          	CALL                PAGE0BANK1
   151 00110 0067          	MOV                 TX1_ID,A
   152                     
   153 00111 11C9          	CALL                PAGE0BANK0
   154 00112 0428          	MOV                 A,TX2_ID_Buffer
   155 00113 11CC          	CALL                PAGE0BANK1
   156 00114 0068          	MOV                 TX2_ID,A
   157                     
   158 00115 11C9          	CALL                PAGE0BANK0
   159 00116 0429          	MOV                 A,TX3_ID_Buffer
   160 00117 11CC          	CALL                PAGE0BANK1
   161 00118 0069          	MOV                 TX3_ID,A
   162                     
   163 00119 11C9          	CALL                PAGE0BANK0
   164 0011A 042A          	MOV                 A,TX4_ID_Buffer
   165 0011B 11CC          	CALL                PAGE0BANK1
   166 0011C 006A          	MOV                 TX4_ID,A
   167                     
   168 0011D 11C9          	CALL                PAGE0BANK0
   169 0011E 042B          	MOV                 A,TX5_ID_Buffer
   170 0011F 11CC          	CALL                PAGE0BANK1
   171 00120 006B          	MOV                 TX5_ID,A
   172                     
   173 00121 11C9          	CALL                PAGE0BANK0
   174 00122 042C          	MOV                 A,TX6_ID_Buffer
   175 00123 11CC          	CALL                PAGE0BANK1
   176 00124 006C          	MOV                 TX6_ID,A
   177                     
   178                     ;===========================================================================
   179 00125 11CC          	CALL                PAGE0BANK1
   180 00126 0421          	MOV                 A,RX_IDH
   181 00127 0322          	XOR                 A,RX_IDL
   182 00128 0E83          	JBS                 STATUS,Z
   183 00129 152E          	JMP                 Run_Start  ;if RX_IDH==RX_IDL should jump
   184 0012A 0422          	MOV                 A,RX_IDL
   185 0012B 1BFF          	XOR                 A,@0XFF
   186 0012C 0C83          	JBC                 STATUS,Z   ;if RX_IDH==RX==0xff set EEpromWRStatusFlag
   187 0012D 0ADE          	BS                  EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   188 0012E               Run_Start:
   189 0012E 0CDE          	JBC                 EEpromWRStatusFlag/16,EEpromWRStatusFlag%16
   190 0012F 1160          	CALL                Rand_ID_Function
   191                   M 	PAGE                5
       00130 0BC3     1     BS  3 , 7 
       00131 0983     1     BC  3 , 6 
       00132 0B43     1     BS  3 , 5 
   192 00133 12C1          	CALL                CHANGE_ADDRESS_VALUE
   193 00134 12AF          	CALL                RF_FREQ_SET
   194                   M 	PAGE                0
       00135 09C3     1     BC  3 , 7 
       00136 0983     1     BC  3 , 6 
       00137 0943     1     BC  3 , 5 
   195 00138 11C9          	CALL                PAGE0BANK0
   196 00139 0000          	NOP
   197                     
   198 0013A 0010          	ENI
   199 0013B 00DB          	CLR                 ComuClock
   200 0013C 00DE          	CLR                 CommuStatusFlag
   201 0013D 00DF          	CLR                 GeneralStatusFlag
   202 0013E 00E3          	CLR                 CHN_FLAG
   203 0013F 00D0          	CLR                 TEMP
   204 00140 11CC          	CALL                PAGE0BANK1
   205                     
   206 00141 0B5F          	BS                  KeyStatusFlag/16,KeyStatusFlag%16
   207 00142 18FF          	MOV                 A,@0XFF
   208 00143 0074          	MOV                 KeystokeFlag_Befor,A
   209 00144 0076          	MOV                 KeystokeTimeCNT,A
   210 00145 08C9          	BC                  LED1_STATUS/16,LED1_STATUS%16
   211 00146 127A          	CALL                SearchLinkMode_Set
   212 00147 0808          	BC                  PORT8,0
   213                     
   214 00148 18D1           	MOV                 A,@(256-47)  ; N=94,P=64,f=6MHz ==> T=1ms
   215 00149 0041          	MOV                 TCC,A        ; TCC reload by PKT pull high
   216 0014A 00DB          	CLR                 ComuClock
   217 0014B 1880          	MOV                 A,@0X80      ; (test)P57 exchange when intrrupt
   218 0014C 0345          	XOR                 PORT5,A
   219 0014D 0000           	NOP
   220                     
   221                     ;=====================================================================
   222                     ;======================== MAIN =======================================
   223                     ;=====================================================================
   224 0014E               MAIN:
   225                     
   226 0014E 0004          	WDTC
   227                   M 	PAGE                4
       0014F 0BC3     1     BS  3 , 7 
       00150 0983     1     BC  3 , 6 
       00151 0943     1     BC  3 , 5 
   228 00152 12FC          	CALL                USB_MAIN
   229                   M  	PAGE                0
       00153 09C3     1     BC  3 , 7 
       00154 0983     1     BC  3 , 6 
       00155 0943     1     BC  3 , 5 
   230 00156 1200          	CALL                SYNC_COM_TX
   231                     
   232                   M 	PAGE                1
       00157 09C3     1     BC  3 , 7 
       00158 0983     1     BC  3 , 6 
       00159 0B43     1     BS  3 , 5 
   233 0015A 1000           	CALL                RX1_FUNCTION
   234                   M 	PAGE                0
       0015B 09C3     1     BC  3 , 7 
       0015C 0983     1     BC  3 , 6 
       0015D 0943     1     BC  3 , 5 
   235                     
   236                     
   237                     /*
   238                     	PAGE                5
   239                     	CALL                RSSI_TEST_FUNCTION
   240                     	PAGE                0
   241                     */
   242                     
   243 0015E 0000          	NOP
   244 0015F 154E          	JMP                 MAIN
   245                     
   246                     
   247                     ;======================================================================
   248                     ;Function:     COMMAND TX setting
   249                     ;Input:        None
   250                     ;Output:       None
   251                     ;======================================================================
   252                     ;========================================================================
   253                     ; Rand RX_ID and synthesize TX1_ID,TX2_ID...TXx_ID
   254                     ;========================================================================
   255 00160               Rand_ID_Function:
   256 00160 1802          	MOV                 A,@2
   257 00161 0051          	MOV                 TEMP1,A
   258 00162 1861          	MOV                 A,@0X61
   259 00163 0052          	MOV                 TEMP2,A
   260 00164 11A4          	CALL                RAND_FUCTION  ; Creat RX_IDH,RX_IDL
   261                     
   262 00165 11CC          	CALL                PAGE0BANK1
   263 00166 0421          	MOV                 A,RX_IDH
   264 00167 1B9D          	XOR                 A,@RX_IDH_DEFAULT
   265 00168 0E83          	JBS                 STATUS,Z
   266 00169 156F          	JMP                 Creat_TX_ID
   267 0016A 0422          	MOV                 A,RX_IDL
   268 0016B 1BBC          	XOR                 A,@RX_IDL_DEFAULT
   269 0016C 0E83          	JBS                 STATUS,Z
   270 0016D 156F          	JMP                 Creat_TX_ID	
   271 0016E 1560          	JMP                 Rand_ID_Function
   272 0016F                 Creat_TX_ID:
   273 0016F 18F0          	MOV                 A,@0XF0       ; synthesize TX_IDx
   274 00170 02A2          	AND                 A,RX_IDL
   275 00171 0067          	MOV                 TX1_ID,A
   276 00172 0068          	MOV                 TX2_ID,A
   277 00173 0069          	MOV                 TX3_ID,A
   278 00174 006A          	MOV                 TX4_ID,A
   279 00175 006B          	MOV                 TX5_ID,A
   280 00176 006C          	MOV                 TX6_ID,A
   281 00177 1801          	MOV                 A,@0X01
   282 00178 03E7          	ADD                 TX1_ID,A
   283 00179 1802          	MOV                 A,@0X02
   284 0017A 03E8          	ADD                 TX2_ID,A
   285 0017B 1803          	MOV                 A,@0X03
   286 0017C 03E9          	ADD                 TX3_ID,A
   287 0017D 1804          	MOV                 A,@0X04
   288 0017E 03EA          	ADD                 TX4_ID,A
   289 0017F 1805          	MOV                 A,@0X05
   290 00180 03EB          	ADD                 TX5_ID,A
   291 00181 1806          	MOV                 A,@0X06
   292 00182 03EC          	ADD                 TX6_ID,A
   293                     
   294 00183 11CC          	CALL                PAGE0BANK1   ; write ID to buffer
   295 00184 0421          	MOV                 A,RX_IDH
   296 00185 11C9          	CALL                PAGE0BANK0
   297 00186 0061          	MOV                 RX_IDH_Buffer,A
   298 00187 11CC          	CALL                PAGE0BANK1
   299 00188 0422          	MOV                 A,RX_IDL
   300 00189 11C9          	CALL                PAGE0BANK0
   301 0018A 0062          	MOV                 RX_IDL_Buffer,A
   302                     
   303 0018B 11CC          	CALL                PAGE0BANK1
   304 0018C 0427          	MOV                 A,TX1_ID
   305 0018D 11C9          	CALL                PAGE0BANK0
   306 0018E 0067          	MOV                 TX1_ID_Buffer,A
   307 0018F 11CC          	CALL                PAGE0BANK1
   308 00190 0428          	MOV                 A,TX2_ID
   309 00191 11C9          	CALL                PAGE0BANK0
   310 00192 0068          	MOV                 TX2_ID_Buffer,A
   311 00193 11CC          	CALL                PAGE0BANK1
   312 00194 0429          	MOV                 A,TX3_ID
   313 00195 11C9          	CALL                PAGE0BANK0
   314 00196 0069          	MOV                 TX3_ID_Buffer,A
   315 00197 11CC          	CALL                PAGE0BANK1
   316 00198 042A          	MOV                 A,TX4_ID
   317 00199 11C9          	CALL                PAGE0BANK0
   318 0019A 006A          	MOV                 TX4_ID_Buffer,A
   319 0019B 11CC          	CALL                PAGE0BANK1
   320 0019C 042B          	MOV                 A,TX5_ID
   321 0019D 11C9          	CALL                PAGE0BANK0
   322 0019E 006B          	MOV                 TX5_ID_Buffer,A
   323 0019F 11CC          	CALL                PAGE0BANK1
   324 001A0 042C          	MOV                 A,TX6_ID
   325 001A1 11C9          	CALL                PAGE0BANK0
   326 001A2 006C          	MOV                 TX6_ID_Buffer,A
   327 001A3 0012          	RET
   328                     
   329                     ;===================================================================
   330                     ; Rand Fuction
   331                     ; Input:       Temp1(Length)
   332                     ;              Temp2(Base address)  ;
   333                     ; output:      rang data from temp2 address base
   334                     ; description: Temp (seed [operand])
   335                     
   336                     ;===================================================================
   337 001A4               RAND_FUCTION:
   338 001A4 0050          	MOV                 TEMP,A
   339 001A5 0412          	MOV                 A,TEMP2
   340 001A6 03D0          	ADD                 TEMP,A        ; save latest data as current seed
   341                     
   342 001A7 00C4          	CLR                 RSR
   343 001A8                 RAND_SEED_LOOP1:
   344 001A8 0400          	MOV                 A,R0
   345 001A9 03D0          	ADD                 TEMP,A          ; seed
   346 001AA 11BD          	CALL                ArithmeticIns
   347 001AB 0544          	INC                 RSR
   348 001AC 0404          	MOV                 A,RSR
   349 001AD 1A40          	AND                 A,@0X40         ; adding form 0x00 to bank 0
   350 001AE 1B40          	XOR                 A,@0X40
   351 001AF 0E83          	JBS                 STATUS,Z
   352 001B0 15A8          	JMP                 RAND_SEED_LOOP1
   353 001B1 0400          	MOV                 A,R0
   354 001B2 03D0          	ADD                 TEMP,A          ; next seed
   355                     	MESSAGE             "adding form 0x00 to bank 0"
***     USER MESSAGE: ADDING FORM 0X00 TO BANK 0
   356                     
   357 001B3                 RAND_DATA_LOOP1:
   358 001B3 0412          	MOV                 A,TEMP2
   359 001B4 0044          	MOV                 RSR,A
   360 001B5 0410          	MOV                 A,TEMP
   361 001B6 0040          	MOV                 R0,A
   362 001B7 11BD          	CALL                ArithmeticIns
   363 001B8 0552          	INC                 TEMP2
   364 001B9 05D1          	DJZ                 TEMP1
   365 001BA 15B3          	JMP                 RAND_DATA_LOOP1:
   366 001BB 0000          	NOP
   367 001BC 0012          	RET
   368                     
   369 001BD                 ArithmeticIns:
   370 001BD 06D0          	RLC         TEMP          ; X*Y+1 MOD Z
   371 001BE 06D0          	RLC         TEMP
   372 001BF 06D0          	RLC         TEMP
   373 001C0 0550          	INC         TEMP
   374 001C1 0650          	RRC         TEMP
   375 001C2 0650          	RRC         TEMP
   376 001C3 0650          	RRC         TEMP
   377 001C4 0E03          	JBS         STATUS,C
   378 001C5 0810          	BC          TEMP,0
   379 001C6 0C03          	JBC         STATUS,C
   380 001C7 0A10          	BS          TEMP,0
   381 001C8 0012          	RET
   382                     
   383                     ;=====================================================================
   384                     ; BANK exchange function
   385                     ;=====================================================================
   386 001C9               	PAGE0BANK0:
   387 001C9 09C4          		BC              0X04,7
   388 001CA 0984          		BC              0X04,6
   389 001CB 0012          	RET
   390 001CC               	PAGE0BANK1:
   391 001CC 09C4          		BC              0X04,7
   392 001CD 0B84          		BS              0X04,6
   393 001CE 0012          	RET
   394 001CF               	PAGE0BANK2:
   395 001CF 0BC4          		BS              0X04,7
   396 001D0 0984          		BC              0X04,6
   397 001D1 0012          	RET
   398 001D2               	PAGE0BANK3:
   399 001D2 0BC4          		BS              0X04,7
   400 001D3 0B84          		BS              0X04,6
   401 001D4 0012          	RET
  0 Error(s), 0 Warning(s), 7 User Message(s)